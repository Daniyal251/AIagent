<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RKT HUB v14 ‚Äî –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞–º–∏</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè•</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&family=Unbounded:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
/* ===== CSS VARIABLES ===== */
:root {
  --bg: #0a0e17;
  --bg2: #111827;
  --bg3: #1a2234;
  --bg4: #1f2b3d;
  --accent: #00d4aa;
  --accent2: #00b894;
  --accent-glow: rgba(0, 212, 170, 0.15);
  --red: #ff6b6b;
  --red-glow: rgba(255, 107, 107, 0.15);
  --orange: #ffa94d;
  --orange-glow: rgba(255, 169, 77, 0.15);
  --yellow: #ffd43b;
  --blue: #4dabf7;
  --blue-glow: rgba(75, 171, 247, 0.15);
  --purple: #b197fc;
  --purple-glow: rgba(177, 151, 252, 0.15);
  --green: #51cf66;
  --pink: #f06595;
  --text: #e8ecf1;
  --text2: #8899aa;
  --text3: #5a6a7a;
  --border: #243044;
  --border2: #2d3f56;
  --radius: 12px;
  --radius-sm: 8px;
  --radius-lg: 16px;
  --shadow: 0 4px 30px rgba(0, 0, 0, 0.4);
  --shadow-lg: 0 20px 60px rgba(0, 0, 0, 0.5);
  --transition: all 0.2s ease;
  --sidebar-w: 260px;
}

/* ===== RESET ===== */
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
code, pre, .mono, .login-input, .ai-input, .search-input { font-family: 'JetBrains Mono', monospace !important; }
html { scroll-behavior: smooth; }

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
  line-height: 1.5;
}

body::before {
  content: '';
  position: fixed;
  top: -50%; left: -50%;
  width: 200%; height: 200%;
  background:
    radial-gradient(ellipse at 20% 50%, rgba(0, 212, 170, 0.06) 0%, transparent 50%),
    radial-gradient(ellipse at 80% 20%, rgba(75, 171, 247, 0.04) 0%, transparent 50%),
    radial-gradient(ellipse at 50% 80%, rgba(177, 151, 252, 0.03) 0%, transparent 50%);
  z-index: 0;
  pointer-events: none;
}

a { color: var(--accent); text-decoration: none; }
a:hover { text-decoration: underline; }

::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--text2); }

/* Responsive 2-column */
@media (max-width: 768px) {
  .sp-two-col { grid-template-columns: 1fr !important; }
}

/* Auth tabs & telegram button */
.auth-tab { flex:1;padding:10px;border:none;background:transparent;color:var(--text2);font-size:13px;font-weight:600;cursor:pointer;border-radius:8px;transition:all .2s;font-family:inherit }
.auth-tab.active { background:var(--accent);color:#fff }
.auth-tab:not(.active):hover { background:var(--bg4) }
.tg-login-btn { width:100%;padding:12px;border-radius:var(--radius-sm);border:1px solid #0088cc;background:rgba(0,136,204,.08);color:#0088cc;font-size:14px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;transition:all .2s;font-family:inherit }
.tg-login-btn:hover { background:rgba(0,136,204,.15);border-color:#006daa }

/* Staff picker cards */
.staff-pick {
  display: flex; align-items: center; gap: 12px;
  padding: 10px 14px; border-radius: 10px; cursor: pointer;
  border: 1px solid transparent; transition: all .15s;
  background: var(--bg3);
}
.staff-pick:hover { border-color: var(--accent); background: rgba(0,212,170,.06); }
.staff-pick .sp-ava {
  width: 38px; height: 38px; border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-weight: 700; font-size: 16px; color: #fff; flex-shrink: 0;
}
.staff-pick .sp-info { flex: 1; min-width: 0; }
.staff-pick .sp-info .sp-n { font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.staff-pick .sp-info .sp-r { font-size: 11px; color: var(--text2); }
.staff-pick .sp-tag { font-size: 11px; color: var(--text3); }

/* ============================================================
   LOGIN SCREEN
   ============================================================ */
.login-screen {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  display: flex;
  align-items: flex-start;
  justify-content: center;
  z-index: 9999;
  background: var(--bg);
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 20px 0;
}

.login-card {
  background: var(--bg2);
  margin: auto;
  border: 1px solid var(--border);
  border-radius: 24px;
  padding: 52px 44px;
  width: 440px;
  max-width: 92vw;
  text-align: center;
  box-shadow: var(--shadow-lg);
  position: relative;
  overflow: hidden;
  animation: loginFadeIn 0.5s ease;
}

@keyframes loginFadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.login-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--accent), var(--blue), var(--purple), var(--accent));
  background-size: 300% 100%;
  animation: gradientShift 4s ease infinite;
}

@keyframes gradientShift {
  0%, 100% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
}

.login-icon { font-size: 72px; margin-bottom: 20px; display: block; }

.login-logo {
  font-family: 'Unbounded', sans-serif;
  font-size: 36px;
  font-weight: 900;
  background: linear-gradient(135deg, var(--accent), var(--blue));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  margin-bottom: 6px;
}

.login-sub { color: var(--text2); font-size: 13px; margin-bottom: 36px; }

.login-label {
  display: block;
  text-align: left;
  font-size: 11px;
  color: var(--text2);
  text-transform: uppercase;
  letter-spacing: 2px;
  margin-bottom: 10px;
  font-weight: 600;
}

.login-input {
  width: 100%;
  padding: 16px 20px;
  background: var(--bg);
  border: 2px solid var(--border);
  border-radius: var(--radius);
  color: var(--text);
  font-family: 'JetBrains Mono', monospace;
  font-size: 18px;
  text-align: center;
  letter-spacing: 3px;
  transition: var(--transition);
  margin-bottom: 10px;
}

.login-input:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 4px var(--accent-glow);
}

.login-input::placeholder { color: var(--text3); font-size: 13px; letter-spacing: 0; }

.login-hint { font-size: 11px; color: var(--text2); margin-bottom: 28px; line-height: 1.8; }
.login-hint a { color: var(--accent); font-weight: 600; }

.login-btn {
  width: 100%;
  padding: 16px;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  color: var(--bg);
  border: none;
  border-radius: var(--radius);
  font-family: 'JetBrains Mono', monospace;
  font-size: 15px;
  font-weight: 700;
  cursor: pointer;
  transition: var(--transition);
  letter-spacing: 1.5px;
  text-transform: uppercase;
}

.login-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0, 212, 170, 0.3); }
.login-btn:active { transform: translateY(0); }
.login-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }

.login-error {
  color: var(--red);
  font-size: 13px;
  margin-top: 16px;
  display: none;
  padding: 10px;
  background: var(--red-glow);
  border-radius: var(--radius-sm);
}

/* ============================================================
   APP LAYOUT
   ============================================================ */
.app {
  position: relative;
  z-index: 1;
  display: flex;
  min-height: 100vh;
}

/* ===== SIDEBAR ===== */
.sidebar {
  width: var(--sidebar-w);
  background: var(--bg2);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  position: fixed;
  top: 0; left: 0; bottom: 0;
  z-index: 100;
  transition: transform 0.3s ease;
  overflow-y: auto;
}

.logo-section {
  padding: 28px 24px 20px;
  border-bottom: 1px solid var(--border);
}

.logo-section h1 {
  font-family: 'Unbounded', sans-serif;
  font-size: 22px;
  font-weight: 900;
  background: linear-gradient(135deg, var(--accent), var(--blue));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.logo-section .subtitle { font-size: 11px; color: var(--text2); margin-top: 4px; }

.nav { flex: 1; padding: 12px; }

.nav-section {
  font-size: 10px;
  color: var(--text3);
  text-transform: uppercase;
  letter-spacing: 2.5px;
  padding: 20px 12px 8px;
  font-weight: 600;
}

.nav-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 11px 14px;
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: var(--transition);
  font-size: 13px;
  color: var(--text2);
  text-decoration: none;
  margin-bottom: 2px;
  position: relative;
}

.nav-item:hover { background: var(--bg3); color: var(--text); text-decoration: none; }
.nav-item.active { background: var(--accent-glow); color: var(--accent); }

.nav-item.active::before {
  content: '';
  position: absolute;
  left: 0; top: 25%; bottom: 25%;
  width: 3px;
  background: var(--accent);
  border-radius: 0 3px 3px 0;
}

.nav-item .icon { font-size: 18px; width: 26px; text-align: center; flex-shrink: 0; }
.nav-item .label { flex: 1; }

.nav-item .badge {
  background: var(--accent);
  color: var(--bg);
  font-size: 10px;
  font-weight: 700;
  padding: 2px 8px;
  border-radius: 12px;
  min-width: 22px;
  text-align: center;
}

.nav-item .badge-orange { background: var(--orange); }
.nav-item .badge-red { background: var(--red); }
.nav-item.hidden { display: none; }

/* User bar */
.user-bar {
  padding: 16px 20px;
  border-top: 1px solid var(--border);
  background: var(--bg3);
}

.user-info { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }

.user-avatar {
  width: 40px; height: 40px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--accent), var(--blue));
  display: flex; align-items: center; justify-content: center;
  font-size: 18px; font-weight: 700; color: var(--bg); flex-shrink: 0;
}

.user-name { font-size: 13px; font-weight: 600; line-height: 1.3; }
.user-role-text { font-size: 11px; color: var(--text2); }

.logout-btn {
  width: 100%;
  padding: 9px;
  background: transparent;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text2);
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}

.logout-btn:hover { border-color: var(--red); color: var(--red); background: var(--red-glow); }

/* ===== MAIN ===== */
.main {
  flex: 1;
  margin-left: var(--sidebar-w);
  padding: 32px 36px 60px;
  max-width: 1400px;
  min-height: 100vh;
}

/* ===== PAGE HEADER ===== */
.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 28px;
  flex-wrap: wrap;
  gap: 12px;
}

.page-header h2 {
  font-family: 'Unbounded', sans-serif;
  font-size: 26px;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 12px;
}

.page-header .actions { display: flex; gap: 8px; flex-wrap: wrap; }

/* ===== BREADCRUMB ===== */
.breadcrumb {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 18px;
  font-size: 12px;
  color: var(--text2);
}

.breadcrumb a { cursor: pointer; color: var(--text2); transition: var(--transition); }
.breadcrumb a:hover { color: var(--accent); text-decoration: none; }
.breadcrumb .sep { color: var(--text3); }
.breadcrumb .current { color: var(--text); font-weight: 600; }

/* ===== BUTTONS ===== */
.btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 20px;
  border-radius: var(--radius-sm);
  border: none;
  cursor: pointer;
  font-family: 'JetBrains Mono', monospace;
  font-size: 13px;
  font-weight: 600;
  transition: var(--transition);
  white-space: nowrap;
}

.btn-primary {
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  color: var(--bg);
}

.btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(0, 212, 170, 0.3); }

.btn-secondary {
  background: var(--bg3);
  color: var(--text);
  border: 1px solid var(--border);
}

.btn-secondary:hover { border-color: var(--accent); color: var(--accent); }

.btn-danger {
  background: var(--red-glow);
  color: var(--red);
  border: 1px solid rgba(255, 107, 107, 0.3);
}

.btn-danger:hover { background: rgba(255, 107, 107, 0.25); }

.btn-sm { padding: 6px 14px; font-size: 11px; }
.btn-xs { padding: 4px 10px; font-size: 10px; }
.btn-approve { background: var(--accent-glow); color: var(--accent); border: 1px solid rgba(0, 212, 170, 0.3); }
.btn-reject { background: var(--red-glow); color: var(--red); border: 1px solid rgba(255, 107, 107, 0.3); }

.btn-ai {
  background: linear-gradient(135deg, var(--purple), #7950f2);
  color: #fff;
}

.btn-ai:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 15px var(--purple-glow);
}

/* ============================================================
   PROJECT GRID ‚Äî Main screen
   ============================================================ */
.project-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
  gap: 20px;
  margin-bottom: 28px;
}

.project-card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  overflow: hidden;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
}

.project-card:hover {
  border-color: var(--accent);
  transform: translateY(-4px);
  box-shadow: 0 12px 40px rgba(0, 212, 170, 0.15);
}

.project-card-top {
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 4px;
}

.project-card-header {
  padding: 28px 28px 16px;
  position: relative;
}

.project-card-header .emoji {
  font-size: 52px;
  margin-bottom: 14px;
  display: block;
  filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
}

.project-card-header h3 {
  font-family: 'Unbounded', sans-serif;
  font-size: 22px;
  font-weight: 700;
  margin-bottom: 6px;
}

.project-card-header .desc {
  font-size: 12px;
  color: var(--text2);
  line-height: 1.6;
}

.project-card-stats {
  padding: 0 28px 12px;
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 10px;
}

.pcs { text-align: center; padding: 10px 0; }

.pcs .v {
  font-family: 'Unbounded', sans-serif;
  font-size: 24px;
  font-weight: 800;
}

.pcs .l { font-size: 10px; color: var(--text2); margin-top: 2px; }

.project-card-progress {
  padding: 0 28px 24px;
}

.project-card-progress .bar {
  height: 6px;
  background: var(--bg);
  border-radius: 3px;
  overflow: hidden;
}

.project-card-progress .fill {
  height: 100%;
  border-radius: 3px;
  transition: width 0.6s ease;
}

.project-card-progress .info {
  display: flex;
  justify-content: space-between;
  margin-top: 6px;
  font-size: 11px;
  color: var(--text2);
}

.status-tag {
  position: absolute;
  top: 18px; right: 18px;
  font-size: 10px;
  padding: 4px 10px;
  border-radius: 12px;
  font-weight: 600;
}

/* Add new project card */
.project-card.add-card {
  border: 2px dashed var(--border);
  background: transparent;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 260px;
  flex-direction: column;
  gap: 12px;
}

.project-card.add-card:hover {
  border-color: var(--accent);
  background: var(--accent-glow);
}

.project-card.add-card .add-icon {
  font-size: 48px;
  opacity: 0.5;
}

.project-card.add-card .add-text {
  font-size: 14px;
  color: var(--text2);
  font-weight: 600;
}

/* ===== SUBPROJECT GRID ===== */
.subproject-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
}

.subproject-card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 22px;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.subproject-card:hover {
  border-color: var(--accent);
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(0, 212, 170, 0.1);
}

.subproject-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 3px;
}

.subproject-card .sp-emoji { font-size: 36px; margin-bottom: 10px; display: block; }

.subproject-card h4 {
  font-family: 'Unbounded', sans-serif;
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 4px;
}

.subproject-card .sp-desc {
  font-size: 11px;
  color: var(--text2);
  line-height: 1.5;
  margin-bottom: 12px;
}

.subproject-card .sp-stats {
  display: flex;
  gap: 16px;
  font-size: 11px;
  color: var(--text2);
}

.subproject-card .sp-stats span {
  display: flex;
  align-items: center;
  gap: 4px;
}

.subproject-card.add-sub {
  border: 2px dashed var(--border);
  background: transparent;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  gap: 8px;
  min-height: 160px;
}

.subproject-card.add-sub:hover {
  border-color: var(--accent);
  background: var(--accent-glow);
}

/* ===== METRICS ===== */
.metrics {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 16px;
  margin-bottom: 28px;
}

.metric-card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 22px;
  position: relative;
  overflow: hidden;
  transition: var(--transition);
}

.metric-card:hover {
  border-color: var(--border2);
  transform: translateY(-2px);
  box-shadow: var(--shadow);
}

.metric-card::after {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 3px;
}

.metric-card:nth-child(1)::after { background: linear-gradient(90deg, var(--accent), var(--accent2)); }
.metric-card:nth-child(2)::after { background: linear-gradient(90deg, var(--blue), #228be6); }
.metric-card:nth-child(3)::after { background: linear-gradient(90deg, var(--orange), #fd7e14); }
.metric-card:nth-child(4)::after { background: linear-gradient(90deg, var(--purple), #7950f2); }
.metric-card:nth-child(5)::after { background: linear-gradient(90deg, var(--green), #37b24d); }

.metric-card .m-icon { font-size: 30px; margin-bottom: 10px; }
.metric-card .m-value { font-family: 'Unbounded', sans-serif; font-size: 32px; font-weight: 900; line-height: 1; }
.metric-card .m-label { font-size: 12px; color: var(--text2); margin-top: 6px; }
.metric-card .m-sub { font-size: 10px; color: var(--text3); margin-top: 4px; }

/* ===== CARDS & TABLES ===== */
.card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  margin-bottom: 24px;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 22px;
  border-bottom: 1px solid var(--border);
  background: rgba(26, 34, 52, 0.5);
}

.card-header h3 {
  font-size: 15px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}

.table-wrap { overflow-x: auto; }

table { width: 100%; border-collapse: collapse; font-size: 13px; }

thead th {
  text-align: left;
  padding: 12px 18px;
  color: var(--text2);
  font-weight: 600;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 1.2px;
  border-bottom: 1px solid var(--border);
  background: var(--bg3);
  white-space: nowrap;
  position: sticky;
  top: 0;
  z-index: 2;
}

tbody td {
  padding: 13px 18px;
  border-bottom: 1px solid rgba(36, 48, 68, 0.4);
  vertical-align: middle;
}

tbody tr { transition: background 0.15s; }
tbody tr:hover td { background: rgba(0, 212, 170, 0.03); }
tbody tr:last-child td { border-bottom: none; }

/* ===== STATUS & BADGES ===== */
.status {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 600;
  white-space: nowrap;
}

.s-active { background: var(--accent-glow); color: var(--accent); }
.s-talks { background: var(--orange-glow); color: var(--orange); }
.s-research { background: var(--blue-glow); color: var(--blue); }
.s-pause { background: rgba(136, 153, 170, 0.15); color: var(--text2); }
.s-urgent { background: var(--red-glow); color: var(--red); }
.s-work { background: var(--purple-glow); color: var(--purple); }
.s-done { background: rgba(81, 207, 102, 0.15); color: var(--green); }

.p1 { color: var(--red); font-weight: 700; }
.p2 { color: var(--orange); font-weight: 600; }
.p3 { color: var(--text2); }

.progress-wrap { display: flex; align-items: center; gap: 10px; }

.progress-bar {
  width: 90px; height: 7px;
  background: var(--bg);
  border-radius: 4px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  border-radius: 4px;
  transition: width 0.5s ease;
}

.progress-text { font-size: 11px; color: var(--text2); font-weight: 600; min-width: 30px; }

/* ===== ACTION BUTTONS ===== */
.actions-cell { display: flex; gap: 5px; }

.act-btn {
  width: 30px; height: 30px;
  display: flex; align-items: center; justify-content: center;
  border-radius: 6px;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text2);
  cursor: pointer;
  font-size: 14px;
  transition: var(--transition);
}

.act-btn:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-glow); }
.act-btn.del:hover { border-color: var(--red); color: var(--red); background: var(--red-glow); }
.act-btn.view:hover { border-color: var(--blue); color: var(--blue); background: var(--blue-glow); }
.act-btn.ai:hover { border-color: var(--purple); color: var(--purple); background: var(--purple-glow); }

/* ===== FILTERS ===== */
.filters-bar {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-bottom: 18px;
  align-items: center;
}

.filter-chip {
  padding: 7px 16px;
  border-radius: 20px;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text2);
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px;
  cursor: pointer;
  transition: var(--transition);
}

.filter-chip:hover { border-color: var(--accent); color: var(--text); }
.filter-chip.active { background: var(--accent-glow); border-color: var(--accent); color: var(--accent); font-weight: 600; }

.search-input {
  padding: 8px 16px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 20px;
  color: var(--text);
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px;
  width: 220px;
  transition: var(--transition);
}

.search-input:focus { outline: none; border-color: var(--accent); width: 280px; }
.search-input::placeholder { color: var(--text3); }

/* ===== TABS ===== */
.tabs {
  display: flex;
  gap: 4px;
  border-bottom: 1px solid var(--border);
  margin-bottom: 20px;
  overflow-x: auto;
}

.tab {
  padding: 10px 18px;
  font-size: 12px;
  color: var(--text2);
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: var(--transition);
  white-space: nowrap;
  font-family: 'JetBrains Mono', monospace;
}

.tab:hover { color: var(--text); }
.tab.active { color: var(--accent); border-bottom-color: var(--accent); font-weight: 600; }

/* ============================================================
   AI CHAT PANEL ‚Äî Inside task view
   ============================================================ */
.ai-panel {
  background: var(--bg2);
  border: 1px solid var(--purple);
  border-radius: var(--radius);
  overflow: hidden;
  margin-top: 20px;
}

.ai-panel-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 20px;
  background: linear-gradient(135deg, rgba(177, 151, 252, 0.1), rgba(121, 80, 242, 0.05));
  border-bottom: 1px solid rgba(177, 151, 252, 0.2);
}

.ai-panel-header h4 {
  font-size: 14px;
  font-weight: 600;
  color: var(--purple);
  display: flex;
  align-items: center;
  gap: 8px;
}

.ai-chat-messages {
  padding: 16px 20px;
  max-height: 400px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.ai-msg {
  padding: 12px 16px;
  border-radius: var(--radius-sm);
  font-size: 13px;
  line-height: 1.6;
  max-width: 90%;
  animation: fadeInMsg 0.3s ease;
}

@keyframes fadeInMsg {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

.ai-msg.assistant {
  background: rgba(177, 151, 252, 0.08);
  border: 1px solid rgba(177, 151, 252, 0.15);
  color: var(--text);
  align-self: flex-start;
}

.ai-msg.user {
  background: var(--accent-glow);
  border: 1px solid rgba(0, 212, 170, 0.2);
  color: var(--text);
  align-self: flex-end;
}

.ai-msg.system {
  background: var(--bg3);
  border: 1px solid var(--border);
  color: var(--text2);
  font-size: 12px;
  text-align: center;
  align-self: center;
}

.ai-suggestions {
  padding: 12px 20px;
  border-top: 1px solid rgba(177, 151, 252, 0.15);
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.ai-suggestion-btn {
  padding: 6px 14px;
  border-radius: 20px;
  border: 1px solid rgba(177, 151, 252, 0.3);
  background: rgba(177, 151, 252, 0.05);
  color: var(--purple);
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  cursor: pointer;
  transition: var(--transition);
}

.ai-suggestion-btn:hover {
  background: rgba(177, 151, 252, 0.15);
  border-color: var(--purple);
}

.ai-input-area {
  display: flex;
  gap: 8px;
  padding: 14px 20px;
  border-top: 1px solid rgba(177, 151, 252, 0.15);
  background: rgba(26, 34, 52, 0.5);
}

.ai-input {
  flex: 1;
  padding: 10px 16px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text);
  font-family: 'JetBrains Mono', monospace;
  font-size: 13px;
  transition: var(--transition);
}

.ai-input:focus {
  outline: none;
  border-color: var(--purple);
  box-shadow: 0 0 0 3px var(--purple-glow);
}

.ai-input::placeholder { color: var(--text3); }

.ai-send-btn {
  padding: 10px 18px;
  background: linear-gradient(135deg, var(--purple), #7950f2);
  color: #fff;
  border: none;
  border-radius: var(--radius-sm);
  font-family: 'JetBrains Mono', monospace;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
}

.ai-send-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 15px var(--purple-glow); }
.ai-send-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

/* Loading dots animation */
.ai-loading { display: flex; gap: 4px; padding: 8px 0; }
.ai-loading span {
  width: 8px; height: 8px;
  border-radius: 50%;
  background: var(--purple);
  animation: aiDots 1.4s infinite both;
}
.ai-loading span:nth-child(2) { animation-delay: 0.2s; }
.ai-loading span:nth-child(3) { animation-delay: 0.4s; }

@keyframes aiDots {
  0%, 80%, 100% { opacity: 0.3; transform: scale(0.8); }
  40% { opacity: 1; transform: scale(1); }
}

/* ============================================================
   TASK DETAIL VIEW
   ============================================================ */
.task-detail {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  overflow: hidden;
}

.task-detail-header {
  padding: 28px;
  border-bottom: 1px solid var(--border);
  background: rgba(26, 34, 52, 0.5);
}

.task-detail-header h3 {
  font-family: 'Unbounded', sans-serif;
  font-size: 20px;
  font-weight: 700;
  margin-bottom: 12px;
}

.task-meta {
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
  font-size: 12px;
  color: var(--text2);
}

.task-meta .meta-item {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 4px 12px;
  background: var(--bg);
  border-radius: 20px;
}

.task-detail-body {
  padding: 28px;
}

.task-detail-body .detail-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin-bottom: 20px;
}

.task-steps {
  margin-top: 20px;
}

.task-steps h4 {
  font-size: 14px;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.task-step {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 12px 0;
  border-bottom: 1px solid rgba(36, 48, 68, 0.4);
}

.task-step:last-child { border-bottom: none; }

.task-step .step-check {
  width: 22px; height: 22px;
  border-radius: 50%;
  border: 2px solid var(--border);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  transition: var(--transition);
  flex-shrink: 0;
  margin-top: 2px;
}

.task-step .step-check:hover { border-color: var(--accent); }
.task-step .step-check.done { border-color: var(--green); background: var(--green); color: var(--bg); }
.task-step .step-text { font-size: 13px; line-height: 1.5; }
.task-step .step-text.done { text-decoration: line-through; color: var(--text3); }

.tab-sm { padding: 4px 12px; font-size: 11px; }
/* ===== SITE GENERATOR ===== */
.sg-form { display: flex; flex-direction: column; gap: 16px; }
.sg-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
@media (max-width: 600px) { .sg-row { grid-template-columns: 1fr; } }
.sg-field { display: flex; flex-direction: column; gap: 6px; }
.sg-field label { font-size: 12px; color: var(--text2); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
.sg-field input, .sg-field textarea, .sg-field select {
  background: var(--bg2); border: 1px solid var(--border); border-radius: var(--radius-sm);
  padding: 10px 14px; color: var(--text); font-family: inherit; font-size: 13px;
  transition: var(--transition);
}
.sg-field input:focus, .sg-field textarea:focus, .sg-field select:focus {
  outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow);
}
.sg-field textarea { resize: vertical; min-height: 60px; }
.sg-field select { cursor: pointer; }
.site-preview-frame {
  border: 2px solid var(--border); border-radius: var(--radius-lg); overflow: hidden;
  margin-top: 12px; box-shadow: var(--shadow-lg); background: #fff;
}
.spinner { width: 40px; height: 40px; border: 4px solid var(--border); border-top-color: var(--accent);
  border-radius: 50%; animation: spin 0.8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* ===== MODAL ===== */
.modal-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.75);
  backdrop-filter: blur(6px);
  z-index: 1000;
  justify-content: center;
  align-items: center;
}

.modal-overlay.show { display: flex; }

.modal {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  width: 560px;
  max-width: 92vw;
  max-height: 88vh;
  overflow-y: auto;
  box-shadow: var(--shadow-lg);
  animation: slideUp 0.25s ease;
}
.modal.wide { width: 720px; }
.form-section-title { font-size: 13px; font-weight: 700; color: var(--accent); margin: 18px 0 10px; padding-top: 14px; border-top: 1px solid var(--border); }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

@keyframes slideUp {
  from { opacity: 0; transform: translateY(30px); }
  to { opacity: 1; transform: translateY(0); }
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 22px 28px;
  border-bottom: 1px solid var(--border);
  background: rgba(26, 34, 52, 0.5);
}

.modal-header h3 {
  font-family: 'Unbounded', sans-serif;
  font-size: 17px;
  font-weight: 700;
}

.modal-close {
  width: 34px; height: 34px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text2);
  cursor: pointer;
  font-size: 20px;
  display: flex; align-items: center; justify-content: center;
  transition: var(--transition);
}

.modal-close:hover { color: var(--red); border-color: var(--red); background: var(--red-glow); }

.modal-body { padding: 28px; }

.form-group { margin-bottom: 18px; }

.form-group label {
  display: block;
  font-size: 11px;
  color: var(--text2);
  margin-bottom: 7px;
  text-transform: uppercase;
  letter-spacing: 1.2px;
  font-weight: 600;
}

.form-group .required::after { content: ' *'; color: var(--red); }

.form-group input,
.form-group select,
.form-group textarea {
  width: 100%;
  padding: 11px 16px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text);
  font-family: 'JetBrains Mono', monospace;
  font-size: 13px;
  transition: var(--transition);
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-glow);
}

.form-group textarea { min-height: 90px; resize: vertical; }
.form-group select { cursor: pointer; }
.form-group select option { background: var(--bg2); color: var(--text); }

.modal-footer {
  padding: 18px 28px;
  border-top: 1px solid var(--border);
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  background: rgba(26, 34, 52, 0.3);
}

/* Detail grid for modals */
.detail-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}

.detail-item {
  padding: 12px;
  background: var(--bg);
  border-radius: var(--radius-sm);
}

.detail-label {
  font-size: 10px;
  color: var(--text3);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 4px;
}

.detail-value { font-size: 13px; color: var(--text); word-break: break-word; }
.detail-full { grid-column: 1 / -1; }

/* ===== CONFIRM DIALOG ===== */
.confirm-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  z-index: 1100;
  justify-content: center;
  align-items: center;
}

.confirm-overlay.show { display: flex; }

.confirm-box {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 32px;
  width: 400px;
  max-width: 90vw;
  text-align: center;
  box-shadow: var(--shadow-lg);
}

.confirm-box .icon { font-size: 40px; margin-bottom: 16px; }
.confirm-box h4 { font-size: 16px; margin-bottom: 8px; }
.confirm-box p { color: var(--text2); font-size: 13px; margin-bottom: 24px; }
.confirm-actions { display: flex; gap: 10px; justify-content: center; }

/* ===== TOAST ===== */
.toast {
  position: fixed;
  bottom: 28px; right: 28px;
  padding: 14px 24px;
  border-radius: var(--radius-sm);
  font-size: 13px;
  font-weight: 600;
  transform: translateY(100px);
  opacity: 0;
  transition: all 0.35s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  z-index: 2000;
  max-width: 400px;
  box-shadow: var(--shadow);
}

.toast.show { transform: translateY(0); opacity: 1; }
.toast-success { background: var(--accent); color: var(--bg); }
.toast-error { background: var(--red); color: #fff; }
.toast-warning { background: var(--orange); color: var(--bg); }
.toast-info { background: var(--blue); color: var(--bg); }

/* ===== PAGES ===== */
.page { display: none; }
.page.active { display: block; animation: pageIn 0.3s ease; }

@keyframes pageIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.empty { text-align: center; padding: 50px; color: var(--text2); }
.empty .icon { font-size: 44px; margin-bottom: 14px; opacity: 0.6; }
.empty p { font-size: 14px; }

/* ===== STATUS BAR ===== */
.status-bar {
  position: fixed;
  bottom: 0; left: 0; right: 0;
  background: var(--bg2);
  border-top: 1px solid var(--border);
  padding: 6px 24px;
  display: flex;
  justify-content: space-between;
  font-size: 11px;
  color: var(--text3);
  z-index: 50;
}

.status-bar .dot {
  display: inline-block;
  width: 7px; height: 7px;
  border-radius: 50%;
  margin-right: 6px;
}

.dot-green { background: var(--accent); }
.dot-red { background: var(--red); }

/* ===== MOBILE ===== */
.mobile-toggle { display: none; }

/* ---- Tablet ---- */
@media (max-width: 1024px) {
  .sidebar { width: 60px !important; }
  .sidebar .logo-section span, .sidebar .nav-item .label,
  .sidebar .user-bar span, .sidebar .user-bar .user-name { display: none !important; }
  .sidebar .nav-item { justify-content: center; padding: 12px; }
  .sidebar .nav-item .icon { margin: 0; font-size: 20px; }
  .main { margin-left: 60px; }
}

/* ---- Mobile ---- */
@media (max-width: 768px) {
  .sidebar {
    position: fixed !important; left: -280px; width: 280px !important;
    height: 100vh; top: 0; transition: left 0.3s ease; z-index: 1100;
  }
  .sidebar.mobile-open { left: 0 !important; }
  .sidebar.mobile-open .logo-section span, .sidebar.mobile-open .nav-item .label,
  .sidebar.mobile-open .user-bar span { display: revert !important; }
  .mobile-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1050; }
  .mobile-overlay.show { display: block; }
  .main { margin-left: 0 !important; padding: 12px !important; }
  .page-header h2 { font-size: 20px !important; }
  .metrics { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
  .table-wrap, .data-table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  table.data-table { min-width: 600px; }
  .slide-over, .slideover, [class*="slide-over"] { width: 100vw !important; max-width: 100vw !important; }
  .modal { width: 95vw !important; max-width: 95vw !important; }
  .login-card { padding: 32px 20px !important; width: 100% !important; max-width: 100% !important; }
  .kanban-wrap, .pipeline-wrap { flex-direction: column !important; }
  .kanban-col, .pipeline-col { min-width: 100% !important; flex: 1 !important; }
  .detail-grid, .form-row { grid-template-columns: 1fr !important; }
  .status-bar { padding: 8px 12px !important; }
  #mobileMenuBtn { display: block !important; }
}

/* ---- Mobile Enhanced ---- */
@media (max-width: 768px) {
  /* Touch targets: minimum 44px for all interactive elements */
  .btn, button, .tab, .nav-item, select, input[type="checkbox"], input[type="radio"] {
    min-height: 44px !important; min-width: 44px !important;
  }
  .btn { width: 100% !important; padding: 12px 16px !important; font-size: 14px !important; }
  .btn-sm { min-height: 38px !important; width: auto !important; padding: 8px 14px !important; }
  /* Full-screen modals */
  .modal { width: 100vw !important; max-width: 100vw !important; max-height: 100vh !important;
    border-radius: 0 !important; margin: 0 !important; }
  .modal-overlay { padding: 0 !important; }
  /* Full-screen slide-over */
  .slide-over, .slideover, [class*="slide-over"], #slideover-panel {
    width: 100vw !important; max-width: 100vw !important; border-radius: 0 !important;
  }
  /* Staff/Client cards: single column */
  [style*="grid-template-columns:repeat(auto-fill"] { grid-template-columns: 1fr !important; }
  /* AI chat full width */
  .ai-global-panel, #ai-global-panel { width: 100vw !important; max-width: 100vw !important;
    right: 0 !important; border-radius: 0 !important; }
  /* Notification panel full width */
  .notif-panel { width: 100vw !important; max-width: 100vw !important; }
  /* Safe area for iOS */
  .main { padding-bottom: calc(20px + env(safe-area-inset-bottom)) !important; }
  .sidebar { padding-bottom: env(safe-area-inset-bottom); }
  /* Sticky mobile header */
  .status-bar { position: sticky !important; top: 0; z-index: 100; backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px); }
  /* Kanban: vertical scroll */
  .kanban-wrap { overflow-x: auto !important; -webkit-overflow-scrolling: touch; padding-bottom: 16px; }
  .kanban-col { min-width: 280px !important; flex: 0 0 280px !important; }
  /* Form inputs larger */
  input, textarea, select { font-size: 16px !important; /* Prevents zoom on iOS */ }
  /* Slide-over actions wrap */
  .so-actions, #so-actions { display: flex !important; flex-wrap: wrap !important; gap: 8px !important; }
  .so-actions button, #so-actions button { flex: 1 1 calc(50% - 4px) !important; min-width: 140px !important; }
  /* Project cards single column */
  .project-card { margin-bottom: 12px; }
  /* Table wrap with scroll indicator */
  .table-wrap::after { content: '‚Üí'; position: sticky; right: 0; padding: 4px 8px;
    background: var(--bg2); color: var(--text3); font-size: 11px; }
  /* Workflow banner stacked */
  .workflow-banner { flex-direction: column !important; text-align: center; gap: 8px !important; }
  .wf-action { width: 100%; }
  .wf-action button { width: 100% !important; }
  /* Pipeline stages scrollable */
  .so-progress, #so-progress { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  /* Client card panel full screen */
  .client-card-panel { width: 100vw !important; max-width: 100vw !important; border-radius: 0 !important; }
  /* z-index hierarchy for overlays */
  .modal-overlay { z-index: 3000 !important; }
  .modal { z-index: 3001 !important; }
  .notif-panel { z-index: 2000 !important; }
  .ai-global-panel, #ai-global-panel { z-index: 2500 !important; }
  .slide-over, #slideover-panel { z-index: 1500 !important; }
  .sidebar { z-index: 1100 !important; }
}
/* ---- Small ---- */
@media (max-width: 480px) {
  .metrics { grid-template-columns: 1fr !important; }
  .btn { padding: 10px 14px !important; font-size: 13px !important; }
  .page-header .actions { flex-wrap: wrap; gap: 6px; }
  .login-card { padding: 24px 16px !important; }
  /* Even more compact kanban */
  .kanban-col { min-width: 260px !important; flex: 0 0 260px !important; }
  .kanban-card { padding: 8px 10px !important; }
  /* Stack details vertically */
  .so-detail-item { grid-column: span 2 !important; }
  /* Full width tabs */
  .tabs { overflow-x: auto; -webkit-overflow-scrolling: touch; white-space: nowrap; }
  .tab { white-space: nowrap; flex-shrink: 0; }
}

/* ===== NOTIFICATION CSS ===== */
.notif-bell { position: relative; cursor: pointer; font-size: 20px; padding: 8px; border-radius: 8px; transition: all 0.2s; user-select: none; }
.notif-bell:hover { background: var(--bg3); }
.notif-badge { position: absolute; top: 2px; right: 2px; background: var(--red, #ff6b6b); color: #fff; font-size: 10px; font-weight: 700; min-width: 18px; height: 18px; border-radius: 9px; display: flex; align-items: center; justify-content: center; line-height: 1; }
.notif-panel { position: fixed; top: 0; right: -400px; width: 400px; max-width: 100vw; height: 100vh; background: var(--bg2); border-left: 1px solid var(--border); z-index: 2000; transition: right 0.3s ease; overflow-y: auto; box-shadow: -4px 0 30px rgba(0,0,0,0.3); }
.notif-panel.open { right: 0; }
.notif-item { padding: 14px 20px; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.15s; }
.notif-item:hover { background: var(--bg3); }
.notif-item.unread { border-left: 3px solid var(--accent); }
.notif-time { font-size: 11px; color: var(--text3, #666); margin-top: 4px; }
.notif-text { font-size: 13px; line-height: 1.5; }

/* ===== SIDEBAR TOOLTIPS ===== */
@media (min-width: 769px) and (max-width: 1024px) {
  .sidebar .nav-item { position: relative; }
  .sidebar .nav-item[data-tooltip]:hover::after {
    content: attr(data-tooltip);
    position: absolute; left: 100%; top: 50%; transform: translateY(-50%);
    background: var(--bg4, var(--bg3)); color: var(--text);
    padding: 6px 12px; border-radius: 6px; white-space: nowrap;
    font-size: 12px; margin-left: 8px; z-index: 999;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3); pointer-events: none;
  }
}

@media (max-width: 900px) {
  .sidebar { transform: translateX(-100%); width: 280px; }
  .sidebar.open { transform: translateX(0); box-shadow: var(--shadow-lg); }
  .main { margin-left: 0; padding: 20px 16px 60px; }
  .metrics { grid-template-columns: repeat(2, 1fr); }
  .project-grid { grid-template-columns: 1fr; }
  .subproject-grid { grid-template-columns: 1fr; }
  .detail-grid { grid-template-columns: 1fr; }
  .page-header h2 { font-size: 20px; }
  .task-detail-body .detail-grid { grid-template-columns: 1fr; }
  .form-row { grid-template-columns: 1fr; }
  .modal.wide { width: 95vw; }
  #aiGlobalPanel { width: calc(100vw - 32px) !important; right: 16px !important; bottom: 16px !important; height: 70vh !important; }

  .mobile-toggle {
    display: flex !important;
    position: fixed;
    top: 14px; left: 14px;
    z-index: 200;
    width: 44px; height: 44px;
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    align-items: center; justify-content: center;
    cursor: pointer;
    color: var(--text);
    font-size: 22px;
    box-shadow: var(--shadow);
  }
}

/* ============== PIPELINE (vertical for Sites) ============== */
.kanban-wrap{display:flex;gap:10px;overflow-x:auto;padding:12px 0;min-height:400px}
.kanban-col{min-width:220px;max-width:240px;flex:0 0 220px;background:var(--bg3);border-radius:var(--radius);display:flex;flex-direction:column;border:1px solid var(--border)}
.kanban-col-header{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;font-size:12px;font-weight:700}
.kanban-col-header .k-count{background:var(--bg);padding:2px 8px;border-radius:10px;font-size:11px;font-weight:500}
.kanban-col-header .k-sum{font-size:10px;color:var(--accent);font-weight:600;margin-top:2px}
.kanban-col-body{flex:1;padding:8px;overflow-y:auto;display:flex;flex-direction:column;gap:6px;min-height:60px}
.kanban-card{background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:10px 12px;cursor:pointer;transition:all .2s;position:relative}
.kanban-card:hover{border-color:var(--accent);transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.3)}
.kanban-card.overdue{border-left:3px solid var(--red)}
.kanban-card .k-name{font-size:13px;font-weight:600;margin-bottom:4px;color:var(--text)}
.kanban-card .k-meta{font-size:10px;color:var(--text3);display:flex;flex-wrap:wrap;gap:6px}
.kanban-card .k-price{color:var(--accent);font-weight:600}
.kanban-card .k-type{color:var(--purple)}
.kanban-card .k-city{color:var(--blue)}
.kanban-card .k-paid{color:var(--green);font-weight:600}
.kanban-card .k-unpaid{color:var(--orange)}
.kanban-card .k-manager{color:var(--text2)}
.kanban-card .k-delete-btn{position:absolute;top:4px;right:4px;background:none;border:none;cursor:pointer;font-size:12px;opacity:0;transition:opacity .2s;padding:2px 4px;border-radius:4px}
.kanban-card:hover .k-delete-btn{opacity:.6}
.kanban-card .k-delete-btn:hover{opacity:1;background:rgba(231,76,60,.15)}
.kanban-card.dragging{opacity:.5;transform:rotate(2deg)}
.kanban-col.drag-over{background:rgba(0,212,170,.08);border-color:var(--accent)}
/* Vertical pipeline */
.pipeline-vertical{display:flex;flex-direction:column;gap:12px}
.pipe-stage{background:var(--bg3);border:1px solid var(--border);border-radius:12px;overflow:hidden}
.pipe-stage-hdr{padding:12px 16px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;font-weight:700;font-size:13px;border-bottom:1px solid var(--border)}
.pipe-stage-hdr .pipe-dot{width:10px;height:10px;border-radius:50%;margin-right:8px;flex-shrink:0}
.pipe-stage-hdr .pipe-info{display:flex;align-items:center;gap:8px}
.pipe-stage-hdr .pipe-stats{font-size:11px;font-weight:400;color:var(--text2);display:flex;gap:10px}
.pipe-stage-body{padding:8px;display:flex;flex-direction:column;gap:6px}
.pipe-client{display:flex;align-items:center;gap:12px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:10px 14px;cursor:pointer;transition:all .2s}
.pipe-client:hover{border-color:var(--accent);box-shadow:0 2px 8px rgba(0,0,0,.2)}
.pipe-client .pc-name{font-weight:600;font-size:13px;flex:1}
.pipe-client .pc-price{font-weight:600;color:var(--accent);font-size:13px}
.pipe-client .pc-meta{font-size:10px;color:var(--text3);display:flex;gap:8px;margin-top:2px}
.pipe-client .pc-del{opacity:0;color:var(--red);cursor:pointer;font-size:16px;padding:4px 6px;border-radius:6px;transition:all .15s}
.pipe-client:hover .pc-del{opacity:1}
.pipe-client .pc-del:hover{background:var(--red-glow)}

/* ============== SLIDE-OVER ============== */
.slideover-overlay{position:fixed;top:0;right:0;bottom:0;left:0;background:rgba(0,0,0,.5);z-index:700;display:none;opacity:0;transition:opacity .3s}
.slideover-overlay.open{display:block;opacity:1}
.slideover{position:fixed;top:0;right:-520px;bottom:0;width:500px;max-width:90vw;background:var(--bg2);z-index:710;transition:right .3s ease;display:flex;flex-direction:column;box-shadow:-10px 0 40px rgba(0,0,0,.5)}
.slideover.open{right:0}
.so-header{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:flex-start}
.so-close{width:32px;height:32px;border-radius:50%;border:1px solid var(--border);background:transparent;color:var(--text2);cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center}
.so-body{flex:1;overflow-y:auto;padding:20px 24px}
.so-progress{display:flex;gap:2px;margin:16px 0}
.so-progress .so-step{flex:1;height:6px;border-radius:3px;background:var(--bg3);cursor:pointer;transition:background .2s}
.so-progress .so-step.active{background:var(--accent)}
.so-progress .so-step.done{background:var(--green)}
.so-stage-labels{display:flex;justify-content:space-between;margin-bottom:16px}
.so-stage-labels span{font-size:9px;color:var(--text3);text-align:center;flex:1}
.so-section{margin-bottom:20px}
.so-section h4{font-size:12px;font-weight:600;color:var(--text2);margin-bottom:10px;text-transform:uppercase;letter-spacing:.5px}
.so-detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.so-detail-item{padding:10px 12px;background:var(--bg3);border-radius:8px}
.so-detail-item .so-label{font-size:10px;color:var(--text3);margin-bottom:2px}
.so-detail-item .so-value{font-size:14px;font-weight:600;color:var(--text)}
.so-actions{display:flex;gap:8px;flex-wrap:wrap;margin:16px 0}
.so-actions button{padding:8px 14px;border-radius:8px;border:1px solid var(--border);background:var(--bg3);color:var(--text);font-size:12px;cursor:pointer;transition:all .2s;font-family:inherit}
.so-actions button:hover{border-color:var(--accent);background:rgba(0,212,170,.08)}
.so-checklist{list-style:none;padding:0}
.so-checklist li{padding:8px 0;border-bottom:1px solid var(--bg3);display:flex;align-items:center;gap:8px;font-size:13px}
.so-checklist li.done{color:var(--text3);text-decoration:line-through}
.so-checklist li .check{width:18px;height:18px;border-radius:50%;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:11px;flex-shrink:0}
.so-checklist li.done .check{background:var(--green);border-color:var(--green);color:#fff}
.so-next-btn{width:100%;padding:12px;background:linear-gradient(135deg,var(--accent),#00b894);border:none;border-radius:8px;color:#fff;font-size:14px;font-weight:600;cursor:pointer;margin-top:12px;font-family:inherit}

/* ============== GUIDED WORKFLOW ============== */
.workflow-banner{background:linear-gradient(135deg,rgba(255,169,77,.1),rgba(253,126,20,.05));border:1px solid rgba(255,169,77,.3);border-radius:var(--radius);padding:16px 20px;margin-bottom:16px;display:flex;align-items:center;gap:14px}
.workflow-banner .wf-step{font-size:24px}
.workflow-banner .wf-info h4{font-size:14px;font-weight:600;color:var(--orange);margin-bottom:2px}
.workflow-banner .wf-info p{font-size:12px;color:var(--text2)}
.workflow-banner .wf-action{margin-left:auto}
.workflow-banner .wf-action button{padding:8px 16px;background:var(--orange);border:none;border-radius:6px;color:#fff;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit}

/* ============== REVENUE CHART ============== */
.chart-container{background:var(--bg3);border-radius:var(--radius);padding:20px;margin:16px 0;border:1px solid var(--border)}
.chart-bars{display:flex;align-items:flex-end;gap:6px;height:140px;padding:0 4px}
.chart-bar-wrap{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px}
.chart-bar{width:100%;border-radius:4px 4px 0 0;background:linear-gradient(180deg,var(--accent),#00b894);min-height:2px;transition:height .5s}
.chart-bar-label{font-size:9px;color:var(--text3)}
.chart-bar-value{font-size:9px;color:var(--accent);font-weight:600}

/* ============== KANBAN VIEW TOGGLE ============== */
.view-toggle{display:flex;gap:4px;background:var(--bg3);border-radius:8px;padding:3px;border:1px solid var(--border)}
.view-toggle button{padding:6px 14px;border-radius:6px;border:none;background:transparent;color:var(--text2);font-size:12px;cursor:pointer;font-family:inherit;transition:all .2s}
.view-toggle button.active{background:var(--accent);color:#fff;font-weight:600}

</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" onerror="document.getElementById('loginError').textContent='‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.';document.getElementById('loginError').style.display='block'"></script>
</head>
<body>

<!-- AUTH SCREEN -->
<div class="login-screen" id="loginScreen">
  <div class="login-card" style="width:440px;max-width:95vw;box-sizing:border-box;padding:48px 40px">
    <span class="login-icon">üè•</span>
    <div class="login-logo">RKT HUB</div>
    <div class="login-sub">–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞–º–∏</div>

    <div style="background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:12px 16px;margin-bottom:20px;text-align:left;font-size:13px;color:var(--text2);line-height:1.6">
      üí° <strong style="color:var(--text)">–ö–∞–∫ –≤–æ–π—Ç–∏:</strong> –≤–≤–µ–¥–∏—Ç–µ –∏–º—è, @telegram –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω, –∑–∞—Ç–µ–º –ø–∞—Ä–æ–ª—å.<br>
      –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –í–∫–ª–∞–¥–∫–∞ ¬´–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è¬ª –∏–ª–∏ –±–æ—Ç <a href="https://t.me/AIhroject_bot" style="color:var(--accent)">@AIhroject_bot</a>.
    </div>

    <!-- AUTH TABS -->
    <div style="display:flex;gap:0;margin-bottom:20px;background:var(--bg3);border-radius:10px;padding:3px;border:1px solid var(--border)">
      <button id="authTabLogin" class="auth-tab active" onclick="showAuthTab('login')">üîë –í—Ö–æ–¥</button>
      <button id="authTabReg" class="auth-tab" onclick="showAuthTab('register')">üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
    </div>

    <!-- ===== LOGIN FORM ===== -->
    <div id="authLogin">
      <div style="display:grid;gap:10px">
        <input class="login-input" id="loginId" type="text" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω, @telegram –∏–ª–∏ email" autocomplete="username" autofocus>
        <div style="position:relative">
          <input class="login-input" id="loginPass" type="password" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="current-password" onkeydown="if(event.key==='Enter')doPasswordLogin()" style="padding-right:44px">
          <button onclick="togglePassVis('loginPass',this)" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;font-size:16px;color:var(--text3)" title="–ü–æ–∫–∞–∑–∞—Ç—å">üëÅ</button>
        </div>
      </div>
      <button class="login-btn" onclick="doPasswordLogin()" style="margin-top:14px">
        <span id="loginBtnText">–í–æ–π—Ç–∏</span>
      </button>
      <div class="login-error" id="loginError"></div>

      <div style="display:flex;align-items:center;gap:12px;margin:18px 0 14px">
        <div style="flex:1;height:1px;background:var(--border)"></div>
        <span style="font-size:11px;color:var(--text3)">–∏–ª–∏</span>
        <div style="flex:1;height:1px;background:var(--border)"></div>
      </div>

      <button class="tg-login-btn" onclick="doTelegramLogin()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="flex-shrink:0"><path d="M12 0C5.37 0 0 5.37 0 12s5.37 12 12 12 12-5.37 12-12S18.63 0 12 0zm5.94 8.13l-1.97 9.28c-.15.67-.54.83-1.09.52l-3.02-2.23-1.45 1.4c-.16.16-.3.3-.61.3l.22-3.05 5.55-5.02c.24-.22-.05-.33-.37-.13l-6.87 4.33-2.96-.92c-.64-.2-.66-.64.13-.95l11.57-4.46c.54-.2 1.01.13.83.93z"/></svg>
        –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram
      </button>

      <div style="text-align:center;margin-top:14px">
        <a href="#" onclick="showForgotPass();return false" style="color:var(--text3);font-size:12px">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</a>
      </div>
    </div>

    <!-- ===== REGISTER FORM ===== -->
    <div id="authRegister" style="display:none">
      <div style="display:grid;gap:10px">
        <input class="login-input" id="regName" type="text" placeholder="üë§ –§–ò–û *">
        <input class="login-input" id="regPhone" type="tel" placeholder="üì± –¢–µ–ª–µ—Ñ–æ–Ω * (+7 900 123-45-67)">
        <input class="login-input" id="regUsername" type="text" placeholder="üí¨ Telegram @—Ç–µ–≥">
        <select class="login-input" id="regProject" style="padding:12px 16px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-size:14px">
          <option value="">üìÇ –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç *</option>
          <option value="–°–∞–π—Ç—ã">üåê –°–∞–π—Ç—ã</option>
          <option value="–†–ö–¢">üè• –†–ö–¢</option>
        </select>
        <div style="position:relative">
          <input class="login-input" id="regPass" type="password" placeholder="üîí –ü–∞—Ä–æ–ª—å * (–º–∏–Ω. 4 —Å–∏–º–≤–æ–ª–∞)" autocomplete="new-password" style="padding-right:44px">
          <button onclick="togglePassVis('regPass',this)" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;font-size:16px;color:var(--text3)">üëÅ</button>
        </div>
        <div style="position:relative">
          <input class="login-input" id="regPass2" type="password" placeholder="üîí –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å *" autocomplete="new-password" onkeydown="if(event.key==='Enter')doPasswordRegister()" style="padding-right:44px">
          <button onclick="togglePassVis('regPass2',this)" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;font-size:16px;color:var(--text3)">üëÅ</button>
        </div>
      </div>
      <button class="login-btn" style="margin-top:14px" onclick="doPasswordRegister()">
        <span id="regBtnText">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</span>
      </button>
      <div class="login-error" id="regError"></div>

      <div style="display:flex;align-items:center;gap:12px;margin:18px 0 14px">
        <div style="flex:1;height:1px;background:var(--border)"></div>
        <span style="font-size:11px;color:var(--text3)">–∏–ª–∏</span>
        <div style="flex:1;height:1px;background:var(--border)"></div>
      </div>

      <button class="tg-login-btn" onclick="doTelegramLogin()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="flex-shrink:0"><path d="M12 0C5.37 0 0 5.37 0 12s5.37 12 12 12 12-5.37 12-12S18.63 0 12 0zm5.94 8.13l-1.97 9.28c-.15.67-.54.83-1.09.52l-3.02-2.23-1.45 1.4c-.16.16-.3.3-.61.3l.22-3.05 5.55-5.02c.24-.22-.05-.33-.37-.13l-6.87 4.33-2.96-.92c-.64-.2-.66-.64.13-.95l11.57-4.46c.54-.2 1.01.13.83.93z"/></svg>
        –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram
      </button>
    </div>

    <!-- ===== FORGOT PASSWORD ===== -->
    <div id="authForgot" style="display:none">
      <div style="text-align:center;margin-bottom:16px">
        <div style="font-size:36px;margin-bottom:8px">üîë</div>
        <div style="font-size:14px;color:var(--text2)">–í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω, @—Ç–µ–≥ –∏–ª–∏ Telegram ID.<br>–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –ø—Ä–∏–¥—ë—Ç –≤ Telegram.</div>
      </div>
      <input class="login-input" id="forgotId" type="text" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω, @telegram –∏–ª–∏ Telegram ID">
      <button class="login-btn" style="margin-top:12px" onclick="doForgotPass()">
        <span id="forgotBtnText">–°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å</span>
      </button>
      <div class="login-error" id="forgotError"></div>
      <div style="text-align:center;margin-top:12px">
        <a href="#" onclick="showAuthTab('login');return false" style="color:var(--accent);font-size:13px">‚Üê –ù–∞–∑–∞–¥ –∫ –≤—Ö–æ–¥—É</a>
      </div>
    </div>
  </div>
</div>

<button class="mobile-toggle" id="mobileToggle" onclick="toggleSidebar()">‚ò∞</button>

<!-- MAIN APP -->
<div class="app" id="mainApp" style="display:none">

  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="logo-section">
      <h1>RKT HUB</h1>
      <div class="subtitle">v6.0 ‚Ä¢ –ü—Ä–æ–µ–∫—Ç—ã + –ò–ò</div>
    </div>

    <nav class="nav">
      <div class="nav-section">–ì–ª–∞–≤–Ω–æ–µ</div>
      <a class="nav-item active" onclick="showPage('home')" data-page="home">
        <span class="icon">üè†</span><span class="label">–ü—Ä–æ–µ–∫—Ç—ã</span>
      </a>
      <a class="nav-item" onclick="showPage('dashboard')" data-page="dashboard">
        <span class="icon">üìä</span><span class="label">–î–∞—à–±–æ—Ä–¥ –ì–î</span>
      </a>
      <a class="nav-item" onclick="toggleAiPanel()" data-page="ai" style="border:1px solid rgba(177,151,252,0.2)">
        <span class="icon">ü§ñ</span><span class="label">–ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç</span>
        <span class="badge" style="background:var(--purple)">AI</span>
      </a>

      <div class="nav-section">–î–∞–Ω–Ω—ã–µ</div>
      <a class="nav-item" onclick="showPage('partners')" data-page="partners">
        <span class="icon">ü§ù</span><span class="label">–ü–∞—Ä—Ç–Ω—ë—Ä—ã</span>
        <span class="badge" id="badge-partners">0</span>
      </a>
      <a class="nav-item" onclick="showPage('tasks')" data-page="tasks">
        <span class="icon">‚úÖ</span><span class="label">–ó–∞–¥–∞—á–∏</span>
        <span class="badge" id="badge-tasks">0</span>
      </a>
      <a class="nav-item" onclick="showPage('comms')" data-page="comms">
        <span class="icon">üí¨</span><span class="label">–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏</span>
      </a>

      <div class="nav-section">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>
      <a class="nav-item" onclick="showPage('staff')" data-page="staff" id="nav-staff">
        <span class="icon">üë•</span><span class="label">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</span>
      </a>
      <a class="nav-item" onclick="showPage('approvals')" data-page="approvals" id="nav-approvals">
        <span class="icon">üìã</span><span class="label">–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è</span>
        <span class="badge badge-orange" id="badge-approvals">0</span>
      </a>

      <div class="nav-section">–°–∏—Å—Ç–µ–º–∞</div>
      <a class="nav-item" onclick="showPage('settings')" data-page="settings">
        <span class="icon">‚öôÔ∏è</span><span class="label">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
      </a>
    </nav>

    <div class="user-bar" id="userBar">
      <div class="user-info">
        <div class="user-avatar" id="userAvatar">?</div>
        <div>
          <div class="user-name" id="userName">‚Äî</div>
          <div class="user-role-text" id="userRoleText">‚Äî</div>
        </div>
      </div>
      <button class="logout-btn" onclick="doLogout()">üö™ –í—ã–π—Ç–∏</button>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="main">

    <!-- ======== HOME: TOP-LEVEL PROJECTS ======== -->
    <div class="page active" id="page-home">
      <div class="page-header">
        <h2>üè† –ú–æ–∏ –ø—Ä–æ–µ–∫—Ç—ã</h2>
        <div class="actions">
          <button class="btn" onclick="toggleAiPanel()" style="background:linear-gradient(135deg,var(--purple),#7950f2);color:#fff">ü§ñ –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç</button>
          <button class="btn btn-secondary" onclick="loadData()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
      </div>
      <div class="metrics" id="home-metrics"></div>
      <div class="project-grid" id="project-grid"></div>
    </div>

    <!-- ======== PROJECT VIEW (subprojects) ======== -->
    <div class="page" id="page-project">
      <div class="breadcrumb">
        <a onclick="showPage('home')">üè† –ü—Ä–æ–µ–∫—Ç—ã</a>
        <span class="sep">‚Ä∫</span>
        <span class="current" id="pv-name">‚Äî</span>
      </div>
      <div class="page-header">
        <h2 id="pv-title">üìÅ –ü—Ä–æ–µ–∫—Ç</h2>
        <div class="actions">
          <button class="btn btn-primary" id="btn-add-sub" onclick="openAddSubproject()">+ –ö–ª–∏–µ–Ω—Ç</button>
          <button class="btn btn-primary" id="btn-quick-site" onclick="openQuickSiteTask()" style="display:none;background:linear-gradient(135deg,#FF6B35,#F7931E)">üåê + –ö–ª–∏–µ–Ω—Ç (—Å—Å—ã–ª–∫–∞)</button>
          <button class="btn btn-primary" onclick="openModal('task')">+ –ó–∞–¥–∞—á–∞</button>
          <button class="btn btn-secondary" onclick="openModal('partner')">+ –ü–∞—Ä—Ç–Ω—ë—Ä</button>
        </div>
      </div>
      <div class="metrics" id="pv-metrics"></div>
      <div class="subproject-grid" id="subproject-grid"></div>

      <!-- Project-level tabs -->
      <div class="tabs" id="pv-tabs">
        <div class="tab active" data-tab="overview" onclick="showPvTab('overview')">üìä –û–±–∑–æ—Ä</div>
        <div class="tab" data-tab="tasks" onclick="showPvTab('tasks')">‚úÖ –ó–∞–¥–∞—á–∏</div>
        <div class="tab" data-tab="partners" onclick="showPvTab('partners')">ü§ù –ü–∞—Ä—Ç–Ω—ë—Ä—ã</div>
        <div class="tab" data-tab="staff" onclick="showPvTab('staff')">üë• –ö–æ–º–∞–Ω–¥–∞</div>
        <div class="tab" data-tab="timeline" onclick="showPvTab('timeline')">üìÖ –ü–ª–∞–Ω-–≥—Ä–∞—Ñ–∏–∫</div>
        <div class="tab" data-tab="comms" onclick="showPvTab('comms')">üí¨ –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏</div>
        <div class="tab tab-finance" data-tab="finance" onclick="showPvTab('finance')" style="display:none">üí∞ –§–∏–Ω–∞–Ω—Å—ã</div>
        <div class="tab tab-salaries" data-tab="salaries" onclick="showPvTab('salaries')" style="display:none">üë• –ó–∞—Ä–ø–ª–∞—Ç—ã</div>
      </div>
      <div id="pv-content"></div>
    </div>

    <!-- ======== SUBPROJECT VIEW (workspace) ======== -->
    <div class="page" id="page-subproject">
      <div class="breadcrumb">
        <a onclick="showPage('home')">üè† –ü—Ä–æ–µ–∫—Ç—ã</a>
        <span class="sep">‚Ä∫</span>
        <a onclick="openProject(currentProject)" id="sp-parent">‚Äî</a>
        <span class="sep">‚Ä∫</span>
        <span class="current" id="sp-name">‚Äî</span>
      </div>
      <div class="page-header">
        <h2 id="sp-title">üìÅ –ü–æ–¥–ø—Ä–æ–µ–∫—Ç</h2>
        <div class="actions" id="sp-actions">
          <button class="btn btn-primary" onclick="openModal('task')">+ –ó–∞–¥–∞—á–∞</button>
          <button class="btn btn-primary" onclick="openModal('partner')">+ –ü–∞—Ä—Ç–Ω—ë—Ä</button>
          <button class="btn btn-secondary" onclick="openModal('comm')">+ –ö–æ–Ω—Ç–∞–∫—Ç</button>
        </div>
      </div>
      <!-- Client quick-info bar (for –°–∞–π—Ç—ã only) -->
      <div id="sp-client-bar" style="display:none"></div>
      <div class="metrics" id="sp-metrics"></div>

      <div class="tabs" id="sp-tabs">
        <div class="tab active" data-tab="overview" onclick="showSpTab('overview')">üìä –û–±–∑–æ—Ä</div>
        <div class="tab" data-tab="tasks" onclick="showSpTab('tasks')">‚úÖ –ó–∞–¥–∞—á–∏</div>
        <div class="tab" data-tab="client-info" onclick="showSpTab('client-info')" style="display:none">üìã –ê–Ω–∫–µ—Ç–∞</div>
        <div class="tab" data-tab="partners" onclick="showSpTab('partners')">ü§ù –ü–∞—Ä—Ç–Ω—ë—Ä—ã</div>
        <div class="tab" data-tab="projects" onclick="showSpTab('projects')">üìÅ –ü—Ä–æ–µ–∫—Ç—ã</div>
        <div class="tab" data-tab="comms" onclick="showSpTab('comms')">üí¨ –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏</div>
        <div class="tab" data-tab="files" onclick="showSpTab('files')">üìÑ –î–æ–∫—É–º–µ–Ω—Ç—ã</div>
        <div class="tab tab-sitegen" data-tab="sitegen" onclick="showSpTab('sitegen')" style="display:none">üåê –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å–∞–π—Ç–æ–≤</div>
      </div>
      <div id="sp-content"></div>
    </div>

    <!-- ======== TASK DETAIL with AI ======== -->
    <div class="page" id="page-taskdetail">
      <div class="breadcrumb" id="td-breadcrumb"></div>
      <div id="td-content"></div>
    </div>

    <!-- ======== DASHBOARD ======== -->
    <div class="page" id="page-dashboard">
      <div class="page-header">
        <h2>üìä –î–∞—à–±–æ—Ä–¥ –≥–µ–Ω–µ—Ä–∞–ª—å–Ω–æ–≥–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞</h2>
        <div class="actions">
          <button class="btn btn-secondary" onclick="loadData()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
      </div>
      <div class="metrics" id="dash-metrics"></div>
      <div id="dash-revenue-chart"></div>
      <div id="dash-pipeline-summary" style="margin-bottom:16px"></div>
      <div id="dash-earnings" style="margin-bottom:16px"></div>
      <div class="card" style="border:1px solid rgba(177,151,252,0.2);background:linear-gradient(135deg,rgba(177,151,252,0.03),rgba(121,80,242,0.01))">
        <div class="card-header" style="display:flex;align-items:center;justify-content:space-between">
          <h3>ü§ñ –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç</h3>
          <button class="btn btn-sm" onclick="toggleAiPanel()" style="background:linear-gradient(135deg,var(--purple),#7950f2);color:#fff;border:none;font-size:11px">–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç ‚Üí</button>
        </div>
        <div style="padding:0 20px 16px;display:flex;gap:8px;flex-wrap:wrap">
          <button onclick="toggleAiPanel();setTimeout(()=>globalAiQuick('–°–æ—Å—Ç–∞–≤—å –æ—Ç—á—ë—Ç –ø–æ –≤—Å–µ–º –ø—Ä–æ–µ–∫—Ç–∞–º'),300)" style="padding:8px 16px;border-radius:20px;border:1px solid rgba(177,151,252,0.25);background:rgba(177,151,252,0.06);color:var(--purple);font-family:'JetBrains Mono',monospace;font-size:11px;cursor:pointer;transition:all .2s">üìä –û—Ç—á—ë—Ç –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º</button>
          <button onclick="toggleAiPanel();setTimeout(()=>globalAiQuick('–ö–∞–∫–∏–µ –∑–∞–¥–∞—á–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω—ã?'),300)" style="padding:8px 16px;border-radius:20px;border:1px solid rgba(177,151,252,0.25);background:rgba(177,151,252,0.06);color:var(--purple);font-family:'JetBrains Mono',monospace;font-size:11px;cursor:pointer;transition:all .2s">üî¥ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ</button>
          <button onclick="toggleAiPanel();setTimeout(()=>globalAiQuick('–ü–æ–¥–≥–æ—Ç–æ–≤—å –ø–ª–∞–Ω –Ω–∞ –Ω–µ–¥–µ–ª—é'),300)" style="padding:8px 16px;border-radius:20px;border:1px solid rgba(177,151,252,0.25);background:rgba(177,151,252,0.06);color:var(--purple);font-family:'JetBrains Mono',monospace;font-size:11px;cursor:pointer;transition:all .2s">üìã –ü–ª–∞–Ω –Ω–∞ –Ω–µ–¥–µ–ª—é</button>
          <button onclick="toggleAiPanel();setTimeout(()=>globalAiQuick('–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ä–∏—Å–∫–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤'),300)" style="padding:8px 16px;border-radius:20px;border:1px solid rgba(177,151,252,0.25);background:rgba(177,151,252,0.06);color:var(--purple);font-family:'JetBrains Mono',monospace;font-size:11px;cursor:pointer;transition:all .2s">‚ö†Ô∏è –†–∏—Å–∫–∏</button>
        </div>
      </div>
      <div class="card">
        <div class="card-header"><h3>üî¥ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏</h3></div>
        <div class="table-wrap"><table><thead><tr><th>–ó–∞–¥–∞—á–∞</th><th>–ü—Ä–æ–µ–∫—Ç</th><th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th><th>–î–µ–¥–ª–∞–π–Ω</th><th>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th><th></th></tr></thead><tbody id="dash-overdue"></tbody></table></div>
      </div>
      <div class="card">
        <div class="card-header"><h3>üìÅ –í—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã</h3></div>
        <div class="table-wrap"><table><thead><tr><th>–ü—Ä–æ–µ–∫—Ç</th><th>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ü—Ä–æ–≥—Ä–µ—Å—Å</th><th>–î–µ–¥–ª–∞–π–Ω</th></tr></thead><tbody id="dash-projects"></tbody></table></div>
      </div>
      <div class="card">
        <div class="card-header"><h3>üí¨ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏</h3></div>
        <div class="table-wrap"><table><thead><tr><th>–ü–∞—Ä—Ç–Ω—ë—Ä</th><th>–¢–∏–ø</th><th>–¢–µ–º–∞</th><th>–î–∞—Ç–∞</th><th>–ê–≤—Ç–æ—Ä</th></tr></thead><tbody id="dash-comms"></tbody></table></div>
      </div>
    </div>

    <!-- ======== PARTNERS ======== -->
    <div class="page" id="page-partners">
      <div class="page-header">
        <h2>ü§ù –í—Å–µ –ø–∞—Ä—Ç–Ω—ë—Ä—ã</h2>
        <div class="actions">
          <button class="btn btn-primary" id="btn-add-partner" onclick="openModal('partner')">+ –ü–∞—Ä—Ç–Ω—ë—Ä</button>
          <button class="btn btn-secondary" onclick="exportCSV('partners')">üì• CSV</button>
        </div>
      </div>
      <div class="filters-bar">
        <div id="partner-filters"></div>
        <input class="search-input" id="partner-search" placeholder="üîç –ü–æ–∏—Å–∫..." oninput="renderPartners()">
      </div>
      <div class="card"><div class="table-wrap"><table>
        <thead><tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–°—Ç—Ä–∞–Ω–∞</th><th>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</th><th>–ü—Ä–æ–¥—É–∫—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ö–æ–Ω—Ç–∞–∫—Ç</th><th></th></tr></thead>
        <tbody id="partners-table"></tbody>
      </table></div></div>
    </div>

    <!-- ======== TASKS ======== -->
    <div class="page" id="page-tasks">
      <div class="page-header">
        <h2>‚úÖ –í—Å–µ –∑–∞–¥–∞—á–∏</h2>
        <div class="actions">
          <button class="btn btn-primary" onclick="openModal('task')">+ –ó–∞–¥–∞—á–∞</button>
          <button class="btn btn-secondary" onclick="exportCSV('tasks')">üì• CSV</button>
        </div>
      </div>
      <div class="filters-bar" style="display:flex;flex-direction:column;gap:8px">
        <div id="task-filters"></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <select id="task-filter-status" onchange="renderTasks()" style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:6px 10px;color:var(--text);font-family:inherit;font-size:12px">
            <option value="active">üìã –ê–∫—Ç–∏–≤–Ω—ã–µ</option>
            <option value="–í—Å–µ">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
            <option value="‚è≥ –í –æ—á–µ—Ä–µ–¥–∏">‚è≥ –í –æ—á–µ—Ä–µ–¥–∏</option>
            <option value="üîÑ –í —Ä–∞–±–æ—Ç–µ">üîÑ –í —Ä–∞–±–æ—Ç–µ</option>
            <option value="‚úÖ –ì–æ—Ç–æ–≤–æ">‚úÖ –ì–æ—Ç–æ–≤–æ</option>
          </select>
          <select id="task-filter-person" onchange="renderTasks()" style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:6px 10px;color:var(--text);font-family:inherit;font-size:12px">
            <option value="–í—Å–µ">üë§ –í—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</option>
          </select>
          <label style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text2);cursor:pointer">
            <input type="checkbox" id="task-show-gantt" onchange="renderTasks()"> üìÖ –ü–æ–∫–∞–∑–∞—Ç—å –ø–ª–∞–Ω-–≥—Ä–∞—Ñ–∏–∫
          </label>
          <input class="search-input" id="task-search" placeholder="üîç –ü–æ–∏—Å–∫..." oninput="renderTasks()">
        </div>
      </div>
      <div id="task-gantt" style="margin-bottom:12px"></div>
      <div class="card"><div class="table-wrap"><table>
        <thead><tr><th>–ó–∞–¥–∞—á–∞</th><th>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</th><th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th><th>–î–µ–¥–ª–∞–π–Ω</th><th></th></tr></thead>
        <tbody id="tasks-table"></tbody>
      </table></div></div>
    </div>

    <!-- ======== STAFF ======== -->
    <div class="page" id="page-staff">
      <div class="page-header">
        <h2>üë• –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</h2>
        <div class="actions">
          <button class="btn btn-primary" id="btn-add-staff" onclick="openModal('staff')">+ –°–æ—Ç—Ä—É–¥–Ω–∏–∫</button>
        </div>
      </div>
      <!-- Step 1: Choose project -->
      <div class="staff-projects" id="staff-projects">
        <div class="tabs" id="staff-project-tabs"></div>
      </div>
      <!-- Step 2: Choose direction (after project selected) -->
      <div class="staff-directions" id="staff-direction-tabs" style="margin-top:8px"></div>
      <!-- Stats & Search -->
      <div style="display:flex;align-items:center;gap:12px;margin:12px 0;flex-wrap:wrap">
        <div id="staff-stats" style="flex:1"></div>
        <input type="text" id="staff-search" placeholder="üîç –ü–æ–∏—Å–∫..." oninput="renderStaff()" style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 14px;color:var(--text);font-family:inherit;font-size:13px;width:200px">
      </div>
      <!-- Pending registrations (CEO only) -->
      <div id="staff-pending" style="margin-bottom:16px"></div>
      <div id="staff-content"></div>
    </div>

    <!-- ======== APPROVALS ======== -->
    <div class="page" id="page-approvals">
      <div class="page-header"><h2>üìã –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è</h2></div>
      <div id="approvals-content"></div>
    </div>

    <!-- ======== COMMS ======== -->
    <div class="page" id="page-comms">
      <div class="page-header">
        <h2>üí¨ –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏</h2>
        <div class="actions">
          <button class="btn btn-primary" onclick="openModal('comm')">+ –ö–æ–Ω—Ç–∞–∫—Ç</button>
        </div>
      </div>
      <div class="filters-bar">
        <input class="search-input" id="comm-search" placeholder="üîç –ü–æ–∏—Å–∫..." oninput="renderComms()">
      </div>
      <div class="card"><div class="table-wrap"><table>
        <thead><tr><th>–ü–∞—Ä—Ç–Ω—ë—Ä</th><th>–¢–∏–ø</th><th>–¢–µ–º–∞</th><th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th><th>–î–∞—Ç–∞</th><th>–ê–≤—Ç–æ—Ä</th><th></th></tr></thead>
        <tbody id="comms-table"></tbody>
      </table></div></div>
    </div>

    <!-- ======== SETTINGS ======== -->
    <div class="page" id="page-settings">
      <div class="page-header"><h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2></div>
      <div class="card" style="padding:28px">
        <h3 style="margin-bottom:20px;font-size:15px">üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h3>
        <div class="form-group"><label>üîó Supabase URL</label><input type="text" id="settingsApiUrl" readonly onchange="updateConfig('API_URL',this.value)" style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 12px;color:var(--text);width:100%;font-family:monospace;font-size:12px"></div>
        <div class="form-group"><label>AI URL</label><input type="text" id="settingsAiUrl" onchange="updateConfig('AI_URL',this.value)" style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 12px;color:var(--text);width:100%;font-family:monospace;font-size:12px"></div>
        <div class="form-group"><label>ü§ñ Telegram Bot (@username)</label><input type="text" id="settingsTgBot" onchange="updateConfig('TG_BOT',this.value)" placeholder="RktHubBot" style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 12px;color:var(--text);width:100%;font-family:monospace;font-size:12px"></div>
        <div class="form-group"><label>üîë Telegram Bot Token</label><input type="password" id="settingsTgToken" onchange="updateConfig('TG_BOT_TOKEN',this.value)" placeholder="123456:ABC-..." style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 12px;color:var(--text);width:100%;font-family:monospace;font-size:12px"></div>
        <div class="form-group"><label>üì¶ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</label><input type="text" id="settingsWriteUrl" value="Supabase PostgreSQL" readonly onchange="updateConfig('WRITE_URL',this.value)" style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 12px;color:var(--text);width:100%;font-family:monospace;font-size:12px"></div>
        <div class="form-group"><label>üìã –°—Ç–∞—Ç—É—Å</label><input type="text" id="settingsSheetId" value="‚úÖ Supabase –ø–æ–¥–∫–ª—é—á–µ–Ω–∞" readonly onchange="updateConfig('SHEET_ID',this.value)" placeholder="1Te4CsdcN1rvpznHNyPa24MuH5ZSx45DUUDREWO5mtoE" style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 12px;color:var(--accent);width:100%;font-family:monospace;font-size:12px;font-weight:600"></div>
        <p style="font-size:11px;color:var(--text3);margin-top:-8px">–°–∫–æ–ø–∏—Ä—É–π—Ç–µ ID –∏–∑ URL —Ç–∞–±–ª–∏—Ü—ã: docs.google.com/spreadsheets/d/<b style="color:var(--accent)">–í–û–¢_–≠–¢–û–¢_ID</b>/edit</p>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="btn btn-primary" onclick="saveSettings()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button class="btn btn-secondary" onclick="testConnection()">üîå –¢–µ—Å—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</button>
        </div>
        <div id="settings-status" style="margin-top:8px;font-size:12px"></div>
      </div>
      <div class="card" style="padding:28px;margin-top:16px">
        <h3 style="margin-bottom:20px;font-size:15px">üë§ –ü—Ä–æ—Ñ–∏–ª—å</h3>
        <div class="detail-grid">
          <div class="detail-item"><div class="detail-label">–ò–º—è</div><div class="detail-value" id="s-name">‚Äî</div></div>
          <div class="detail-item"><div class="detail-label">–†–æ–ª—å</div><div class="detail-value" id="s-role">‚Äî</div></div>
          <div class="detail-item"><div class="detail-label">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div><div class="detail-value" id="s-dir">‚Äî</div></div>
          <div class="detail-item"><div class="detail-label">Telegram ID</div><div class="detail-value" id="s-tgid">‚Äî</div></div>
          <div class="detail-item"><div class="detail-label">–¢–µ–ª–µ—Ñ–æ–Ω</div><div class="detail-value" id="s-phone">‚Äî</div></div>
        </div>
        <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border);display:flex;gap:8px">
          <button class="btn btn-secondary" onclick="changeMyPassword()" style="font-size:13px">üîí –°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
          <button class="btn btn-danger" onclick="doLogout()" style="font-size:13px">üö™ –í—ã–π—Ç–∏</button>
        </div>
      </div>
      <div class="card" style="padding:28px;margin-top:16px">
        <h3 style="margin-bottom:16px;font-size:15px">üîê –ó–æ–Ω—ã –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏</h3>
        <div id="s-perms" style="font-size:13px;line-height:2"></div>
        </div>
      </div>
      <!-- Statistics section removed per CEO request -->
    </div>

  </main>
</div>


<!-- ======== KANBAN PIPELINE VIEW ======== -->
<div class="page" id="page-kanban">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:10px">
    <div>
      <h2 style="font-size:22px;font-weight:700">üîÑ –í–æ—Ä–æ–Ω–∫–∞ –ø—Ä–æ–¥–∞–∂</h2>
      <p style="font-size:13px;color:var(--text3);margin-top:4px">Drag-and-drop –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è —Å–¥–µ–ª–æ–∫</p>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <select id="kanban-filter-manager" onchange="renderKanban()" style="padding:6px 12px;border-radius:6px;border:1px solid var(--border);background:var(--bg3);color:var(--text);font-size:12px"><option value="">–í—Å–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã</option></select>
      <button class="btn btn-primary btn-sm" onclick="openAddSubproject()">+ –ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç</button>
    </div>
  </div>
  <div id="kanban-container" class="kanban-wrap"></div>
</div>

<!-- ======== SLIDE-OVER DEAL CARD ======== -->
<div class="slideover-overlay" id="slideoverOverlay" onclick="if(event.target===this)closeSlideOver()"></div>
<div class="slideover" id="slideoverPanel">
  <div class="so-header">
    <div>
      <h3 id="so-name" style="font-size:20px;font-weight:700">–ö–ª–∏–µ–Ω—Ç</h3>
      <p id="so-type" style="font-size:12px;color:var(--text3);margin-top:2px"></p>
    </div>
    <button class="so-close" onclick="closeSlideOver()">‚úï</button>
  </div>
  <div class="so-body">
    <div id="so-workflow-banner"></div>
    <div class="so-progress" id="so-progress"></div>
    <div class="so-stage-labels" id="so-stage-labels"></div>
    <div class="so-section">
      <h4>üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
      <div class="so-detail-grid" id="so-details"></div>
    </div>
    <div class="so-section">
      <h4>‚ö° –î–µ–π—Å—Ç–≤–∏—è</h4>
      <div class="so-actions" id="so-actions"></div>
    </div>
    <div class="so-section">
      <h4>üìã –ó–∞–¥–∞—á–∏</h4>
      <ul class="so-checklist" id="so-tasks"></ul>
    </div>
    <button class="so-next-btn" id="so-next-btn" onclick="advanceDealStage()">‚û°Ô∏è –ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø</button>
  </div>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this)closeModal()">
  <div class="modal" id="modalBox">
    <div class="modal-header">
      <h3 id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å</h3>
      <button class="modal-close" onclick="closeModal()">‚úï</button>
    </div>
    <div class="modal-body" id="modalBody"></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary" id="modalSaveBtn" onclick="saveModal()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- DETAIL MODAL -->
<div class="modal-overlay" id="detailOverlay" onclick="if(event.target===this)closeDetail()">
  <div class="modal" style="width:620px">
    <div class="modal-header">
      <h3 id="detailTitle">–î–µ—Ç–∞–ª–∏</h3>
      <button class="modal-close" onclick="closeDetail()">‚úï</button>
    </div>
    <div class="modal-body" id="detailBody"></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeDetail()">–ó–∞–∫—Ä—ã—Ç—å</button>
      <button class="btn btn-primary" id="detailEditBtn">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>
  </div>
</div>

<!-- CONFIRM -->
<div class="confirm-overlay" id="confirmOverlay">
  <div class="confirm-box">
    <div class="icon">‚ö†Ô∏è</div>
    <h4 id="confirmTitle">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h4>
    <p id="confirmText">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</p>
    <div class="confirm-actions">
      <button class="btn btn-secondary" onclick="closeConfirm(false)">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-danger" onclick="closeConfirm(true)">üóë –£–¥–∞–ª–∏—Ç—å</button>
    </div>
  </div>
</div>

<button id="aiFab" onclick="toggleAiPanel()" style="position:fixed;bottom:40px;right:28px;width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,#b197fc,#7950f2);border:none;color:#fff;font-size:28px;cursor:pointer;z-index:500;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 24px rgba(177,151,252,0.4);transition:all .3s">ü§ñ</button>

<div id="aiGlobalPanel" style="position:fixed;bottom:40px;right:28px;width:440px;max-width:calc(100vw - 56px);height:600px;max-height:calc(100vh - 80px);background:var(--bg2);border:1px solid var(--purple);border-radius:16px;z-index:600;display:none;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,0.6),0 0 40px rgba(177,151,252,0.1)">
  <div style="display:flex;align-items:center;justify-content:space-between;padding:16px 20px;background:linear-gradient(135deg,rgba(177,151,252,0.12),rgba(121,80,242,0.06));border-bottom:1px solid rgba(177,151,252,0.2);border-radius:16px 16px 0 0">
    <h4 style="font-size:15px;font-weight:700;color:var(--purple);display:flex;align-items:center;gap:10px">ü§ñ –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç RKT HUB</h4>
    <button onclick="toggleAiPanel()" style="width:30px;height:30px;border-radius:50%;border:1px solid rgba(177,151,252,0.3);background:transparent;color:var(--text2);cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center">‚úï</button>
  </div>
  <div style="padding:10px 16px;border-bottom:1px solid rgba(177,151,252,0.1);display:flex;gap:6px;flex-wrap:wrap">
    <button onclick="globalAiQuick('–ö–∞–∫–∏–µ –∑–∞–¥–∞—á–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω—ã?')" style="padding:5px 12px;border-radius:16px;border:1px solid rgba(177,151,252,0.25);background:rgba(177,151,252,0.05);color:var(--purple);font-family:'JetBrains Mono',monospace;font-size:10px;cursor:pointer">üî¥ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</button>
    <button onclick="globalAiQuick('–°–æ—Å—Ç–∞–≤—å –æ—Ç—á—ë—Ç –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º')" style="padding:5px 12px;border-radius:16px;border:1px solid rgba(177,151,252,0.25);background:rgba(177,151,252,0.05);color:var(--purple);font-family:'JetBrains Mono',monospace;font-size:10px;cursor:pointer">üìä –û—Ç—á—ë—Ç</button>
    <button onclick="globalAiQuick('–ù–∞–ø–∏—à–∏ –¥–µ–ª–æ–≤–æ–µ –ø–∏—Å—å–º–æ')" style="padding:5px 12px;border-radius:16px;border:1px solid rgba(177,151,252,0.25);background:rgba(177,151,252,0.05);color:var(--purple);font-family:'JetBrains Mono',monospace;font-size:10px;cursor:pointer">üìß –ü–∏—Å—å–º–æ</button>
    <button onclick="globalAiQuick('–ö–∞–∫–∏–µ –∑–∞–¥–∞—á–∏ —Å–∞–º—ã–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ?')" style="padding:5px 12px;border-radius:16px;border:1px solid rgba(177,151,252,0.25);background:rgba(177,151,252,0.05);color:var(--purple);font-family:'JetBrains Mono',monospace;font-size:10px;cursor:pointer">‚≠ê –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã</button>
    <button onclick="globalAiQuick('–ü–æ–¥–≥–æ—Ç–æ–≤—å –ø–ª–∞–Ω –Ω–∞ –Ω–µ–¥–µ–ª—é')" style="padding:5px 12px;border-radius:16px;border:1px solid rgba(177,151,252,0.25);background:rgba(177,151,252,0.05);color:var(--purple);font-family:'JetBrains Mono',monospace;font-size:10px;cursor:pointer">üìã –ü–ª–∞–Ω</button>
  </div>
  <div id="ai-global-messages" style="flex:1;padding:16px;overflow-y:auto;display:flex;flex-direction:column;gap:10px">
    <div class="ai-msg system">–ü—Ä–∏–≤–µ—Ç! –Ø –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç RKT HUB. –ü–æ–º–æ–≥—É —Å –∑–∞–¥–∞—á–∞–º–∏, –ö–ü, –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º.</div>
    <div style="display:flex;flex-wrap:wrap;gap:6px;padding:0 16px 8px">
      <button onclick="aiQuick('–ü–æ–¥–≥–æ—Ç–æ–≤—å –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ (–ö–ü) –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞')" style="padding:6px 12px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text2);font-size:11px;cursor:pointer;font-family:inherit">üìÑ –°–æ–∑–¥–∞—Ç—å –ö–ü</button>
      <button onclick="aiQuick('–ü–æ–∫–∞–∂–∏ –æ—Ç—á—ë—Ç –ø–æ –∑–∞–¥–∞—á–∞–º –∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–º')" style="padding:6px 12px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text2);font-size:11px;cursor:pointer;font-family:inherit">üìä –û—Ç—á—ë—Ç</button>
      <button onclick="aiQuick('–ß—Ç–æ –¥–µ–ª–∞—Ç—å –Ω–æ–≤–æ–º—É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É? –û–±—ä—è—Å–Ω–∏ –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–∏—Å—Ç–µ–º–∞')" style="padding:6px 12px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text2);font-size:11px;cursor:pointer;font-family:inherit">üÜò –ü–æ–º–æ—â—å</button>
      <button onclick="aiQuick('–°–æ—Å—Ç–∞–≤—å –ø–ª–∞–Ω —Ä–∞–±–æ—Ç—ã –Ω–∞ –Ω–µ–¥–µ–ª—é')" style="padding:6px 12px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text2);font-size:11px;cursor:pointer;font-family:inherit">üìã –ü–ª–∞–Ω</button>
    </div>
  </div>
  <div style="display:flex;gap:8px;padding:14px 16px;border-top:1px solid rgba(177,151,252,0.15);background:rgba(26,34,52,0.5);border-radius:0 0 16px 16px">
    <div style="display:flex;flex-direction:column;gap:4px;padding:8px 12px">
    <div id="ai-file-badge" style="display:none;font-size:11px;color:var(--accent);padding:2px 8px;background:var(--accent-glow);border-radius:6px;cursor:pointer" onclick="window._aiAttachedFile=null;this.style.display='none';toast('üìé –§–∞–π–ª –æ—Ç–≤—è–∑–∞–Ω','info')">üìé</div>
    <div style="display:flex;gap:8px">
    <button onclick="attachFileToAI()" style="padding:10px 12px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text2);cursor:pointer;font-size:16px" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª">üìé</button>
    <input id="ai-global-input" placeholder="–°–ø—Ä–æ—Å–∏—Ç–µ —á—Ç–æ —É–≥–æ–¥–Ω–æ..." onkeydown="if(event.key==='Enter')sendGlobalAi()" style="flex:1;padding:10px 16px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:13px">
    <button id="ai-global-send" onclick="sendGlobalAi()" style="padding:10px 18px;background:linear-gradient(135deg,var(--purple),#7950f2);color:#fff;border:none;border-radius:8px;font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:600;cursor:pointer">‚û§</button>
    </div></div>
  </div>
</div>

<div class="toast" id="toast"></div>
<div class="status-bar" id="statusBar">
  <button id="mobileMenuBtn" aria-label="–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é" onclick="toggleMobileMenu()" style="display:none;background:none;border:none;color:var(--text);font-size:24px;cursor:pointer;padding:4px 8px;margin-right:8px">‚ò∞</button>
  <div><span class="dot dot-green" id="statusDot"></span> <span id="statusText">–ü–æ–¥–∫–ª—é—á–µ–Ω–æ</span></div>
  <div style="margin-left:auto;display:flex;align-items:center;gap:12px">
    <div class="notif-bell" role="button" tabindex="0" aria-label="–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è" onclick="toggleNotifPanel()">üîî<span class="notif-badge" id="notifBadge" style="display:none">0</span></div>
    <div id="statusTime"></div>
  </div>
</div>

<script>
// ============================================================
// CONFIG & STATE
// ============================================================
const CONFIG = {
  SUPABASE_URL: 'https://prparzgqevfelwsndmkc.supabase.co',
  SUPABASE_KEY: 'sb_publishable_gFeXATQGYxKx08BpeOedZg_7buTwVJq',
  AI_URL: 'https://daniyal2212.app.n8n.cloud/webhook/rkt-ai',
  TG_BOT: 'AIhroject_bot',    // @username –±–æ—Ç–∞ –±–µ–∑ @
  TG_BOT_TOKEN: '',           // –¢–æ–∫–µ–Ω –±–æ—Ç–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π (–∑–∞–ø–æ–ª–Ω–∏—Ç—å!)
  REFRESH: 120000,
  VERSION: '14.1.0'
};

// Debounce utility ‚Äî prevents multiple rapid calls
function debounce(fn, delay) {
  let timer = null;
  let running = false;
  return function(...args) {
    if (timer) clearTimeout(timer);
    timer = setTimeout(async () => {
      if (running) return;
      running = true;
      try { await fn.apply(this, args); } finally { running = false; }
    }, delay);
  };
}
const debouncedLoadData = debounce(() => loadData(), 500);

// filterByRole cache ‚Äî invalidated on each loadData
let _filterCache = new Map();
let _filterCacheVersion = 0;

// Supabase client
let SB = null;
try {
  if (window.supabase) {
    SB = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);
  } else {
    console.error('Supabase library not loaded! Check CDN or internet connection.');
  }
} catch(e) {
  console.error('Supabase init error:', e);
}

// ============================================================
// COLUMN MAPPING: Supabase (English) ‚Üî Frontend (Russian)
// ============================================================
const COL_MAP = {
  staff: {
    id:'ID', name:'–ò–º—è', role:'–†–æ–ª—å', project:'–ü—Ä–æ–µ–∫—Ç', direction:'–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ',
    telegram_id:'Telegram_ID', username:'Username', phone:'–¢–µ–ª–µ—Ñ–æ–Ω', email:'Email', hire_date:'–î–∞—Ç–∞_–Ω–∞–π–º–∞',
    status:'–°—Ç–∞—Ç—É—Å', created_at:'–î–∞—Ç–∞_–¥–æ–±–∞–≤–ª–µ–Ω–∏—è', updated_at:'–û–±–Ω–æ–≤–ª–µ–Ω–æ', pin_hash:'pin_hash',
    salary_pct:'–ü—Ä–æ—Ü–µ–Ω—Ç_–ó–ü', extra_projects:'–î–æ–ø_–ø—Ä–æ–µ–∫—Ç—ã'
  },
  partners: {
    id:'ID', name:'–ù–∞–∑–≤–∞–Ω–∏–µ', country:'–°—Ç—Ä–∞–Ω–∞', direction:'–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', product:'–ü—Ä–æ–¥—É–∫—Ç',
    status:'–°—Ç–∞—Ç—É—Å', contact:'–ö–æ–Ω—Ç–∞–∫—Ç', website:'–°–∞–π—Ç', notes:'–ü—Ä–∏–º–µ—á–∞–Ω–∏—è',
    created_at:'–î–∞—Ç–∞_–¥–æ–±–∞–≤–ª–µ–Ω–∏—è'
  },
  directions: {
    id:'ID', name:'–ù–∞–∑–≤–∞–Ω–∏–µ', project:'–ü—Ä–æ–µ–∫—Ç', status:'–°—Ç–∞—Ç—É—Å', stage:'stage',
    manager:'–ú–µ–Ω–µ–¥–∂–µ—Ä', description:'–û–ø–∏—Å–∞–Ω–∏–µ', link:'–°—Å—ã–ª–∫–∞', phone:'–¢–µ–ª–µ—Ñ–æ–Ω', city:'–ì–æ—Ä–æ–¥',
    site_type:'–¢–∏–ø —Å–∞–π—Ç–∞', price:'–¶–µ–Ω–∞', paid:'–û–ø–ª–∞—á–µ–Ω–æ', business_type:'–¢–∏–ø –±–∏–∑–Ω–µ—Å–∞',
    style:'–°—Ç–∏–ª—å', questionnaire:'–ê–Ω–∫–µ—Ç–∞', client_name:'–ö–ª–∏–µ–Ω—Ç', created_at:'–î–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è',
    services:'–£—Å–ª—É–≥–∏', comment:'–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π', address:'–ê–¥—Ä–µ—Å', social:'–°–æ—Ü—Å–µ—Ç–∏',
    work_hours:'–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã', prices:'–¶–µ–Ω—ã',
    source:'–ò—Å—Ç–æ—á–Ω–∏–∫', next_contact:'–°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç', touches:'–ö–∞—Å–∞–Ω–∏—è',
    reject_reason:'–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞', feedback:'–§–∏–¥–±–µ–∫', created:'–°–æ–∑–¥–∞–Ω',
    site_html:'site_html', site_url:'site_url',
    logo_url:'logo_url', photos:'photos'
  },
  tasks: {
    id:'ID', description:'–û–ø–∏—Å–∞–Ω–∏–µ', direction:'–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', project:'–ü—Ä–æ–µ–∫—Ç',
    priority:'–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç', status:'–°—Ç–∞—Ç—É—Å', deadline:'–î–µ–¥–ª–∞–π–Ω', assignee:'–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π',
    notes:'–ü—Ä–∏–º–µ—á–∞–Ω–∏—è', link:'–°—Å—ã–ª–∫–∞', comment:'–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π', created_at:'–î–∞—Ç–∞_–¥–æ–±–∞–≤–ª–µ–Ω–∏—è'
  },
  projects: {
    id:'ID', name:'–ù–∞–∑–≤–∞–Ω–∏–µ', direction:'–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', status:'–°—Ç–∞—Ç—É—Å', priority:'–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç',
    progress:'–ü—Ä–æ–≥—Ä–µ—Å—Å', partner:'–ü–∞—Ä—Ç–Ω—ë—Ä', budget:'–ë—é–¥–∂–µ—Ç', deadline:'–î–µ–¥–ª–∞–π–Ω',
    description:'–û–ø–∏—Å–∞–Ω–∏–µ', created_at:'–°–æ–∑–¥–∞–Ω–æ', updated_at:'–û–±–Ω–æ–≤–ª–µ–Ω–æ'
  },
  approvals: {
    id:'ID', type:'–¢–∏–ø', description:'–û–ø–∏—Å–∞–Ω–∏–µ', from_name:'–û—Ç_–∫–æ–≥–æ', from_role:'–†–æ–ª—å',
    telegram_id:'Telegram_ID', direction:'–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', project:'–ü—Ä–æ–µ–∫—Ç', sheet:'–õ–∏—Å—Ç',
    status:'–°—Ç–∞—Ç—É—Å', request_date:'–î–∞—Ç–∞_–∑–∞–ø—Ä–æ—Å–∞', decision_date:'–î–∞—Ç–∞_—Ä–µ—à–µ–Ω–∏—è',
    ceo_decision:'–†–µ—à–µ–Ω–∏–µ_CEO', data:'–î–∞–Ω–Ω—ã–µ', created_at:'–î–∞—Ç–∞_–¥–æ–±–∞–≤–ª–µ–Ω–∏—è'
  },
  communications: {
    id:'ID', partner:'–ü–∞—Ä—Ç–Ω—ë—Ä', type:'–¢–∏–ø', subject:'–¢–µ–º–∞', comm_date:'–î–∞—Ç–∞',
    author:'–ê–≤—Ç–æ—Ä', result:'–†–µ–∑—É–ª—å—Ç–∞—Ç', created_at:'–î–∞—Ç–∞_–¥–æ–±–∞–≤–ª–µ–Ω–∏—è'
  },
  documents: {
    id:'ID', filename:'–§–∞–π–ª', folder:'–ü–∞–ø–∫–∞', uploaded_by:'–ó–∞–≥—Ä—É–∑–∏–ª',
    upload_date:'–î–∞—Ç–∞', link:'–°—Å—ã–ª–∫–∞', drive_id:'Drive_ID', size:'–†–∞–∑–º–µ—Ä',
    created_at:'–î–∞—Ç–∞_–¥–æ–±–∞–≤–ª–µ–Ω–∏—è'
  }
};

// Reverse maps (Russian ‚Üí English) for writing
const COL_MAP_REV = {};
for (const [table, map] of Object.entries(COL_MAP)) {
  COL_MAP_REV[table] = {};
  for (const [en, ru] of Object.entries(map)) { COL_MAP_REV[table][ru] = en; }
}

function mapFromDb(table, rows) {
  const map = COL_MAP[table];
  if (!map) return rows;
  return rows.map(row => {
    const out = {};
    for (const [key, val] of Object.entries(row)) {
      out[map[key] || key] = val;
    }
    return out;
  });
}

function mapToDb(table, row) {
  const map = COL_MAP_REV[table];
  if (!map) return row;
  const out = {};
  for (const [key, val] of Object.entries(row)) {
    const dbKey = map[key] || key.toLowerCase();
    if (dbKey !== '–¥–∞—Ç–∞_–¥–æ–±–∞–≤–ª–µ–Ω–∏—è' && dbKey !== '–æ–±–Ω–æ–≤–ª–µ–Ω–æ') { // auto-managed
      out[dbKey] = val;
    }
  }
  return out;
}

function tableForSheet(sheet) {
  const m = {'–ü–∞—Ä—Ç–Ω—ë—Ä—ã':'partners','–ó–∞–¥–∞—á–∏':'tasks','–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è':'directions',
    '–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏':'staff','–ü—Ä–æ–µ–∫—Ç—ã':'projects','–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è':'approvals',
    '–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏':'communications','–î–æ–∫—É–º–µ–Ω—Ç—ã':'documents'};
  return m[sheet] || sheet;
}

let DATA = { partners:[], tasks:[], directions:[], staff:[], projects:[], approvals:[], comms:[], documents:[] };
let USER = null;

function normalizeRole(role) {
  const r = (role||'').toLowerCase().trim();
  const map = {
    '–≥–µ–Ω–µ—Ä–∞–ª—å–Ω—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä': 'CEO', '–≥–µ–Ω–¥–∏—Ä–µ–∫—Ç–æ—Ä': 'CEO', '–≥–µ–Ω–¥–∏—Ä': 'CEO', '–≥–¥': 'CEO', '–¥–∏—Ä–µ–∫—Ç–æ—Ä': 'CEO',
    '–∑–∞–º–µ—Å—Ç–∏—Ç–µ–ª—å': '–ó–∞–º', '–∑–∞–º–µ—Å—Ç–∏—Ç–µ–ª—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞': '–ó–∞–º', '–∑–∞–º–¥–∏—Ä': '–ó–∞–º', '–∑–∞–º': '–ó–∞–º',
    '–º–µ–Ω–µ–¥–∂–µ—Ä –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º': '–ú–µ–Ω–µ–¥–∂–µ—Ä', '–ø—Ä–æ–¥–∞–∂–Ω–∏–∫': '–ú–µ–Ω–µ–¥–∂–µ—Ä', '–º–µ–Ω–µ–¥–∂–µ—Ä': '–ú–µ–Ω–µ–¥–∂–µ—Ä',
    '—Ä–∞–∑—Ä–∞–±': '–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫', '–ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç': '–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫', 'dev': '–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫', '—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫': '–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫',
    '–∏–Ω–∂–µ–Ω–µ—Ä': '–ò–Ω–∂–µ–Ω–µ—Ä', '—Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å': '–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å', '—Å–æ—Ç—Ä—É–¥–Ω–∏–∫': '–°–æ—Ç—Ä—É–¥–Ω–∏–∫',
    'ceo': 'CEO'
  };
  // Exact match first
  if (map[r]) return map[r];
  // Prefix match: "–∑–∞–º –ø–æ —Å–∞–π—Ç–∞–º" starts with "–∑–∞–º" ‚Üí –ó–∞–º
  if (r.startsWith('–∑–∞–º')) return '–ó–∞–º';
  if (r.startsWith('—Ä—É–∫–æ–≤–æ–¥')) return '–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å';
  if (r.startsWith('–º–µ–Ω–µ–¥–∂–µ—Ä')) return '–ú–µ–Ω–µ–¥–∂–µ—Ä';
  if (r.startsWith('–¥–∏—Ä–µ–∫—Ç–æ—Ä') || r.startsWith('–≥–µ–Ω–µ—Ä–∞–ª—å–Ω') || r.startsWith('–≥–µ–Ω–¥') || r === 'ceo') return 'CEO';
  if (r.startsWith('—Ä–∞–∑—Ä–∞–±') || r.startsWith('–ø—Ä–æ–≥—Ä–∞–º–º') || r.startsWith('dev')) return '–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫';
  if (r.startsWith('–∏–Ω–∂–µ–Ω–µ—Ä')) return '–ò–Ω–∂–µ–Ω–µ—Ä';
  // Check if role is already a valid ROLES key
  if (ROLES[role]) return role;
  return role || '–°–æ—Ç—Ä—É–¥–Ω–∏–∫';
}
let currentModal = '';
let editingItem = null;
let confirmCallback = null;
let currentFilters = { partners: '–í—Å–µ', tasks: '–í—Å–µ' };
let refreshTimer = null;

// Navigation state
let currentProject = null;       // Top-level project key (e.g. 'rkt', 'sites')
let currentSubproject = null;    // Subproject direction (e.g. '–ö–¢', '–ü—ã—à–∫–∏ –º–∏—Ä–∞')
let currentPvTab = 'overview';   // Project view tab
let currentSpTab = 'overview';   // Subproject view tab
let currentTaskId = null;        // Task open for detail+AI
let aiMessages = [];             // AI chat history for current task

// ============================================================
// TOP-LEVEL PROJECTS DEFINITION
// ============================================================
const PROJECTS = {
  rkt: {
    name: '–†–ö–¢',
    emoji: 'üè•',
    color: 'var(--accent)',
    gradient: 'linear-gradient(90deg, #00d4aa, #00b894)',
    desc: '–†–æ—Å—Å–∏–π—Å–∫–∏–µ –ö–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã–µ –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ ‚Äî –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è',
    subprojects: {
      '–ö–¢':       { emoji: 'üî¨', color: 'var(--accent)', desc: '–ö–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã–µ —Ç–æ–º–æ–≥—Ä–∞—Ñ—ã ‚Äî –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è —Å Syno-Tech' },
      '–†–µ–Ω—Ç–≥–µ–Ω':  { emoji: 'üì°', color: 'var(--blue)', desc: '–†–µ–Ω—Ç–≥–µ–Ω–æ–≤—Å–∫–∏–µ –∞–ø–ø–∞—Ä–∞—Ç—ã ‚Äî —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –ª–∏–Ω–µ–π–∫–∏' },
      '–†–æ–±–æ—Ç—ã':   { emoji: 'ü§ñ', color: 'var(--purple)', desc: '–•–∏—Ä—É—Ä–≥–∏—á–µ—Å–∫–∏–µ —Ä–æ–±–æ—Ç–æ—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–∏—Å—Ç–µ–º—ã' },
      '–£—Ä–æ–ª–æ–≥–∏—è': { emoji: 'üíä', color: 'var(--orange)', desc: '–£—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ' },
      'PACS':     { emoji: 'üíª', color: 'var(--pink)', desc: '–°–∏—Å—Ç–µ–º—ã –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π' },
      '–£–ó–ò':      { emoji: 'ü©∫', color: 'var(--green)', desc: '–£–ª—å—Ç—Ä–∞–∑–≤—É–∫–æ–≤–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ ‚Äî –ø–ª–∞–Ω —Å 2028' }
    }
  },
  sites: {
    name: '–°–∞–π—Ç—ã',
    emoji: 'üåê',
    color: 'var(--blue)',
    gradient: 'linear-gradient(90deg, #4dabf7, #228be6)',
    desc: '–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∏ –≤–µ–¥–µ–Ω–∏–µ –≤–µ–±-—Å–∞–π—Ç–æ–≤ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞',
    subprojects: {
      '–ü—ã—à–∫–∏ –º–∏—Ä–∞':  { emoji: 'üç©', color: 'var(--orange)', desc: '–°–∞–π—Ç –¥–ª—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ –ü—ã—à–∫–∏ –º–∏—Ä–∞' },
      '–ë—Ä–µ–∂–Ω–µ–≤':     { emoji: 'üèõ', color: 'var(--red)', desc: '–°–∞–π—Ç –¥–ª—è —Ä–µ—Å—Ç–æ–∫–ª—É–±–∞ –ë—Ä–µ–∂–Ω–µ–≤' },
      '–ö–µ—Ä–∞—Ç–∏–Ω –ê–≥—Ä—ã–∑': { emoji: 'üíá', color: 'var(--pink)', desc: '–°–∞–π—Ç –∫–µ—Ä–∞—Ç–∏–Ω–æ–≤–æ–≥–æ –≤—ã–ø—Ä—è–º–ª–µ–Ω–∏—è, –ê–≥—Ä—ã–∑' }
    },
    canAddSub: true // can add new subprojects (sites)
  }
};

// ============================================================
// SITES BUSINESS: PRICING & SALARY MODEL
// ============================================================
const SITE_PRICING = {
  '–í–∏–∑–∏—Ç–∫–∞':  { price: 5000,  emoji: 'üìÑ', desc: '1-3 —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –±–∞–∑–æ–≤—ã–π –¥–∏–∑–∞–π–Ω' },
  '–õ–µ–Ω–¥–∏–Ω–≥':  { price: 10000, emoji: 'üéØ', desc: '1 –ø—Ä–æ–¥–∞—é—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞, –∞–Ω–∏–º–∞—Ü–∏–∏' },
  '–ö–∞—Ç–∞–ª–æ–≥':  { price: 15000, emoji: 'üõí', desc: '5+ —Å—Ç—Ä–∞–Ω–∏—Ü, –∫–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤' },
  '–ü—Ä–µ–º–∏—É–º':  { price: 25000, emoji: '‚≠ê', desc: '–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –¥–∏–∑–∞–π–Ω, SEO, CRM' },
  '–î–æ–º–µ–Ω+—Ö–æ—Å—Ç–∏–Ω–≥': { price: 3000, emoji: 'üåê', desc: '–î–æ–º–µ–Ω .ru + —Ö–æ—Å—Ç–∏–Ω–≥ –Ω–∞ –≥–æ–¥' }
};

// Default salary percentages by role
const DEFAULT_SALARY_PCT = {
  '–ú–µ–Ω–µ–¥–∂–µ—Ä': 10,
  '–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫': 10,
  '–ò–Ω–∂–µ–Ω–µ—Ä': 10,
  'CEO': 0,
  '–ó–∞–º': 0,
  '–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å': 0,
  '–°–æ—Ç—Ä—É–¥–Ω–∏–∫': 0
};

// ============================================================
// DYNAMIC SUBPROJECTS: sync from database directions
// ============================================================
const SP_EMOJIS = ['üè™','üçï','üíà','üèãÔ∏è','üéì','üè†','üöó','üíê','üç∞','üé≠','üéµ','üì∏','üßÅ','üçú','‚òï','üõçÔ∏è','üé®','üè•','üì±','üîß'];
const SP_COLORS = ['var(--orange)','var(--blue)','var(--pink)','var(--purple)','var(--green)','var(--red)','var(--accent)','var(--yellow)'];

function syncSubprojectsFromDb(projKey) {
  const proj = PROJECTS[projKey];
  if (!proj) return;
  const projName = proj.name; // e.g. '–†–ö–¢' or '–°–∞–π—Ç—ã'
  
  // Get all directions for this project from database
  const dbDirs = (DATA.directions || []).filter(d => (d['–ü—Ä–æ–µ–∫—Ç']||'') === projName);
  
  // Keep hardcoded ones as defaults, add any new from DB
  const existing = new Set(Object.keys(proj.subprojects));
  
  dbDirs.forEach((d, idx) => {
    const name = d['–ù–∞–∑–≤–∞–Ω–∏–µ'] || '';
    if (!name || existing.has(name)) return;
    proj.subprojects[name] = {
      emoji: SP_EMOJIS[idx % SP_EMOJIS.length],
      color: SP_COLORS[idx % SP_COLORS.length],
      desc: d['–û–ø–∏—Å–∞–Ω–∏–µ'] || (projName === '–°–∞–π—Ç—ã' ? siteDescFromDir(d) : name)
    };
    existing.add(name);
  });
  
  // Also update descriptions from DB data for existing ones
  dbDirs.forEach(d => {
    const name = d['–ù–∞–∑–≤–∞–Ω–∏–µ'] || '';
    if (!name || !proj.subprojects[name]) return;
    if (projName === '–°–∞–π—Ç—ã') {
      proj.subprojects[name].desc = siteDescFromDir(d);
    }
  });
}

function siteDescFromDir(d) {
  const type = d['–¢–∏–ø —Å–∞–π—Ç–∞'] || '';
  const price = d['–¶–µ–Ω–∞'] || d['price'] || 0;
  const paid = d['–û–ø–ª–∞—á–µ–Ω–æ'] === true || d['–û–ø–ª–∞—á–µ–Ω–æ'] === 'TRUE';
  const status = d['–°—Ç–∞—Ç—É—Å'] || '';
  let desc = '';
  if (type) desc += type;
  if (price) desc += ' ¬∑ ' + Number(price).toLocaleString('ru') + '‚ÇΩ';
  if (paid) desc += ' ‚úÖ –æ–ø–ª–∞—á–µ–Ω–æ';
  else if (price) desc += ' ¬∑ –Ω–µ –æ–ø–ª–∞—á–µ–Ω–æ';
  if (status && status !== '–í —Ä–∞–±–æ—Ç–µ') desc += ' ¬∑ ' + status;
  return desc || '–ö–ª–∏–µ–Ω—Ç';
}

const SITE_PIPELINE = [
  { step: 1, name: 'üîç –ù–∞–π—Ç–∏ –ª–∏–¥–∞ –Ω–∞ –∫–∞—Ä—Ç–∞—Ö',        role: '–ú–µ–Ω–µ–¥–∂–µ—Ä',   days: 0, auto: false },
  { step: 2, name: 'üìû –ü–µ—Ä–≤—ã–π –∑–≤–æ–Ω–æ–∫/—Å–æ–æ–±—â–µ–Ω–∏–µ',     role: '–ú–µ–Ω–µ–¥–∂–µ—Ä',   days: 0, auto: false },
  { step: 3, name: 'üìû Follow-up #2 (–ø–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å)',   role: '–ú–µ–Ω–µ–¥–∂–µ—Ä',   days: 2, auto: true },
  { step: 4, name: 'üìû Follow-up #3 (–Ω–∞–ø–æ–º–Ω–∏—Ç—å)',     role: '–ú–µ–Ω–µ–¥–∂–µ—Ä',   days: 5, auto: true },
  { step: 5, name: 'üé® –°–æ–∑–¥–∞—Ç—å –¥–µ–º–æ-–ø—Ä–æ—Ç–æ—Ç–∏–ø',       role: '–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫', days: 3, auto: true },
  { step: 6, name: 'üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ—Ç–æ—Ç–∏–ø –∫–ª–∏–µ–Ω—Ç—É',  role: '–ú–µ–Ω–µ–¥–∂–µ—Ä',   days: 4, auto: true },
  { step: 7, name: 'üìã –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ö–ü',   role: '–ú–µ–Ω–µ–¥–∂–µ—Ä',   days: 5, auto: true },
  { step: 8, name: 'üí¨ –°–æ–±—Ä–∞—Ç—å –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å',       role: '–ú–µ–Ω–µ–¥–∂–µ—Ä',   days: 7, auto: false },
  { step: 9, name: 'üí∞ –í—ã—Å—Ç–∞–≤–∏—Ç—å —Å—á—ë—Ç + –æ–ø–ª–∞—Ç–∞',     role: '–ú–µ–Ω–µ–¥–∂–µ—Ä',   days: 10, auto: true },
  { step: 10, name: 'üîß –ó–∞–ª–∏—Ç—å —Å–∞–π—Ç –Ω–∞ —Ö–æ—Å—Ç–∏–Ω–≥',     role: '–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫', days: 12, auto: true },
  { step: 11, name: '‚úÖ –°–¥–∞—á–∞ –∫–ª–∏–µ–Ω—Ç—É',              role: '–ó–∞–º',        days: 14, auto: false },
  { step: 12, name: 'üëë –£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ CEO',             role: 'CEO',        days: 15, auto: true }
];

function getSiteStaffByRole(role) {
  // Include staff from main project and extra_projects
  const staff = DATA.staff.filter(s => {
    if (s['–°—Ç–∞—Ç—É—Å'] !== '–ê–∫—Ç–∏–≤–Ω—ã–π') return false;
    if (s['–ü—Ä–æ–µ–∫—Ç'] === '–°–∞–π—Ç—ã') return true;
    try {
      const extra = JSON.parse(s['–î–æ–ø_–ø—Ä–æ–µ–∫—Ç—ã'] || '[]');
      return Array.isArray(extra) && extra.includes('–°–∞–π—Ç—ã');
    } catch(e) { return false; }
  });

  const byRole = staff.filter(s => {
    const r = normalizeRole(s['–†–æ–ª—å']||'');
    if (role === '–ú–µ–Ω–µ–¥–∂–µ—Ä') return r === '–ú–µ–Ω–µ–¥–∂–µ—Ä';
    if (role === '–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫') return r === '–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫' || r === '–ò–Ω–∂–µ–Ω–µ—Ä';
    if (role === '–ó–∞–º') return r === '–ó–∞–º';
    if (role === 'CEO') return r === 'CEO';
    return false;
  });
  if (byRole.length) return byRole[0]['–ò–º—è'];

  // Escalation chain: –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ ‚Üí –ú–µ–Ω–µ–¥–∂–µ—Ä ‚Üí –ó–∞–º ‚Üí CEO
  // –ú–µ–Ω–µ–¥–∂–µ—Ä ‚Üí –ó–∞–º ‚Üí CEO
  const FALLBACK_CHAIN = {
    '–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫': ['–ú–µ–Ω–µ–¥–∂–µ—Ä', '–ó–∞–º', 'CEO'],
    '–ú–µ–Ω–µ–¥–∂–µ—Ä':    ['–ó–∞–º', 'CEO'],
    '–ó–∞–º':         ['CEO'],
    'CEO':         []
  };
  const chain = FALLBACK_CHAIN[role] || ['–ó–∞–º', 'CEO'];
  for (const fallbackRole of chain) {
    const fb = staff.find(s => normalizeRole(s['–†–æ–ª—å']||'') === fallbackRole);
    if (fb) {
      console.log('[RKT] getSiteStaffByRole: fallback', role, '‚Üí', fallbackRole, '=', fb['–ò–º—è']);
      return fb['–ò–º—è'];
    }
  }

  return USER ? USER.name : '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω';
}

function calcSiteFinancials() {
  const dirs = DATA.directions.filter(d => d['–ü—Ä–æ–µ–∫—Ç'] === '–°–∞–π—Ç—ã');
  const tasks = DATA.tasks.filter(t => t['–ü—Ä–æ–µ–∫—Ç'] === '–°–∞–π—Ç—ã');
  const staff = DATA.staff.filter(s => s['–ü—Ä–æ–µ–∫—Ç'] === '–°–∞–π—Ç—ã' && s['–°—Ç–∞—Ç—É—Å'] === '–ê–∫—Ç–∏–≤–Ω—ã–π');

  let totalRevenue = 0, totalStaffCost = 0;
  const clientStats = [];
  const staffEarnings = {};

  // Initialize earnings for all staff with their salary_pct
  staff.forEach(s => {
    const pct = parseInt(s['–ü—Ä–æ—Ü–µ–Ω—Ç_–ó–ü']) || DEFAULT_SALARY_PCT[s['–†–æ–ª—å']] || 0;
    staffEarnings[s['–ò–º—è']] = { role: s['–†–æ–ª—å'], pct, earned: 0, sites: 0 };
  });

  dirs.forEach(d => {
    const type = d['–¢–∏–ø —Å–∞–π—Ç–∞'] || '–õ–µ–Ω–¥–∏–Ω–≥';
    const pricing = SITE_PRICING[type] || SITE_PRICING['–õ–µ–Ω–¥–∏–Ω–≥'];
    const status = d['–°—Ç–∞—Ç—É—Å'] || '';
    const isDone = status.includes('–ì–æ—Ç–æ–≤–æ') || status.includes('‚úÖ') || status.includes('–û–ø–ª–∞—á–µ–Ω');
    const isPaid = status.includes('–û–ø–ª–∞—á–µ–Ω') || d['–û–ø–ª–∞—á–µ–Ω–æ'] === '–î–∞';

    const clientTasks = tasks.filter(t => t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] === d['–ù–∞–∑–≤–∞–Ω–∏–µ']);
    const doneTasks = clientTasks.filter(t => t['–°—Ç–∞—Ç—É—Å'] === '–ì–æ—Ç–æ–≤–æ' || t['–°—Ç–∞—Ç—É—Å'] === '‚úÖ –ì–æ—Ç–æ–≤–æ');
    const progress = clientTasks.length ? Math.round(doneTasks.length / clientTasks.length * 100) : 0;

    const revenue = isPaid ? pricing.price : 0;
    const plannedRevenue = pricing.price;
    totalRevenue += revenue;

    let clientStaffCost = 0;

    if (isDone || isPaid) {
      // Find all staff assigned to tasks for this client
      const assignedStaff = new Set();
      clientTasks.forEach(t => {
        const assignee = t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π'] || '';
        if (assignee && staffEarnings[assignee]) {
          assignedStaff.add(assignee);
        }
      });

      // Each assigned employee earns their salary_pct % from the site price
      assignedStaff.forEach(name => {
        const se = staffEarnings[name];
        const pay = Math.round(pricing.price * se.pct / 100);
        se.earned += pay;
        se.sites++;
        clientStaffCost += pay;
      });

      totalStaffCost += clientStaffCost;
    }

    clientStats.push({
      name: d['–ù–∞–∑–≤–∞–Ω–∏–µ'], type, pricing, status, progress,
      revenue, plannedRevenue, isPaid, isDone,
      tasksTotal: clientTasks.length, tasksDone: doneTasks.length,
      staffCost: clientStaffCost
    });
  });

  return {
    clients: clientStats,
    totalRevenue,
    plannedRevenue: dirs.length * 10000,
    totalStaffCost,
    totalCost: totalStaffCost,
    profit: totalRevenue - totalStaffCost,
    staffEarnings,
    staffCount: staff.length,
    clientCount: dirs.length,
    paidCount: clientStats.filter(c => c.isPaid).length,
    inProgressCount: clientStats.filter(c => !c.isDone && !c.isPaid).length
  };
}
// ============================================================
const ROLES = {
  'CEO': {
    emoji: 'üëë', level: 4,
    canWrite: true, canDelete: true, canApprove: true, canManageStaff: true, seeAll: true,
    canEditTasks: true, canEditPartners: true, canEditStaff: true, canEditProjects: true,
    canAssignTasks: true, canViewFinance: true, canExport: true, canSettings: true,
    canCreateSiteTask: true, canGenerateSite: true,
    writeSheets: ['–ü–∞—Ä—Ç–Ω—ë—Ä—ã','–ó–∞–¥–∞—á–∏','–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è','–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏','–ü—Ä–æ–µ–∫—Ç—ã','–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è','–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏'],
    desc: '–ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–π —Å–∏—Å—Ç–µ–º–µ'
  },
  '–ó–∞–º': {
    emoji: '‚≠ê', level: 3,
    canWrite: true, canDelete: false, canApprove: false, canManageStaff: true, seeAll: false,
    canEditTasks: true, canEditPartners: true, canEditStaff: true, canEditProjects: false,
    canAssignTasks: true, canViewFinance: true, canExport: true, canSettings: false,
    canCreateSiteTask: true, canGenerateSite: true,
    writeSheets: ['–ü–∞—Ä—Ç–Ω—ë—Ä—ã','–ó–∞–¥–∞—á–∏','–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏','–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è'],
    needsApproval: ['–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏','–ü—Ä–æ–µ–∫—Ç—ã'],
    desc: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–≤–æ–∏–º –ø—Ä–æ–µ–∫—Ç–æ–º: –∑–∞–¥–∞—á–∏, –ø–∞—Ä—Ç–Ω—ë—Ä—ã, –∫–æ–º–∞–Ω–¥–∞'
  },
  '–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å': {
    emoji: 'üìã', level: 2,
    canWrite: true, canDelete: false, canApprove: false, canManageStaff: false, seeAll: false,
    canEditTasks: true, canEditPartners: false, canEditStaff: false, canEditProjects: false,
    canAssignTasks: true, canViewFinance: false, canExport: false, canSettings: false,
    canCreateSiteTask: true, canGenerateSite: true,
    writeSheets: ['–ó–∞–¥–∞—á–∏','–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏'],
    needsApproval: ['–ü–∞—Ä—Ç–Ω—ë—Ä—ã','–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è','–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏','–ü—Ä–æ–µ–∫—Ç—ã'],
    desc: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∞–º–∏ –≤ —Å–≤–æ—ë–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏'
  },
  '–ú–µ–Ω–µ–¥–∂–µ—Ä': {
    emoji: 'üíº', level: 1,
    canWrite: true, canDelete: false, canApprove: false, canManageStaff: false, seeAll: false,
    canEditTasks: true, canEditPartners: false, canEditStaff: false, canEditProjects: false,
    canAssignTasks: false, canViewFinance: false, canExport: false, canSettings: false,
    canCreateSiteTask: true, canGenerateSite: false,
    writeSheets: ['–ó–∞–¥–∞—á–∏','–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏'],
    needsApproval: ['–ü–∞—Ä—Ç–Ω—ë—Ä—ã','–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è'],
    desc: '–†–∞–±–æ—Ç–∞ —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏ –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á'
  },
  '–°–æ—Ç—Ä—É–¥–Ω–∏–∫': {
    emoji: 'üë§', level: 0,
    canWrite: false, canDelete: false, canApprove: false, canManageStaff: false, seeAll: false,
    canEditTasks: false, canEditPartners: false, canEditStaff: false, canEditProjects: false,
    canAssignTasks: false, canViewFinance: false, canExport: false, canSettings: false,
    canCreateSiteTask: false, canGenerateSite: false,
    writeSheets: [],
    needsApproval: ['–ó–∞–¥–∞—á–∏','–ü–∞—Ä—Ç–Ω—ë—Ä—ã','–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏'],
    desc: '–ü—Ä–æ—Å–º–æ—Ç—Ä –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–≤–æ–∏—Ö –∑–∞–¥–∞—á'
  }
};

function getUserPerms() {
  return USER ? (ROLES[USER.role] || ROLES['–°–æ—Ç—Ä—É–¥–Ω–∏–∫']) : ROLES['–°–æ—Ç—Ä—É–¥–Ω–∏–∫'];
}

// Check if user can directly write to a sheet or needs approval
function canDirectWrite(sheet) {
  const p = getUserPerms();
  if (p.writeSheets && p.writeSheets.includes(sheet)) return 'direct';
  if (p.needsApproval && p.needsApproval.includes(sheet)) return 'approval';
  return 'denied';
}

// ============================================================
// FORM DEFINITIONS
// ============================================================
function getDirectionOptions(forProject) {
  let opts = [];
  if (forProject && forProject !== '–í—Å–µ') {
    // Find project by name and return only its subprojects
    const proj = Object.values(PROJECTS).find(p => p.name === forProject);
    if (proj) {
      Object.keys(proj.subprojects).forEach(sp => opts.push(sp));
    }
  } else {
    // All subprojects
    Object.values(PROJECTS).forEach(p => {
      Object.keys(p.subprojects).forEach(sp => { if (!opts.includes(sp)) opts.push(sp); });
    });
  }
  opts.push('–û–±—â–µ–µ');
  return opts;
}

const FORM_DEFS = {
  partner: {
    title: '–ü–∞—Ä—Ç–Ω—ë—Ä', sheet: '–ü–∞—Ä—Ç–Ω—ë—Ä—ã',
    fields: [
      { name: '–ù–∞–∑–≤–∞–Ω–∏–µ', type: 'text', required: true, placeholder: '–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏' },
      { name: '–°—Ç—Ä–∞–Ω–∞', type: 'text', placeholder: '–ö–∏—Ç–∞–π, –†–æ—Å—Å–∏—è...' },
      { name: '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', type: 'select', options: () => getDirectionOptions() },
      { name: '–ü—Ä–æ–¥—É–∫—Ç', type: 'text', placeholder: '–ü—Ä–æ–¥—É–∫—Ç' },
      { name: '–°—Ç–∞—Ç—É—Å', type: 'select', options: ['Research', '–ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã', '–ê–∫—Ç–∏–≤–Ω—ã–π', '–ü–∞—É–∑–∞'] },
      { name: '–ö–æ–Ω—Ç–∞–∫—Ç', type: 'text', placeholder: '–ò–º—è –∫–æ–Ω—Ç–∞–∫—Ç–∞' },
      { name: 'Email', type: 'text', placeholder: 'email@company.com' },
      { name: '–¢–µ–ª–µ—Ñ–æ–Ω', type: 'text', placeholder: '+7...' },
      { name: '–°–∞–π—Ç', type: 'text', placeholder: 'https://' },
      { name: '–û–ø–∏—Å–∞–Ω–∏–µ', type: 'textarea', placeholder: '–ó–∞–º–µ—Ç–∫–∏...' }
    ]
  },
  project: {
    title: '–ü—Ä–æ–µ–∫—Ç', sheet: '–ü—Ä–æ–µ–∫—Ç—ã',
    fields: [
      { name: '–ù–∞–∑–≤–∞–Ω–∏–µ', type: 'text', required: true, placeholder: '–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞' },
      { name: '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', type: 'select', options: () => getDirectionOptions() },
      { name: '–û–ø–∏—Å–∞–Ω–∏–µ', type: 'textarea', placeholder: '–û–ø–∏—Å–∞–Ω–∏–µ...' },
      { name: '–°—Ç–∞—Ç—É—Å', type: 'select', options: ['–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ', '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞', '–í —Ä–∞–±–æ—Ç–µ', '–ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã', '–ó–∞–≤–µ—Ä—à—ë–Ω'] },
      { name: '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç', type: 'select', options: ['P1', 'P2', 'P3'] },
      { name: '–ü—Ä–æ–≥—Ä–µ—Å—Å', type: 'text', placeholder: '0-100' },
      { name: '–ü–∞—Ä—Ç–Ω—ë—Ä', type: 'text', placeholder: '–ü–∞—Ä—Ç–Ω—ë—Ä' },
      { name: '–ë—é–¥–∂–µ—Ç', type: 'text', placeholder: '–ë—é–¥–∂–µ—Ç' },
      { name: '–î–µ–¥–ª–∞–π–Ω', type: 'date' },
      { name: '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π', type: 'text', placeholder: '–ö—Ç–æ –≤–µ–¥—ë—Ç' }
    ]
  },
  task: {
    title: '–ó–∞–¥–∞—á–∞', sheet: '–ó–∞–¥–∞—á–∏',
    fields: [
      { name: '–û–ø–∏—Å–∞–Ω–∏–µ', type: 'text', required: true, placeholder: '–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å' },
      { name: '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', type: 'select', options: () => getDirectionOptions() },
      { name: '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç', type: 'select', options: ['P1', 'P2', 'P3'] },
      { name: '–°—Ç–∞—Ç—É—Å', type: 'select', options: ['‚è≥ –í –æ—á–µ—Ä–µ–¥–∏', '–í —Ä–∞–±–æ—Ç–µ', '–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ', '–ì–æ—Ç–æ–≤–æ'] },
      { name: '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π', type: 'text', placeholder: '–ö—Ç–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç' },
      { name: '–ü—Ä–æ–µ–∫—Ç', type: 'text', placeholder: '–ü—Ä–æ–µ–∫—Ç' },
      { name: '–î–µ–¥–ª–∞–π–Ω', type: 'date' },
      { name: '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π', type: 'textarea', placeholder: '–î–æ–ø. –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è...' }
    ]
  },
  staff: {
    title: '–°–æ—Ç—Ä—É–¥–Ω–∏–∫', sheet: '–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏',
    fields: [
      { name: '–ò–º—è', type: 'text', required: true, placeholder: '–§–ò–û' },
      { name: '–†–æ–ª—å', type: 'select', options: ['CEO', '–ó–∞–º', '–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å', '–ú–µ–Ω–µ–¥–∂–µ—Ä', '–ò–Ω–∂–µ–Ω–µ—Ä', '–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫', '–°–æ—Ç—Ä—É–¥–Ω–∏–∫'] },
      { name: '–ü—Ä–æ–µ–∫—Ç', type: 'select', options: () => ['–í—Å–µ', ...Object.values(PROJECTS).map(p=>p.name)], onchange: 'updateDirectionOptions(this.value)' },
      { name: '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', type: 'select', id: 'field-direction', options: () => ['–í—Å–µ', ...getDirectionOptions()] },
      { name: '–ü—Ä–æ—Ü–µ–Ω—Ç_–ó–ü', type: 'number', placeholder: '% –æ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Å–∞–π—Ç–∞ (0-100)' },
      { name: 'Telegram_ID', type: 'text', placeholder: '–ß–∏—Å–ª–æ–≤–æ–π Telegram ID' },
      { name: 'Username', type: 'text', placeholder: '@username' },
      { name: 'Email', type: 'text', placeholder: 'email' },
      { name: '–¢–µ–ª–µ—Ñ–æ–Ω', type: 'text', placeholder: '+7...', required: true },
      { name: '–°—Ç–∞—Ç—É—Å', type: 'select', options: ['–ê–∫—Ç–∏–≤–Ω—ã–π', '–û–∂–∏–¥–∞–µ—Ç', '–û—Ç–∫–ª—é—á—ë–Ω'] }
    ]
  },
  comm: {
    title: '–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è', sheet: '–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏',
    fields: [
      { name: '–ü–∞—Ä—Ç–Ω—ë—Ä', type: 'text', required: true, placeholder: '–° –∫–µ–º –æ–±—â–∞–ª–∏—Å—å' },
      { name: '–¢–∏–ø', type: 'select', options: ['–ó–≤–æ–Ω–æ–∫', 'Email', '–í—Å—Ç—Ä–µ—á–∞', '–ß–∞—Ç', 'Zoom', 'Telegram'] },
      { name: '–¢–µ–º–∞', type: 'text', placeholder: '–¢–µ–º–∞' },
      { name: '–†–µ–∑—É–ª—å—Ç–∞—Ç', type: 'textarea', placeholder: '–ò—Ç–æ–≥, –¥–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç–∏...' },
      { name: '–°–ª–µ–¥—É—é—â–∏–π_—à–∞–≥', type: 'text', placeholder: '–ß—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ' },
      { name: '–î–∞—Ç–∞_—Å–ª–µ–¥—É—é—â–µ–≥–æ', type: 'date' }
    ]
  },
  site: {
    title: '–°–∞–π—Ç (–ø–æ–¥–ø—Ä–æ–µ–∫—Ç)', sheet: null, // handled locally
    fields: [
      { name: '–ù–∞–∑–≤–∞–Ω–∏–µ', type: 'text', required: true, placeholder: '–ù–∞–∑–≤–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å–∞' },
      { name: '–°—Å—ã–ª–∫–∞', type: 'text', placeholder: 'https://...' },
      { name: '–ö–ª–∏–µ–Ω—Ç', type: 'text', placeholder: '–ò–º—è –∑–∞–∫–∞–∑—á–∏–∫–∞' },
      { name: '–¢–µ–ª–µ—Ñ–æ–Ω', type: 'text', placeholder: '+7...' },
      { name: '–û–ø–∏—Å–∞–Ω–∏–µ', type: 'textarea', placeholder: '–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞...' }
    ]
  }
};

// ============================================================
// HELPERS
// ============================================================
function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function escA(s) { return String(s||'').replace(/'/g,"\\'").replace(/"/g,'&quot;'); }
function emptyRow(c,m,cta) { return '<tr><td colspan="'+c+'" class="empty" style="padding:32px;text-align:center"><div class="icon" style="font-size:32px;margin-bottom:8px">üì≠</div><p style="color:var(--text2);margin-bottom:12px">'+m+'</p>'+(cta?'<button class="btn btn-primary btn-sm" onclick="'+cta.action+'" style="display:inline-block;width:auto">'+cta.label+'</button>':'')+'</td></tr>'; }

function statusBadge(s) {
  if (!s) return '';
  let c = 's-active';
  if (s==='–ê–∫—Ç–∏–≤–Ω—ã–π'||s.includes('–ì–æ—Ç–æ–≤–æ')) c='s-done';
  else if (s==='–ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã') c='s-talks';
  else if (s==='Research'||s.includes('–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ')) c='s-research';
  else if (s==='–ü–∞—É–∑–∞') c='s-pause';
  else if (s.includes('—Ä–∞–±–æ—Ç–µ')||s.includes('–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞')||s.includes('–ø—Ä–æ–≤–µ—Ä–∫–µ')) c='s-work';
  else if (s.includes('–û–∂–∏–¥–∞–µ—Ç')||s.includes('–æ—á–µ—Ä–µ–¥–∏')) c='s-urgent';
  else if (s.includes('–û–¥–æ–±—Ä–µ–Ω–æ')) c='s-done';
  else if (s.includes('–û—Ç–∫–ª–æ–Ω–µ–Ω–æ')) c='s-urgent';
  return '<span class="status '+c+'">'+esc(s)+'</span>';
}

function prBadge(p) {
  if (!p) return '';
  return '<span class="'+(p==='P1'?'p1':p==='P2'?'p2':'p3')+'">'+esc(p)+'</span>';
}

function progBar(v) {
  v = parseInt(v)||0;
  const c = v>=80?'var(--green)':v>=50?'var(--accent)':v>=25?'var(--orange)':'var(--red)';
  return '<div class="progress-wrap"><div class="progress-bar"><div class="progress-fill" style="width:'+v+'%;background:'+c+'"></div></div><span class="progress-text">'+v+'%</span></div>';
}

function actBtns(type, id, name) {
  const p = getUserPerms();
  let h = '<div class="actions-cell">';
  h += '<button class="act-btn view" onclick="viewItem(\''+type+'\',\''+escA(id)+'\')" title="–ü—Ä–æ—Å–º–æ—Ç—Ä">üëÅ</button>';
  if (type === 'task') {
    h += '<button class="act-btn ai" onclick="openTaskDetail(\''+escA(id)+'\')" title="–û—Ç–∫—Ä—ã—Ç—å —Å –ò–ò">ü§ñ</button>';
  }
  h += '<button class="act-btn" onclick="editItem(\''+type+'\',\''+escA(id)+'\')" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>';
  if (p.canDelete) h += '<button class="act-btn del" onclick="confirmDelete(\''+type+'\',\''+escA(id)+'\',\''+escA(name)+'\')" title="–£–¥–∞–ª–∏—Ç—å">üóë</button>';
  h += '</div>';
  return h;
}

function toast(m,t) {
  const e = document.getElementById('toast');
  e.textContent = m;
  e.className = 'toast toast-'+(t||'success')+' show';
  setTimeout(()=>e.classList.remove('show'), 3000);
}

function setStatus(s) {
  const d=document.getElementById('statusDot'), t=document.getElementById('statusText');
  if (s==='connected') { d.className='dot dot-green'; t.textContent='–ü–æ–¥–∫–ª—é—á–µ–Ω–æ ‚Ä¢ '+new Date().toLocaleTimeString('ru',{hour:'2-digit',minute:'2-digit'}); }
  else if (s==='loading') { d.className='dot dot-green'; t.textContent='–ó–∞–≥—Ä—É–∑–∫–∞...'; }
  else { d.className='dot dot-red'; t.textContent='–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è'; }
}

function updateStatusTime() {
  const e=document.getElementById('statusTime');
  if(e) e.textContent=new Date().toLocaleString('ru',{day:'2-digit',month:'long',year:'numeric',hour:'2-digit',minute:'2-digit'});
}

function today() { return new Date().toISOString().split('T')[0]; }

// Russian date formatting: "12 —Ñ–µ–≤—Ä–∞–ª—è 2026"
function formatDateRu(dateStr) {
  if (!dateStr) return '‚Äî';
  try {
    const d = new Date(dateStr);
    if (isNaN(d.getTime())) return dateStr;
    const months = ['—è–Ω–≤–∞—Ä—è','—Ñ–µ–≤—Ä–∞–ª—è','–º–∞—Ä—Ç–∞','–∞–ø—Ä–µ–ª—è','–º–∞—è','–∏—é–Ω—è','–∏—é–ª—è','–∞–≤–≥—É—Å—Ç–∞','—Å–µ–Ω—Ç—è–±—Ä—è','–æ–∫—Ç—è–±—Ä—è','–Ω–æ—è–±—Ä—è','–¥–µ–∫–∞–±—Ä—è'];
    return d.getDate() + ' ' + months[d.getMonth()] + ' ' + d.getFullYear();
  } catch(e) { return dateStr; }
}

// Short Russian date: "12 —Ñ–µ–≤"
function formatDateShort(dateStr) {
  if (!dateStr) return '‚Äî';
  try {
    const d = new Date(dateStr);
    if (isNaN(d.getTime())) return dateStr;
    const months = ['—è–Ω–≤','—Ñ–µ–≤','–º–∞—Ä','–∞–ø—Ä','–º–∞–π','–∏—é–Ω','–∏—é–ª','–∞–≤–≥','—Å–µ–Ω','–æ–∫—Ç','–Ω–æ—è','–¥–µ–∫'];
    return d.getDate() + ' ' + months[d.getMonth()];
  } catch(e) { return dateStr; }
}

// ============================================================
// AUTHENTICATION
// ============================================================
function checkSavedLogin() {
  loadSavedSettings();
  loadNotifications();
  initMobileMenu();
  const s = localStorage.getItem('rkt_user');
  if (s) { try { USER=JSON.parse(s); if(USER&&(USER.tgId||USER.phone||USER.name)){USER.role=normalizeRole(USER.role);showApp();return;} } catch(e){} localStorage.removeItem('rkt_user'); }
  // Not logged in ‚Äî load staff cache
  loadStaffCache();
}

// ============ PASSWORD AUTH ============
let _staffCache = [];
const ROLE_COLORS = {'CEO':'#e74c3c','–ó–∞–º':'#e67e22','–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å':'#3498db','–ú–µ–Ω–µ–¥–∂–µ—Ä':'#00d4aa','–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫':'#9b59b6','–ò–Ω–∂–µ–Ω–µ—Ä':'#1abc9c','–°–æ—Ç—Ä—É–¥–Ω–∏–∫':'#7f8c8d'};

async function hashPassword(pass) {
  const data = new TextEncoder().encode(pass + '_rkt_hub_2026');
  const hash = await crypto.subtle.digest('SHA-256', data);
  return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

// Load staff cache (for internal use, not displayed to user)
async function loadStaffCache() {
  if (!SB) { console.warn('No Supabase connection'); return; }
  try {
    const { data, error } = await SB.from('staff').select('*');
    if (error) throw error;
    _staffCache = (data||[]).map(s => mapFromDb('staff',[s])[0]).filter(Boolean);
  } catch(e) {
    console.error('loadStaffCache:', e);
  }
}

// ---- UI TAB SWITCHING ----
function showAuthTab(tab) {
  document.getElementById('authLogin').style.display = tab==='login' ? 'block' : 'none';
  document.getElementById('authRegister').style.display = tab==='register' ? 'block' : 'none';
  document.getElementById('authForgot').style.display = tab==='forgot' ? 'block' : 'none';
  document.getElementById('authTabLogin').classList.toggle('active', tab==='login');
  document.getElementById('authTabReg').classList.toggle('active', tab==='register');
  // Clear errors
  ['loginError','regError','forgotError'].forEach(id => { const e=document.getElementById(id); if(e){e.style.display='none'; e.style.color='';} });
  // Focus first input
  if (tab==='login') document.getElementById('loginId')?.focus();
  if (tab==='register') document.getElementById('regName')?.focus();
  if (tab==='forgot') document.getElementById('forgotId')?.focus();
}

function showForgotPass() { showAuthTab('forgot'); }

function togglePassVis(inputId, btn) {
  const inp = document.getElementById(inputId);
  if (!inp) return;
  const isPass = inp.type === 'password';
  inp.type = isPass ? 'text' : 'password';
  btn.textContent = isPass ? 'üôà' : 'üëÅ';
}

function showLoginErr(m, color) { 
  const e=document.getElementById('loginError'); 
  e.textContent=m; e.style.display='block'; e.style.color=color||''; 
}

// ---- FIND STAFF BY IDENTIFIER ----
function findStaffByInput(input) {
  if (!input) return null;
  const q = input.trim();
  const allStaff = _staffCache;
  
  // @username
  if (q.startsWith('@')) {
    const uname = q.slice(1).toLowerCase();
    return allStaff.find(s => (s['Username']||'').toLowerCase().replace('@','') === uname);
  }
  // Phone
  if (/^\+?\d[\d\s\-()]{6,}$/.test(q)) {
    const clean = q.replace(/[\s\-()]/g, '');
    return allStaff.find(s => {
      const sp = (s['–¢–µ–ª–µ—Ñ–æ–Ω']||'').replace(/[\s\-()]/g, '');
      return sp && (sp === clean || sp.endsWith(clean.slice(-10)) || clean.endsWith(sp.slice(-10)));
    });
  }
  // Email
  if (q.includes('@') && q.includes('.')) {
    return allStaff.find(s => (s['Email']||'').toLowerCase() === q.toLowerCase());
  }
  // Telegram ID (digits only)
  if (/^\d+$/.test(q)) {
    return allStaff.find(s => String(s.Telegram_ID||'').trim() === q);
  }
  // Name (exact then partial)
  const lower = q.toLowerCase();
  return allStaff.find(s => (s['–ò–º—è']||'').toLowerCase() === lower) ||
         allStaff.find(s => (s['–ò–º—è']||'').toLowerCase().includes(lower));
}

// ---- PASSWORD LOGIN ----

// ============================================================
// BRUTE-FORCE PROTECTION
// ============================================================
const LOGIN_ATTEMPTS = {};
const MAX_LOGIN_ATTEMPTS = 5;
const LOCKOUT_MS = 5 * 60 * 1000;

function checkLoginRate(identifier) {
  const now = Date.now();
  if (!LOGIN_ATTEMPTS[identifier]) LOGIN_ATTEMPTS[identifier] = { count: 0, first: now };
  const r = LOGIN_ATTEMPTS[identifier];
  if (now - r.first > LOCKOUT_MS) { r.count = 0; r.first = now; }
  r.count++;
  if (r.count > MAX_LOGIN_ATTEMPTS) {
    return { blocked: true, sec: Math.ceil((LOCKOUT_MS - (now - r.first)) / 1000) };
  }
  return { blocked: false };
}
function resetLoginRate(id) { delete LOGIN_ATTEMPTS[id]; }

async function doPasswordLogin() {
  const id = document.getElementById('loginId').value.trim();
  const pass = document.getElementById('loginPass').value;
  const errEl = document.getElementById('loginError');
  errEl.style.display = 'none';
  
  if (!SB) { showLoginErr('‚ö†Ô∏è –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.'); return; }
  if (!id) { showLoginErr('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω, @—Ç–µ–≥ –∏–ª–∏ email'); return; }
  var _rate = checkLoginRate(id.toLowerCase());
  if (_rate.blocked) { showLoginErr('–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫. –ü–æ–¥–æ–∂–¥–∏—Ç–µ ' + _rate.sec + ' —Å–µ–∫.'); return; }
  if (!pass) { showLoginErr('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å'); return; }
  
  document.getElementById('loginBtnText').textContent = '‚è≥ –í—Ö–æ–¥...';
  
  try {
    // Load staff if not loaded
    if (!_staffCache.length) await loadStaffCache();
    
    const staff = findStaffByInput(id);
    if (!staff) {
      showLoginErr('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å.');
      document.getElementById('loginBtnText').textContent = '–í–æ–π—Ç–∏';
      return;
    }

    // Check if user is pending approval
    const staffStatus = (staff['–°—Ç–∞—Ç—É—Å'] || staff.status || '–ê–∫—Ç–∏–≤–Ω—ã–π').trim();
    if (staffStatus === '–û–∂–∏–¥–∞–µ—Ç') {
      showLoginErr('‚è≥ –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –µ—â—ë –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏. –î–æ–∂–¥–∏—Ç–µ—Å—å –æ–¥–æ–±—Ä–µ–Ω–∏—è —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª–µ–º.');
      document.getElementById('loginBtnText').textContent = '–í–æ–π—Ç–∏';
      return;
    }
    if (staffStatus === '–û—Ç–∫–ª—é—á—ë–Ω' || staffStatus === '‚ùå –£–¥–∞–ª—ë–Ω') {
      showLoginErr('üö´ –í–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤—É.');
      document.getElementById('loginBtnText').textContent = '–í–æ–π—Ç–∏';
      return;
    }
    
    // Check password
    const hash = await hashPassword(pass);
    if (!staff['pin_hash']) {
      // No password set yet ‚Äî set it now and login
      try {
        await SB.from('staff').update({ pin_hash: hash }).eq('id', staff.ID||staff.id);
        staff['pin_hash'] = hash;
        const cached = _staffCache.find(s => (s.ID||s.id) === (staff.ID||staff.id));
        if (cached) cached['pin_hash'] = hash;
        showLoginErr('‚úÖ –ü–∞—Ä–æ–ª—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω! –í—Ö–æ–¥–∏–º...', 'var(--green)');
        setTimeout(() => completeLogin(staff), 500);
        return;
      } catch(e2) {
        // pin_hash column may not exist ‚Äî login without password check
        console.warn('Cannot set password, pin_hash column may not exist:', e2);
        completeLogin(staff);
        return;
      }
    }
    
    if (hash !== staff['pin_hash']) {
      showLoginErr('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
      document.getElementById('loginBtnText').textContent = '–í–æ–π—Ç–∏';
      return;
    }
    
    // Success!
    completeLogin(staff);
    
  } catch(e) {
    console.error('Login error:', e);
    showLoginErr('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: '+e.message);
    document.getElementById('loginBtnText').textContent = '–í–æ–π—Ç–∏';
  }
}

// ---- PASSWORD REGISTER ----
async function doPasswordRegister() {
  const name = document.getElementById('regName').value.trim();
  const phone = document.getElementById('regPhone').value.trim();
  const username = document.getElementById('regUsername').value.trim().replace(/^@/, '');
  const project = document.getElementById('regProject').value;
  const pass = document.getElementById('regPass').value;
  const pass2 = document.getElementById('regPass2').value;
  const errEl = document.getElementById('regError');
  errEl.style.display = 'none';
  errEl.style.color = '';
  
  if (!SB) { errEl.textContent='‚ö†Ô∏è –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.'; errEl.style.display='block'; return; }
  
  // Validation
  if (!name) { errEl.textContent='–£–∫–∞–∂–∏—Ç–µ –§–ò–û'; errEl.style.display='block'; return; }
  if (!phone) { errEl.textContent='–£–∫–∞–∂–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω'; errEl.style.display='block'; return; }
  if (!project) { errEl.textContent='–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç'; errEl.style.display='block'; return; }
  if (!pass || pass.length < 4) { errEl.textContent='–ü–∞—Ä–æ–ª—å –º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞'; errEl.style.display='block'; return; }
  if (pass !== pass2) { errEl.textContent='–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç'; errEl.style.display='block'; return; }
  
  document.getElementById('regBtnText').textContent = '‚è≥ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è...';
  
  try {
    if (!_staffCache.length) await loadStaffCache();
    
    // Check duplicates
    const cleanPhone = phone.replace(/[\s\-()]/g, '');
    const dup = _staffCache.find(s => {
      const sp = (s['–¢–µ–ª–µ—Ñ–æ–Ω']||'').replace(/[\s\-()]/g, '');
      return (sp && cleanPhone && (sp === cleanPhone || sp.endsWith(cleanPhone.slice(-10)) || cleanPhone.endsWith(sp.slice(-10)))) ||
             (username && (s['Username']||'').toLowerCase().replace('@','') === username.toLowerCase());
    });
    if (dup) {
      errEl.textContent = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º '+(username && (dup['Username']||'').toLowerCase().replace('@','')===username.toLowerCase() ?'—Ç–µ–≥–æ–º':'—Ç–µ–ª–µ—Ñ–æ–Ω–æ–º')+' —É–∂–µ –µ—Å—Ç—å. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤–æ –≤–∫–ª–∞–¥–∫—É –í—Ö–æ–¥.';
      errEl.style.display = 'block';
      document.getElementById('regBtnText').textContent = '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
      return;
    }
    
    const passHash = await hashPassword(pass);
    const newId = 'S' + Date.now().toString(36).toUpperCase();
    
    // Direct Supabase INSERT ‚Äî try with pin_hash first
    const baseRow = {
      id: newId, name: name, role: '–°–æ—Ç—Ä—É–¥–Ω–∏–∫', project: project,
      direction: null, telegram_id: null, username: username || null, email: null,
      phone: phone, status: '–ê–∫—Ç–∏–≤–Ω—ã–π'
    };
    
    // Attempt 1: with pin_hash
    let result = await SB.from('staff').insert({ ...baseRow, pin_hash: passHash });
    
    // Attempt 2: without pin_hash on ANY error
    if (result.error) {
      console.warn('Insert attempt 1 failed:', result.error.message, '‚Äî retrying without pin_hash');
      result = await SB.from('staff').insert(baseRow);
    }
    
    if (result.error) {
      console.error('Registration insert error:', result.error);
      errEl.textContent = '‚ùå ' + (result.error.message || '–û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö');
      errEl.style.display = 'block';
      document.getElementById('regBtnText').textContent = '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
      return;
    }
    
    // Success! Send approval request for role upgrade
    try { await selfRegister({ name, phone, username, email:'', role:'–ú–µ–Ω–µ–¥–∂–µ—Ä', project, telegram_id:'' }); } catch(e2) { console.warn('Approval request failed:', e2); }
    
    // Reload cache and auto-login
    await loadStaffCache();
    const newStaff = _staffCache.find(s => (s.ID||s.id) === newId || (s['–¢–µ–ª–µ—Ñ–æ–Ω']||'').replace(/[\s\-()]/g,'') === cleanPhone);
    
    errEl.style.display = 'block';
    errEl.style.color = 'var(--green)';
    
    if (newStaff) {
      errEl.textContent = '‚úÖ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –í—Ö–æ–¥–∏–º...';
      setTimeout(() => completeLogin(newStaff), 600);
    } else {
      errEl.textContent = '‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã! –í–æ–π–¥–∏—Ç–µ —Å –≤–∞—à–∏–º –ø–∞—Ä–æ–ª–µ–º.';
      document.getElementById('regBtnText').textContent = '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
      setTimeout(() => showAuthTab('login'), 1500);
    }
    
  } catch(e) {
    console.error('Register error:', e);
    errEl.textContent = '‚ùå ' + (e.message||'–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
    errEl.style.display = 'block';
    document.getElementById('regBtnText').textContent = '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
  }
}

// ---- TELEGRAM LOGIN ----
function doTelegramLogin() {
  const botName = CONFIG.TG_BOT || 'AIhroject_bot';
  
  // Show TG login modal inline
  const container = document.getElementById('authLogin').style.display !== 'none' 
    ? document.getElementById('authLogin') 
    : document.getElementById('authRegister');
  
  // Replace current form with TG flow
  const prevHTML = container.innerHTML;
  container.innerHTML = `
    <div style="text-align:center">
      <div style="font-size:48px;margin-bottom:12px">üí¨</div>
      <div style="font-size:15px;font-weight:600;margin-bottom:8px">–í—Ö–æ–¥ —á–µ—Ä–µ–∑ Telegram</div>
      <div style="font-size:13px;color:var(--text2);margin-bottom:16px;line-height:1.5">
        1. –û—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞ <b>@${botName}</b><br>
        2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É <code>/login</code><br>
        3. –ë–æ—Ç –ø—Ä–∏—à–ª—ë—Ç –∫–æ–¥ ‚Äî –≤–≤–µ–¥–∏—Ç–µ –µ–≥–æ –Ω–∏–∂–µ
      </div>
      <a href="https://t.me/${botName}?start=login" target="_blank" class="tg-login-btn" style="margin-bottom:14px;text-decoration:none">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.37 0 0 5.37 0 12s5.37 12 12 12 12-5.37 12-12S18.63 0 12 0zm5.94 8.13l-1.97 9.28c-.15.67-.54.83-1.09.52l-3.02-2.23-1.45 1.4c-.16.16-.3.3-.61.3l.22-3.05 5.55-5.02c.24-.22-.05-.33-.37-.13l-6.87 4.33-2.96-.92c-.64-.2-.66-.64.13-.95l11.57-4.46c.54-.2 1.01.13.83.93z"/></svg>
        –û—Ç–∫—Ä—ã—Ç—å @${botName}
      </a>
      <input class="login-input" id="tgCodeInput" type="text" placeholder="6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –∏–∑ –±–æ—Ç–∞" style="text-align:center;font-size:18px;letter-spacing:6px" maxlength="6" onkeydown="if(event.key==='Enter')verifyTgCode()">
      <button class="login-btn" style="margin-top:10px" onclick="verifyTgCode()">
        <span id="tgVerifyBtnText">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</span>
      </button>
      <div class="login-error" id="tgError"></div>
      <div style="margin-top:14px">
        <a href="#" onclick="cancelTgLogin();return false" style="color:var(--text3);font-size:12px">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –æ–±—ã—á–Ω–æ–º—É –≤—Ö–æ–¥—É</a>
      </div>
    </div>
  `;
  container._prevHTML = prevHTML;
}

function cancelTgLogin() {
  const loginDiv = document.getElementById('authLogin');
  const regDiv = document.getElementById('authRegister');
  if (loginDiv._prevHTML) { loginDiv.innerHTML = loginDiv._prevHTML; delete loginDiv._prevHTML; }
  if (regDiv._prevHTML) { regDiv.innerHTML = regDiv._prevHTML; delete regDiv._prevHTML; }
  // If nothing restored, just reload page
  if (!loginDiv.innerHTML.includes('loginId')) location.reload();
}

async function verifyTgCode() {
  const code = (document.getElementById('tgCodeInput')?.value||'').trim();
  const errEl = document.getElementById('tgError');
  if (!code) { errEl.textContent='–í–≤–µ–¥–∏—Ç–µ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –∏–∑ –±–æ—Ç–∞'; errEl.style.display='block'; return; }
  
  document.getElementById('tgVerifyBtnText').textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...';
  errEl.style.display = 'none';
  
  try {
    if (!_staffCache.length) await loadStaffCache();
    
    let staff = null;
    
    // 1) Try as auth token from tg_auth_tokens (primary method)
    try {
      const { data } = await SB.from('tg_auth_tokens').select('*').eq('token', code).single();
      if (data) {
        // Check expiry (5 min)
        const created = new Date(data.created_at).getTime();
        if (Date.now() - created > 5 * 60 * 1000) {
          await SB.from('tg_auth_tokens').delete().eq('token', code).catch(()=>{});
          errEl.textContent = '‚ùå –ö–æ–¥ –∏—Å—Ç—ë–∫. –û—Ç–ø—Ä–∞–≤—å—Ç–µ /login –≤ –±–æ—Ç–µ –∑–∞–Ω–æ–≤–æ.';
          errEl.style.display = 'block';
          document.getElementById('tgVerifyBtnText').textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å';
          return;
        }
        if (data.staff_id) {
          staff = _staffCache.find(s => (s.ID||s.id) === data.staff_id);
        } else if (data.telegram_id) {
          staff = _staffCache.find(s => String(s.Telegram_ID||s.telegram_id||'').trim() === String(data.telegram_id));
        }
        // Delete used token (one-time)
        await SB.from('tg_auth_tokens').delete().eq('token', code).catch(()=>{});
      }
    } catch(e) { /* table may not exist */ }
    
    // 2) Fallback: try as Telegram ID (numeric, for backward compat)
    if (!staff && /^\d{5,}$/.test(code)) {
      staff = _staffCache.find(s => String(s.Telegram_ID||s.telegram_id||'').trim() === code);
    }
    
    // 3) Try as @username
    if (!staff && code.startsWith('@')) {
      const uname = code.slice(1).toLowerCase();
      staff = _staffCache.find(s => (s['Username']||s.username||'').toLowerCase().replace('@','') === uname);
    }
    
    if (staff) {
      errEl.style.color = 'var(--green)';
      errEl.textContent = '‚úÖ –ù–∞–π–¥–µ–Ω: ' + (staff['–ò–º—è']||staff.name||'') + '. –í—Ö–æ–¥–∏–º...';
      errEl.style.display = 'block';
      setTimeout(() => { cancelTgLogin(); completeLogin(staff); }, 600);
    } else {
      errEl.textContent = '‚ùå –ö–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –∏—Å—Ç—ë–∫. –û—Ç–ø—Ä–∞–≤—å—Ç–µ /login –≤ –±–æ—Ç–µ.';
      errEl.style.display = 'block';
      document.getElementById('tgVerifyBtnText').textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å';
    }
  } catch(e) {
    errEl.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + e.message;
    errEl.style.display = 'block';
    document.getElementById('tgVerifyBtnText').textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å';
  }
}

// ---- FORGOT PASSWORD ----
async function doForgotPass() {
  const id = document.getElementById('forgotId').value.trim();
  const errEl = document.getElementById('forgotError');
  errEl.style.display = 'none';
  
  if (!id) { errEl.textContent='–í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ @—Ç–µ–≥'; errEl.style.display='block'; return; }
  
  document.getElementById('forgotBtnText').textContent = '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...';
  
  try {
    if (!_staffCache.length) await loadStaffCache();
    const staff = findStaffByInput(id);
    
    if (!staff) {
      errEl.textContent = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω';
      errEl.style.display = 'block';
      document.getElementById('forgotBtnText').textContent = '–°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å';
      return;
    }
    
    // Generate temp password
    const tempPass = Math.random().toString(36).slice(2,8).toUpperCase();
    const hash = await hashPassword(tempPass);
    
    // Save new password hash
    await SB.from('staff').update({ pin_hash: hash }).eq('id', staff.ID||staff.id);
    
    // Try to send via Telegram bot (through n8n webhook)
    const tgId = staff.Telegram_ID || staff['Telegram_ID'] || staff.telegram_id;
    if (tgId) {
      try {
        await sendTelegramNotification(tgId, 'üîë –í–∞—à –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–ª—è RKT HUB:\n\n`' + tempPass + '`\n\n–°–º–µ–Ω–∏—Ç–µ –µ–≥–æ –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞ –≤ —Ä–∞–∑–¥–µ–ª–µ –ü—Ä–æ—Ñ–∏–ª—å.');
        errEl.style.color = 'var(--green)';
        errEl.textContent = '‚úÖ –ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram!';
      } catch(e) {
        errEl.style.color = 'var(--orange)';
        errEl.textContent = '‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ TG. –ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å: ' + tempPass;
      }
    } else {
      // No TG ‚Äî show password directly
      errEl.style.color = 'var(--orange)';
      errEl.textContent = '‚ö†Ô∏è Telegram –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω. –ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å: ' + tempPass;
    }
    errEl.style.display = 'block';
    document.getElementById('forgotBtnText').textContent = '–°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å';
    
  } catch(e) {
    errEl.textContent = '‚ùå –û—à–∏–±–∫–∞: '+e.message;
    errEl.style.display = 'block';
    document.getElementById('forgotBtnText').textContent = '–°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å';
  }
}

// ---- COMPLETE LOGIN ----
function completeLogin(staff) {
  const staffProject = (staff['–ü—Ä–æ–µ–∫—Ç'] || staff.project || '').trim();
  const staffDirection = (staff['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] || staff.direction || '').trim();
  USER = {
    id: staff.ID || staff.id || '', tgId: String(staff.Telegram_ID || staff.telegram_id || '').trim(),
    name: (staff['–ò–º—è'] || staff.name || '–°–æ—Ç—Ä—É–¥–Ω–∏–∫').trim(),
    role: normalizeRole(staff['–†–æ–ª—å'] || staff.role || '–°–æ—Ç—Ä—É–¥–Ω–∏–∫'),
    originalRole: (staff['–†–æ–ª—å'] || staff.role || '').trim(),
    direction: staffDirection || '–í—Å–µ',
    project: staffProject,
    email: (staff['Email'] || staff.email || '').trim(),
    phone: (staff['–¢–µ–ª–µ—Ñ–æ–Ω'] || staff.phone || '').trim(),
    username: (staff['Username'] || staff.username || '').trim()
  };
  console.log('[RKT] completeLogin:', USER.name, '| role:', USER.role, '| project:', USER.project, '| direction:', USER.direction);
  localStorage.setItem('rkt_user', JSON.stringify(USER));
  showApp();
}

function doLogout() {
  USER=null; localStorage.removeItem('rkt_user');
  if(refreshTimer) clearInterval(refreshTimer);
  if(window._tgPollInterval) clearInterval(window._tgPollInterval);
  document.getElementById('mainApp').style.display='none';
  document.getElementById('loginScreen').style.display='flex';
  showAuthTab('login');
  document.getElementById('loginId').value='';
  document.getElementById('loginPass').value='';
  document.getElementById('loginError').style.display='none';
}


function showApp() {
  document.getElementById('loginScreen').style.display='none';
  document.getElementById('mainApp').style.display='flex';
  const p = getUserPerms();
  document.getElementById('userName').textContent = USER.name;
  document.getElementById('userRoleText').textContent = p.emoji+' '+USER.role;
  document.getElementById('userAvatar').textContent = USER.name.charAt(0).toUpperCase();
  document.getElementById('settingsApiUrl').value = CONFIG.SUPABASE_URL;
  document.getElementById('settingsAiUrl').value = CONFIG.AI_URL;
  document.getElementById('settingsTgBot').value = CONFIG.TG_BOT || '';
  document.getElementById('settingsTgToken').value = CONFIG.TG_BOT_TOKEN || '';
  document.getElementById('s-name').textContent = USER.name;
  document.getElementById('s-role').textContent = p.emoji+' '+USER.role;
  document.getElementById('s-dir').textContent = USER.direction;
  document.getElementById('s-tgid').textContent = USER.username ? '@'+USER.username.replace('@','') : (USER.tgId||'‚Äî');
  document.getElementById('s-phone').textContent = USER.phone || '‚Äî';
  document.getElementById('btn-add-staff').style.display = p.canManageStaff?'':'none';
  
  // ROLE-BASED NAV VISIBILITY
  document.getElementById('nav-approvals').classList.toggle('hidden', !p.canApprove);
  // Settings ‚Äî only CEO
  const navSettings = document.querySelector('[data-page="settings"]');
  if (navSettings) navSettings.classList.toggle('hidden', USER.role !== 'CEO');
  // Partners ‚Äî only CEO and –ó–∞–º
  const navPartners = document.querySelector('[data-page="partners"]');
  if (navPartners) navPartners.classList.toggle('hidden', p.level < 3);
  // Staff ‚Äî only CEO and –ó–∞–º
  const navStaff = document.querySelector('[data-page="staff"]');
  if (navStaff) navStaff.classList.toggle('hidden', !p.canManageStaff);
  // Comms ‚Äî hide for basic –°–æ—Ç—Ä—É–¥–Ω–∏–∫
  const navComms = document.querySelector('[data-page="comms"]');
  if (navComms) navComms.classList.toggle('hidden', p.level < 1);
  
  loadData();
  if(refreshTimer) clearInterval(refreshTimer);
  refreshTimer = setInterval(loadData, CONFIG.REFRESH);
  updateStatusTime(); setInterval(updateStatusTime, 60000);
  startDeadlineChecks();
  
  // Supabase Realtime ‚Äî auto-reload on changes (deduplicated, debounced)
  SB.channel('rkt-hub-changes')
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'tasks' }, (payload) => {
      var t = payload.new || {};
      addNotification('–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞: ' + (t.description || t['–û–ø–∏—Å–∞–Ω–∏–µ'] || '–±–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'), 'task');
      debouncedLoadData();
    })
    .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'tasks' }, () => debouncedLoadData())
    .on('postgres_changes', { event: '*', schema: 'public', table: 'directions' }, (payload) => {
      if (payload.eventType === 'INSERT') addNotification('–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç –≤ –≤–æ—Ä–æ–Ω–∫–µ', 'deal');
      debouncedLoadData();
    })
    .on('postgres_changes', { event: '*', schema: 'public', table: 'approvals' }, (payload) => {
      if (payload.eventType === 'INSERT') addNotification('–ù–æ–≤–æ–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ', 'approval');
      debouncedLoadData();
    })
    .on('postgres_changes', { event: '*', schema: 'public', table: 'staff' }, () => debouncedLoadData())
    .on('postgres_changes', { event: '*', schema: 'public', table: 'partners' }, () => debouncedLoadData())
    .subscribe();

  // Onboarding for first-time users
  setTimeout(checkOnboarding, 800);
}

// ============================================================
// DATA
// ============================================================
function normData(d) {
  const staffArr = Array.isArray(d.staff)?d.staff:[];
  // Normalize roles and filter out template/placeholder rows
  const cleanStaff = staffArr
    .filter(s => s['–ò–º—è'] && !['–§–ò–û','–ò–º—è','–§–∞–º–∏–ª–∏—è','–ü—Ä–∏–º–µ—Ä'].includes(s['–ò–º—è']))
    .map(s => { if(s['–†–æ–ª—å']) s['–†–æ–ª—å'] = normalizeRole(s['–†–æ–ª—å']); return s; });
  return {
    partners: (Array.isArray(d.partners)?d.partners:[]).filter(p => p['–ù–∞–∑–≤–∞–Ω–∏–µ'] && !['–ù–∞–∑–≤–∞–Ω–∏–µ','–ü—Ä–∏–º–µ—Ä'].includes(p['–ù–∞–∑–≤–∞–Ω–∏–µ'])),
    tasks: (Array.isArray(d.tasks)?d.tasks:[]).filter(t => t['–û–ø–∏—Å–∞–Ω–∏–µ'] && !['–û–ø–∏—Å–∞–Ω–∏–µ','–ü—Ä–∏–º–µ—Ä'].includes(t['–û–ø–∏—Å–∞–Ω–∏–µ'])),
    directions: Array.isArray(d.directions)?d.directions:[],
    staff: cleanStaff,
    projects: Array.isArray(d.projects)?d.projects:[],
    approvals: Array.isArray(d.approvals)?d.approvals:[],
    comms: Array.isArray(d.comms)?d.comms:[],
    documents: Array.isArray(d.documents)?d.documents:[]
  };
}

async function loadData() {
  _filterCache.clear();
  _filterCacheVersion++;
  setStatus('loading');
  try {
    const [staff, partners, tasks, directions, projects, approvals, comms, docs] = await Promise.all([
      SB.from('staff').select('*'),
      SB.from('partners').select('*'),
      SB.from('tasks').select('*'),
      SB.from('directions').select('*'),
      SB.from('projects').select('*'),
      SB.from('approvals').select('*'),
      SB.from('communications').select('*'),
      SB.from('documents').select('*')
    ]);
    
    DATA = normData({
      staff: mapFromDb('staff', staff.data || []),
      partners: mapFromDb('partners', partners.data || []),
      tasks: mapFromDb('tasks', tasks.data || []),
      directions: mapFromDb('directions', directions.data || []),
      projects: mapFromDb('projects', projects.data || []),
      approvals: mapFromDb('approvals', approvals.data || []),
      comms: mapFromDb('communications', comms.data || []),
      documents: mapFromDb('documents', docs.data || [])
    });
    renderAll();
    setStatus('connected');
  } catch(e) {
    console.error('loadData error:', e);
    setStatus('error');
    toast('‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: '+e.message,'error');
  }
}

async function apiWrite(sheet, row, action) {
  try {
    const table = tableForSheet(sheet);
    const dbRow = mapToDb(table, row);
    
    // Ensure ID
    if (!dbRow.id && row.ID) dbRow.id = row.ID;
    if (!dbRow.id) dbRow.id = genId(table.charAt(0).toUpperCase());
    
    if (action === 'delete') {
      const { error } = await SB.from(table).delete().eq('id', dbRow.id);
      if (error) throw error;
    } else if (dbRow.id && action === 'update') {
      const id = dbRow.id;
      delete dbRow.id;
      const { error } = await SB.from(table).update(dbRow).eq('id', id);
      if (error) throw error;
    } else {
      // Upsert: insert or update by id
      const { error } = await SB.from(table).upsert(dbRow, { onConflict: 'id' });
      if (error) throw error;
    }
    return true;
  } catch(e) {
    console.error('apiWrite error:', e);
    toast('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏: '+(e.message||e),'error');
    return false;
  }
}

function genId(prefix) {
  return (prefix||'X') + Date.now().toString(36).toUpperCase();
}

// ============================================================
// FILTERING
// ============================================================
function filterByRole(arr) {
  // Cache: same array reference ‚Üí same result within one render cycle
  const cacheKey = arr;
  if (_filterCache.has(cacheKey)) return _filterCache.get(cacheKey);

  const p = getUserPerms();
  if (p.seeAll || !USER) { _filterCache.set(cacheKey, arr); return arr; }

  // Determine user's project key
  const userProjKey = getUserProjectKey();
  const userName = (USER.name || USER['–ò–º—è'] || '').trim();
  const userDir = (USER.direction || USER['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] || '').trim();
  const userProj = (USER.project || USER['–ü—Ä–æ–µ–∫—Ç'] || '').trim();

  // If user has no specific project/direction restriction
  if (!userProjKey && (userDir === '–í—Å–µ' || !userDir)) {
    // Only CEO-level (seeAll) should see everything ‚Äî already handled above
    // For others with level >= 2: show everything in their project (fallback)
    if (p.level >= 2 && userProj) {
      // High-level user without detected project key ‚Äî still try to show project data
      const result = arr.filter(i => {
        const d = i['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] || '';
        const proj = i['–ü—Ä–æ–µ–∫—Ç'] || '';
        if (proj === userProj || d === userProj) return true;
        if (userName && (i['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'').includes(userName)) return true;
        return false;
      });
      _filterCache.set(cacheKey, result);
      return result;
    }
    // For others: show only items assigned to them
    const result = arr.filter(i => userName && (i['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'').includes(userName));
    _filterCache.set(cacheKey, result);
    return result;
  }

  // Build list of all directions this user can see
  const myDirs = new Set(['–í—Å–µ', '–û–±—â–µ–µ', '']);
  if (userDir && userDir !== '–í—Å–µ') myDirs.add(userDir);
  if (userProj) myDirs.add(userProj);

  // –ó–∞–º/–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å: see all directions in their project
  if (p.level >= 2 && userProjKey) {
    getProjectDirs(userProjKey).forEach(d => myDirs.add(d));
    myDirs.add(PROJECTS[userProjKey].name);
  }

  // Also check extra_projects
  if (userName) {
    const myStaff = (DATA.staff || []).find(s => s['–ò–º—è'] === userName);
    if (myStaff) {
      try {
        const extra = JSON.parse(myStaff['–î–æ–ø_–ø—Ä–æ–µ–∫—Ç—ã'] || '[]');
        if (Array.isArray(extra)) {
          extra.forEach(ep => {
            myDirs.add(ep);
            const epKey = Object.keys(PROJECTS).find(k => PROJECTS[k].name === ep);
            if (epKey) getProjectDirs(epKey).forEach(d => myDirs.add(d));
          });
        }
      } catch(e) {}
    }
  }

  const result = arr.filter(i => {
    const d = i['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] || '';
    const proj = i['–ü—Ä–æ–µ–∫—Ç'] || '';
    if (myDirs.has(d) || myDirs.has(proj)) return true;
    // All levels can see items assigned to them
    if (userName && (i['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'').includes(userName)) return true;
    return false;
  });
  _filterCache.set(cacheKey, result);
  return result;
}

// Find which PROJECTS key this user belongs to
function getUserProjectKey() {
  if (!USER) return null;

  // Gather all possible project/direction values (from both key styles)
  const userProject = (USER.project || USER['–ü—Ä–æ–µ–∫—Ç'] || '').trim();
  const userDirection = (USER.direction || USER['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] || '').trim();
  const userOrigRole = (USER.originalRole || USER.role || '').trim();

  // 1. Check explicit project field
  if (userProject && userProject !== '–í—Å–µ') {
    // Match against project names
    const byName = Object.keys(PROJECTS).find(k => PROJECTS[k].name === userProject);
    if (byName) return byName;
    // Match against project keys directly
    if (PROJECTS[userProject]) return userProject;
    // Fuzzy match (case-insensitive, trimmed)
    const projLower = userProject.toLowerCase();
    const byNameLower = Object.keys(PROJECTS).find(k => PROJECTS[k].name.toLowerCase().trim() === projLower);
    if (byNameLower) return byNameLower;
  }

  // 2. Check direction ‚Üí which project has this as subproject
  if (userDirection && userDirection !== '–í—Å–µ') {
    // Direct match against project names (e.g. direction='–°–∞–π—Ç—ã')
    const byProjName = Object.keys(PROJECTS).find(k => PROJECTS[k].name === userDirection);
    if (byProjName) return byProjName;
    // Match against subproject names
    const byDir = Object.keys(PROJECTS).find(k => {
      return getProjectDirs(k).includes(userDirection);
    });
    if (byDir) return byDir;
    // Fuzzy match on direction
    const dirLower = userDirection.toLowerCase();
    const byDirFuzzy = Object.keys(PROJECTS).find(k => {
      if (PROJECTS[k].name.toLowerCase().trim() === dirLower) return true;
      return getProjectDirs(k).some(d => d.toLowerCase().trim() === dirLower);
    });
    if (byDirFuzzy) return byDirFuzzy;
  }

  // 3. Check role name for project hints (e.g. "–ó–∞–º –ø–æ –°–∞–π—Ç–∞–º")
  if (userOrigRole) {
    const roleLower = userOrigRole.toLowerCase();
    for (const [k, proj] of Object.entries(PROJECTS)) {
      if (roleLower.includes(proj.name.toLowerCase())) return k;
    }
  }

  // 4. Check DB staff record for project field (handles mapFromDb inconsistencies)
  if (USER.name) {
    const myStaff = (DATA.staff || []).find(s => s['–ò–º—è'] === USER.name || s.name === USER.name);
    if (myStaff) {
      const staffProject = (myStaff['–ü—Ä–æ–µ–∫—Ç'] || myStaff.project || '').trim();
      if (staffProject && staffProject !== '–í—Å–µ') {
        const byStaff = Object.keys(PROJECTS).find(k => PROJECTS[k].name === staffProject);
        if (byStaff) {
          // Also fix USER object for future calls
          USER.project = staffProject;
          return byStaff;
        }
      }
      // Check extra_projects
      try {
        const extra = JSON.parse(myStaff['–î–æ–ø_–ø—Ä–æ–µ–∫—Ç—ã'] || '[]');
        if (Array.isArray(extra) && extra.length > 0) {
          for (const ep of extra) {
            const byExtra = Object.keys(PROJECTS).find(k => PROJECTS[k].name === ep);
            if (byExtra) return byExtra;
          }
        }
      } catch(e) {}
    }
  }

  console.warn('[RKT] getUserProjectKey: could not determine project for', USER.name, '| project:', userProject, '| direction:', userDirection, '| role:', userOrigRole);
  return null; // Can't determine ‚Üí secure fallback
}

function filterBySearch(arr, sid, fields) {
  const e = document.getElementById(sid);
  if(!e) return arr;
  const q = e.value.toLowerCase().trim();
  if(!q) return arr;
  return arr.filter(i => fields.some(f => (i[f]||'').toLowerCase().includes(q)));
}

function filterByDir(arr, dir) {
  if(!dir||dir==='–í—Å–µ') return arr;
  return arr.filter(i => (i['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'').includes(dir));
}

// Which top-level project does a direction belong to?
function dirToProject(dir) {
  for (const [key, proj] of Object.entries(PROJECTS)) {
    if (proj.subprojects[dir]) return key;
  }
  return null;
}

// Get all direction names for a top-level project
function getProjectDirs(projKey) {
  const p = PROJECTS[projKey];
  return p ? Object.keys(p.subprojects) : [];
}

// Filter data by top-level project (all its subproject directions)
function filterByProject(arr, projKey) {
  const dirs = getProjectDirs(projKey);
  return arr.filter(i => {
    const dir = i['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] || '';
    const proj = i['–ü—Ä–æ–µ–∫—Ç'] || '';
    // Match by direction belonging to this project
    if (dirs.includes(dir)) return true;
    // Match by explicit –ü—Ä–æ–µ–∫—Ç field
    const projName = PROJECTS[projKey] ? PROJECTS[projKey].name : '';
    if (proj === projName || proj === projKey) return true;
    return false;
  });
}

// ============================================================
// NAVIGATION
// ============================================================
function showPage(page) {
  if (page === 'kanban') { renderKanban(); }
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  const pe = document.getElementById('page-'+page);
  const ne = document.querySelector('[data-page="'+page+'"]');
  if(pe) pe.classList.add('active');
  if(ne) ne.classList.add('active');
  document.getElementById('sidebar').classList.remove('open');
  if(page==='home') { currentProject=null; currentSubproject=null; }
  // Lazy render: render the page we're switching to
  renderAll();
}

function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }

function openProject(projKey) {
  currentProject = projKey;
  currentSubproject = null;
  currentPvTab = 'overview';
  showPage('project');
  
  // FIX 8: Hide partner elements in –°–∞–π—Ç—ã project
  const isSites = (projKey === 'sites');
  const pvPartnerBtn = document.querySelector('#page-project .actions [onclick*="partner"]');
  if (pvPartnerBtn) pvPartnerBtn.style.display = isSites ? 'none' : '';
  const pvPartnerTab = document.querySelector('#pv-tabs [data-tab="partners"]');
  if (pvPartnerTab) pvPartnerTab.style.display = isSites ? 'none' : '';
  // Show finance/salaries tabs in –°–∞–π—Ç—ã
  document.querySelectorAll('.tab-finance, .tab-salaries').forEach(t => t.style.display = isSites ? '' : 'none');
  
  renderProjectView();
}

function openSubproject(spName) {
  currentSubproject = spName;
  currentSpTab = 'overview';
  showPage('subproject');
  const isSites = (currentProject === 'sites');
  const dir = isSites ? (DATA.directions||[]).find(d => (d['–ù–∞–∑–≤–∞–Ω–∏–µ']||d['name']) === spName && d['–ü—Ä–æ–µ–∫—Ç'] === '–°–∞–π—Ç—ã') : null;
  
  // === CONFIGURE TABS ===
  const tabs = {
    'overview': true,
    'tasks': true,
    'client-info': isSites,
    'partners': !isSites,
    'projects': !isSites,
    'comms': !isSites,
    'files': true,
    'sitegen': isSites
  };
  document.querySelectorAll('#sp-tabs .tab').forEach(t => {
    const tab = t.getAttribute('data-tab');
    t.style.display = (tabs[tab] !== undefined ? tabs[tab] : true) ? '' : 'none';
  });
  
  // === CONFIGURE ACTION BUTTONS ===
  const actionsEl = document.getElementById('sp-actions');
  if (isSites && dir) {
    const phone = dir['–¢–µ–ª–µ—Ñ–æ–Ω'] || '';
    const cleanPhone = phone.replace(/[^\d+]/g, '');
    const eid = escA(dir['ID']||dir.id||'');
    actionsEl.innerHTML = 
      (phone ? '<a href="tel:'+esc(cleanPhone)+'" class="btn btn-primary" style="text-decoration:none">üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</a>' +
               '<a href="https://t.me/'+esc(cleanPhone.replace('+',''))+'" target="_blank" class="btn btn-secondary" style="text-decoration:none">üí¨ Telegram</a>' : '') +
      '<button class="btn btn-secondary" onclick="openModal(\'task\')">+ –ó–∞–¥–∞—á–∞</button>';
  } else {
    actionsEl.innerHTML = 
      '<button class="btn btn-primary" onclick="openModal(\'task\')">+ –ó–∞–¥–∞—á–∞</button>' +
      '<button class="btn btn-primary" onclick="openModal(\'partner\')">+ –ü–∞—Ä—Ç–Ω—ë—Ä</button>' +
      '<button class="btn btn-secondary" onclick="openModal(\'comm\')">+ –ö–æ–Ω—Ç–∞–∫—Ç</button>';
  }
  
  // === CLIENT QUICK-INFO BAR (–°–∞–π—Ç—ã only) ===
  const clientBar = document.getElementById('sp-client-bar');
  if (isSites && dir) {
    const stage = dir['stage']||'prospect';
    const stObj = STAGES.find(s=>s.id===stage)||STAGES[0];
    const stIdx = STAGES.findIndex(s=>s.id===stage);
    const price = Number(dir['–¶–µ–Ω–∞'])||0;
    const paid = !!dir['–û–ø–ª–∞—á–µ–Ω–æ'];
    
    clientBar.style.display = 'block';
    clientBar.innerHTML = '<div style="display:flex;align-items:center;gap:12px;padding:12px 16px;background:var(--bg3);border:1px solid var(--border);border-radius:12px;margin-bottom:12px;flex-wrap:wrap">' +
      // Stage stepper
      '<div style="display:flex;align-items:center;gap:2px;flex:1;min-width:300px">' +
      STAGES.map((s,i) => {
        const done = i < stIdx;
        const cur = i === stIdx;
        const bg = done ? 'var(--green)' : cur ? stObj.color : 'var(--bg4)';
        const txt = done || cur ? '#fff' : 'var(--text3)';
        return '<div style="flex:1;height:6px;border-radius:3px;background:'+bg+';position:relative" title="'+s.name+'">' +
          (cur ? '<div style="position:absolute;top:-20px;left:50%;transform:translateX(-50%);font-size:10px;white-space:nowrap;color:'+stObj.color+';font-weight:700">'+s.name+'</div>' : '') +
          '</div>';
      }).join('') +
      '</div>' +
      // Key info chips
      '<div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">' +
        '<span style="background:'+stObj.color+';color:#fff;padding:4px 12px;border-radius:10px;font-size:12px;font-weight:600">'+stObj.name+'</span>' +
        (price ? '<span style="background:var(--bg4);padding:4px 12px;border-radius:10px;font-size:12px;font-weight:600">'+price.toLocaleString('ru')+'‚ÇΩ</span>' : '') +
        '<span style="color:'+(paid?'var(--green)':'var(--orange)')+';font-size:12px;font-weight:600">'+(paid?'‚úÖ –û–ø–ª–∞—á–µ–Ω':'‚è≥ –ù–µ –æ–ø–ª–∞—á–µ–Ω')+'</span>' +
        (dir['–ú–µ–Ω–µ–¥–∂–µ—Ä'] ? '<span style="color:var(--text2);font-size:12px">üë§ '+esc(dir['–ú–µ–Ω–µ–¥–∂–µ—Ä'])+'</span>' : '') +
      '</div>' +
    '</div>';
  } else {
    clientBar.style.display = 'none';
  }
  
  renderSubprojectView();
}

function showPvTab(tab) {
  currentPvTab = tab;
  document.querySelectorAll('#pv-tabs .tab').forEach(t => t.classList.toggle('active', t.getAttribute('data-tab')===tab));
  renderProjectView();
}

function showSpTab(tab) {
  currentSpTab = tab;
  document.querySelectorAll('#sp-tabs .tab').forEach(t => t.classList.toggle('active', t.getAttribute('data-tab')===tab));
  renderSubprojectView();
}

// ============================================================
// RENDER: MASTER
// ============================================================
function renderAll() {
  // Lazy render: only render the visible page + always update badges
  const activePage = document.querySelector('.page.active');
  const pageId = activePage ? activePage.id : 'page-home';

  // Always sync subprojects and update badges (lightweight)
  if(currentProject) syncSubprojectsFromDb(currentProject);
  updateBadges();

  switch(pageId) {
    case 'page-home': renderHome(); break;
    case 'page-dashboard': renderDashboard(); break;
    case 'page-partners': renderPartnerFilters(); renderPartners(); break;
    case 'page-tasks': renderTaskFilters(); renderTasks(); break;
    case 'page-staff': renderStaff(); break;
    case 'page-approvals': renderApprovals(); break;
    case 'page-comms': renderComms(); break;
    case 'page-settings': renderSettings(); break;
    case 'page-project':
      if(currentProject && !currentSubproject) renderProjectView();
      break;
    case 'page-subproject':
      if(currentSubproject) renderSubprojectView();
      break;
    default:
      // Fallback: render everything
      renderHome(); renderDashboard(); renderPartnerFilters(); renderPartners();
      renderTaskFilters(); renderTasks(); renderStaff(); renderApprovals();
      renderComms(); renderSettings();
      if(currentProject && !currentSubproject) renderProjectView();
      if(currentSubproject) renderSubprojectView();
  }
}


function updateBadges() {
  const fp = filterByRole(DATA.partners);
  const ft = filterByRole(DATA.tasks).filter(t => (t['–°—Ç–∞—Ç—É—Å']||'')!=='–ì–æ—Ç–æ–≤–æ');
  const pa = DATA.approvals.filter(a => (a['–°—Ç–∞—Ç—É—Å']||'').includes('–û–∂–∏–¥–∞–µ—Ç'));
  document.getElementById('badge-partners').textContent = fp.length;
  document.getElementById('badge-tasks').textContent = ft.length;
  document.getElementById('badge-approvals').textContent = pa.length;
}

// ============================================================
// RENDER: HOME ‚Äî TOP-LEVEL PROJECT CARDS
// ============================================================
function renderHome() {
  const allPartners = filterByRole(DATA.partners);
  const allTasks = filterByRole(DATA.tasks);
  const allProjects = filterByRole(DATA.projects);
  const td = today();
  const overdue = allTasks.filter(t => t['–î–µ–¥–ª–∞–π–Ω'] && t['–î–µ–¥–ª–∞–π–Ω']<td && (t['–°—Ç–∞—Ç—É—Å']||'')!=='–ì–æ—Ç–æ–≤–æ');
  const active = allTasks.filter(t => (t['–°—Ç–∞—Ç—É—Å']||'')!=='–ì–æ—Ç–æ–≤–æ');

  // Total metrics across all projects
  document.getElementById('home-metrics').innerHTML =
    '<div class="metric-card"><div class="m-icon">ü§ù</div><div class="m-value">'+allPartners.length+'</div><div class="m-label">–ü–∞—Ä—Ç–Ω—ë—Ä–æ–≤</div></div>'+
    '<div class="metric-card"><div class="m-icon">üìÅ</div><div class="m-value">'+allProjects.length+'</div><div class="m-label">–ü—Ä–æ–µ–∫—Ç–æ–≤</div></div>'+
    '<div class="metric-card"><div class="m-icon">‚úÖ</div><div class="m-value">'+active.length+'</div><div class="m-label">–ó–∞–¥–∞—á</div></div>'+
    '<div class="metric-card"><div class="m-icon">üî¥</div><div class="m-value" style="color:'+(overdue.length?'var(--red)':'var(--green)')+'">'+overdue.length+'</div><div class="m-label">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</div></div>'+
    '<div class="metric-card"><div class="m-icon">üë•</div><div class="m-value">'+DATA.staff.length+'</div><div class="m-label">–ö–æ–º–∞–Ω–¥–∞</div></div>';

  // Project cards ‚Äî filter by user's project access
  let html = '';
  const visibleProjects = Object.entries(PROJECTS).filter(([key, proj]) => {
    const p = getUserPerms();
    if (p.seeAll) return true;
    const userPK = getUserProjectKey();
    if (!userPK) return false;
    if (key === userPK) return true;
    // Check extra_projects for this staff member
    if (USER) {
      const myStaff = (DATA.staff||[]).find(s => s['–ò–º—è'] === USER.name);
      if (myStaff) {
        try {
          const extra = JSON.parse(myStaff['–î–æ–ø_–ø—Ä–æ–µ–∫—Ç—ã'] || '[]');
          if (Array.isArray(extra) && extra.includes(proj.name)) return true;
        } catch(e) {}
      }
    }
    return false;
  });
  
  for (const [key, proj] of visibleProjects) {
    const dirs = getProjectDirs(key);
    const pp = allPartners.filter(p => dirs.includes(p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||''));
    const pt = allTasks.filter(t => dirs.includes(t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||''));
    const ptActive = pt.filter(t => (t['–°—Ç–∞—Ç—É—Å']||'')!=='–ì–æ—Ç–æ–≤–æ');
    const ptOverdue = ptActive.filter(t => t['–î–µ–¥–ª–∞–π–Ω'] && t['–î–µ–¥–ª–∞–π–Ω']<td);
    const ppr = allProjects.filter(p => dirs.includes(p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||''));
    const avgPr = ppr.length ? Math.round(ppr.reduce((s,p) => s+(parseInt(p['–ü—Ä–æ–≥—Ä–µ—Å—Å'])||0),0)/ppr.length) : 0;

    let stTag = '';
    if (ptOverdue.length) stTag = '<span class="status-tag" style="background:var(--red-glow);color:var(--red)">üî¥ '+ptOverdue.length+' –ø—Ä–æ—Å—Ä–æ—á.</span>';
    else if (ptActive.length) stTag = '<span class="status-tag" style="background:var(--accent-glow);color:var(--accent)">–í —Ä–∞–±–æ—Ç–µ</span>';
    else stTag = '<span class="status-tag" style="background:rgba(136,153,170,0.15);color:var(--text2)">–°—Ç–∞—Ä—Ç</span>';

    html += '<div class="project-card" onclick="openProject(\''+key+'\')">';
    html += '<div class="project-card-top" style="background:'+proj.gradient+'"></div>';
    html += stTag;
    html += '<div class="project-card-header">';
    html += '<span class="emoji">'+proj.emoji+'</span>';
    html += '<h3>'+esc(proj.name)+'</h3>';
    html += '<div class="desc">'+esc(proj.desc)+'</div>';
    html += '</div>';
    html += '<div class="project-card-stats">';
    html += '<div class="pcs"><div class="v" style="color:'+proj.color+'">'+Object.keys(proj.subprojects).length+'</div><div class="l">'+(proj.canAddSub?'–ö–ª–∏–µ–Ω—Ç–æ–≤':'–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π')+'</div></div>';
    html += '<div class="pcs"><div class="v" style="color:'+proj.color+'">'+pp.length+'</div><div class="l">–ü–∞—Ä—Ç–Ω—ë—Ä–æ–≤</div></div>';
    html += '<div class="pcs"><div class="v" style="color:'+proj.color+'">'+ptActive.length+'</div><div class="l">–ó–∞–¥–∞—á</div></div>';
    html += '</div>';
    html += '<div class="project-card-progress">';
    html += '<div class="bar"><div class="fill" style="width:'+avgPr+'%;background:'+proj.color+'"></div></div>';
    html += '<div class="info"><span>–ü—Ä–æ–≥—Ä–µ—Å—Å</span><span>'+avgPr+'%</span></div>';
    html += '</div></div>';
  }

  // Add project card ‚Äî only CEO
  if (getUserPerms().level >= 4) {
    html += '<div class="project-card add-card" onclick="openModal(\'newproject\')">';
    html += '<span class="add-icon">‚ûï</span>';
    html += '<span class="add-text">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</span>';
    html += '</div>';
  }

  document.getElementById('project-grid').innerHTML = html;
}

// ============================================================
// RENDER: PROJECT VIEW (subprojects)
// ============================================================
function renderProjectView() {
  if(!currentProject) return;
  const proj = PROJECTS[currentProject];
  if(!proj) return;
  const td = today();

  document.getElementById('pv-name').textContent = proj.name;
  document.getElementById('pv-title').innerHTML = proj.emoji + ' ' + esc(proj.name);
  // Show quick site button only for projects that support subprojects (site projects)
  const qsBtn = document.getElementById('btn-quick-site');
  if (qsBtn) qsBtn.style.display = proj.canAddSub ? '' : 'none';
  document.getElementById('btn-add-sub').style.display = proj.canAddSub ? '' : 'none';

  const dirs = getProjectDirs(currentProject);
  const pp = filterByRole(DATA.partners).filter(p => dirs.includes(p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||''));
  const pt = filterByRole(DATA.tasks).filter(t => dirs.includes(t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||''));
  const ppr = filterByRole(DATA.projects).filter(p => dirs.includes(p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||''));
  const ptActive = pt.filter(t => (t['–°—Ç–∞—Ç—É—Å']||'')!=='–ì–æ—Ç–æ–≤–æ');
  const ptOverdue = ptActive.filter(t => t['–î–µ–¥–ª–∞–π–Ω'] && t['–î–µ–¥–ª–∞–π–Ω']<td);
  const avgPr = ppr.length ? Math.round(ppr.reduce((s,p) => s+(parseInt(p['–ü—Ä–æ–≥—Ä–µ—Å—Å'])||0),0)/ppr.length) : 0;

  // Metrics
  if (proj.canAddSub) {
    const allDirsM = (DATA.directions||[]).filter(d => d['–ü—Ä–æ–µ–∫—Ç'] === '–°–∞–π—Ç—ã');
    const activeM = allDirsM.filter(d => !['done','lost'].includes(d['stage']||'prospect'));
    const revenue = allDirsM.filter(d=>d['–û–ø–ª–∞—á–µ–Ω–æ']).reduce((s,d)=>s+(Number(d['–¶–µ–Ω–∞'])||0),0);
    const lostM = allDirsM.filter(d => d['stage']==='lost').length;
    const wonM = allDirsM.filter(d => d['stage']==='done').length;
    const winRate = (wonM+lostM) > 0 ? Math.round(wonM/(wonM+lostM)*100) : 0;
    const followupToday = allDirsM.filter(d => d['–°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç'] && d['–°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç'] <= td && !['done','lost'].includes(d['stage']||'prospect')).length;
    document.getElementById('pv-metrics').innerHTML =
      '<div class="metric-card"><div class="m-icon">üë•</div><div class="m-value">'+allDirsM.length+'</div><div class="m-label">–ö–ª–∏–µ–Ω—Ç–æ–≤</div><div class="m-sub">'+activeM.length+' –≤ —Ä–∞–±–æ—Ç–µ</div></div>'+
      '<div class="metric-card"><div class="m-icon">üí∞</div><div class="m-value">'+revenue.toLocaleString('ru')+'‚ÇΩ</div><div class="m-label">–í—ã—Ä—É—á–∫–∞</div></div>'+
      '<div class="metric-card"><div class="m-icon">üìä</div><div class="m-value">'+winRate+'%</div><div class="m-label">–ö–æ–Ω–≤–µ—Ä—Å–∏—è</div><div class="m-sub">'+wonM+' –∏–∑ '+(wonM+lostM)+'</div></div>'+
      (followupToday ? '<div class="metric-card" style="border:1px solid var(--orange)"><div class="m-icon">üîî</div><div class="m-value" style="color:var(--orange)">'+followupToday+'</div><div class="m-label">–ü–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å!</div><div class="m-sub">—Å–µ–≥–æ–¥–Ω—è</div></div>' :
      '<div class="metric-card"><div class="m-icon">‚úÖ</div><div class="m-value">'+ptActive.length+'</div><div class="m-label">–ó–∞–¥–∞—á</div><div class="m-sub">'+(ptOverdue.length?'üî¥ '+ptOverdue.length+' –ø—Ä–æ—Å—Ä–æ—á.':'–≤ —Ä–∞–±–æ—Ç–µ')+'</div></div>');
  } else {
  document.getElementById('pv-metrics').innerHTML =
    '<div class="metric-card"><div class="m-icon">üìÇ</div><div class="m-value">'+Object.keys(proj.subprojects).length+'</div><div class="m-label">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π</div></div>'+
    '<div class="metric-card"><div class="m-icon">ü§ù</div><div class="m-value">'+pp.length+'</div><div class="m-label">–ü–∞—Ä—Ç–Ω—ë—Ä–æ–≤</div></div>'+
    '<div class="metric-card"><div class="m-icon">‚úÖ</div><div class="m-value">'+ptActive.length+'</div><div class="m-label">–ó–∞–¥–∞—á</div><div class="m-sub">'+(ptOverdue.length?'üî¥ '+ptOverdue.length+' –ø—Ä–æ—Å—Ä–æ—á.':'–≤ —Ä–∞–±–æ—Ç–µ')+'</div></div>'+
    '<div class="metric-card"><div class="m-icon">üìà</div><div class="m-value">'+avgPr+'%</div><div class="m-label">–ü—Ä–æ–≥—Ä–µ—Å—Å</div></div>'+
    '<div class="metric-card"><div class="m-icon">üìÅ</div><div class="m-value">'+ppr.length+'</div><div class="m-label">–ü—Ä–æ–µ–∫—Ç–æ–≤</div></div>';
  }

  // Subproject cards grid
  let sgHtml = '';
  // CLIENT-ORIENTED CRM for –°–∞–π—Ç—ã
  if (proj.canAddSub) {
    // Render vertical pipeline
    const allDirs = (DATA.directions||[]).filter(d => d['–ü—Ä–æ–µ–∫—Ç'] === '–°–∞–π—Ç—ã');
    const totalRev = allDirs.filter(d=>d['–û–ø–ª–∞—á–µ–Ω–æ']).reduce((s,d)=>s+(Number(d['–¶–µ–Ω–∞'])||0),0);
    const totalPipe = allDirs.filter(d=>!d['–û–ø–ª–∞—á–µ–Ω–æ']&&!['done','lost'].includes(d['stage']||'prospect')).reduce((s,d)=>s+(Number(d['–¶–µ–Ω–∞'])||0),0);
    const doneCount = allDirs.filter(d=>(d['stage'])==='done').length;
    const lostCount = allDirs.filter(d=>(d['stage'])==='lost').length;
    const activeCount = allDirs.filter(d=>!['done','lost'].includes(d['stage']||'prospect')).length;
    
    // Follow-up alerts - clients to call today
    const followups = allDirs.filter(d => d['–°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç'] && d['–°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç'] <= td && !['done','lost'].includes(d['stage']||'prospect'));
    
    // Compact stats row
    sgHtml += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;margin-bottom:16px">';
    sgHtml += '<div class="card" style="padding:14px;text-align:center"><div style="font-size:11px;color:var(--text2)">üë• –ö–ª–∏–µ–Ω—Ç—ã</div><div style="font-size:22px;font-weight:700">'+allDirs.length+'</div><div style="font-size:10px;color:var(--text3)">'+activeCount+' –≤ —Ä–∞–±–æ—Ç–µ</div></div>';
    sgHtml += '<div class="card" style="padding:14px;text-align:center"><div style="font-size:11px;color:var(--text2)">üí∞ –ü–æ–ª—É—á–µ–Ω–æ</div><div style="font-size:22px;font-weight:700;color:var(--green)">'+totalRev.toLocaleString('ru')+'‚ÇΩ</div></div>';
    sgHtml += '<div class="card" style="padding:14px;text-align:center"><div style="font-size:11px;color:var(--text2)">üìä –í –≤–æ—Ä–æ–Ω–∫–µ</div><div style="font-size:22px;font-weight:700;color:var(--blue)">'+totalPipe.toLocaleString('ru')+'‚ÇΩ</div></div>';
    sgHtml += '<div class="card" style="padding:14px;text-align:center"><div style="font-size:11px;color:var(--text2)">‚úÖ –°–¥–∞–Ω–æ</div><div style="font-size:22px;font-weight:700">'+doneCount+'</div></div>';
    sgHtml += '<div class="card" style="padding:14px;text-align:center"><div style="font-size:11px;color:var(--text2)">‚ùå –û—Ç–∫–∞–∑—ã</div><div style="font-size:22px;font-weight:700;color:var(--red)">'+lostCount+'</div></div>';
    sgHtml += '</div>';
    
    // üîî Follow-up alerts - MOST IMPORTANT section
    if (followups.length) {
      sgHtml += '<div class="card" style="margin-bottom:16px;border:1px solid var(--orange);background:rgba(255,170,0,0.05)">';
      sgHtml += '<div style="padding:12px 16px;font-weight:700;color:var(--orange)">üîî –ù–∞–¥–æ –ø–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è ('+followups.length+')</div>';
      followups.forEach(d => {
        const cid = d['ID']||d.id||'';
        const cleanPh = (d['–¢–µ–ª–µ—Ñ–æ–Ω']||'').replace(/[^\\d+]/g,'');
        sgHtml += '<div style="padding:8px 16px;display:flex;align-items:center;gap:10px;border-top:1px solid var(--border)">';
        sgHtml += '<span style="font-weight:600;flex:1;cursor:pointer" onclick="openSlideOver(\''+escA(cid)+'\')">'+esc(d['–ù–∞–∑–≤–∞–Ω–∏–µ']||'?')+'</span>';
        sgHtml += '<span style="font-size:12px;color:var(--text2)">'+esc(d['–¢–µ–ª–µ—Ñ–æ–Ω']||'–Ω–µ—Ç —Ç–µ–ª.')+'</span>';
        sgHtml += '<span style="font-size:11px;padding:2px 8px;border-radius:10px;background:rgba(255,170,0,0.15);color:var(--orange)">–ö–∞—Å–∞–Ω–∏–µ #'+(Number(d['–ö–∞—Å–∞–Ω–∏—è']||0)+1)+'</span>';
        if (cleanPh) sgHtml += '<button onclick="window.open(\'tel:'+cleanPh+'\')" style="padding:4px 10px;font-size:12px;background:var(--accent);border:none;border-radius:6px;color:#000;cursor:pointer">üìû</button>';
        sgHtml += '<button onclick="logTouch(\''+escA(cid)+'\')" style="padding:4px 10px;font-size:12px;background:var(--green);border:none;border-radius:6px;color:#000;cursor:pointer">‚úÖ –ü–æ–∑–≤–æ–Ω–∏–ª</button>';
        sgHtml += '</div>';
      });
      sgHtml += '</div>';
    }
    
    // Vertical pipeline
    const canDel = getUserPerms().level >= 3; // CEO + –ó–∞–º
    sgHtml += '<div class="pipeline-vertical">';
    STAGES.forEach(stage => {
      const deals = allDirs.filter(d => (d['stage']||'prospect') === stage.id);
      const sum = deals.reduce((s,d) => s + (Number(d['–¶–µ–Ω–∞'])||0), 0);
      // Hide empty 'lost' stage by default
      if (stage.id === 'lost' && !deals.length) return;
      
      sgHtml += '<div class="pipe-stage">';
      sgHtml += '<div class="pipe-stage-hdr" onclick="togglePipeStage(this)">';
      sgHtml += '<div class="pipe-info"><span class="pipe-dot" style="background:'+stage.color+'"></span>'+stage.name+'</div>';
      sgHtml += '<div class="pipe-stats"><span>'+deals.length+' –∫–ª–∏–µ–Ω—Ç'+(deals.length!==1?'–æ–≤':'')+'</span>';
      if (sum) sgHtml += '<span style="color:var(--accent)">'+sum.toLocaleString('ru')+'‚ÇΩ</span>';
      if (stage.pct) sgHtml += '<span style="font-size:10px;color:var(--text3)">~'+stage.pct+'%</span>';
      sgHtml += '<span>‚ñæ</span></div></div>';
      
      if (deals.length) {
        sgHtml += '<div class="pipe-stage-body">';
        deals.forEach(d => {
          const cid = d['ID']||d.id||'';
          const cname = d['–ù–∞–∑–≤–∞–Ω–∏–µ']||'?';
          const overdue = d['–°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç'] && d['–°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç'] <= td && !['done','lost'].includes(stage.id);
          const touches = Number(d['–ö–∞—Å–∞–Ω–∏—è']||0);
          sgHtml += '<div class="pipe-client'+(overdue?' overdue':'')+'" onclick="openSlideOver(\''+escA(cid)+'\')">';
          sgHtml += '<div style="flex:1"><div class="pc-name">'+esc(cname)+'</div>';
          sgHtml += '<div class="pc-meta">';
          if (d['–¢–∏–ø —Å–∞–π—Ç–∞']) sgHtml += '<span>'+esc(d['–¢–∏–ø —Å–∞–π—Ç–∞'])+'</span>';
          if (d['–ì–æ—Ä–æ–¥']) sgHtml += '<span>üìç'+esc(d['–ì–æ—Ä–æ–¥'])+'</span>';
          if (d['–ú–µ–Ω–µ–¥–∂–µ—Ä']) sgHtml += '<span>üë§'+esc(d['–ú–µ–Ω–µ–¥–∂–µ—Ä'].split(' ')[0])+'</span>';
          if (d['–ò—Å—Ç–æ—á–Ω–∏–∫']) sgHtml += '<span style="font-size:10px">'+esc(d['–ò—Å—Ç–æ—á–Ω–∏–∫'])+'</span>';
          if (touches) sgHtml += '<span style="font-size:10px">üìû√ó'+touches+'</span>';
          if (overdue) sgHtml += '<span style="color:var(--orange)">üîî –ü–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å!</span>';
          else if (d['–°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç'] && !['done','lost'].includes(stage.id)) sgHtml += '<span style="font-size:10px;color:var(--text3)">üìÖ '+d['–°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç']+'</span>';
          sgHtml += d['–û–ø–ª–∞—á–µ–Ω–æ'] ? '<span style="color:var(--green)">üí∞</span>' : '';
          sgHtml += '</div></div>';
          if (d['–¶–µ–Ω–∞']) sgHtml += '<div class="pc-price">'+Number(d['–¶–µ–Ω–∞']).toLocaleString('ru')+'‚ÇΩ</div>';
          if (canDel) sgHtml += '<div class="pc-del" onclick="event.stopPropagation();deleteClient(\''+escA(cid)+'\',\''+escA(cname)+'\')" title="–£–¥–∞–ª–∏—Ç—å">üóë</div>';
          sgHtml += '</div>';
        });
        sgHtml += '</div>';
      }
      sgHtml += '</div>';
    });
    sgHtml += '</div>';
    
    // Add client button
    sgHtml += '<button class="btn btn-primary" onclick="openAddSubproject()" style="margin-top:16px;width:100%">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</button>';
    
  } else {
  // Standard subproject cards (for –†–ö–¢ etc.)
  for (const [spName, spMeta] of Object.entries(proj.subprojects)) {
    const spp = pp.filter(p => (p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'')===spName);
    const spt = ptActive.filter(t => (t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'')===spName);
    const spOverdue = spt.filter(t => t['–î–µ–¥–ª–∞–π–Ω'] && t['–î–µ–¥–ª–∞–π–Ω']<td);

    sgHtml += '<div class="subproject-card" onclick="openSubproject(\''+escA(spName)+'\')">';
    sgHtml += '<div style="position:absolute;top:0;left:0;right:0;height:3px;background:'+spMeta.color+'"></div>';
    sgHtml += '<span class="sp-emoji">'+spMeta.emoji+'</span>';
    sgHtml += '<h4>'+esc(spName)+'</h4>';
    sgHtml += '<div class="sp-desc">'+esc(spMeta.desc)+'</div>';
    sgHtml += '<div class="sp-stats">';
    sgHtml += '<span>ü§ù '+spp.length+'</span>';
    sgHtml += '<span>‚úÖ '+spt.length+'</span>';
    if (spOverdue.length) sgHtml += '<span style="color:var(--red)">üî¥ '+spOverdue.length+'</span>';
    sgHtml += '</div>';
    sgHtml += '</div>';
  }
  }

  document.getElementById('subproject-grid').innerHTML = sgHtml;

  // Tab content
  const content = document.getElementById('pv-content');
  let html = '';

  if (currentPvTab === 'overview') {
    // CLIENT STATUS SUMMARY (for –°–∞–π—Ç—ã project)
    if (proj.canAddSub) {
      const clientDirs = (DATA.directions||[]).filter(d => d['–ü—Ä–æ–µ–∫—Ç'] === proj.name);
      if (clientDirs.length) {
        html += '<div class="card" style="margin-bottom:16px"><div class="card-header"><h3>üë• –°—Ç–∞—Ç—É—Å –∫–ª–∏–µ–Ω—Ç–æ–≤ ('+clientDirs.length+')</h3></div>';
        html += '<div class="table-wrap"><table><thead><tr><th>–ö–ª–∏–µ–Ω—Ç</th><th>–≠—Ç–∞–ø</th><th>–¢–∏–ø —Å–∞–π—Ç–∞</th><th>üí∞ –¶–µ–Ω–∞</th><th>–ú–µ–Ω–µ–¥–∂–µ—Ä</th><th>–û–ø–ª–∞—Ç–∞</th><th>–ì–æ—Ä–æ–¥</th></tr></thead><tbody>';
        clientDirs.sort((a,b) => {
          const sa = STAGES.findIndex(s=>s.id===(a['stage']||'prospect'));
          const sb = STAGES.findIndex(s=>s.id===(b['stage']||'prospect'));
          return sa - sb;
        }).forEach(d => {
          const st = d['stage']||'prospect';
          const stObj = STAGES.find(s=>s.id===st) || STAGES[0];
          const stIdx = STAGES.findIndex(s=>s.id===st);
          const paid = d['–û–ø–ª–∞—á–µ–Ω–æ'];
          const price = Number(d['–¶–µ–Ω–∞'])||0;
          const cid = d['ID']||d.id||'';
          // Find the current active task for this client
          const clientTasks = (DATA.tasks||[]).filter(t => (t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'') === (d['–ù–∞–∑–≤–∞–Ω–∏–µ']||''));
          const activeTask = clientTasks.find(t => (t['–°—Ç–∞—Ç—É—Å']||'').includes('–í —Ä–∞–±–æ—Ç–µ') || (t['–°—Ç–∞—Ç—É—Å']||'').includes('–ù–æ–≤–∞—è'));
          html += '<tr onclick="openSlideOver(\''+escA(cid)+'\')" style="cursor:pointer" title="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π">';
          html += '<td><strong>'+esc(d['–ù–∞–∑–≤–∞–Ω–∏–µ']||'?')+'</strong></td>';
          html += '<td><span style="background:'+stObj.color+';color:#fff;padding:2px 10px;border-radius:10px;font-size:11px;white-space:nowrap">'+stObj.name+'</span></td>';
          html += '<td>'+esc(d['–¢–∏–ø —Å–∞–π—Ç–∞']||'‚Äî')+'</td>';
          html += '<td style="font-weight:600">'+(price?price.toLocaleString('ru')+'‚ÇΩ':'‚Äî')+'</td>';
          html += '<td>'+esc(d['–ú–µ–Ω–µ–¥–∂–µ—Ä']||'‚Äî')+'</td>';
          html += '<td style="color:'+(paid?'var(--green)':'var(--orange)')+'">'+( paid?'‚úÖ –û–ø–ª–∞—á–µ–Ω':'‚è≥')+'</td>';
          html += '<td>'+esc(d['–ì–æ—Ä–æ–¥']||'‚Äî')+'</td>';
          html += '</tr>';
          // Show current task as sub-row
          if (activeTask) {
            html += '<tr style="background:rgba(0,212,170,0.04);font-size:12px"><td colspan="7" style="padding:4px 12px 8px 20px">‚Ü≥ <span style="color:var(--accent)">–¢–µ–∫—É—â–∞—è –∑–∞–¥–∞—á–∞:</span> '+esc(activeTask['–û–ø–∏—Å–∞–Ω–∏–µ']||'')+'  <span style="color:var(--text2)">üë§ '+esc(activeTask['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'‚Äî')+' ¬∑ üìÖ '+(activeTask['–î–µ–¥–ª–∞–π–Ω']||'‚Äî')+'</span></td></tr>';
          }
        });
        html += '</tbody></table></div></div>';
      }
      
      // === KPI / Sales Performance ===
      const thisMonth = today().slice(0,7); // YYYY-MM
      const monthClients = clientDirs.filter(d => (d['–°–æ–∑–¥–∞–Ω']||d['–î–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è']||'').startsWith(thisMonth));
      const monthWon = monthClients.filter(d => d['stage'] === 'done').length;
      const monthLost = monthClients.filter(d => d['stage'] === 'lost').length;
      const monthRev = monthClients.filter(d=>d['–û–ø–ª–∞—á–µ–Ω–æ']).reduce((s,d)=>s+(Number(d['–¶–µ–Ω–∞'])||0),0);
      const totalTouches = clientDirs.reduce((s,d) => s + (Number(d['–ö–∞—Å–∞–Ω–∏—è']||0)), 0);
      const avgTouches = clientDirs.length ? Math.round(totalTouches / clientDirs.length * 10) / 10 : 0;
      const followupsDue = clientDirs.filter(d => d['–°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç'] && d['–°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç'] <= td && !['done','lost'].includes(d['stage']||'prospect')).length;
      
      html += '<div class="card" style="margin-bottom:16px"><div class="card-header"><h3>üìä KPI –∑–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü</h3></div>';
      html += '<div style="padding:16px;display:grid;grid-template-columns:repeat(auto-fit,minmax(110px,1fr));gap:12px;text-align:center">';
      html += '<div><div style="font-size:22px;font-weight:700">'+monthClients.length+'</div><div style="font-size:11px;color:var(--text2)">–ù–æ–≤—ã—Ö –ª–∏–¥–æ–≤</div></div>';
      html += '<div><div style="font-size:22px;font-weight:700;color:var(--green)">'+monthWon+'</div><div style="font-size:11px;color:var(--text2)">–ó–∞–∫—Ä—ã—Ç–æ</div></div>';
      html += '<div><div style="font-size:22px;font-weight:700;color:var(--red)">'+monthLost+'</div><div style="font-size:11px;color:var(--text2)">–û—Ç–∫–∞–∑—ã</div></div>';
      html += '<div><div style="font-size:22px;font-weight:700;color:var(--accent)">'+monthRev.toLocaleString('ru')+'‚ÇΩ</div><div style="font-size:11px;color:var(--text2)">–í—ã—Ä—É—á–∫–∞</div></div>';
      html += '<div><div style="font-size:22px;font-weight:700">'+avgTouches+'</div><div style="font-size:11px;color:var(--text2)">–°—Ä. –∫–∞—Å–∞–Ω–∏–π</div></div>';
      if (followupsDue) html += '<div><div style="font-size:22px;font-weight:700;color:var(--orange)">'+followupsDue+'</div><div style="font-size:11px;color:var(--text2)">üîî –ü–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å</div></div>';
      html += '</div></div>';
    }
    
    // Overdue
    if (ptOverdue.length) {
      html += '<div class="card" style="border-color:rgba(255,107,107,0.4)"><div class="card-header" style="background:rgba(255,107,107,0.05)"><h3>üî¥ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ ('+ptOverdue.length+')</h3></div>';
      html += '<div class="table-wrap"><table><thead><tr><th>–ó–∞–¥–∞—á–∞</th><th>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</th><th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th><th>–î–µ–¥–ª–∞–π–Ω</th><th></th></tr></thead><tbody>';
      html += ptOverdue.map(t => '<tr style="background:rgba(255,107,107,0.03)"><td>'+esc(t['–û–ø–∏—Å–∞–Ω–∏–µ']||t['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</td><td>'+esc(t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'])+'</td><td>'+prBadge(t['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç'])+'</td><td style="color:var(--red);font-weight:700">'+esc(t['–î–µ–¥–ª–∞–π–Ω'])+'</td><td>'+actBtns('task',t.ID,t['–û–ø–∏—Å–∞–Ω–∏–µ'])+'</td></tr>').join('');
      html += '</tbody></table></div></div>';
    }
    // Active projects
    if (ppr.length) {
      html += '<div class="card"><div class="card-header"><h3>üìÅ –ü—Ä–æ–µ–∫—Ç—ã ('+ppr.length+')</h3></div>';
      html += '<div class="table-wrap"><table><thead><tr><th>–ü—Ä–æ–µ–∫—Ç</th><th>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ü—Ä–æ–≥—Ä–µ—Å—Å</th><th>–î–µ–¥–ª–∞–π–Ω</th></tr></thead><tbody>';
      html += ppr.map(p => '<tr><td><strong>'+esc(p['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</strong></td><td>'+esc(p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'])+'</td><td>'+statusBadge(p['–°—Ç–∞—Ç—É—Å'])+'</td><td>'+progBar(p['–ü—Ä–æ–≥—Ä–µ—Å—Å'])+'</td><td>'+esc(p['–î–µ–¥–ª–∞–π–Ω']||'‚Äî')+'</td></tr>').join('');
      html += '</tbody></table></div></div>';
    }
    // Recent tasks
    const pOrder = {P1:1,P2:2,P3:3};
    const topT = [...ptActive].sort((a,b) => (pOrder[a['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']]||9)-(pOrder[b['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']]||9)).slice(0,10);
    html += '<div class="card"><div class="card-header"><h3>‚úÖ –ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏</h3></div>';
    html += '<div class="table-wrap"><table><thead><tr><th>–ó–∞–¥–∞—á–∞</th><th>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</th><th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–µ–¥–ª–∞–π–Ω</th><th></th></tr></thead><tbody>';
    html += topT.length ? topT.map(t => {
      const od = t['–î–µ–¥–ª–∞–π–Ω']&&t['–î–µ–¥–ª–∞–π–Ω']<td;
      return '<tr style="'+(od?'background:rgba(255,107,107,0.03)':'')+'"><td>'+(od?'üî¥ ':'')+esc(t['–û–ø–∏—Å–∞–Ω–∏–µ']||t['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</td><td>'+esc(t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'])+'</td><td>'+prBadge(t['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç'])+'</td><td>'+statusBadge(t['–°—Ç–∞—Ç—É—Å'])+'</td><td>'+esc(t['–î–µ–¥–ª–∞–π–Ω']||'‚Äî')+'</td><td>'+actBtns('task',t.ID,t['–û–ø–∏—Å–∞–Ω–∏–µ'])+'</td></tr>';
    }).join('') : emptyRow(6,'–ù–µ—Ç –∑–∞–¥–∞—á');
    html += '</tbody></table></div></div>';

  } else if (currentPvTab === 'tasks') {
    html += renderTaskTable(pt);
  } else if (currentPvTab === 'partners') {
    html += renderPartnerTable(pp);
  } else if (currentPvTab === 'staff') {
    // Staff for this project
    const projName = PROJECTS[currentProject]?.name || '';
    const projectStaff = getStaffForProject(projName).filter(s => (s['–°—Ç–∞—Ç—É—Å']||'–ê–∫—Ç–∏–≤–Ω—ã–π')!=='–û–∂–∏–¥–∞–µ—Ç');
    const roleColors = {CEO:'linear-gradient(135deg,#00d4aa,#4dabf7)','–ó–∞–º':'linear-gradient(135deg,#b197fc,#7950f2)','–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å':'linear-gradient(135deg,#ffa94d,#fd7e14)'};
    html += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:12px">';
    const roleOrd = {'CEO':0,'–ó–∞–º':1,'–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å':2};
    [...projectStaff].sort((a,b)=>(roleOrd[a['–†–æ–ª—å']]??9)-(roleOrd[b['–†–æ–ª—å']]??9)).forEach(s => {
      const bg = roleColors[s['–†–æ–ª—å']]||'linear-gradient(135deg,var(--text3),var(--text2))';
      const tc = DATA.tasks.filter(t=>(t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'').includes(s['–ò–º—è']||'___')&&(t['–°—Ç–∞—Ç—É—Å']||'')!=='–ì–æ—Ç–æ–≤–æ').length;
      html += '<div style="background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:14px;display:flex;align-items:center;gap:12px">';
      html += '<div style="width:40px;height:40px;border-radius:50%;background:'+bg+';display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--bg);font-size:16px;flex-shrink:0">'+esc((s['–ò–º—è']||'?')[0])+'</div>';
      html += '<div><div style="font-weight:600;font-size:13px">'+esc(s['–ò–º—è']||'‚Äî')+'</div>';
      html += '<div style="font-size:11px;color:var(--text2)">'+({CEO:'üëë',–ó–∞–º:'‚≠ê',–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å:'üìã'}[s['–†–æ–ª—å']]||'üë§')+' '+esc(s['–†–æ–ª—å']||'')+' ¬∑ '+esc(s['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'–í—Å–µ')+'</div>';
      if(tc) html += '<div style="font-size:10px;color:var(--orange)">üìã '+tc+' –∑–∞–¥–∞—á</div>';
      html += '</div></div>';
    });
    if(!projectStaff.length) html += '<div class="empty" style="grid-column:1/-1"><div class="icon">üë•</div><p>–ù–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</p></div>';
    html += '</div>';
  } else if (currentPvTab === 'timeline') {
    // Gantt / Timeline
    html += renderTimeline(pt, dirs);
  } else if (currentPvTab === 'comms') {
    const pNames = pp.map(p => p['–ù–∞–∑–≤–∞–Ω–∏–µ']).filter(Boolean);
    const dc = (DATA.comms||[]).filter(c => pNames.some(n => (c['–ü–∞—Ä—Ç–Ω—ë—Ä']||'').includes(n)));
    html += renderCommTable(dc);
  } else if (currentPvTab === 'finance') {
    html += renderSiteFinance();
  } else if (currentPvTab === 'salaries') {
    html += renderSiteSalaries();
  }

  content.innerHTML = html;
}

// ============================================================
// RENDER: SUBPROJECT VIEW (workspace inside e.g. –ö–¢ or –ü—ã—à–∫–∏)
// ============================================================
function renderSubprojectView() {
  if (!currentSubproject||!currentProject) return;
  const proj = PROJECTS[currentProject];
  const spMeta = proj?.subprojects[currentSubproject] || { emoji:'üìå', color:'var(--text2)', desc:'' };
  const td = today();
  const isSites = (currentProject === 'sites');

  document.getElementById('sp-parent').textContent = proj.name;
  document.getElementById('sp-parent').setAttribute('onclick', "openProject('"+currentProject+"')");
  document.getElementById('sp-name').textContent = currentSubproject;
  document.getElementById('sp-title').innerHTML = spMeta.emoji + ' ' + esc(currentSubproject);

  const sp = filterByRole(DATA.partners).filter(p => (p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'')===currentSubproject);
  const st = filterByRole(DATA.tasks).filter(t => (t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'')===currentSubproject);
  const spr = filterByRole(DATA.projects).filter(p => (p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'')===currentSubproject);
  const stActive = st.filter(t => (t['–°—Ç–∞—Ç—É—Å']||'')!=='–ì–æ—Ç–æ–≤–æ');
  const stDone = st.filter(t => (t['–°—Ç–∞—Ç—É—Å']||'')==='–ì–æ—Ç–æ–≤–æ');
  const stOverdue = stActive.filter(t => t['–î–µ–¥–ª–∞–π–Ω']&&t['–î–µ–¥–ª–∞–π–Ω']<td);

  // === METRICS (role-appropriate) ===
  if (isSites) {
    const dir = (DATA.directions||[]).find(d => (d['–ù–∞–∑–≤–∞–Ω–∏–µ']||d['name']) === currentSubproject && d['–ü—Ä–æ–µ–∫—Ç'] === '–°–∞–π—Ç—ã');
    const stage = dir ? (dir['stage']||'prospect') : 'prospect';
    const stObj = STAGES.find(s=>s.id===stage)||STAGES[0];
    const stIdx = STAGES.findIndex(s=>s.id===stage);
    const progress = Math.round((stIdx / (STAGES.length-1)) * 100);
    document.getElementById('sp-metrics').innerHTML =
      '<div class="metric-card"><div class="m-icon">üìä</div><div class="m-value" style="color:'+stObj.color+'">'+stObj.name.replace(/[^\w–ê-–Ø–∞-—è—ë–Å\s]/g,'').trim()+'</div><div class="m-label">–≠—Ç–∞–ø</div><div class="m-sub">—à–∞–≥ '+(stIdx+1)+'/'+STAGES.length+'</div></div>'+
      '<div class="metric-card"><div class="m-icon">‚úÖ</div><div class="m-value">'+stDone.length+'/'+st.length+'</div><div class="m-label">–ó–∞–¥–∞—á</div><div class="m-sub">'+stActive.length+' –≤ —Ä–∞–±–æ—Ç–µ</div></div>'+
      '<div class="metric-card"><div class="m-icon">'+(stOverdue.length?'üî¥':'üü¢')+'</div><div class="m-value" style="color:'+(stOverdue.length?'var(--red)':'var(--green)')+'">'+(stOverdue.length?stOverdue.length+' –ø—Ä–æ—Å—Ä–æ—á.':'–í —Å—Ä–æ–∫')+'</div><div class="m-label">–î–µ–¥–ª–∞–π–Ω</div></div>'+
      '<div class="metric-card"><div class="m-icon">üìà</div><div class="m-value">'+progress+'%</div><div class="m-label">–ü—Ä–æ–≥—Ä–µ—Å—Å</div><div class="m-sub" style="width:100%;height:4px;background:var(--bg4);border-radius:2px;margin-top:4px"><div style="width:'+progress+'%;height:100%;background:var(--green);border-radius:2px"></div></div></div>';
  } else {
    const avgPr = spr.length ? Math.round(spr.reduce((s,p) => s+(parseInt(p['–ü—Ä–æ–≥—Ä–µ—Å—Å'])||0),0)/spr.length) : 0;
    const pNames = sp.map(p => p['–ù–∞–∑–≤–∞–Ω–∏–µ']).filter(Boolean);
    const sc = (DATA.comms||[]).filter(c => pNames.some(n => (c['–ü–∞—Ä—Ç–Ω—ë—Ä']||'').includes(n)));
    document.getElementById('sp-metrics').innerHTML =
      '<div class="metric-card"><div class="m-icon">ü§ù</div><div class="m-value">'+sp.length+'</div><div class="m-label">–ü–∞—Ä—Ç–Ω—ë—Ä–æ–≤</div></div>'+
      '<div class="metric-card"><div class="m-icon">‚úÖ</div><div class="m-value">'+stActive.length+'</div><div class="m-label">–ó–∞–¥–∞—á</div><div class="m-sub">'+stDone.length+' –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</div></div>'+
      '<div class="metric-card"><div class="m-icon">üî¥</div><div class="m-value" style="color:'+(stOverdue.length?'var(--red)':'var(--green)')+'">'+stOverdue.length+'</div><div class="m-label">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</div></div>'+
      '<div class="metric-card"><div class="m-icon">üìÅ</div><div class="m-value">'+spr.length+'</div><div class="m-label">–ü—Ä–æ–µ–∫—Ç–æ–≤</div><div class="m-sub">'+avgPr+'% –ø—Ä–æ–≥—Ä–µ—Å—Å</div></div>';
  }

  const content = document.getElementById('sp-content');
  let html = '';

  // ====== –°–ê–ô–¢–´ CLIENT OVERVIEW ======
  if (isSites && currentSpTab === 'overview') {
    const dir = (DATA.directions||[]).find(d => (d['–ù–∞–∑–≤–∞–Ω–∏–µ']||d['name']) === currentSubproject && d['–ü—Ä–æ–µ–∫—Ç'] === '–°–∞–π—Ç—ã');
    if (dir) {
      const eid = escA(dir['ID']||dir.id||'');
      const stage = dir['stage']||'prospect';
      const stObj = STAGES.find(s=>s.id===stage)||STAGES[0];
      const stIdx = STAGES.findIndex(s=>s.id===stage);
      const wf = getWorkflowStep(dir);
      
      // === NEXT ACTION CARD (most important!) ===
      if (stage !== 'done' && stage !== 'lost') {
        const nextActions = {
          'prospect':    { icon:'üîç', title:'–ü–æ–∑–≤–æ–Ω–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç—É', desc:'–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç ‚Äî –ø–æ–∑–≤–æ–Ω–∏—Ç–µ –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ', btn:'üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å ‚Üí', fn:'openClientCard(\''+eid+'\')' },
          'contact':     { icon:'üìû', title:'–ñ–¥—ë–º –æ—Ç–≤–µ—Ç', desc:'–ü–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç–µ —á–µ—Ä–µ–∑ 1-2 –¥–Ω—è –µ—Å–ª–∏ –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª', btn:'–û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É ‚Üí', fn:'openClientCard(\''+eid+'\')' },
          'interest':    { icon:'‚úÖ', title:'–°–æ–±–µ—Ä–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–∞–π—Ç–∞', desc:'–ö–ª–∏–µ–Ω—Ç –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω! –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∞–Ω–∫–µ—Ç—É', btn:'–ó–∞–ø–æ–ª–Ω–∏—Ç—å ‚Üí', fn:'openClientCard(\''+eid+'\')' },
          'proto':       { icon:'üé®', title:'–°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ—Ç–æ—Ç–∏–ø', desc:'–û—Ç–∫—Ä–æ–π—Ç–µ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏ —Å–æ–∑–¥–∞–π—Ç–µ –¥–µ–º–æ-—Å–∞–π—Ç', btn:'–û—Ç–∫—Ä—ã—Ç—å –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä ‚Üí', fn:'showSpTab(\'sitegen\')' },
          'proposal':    { icon:'üìã', title:'–ö–ü –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', desc:'–ü–æ–∫–∞–∂–∏—Ç–µ –ø—Ä–æ—Ç–æ—Ç–∏–ø –ø—Ä–∏ –∑–≤–æ–Ω–∫–µ + –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ü–µ–Ω—É', btn:'ü§ù –ù–∞—á–∞—Ç—å –ø–µ—Ä–µ–≥–æ–≤–æ—Ä—ã', fn:'setDealStage(\''+eid+'\',\'negotiation\')' },
          'negotiation': { icon:'ü§ù', title:'–ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã', desc:'–û–±—Å—É–¥–∏—Ç–µ —É—Å–ª–æ–≤–∏—è –∏ –∑–∞–∫—Ä–æ–π—Ç–µ —Å–¥–µ–ª–∫—É', btn:'üí∞ –ö–ª–∏–µ–Ω—Ç —Å–æ–≥–ª–∞—Å–∏–ª—Å—è', fn:'setDealStage(\''+eid+'\',\'payment\')' },
          'payment':     { icon:'üí∞', title:'–ü–æ–ª—É—á–∏—Ç–µ –æ–ø–ª–∞—Ç—É –∏ —Å–¥–∞–π—Ç–µ —Å–∞–π—Ç', desc:'–ó–∞–ª–µ–π—Ç–µ –Ω–∞ —Ö–æ—Å—Ç–∏–Ω–≥ –∏ –ø–µ—Ä–µ–¥–∞–π—Ç–µ –∫–ª–∏–µ–Ω—Ç—É', btn:'‚úÖ –°–∞–π—Ç —Å–¥–∞–Ω!', fn:'setDealStage(\''+eid+'\',\'done\')' }
        };
        const na = nextActions[stage] || nextActions['prospect'];
        html += '<div class="card" style="border:2px solid '+stObj.color+';margin-bottom:16px;overflow:hidden">';
        html += '<div style="padding:20px;display:flex;align-items:center;gap:16px;flex-wrap:wrap">';
        html += '<div style="font-size:40px;line-height:1">'+na.icon+'</div>';
        html += '<div style="flex:1;min-width:200px">';
        html += '<div style="font-size:16px;font-weight:700;margin-bottom:4px">'+na.title+'</div>';
        html += '<div style="font-size:13px;color:var(--text2)">'+na.desc+'</div>';
        html += '</div>';
        const perm = getUserPerms();
        // Show action button: always for view/edit actions, only canWrite for stage changes
        const isStageChange = ['proposal','negotiation','payment'].includes(stage);
        if (!isStageChange || perm.canWrite) {
          html += '<button class="btn btn-primary" onclick="'+na.fn+'" style="font-size:14px;padding:12px 24px;white-space:nowrap">'+na.btn+'</button>';
        }
        html += '</div></div>';
      } else if (stage === 'lost') {
        html += '<div class="card" style="border:2px solid var(--red);margin-bottom:16px;padding:20px;text-align:center;background:rgba(255,75,75,.04)">';
        html += '<div style="font-size:40px;margin-bottom:8px">‚ùå</div>';
        html += '<div style="font-size:18px;font-weight:700;color:var(--red)">–ö–ª–∏–µ–Ω—Ç –æ—Ç–∫–∞–∑–∞–ª—Å—è</div>';
        html += '<div style="color:var(--text2);margin-top:4px">–ü—Ä–∏—á–∏–Ω–∞: '+esc(dir['–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞']||'–Ω–µ —É–∫–∞–∑–∞–Ω–∞')+'</div>';
        html += '<button class="btn btn-secondary" onclick="advanceToStage(\''+eid+'\',\'prospect\')" style="margin-top:12px">üîÑ –í–µ—Ä–Ω—É—Ç—å –≤ –≤–æ—Ä–æ–Ω–∫—É</button>';
        html += '</div>';
      } else {
        html += '<div class="card" style="border:2px solid var(--green);margin-bottom:16px;padding:20px;text-align:center;background:rgba(0,212,170,.04)">';
        html += '<div style="font-size:40px;margin-bottom:8px">üéâ</div>';
        html += '<div style="font-size:18px;font-weight:700;color:var(--green)">–ü—Ä–æ–µ–∫—Ç –∑–∞–≤–µ—Ä—à—ë–Ω!</div>';
        html += '<div style="color:var(--text2);margin-top:4px">–ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∏–ª –≥–æ—Ç–æ–≤—ã–π —Å–∞–π—Ç</div>';
        html += '</div>';
      }
      
      // === CLIENT INFO + TASK CHECKLIST (2-column layout) ===
      html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px" class="sp-two-col">';
      
      // Left: Client info card
      html += '<div class="card" style="padding:0;overflow:hidden">';
      html += '<div class="card-header" style="display:flex;justify-content:space-between;align-items:center"><h3>üìá –ö–ª–∏–µ–Ω—Ç</h3>';
      html += '<button class="btn btn-sm btn-secondary" onclick="openClientCard(\''+eid+'\')">‚úèÔ∏è</button></div>';
      html += '<div style="padding:12px 16px">';
      const fields = [
        ['üì± –¢–µ–ª–µ—Ñ–æ–Ω', dir['–¢–µ–ª–µ—Ñ–æ–Ω']],
        ['üìç –ì–æ—Ä–æ–¥', dir['–ì–æ—Ä–æ–¥']],
        ['üåê –¢–∏–ø —Å–∞–π—Ç–∞', dir['–¢–∏–ø —Å–∞–π—Ç–∞']],
        ['üí∞ –¶–µ–Ω–∞', dir['–¶–µ–Ω–∞'] ? Number(dir['–¶–µ–Ω–∞']).toLocaleString('ru')+'‚ÇΩ' : null],
        ['üë§ –ú–µ–Ω–µ–¥–∂–µ—Ä', dir['–ú–µ–Ω–µ–¥–∂–µ—Ä']],
        ['üíº –¢–∏–ø –±–∏–∑–Ω–µ—Å–∞', dir['–¢–∏–ø –±–∏–∑–Ω–µ—Å–∞'] || dir['–û–ø–∏—Å–∞–Ω–∏–µ']],
        ['üí≥ –û–ø–ª–∞—Ç–∞', dir['–û–ø–ª–∞—á–µ–Ω–æ'] ? '‚úÖ –û–ø–ª–∞—á–µ–Ω' : '‚è≥ –ù–µ –æ–ø–ª–∞—á–µ–Ω']
      ];
      fields.forEach(([label, val]) => {
        if (val) {
          html += '<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);font-size:13px">';
          html += '<span style="color:var(--text2)">'+label+'</span>';
          if (label.includes('–¢–µ–ª–µ—Ñ–æ–Ω') && val) {
            const clean = val.replace(/[^\d+]/g,'');
            html += '<span><a href="tel:'+esc(clean)+'" style="color:var(--accent)">'+esc(val)+'</a></span>';
          } else if (label.includes('–û–ø–ª–∞—Ç–∞')) {
            html += '<span style="color:'+(val.includes('‚úÖ')?'var(--green)':'var(--orange)')+'">'+val+'</span>';
          } else {
            html += '<span style="font-weight:500">'+esc(val)+'</span>';
          }
          html += '</div>';
        }
      });
      if (dir['–°—Å—ã–ª–∫–∞']) {
        html += '<div style="padding:6px 0;font-size:13px"><span style="color:var(--text2)">üîó –°—Å—ã–ª–∫–∞</span> <a href="'+esc(dir['–°—Å—ã–ª–∫–∞'])+'" target="_blank" style="color:var(--accent);word-break:break-all">'+esc(dir['–°—Å—ã–ª–∫–∞'])+'</a></div>';
      }
      html += '</div></div>';
      
      // Right: Task checklist
      html += '<div class="card" style="padding:0;overflow:hidden">';
      html += '<div class="card-header"><h3>‚úÖ –ó–∞–¥–∞—á–∏ ('+stDone.length+'/'+st.length+')</h3></div>';
      html += '<div style="padding:8px 16px;max-height:300px;overflow-y:auto">';
      if (st.length) {
        // Sort: active first, then done
        const sortedTasks = [...stActive, ...stDone];
        sortedTasks.forEach(t => {
          const done = (t['–°—Ç–∞—Ç—É—Å']||'')==='–ì–æ—Ç–æ–≤–æ';
          const od = !done && t['–î–µ–¥–ª–∞–π–Ω'] && t['–î–µ–¥–ª–∞–π–Ω'] < td;
          const tid = t['ID']||t.id;
          html += '<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border);cursor:pointer;'+(done?'opacity:0.5':'')+(od?';background:rgba(255,107,107,0.05);margin:0 -16px;padding:8px 16px':'')+'" onclick="openTaskDetail(\''+escA(tid)+'\')">';
          html += '<div style="width:22px;height:22px;border-radius:6px;border:2px solid '+(done?'var(--green)':od?'var(--red)':'var(--border2)')+';display:flex;align-items:center;justify-content:center;flex-shrink:0;cursor:pointer;font-size:12px" onclick="event.stopPropagation();toggleTaskDone(\''+escA(tid)+'\')">'+(done?'‚úì':'')+'</div>';
          html += '<div style="flex:1;min-width:0">';
          html += '<div style="font-size:12px;'+(done?'text-decoration:line-through;color:var(--text3)':'')+(od?';color:var(--red)':'')+'">'+(od?'üî¥ ':'')+esc(t['–û–ø–∏—Å–∞–Ω–∏–µ']||t['–ù–∞–∑–≤–∞–Ω–∏–µ']||'?')+'</div>';
          html += '<div style="font-size:10px;color:var(--text3);display:flex;gap:8px;margin-top:2px">';
          if (t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']) html += '<span>üë§ '+esc(t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π'].split(' ')[0])+'</span>';
          if (t['–î–µ–¥–ª–∞–π–Ω']) html += '<span style="'+(od?'color:var(--red);font-weight:600':'')+'">üìÖ '+t['–î–µ–¥–ª–∞–π–Ω'].slice(5)+'</span>';
          html += '</div></div></div>';
        });
      } else {
        html += '<div style="text-align:center;padding:20px;color:var(--text3)">–ó–∞–¥–∞—á –ø–æ–∫–∞ –Ω–µ—Ç</div>';
      }
      html += '</div></div>';
      html += '</div>'; // end 2-col
      
      // === BUDGET CARD (for –ó–∞–º / CEO) ===
      const p = getUserPerms();
      if (p.canViewFinance && dir['–¶–µ–Ω–∞']) {
        const price = Number(dir['–¶–µ–Ω–∞'])||0;
        // Calculate staff costs for this client based on individual salary_pct
        const clientTasks = (DATA.tasks||[]).filter(t => t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] === dir['–ù–∞–∑–≤–∞–Ω–∏–µ']);
        const assignedNames = new Set();
        clientTasks.forEach(t => { if (t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']) assignedNames.add(t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']); });
        let staffCost = 0;
        const staffBreakdown = [];
        assignedNames.forEach(name => {
          const emp = (DATA.staff||[]).find(s => s['–ò–º—è'] === name);
          if (emp) {
            const pct = parseInt(emp['–ü—Ä–æ—Ü–µ–Ω—Ç_–ó–ü']) || DEFAULT_SALARY_PCT[emp['–†–æ–ª—å']] || 0;
            const pay = Math.round(price * pct / 100);
            staffCost += pay;
            if (pct > 0) staffBreakdown.push(esc(name) + ' ' + pct + '% (' + pay.toLocaleString('ru') + '‚ÇΩ)');
          }
        });
        const profit = price - staffCost;
        html += '<div class="card" style="margin-bottom:16px"><div class="card-header"><h3>üí∞ –ë—é–¥–∂–µ—Ç —Å–¥–µ–ª–∫–∏</h3></div>';
        html += '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;padding:16px;text-align:center">';
        html += '<div><div style="font-size:11px;color:var(--text2)">–ö–ª–∏–µ–Ω—Ç –ø–ª–∞—Ç–∏—Ç</div><div style="font-size:18px;font-weight:700">'+price.toLocaleString('ru')+'‚ÇΩ</div></div>';
        html += '<div><div style="font-size:11px;color:var(--text2)">–§–û–¢ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</div><div style="font-size:18px;font-weight:700;color:var(--orange)">'+staffCost.toLocaleString('ru')+'‚ÇΩ</div></div>';
        html += '<div><div style="font-size:11px;color:var(--text2)">–ü—Ä–∏–±—ã–ª—å</div><div style="font-size:18px;font-weight:700;color:var(--green)">'+profit.toLocaleString('ru')+'‚ÇΩ</div></div>';
        html += '</div>';
        if (staffBreakdown.length) {
          html += '<div style="padding:8px 16px 16px;font-size:11px;color:var(--text2)">'+staffBreakdown.join(' ¬∑ ')+'</div>';
        }
        html += '</div>';
      }
      
    } else {
      html += '<div class="empty"><div class="icon">üöÄ</div><p>–ö–ª–∏–µ–Ω—Ç ¬´'+esc(currentSubproject)+'¬ª –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ</p></div>';
    }
    
  // ====== –°–ê–ô–¢–´ CLIENT INFO (Anketa tab) ======
  } else if (isSites && currentSpTab === 'client-info') {
    const dir = (DATA.directions||[]).find(d => (d['–ù–∞–∑–≤–∞–Ω–∏–µ']||d['name']) === currentSubproject && d['–ü—Ä–æ–µ–∫—Ç'] === '–°–∞–π—Ç—ã');
    if (dir) {
      const eid = escA(dir['ID']||dir.id||'');
      html += '<div class="card" style="padding:20px">';
      html += '<h3 style="margin-bottom:16px">üìã –ê–Ω–∫–µ—Ç–∞ –∫–ª–∏–µ–Ω—Ç–∞: '+esc(currentSubproject)+'</h3>';
      html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px" class="sp-two-col">';
      const anketaFields = [
        {id:'cc-biz-type', label:'–¢–∏–ø –±–∏–∑–Ω–µ—Å–∞', val:dir['–¢–∏–ø –±–∏–∑–Ω–µ—Å–∞']||dir['–û–ø–∏—Å–∞–Ω–∏–µ']||'', type:'text', ph:'–†–µ—Å—Ç–æ—Ä–∞–Ω, —Å–∞–ª–æ–Ω –∫—Ä–∞—Å–æ—Ç—ã...'},
        {id:'cc-phone', label:'–¢–µ–ª–µ—Ñ–æ–Ω', val:dir['–¢–µ–ª–µ—Ñ–æ–Ω']||'', type:'tel', ph:'+7 900 123-45-67'},
        {id:'cc-city', label:'–ì–æ—Ä–æ–¥', val:dir['–ì–æ—Ä–æ–¥']||'', type:'text', ph:'–ù–∞–±–µ—Ä–µ–∂–Ω—ã–µ –ß–µ–ª–Ω—ã'},
        {id:'cc-address', label:'–ê–¥—Ä–µ—Å', val:dir['–ê–¥—Ä–µ—Å']||'', type:'text', ph:'—É–ª. –õ–µ–Ω–∏–Ω–∞ 1'},
        {id:'cc-social', label:'–°–æ—Ü—Å–µ—Ç–∏', val:dir['–°–æ—Ü—Å–µ—Ç–∏']||'', type:'text', ph:'@instagram, vk.com/...'},
        {id:'cc-hours', label:'–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã', val:dir['–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã']||'', type:'text', ph:'–ü–Ω-–ü—Ç 9:00-18:00'},
      ];
      anketaFields.forEach(f => {
        html += '<div><label style="font-size:11px;color:var(--text2);display:block;margin-bottom:3px">'+f.label+'</label>';
        html += '<input id="'+f.id+'" type="'+f.type+'" value="'+escA(f.val)+'" placeholder="'+f.ph+'" style="width:100%;padding:8px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px"></div>';
      });
      html += '</div>';
      // Full-width fields
      html += '<div style="margin-top:12px"><label style="font-size:11px;color:var(--text2);display:block;margin-bottom:3px">–£—Å–ª—É–≥–∏ / –ú–µ–Ω—é</label>';
      html += '<textarea id="cc-services" rows="3" placeholder="–ü–µ—Ä–µ—á–∏—Å–ª–∏—Ç–µ —É—Å–ª—É–≥–∏ –∏–ª–∏ –ø–æ–∑–∏—Ü–∏–∏ –º–µ–Ω—é" style="width:100%;padding:8px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;resize:vertical">'+(dir['–£—Å–ª—É–≥–∏']||'')+'</textarea></div>';
      html += '<div style="margin-top:12px"><label style="font-size:11px;color:var(--text2);display:block;margin-bottom:3px">–¶–µ–Ω—ã –Ω–∞ —É—Å–ª—É–≥–∏</label>';
      html += '<textarea id="cc-prices" rows="3" placeholder="–°—Ç—Ä–∏–∂–∫–∞ ‚Äî 500‚ÇΩ, –ú–∞–Ω–∏–∫—é—Ä ‚Äî 1000‚ÇΩ..." style="width:100%;padding:8px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;resize:vertical">'+(dir['–¶–µ–Ω—ã']||'')+'</textarea></div>';
      html += '<div style="margin-top:12px"><label style="font-size:11px;color:var(--text2);display:block;margin-bottom:3px">–ü–æ–∂–µ–ª–∞–Ω–∏—è –ø–æ –¥–∏–∑–∞–π–Ω—É</label>';
      html += '<textarea id="cc-wishes" rows="2" placeholder="–¶–≤–µ—Ç–∞, —Å—Ç–∏–ª—å, —Ä–µ—Ñ–µ—Ä–µ–Ω—Å—ã..." style="width:100%;padding:8px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;resize:vertical">'+(dir['–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π']||'')+'</textarea></div>';

      // Logo upload
      html += '<div style="margin-top:16px;border-top:1px solid var(--border);padding-top:16px">';
      html += '<div style="font-size:14px;font-weight:600;margin-bottom:12px">üìé –§–∞–π–ª—ã –¥–ª—è —Å–∞–π—Ç–∞</div>';
      html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px" class="sp-two-col">';

      // Logo
      html += '<div>';
      html += '<label style="font-size:11px;color:var(--text2);display:block;margin-bottom:6px">üñºÔ∏è –õ–æ–≥–æ—Ç–∏–ø</label>';
      if (dir['logo_url']) {
        html += '<div id="cc-logo-preview" style="margin-bottom:8px"><img src="'+esc(dir['logo_url'])+'" style="max-width:120px;max-height:80px;border-radius:8px;border:1px solid var(--border)"></div>';
        html += '<button class="btn btn-sm" style="margin-bottom:4px" onclick="removeAnketaFile(\''+eid+'\',\'logo\')">üóë –£–¥–∞–ª–∏—Ç—å</button><br>';
      } else {
        html += '<div id="cc-logo-preview"></div>';
      }
      html += '<input type="file" id="cc-logo-file" accept="image/*" onchange="uploadAnketaFile(\''+eid+'\',\'logo\',this)" style="font-size:12px">';
      html += '</div>';

      // Photos
      html += '<div>';
      html += '<label style="font-size:11px;color:var(--text2);display:block;margin-bottom:6px">üì∏ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ (–¥–æ 5)</label>';
      const photos = (() => { try { return JSON.parse(dir['photos']||'[]'); } catch(e) { return []; } })();
      html += '<div id="cc-photos-preview" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px">';
      photos.forEach((url, i) => {
        html += '<div style="position:relative;display:inline-block">';
        html += '<img src="'+esc(url)+'" style="width:60px;height:60px;object-fit:cover;border-radius:6px;border:1px solid var(--border)">';
        html += '<button onclick="removeAnketaPhoto(\''+eid+'\','+i+')" style="position:absolute;top:-4px;right:-4px;width:18px;height:18px;border-radius:50%;background:var(--red);color:#fff;border:none;font-size:10px;cursor:pointer;display:flex;align-items:center;justify-content:center">√ó</button>';
        html += '</div>';
      });
      html += '</div>';
      if (photos.length < 5) {
        html += '<input type="file" id="cc-photos-file" accept="image/*" multiple onchange="uploadAnketaFile(\''+eid+'\',\'photos\',this)" style="font-size:12px">';
      }
      html += '</div>';
      html += '</div></div>';

      html += '<div style="margin-top:16px;display:flex;gap:8px">';
      html += '<button class="btn btn-primary" onclick="saveAnketa(\''+eid+'\')" style="flex:1">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∞–Ω–∫–µ—Ç—É</button>';
      const stage = dir['stage']||'prospect';
      if (stage === 'contact') {
        html += '<button class="btn btn-secondary" onclick="advanceAnketaToProto(\''+eid+'\')" style="flex:1">üé® –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ —Å–æ–∑–¥–∞—Ç—å —Å–∞–π—Ç ‚Üí</button>';
      }
      html += '</div></div>';
    }

  // ====== STANDARD OVERVIEW (–†–ö–¢ etc.) ======
  } else if (!isSites && currentSpTab === 'overview') {
    if (stOverdue.length) {
      html += '<div class="card" style="border-color:rgba(255,107,107,0.4)"><div class="card-header" style="background:rgba(255,107,107,0.05)"><h3>üî¥ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ ('+stOverdue.length+')</h3></div>';
      html += '<div class="table-wrap"><table><thead><tr><th>–ó–∞–¥–∞—á–∞</th><th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th><th>–î–µ–¥–ª–∞–π–Ω</th><th>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th><th></th></tr></thead><tbody>';
      html += stOverdue.map(t => '<tr style="background:rgba(255,107,107,0.03)"><td>'+esc(t['–û–ø–∏—Å–∞–Ω–∏–µ']||t['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</td><td>'+prBadge(t['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç'])+'</td><td style="color:var(--red);font-weight:700">'+esc(t['–î–µ–¥–ª–∞–π–Ω'])+'</td><td>'+esc(t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'‚Äî')+'</td><td>'+actBtns('task',t.ID,t['–û–ø–∏—Å–∞–Ω–∏–µ'])+'</td></tr>').join('');
      html += '</tbody></table></div></div>';
    }
    if (spr.length) {
      html += '<div class="card"><div class="card-header"><h3>üìÅ –ü—Ä–æ–µ–∫—Ç—ã</h3></div><div class="table-wrap"><table><thead><tr><th>–ü—Ä–æ–µ–∫—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ü—Ä–æ–≥—Ä–µ—Å—Å</th><th>–ü–∞—Ä—Ç–Ω—ë—Ä</th><th>–î–µ–¥–ª–∞–π–Ω</th></tr></thead><tbody>';
      html += spr.map(p => '<tr><td><strong>'+esc(p['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</strong></td><td>'+statusBadge(p['–°—Ç–∞—Ç—É—Å'])+'</td><td>'+progBar(p['–ü—Ä–æ–≥—Ä–µ—Å—Å'])+'</td><td>'+esc(p['–ü–∞—Ä—Ç–Ω—ë—Ä']||'')+'</td><td>'+esc(p['–î–µ–¥–ª–∞–π–Ω']||'‚Äî')+'</td></tr>').join('');
      html += '</tbody></table></div></div>';
    }
    const pO = {P1:1,P2:2,P3:3};
    const topT = [...stActive].sort((a,b)=>(pO[a['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']]||9)-(pO[b['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']]||9)).slice(0,10);
    html += '<div class="card"><div class="card-header"><h3>‚úÖ –ó–∞–¥–∞—á–∏ ('+stActive.length+')</h3></div><div class="table-wrap"><table><thead><tr><th>–ó–∞–¥–∞—á–∞</th><th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th><th>–î–µ–¥–ª–∞–π–Ω</th><th></th></tr></thead><tbody>';
    html += topT.length ? topT.map(t => {
      const od = t['–î–µ–¥–ª–∞–π–Ω']&&t['–î–µ–¥–ª–∞–π–Ω']<td&&(t['–°—Ç–∞—Ç—É—Å']||'')!=='–ì–æ—Ç–æ–≤–æ';
      return '<tr style="'+(od?'background:rgba(255,107,107,0.03)':'')+'"><td>'+(od?'üî¥ ':'')+esc(t['–û–ø–∏—Å–∞–Ω–∏–µ']||t['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</td><td>'+prBadge(t['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç'])+'</td><td>'+statusBadge(t['–°—Ç–∞—Ç—É—Å'])+'</td><td>'+esc(t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'‚Äî')+'</td><td>'+esc(t['–î–µ–¥–ª–∞–π–Ω']||'‚Äî')+'</td><td>'+actBtns('task',t.ID,t['–û–ø–∏—Å–∞–Ω–∏–µ'])+'</td></tr>';
    }).join('') : emptyRow(6,'–ù–µ—Ç –∑–∞–¥–∞—á');
    html += '</tbody></table></div></div>';
    if(sp.length) {
      html += '<div class="card"><div class="card-header"><h3>ü§ù –ü–∞—Ä—Ç–Ω—ë—Ä—ã ('+sp.length+')</h3></div><div class="table-wrap"><table><thead><tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–°—Ç—Ä–∞–Ω–∞</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ü—Ä–æ–¥—É–∫—Ç</th><th>–ö–æ–Ω—Ç–∞–∫—Ç</th></tr></thead><tbody>';
      html += sp.map(p => '<tr><td><strong>'+esc(p['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</strong></td><td>'+esc(p['–°—Ç—Ä–∞–Ω–∞'])+'</td><td>'+statusBadge(p['–°—Ç–∞—Ç—É—Å'])+'</td><td>'+esc(p['–ü—Ä–æ–¥—É–∫—Ç']||'')+'</td><td>'+esc(p['–ö–æ–Ω—Ç–∞–∫—Ç']||'')+'</td></tr>').join('');
      html += '</tbody></table></div></div>';
    }
    if(!html) html = '<div class="empty"><div class="icon">üöÄ</div><p>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ¬´'+esc(currentSubproject)+'¬ª –ø–æ–∫–∞ –ø—É—Å—Ç–æ–µ.</p></div>';

  // ====== SHARED TABS ======
  } else if (currentSpTab==='tasks') { html += renderTaskTable(st);
  } else if (currentSpTab==='partners') { html += renderPartnerTable(sp);
  } else if (currentSpTab==='projects') {
    html += '<div class="card"><div class="table-wrap"><table><thead><tr><th>–ü—Ä–æ–µ–∫—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th><th>–ü—Ä–æ–≥—Ä–µ—Å—Å</th><th>–ü–∞—Ä—Ç–Ω—ë—Ä</th><th>–ë—é–¥–∂–µ—Ç</th><th>–î–µ–¥–ª–∞–π–Ω</th><th></th></tr></thead><tbody>';
    html += spr.length ? spr.map(p => '<tr><td><strong>'+esc(p['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</strong></td><td>'+statusBadge(p['–°—Ç–∞—Ç—É—Å'])+'</td><td>'+prBadge(p['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç'])+'</td><td>'+progBar(p['–ü—Ä–æ–≥—Ä–µ—Å—Å'])+'</td><td>'+esc(p['–ü–∞—Ä—Ç–Ω—ë—Ä']||'')+'</td><td>'+esc(p['–ë—é–¥–∂–µ—Ç']||'‚Äî')+'</td><td>'+esc(p['–î–µ–¥–ª–∞–π–Ω']||'‚Äî')+'</td><td>'+actBtns('project',p.ID,p['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</td></tr>').join('') : emptyRow(8,'–ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤');
    html += '</tbody></table></div></div>';
  } else if (currentSpTab==='comms') {
    const pNames = sp.map(p => p['–ù–∞–∑–≤–∞–Ω–∏–µ']).filter(Boolean);
    const sc = (DATA.comms||[]).filter(c => pNames.some(n => (c['–ü–∞—Ä—Ç–Ω—ë—Ä']||'').includes(n)));
    html += renderCommTable(sc);
  } else if (currentSpTab==='sitegen') {
    const sgCheck = getSiteGenData();
    if (sgCheck.html) siteGenStep = 'preview';
    else if (siteGenStep !== 'loading') siteGenStep = 'form';
    html += renderSiteGenerator(); 
  } else if (currentSpTab==='files') { html += renderFilesSection(); }

  content.innerHTML = html;
  if (currentSpTab==='sitegen') initSiteGenerator();
  if (currentSpTab==='files') initFileUpload();
}

// Reusable table renderers
function renderTaskTable(data) {
  const pO = {P1:1,P2:2,P3:3};
  const sorted = [...data].sort((a,b)=>(pO[a['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']]||9)-(pO[b['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']]||9));
  const td = today();
  let h = '<div class="card"><div class="table-wrap"><table><thead><tr><th>–ó–∞–¥–∞—á–∞</th><th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th><th>–ü—Ä–æ–µ–∫—Ç</th><th>–î–µ–¥–ª–∞–π–Ω</th><th></th></tr></thead><tbody>';
  h += sorted.length ? sorted.map(t => {
    const od = t['–î–µ–¥–ª–∞–π–Ω']&&t['–î–µ–¥–ª–∞–π–Ω']<td&&(t['–°—Ç–∞—Ç—É—Å']||'')!=='–ì–æ—Ç–æ–≤–æ';
    return '<tr style="'+(od?'background:rgba(255,107,107,0.05)':'')+'"><td>'+(od?'üî¥ ':'')+esc(t['–û–ø–∏—Å–∞–Ω–∏–µ']||t['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</td><td>'+prBadge(t['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç'])+'</td><td>'+statusBadge(t['–°—Ç–∞—Ç—É—Å'])+'</td><td>'+esc(t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'‚Äî')+'</td><td>'+esc(t['–ü—Ä–æ–µ–∫—Ç']||'‚Äî')+'</td><td>'+(od?'<span style="color:var(--red);font-weight:700">':'')+esc(t['–î–µ–¥–ª–∞–π–Ω']||'‚Äî')+(od?'</span>':'')+'</td><td>'+actBtns('task',t.ID,t['–û–ø–∏—Å–∞–Ω–∏–µ']||t['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</td></tr>';
  }).join('') : emptyRow(7,'–ù–µ—Ç –∑–∞–¥–∞—á');
  h += '</tbody></table></div></div>';
  return h;
}

function renderPartnerTable(data) {
  let h = '<div class="card"><div class="table-wrap"><table><thead><tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–°—Ç—Ä–∞–Ω–∞</th><th>–ü—Ä–æ–¥—É–∫—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ö–æ–Ω—Ç–∞–∫—Ç</th><th>Email</th><th></th></tr></thead><tbody>';
  h += data.length ? data.map(p => '<tr><td><strong>'+esc(p['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</strong></td><td>'+esc(p['–°—Ç—Ä–∞–Ω–∞'])+'</td><td>'+esc(p['–ü—Ä–æ–¥—É–∫—Ç']||'')+'</td><td>'+statusBadge(p['–°—Ç–∞—Ç—É—Å'])+'</td><td>'+esc(p['–ö–æ–Ω—Ç–∞–∫—Ç']||'')+'</td><td>'+esc(p['Email']||'')+'</td><td>'+actBtns('partner',p.ID,p['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</td></tr>').join('') : emptyRow(7,'–ù–µ—Ç –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤');
  h += '</tbody></table></div></div>';
  return h;
}

function renderCommTable(data) {
  let h = '<div class="card"><div class="table-wrap"><table><thead><tr><th>–ü–∞—Ä—Ç–Ω—ë—Ä</th><th>–¢–∏–ø</th><th>–¢–µ–º–∞</th><th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th><th>–î–∞—Ç–∞</th><th>–ê–≤—Ç–æ—Ä</th><th></th></tr></thead><tbody>';
  h += data.length ? data.map(c => '<tr><td><strong>'+esc(c['–ü–∞—Ä—Ç–Ω—ë—Ä'])+'</strong></td><td>'+esc(c['–¢–∏–ø'])+'</td><td>'+esc(c['–¢–µ–º–∞'])+'</td><td style="font-size:12px;max-width:200px;overflow:hidden;text-overflow:ellipsis">'+esc(c['–†–µ–∑—É–ª—å—Ç–∞—Ç']||'')+'</td><td>'+esc(c['–î–∞—Ç–∞']||'‚Äî')+'</td><td>'+esc(c['–ê–≤—Ç–æ—Ä']||'‚Äî')+'</td><td>'+actBtns('comm',c.ID||'',c['–ü–∞—Ä—Ç–Ω—ë—Ä'])+'</td></tr>').join('') : emptyRow(7,'–ù–µ—Ç –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π');
  h += '</tbody></table></div></div>';
  return h;
}

// ============================================================
// RENDER: DASHBOARD (–ì–î)
// ============================================================
function renderDashboard() {
  const p = getUserPerms();
  const isCEO = USER && USER.role === 'CEO';
  
  // === CEO/–ó–∞–º KPI PANEL ===
  if (isCEO || USER.role === '–ó–∞–º') {
    try {
      var allDirs = DATA.directions || [];
      var siteDirs = allDirs.filter(function(d) { return d['–ü—Ä–æ–µ–∫—Ç'] === '–°–∞–π—Ç—ã'; });
      var totalLeads = siteDirs.length;
      var wonDeals = siteDirs.filter(function(d) { return d.stage === 'done'; }).length;
      var lostDeals = siteDirs.filter(function(d) { return d.stage === 'lost'; }).length;
      var activeDeals = totalLeads - wonDeals - lostDeals;
      var convRate = totalLeads > 0 ? ((wonDeals / totalLeads) * 100).toFixed(1) : '0.0';
      var revenue = siteDirs.filter(function(d) { return d.stage === 'done'; }).reduce(function(s, d) { return s + (parseFloat(d['–¶–µ–Ω–∞']) || 0); }, 0);
      var todayDate = new Date().toISOString().split('T')[0];
      var overdueFollowups = siteDirs.filter(function(d) {
        return d['–°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç'] && d['–°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç'] < todayDate && ['done','lost'].indexOf(d.stage) < 0;
      });
      var kpi = '<div style="background:linear-gradient(135deg,var(--bg3),var(--bg2));border:1px solid var(--border);border-radius:16px;padding:24px;margin-bottom:24px">';
      kpi += '<h3 style="font-size:15px;margin-bottom:16px;color:var(--text2)">üìä KPI –ü—Ä–æ–¥–∞–∂–∏ (–°–∞–π—Ç—ã)</h3>';
      kpi += '<div style="display:grid;grid-template-columns:repeat(5,1fr);gap:12px" class="metrics">';
      kpi += '<div style="text-align:center"><div style="font-size:28px;font-weight:700;color:var(--accent)">' + totalLeads + '</div><div style="font-size:12px;color:var(--text2)">–í—Å–µ–≥–æ</div></div>';
      kpi += '<div style="text-align:center"><div style="font-size:28px;font-weight:700;color:var(--blue,#4babf7)">' + activeDeals + '</div><div style="font-size:12px;color:var(--text2)">–í —Ä–∞–±–æ—Ç–µ</div></div>';
      kpi += '<div style="text-align:center"><div style="font-size:28px;font-weight:700;color:var(--green,#4ecdc4)">' + wonDeals + '</div><div style="font-size:12px;color:var(--text2)">–ó–∞–∫—Ä—ã—Ç–æ</div></div>';
      kpi += '<div style="text-align:center"><div style="font-size:28px;font-weight:700;color:var(--yellow,#ffe66d)">' + convRate + '%</div><div style="font-size:12px;color:var(--text2)">–ö–æ–Ω–≤–µ—Ä—Å–∏—è</div></div>';
      kpi += '<div style="text-align:center"><div style="font-size:28px;font-weight:700;color:var(--purple,#a855f7)">' + (typeof fmtMoney === "function" ? fmtMoney(revenue) : revenue.toLocaleString('ru-RU') + ' \u20BD') + '</div><div style="font-size:12px;color:var(--text2)">–í—ã—Ä—É—á–∫–∞</div></div>';
      kpi += '</div>';
      if (overdueFollowups.length > 0) {
        kpi += '<div style="margin-top:16px;padding:12px;background:rgba(255,107,107,0.1);border-radius:10px;border:1px solid rgba(255,107,107,0.2)">';
        kpi += '<span style="color:var(--red,#ff6b6b);font-weight:600">‚ö†Ô∏è –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö follow-up: ' + overdueFollowups.length + '</span>';
        kpi += '</div>';
      }
      kpi += '</div>';
      var dashEl = document.getElementById('dashboardPage');
      if (dashEl) {
        var existing = dashEl.querySelector('.ceo-kpi-panel');
        if (existing) existing.remove();
        var div = document.createElement('div');
        div.className = 'ceo-kpi-panel';
        div.innerHTML = kpi;
        dashEl.prepend(div);
      }
    } catch(e) { console.warn('KPI render error:', e); }
  }
  
  // Filter data by user's scope
  let fp = filterByRole(DATA.partners);
  let ft = filterByRole(DATA.tasks);
  let fpr = filterByRole(DATA.projects);
  let fDirs = DATA.directions || [];
  
  // Non-CEO: filter by their direction/project
  if (!isCEO && USER && USER.direction && USER.direction !== '–í—Å–µ') {
    fp = fp.filter(x => (x['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'') === USER.direction || !x['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']);
    ft = ft.filter(x => (x['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'') === USER.direction || (x['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'') === USER.name);
    fpr = fpr.filter(x => (x['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'') === USER.direction);
    fDirs = fDirs.filter(x => {
      // Find if this direction belongs to user's project
      const projKey = Object.keys(PROJECTS).find(k => PROJECTS[k].name === USER.direction || getProjectDirs(k).includes(USER.direction));
      return projKey ? getProjectDirs(projKey).includes(x['–ù–∞–∑–≤–∞–Ω–∏–µ']) : true;
    });
  }
  // –ú–µ–Ω–µ–¥–∂–µ—Ä/–°–æ—Ç—Ä—É–¥–Ω–∏–∫: only their own tasks
  if (p.level <= 1 && USER) {
    ft = ft.filter(t => (t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'').includes(USER.name));
  }
  
  const td = today();
  const active = ft.filter(t => (t['–°—Ç–∞—Ç—É—Å']||'')!=='–ì–æ—Ç–æ–≤–æ');
  const overdue = active.filter(t => t['–î–µ–¥–ª–∞–π–Ω']&&t['–î–µ–¥–ª–∞–π–Ω']<td);

  // Dashboard title based on role
  const dashTitle = isCEO ? '–í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã' : (USER?.direction || '–ú–æ–∏ –∑–∞–¥–∞—á–∏');
  
  document.getElementById('dash-metrics').innerHTML =
    (isCEO ? '<div class="metric-card"><div class="m-icon">üè¢</div><div class="m-value">'+Object.keys(PROJECTS).length+'</div><div class="m-label">–ü—Ä–æ–µ–∫—Ç–æ–≤</div></div>' : '') +
    (p.level >= 3 ? '<div class="metric-card"><div class="m-icon">ü§ù</div><div class="m-value">'+fp.length+'</div><div class="m-label">–ü–∞—Ä—Ç–Ω—ë—Ä–æ–≤</div><div class="m-sub">'+fp.filter(x=>x['–°—Ç–∞—Ç—É—Å']==='–ê–∫—Ç–∏–≤–Ω—ã–π').length+' –∞–∫—Ç–∏–≤–Ω—ã—Ö</div></div>' : '') +
    '<div class="metric-card"><div class="m-icon">‚úÖ</div><div class="m-value">'+active.length+'</div><div class="m-label">'+(p.level<=1?'–ú–æ–∏ –∑–∞–¥–∞—á–∏':'–ó–∞–¥–∞—á –≤ —Ä–∞–±–æ—Ç–µ')+'</div><div class="m-sub">'+(overdue.length?'üî¥ '+overdue.length+' –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ':'–≤—Å—ë –≤ —Å—Ä–æ–∫')+'</div></div>'+
    '<div class="metric-card"><div class="m-icon">üìÅ</div><div class="m-value">'+fpr.length+'</div><div class="m-label">–ü–æ–¥–ø—Ä–æ–µ–∫—Ç–æ–≤</div></div>'+
    (p.canManageStaff ? '<div class="metric-card"><div class="m-icon">üë•</div><div class="m-value">'+DATA.staff.filter(s=>(s['–°—Ç–∞—Ç—É—Å']||'–ê–∫—Ç–∏–≤–Ω—ã–π')!=='–û–∂–∏–¥–∞–µ—Ç'&&s['–°—Ç–∞—Ç—É—Å']!=='‚ùå –£–¥–∞–ª—ë–Ω').length+'</div><div class="m-label">–ö–æ–º–∞–Ω–¥–∞</div></div>' : '');

  // Revenue chart ‚Äî CEO/–ó–∞–º only
  const rchEl = document.getElementById('dash-revenue-chart');
  if (rchEl) rchEl.innerHTML = (p.level >= 3) ? renderRevenueChart() : '';

  // Pipeline summary ‚Äî based on user's visible directions
  const sDirs = fDirs.filter(d => d['–ü—Ä–æ–µ–∫—Ç'] === '–°–∞–π—Ç—ã');
  const pEl = document.getElementById('dash-pipeline-summary');
  if (pEl && sDirs.length) {
    const tPipe = sDirs.filter(d=>(d['stage']||'prospect')!=='done').reduce((s,d)=>s+(Number(d['–¶–µ–Ω–∞'])||0),0);
    const tPaid = sDirs.filter(d=>d['–û–ø–ª–∞—á–µ–Ω–æ']).reduce((s,d)=>s+(Number(d['–¶–µ–Ω–∞'])||0),0);
    pEl.innerHTML = '<div class="card" style="padding:16px 20px"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><h4 style="font-size:14px;font-weight:600">üîÑ –í–æ—Ä–æ–Ω–∫–∞</h4><a onclick="showPage(\'kanban\')" style="font-size:12px;color:var(--accent);cursor:pointer">Kanban ‚Üí</a></div>' +
      '<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px">' + STAGES.map(s => {
        const cnt = sDirs.filter(d=>(d['stage']||'prospect')===s.id).length;
        return cnt ? '<span style="padding:3px 10px;border-radius:12px;background:var(--bg);font-size:11px;color:var(--text2)">'+s.name+' <b>'+cnt+'</b></span>' : '';
      }).join('') + '</div>' +
      '<div style="font-size:12px;color:var(--text2)">üí∞ –ü–æ–ª—É—á–µ–Ω–æ: <b style="color:var(--green)">'+tPaid.toLocaleString('ru')+'‚ÇΩ</b> ¬∑ –í —Ä–∞–±–æ—Ç–µ: <b style="color:var(--accent)">'+tPipe.toLocaleString('ru')+'‚ÇΩ</b></div></div>';
  } else if (pEl) { pEl.innerHTML = ''; }

  // MY EARNINGS ‚Äî show for all employees (FIX 12)
  const earningsEl = document.getElementById('dash-earnings');
  if (earningsEl && USER) {
    // Use individual salary_pct for current user
    const myStaff = (DATA.staff||[]).find(s => s['–ò–º—è'] === USER.name);
    const myPct = myStaff ? (parseInt(myStaff['–ü—Ä–æ—Ü–µ–Ω—Ç_–ó–ü']) || DEFAULT_SALARY_PCT[myStaff['–†–æ–ª—å']] || 0) : 0;
    const myDeals = (DATA.directions||[]).filter(d => d['–ü—Ä–æ–µ–∫—Ç']==='–°–∞–π—Ç—ã' && d['–û–ø–ª–∞—á–µ–Ω–æ'] && d['–ú–µ–Ω–µ–¥–∂–µ—Ä'] === USER.name);
    const myTotal = myDeals.reduce((s,d) => {
      const price = Number(d['–¶–µ–Ω–∞'])||0;
      return s + Math.round(price * myPct / 100);
    }, 0);
    const myPending = (DATA.directions||[]).filter(d => d['–ü—Ä–æ–µ–∫—Ç']==='–°–∞–π—Ç—ã' && !d['–û–ø–ª–∞—á–µ–Ω–æ'] && d['–ú–µ–Ω–µ–¥–∂–µ—Ä'] === USER.name);
    const pendingTotal = myPending.reduce((s,d) => {
      const price = Number(d['–¶–µ–Ω–∞'])||0;
      return s + Math.round(price * myPct / 100);
    }, 0);
    
    if (myDeals.length || myPending.length) {
      earningsEl.innerHTML = '<div class="card" style="padding:16px 20px"><h4 style="font-size:14px;font-weight:600;margin-bottom:10px">üí∞ –ú–æ–∏ –¥–æ—Ö–æ–¥—ã</h4>' +
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">' +
        '<div style="text-align:center;padding:12px;background:rgba(0,212,170,0.08);border-radius:8px"><div style="font-size:11px;color:var(--text2)">‚úÖ –ü–æ–ª—É—á–µ–Ω–æ</div><div style="font-size:22px;font-weight:700;color:var(--green)">'+myTotal.toLocaleString('ru')+'‚ÇΩ</div><div style="font-size:11px;color:var(--text3)">'+myDeals.length+' —Å–¥–µ–ª–æ–∫</div></div>' +
        '<div style="text-align:center;padding:12px;background:rgba(255,170,0,0.08);border-radius:8px"><div style="font-size:11px;color:var(--text2)">‚è≥ –û–∂–∏–¥–∞–µ—Ç—Å—è</div><div style="font-size:22px;font-weight:700;color:var(--orange)">'+pendingTotal.toLocaleString('ru')+'‚ÇΩ</div><div style="font-size:11px;color:var(--text3)">'+myPending.length+' –≤ —Ä–∞–±–æ—Ç–µ</div></div>' +
        '</div></div>';
    } else {
      earningsEl.innerHTML = '';
    }
  }

  // Overdue table
  document.getElementById('dash-overdue').innerHTML = overdue.length ? overdue.map(t =>
    '<tr style="background:rgba(255,107,107,0.03)"><td>'+esc(t['–û–ø–∏—Å–∞–Ω–∏–µ']||t['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</td><td>'+esc(t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'])+'</td><td>'+prBadge(t['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç'])+'</td><td style="color:var(--red);font-weight:700">'+esc(t['–î–µ–¥–ª–∞–π–Ω'])+'</td><td>'+esc(t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'‚Äî')+'</td><td>'+actBtns('task',t.ID,t['–û–ø–∏—Å–∞–Ω–∏–µ'])+'</td></tr>'
  ).join('') : emptyRow(6,'–ù–µ—Ç –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á üéâ');

  // Active projects
  const ap = fpr.filter(p => (p['–°—Ç–∞—Ç—É—Å']||'')!=='–ó–∞–≤–µ—Ä—à—ë–Ω').slice(0,10);
  document.getElementById('dash-projects').innerHTML = ap.length ? ap.map(p =>
    '<tr><td><strong>'+esc(p['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</strong></td><td>'+esc(p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'])+'</td><td>'+statusBadge(p['–°—Ç–∞—Ç—É—Å'])+'</td><td>'+progBar(p['–ü—Ä–æ–≥—Ä–µ—Å—Å'])+'</td><td>'+esc(p['–î–µ–¥–ª–∞–π–Ω']||'‚Äî')+'</td></tr>'
  ).join('') : emptyRow(5,'–ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤');

  // Recent comms
  const rc = (DATA.comms||[]).slice(0,5);
  document.getElementById('dash-comms').innerHTML = rc.length ? rc.map(c =>
    '<tr><td>'+esc(c['–ü–∞—Ä—Ç–Ω—ë—Ä'])+'</td><td>'+esc(c['–¢–∏–ø'])+'</td><td>'+esc(c['–¢–µ–º–∞'])+'</td><td>'+esc(c['–î–∞—Ç–∞']||'‚Äî')+'</td><td>'+esc(c['–ê–≤—Ç–æ—Ä']||'‚Äî')+'</td></tr>'
  ).join('') : emptyRow(5,'–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π');
}

// ============================================================
// RENDER: GLOBAL PAGES (Partners, Tasks, Staff, Approvals, Comms, Settings)
// ============================================================
function renderPartnerFilters() {
  const allDirs = ['–í—Å–µ', ...new Set(DATA.partners.map(i=>i['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']).filter(Boolean))];
  const el = document.getElementById('partner-filters');
  if(el) el.innerHTML = allDirs.map(d => '<button class="filter-chip '+(currentFilters.partners===d?'active':'')+'" onclick="currentFilters.partners=\''+escA(d)+'\';renderAll()">'+esc(d)+'</button>').join('');
}

function renderTaskFilters() {
  const allDirs = ['–í—Å–µ', ...new Set(DATA.tasks.map(i=>i['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']).filter(Boolean))];
  const el = document.getElementById('task-filters');
  if(el) el.innerHTML = allDirs.map(d => '<button class="filter-chip '+(currentFilters.tasks===d?'active':'')+'" onclick="currentFilters.tasks=\''+escA(d)+'\';renderTasks()">'+esc(d)+'</button>').join('');
  
  // Populate person dropdown
  const personEl = document.getElementById('task-filter-person');
  if (personEl) {
    const people = ['–í—Å–µ', ...new Set(DATA.tasks.map(t=>t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']).filter(Boolean))];
    const current = personEl.value;
    personEl.innerHTML = people.map(p => '<option value="'+esc(p)+'"'+(p===current?' selected':'')+'>'+esc(p==='–í—Å–µ'?'üë§ –í—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏':p)+'</option>').join('');
  }
}

function renderPartners() {
  let d = filterByRole(DATA.partners);
  d = filterByDir(d, currentFilters.partners==='–í—Å–µ'?null:currentFilters.partners);
  d = filterBySearch(d,'partner-search',['–ù–∞–∑–≤–∞–Ω–∏–µ','–°—Ç—Ä–∞–Ω–∞','–ü—Ä–æ–¥—É–∫—Ç','–ö–æ–Ω—Ç–∞–∫—Ç']);
  document.getElementById('partners-table').innerHTML = d.length ? d.map(p =>
    '<tr><td><strong>'+esc(p['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</strong></td><td>'+esc(p['–°—Ç—Ä–∞–Ω–∞'])+'</td><td>'+esc(p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'])+'</td><td>'+esc(p['–ü—Ä–æ–¥—É–∫—Ç']||'')+'</td><td>'+statusBadge(p['–°—Ç–∞—Ç—É—Å'])+'</td><td>'+esc(p['–ö–æ–Ω—Ç–∞–∫—Ç']||'')+'</td><td>'+actBtns('partner',p.ID,p['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</td></tr>'
  ).join('') : emptyRow(7,'–ù–µ—Ç –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤');
}

function renderTasks() {
  renderTaskFilters();
  let d = filterByRole(DATA.tasks);
  d = filterByDir(d, currentFilters.tasks==='–í—Å–µ'?null:currentFilters.tasks);
  d = filterBySearch(d,'task-search',['–û–ø–∏—Å–∞–Ω–∏–µ','–ù–∞–∑–≤–∞–Ω–∏–µ','–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π','–ü—Ä–æ–µ–∫—Ç']);
  
  // Status filter
  const statusFilter = document.getElementById('task-filter-status')?.value || 'active';
  if (statusFilter === 'active') d = d.filter(t => (t['–°—Ç–∞—Ç—É—Å']||'') !== '‚úÖ –ì–æ—Ç–æ–≤–æ' && (t['–°—Ç–∞—Ç—É—Å']||'') !== '–ì–æ—Ç–æ–≤–æ');
  else if (statusFilter !== '–í—Å–µ') d = d.filter(t => (t['–°—Ç–∞—Ç—É—Å']||'').includes(statusFilter.replace(/[^–∞-—è–ê-–Ø\s]/g,'').trim()));
  
  // Person filter
  const personFilter = document.getElementById('task-filter-person')?.value || '–í—Å–µ';
  if (personFilter !== '–í—Å–µ') d = d.filter(t => (t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'') === personFilter);
  
  const pO = {P1:1,P2:2,P3:3};
  d = [...d].sort((a,b)=>(pO[a['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']]||9)-(pO[b['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']]||9));
  const td = today();
  
  document.getElementById('tasks-table').innerHTML = d.length ? d.map(t => {
    const od = t['–î–µ–¥–ª–∞–π–Ω']&&t['–î–µ–¥–ª–∞–π–Ω']<td&&(t['–°—Ç–∞—Ç—É—Å']||'')!=='–ì–æ—Ç–æ–≤–æ'&&(t['–°—Ç–∞—Ç—É—Å']||'')!=='‚úÖ –ì–æ—Ç–æ–≤–æ';
    return '<tr style="'+(od?'background:rgba(255,107,107,0.05)':'')+'"><td>'+(od?'üî¥ ':'')+esc(t['–û–ø–∏—Å–∞–Ω–∏–µ']||t['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</td><td>'+esc(t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'])+'</td><td>'+prBadge(t['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç'])+'</td><td>'+statusBadge(t['–°—Ç–∞—Ç—É—Å'])+'</td><td>'+esc(t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'‚Äî')+'</td><td>'+(od?'<span style="color:var(--red);font-weight:700">':'')+esc(t['–î–µ–¥–ª–∞–π–Ω']||'‚Äî')+(od?'</span>':'')+'</td><td>'+actBtns('task',t.ID,t['–û–ø–∏—Å–∞–Ω–∏–µ']||t['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</td></tr>';
  }).join('') : emptyRow(7,'–ù–µ—Ç –∑–∞–¥–∞—á');
  
  // Gantt chart
  const ganttEl = document.getElementById('task-gantt');
  if (ganttEl) {
    const showGantt = document.getElementById('task-show-gantt')?.checked;
    ganttEl.innerHTML = showGantt ? renderTimeline(d) : '';
  }
}

// ============================================================
// TIMELINE / GANTT CHART
// ============================================================
function renderTimeline(tasks, directions) {
  // GANTT CHART: rows = clients/directions, columns = days, bars = tasks
  const p = getUserPerms();
  const userName = USER ? (USER.name || USER['–ò–º—è'] || '') : '';
  const allDirs = (directions || DATA.directions || []).filter(d => d['–ü—Ä–æ–µ–∫—Ç'] === '–°–∞–π—Ç—ã');
  const allTasks = (tasks || DATA.tasks || []).filter(t => t['–ü—Ä–æ–µ–∫—Ç'] === '–°–∞–π—Ç—ã');

  if (!allTasks.length && !allDirs.length) {
    return '<div class="card" style="padding:20px;text-align:center;color:var(--text2)"><div style="font-size:32px;margin-bottom:8px">üìÖ</div>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è Gantt-–≥—Ä–∞—Ñ–∏–∫–∞</div>';
  }

  // Filter by role: CEO/–ó–∞–º see all, others see only their tasks
  let visibleDirs = allDirs;
  if (!p.seeAll && p.level < 3 && userName) {
    const myDirNames = new Set();
    allTasks.forEach(t => {
      if ((t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'').includes(userName)) myDirNames.add(t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'');
    });
    visibleDirs = allDirs.filter(d => myDirNames.has(d['–ù–∞–∑–≤–∞–Ω–∏–µ']||''));
  }

  // Exclude done/lost if not many
  const activeDirs = visibleDirs.filter(d => !['done','lost'].includes(d['stage']||'prospect'));
  const displayDirs = activeDirs.length > 0 ? activeDirs : visibleDirs;

  if (!displayDirs.length) {
    return '<div class="card" style="padding:20px;text-align:center;color:var(--text2)"><div style="font-size:32px;margin-bottom:8px">üìÖ</div>–ù–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è' +
      (p.level < 3 ? '<br><span style="font-size:12px">–ü–æ–∫–∞–∑–∞–Ω—ã —Ç–æ–ª—å–∫–æ –∫–ª–∏–µ–Ω—Ç—ã —Å –≤–∞—à–∏–º–∏ –∑–∞–¥–∞—á–∞–º–∏</span>' : '') + '</div>';
  }

  const td = today();
  const tdDate = new Date(td);
  // Date range: 7 days before today ‚Üí 30 days after
  const rangeStart = new Date(tdDate); rangeStart.setDate(rangeStart.getDate() - 7);
  const rangeEnd = new Date(tdDate); rangeEnd.setDate(rangeEnd.getDate() + 35);
  const totalDays = Math.ceil((rangeEnd - rangeStart) / 86400000);

  // Generate day columns
  const days = [];
  for (let dd = new Date(rangeStart); dd <= rangeEnd; dd.setDate(dd.getDate() + 1)) {
    days.push(new Date(dd));
  }

  // Week markers
  const weeks = [];
  const monthNames = ['–Ø–Ω–≤','–§–µ–≤','–ú–∞—Ä','–ê–ø—Ä','–ú–∞–π','–ò—é–Ω','–ò—é–ª','–ê–≤–≥','–°–µ–Ω','–û–∫—Ç','–ù–æ—è','–î–µ–∫'];
  days.forEach((dd, i) => {
    if (dd.getDay() === 1 || i === 0) {
      weeks.push({ idx: i, label: dd.getDate() + ' ' + monthNames[dd.getMonth()] });
    }
  });

  const todayIdx = days.findIndex(dd => dd.toISOString().slice(0,10) === td);
  const cellW = 28;
  const labelW = 180;
  const gridW = days.length * cellW;

  const statusColors = {
    '–ì–æ—Ç–æ–≤–æ': '#00d4aa', '‚úÖ –ì–æ—Ç–æ–≤–æ': '#00d4aa',
    '–í —Ä–∞–±–æ—Ç–µ': '#4dabf7', 'üîÑ –í —Ä–∞–±–æ—Ç–µ': '#4dabf7',
    '–ù–æ–≤–∞—è': '#ffa94d', '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–∞': '#ff6b6b'
  };

  let h = '<div class="card"><div class="card-header" style="display:flex;justify-content:space-between;align-items:center"><h3>üìÖ Gantt-–≥—Ä–∞—Ñ–∏–∫</h3>';
  h += '<div style="display:flex;gap:8px;font-size:11px">';
  h += '<span style="color:#00d4aa">‚óè –ì–æ—Ç–æ–≤–æ</span>';
  h += '<span style="color:#4dabf7">‚óè –í —Ä–∞–±–æ—Ç–µ</span>';
  h += '<span style="color:#ffa94d">‚óè –ù–æ–≤–∞—è</span>';
  h += '<span style="color:#ff6b6b">‚óè –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–∞</span>';
  h += '</div></div>';
  h += '<div style="overflow-x:auto;-webkit-overflow-scrolling:touch;padding:0 0 12px">';
  h += '<div style="display:grid;grid-template-columns:' + labelW + 'px ' + gridW + 'px;min-width:' + (labelW + gridW) + 'px">';

  // Header: week labels
  h += '<div style="border-bottom:2px solid var(--border);padding:4px 8px;font-size:11px;font-weight:700;color:var(--text2);position:sticky;left:0;background:var(--bg2);z-index:2">–ö–ª–∏–µ–Ω—Ç</div>';
  h += '<div style="position:relative;height:28px;border-bottom:2px solid var(--border)">';
  weeks.forEach(w => {
    h += '<span style="position:absolute;left:' + (w.idx * cellW) + 'px;font-size:10px;color:var(--text3);white-space:nowrap;padding:4px 2px">' + w.label + '</span>';
  });
  // Today marker in header
  if (todayIdx >= 0) {
    h += '<div style="position:absolute;left:' + (todayIdx * cellW + cellW/2) + 'px;top:0;bottom:0;width:2px;background:var(--accent);z-index:3"></div>';
  }
  h += '</div>';

  // Rows: one per direction
  displayDirs.forEach(dir => {
    const dirName = dir['–ù–∞–∑–≤–∞–Ω–∏–µ'] || '';
    const dirTasks = allTasks.filter(t => (t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'') === dirName);
    const stageName = STAGES.find(s => s.id === (dir['stage']||'prospect'))?.name || '';

    // Row label
    h += '<div style="padding:6px 8px;border-bottom:1px solid var(--border);font-size:12px;position:sticky;left:0;background:var(--bg2);z-index:2;cursor:pointer;display:flex;flex-direction:column;justify-content:center" onclick="openSlideOver(\'' + escA(dir['ID']||dir.id||'') + '\')" title="' + esc(dirName) + '">';
    h += '<div style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:' + (labelW - 16) + 'px">' + esc(dirName) + '</div>';
    h += '<div style="font-size:10px;color:var(--text3)">' + esc(stageName) + '</div>';
    h += '</div>';

    // Gantt bars area
    h += '<div style="position:relative;height:' + Math.max(32, dirTasks.length * 20 + 8) + 'px;border-bottom:1px solid var(--border)">';
    // Weekend background
    days.forEach((dd, i) => {
      if (dd.getDay() === 0 || dd.getDay() === 6) {
        h += '<div style="position:absolute;left:' + (i * cellW) + 'px;top:0;bottom:0;width:' + cellW + 'px;background:rgba(255,255,255,.02)"></div>';
      }
    });
    // Today marker
    if (todayIdx >= 0) {
      h += '<div style="position:absolute;left:' + (todayIdx * cellW + cellW/2) + 'px;top:0;bottom:0;width:2px;background:var(--accent);opacity:.3;z-index:1"></div>';
    }
    // Task bars
    dirTasks.forEach((t, ti) => {
      const dl = t['–î–µ–¥–ª–∞–π–Ω'] ? new Date(t['–î–µ–¥–ª–∞–π–Ω']) : null;
      const cr = t['–°–æ–∑–¥–∞–Ω–æ'] ? new Date(t['–°–æ–∑–¥–∞–Ω–æ']) : (dl ? new Date(dl.getTime() - 7*86400000) : null);
      if (!dl && !cr) return;
      const barStart = cr || new Date(dl.getTime() - 7*86400000);
      const barEnd = dl || new Date(cr.getTime() + 7*86400000);
      const startIdx = Math.max(0, Math.floor((barStart - rangeStart) / 86400000));
      const endIdx = Math.min(totalDays, Math.ceil((barEnd - rangeStart) / 86400000));
      if (endIdx <= 0 || startIdx >= totalDays) return;
      const left = startIdx * cellW;
      const width = Math.max(cellW, (endIdx - startIdx) * cellW);
      const st = t['–°—Ç–∞—Ç—É—Å'] || '';
      const isDone = st.includes('–ì–æ—Ç–æ–≤–æ');
      const isOverdue = dl && dl.toISOString().slice(0,10) < td && !isDone;
      const color = isOverdue ? '#ff6b6b' : (statusColors[st] || '#ffa94d');
      const y = ti * 20 + 4;

      h += '<div style="position:absolute;left:' + left + 'px;top:' + y + 'px;width:' + width + 'px;height:16px;background:' + color + '33;border:1px solid ' + color + '88;border-radius:3px;cursor:pointer;display:flex;align-items:center;padding:0 4px;overflow:hidden;z-index:2" title="' + esc(t['–û–ø–∏—Å–∞–Ω–∏–µ']||'') + (t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']?' ¬∑ üë§'+esc(t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']):'') + '" onclick="openTaskDetail(\'' + escA(t.ID||t.id||'') + '\')">';
      h += '<span style="font-size:8px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">' + (isDone?'‚úÖ ':isOverdue?'üî¥ ':'') + esc((t['–û–ø–∏—Å–∞–Ω–∏–µ']||'').slice(0,30)) + '</span>';
      h += '</div>';
    });
    h += '</div>';
  });

  h += '</div></div></div>';
  return h;
}


let staffProjectFilter = '–í—Å–µ';
let staffDirFilter = '–í—Å–µ';

function renderStaffTabs() {
  // Project tabs
  const projects = ['–í—Å–µ', '–†–ö–¢', '–°–∞–π—Ç—ã'];
  const projDirs = {};
  (DATA.directions || []).forEach(d => {
    const p = d['–ü—Ä–æ–µ–∫—Ç'] || '';
    if (p && !projects.includes(p)) projects.push(p);
    (projDirs[p] = projDirs[p] || []).push(d['–ù–∞–∑–≤–∞–Ω–∏–µ'] || '');
  });
  
  const tabsEl = document.getElementById('staff-project-tabs');
  if (tabsEl) {
    tabsEl.innerHTML = projects.map(p => {
      const emoji = p==='–í—Å–µ'?'üè†':p==='–†–ö–¢'?'üè•':p==='–°–∞–π—Ç—ã'?'üåê':'üìÇ';
      const count = getStaffForProject(p).length;
      return '<div class="tab'+(staffProjectFilter===p?' active':'')+'" onclick="filterStaffProject(\''+escA(p)+'\')">'+emoji+' '+esc(p)+' <span style="opacity:.5;font-size:11px">('+count+')</span></div>';
    }).join('');
  }
  
  // Direction tabs (only when specific project selected)
  const dirEl = document.getElementById('staff-direction-tabs');
  if (dirEl) {
    if (staffProjectFilter === '–í—Å–µ') {
      dirEl.innerHTML = '';
    } else {
      const dirs = ['–í—Å–µ', ...(projDirs[staffProjectFilter] || [])];
      dirEl.innerHTML = '<div class="tabs">' + dirs.map(d => {
        const count = d === '–í—Å–µ' ? getStaffForProject(staffProjectFilter).length : 
          DATA.staff.filter(s => (s['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'')=== d || (d==='–í—Å–µ' && (s['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'')==='–í—Å–µ')).length;
        return '<div class="tab tab-sm'+(staffDirFilter===d?' active':'')+'" onclick="filterStaffDir(\''+escA(d)+'\')">'+esc(d)+' <span style="opacity:.5">('+count+')</span></div>';
      }).join('') + '</div>';
    }
  }
}

function filterStaffProject(proj) {
  staffProjectFilter = proj;
  staffDirFilter = '–í—Å–µ';
  renderStaff();
}
function filterStaffDir(dir) {
  staffDirFilter = dir;
  renderStaff();
}

function getStaffForProject(proj) {
  if (proj === '–í—Å–µ') return DATA.staff;
  const projDirs = (DATA.directions || []).filter(d => (d['–ü—Ä–æ–µ–∫—Ç']||'') === proj).map(d => d['–ù–∞–∑–≤–∞–Ω–∏–µ']||'');
  return DATA.staff.filter(s => {
    const dir = s['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] || '';
    const role = s['–†–æ–ª—å'] || '';
    const staffProj = s['–ü—Ä–æ–µ–∫—Ç'] || '';
    if (role === 'CEO') return true;
    if (staffProj === '–í—Å–µ') return true;
    if (staffProj === proj) return true;
    if (projDirs.includes(dir)) return true;
    // Check extra_projects
    try {
      const extra = JSON.parse(s['–î–æ–ø_–ø—Ä–æ–µ–∫—Ç—ã'] || '[]');
      if (Array.isArray(extra) && extra.includes(proj)) return true;
    } catch(e) {}
    return false;
  });
}

function renderStaff() {
  renderStaffTabs();
  
  const p = getUserPerms();
  let staff = getStaffForProject(staffProjectFilter);
  
  // FIX 6: Non-CEO users only see staff in their project/direction
  if (!p.seeAll && USER && USER.direction && USER.direction !== '–í—Å–µ') {
    const userProjKey = Object.keys(PROJECTS).find(k => getProjectDirs(k).includes(USER.direction) || PROJECTS[k].name === USER.direction);
    if (userProjKey) {
      const myDirs = getProjectDirs(userProjKey);
      staff = staff.filter(s => {
        const sd = s['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'';
        const sp = s['–ü—Ä–æ–µ–∫—Ç']||'';
        return sd === USER.direction || myDirs.includes(sd) || sp === PROJECTS[userProjKey]?.name || sd === '–í—Å–µ' || s['–†–æ–ª—å'] === 'CEO';
      });
    }
  }
  
  // Direction filter
  if (staffDirFilter !== '–í—Å–µ') {
    staff = staff.filter(s => {
      const d = s['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'';
      const role = s['–†–æ–ª—å']||'';
      return d === staffDirFilter || role === 'CEO' || role === '–ó–∞–º' || d === '–í—Å–µ';
    });
  }
  
  // Search
  const q = (document.getElementById('staff-search')?.value||'').toLowerCase().trim();
  if (q) staff = staff.filter(s => 
    (s['–ò–º—è']||'').toLowerCase().includes(q) || (s['–†–æ–ª—å']||'').toLowerCase().includes(q) ||
    (s['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'').toLowerCase().includes(q) || (s['Email']||'').toLowerCase().includes(q));
  
  // Stats
  const roles = {};
  staff.forEach(s => { const r=s['–†–æ–ª—å']||'–î—Ä—É–≥–æ–µ'; roles[r]=(roles[r]||0)+1; });
  const statsEl = document.getElementById('staff-stats');
  if (statsEl) {
    statsEl.innerHTML = '<div style="display:flex;flex-wrap:wrap;gap:6px">' +
      Object.entries(roles).map(([r,c]) => '<span style="padding:3px 10px;background:var(--bg3);border-radius:20px;font-size:11px;color:var(--text2)">' + 
        ({CEO:'üëë',–ó–∞–º:'‚≠ê',–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å:'üìã'}[r]||'üë§') + ' ' + esc(r) + ': <b style="color:var(--text)">' + c + '</b></span>').join('') +
      '<span style="padding:3px 10px;background:var(--accent-glow);border-radius:20px;font-size:11px;color:var(--accent);font-weight:600">–í—Å–µ–≥–æ: ' + staff.length + '</span></div>';
  }
  
  // Pending registrations (CEO only)
  const pendingEl = document.getElementById('staff-pending');
  if (pendingEl && p.canManageStaff) {
    const pending = DATA.staff.filter(s => (s['–°—Ç–∞—Ç—É—Å']||'')==='–û–∂–∏–¥–∞–µ—Ç');
    if (pending.length) {
      let ph = '<div class="card" style="border-color:rgba(255,169,77,.4)"><div class="card-header" style="background:rgba(255,169,77,.05)"><h3>‚è≥ –û–∂–∏–¥–∞—é—Ç –æ–¥–æ–±—Ä–µ–Ω–∏—è ('+pending.length+')</h3></div><div style="padding:12px;display:flex;flex-wrap:wrap;gap:10px">';
      pending.forEach(s => {
        ph += '<div style="background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:12px;min-width:200px">';
        ph += '<div style="font-weight:700">'+esc(s['–ò–º—è']||'‚Äî')+'</div>';
        ph += '<div style="font-size:11px;color:var(--text2)">'+esc(s['–†–æ–ª—å']||'')+ ' ¬∑ '+esc(s['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'')+'</div>';
        if(s['Telegram_ID']) ph += '<div style="font-size:11px;color:var(--text3)">TG: '+esc(String(s['Telegram_ID']))+'</div>';
        if(s['Username']) ph += '<div style="font-size:11px;color:var(--text3)">@'+esc(String(s['Username']).replace('@',''))+'</div>';
        if(s['–¢–µ–ª–µ—Ñ–æ–Ω']) ph += '<div style="font-size:11px;color:var(--text3)">üìû '+esc(s['–¢–µ–ª–µ—Ñ–æ–Ω'])+'</div>';
        ph += '<div style="display:flex;gap:6px;margin-top:8px">';
        ph += '<button class="btn btn-sm btn-primary" onclick="approveStaff(\''+escA(s.ID)+'\')">‚úÖ –ü—Ä–∏–Ω—è—Ç—å</button>';
        ph += '<button class="btn btn-sm btn-danger" onclick="rejectStaff(\''+escA(s.ID)+'\')">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>';
        ph += '</div></div>';
      });
      ph += '</div></div>';
      pendingEl.innerHTML = ph;
    } else { pendingEl.innerHTML = ''; }
  }
  
  // Sort: CEO ‚Üí –ó–∞–º ‚Üí –†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å ‚Üí rest
  const roleOrder = {'CEO':0,'–ó–∞–º':1,'–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å':2,'–ú–µ–Ω–µ–¥–∂–µ—Ä':3,'–ò–Ω–∂–µ–Ω–µ—Ä':4};
  staff = [...staff].filter(s=>(s['–°—Ç–∞—Ç—É—Å']||'–ê–∫—Ç–∏–≤–Ω—ã–π')!=='–û–∂–∏–¥–∞–µ—Ç').sort((a,b)=>(roleOrder[a['–†–æ–ª—å']]??9)-(roleOrder[b['–†–æ–ª—å']]??9));
  
  const roleColors = { CEO:'linear-gradient(135deg,#00d4aa,#4dabf7)','–ó–∞–º':'linear-gradient(135deg,#b197fc,#7950f2)',
    '–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å':'linear-gradient(135deg,#ffa94d,#fd7e14)','–ú–µ–Ω–µ–¥–∂–µ—Ä':'linear-gradient(135deg,#4dabf7,#228be6)' };
  
  let h = '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px">';
  if (staff.length) {
    staff.forEach(s => {
      const bg = roleColors[s['–†–æ–ª—å']] || 'linear-gradient(135deg,var(--text3),var(--text2))';
      const initial = (s['–ò–º—è']||'?').charAt(0).toUpperCase();
      const dir = s['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] || '–í—Å–µ';
      const role = s['–†–æ–ª—å'] || '';
      const taskCount = DATA.tasks.filter(t => (t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'').includes(s['–ò–º—è']||'___') && (t['–°—Ç–∞—Ç—É—Å']||'')!=='–ì–æ—Ç–æ–≤–æ').length;
      
      h += '<div style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:16px;transition:all .2s">';
      h += '<div style="display:flex;align-items:center;gap:12px;margin-bottom:10px">';
      h += '<div style="width:44px;height:44px;border-radius:50%;background:'+bg+';display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700;color:var(--bg);flex-shrink:0">'+esc(initial)+'</div>';
      h += '<div><div style="font-weight:700;font-size:14px">'+esc(s['–ò–º—è']||'‚Äî')+'</div>';
      h += '<div style="font-size:11px;color:var(--text2)">'+({CEO:'üëë',–ó–∞–º:'‚≠ê',–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å:'üìã'}[role]||'üë§')+' '+esc(role)+'</div></div>';
      h += '</div>';
      
      // Badges
      h += '<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px">';
      if (role==='–ó–∞–º') h += '<span style="padding:2px 8px;background:var(--purple-glow);color:var(--purple);border-radius:12px;font-size:10px;font-weight:600">–í–µ—Å—å –ø—Ä–æ–µ–∫—Ç</span>';
      else h += '<span style="padding:2px 8px;background:var(--blue-glow);color:var(--blue);border-radius:12px;font-size:10px;font-weight:600">üìÇ '+esc(dir)+'</span>';
      if (taskCount) h += '<span style="padding:2px 8px;background:var(--orange-glow);color:var(--orange);border-radius:12px;font-size:10px;font-weight:600">üìã '+taskCount+' –∑–∞–¥–∞—á</span>';
      h += '</div>';
      
      h += '<div style="display:flex;flex-direction:column;gap:3px;font-size:11px;color:var(--text3)">';
      if(s['Username']) h += '<span>üí¨ @'+esc(String(s['Username']).replace('@',''))+'</span>';
      if(s['–¢–µ–ª–µ—Ñ–æ–Ω']) h += '<span>üìû '+esc(s['–¢–µ–ª–µ—Ñ–æ–Ω'])+'</span>';
      if(s['Email']) h += '<span>‚úâÔ∏è '+esc(s['Email'])+'</span>';
      if(s['Telegram_ID']) h += '<span style="opacity:0.6">ID: '+esc(String(s['Telegram_ID']))+'</span>';
      h += '</div>';
      
      if(p.canManageStaff) {
        h += '<div style="display:flex;gap:6px;margin-top:10px;padding-top:10px;border-top:1px solid var(--border);flex-wrap:wrap">';
        h += '<button class="btn btn-sm btn-secondary" onclick="editItem(\'staff\',\''+escA(s.ID)+'\')">‚úèÔ∏è</button>';
        h += s['pin_hash'] ? '<button class="btn btn-sm btn-secondary" onclick="resetStaffPassword(\''+escA(s.ID)+'\',\''+escA(s['–ò–º—è'])+'\')">üîì –°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è</button>' 
                           : '<span style="font-size:10px;color:var(--orange);padding:4px 8px">‚ö†Ô∏è –ù–µ—Ç –ø–∞—Ä–æ–ª—è</span>';
        h += '<button class="btn btn-sm btn-danger" onclick="confirmDelete(\'staff\',\''+escA(s.ID)+'\',\''+escA(s['–ò–º—è'])+'\')">üóë</button>';
        h += '</div>';
      }
      h += '</div>';
    });
  } else {
    h += '<div class="empty" style="grid-column:1/-1"><div class="icon">üë•</div><p>–ù–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤'+(staffProjectFilter!=='–í—Å–µ'?' –≤ ¬´'+esc(staffProjectFilter)+'¬ª':'')+'</p></div>';
  }
  h += '</div>';
  document.getElementById('staff-content').innerHTML = h;
}

async function resetStaffPassword(staffId, staffName) {
  if (!confirm('–°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å –¥–ª—è '+staffName+'?\n–ù–æ–≤—ã–π –≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø–∞—Ä–æ–ª—å –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω –Ω–∞ —ç–∫—Ä–∞–Ω–µ.')) return;
  try {
    const tempPass = Math.random().toString(36).slice(2,8).toUpperCase();
    const hash = await hashPassword(tempPass);
    await SB.from('staff').update({ pin_hash: hash }).eq('id', staffId);
    const cached = _staffCache.find(s => (s.ID||s.id) === staffId);
    if (cached) cached['pin_hash'] = hash;
    const inData = (DATA.staff||[]).find(s => (s.ID||s.id) === staffId);
    if (inData) inData['pin_hash'] = hash;
    
    // Try send via TG
    const staff = cached || inData;
    const tgId = staff?.Telegram_ID || staff?.['Telegram_ID'];
    if (tgId && CONFIG.TG_BOT_TOKEN) {
      try {
        await fetch('https://api.telegram.org/bot'+CONFIG.TG_BOT_TOKEN+'/sendMessage', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ chat_id: tgId, text: 'üîë –í–∞—à –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–ª—è RKT HUB: '+tempPass })
        });
        toast('‚úÖ –ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram –¥–ª—è '+staffName, 'success');
      } catch(e) {
        alert('–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–ª—è '+staffName+': '+tempPass+'\n\n(Telegram –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî –ø–µ—Ä–µ–¥–∞–π—Ç–µ –ª–∏—á–Ω–æ)');
      }
    } else {
      alert('–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–ª—è '+staffName+': '+tempPass+'\n\n–°–æ–æ–±—â–∏—Ç–µ –µ–º—É –ª–∏—á–Ω–æ.');
    }
    renderStaff();
  } catch(e) {
    toast('‚ùå –û—à–∏–±–∫–∞: '+e.message, 'error');
  }
}

// ---- PASSWORD CHANGE WITH TELEGRAM CODE CONFIRMATION ----
let _pwdChangeState = {};

async function changeMyPassword() {
  if (!USER) return;
  const staff = _staffCache.find(s => (s.ID||s.id) === USER.id);
  if (!staff) { toast('‚ùå –ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω','error'); return; }
  
  const tgId = staff.Telegram_ID || staff.telegram_id || '';
  if (!tgId) {
    toast('‚ùå Telegram –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω. –ü—Ä–∏–≤—è–∂–∏—Ç–µ —á–µ—Ä–µ–∑ –±–æ—Ç–∞ @' + (CONFIG.TG_BOT||'AIhroject_bot'), 'error');
    return;
  }
  
  _pwdChangeState = { staffId: USER.id, tgId, step: 1 };
  
  // Show password change modal
  let overlay = document.getElementById('pwdChangeOverlay');
  if (overlay) overlay.remove();
  
  overlay = document.createElement('div');
  overlay.id = 'pwdChangeOverlay';
  overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:10000;display:flex;align-items:center;justify-content:center;animation:fadeIn .2s';
  overlay.innerHTML = `
    <div style="background:var(--bg2);border-radius:16px;padding:28px;width:380px;max-width:90vw;box-shadow:0 8px 32px rgba(0,0,0,.4)">
      <div style="text-align:center;margin-bottom:18px">
        <div style="font-size:36px;margin-bottom:8px">üîê</div>
        <div style="font-size:16px;font-weight:700;color:var(--text)">–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è</div>
      </div>
      <div id="pwdStep1">
        <input class="login-input" id="pwdNew" type="password" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (–º–∏–Ω. 4 —Å–∏–º–≤–æ–ª–∞)" style="margin-bottom:10px">
        <input class="login-input" id="pwdNew2" type="password" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å" onkeydown="if(event.key==='Enter')pwdSendCode()">
        <button class="login-btn" style="margin-top:12px;width:100%" onclick="pwdSendCode()">
          <span id="pwdSendBtnText">üì± –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –≤ Telegram</span>
        </button>
      </div>
      <div id="pwdStep2" style="display:none">
        <div style="text-align:center;font-size:13px;color:var(--text2);margin-bottom:14px;line-height:1.5">
          üì± –ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤<br><b>Telegram</b>. –í–≤–µ–¥–∏—Ç–µ –µ–≥–æ –Ω–∏–∂–µ:
        </div>
        <input class="login-input" id="pwdCode" type="text" placeholder="6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥" style="text-align:center;font-size:20px;letter-spacing:8px" maxlength="6" onkeydown="if(event.key==='Enter')pwdVerifyCode()">
        <button class="login-btn" style="margin-top:12px;width:100%" onclick="pwdVerifyCode()">
          <span id="pwdVerifyBtnText">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</span>
        </button>
        <div style="text-align:center;margin-top:10px">
          <a href="#" onclick="pwdSendCode();return false" style="color:var(--accent);font-size:12px">üîÑ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –∑–∞–Ω–æ–≤–æ</a>
        </div>
      </div>
      <div class="login-error" id="pwdError"></div>
      <div style="text-align:center;margin-top:14px">
        <a href="#" onclick="closePwdChange();return false" style="color:var(--text3);font-size:12px">‚Üê –û—Ç–º–µ–Ω–∞</a>
      </div>
    </div>`;
  document.body.appendChild(overlay);
  overlay.onclick = (e) => { if (e.target === overlay) closePwdChange(); };
  document.getElementById('pwdNew').focus();
}

function closePwdChange() {
  const el = document.getElementById('pwdChangeOverlay');
  if (el) el.remove();
  _pwdChangeState = {};
}

async function pwdSendCode() {
  const errEl = document.getElementById('pwdError');
  errEl.style.display = 'none';
  
  const p1 = document.getElementById('pwdNew').value;
  const p2 = document.getElementById('pwdNew2').value;
  
  if (!p1 || p1.length < 4) { errEl.textContent='‚ùå –ü–∞—Ä–æ–ª—å –º–∏–Ω. 4 —Å–∏–º–≤–æ–ª–∞'; errEl.style.display='block'; return; }
  if (p1 !== p2) { errEl.textContent='‚ùå –ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç'; errEl.style.display='block'; return; }
  
  document.getElementById('pwdSendBtnText').textContent = '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...';
  
  // Generate 6-digit code
  const code = String(Math.floor(100000 + Math.random() * 900000));
  _pwdChangeState.code = code;
  _pwdChangeState.codeTime = Date.now();
  _pwdChangeState.newPassHash = await hashPassword(p1);
  
  // Save code to tg_auth_tokens
  try {
    await SB.from('tg_auth_tokens').insert({
      token: code,
      staff_id: _pwdChangeState.staffId,
      telegram_id: _pwdChangeState.tgId,
      type: 'password_change'
    });
  } catch(e) { /* table may not exist, use local check */ }
  
  // Send code via Telegram
  try {
    await sendTelegramNotification(
      _pwdChangeState.tgId,
      'üîê *–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è*\n\n–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è: `' + code + '`\n\n‚è∞ –ö–æ–¥ –¥–µ–π—Å—Ç–≤—É–µ—Ç 5 –º–∏–Ω—É—Ç.\n‚ö†Ô∏è –ï—Å–ª–∏ –≤—ã –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–ª–∏ —Å–º–µ–Ω—É –ø–∞—Ä–æ–ª—è ‚Äî –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä—É–π—Ç–µ.'
    );
  } catch(e) {
    errEl.textContent = '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –≤ Telegram';
    errEl.style.display = 'block';
    document.getElementById('pwdSendBtnText').textContent = 'üì± –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –≤ Telegram';
    return;
  }
  
  // Switch to step 2
  document.getElementById('pwdStep1').style.display = 'none';
  document.getElementById('pwdStep2').style.display = 'block';
  document.getElementById('pwdSendBtnText').textContent = 'üì± –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –≤ Telegram';
  document.getElementById('pwdCode').focus();
  toast('üì± –ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram', 'success');
}

async function pwdVerifyCode() {
  const errEl = document.getElementById('pwdError');
  errEl.style.display = 'none';
  const entered = (document.getElementById('pwdCode')?.value||'').trim();
  
  if (!entered || entered.length !== 6) { errEl.textContent='–í–≤–µ–¥–∏—Ç–µ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥'; errEl.style.display='block'; return; }
  
  document.getElementById('pwdVerifyBtnText').textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...';
  
  // Check expiry (5 min)
  if (Date.now() - (_pwdChangeState.codeTime||0) > 5 * 60 * 1000) {
    errEl.textContent = '‚ùå –ö–æ–¥ –∏—Å—Ç—ë–∫. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–æ–≤—ã–π.';
    errEl.style.display = 'block';
    document.getElementById('pwdVerifyBtnText').textContent = '‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å';
    return;
  }
  
  // Verify code (local + DB)
  let valid = (entered === _pwdChangeState.code);
  
  if (!valid) {
    try {
      const { data } = await SB.from('tg_auth_tokens').select('*').eq('token', entered).eq('staff_id', _pwdChangeState.staffId).single();
      if (data) {
        valid = true;
        await SB.from('tg_auth_tokens').delete().eq('token', entered).catch(()=>{});
      }
    } catch(e) { /* table may not exist */ }
  }
  
  if (!valid) {
    errEl.textContent = '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥';
    errEl.style.display = 'block';
    document.getElementById('pwdVerifyBtnText').textContent = '‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å';
    return;
  }
  
  // Code verified ‚Äî change password
  try {
    await SB.from('staff').update({ pin_hash: _pwdChangeState.newPassHash }).eq('id', _pwdChangeState.staffId);
    const staff = _staffCache.find(s => (s.ID||s.id) === _pwdChangeState.staffId);
    if (staff) staff['pin_hash'] = _pwdChangeState.newPassHash;
    
    // Cleanup used code from DB
    try { await SB.from('tg_auth_tokens').delete().eq('token', _pwdChangeState.code).catch(()=>{}); } catch(e) {}
    
    closePwdChange();
    toast('‚úÖ –ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω!', 'success');
    
    // Notify via Telegram
    try {
      await sendTelegramNotification(_pwdChangeState.tgId, '‚úÖ –ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω –≤ RKT HUB.');
    } catch(e) {}
  } catch(e) {
    errEl.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + e.message;
    errEl.style.display = 'block';
    document.getElementById('pwdVerifyBtnText').textContent = '‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å';
  }
}

async function approveStaff(id) {
  const staff = DATA.staff.find(s => s.ID === id);
  if (!staff) return;
  try {
    staff['–°—Ç–∞—Ç—É—Å'] = '–ê–∫—Ç–∏–≤–Ω—ã–π';
    await apiWrite('–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏', { ID: id, '–°—Ç–∞—Ç—É—Å': '–ê–∫—Ç–∏–≤–Ω—ã–π' }, 'update');
    toast('‚úÖ ' + esc(staff['–ò–º—è']) + ' –æ–¥–æ–±—Ä–µ–Ω!', 'success');
    // Notify the approved staff member via Telegram
    const tgId = staff['Telegram_ID'];
    if (tgId) {
      sendTelegramNotification(tgId, '‚úÖ –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –≤ RKT HUB –æ–¥–æ–±—Ä–µ–Ω–∞! –í—ã –º–æ–∂–µ—Ç–µ –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É.');
    }
    addNotification('‚úÖ –û–¥–æ–±—Ä–µ–Ω —Å–æ—Ç—Ä—É–¥–Ω–∏–∫: ' + (staff['–ò–º—è']||''), 'staff');
    await loadData();
    renderStaff();
  } catch(e) {
    toast('‚ùå –û—à–∏–±–∫–∞: ' + e.message, 'error');
  }
}

async function rejectStaff(id) {
  const staff = DATA.staff.find(s => s.ID === id);
  if (!staff) return;
  try {
    // Notify the rejected staff member via Telegram first
    const tgId = staff['Telegram_ID'];
    if (tgId) {
      sendTelegramNotification(tgId, '‚ùå –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤–∞—à–∞ –∑–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –≤ RKT HUB –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞. –°–≤—è–∂–∏—Ç–µ—Å—å —Å —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ–º –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è.');
    }
    // Delete the staff record
    await SB.from('staff').delete().eq('id', id);
    DATA.staff = DATA.staff.filter(s => (s.ID || s.id) !== id);
    toast('‚ùå –ó–∞—è–≤–∫–∞ ' + esc(staff['–ò–º—è'] || '') + ' –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞', 'warning');
    addNotification('‚ùå –û—Ç–∫–ª–æ–Ω—ë–Ω —Å–æ—Ç—Ä—É–¥–Ω–∏–∫: ' + (staff['–ò–º—è']||''), 'staff');
    renderStaff();
  } catch(e) {
    toast('‚ùå –û—à–∏–±–∫–∞: ' + e.message, 'error');
  }
}

// Send Telegram notification helper
async function sendTelegramNotification(chatId, text) {
  if (!CONFIG.TG_BOT_TOKEN || !chatId) return;
  try {
    await fetch('https://api.telegram.org/bot' + CONFIG.TG_BOT_TOKEN + '/sendMessage', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ chat_id: chatId, text: text, parse_mode: 'Markdown' })
    });
  } catch(e) { console.warn('TG notification error:', e); }
}

// Self-registration function (from Telegram bot or web)
async function selfRegister(data) {
  const staffRow = {
    '–ò–º—è': data.name || '',
    '–†–æ–ª—å': data.role || '–°–æ—Ç—Ä—É–¥–Ω–∏–∫',
    '–ü—Ä–æ–µ–∫—Ç': data.project || '',
    '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ': data.direction || '',
    'Telegram_ID': data.telegram_id || '',
    'Username': data.username || '',
    'Email': data.email || '',
    '–¢–µ–ª–µ—Ñ–æ–Ω': data.phone || '',
    '–°—Ç–∞—Ç—É—Å': '–û–∂–∏–¥–∞–µ—Ç',
    '–î–∞—Ç–∞_–¥–æ–±–∞–≤–ª–µ–Ω–∏—è': today()
  };
  // Create the staff record with pending status
  const ok = await apiWrite('–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏', staffRow);
  if (ok) {
    // Also create approval request for CEO
    const approval = {
      ID: 'A' + Date.now().toString(36).toUpperCase(),
      '–¢–∏–ø': 'üë§ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞',
      '–û–ø–∏—Å–∞–Ω–∏–µ': (data.name||'?') + ' ‚Äî ' + (data.role||'–°–æ—Ç—Ä—É–¥–Ω–∏–∫') + ' (' + (data.project||'') + ')',
      '–û—Ç_–∫–æ–≥–æ': data.name || '?',
      '–†–æ–ª—å': data.role || '–°–æ—Ç—Ä—É–¥–Ω–∏–∫',
      '–°—Ç–∞—Ç—É—Å': '‚è≥ –û–∂–∏–¥–∞–µ—Ç',
      '–î–∞—Ç–∞_–∑–∞–ø—Ä–æ—Å–∞': today(),
      '–õ–∏—Å—Ç': '–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏',
      '–î–∞–Ω–Ω—ã–µ': JSON.stringify(staffRow)
    };
    await apiWrite('–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è', approval);
    // Notify CEO about new registration
    notifyCEO('üë§ –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é:\n' + (data.name||'?') + ' ‚Äî ' + (data.role||'–°–æ—Ç—Ä—É–¥–Ω–∏–∫') + '\n–ü—Ä–æ–µ–∫—Ç: ' + (data.project||'–Ω–µ —É–∫–∞–∑–∞–Ω'));
  }
  return ok;
}

// Notify CEO via Telegram
function notifyCEO(text) {
  const ceo = (DATA.staff||[]).find(s => normalizeRole(s['–†–æ–ª—å']||'') === 'CEO' && s['Telegram_ID']);
  if (ceo) sendTelegramNotification(ceo['Telegram_ID'], text);
}

// Quick site task ‚Äî CEO/–ó–∞–º –≤—Å—Ç–∞–≤–ª—è–µ—Ç —Å—Å—ã–ª–∫—É –Ω–∞ –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç—ã
function openQuickSiteTask() {
  const html = `
    <div style="padding:20px">
      <h3 style="margin-bottom:16px">üåê –ë—ã—Å—Ç—Ä–æ–µ –∑–∞–¥–∞–Ω–∏–µ –ø–æ —Å–∞–π—Ç—É</h3>
      <p style="font-size:13px;color:var(--text2);margin-bottom:16px">–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç—ã –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å–∞ ‚Äî —Å–∏—Å—Ç–µ–º–∞ —Å–æ–∑–¥–∞—Å—Ç –∫–ª–∏–µ–Ω—Ç–∞ –∏ –∑–∞–¥–∞—á–∏ –¥–ª—è –∑–∞–º–∞.</p>
      <div class="form-group">
        <label>üîó –°—Å—ã–ª–∫–∞ –Ω–∞ –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç—ã –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ</label>
        <input type="text" id="qs-link" placeholder="https://yandex.ru/maps/... –∏–ª–∏ –ù–∞–∑–≤–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å–∞" style="width:100%">
      </div>
      <div class="form-group">
        <label>üìç –ì–æ—Ä–æ–¥</label>
        <input type="text" id="qs-city" placeholder="–ù–∞–±–µ—Ä–µ–∂–Ω—ã–µ –ß–µ–ª–Ω—ã" value="–ù–∞–±–µ—Ä–µ–∂–Ω—ã–µ –ß–µ–ª–Ω—ã" style="width:100%">
      </div>
      <div class="form-group">
        <label>üìû –¢–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–µ–Ω—Ç–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)</label>
        <input type="text" id="qs-phone" placeholder="+7..." style="width:100%">
      </div>
      <div class="form-group">
        <label>üë§ –ù–∞–∑–Ω–∞—á–∏—Ç—å –Ω–∞</label>
        <select id="qs-assignee" style="width:100%">
          ${DATA.staff.filter(s => s['–°—Ç–∞—Ç—É—Å']!=='–û–∂–∏–¥–∞–µ—Ç' && s['–°—Ç–∞—Ç—É—Å']!=='‚ùå –£–¥–∞–ª—ë–Ω').map(s =>
            '<option value="'+esc(s['–ò–º—è'])+'">'+esc(s['–ò–º—è'])+' ('+esc(s['–†–æ–ª—å'])+')</option>'
          ).join('')}
        </select>
      </div>
      <div class="form-group">
        <label>üìù –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π CEO</label>
        <textarea id="qs-comment" rows="2" placeholder="–î–æ–ø. –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –∑–∞–º–∞..." style="width:100%"></textarea>
      </div>
      <button class="btn btn-primary" onclick="submitQuickSiteTask()" style="width:100%;margin-top:8px">üöÄ –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ</button>
    </div>`;
  document.getElementById('modalTitle').textContent = 'üåê –ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç –Ω–∞ —Å–∞–π—Ç';
  document.getElementById('modalBody').innerHTML = html;
  document.getElementById('modalSaveBtn').style.display = 'none';
  document.getElementById('modalOverlay').classList.add('show');
}

async function submitQuickSiteTask() {
  const link = document.getElementById('qs-link').value.trim();
  const city = document.getElementById('qs-city').value.trim();
  const phone = document.getElementById('qs-phone').value.trim();
  const assignee = document.getElementById('qs-assignee').value;
  const comment = document.getElementById('qs-comment').value.trim();

  if (!link) { toast('–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ','warning'); return; }

  // Extract name from link or use as-is
  let bizName = link;
  if (link.includes('yandex.ru/maps') || link.includes('2gis')) {
    bizName = '–ö–ª–∏–µ–Ω—Ç_' + String(Date.now()).slice(-4);
  }

  const td = today();
  const proj = PROJECTS['—Å–∞–π—Ç—ã'] || PROJECTS['sites'] || Object.values(PROJECTS).find(p => p.canAddSub);
  const projName = proj ? proj.name : '–°–∞–π—Ç—ã';

  // 1. Create direction (subproject)
  await apiWrite('–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è', {
    ID: 'DIR'+String(Date.now()).slice(-6),
    '–ù–∞–∑–≤–∞–Ω–∏–µ': bizName,
    '–ü—Ä–æ–µ–∫—Ç': projName,
    '–°—Ç–∞—Ç—É—Å': 'üîç –ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞',
    '–≠—Ç–∞–ø': '–õ–∏–¥',
    '–°—Å—ã–ª–∫–∞': link,
    '–¢–µ–ª–µ—Ñ–æ–Ω': phone,
    '–ì–æ—Ä–æ–¥': city,
    '–î–∞—Ç–∞_—Å–æ–∑–¥–∞–Ω–∏—è': td
  });

  // 2. Auto-create pipeline tasks
  const pipeline = [
    { desc: 'üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å –∫–ª–∏–µ–Ω—Ç—É ¬´'+bizName+'¬ª, –¥–æ–≥–æ–≤–æ—Ä–∏—Ç—å—Å—è –æ —Å–∞–π—Ç–µ', days: 1, pr: 'P1' },
    { desc: 'üìã –ó–∞–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∫–µ—Ç—É –¥–ª—è ¬´'+bizName+'¬ª', days: 2, pr: 'P1' },
    { desc: 'üé® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–º–µ—Ä —Å–∞–π—Ç–∞ ¬´'+bizName+'¬ª', days: 3, pr: 'P1' },
    { desc: 'üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä –∫–ª–∏–µ–Ω—Ç—É ¬´'+bizName+'¬ª', days: 4, pr: 'P1' },
    { desc: 'üí¨ –ü–æ–ª—É—á–∏—Ç—å —Ñ–∏–¥–±–µ–∫ –æ—Ç ¬´'+bizName+'¬ª', days: 6, pr: 'P2' },
    { desc: 'üí≥ –í—ã—Å—Ç–∞–≤–∏—Ç—å —Å—á—ë—Ç –∑–∞ –¥–æ–º–µ–Ω/—Ö–æ—Å—Ç–∏–Ω–≥ ¬´'+bizName+'¬ª', days: 8, pr: 'P2' },
    { desc: 'üîß –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∞–π—Ç ¬´'+bizName+'¬ª –Ω–∞ —Ö–æ—Å—Ç–∏–Ω–≥', days: 12, pr: 'P2' },
    { desc: '‚úÖ –°–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç ¬´'+bizName+'¬ª, –ø–æ–ª—É—á–∏—Ç—å –æ–ø–ª–∞—Ç—É', days: 14, pr: 'P3' }
  ];

  for (const task of pipeline) {
    const dl = new Date(); dl.setDate(dl.getDate() + task.days);
    await apiWrite('–ó–∞–¥–∞—á–∏', {
      ID: 'T'+String(Date.now()).slice(-6)+String(Math.random()).slice(2,4),
      '–û–ø–∏—Å–∞–Ω–∏–µ': task.desc + (comment ? '\nüí° CEO: '+comment : ''),
      '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ': bizName,
      '–ü—Ä–æ–µ–∫—Ç': projName,
      '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç': task.pr,
      '–°—Ç–∞—Ç—É—Å': '‚è≥ –í –æ—á–µ—Ä–µ–¥–∏',
      '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π': assignee,
      '–î–µ–¥–ª–∞–π–Ω': dl.toISOString().split('T')[0],
      '–°—Å—ã–ª–∫–∞': link,
      '–°–æ–∑–¥–∞–Ω–æ': td
    });
  }

  closeModal();
  toast('üöÄ –°–æ–∑–¥–∞–Ω –∫–ª–∏–µ–Ω—Ç ¬´'+bizName+'¬ª + 8 –∑–∞–¥–∞—á –¥–ª—è '+assignee, 'success');
  debouncedLoadData();
}

function renderApprovals() {
  const el = document.getElementById('approvals-content');
  const p = getUserPerms();
  if (!p.canApprove) { el.innerHTML = '<div class="empty"><div class="icon">üîí</div><p>–¢–æ–ª—å–∫–æ –¥–ª—è CEO</p></div>'; return; }
  const pending = DATA.approvals.filter(a=>(a['–°—Ç–∞—Ç—É—Å']||'').includes('–û–∂–∏–¥–∞–µ—Ç'));
  const done = DATA.approvals.filter(a=>!(a['–°—Ç–∞—Ç—É—Å']||'').includes('–û–∂–∏–¥–∞–µ—Ç')).slice(0,20);

  let h = '<div class="card" style="margin-bottom:16px"><div class="card-header"><h3>‚è≥ –û–∂–∏–¥–∞—é—Ç –æ–¥–æ–±—Ä–µ–Ω–∏—è ('+pending.length+')</h3></div>';
  if (pending.length) {
    h += pending.map(a => {
      let preview = '';
      try {
        const d = JSON.parse(a['–î–∞–Ω–Ω—ã–µ']||'{}');
        preview = Object.entries(d).filter(([k,v])=>v&&k!=='ID'&&k!=='row_number').slice(0,5).map(([k,v])=>'<span style="font-size:11px;background:var(--bg3);padding:2px 6px;border-radius:4px;margin:2px">'+esc(k)+': '+esc(String(v).substring(0,40))+'</span>').join(' ');
      } catch(e) {}
      return '<div class="card" style="padding:16px;margin:8px 16px;border-left:3px solid var(--accent)">' +
        '<div style="display:flex;justify-content:space-between;align-items:start;gap:12px">' +
        '<div style="flex:1">' +
        '<div style="font-weight:600;font-size:14px">'+esc(a['–¢–∏–ø']||'–ó–∞–ø—Ä–æ—Å')+'</div>' +
        '<div style="font-size:13px;color:var(--text2);margin:4px 0">'+esc(a['–û–ø–∏—Å–∞–Ω–∏–µ']||'')+'</div>' +
        '<div style="font-size:12px;color:var(--text3)">üë§ '+esc(a['–û—Ç_–∫–æ–≥–æ']||'?')+' ('+esc(a['–†–æ–ª—å']||'')+') ¬∑ üìÖ '+esc(a['–î–∞—Ç–∞_–∑–∞–ø—Ä–æ—Å–∞']||'')+'</div>' +
        (a['–õ–∏—Å—Ç'] ? '<div style="font-size:11px;margin-top:4px">üìã –õ–∏—Å—Ç: <b>'+esc(a['–õ–∏—Å—Ç'])+'</b></div>' : '') +
        (preview ? '<div style="margin-top:6px;display:flex;flex-wrap:wrap;gap:2px">'+preview+'</div>' : '') +
        '</div>' +
        '<div style="display:flex;gap:6px;flex-shrink:0">' +
        '<button class="btn btn-primary" style="padding:6px 16px" onclick="handleApproval(\''+escA(a.ID)+'\',true)">‚úÖ –û–¥–æ–±—Ä–∏—Ç—å</button>' +
        '<button class="btn btn-danger" style="padding:6px 12px" onclick="handleApproval(\''+escA(a.ID)+'\',false)">‚ùå</button>' +
        '</div></div></div>';
    }).join('');
  } else {
    h += '<div class="empty" style="padding:30px"><div class="icon">‚ú®</div><p>–ù–µ—Ç –æ–∂–∏–¥–∞—é—â–∏—Ö</p></div>';
  }
  h += '</div>';

  if (done.length) {
    h += '<div class="card"><div class="card-header"><h3>üìã –ò—Å—Ç–æ—Ä–∏—è</h3></div><div class="table-wrap"><table><thead><tr><th>–¢–∏–ø</th><th>–û–ø–∏—Å–∞–Ω–∏–µ</th><th>–û—Ç –∫–æ–≥–æ</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–∞—Ç–∞ —Ä–µ—à–µ–Ω–∏—è</th></tr></thead><tbody>';
    h += done.map(a => '<tr><td>'+esc(a['–¢–∏–ø'])+'</td><td>'+esc(a['–û–ø–∏—Å–∞–Ω–∏–µ'])+'</td><td>'+esc(a['–û—Ç_–∫–æ–≥–æ'])+'</td><td>'+esc(a['–°—Ç–∞—Ç—É—Å'])+'</td><td>'+esc(a['–î–∞—Ç–∞_—Ä–µ—à–µ–Ω–∏—è']||'‚Äî')+'</td></tr>').join('');
    h += '</tbody></table></div></div>';
  }
  el.innerHTML = h;
}

function renderComms() {
  let d = DATA.comms||[];
  d = filterBySearch(d,'comm-search',['–ü–∞—Ä—Ç–Ω—ë—Ä','–¢–µ–º–∞','–†–µ–∑—É–ª—å—Ç–∞—Ç']);
  document.getElementById('comms-table').innerHTML = d.length ? d.map(c =>
    '<tr><td><strong>'+esc(c['–ü–∞—Ä—Ç–Ω—ë—Ä'])+'</strong></td><td>'+esc(c['–¢–∏–ø'])+'</td><td>'+esc(c['–¢–µ–º–∞'])+'</td><td style="font-size:12px;max-width:200px;overflow:hidden;text-overflow:ellipsis">'+esc(c['–†–µ–∑—É–ª—å—Ç–∞—Ç']||'')+'</td><td>'+esc(c['–î–∞—Ç–∞']||'‚Äî')+'</td><td>'+esc(c['–ê–≤—Ç–æ—Ä']||'‚Äî')+'</td><td>'+actBtns('comm',c.ID||'',c['–ü–∞—Ä—Ç–Ω—ë—Ä'])+'</td></tr>'
  ).join('') : emptyRow(7,'–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π');
}

function renderSettings() {
  // Statistics section removed per CEO request

  // Permissions display
  const p = getUserPerms();
  const yn = (v) => v ? '<span style="color:var(--green)">‚úÖ</span>' : '<span style="color:var(--red)">‚ùå</span>';
  let ph = '<div style="margin-bottom:8px;color:var(--text2)">'+esc(p.desc||'')+'</div>';
  ph += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:4px">';
  ph += '<div>'+yn(p.canEditTasks)+' –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∞–º–∏</div>';
  ph += '<div>'+yn(p.canEditPartners)+' –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä—Ç–Ω—ë—Ä–∞–º–∏</div>';
  ph += '<div>'+yn(p.canEditStaff)+' –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏</div>';
  ph += '<div>'+yn(p.canEditProjects)+' –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞–º–∏</div>';
  ph += '<div>'+yn(p.canAssignTasks)+' –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∑–∞–¥–∞—á</div>';
  ph += '<div>'+yn(p.canApprove)+' –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ</div>';
  ph += '<div>'+yn(p.canDelete)+' –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π</div>';
  ph += '<div>'+yn(p.canCreateSiteTask)+' –°–æ–∑–¥–∞–Ω–∏–µ —Å–∞–π—Ç-–∑–∞–¥–∞—á</div>';
  ph += '<div>'+yn(p.canGenerateSite)+' –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∞–π—Ç–æ–≤</div>';
  ph += '<div>'+yn(p.canExport)+' –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
  ph += '</div>';
  if (p.writeSheets && p.writeSheets.length) {
    ph += '<div style="margin-top:8px;font-size:12px;color:var(--text3)">üìù –ü—Ä—è–º–∞—è –∑–∞–ø–∏—Å—å: '+p.writeSheets.join(', ')+'</div>';
  }
  if (p.needsApproval && p.needsApproval.length) {
    ph += '<div style="font-size:12px;color:var(--text3)">‚è≥ –ß–µ—Ä–µ–∑ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ: '+p.needsApproval.join(', ')+'</div>';
  }
  const permsEl = document.getElementById('s-perms');
  if (permsEl) permsEl.innerHTML = ph;
}

function updateConfig(key, value) { CONFIG[key] = value.trim(); }

// Dynamic direction filter when Project changes in form
function updateDirectionOptions(projName) {
  const sel = document.getElementById('field-–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ');
  if (!sel) return;
  const dirs = ['–í—Å–µ', ...getDirectionOptions(projName === '–í—Å–µ' ? null : projName)];
  sel.innerHTML = dirs.map(d => '<option value="'+escA(d)+'">'+esc(d)+'</option>').join('');
}

function saveSettings() {
  if (!USER || USER.role !== 'CEO') { toast('‚õî –¢–æ–ª—å–∫–æ CEO –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏','error'); return; }
  localStorage.setItem('rkt_config', JSON.stringify({
    AI_URL: CONFIG.AI_URL,
    TG_BOT: CONFIG.TG_BOT,
    TG_BOT_TOKEN: CONFIG.TG_BOT_TOKEN
  }));
  toast('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
}

function loadSavedSettings() {
  try {
    const saved = JSON.parse(localStorage.getItem('rkt_config') || '{}');
    if (saved.AI_URL) CONFIG.AI_URL = saved.AI_URL;
    if (saved.TG_BOT) CONFIG.TG_BOT = saved.TG_BOT;
    if (saved.TG_BOT_TOKEN) CONFIG.TG_BOT_TOKEN = saved.TG_BOT_TOKEN;
  } catch(e) {}
}

async function testConnection() {
  const el = document.getElementById('settings-status');
  el.innerHTML = '‚è≥ –ü—Ä–æ–≤–µ—Ä—è—é...';
  try {
    const testUrl = CONFIG.SUPABASE_URL + '/rest/v1/staff?select=id&limit=1';
    const ctrl = new AbortController();
    const tmr = setTimeout(() => ctrl.abort(), 10000);
    const r = await fetch(testUrl, {
      headers: { 'apikey': CONFIG.SUPABASE_KEY },
      signal: ctrl.signal
    });
    clearTimeout(tmr);
    if (r.ok) {
      el.innerHTML = '<span style="color:var(--green)">‚úÖ Supabase –ø–æ–¥–∫–ª—é—á–µ–Ω–∞! –ü–∞—Ä—Ç–Ω—ë—Ä–æ–≤: '+(DATA.partners||[]).length+', –ó–∞–¥–∞—á: '+(DATA.tasks||[]).length+', –°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤: '+(DATA.staff||[]).length+'</span>';
    } else {
      el.innerHTML = '<span style="color:var(--red)">‚ùå HTTP ' + r.status + '</span>';
    }
    // Test AI
    if (CONFIG.AI_URL) {
      const aiR = await fetch(CONFIG.AI_URL, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({message:'test',userId:'test',context:'ping'}),
        signal: AbortSignal.timeout(10000)
      }).catch(() => null);
      if (aiR && aiR.ok) {
        el.innerHTML += '<br><span style="color:var(--green)">‚úÖ AI webhook –¥–æ—Å—Ç—É–ø–µ–Ω</span>';
      } else {
        el.innerHTML += '<br><span style="color:var(--orange)">‚ö†Ô∏è AI webhook –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ n8n</span>';
      }
    }
  } catch(e) {
    const msg = e.name === 'AbortError' ? '–¢–∞–π–º–∞—É—Ç ‚Äî —Å–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç' : e.message;
    el.innerHTML = '<span style="color:var(--red)">‚ùå ' + msg + '</span>';
  }
}

// ============================================================
// SITE GENERATOR ‚Äî –∞–Ω–∫–µ—Ç–∞ + –ø—Ä–µ–≤—å—é —Å–∞–π—Ç–∞ —á–µ—Ä–µ–∑ Claude
// ============================================================
let siteGenCache = {}; // Per-subproject site data cache
let siteGenStep = 'form'; // form | loading | preview

function getSiteGenData() {
  const key = currentSubproject || '_default';
  if (!siteGenCache[key]) {
    siteGenCache[key] = {};
    // Auto-load saved site_html from database
    const dir = (DATA.directions||[]).find(d => d['–ù–∞–∑–≤–∞–Ω–∏–µ'] === currentSubproject && d['–ü—Ä–æ–µ–∫—Ç'] === '–°–∞–π—Ç—ã');
    if (dir && dir['site_html'] && !siteGenCache[key].html) {
      siteGenCache[key].html = dir['site_html'];
      siteGenCache[key].name = dir['–ù–∞–∑–≤–∞–Ω–∏–µ'] || '';
    }
  }
  return siteGenCache[key];
}

// ============================================================
// SITES BUSINESS: FINANCE DASHBOARD
// ============================================================
function renderSiteFinance() {
  const fin = calcSiteFinancials();
  const avgCheck = fin.clientCount ? Math.round(fin.plannedRevenue / fin.clientCount) : 10000;
  const saved = JSON.parse(localStorage.getItem('rkt_site_plan') || '{}');
  
  let html = '';
  
  // ====== PLAN GENERATOR ======
  html += '<div class="card" style="border-color:var(--accent);border-width:2px"><div class="card-header" style="background:rgba(110,86,207,0.08)"><h3>üéØ –ì–µ–Ω–µ—Ä–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω</h3>';
  html += '<button class="btn btn-sm btn-primary" onclick="executeSitePlan()">üöÄ –†–∞—Å–∫–∏–¥–∞—Ç—å –∑–∞–¥–∞—á–∏</button></div>';
  html += '<div class="card-body">';
  
  // Period & target
  html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:16px">';
  html += '<div class="form-group"><label>üìÖ –ü–µ—Ä–∏–æ–¥</label><select id="plan-period" onchange="recalcPlan()">';
  ['–ù–µ–¥–µ–ª—è','2 –Ω–µ–¥–µ–ª–∏','–ú–µ—Å—è—Ü'].forEach(p => {
    html += '<option'+(saved.period===p?' selected':'')+'>'+p+'</option>';
  });
  html += '</select></div>';
  html += '<div class="form-group"><label>üéØ –¶–µ–ª–µ–≤–æ–µ –∫–æ–ª-–≤–æ —Å–∞–π—Ç–æ–≤</label><input type="number" id="plan-target" value="'+(saved.target||10)+'" min="1" max="500" onchange="recalcPlan()"></div>';
  html += '<div class="form-group"><label>üìÑ –û—Å–Ω–æ–≤–Ω–æ–π —Ç–∏–ø</label><select id="plan-type" onchange="recalcPlan()">';
  for (const [name, p] of Object.entries(SITE_PRICING)) {
    html += '<option value="'+name+'"'+(saved.type===name?' selected':'')+'>'+p.emoji+' '+name+' ‚Äî '+fmtMoney(p.price)+'</option>';
  }
  html += '</select></div>';
  html += '<div class="form-group"><label>üìÜ –°—Ç–∞—Ä—Ç –ø–ª–∞–Ω–∞</label><input type="date" id="plan-start" value="'+(saved.start||today())+'"></div>';
  html += '</div>';
  
  // Auto-calculated distribution
  const staff = DATA.staff.filter(s => s['–ü—Ä–æ–µ–∫—Ç']==='–°–∞–π—Ç—ã' && s['–°—Ç–∞—Ç—É—Å']==='–ê–∫—Ç–∏–≤–Ω—ã–π');
  const devs = staff.filter(s => ['–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫','–ò–Ω–∂–µ–Ω–µ—Ä'].includes(s['–†–æ–ª—å']));
  const mgrs = staff.filter(s => s['–†–æ–ª—å']==='–ú–µ–Ω–µ–¥–∂–µ—Ä');
  const target = parseInt(saved.target) || 10;
  const siteType = saved.type || '–õ–µ–Ω–¥–∏–Ω–≥';
  const pricing = SITE_PRICING[siteType] || SITE_PRICING['–õ–µ–Ω–¥–∏–Ω–≥'];
  
  html += '<div style="background:var(--bg2);border-radius:var(--radius);padding:16px;margin-bottom:16px">';
  html += '<div style="font-weight:700;margin-bottom:12px;font-size:15px">üìä –†–∞—Å—á—ë—Ç –ø–ª–∞–Ω–∞ –Ω–∞ <span id="plan-calc-target">'+target+'</span> —Å–∞–π—Ç–æ–≤</div>';
  html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px">';
  
  const planRev = target * pricing.price;
  // Calculate total staff cost based on actual salary percentages
  const planStaffPct = allWorkers.reduce((sum, s) => {
    return sum + (parseInt(s['–ü—Ä–æ—Ü–µ–Ω—Ç_–ó–ü']) || DEFAULT_SALARY_PCT[s['–†–æ–ª—å']] || 0);
  }, 0);
  const planStaffCost = target * Math.round(pricing.price * planStaffPct / 100);
  const planProfit = planRev - planStaffCost;

  html += '<div style="text-align:center"><div style="font-size:22px;font-weight:700;color:var(--accent)">'+fmtMoney(planRev)+'</div><div style="font-size:11px;color:var(--text2)">–í—ã—Ä—É—á–∫–∞ (–ø–ª–∞–Ω)</div></div>';
  html += '<div style="text-align:center"><div style="font-size:22px;font-weight:700;color:var(--orange)">'+fmtMoney(planStaffCost)+'</div><div style="font-size:11px;color:var(--text2)">–§–û–¢ ('+planStaffPct+'%)</div></div>';
  html += '<div style="text-align:center"><div style="font-size:22px;font-weight:700;color:var(--green)">'+fmtMoney(planProfit)+'</div><div style="font-size:11px;color:var(--text2)">–ü—Ä–∏–±—ã–ª—å ('+(100-planStaffPct)+'%)</div></div>';
  html += '</div></div>';
  
  // Staff distribution
  html += '<div style="font-weight:600;margin-bottom:8px">üë• –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º:</div>';
  html += '<div class="table-wrap"><table><thead><tr><th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th><th>–†–æ–ª—å</th><th>%</th><th>–°–∞–π—Ç–æ–≤</th><th>–ó–∞—Ä–∞–±–æ—Ç–∞–µ—Ç</th><th>–ù–∞–≥—Ä—É–∑–∫–∞/–¥–µ–Ω—å</th></tr></thead><tbody>';

  const periodDays = saved.period === '2 –Ω–µ–¥–µ–ª–∏' ? 14 : (saved.period === '–ú–µ—Å—è—Ü' ? 30 : 7);
  const allWorkers = [...devs, ...mgrs];

  if (allWorkers.length === 0) {
    const escalation = staff.find(s => ['CEO','–ó–∞–º'].includes(s['–†–æ–ª—å'])) || { '–ò–º—è': USER?.name || 'CEO', '–†–æ–ª—å': 'CEO' };
    html += '<tr><td><strong>'+esc(escalation['–ò–º—è'])+'</strong></td><td>üëë '+esc(escalation['–†–æ–ª—å'])+'</td>';
    html += '<td>‚Äî</td><td style="font-weight:700">'+target+'</td>';
    html += '<td style="color:var(--accent);font-weight:600">'+fmtMoney(planProfit)+'</td>';
    html += '<td>'+(target/periodDays).toFixed(1)+'/–¥–µ–Ω—å</td></tr>';
    html += '<tr><td colspan="6" style="text-align:center;color:var(--orange)">‚ö†Ô∏è –ù–µ—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∏ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ ‚Äî –Ω–∞–π–º–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É!</td></tr>';
  } else {
    // Show each worker with their individual salary %
    const sitesPerWorker = allWorkers.length ? Math.ceil(target / allWorkers.length) : target;
    allWorkers.forEach((w, i) => {
      const role = w['–†–æ–ª—å'] || '?';
      const pct = parseInt(w['–ü—Ä–æ—Ü–µ–Ω—Ç_–ó–ü']) || DEFAULT_SALARY_PCT[role] || 0;
      const myCount = i < allWorkers.length - 1 ? sitesPerWorker : Math.max(0, target - sitesPerWorker * (allWorkers.length - 1));
      const earn = myCount * Math.round(pricing.price * pct / 100);
      const roleIcon = {'–ú–µ–Ω–µ–¥–∂–µ—Ä':'üíº','–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫':'üíª','–ò–Ω–∂–µ–Ω–µ—Ä':'üîß'}[role] || 'üë§';
      html += '<tr><td><strong>'+esc(w['–ò–º—è'])+'</strong></td><td>'+roleIcon+' '+esc(role)+'</td>';
      html += '<td style="font-weight:600">'+pct+'%</td>';
      html += '<td style="font-weight:700">'+myCount+'</td>';
      html += '<td style="color:var(--accent);font-weight:600">'+fmtMoney(earn)+'</td>';
      html += '<td>'+(myCount/periodDays).toFixed(1)+'/–¥–µ–Ω—å</td></tr>';
    });

    if (!devs.length) html += '<tr><td colspan="6" style="color:var(--orange)">‚ö†Ô∏è –ù–µ—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ ‚Äî –∑–∞–¥–∞—á–∏ –±—É–¥—É—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω—ã –Ω–∞ –ó–∞–º/CEO</td></tr>';
    if (!mgrs.length) html += '<tr><td colspan="6" style="color:var(--orange)">‚ö†Ô∏è –ù–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ ‚Äî –∑–∞–¥–∞—á–∏ –ø–æ–∏—Å–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã –Ω–∞ –ó–∞–º/CEO</td></tr>';
  }
  
  html += '</tbody></table></div>';
  html += '</div></div>';
  
  // ====== EDITABLE PRICING ======
  html += '<div class="card"><div class="card-header"><h3>üí∞ –ü—Ä–∞–π—Å-–ª–∏—Å—Ç</h3>';
  html += '<button class="btn btn-sm btn-secondary" onclick="openPricingEditor()">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button></div>';
  html += '<div class="table-wrap"><table><thead><tr><th>–¢–∏–ø —Å–∞–π—Ç–∞</th><th>–¶–µ–Ω–∞ –∫–ª–∏–µ–Ω—Ç—É</th><th>–û–ø–∏—Å–∞–Ω–∏–µ</th></tr></thead><tbody>';
  for (const [name, p] of Object.entries(SITE_PRICING)) {
    html += '<tr><td>'+p.emoji+' <strong>'+esc(name)+'</strong></td>';
    html += '<td style="font-weight:700;color:var(--accent)">'+fmtMoney(p.price)+'</td>';
    html += '<td style="font-size:12px;color:var(--text2)">'+esc(p.desc)+'</td></tr>';
  }
  html += '</tbody></table></div>';
  // Staff salary percentages inline
  const staffForPct = DATA.staff.filter(s => s['–ü—Ä–æ–µ–∫—Ç']==='–°–∞–π—Ç—ã' && s['–°—Ç–∞—Ç—É—Å']==='–ê–∫—Ç–∏–≤–Ω—ã–π');
  if (staffForPct.length) {
    html += '<div style="padding:12px 16px;background:var(--bg2);border-radius:0 0 var(--radius) var(--radius);font-size:12px;color:var(--text2)">';
    html += '<strong>–ü—Ä–æ—Ü–µ–Ω—Ç—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:</strong> ';
    html += staffForPct.map(s => {
      const pct = parseInt(s['–ü—Ä–æ—Ü–µ–Ω—Ç_–ó–ü']) || DEFAULT_SALARY_PCT[s['–†–æ–ª—å']] || 0;
      return esc(s['–ò–º—è']) + ' ‚Äî ' + pct + '%';
    }).join(', ');
    html += ' <span style="color:var(--text2)">(–æ—Å—Ç–∞–ª—å–Ω–æ–µ ‚Äî –ø—Ä–∏–±—ã–ª—å –∫–æ–º–ø–∞–Ω–∏–∏)</span>';
    html += '</div>';
  }
  html += '</div>';
  
  // ====== SUMMARY METRICS ======
  html += '<div class="metrics" style="margin-bottom:20px">';
  html += '<div class="metric-card"><div class="m-icon">üë•</div><div class="m-value">'+fin.clientCount+'</div><div class="m-label">–ö–ª–∏–µ–Ω—Ç–æ–≤</div><div class="m-sub">'+fin.inProgressCount+' –≤ —Ä–∞–±–æ—Ç–µ / '+fin.paidCount+' –æ–ø–ª–∞—á–µ–Ω–æ</div></div>';
  html += '<div class="metric-card"><div class="m-icon">üí∞</div><div class="m-value">'+fmtMoney(fin.totalRevenue)+'</div><div class="m-label">–§–∞–∫—Ç –≤—ã—Ä—É—á–∫–∞</div></div>';
  html += '<div class="metric-card"><div class="m-icon">üí∏</div><div class="m-value">'+fmtMoney(fin.totalStaffCost)+'</div><div class="m-label">–§–∞–∫—Ç –§–û–¢</div></div>';
  html += '<div class="metric-card"><div class="m-icon">'+(fin.profit>=0?'üìà':'üìâ')+'</div><div class="m-value" style="color:'+(fin.profit>=0?'var(--green)':'var(--red)')+'">'+fmtMoney(fin.profit)+'</div><div class="m-label">–§–∞–∫—Ç –ø—Ä–∏–±—ã–ª—å</div></div>';
  html += '</div>';
  
  // ====== CLIENT PIPELINE ======
  html += '<div class="card"><div class="card-header"><h3>üìã –ö–ª–∏–µ–Ω—Ç—ã ‚Äî –≤–æ—Ä–æ–Ω–∫–∞</h3></div>';
  html += '<div class="table-wrap"><table><thead><tr><th>–ö–ª–∏–µ–Ω—Ç</th><th>–¢–∏–ø</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ü—Ä–æ–≥—Ä–µ—Å—Å</th><th>–í—ã—Ä—É—á–∫–∞</th><th>–û–ø–ª–∞—Ç–∞</th></tr></thead><tbody>';
  if (fin.clients.length) {
    fin.clients.forEach(c => {
      const statusColor = c.isPaid ? 'var(--green)' : (c.isDone ? 'var(--orange)' : 'var(--blue)');
      html += '<tr><td><strong>'+esc(c.name)+'</strong></td>';
      html += '<td>'+(SITE_PRICING[c.type]?.emoji||'üìÑ')+' '+esc(c.type)+'</td>';
      html += '<td>'+statusBadge(c.status)+'</td>';
      html += '<td>'+progBar(c.progress)+'</td>';
      html += '<td>'+fmtMoney(c.plannedRevenue)+'</td>';
      html += '<td style="color:'+statusColor+';font-weight:600">'+(c.isPaid?'‚úÖ –û–ø–ª–∞—á–µ–Ω–æ':(c.isDone?'‚è≥ –ñ–¥—ë–º –æ–ø–ª–∞—Ç—É':'üîÑ –í —Ä–∞–±–æ—Ç–µ'))+'</td></tr>';
    });
  } else {
    html += emptyRow(6, '–ù–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤');
  }
  html += '</tbody></table></div></div>';
  
  return html;
}

// ============================================================
// PLAN: save, recalc, execute
// ============================================================
function recalcPlan() {
  const plan = {
    period: document.getElementById('plan-period')?.value || '–ù–µ–¥–µ–ª—è',
    target: document.getElementById('plan-target')?.value || '10',
    type: document.getElementById('plan-type')?.value || '–õ–µ–Ω–¥–∏–Ω–≥',
    start: document.getElementById('plan-start')?.value || today()
  };
  localStorage.setItem('rkt_site_plan', JSON.stringify(plan));
  // Re-render finance tab
  if (currentPvTab === 'finance') {
    document.getElementById('pv-content').innerHTML = renderSiteFinance();
  }
}

async function executeSitePlan() {
  const target = parseInt(document.getElementById('plan-target')?.value) || 10;
  const period = document.getElementById('plan-period')?.value || '–ù–µ–¥–µ–ª—è';
  const siteType = document.getElementById('plan-type')?.value || '–õ–µ–Ω–¥–∏–Ω–≥';
  const startDate = document.getElementById('plan-start')?.value || today();
  const periodDays = period === '2 –Ω–µ–¥–µ–ª–∏' ? 14 : (period === '–ú–µ—Å—è—Ü' ? 30 : 7);
  const pricing = SITE_PRICING[siteType] || SITE_PRICING['–õ–µ–Ω–¥–∏–Ω–≥'];

  // Calculate financial forecast
  const expectedRevenue = target * pricing.price;
  const staff = DATA.staff.filter(s => s['–ü—Ä–æ–µ–∫—Ç']==='–°–∞–π—Ç—ã' && s['–°—Ç–∞—Ç—É—Å']==='–ê–∫—Ç–∏–≤–Ω—ã–π');
  const devs = staff.filter(s => ['–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫','–ò–Ω–∂–µ–Ω–µ—Ä'].includes(normalizeRole(s['–†–æ–ª—å']||'')));
  const mgrs = staff.filter(s => normalizeRole(s['–†–æ–ª—å']||'') === '–ú–µ–Ω–µ–¥–∂–µ—Ä');

  let totalSalaryCost = 0;
  staff.forEach(s => {
    const pct = parseInt(s['–ü—Ä–æ—Ü–µ–Ω—Ç_–ó–ü']) || 0;
    if (pct > 0) totalSalaryCost += Math.round(expectedRevenue * pct / 100 / staff.length);
  });
  const expectedProfit = expectedRevenue - totalSalaryCost;
  const tasksPerPerson = Math.ceil(target * 3 / Math.max(staff.length, 1));

  if (!confirm('üöÄ –ì–µ–Ω–µ—Ä–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω\n\n' +
    'üìä –¶–µ–ª–µ–≤—ã–µ –∫–ª–∏–µ–Ω—Ç—ã: ' + target + ' √ó ¬´' + siteType + '¬ª\n' +
    'üìÖ –ü–µ—Ä–∏–æ–¥: ' + period + ' (—Å ' + startDate + ')\n\n' +
    'üí∞ –§–ò–ù–ê–ù–°–û–í–´–ô –ü–†–û–ì–ù–û–ó:\n' +
    '  –í—ã—Ä—É—á–∫–∞: ' + fmtMoney(expectedRevenue) + '\n' +
    '  –†–∞—Å—Ö–æ–¥—ã –Ω–∞ –∑–∞—Ä–ø–ª–∞—Ç—ã: ~' + fmtMoney(totalSalaryCost) + '\n' +
    '  –ü—Ä–∏–±—ã–ª—å: ~' + fmtMoney(expectedProfit) + '\n\n' +
    'üë• –ó–∞–≥—Ä—É–∑–∫–∞: ~' + tasksPerPerson + ' –∑–∞–¥–∞—á/—á–µ–ª.\n\n' +
    '–ë—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã ' + target + ' placeholder-–∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ –ø–æ–ª–Ω—ã–µ —Ü–µ–ø–æ—á–∫–∏ –∑–∞–¥–∞—á.\n–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?'
  )) return;

  const fallbackPerson = staff.find(s => ['CEO','–ó–∞–º'].includes(normalizeRole(s['–†–æ–ª—å']||'')))?.['–ò–º—è'] || (USER?.name || 'CEO');
  const devNames = devs.length ? devs.map(d => d['–ò–º—è']) : [fallbackPerson];
  const mgrNames = mgrs.length ? mgrs.map(m => m['–ò–º—è']) : [fallbackPerson];

  let createdDirs = 0, createdTasks = 0;
  const startD = new Date(startDate);

  toast('‚è≥ –°–æ–∑–¥–∞—é –≥–µ–Ω–ø–ª–∞–Ω...', 'info');

  for (let i = 0; i < target; i++) {
    const dayOffset = Math.floor(i * periodDays / target);
    const dl = new Date(startD); dl.setDate(dl.getDate() + dayOffset);
    const deadlineStr = dl.toISOString().split('T')[0];

    const mgrName = mgrNames[i % mgrNames.length];
    const devName = devNames[i % devNames.length];
    const clientLabel = '–ü–ª–∞–Ω #' + (fin_planCounter++) + ' ‚Äî ' + siteType;
    const dirId = 'D' + Date.now().toString(36).toUpperCase() + String(Math.random()).slice(2,5);

    // Create placeholder direction (client)
    try {
      await SB.from('directions').insert({
        id: dirId,
        name: clientLabel,
        project: '–°–∞–π—Ç—ã',
        site_type: siteType,
        price: pricing.price,
        stage: 'prospect',
        source: '–ì–µ–Ω–ø–ª–∞–Ω',
        manager: mgrName,
        status: '–ê–∫—Ç–∏–≤–Ω—ã–π',
        created_at: today()
      });
      createdDirs++;
    } catch(e) { console.warn('GenPlan dir create error:', e); }

    // Create first 3 pipeline tasks for each client
    const initialSteps = SITE_PIPELINE.slice(0, 3);
    for (const step of initialSteps) {
      const assignee = step.role === '–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫' ? devName :
                       step.role === '–ú–µ–Ω–µ–¥–∂–µ—Ä' ? mgrName :
                       getSiteStaffByRole(step.role);
      const taskDl = new Date(dl); taskDl.setDate(taskDl.getDate() + step.days);
      try {
        await SB.from('tasks').insert({
          id: 'T' + Date.now().toString(36).toUpperCase() + String(Math.random()).slice(2,5),
          description: step.name + ': ' + clientLabel,
          direction: clientLabel,
          project: '–°–∞–π—Ç—ã',
          priority: step.step <= 2 ? 'P1' : 'P2',
          status: step.step === 1 ? '–í —Ä–∞–±–æ—Ç–µ' : '–ù–æ–≤–∞—è',
          assignee: assignee,
          deadline: taskDl.toISOString().split('T')[0],
          created_at: today()
        });
        createdTasks++;
      } catch(e) { console.warn('GenPlan task create error:', e); }
    }

    if (i % 5 === 4) await new Promise(r => setTimeout(r, 200));
  }

  toast('‚úÖ –ì–µ–Ω–ø–ª–∞–Ω —Å–æ–∑–¥–∞–Ω!\nüìÇ ' + createdDirs + ' –∫–ª–∏–µ–Ω—Ç–æ–≤\nüìã ' + createdTasks + ' –∑–∞–¥–∞—á\nüí∞ –ü–ª–∞–Ω –≤—ã—Ä—É—á–∫–∏: ' + fmtMoney(expectedRevenue), 'success');

  // Save plan
  localStorage.setItem('rkt_site_plan', JSON.stringify({
    period, target: String(target), type: siteType, start: startDate,
    lastExecuted: today(), createdDirs, createdTasks,
    forecast: { revenue: expectedRevenue, costs: totalSalaryCost, profit: expectedProfit }
  }));

  await loadData();
  renderAll();
}
let fin_planCounter = 1;
// Init counter from existing tasks
try { fin_planCounter = DATA.tasks.filter(t => (t['–û–ø–∏—Å–∞–Ω–∏–µ']||'').includes('–ø–ª–∞–Ω')).length + 1; } catch(e) {}

function openPricingEditor() {
  let fieldsHtml = '<h3 style="margin-bottom:16px">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∞–π—Å-–ª–∏—Å—Ç</h3>';
  fieldsHtml += '<p style="font-size:12px;color:var(--text2);margin-bottom:16px">–ò–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –ü—Ä–æ—Ü–µ–Ω—Ç—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É—é—Ç—Å—è –≤ –∫–∞—Ä—Ç–æ—á–∫–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞.</p>';

  for (const [name, p] of Object.entries(SITE_PRICING)) {
    fieldsHtml += '<div style="background:var(--bg2);border-radius:var(--radius);padding:12px;margin-bottom:8px">';
    fieldsHtml += '<div style="font-weight:600;margin-bottom:8px">'+p.emoji+' '+name+'</div>';
    fieldsHtml += '<div class="form-group"><label style="font-size:11px">–¶–µ–Ω–∞ –∫–ª–∏–µ–Ω—Ç—É (‚ÇΩ)</label><input type="number" id="price-'+name+'" value="'+p.price+'" min="0" step="500"></div>';
    fieldsHtml += '</div>';
  }

  // Show staff salary percentages for reference
  const staffForPct = DATA.staff.filter(s => s['–ü—Ä–æ–µ–∫—Ç']==='–°–∞–π—Ç—ã' && s['–°—Ç–∞—Ç—É—Å']==='–ê–∫—Ç–∏–≤–Ω—ã–π');
  if (staffForPct.length) {
    fieldsHtml += '<div style="background:var(--bg2);border-radius:var(--radius);padding:12px;margin-bottom:8px">';
    fieldsHtml += '<div style="font-weight:600;margin-bottom:8px">üë• –ü—Ä–æ—Ü–µ–Ω—Ç—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</div>';
    staffForPct.forEach(s => {
      const pct = parseInt(s['–ü—Ä–æ—Ü–µ–Ω—Ç_–ó–ü']) || DEFAULT_SALARY_PCT[s['–†–æ–ª—å']] || 0;
      fieldsHtml += '<div style="display:flex;justify-content:space-between;align-items:center;padding:4px 0;font-size:13px">';
      fieldsHtml += '<span>'+esc(s['–ò–º—è'])+' ('+esc(s['–†–æ–ª—å'])+')</span>';
      fieldsHtml += '<span style="font-weight:600;color:var(--accent)">'+pct+'%</span>';
      fieldsHtml += '</div>';
    });
    fieldsHtml += '</div>';
  }

  fieldsHtml += '<div style="display:flex;gap:8px;margin-top:16px">';
  fieldsHtml += '<button class="btn btn-primary" onclick="savePricing()" style="flex:1">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>';
  fieldsHtml += '<button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>';
  fieldsHtml += '</div>';

  document.getElementById('modalTitle').textContent = 'üí∞ –ü—Ä–∞–π—Å-–ª–∏—Å—Ç';
  document.getElementById('modalBody').innerHTML = fieldsHtml;
  document.getElementById('modalFooter').innerHTML = '';
  document.getElementById('modalOverlay').classList.add('show');
  currentModal = 'pricing';
}

function savePricing() {
  for (const [name, p] of Object.entries(SITE_PRICING)) {
    const price = parseInt(document.getElementById('price-'+name)?.value) || p.price;
    SITE_PRICING[name].price = price;
  }
  localStorage.setItem('rkt_site_pricing', JSON.stringify(SITE_PRICING));
  closeModal();
  toast('–ü—Ä–∞–π—Å-–ª–∏—Å—Ç –æ–±–Ω–æ–≤–ª—ë–Ω', 'success');
  if (currentPvTab === 'finance') {
    document.getElementById('pv-content').innerHTML = renderSiteFinance();
  }
}

// Load saved pricing on startup
try {
  const savedPricing = JSON.parse(localStorage.getItem('rkt_site_pricing'));
  if (savedPricing) {
    for (const [name, p] of Object.entries(savedPricing)) {
      if (SITE_PRICING[name]) SITE_PRICING[name].price = p.price || SITE_PRICING[name].price;
    }
  }
} catch(e) {}

function renderSiteSalaries() {
  const fin = calcSiteFinancials();
  const staff = DATA.staff.filter(s => s['–ü—Ä–æ–µ–∫—Ç']==='–°–∞–π—Ç—ã' && s['–°—Ç–∞—Ç—É—Å']==='–ê–∫—Ç–∏–≤–Ω—ã–π');

  let html = '';

  // Staff overview
  html += '<div class="card"><div class="card-header"><h3>üë• –ö–æ–º–∞–Ω–¥–∞ ¬´–°–∞–π—Ç—ã¬ª ‚Äî –ó–∞—Ä–ø–ª–∞—Ç—ã</h3>';
  html += '<button class="btn btn-sm btn-primary" onclick="openModal(\'staff\')">+ –°–æ—Ç—Ä—É–¥–Ω–∏–∫</button></div>';
  html += '<div class="table-wrap"><table><thead><tr><th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th><th>–†–æ–ª—å</th><th>% –æ—Ç —Å–∞–π—Ç–∞</th><th>–°–∞–π—Ç–æ–≤</th><th>–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</th><th>–°—Ç–∞—Ç—É—Å</th></tr></thead><tbody>';

  if (staff.length) {
    staff.forEach(s => {
      const name = s['–ò–º—è'] || '?';
      const role = s['–†–æ–ª—å'] || '?';
      const earnings = fin.staffEarnings[name] || { pct: 0, earned: 0, sites: 0 };
      const pct = parseInt(s['–ü—Ä–æ—Ü–µ–Ω—Ç_–ó–ü']) || DEFAULT_SALARY_PCT[role] || 0;

      const bg = role === 'CEO' ? 'var(--accent)' : role === '–ó–∞–º' ? 'var(--blue)' : role === '–ú–µ–Ω–µ–¥–∂–µ—Ä' ? 'var(--orange)' : 'var(--purple)';
      html += '<tr><td><div style="display:flex;align-items:center;gap:8px">';
      html += '<div style="width:32px;height:32px;border-radius:50%;background:'+bg+';display:flex;align-items:center;justify-content:center;color:var(--bg);font-weight:700;font-size:13px">'+esc(name[0])+'</div>';
      html += '<strong>'+esc(name)+'</strong></div></td>';
      html += '<td>'+({CEO:'üëë',–ó–∞–º:'‚≠ê',–ú–µ–Ω–µ–¥–∂–µ—Ä:'üíº',–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫:'üíª',–ò–Ω–∂–µ–Ω–µ—Ä:'üîß'}[role]||'üë§')+' '+esc(role)+'</td>';
      html += '<td style="font-weight:600;color:var(--accent)">'+pct+'%</td>';
      html += '<td style="font-weight:600">'+earnings.sites+'</td>';
      html += '<td style="font-weight:700;color:var(--accent)">'+fmtMoney(earnings.earned)+'</td>';
      html += '<td>'+statusBadge(s['–°—Ç–∞—Ç—É—Å'])+'</td></tr>';
    });
  } else {
    html += emptyRow(6, '–ù–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –≤ –ø—Ä–æ–µ–∫—Ç–µ ¬´–°–∞–π—Ç—ã¬ª');
  }
  html += '</tbody></table></div></div>';
  
  // Pipeline roles
  html += '<div class="card"><div class="card-header"><h3>üîÑ –ö–æ–Ω–≤–µ–π–µ—Ä ‚Äî –†–æ–ª–∏ –≤ –ø–∞–π–ø–ª–∞–π–Ω–µ</h3></div>';
  html += '<div class="card-body"><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px">';
  SITE_PIPELINE.forEach(p => {
    const assigned = getSiteStaffByRole(p.role);
    const roleColor = p.role === 'CEO' ? 'var(--accent)' : p.role === '–ú–µ–Ω–µ–¥–∂–µ—Ä' ? 'var(--orange)' : 'var(--purple)';
    html += '<div style="background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:12px;border-left:3px solid '+roleColor+'">';
    html += '<div style="font-size:12px;color:var(--text2)">–®–∞–≥ '+p.step+'</div>';
    html += '<div style="font-weight:600;font-size:13px;margin:4px 0">'+esc(p.name)+'</div>';
    html += '<div style="font-size:11px;color:'+roleColor+'">'+esc(p.role)+' ‚Üí '+esc(assigned)+'</div>';
    if (p.auto) html += '<div style="font-size:10px;color:var(--green);margin-top:4px">‚ö° –ê–≤—Ç–æ-–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ</div>';
    html += '</div>';
  });
  html += '</div></div></div>';
  
  // Salary summary
  const totalFot = Object.values(fin.staffEarnings).reduce((s, e) => s + e.earned, 0);
  html += '<div class="card"><div class="card-header"><h3>üí∞ –ò—Ç–æ–≥–æ –§–û–¢</h3></div>';
  html += '<div class="card-body" style="text-align:center">';
  html += '<div style="font-size:28px;font-weight:700;color:var(--accent)">'+fmtMoney(totalFot)+'</div>';
  html += '<div style="color:var(--text2);margin-top:4px">–í—ã–ø–ª–∞—á–µ–Ω–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º</div>';
  html += '<div style="margin-top:12px;display:flex;gap:20px;justify-content:center">';
  html += '<div>–í—ã—Ä—É—á–∫–∞: <strong>'+fmtMoney(fin.totalRevenue)+'</strong></div>';
  html += '<div>–§–û–¢: <strong style="color:var(--orange)">'+fmtMoney(totalFot)+'</strong></div>';
  html += '<div>–ü—Ä–∏–±—ã–ª—å: <strong style="color:var(--green)">'+fmtMoney(fin.totalRevenue - totalFot)+'</strong></div>';
  html += '</div></div></div>';
  
  return html;
}

function fmtMoney(n) {
  if (!n && n !== 0) return '‚Äî';
  return new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB', maximumFractionDigits: 0 }).format(n);
}

// ============================================================
// SITE GENERATOR
// ============================================================
function renderSiteGenerator() {
  const siteGenData = getSiteGenData();
  if (siteGenStep === 'preview' && siteGenData.html) return renderSitePreview();
  if (siteGenStep === 'loading') return '<div class="card"><div class="card-body" style="text-align:center;padding:60px">' +
    '<div class="spinner" style="margin:0 auto 20px"></div><h3 style="margin-bottom:10px">ü§ñ Claude –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–∞–π—Ç...</h3>' +
    '<p style="color:var(--text2)">–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 20-30 —Å–µ–∫—É–Ω–¥</p></div></div>';

  // Pre-fill from anketa data if available
  const ankDir = (DATA.directions||[]).find(d => d['–ù–∞–∑–≤–∞–Ω–∏–µ'] === currentSubproject && d['–ü—Ä–æ–µ–∫—Ç'] === '–°–∞–π—Ç—ã');
  const av = (key) => ankDir ? esc(ankDir[key]||'') : '';

  return '<div class="card"><div class="card-header"><h3>üåê –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å–∞–π—Ç–∞ –¥–ª—è ¬´' + esc(currentSubproject) + '¬ª</h3></div>' +
    '<div class="card-body" style="padding:20px">' +
    '<p style="color:var(--text2);margin-bottom:20px">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∞–Ω–∫–µ—Ç—É ‚Äî Claude —Å–æ–∑–¥–∞—Å—Ç –≥–æ—Ç–æ–≤—ã–π —Å–∞–π—Ç-–≤–∏–∑–∏—Ç–∫—É —Å –≤–∞—à–∏–º –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º.' +
    (ankDir && (ankDir['–¢–∏–ø –±–∏–∑–Ω–µ—Å–∞'] || ankDir['–£—Å–ª—É–≥–∏']) ? ' <span style="color:var(--green)">‚úÖ –î–∞–Ω–Ω—ã–µ –∏–∑ –∞–Ω–∫–µ—Ç—ã –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</span>' : '') + '</p>' +
    '<div class="sg-form" id="sg-form">' +

    '<div class="sg-row">' +
    '<div class="sg-field"><label>–ù–∞–∑–≤–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å–∞ *</label><input type="text" id="sg-name" placeholder="–ü—ã—à–∫–∏ –º–∏—Ä–∞" value="' + esc(currentSubproject || '') + '"></div>' +
    '<div class="sg-field"><label>–¢–∏–ø –±–∏–∑–Ω–µ—Å–∞ *</label><input type="text" id="sg-type" placeholder="–†–µ—Å—Ç–æ—Ä–∞–Ω, –∫–∞—Ñ–µ, —Å–∞–ª–æ–Ω..." value="' + av('–¢–∏–ø –±–∏–∑–Ω–µ—Å–∞') + '"></div>' +
    '</div>' +

    '<div class="sg-row">' +
    '<div class="sg-field"><label>–ì–æ—Ä–æ–¥</label><input type="text" id="sg-city" placeholder="–ù–∞–±–µ—Ä–µ–∂–Ω—ã–µ –ß–µ–ª–Ω—ã" value="' + av('–ì–æ—Ä–æ–¥') + '"></div>' +
    '<div class="sg-field"><label>–ê–¥—Ä–µ—Å</label><input type="text" id="sg-address" placeholder="—É–ª. –õ–µ–Ω–∏–Ω–∞, –¥. 1" value="' + av('–ê–¥—Ä–µ—Å') + '"></div>' +
    '</div>' +

    '<div class="sg-row">' +
    '<div class="sg-field"><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input type="text" id="sg-phone" placeholder="+7 900 123-45-67" value="' + av('–¢–µ–ª–µ—Ñ–æ–Ω') + '"></div>' +
    '<div class="sg-field"><label>Instagram / –°–æ—Ü—Å–µ—Ç–∏</label><input type="text" id="sg-social" placeholder="@pyshki_mira" value="' + av('–°–æ—Ü—Å–µ—Ç–∏') + '"></div>' +
    '</div>' +

    '<div class="sg-field"><label>–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã</label><input type="text" id="sg-hours" placeholder="–ü–Ω-–ü—Ç 10:00-22:00, –°–±-–í—Å 11:00-23:00" value="' + av('–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã') + '"></div>' +

    '<div class="sg-field"><label>–û–ø–∏—Å–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å–∞ (—á–µ–º –∑–∞–Ω–∏–º–∞–µ—Ç–µ—Å—å, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏, –£–¢–ü) *</label>' +
    '<textarea id="sg-desc" rows="4" placeholder="–£—é—Ç–Ω–æ–µ –∫–∞—Ñ–µ —Å –¥–æ–º–∞—à–Ω–∏–º–∏ –ø—ã—à–∫–∞–º–∏ –∏ –∫–æ—Ñ–µ. –†–∞–±–æ—Ç–∞–µ–º —Å 2020 –≥–æ–¥–∞. –°–≤–µ–∂–∞—è –≤—ã–ø–µ—á–∫–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å...">' + av('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π') + '</textarea></div>' +

    '<div class="sg-field"><label>–£—Å–ª—É–≥–∏ / –ú–µ–Ω—é (–ø–µ—Ä–µ—á–∏—Å–ª–∏—Ç–µ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>' +
    '<textarea id="sg-services" rows="3" placeholder="–ü—ã—à–∫–∏ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ, –ü—ã—à–∫–∏ —Å –Ω–∞—á–∏–Ω–∫–æ–π, –ö–æ—Ñ–µ, –ß–∞–π, –î–µ—Å–µ—Ä—Ç—ã, –î–æ—Å—Ç–∞–≤–∫–∞...">' + av('–£—Å–ª—É–≥–∏') + '</textarea></div>' +

    '<div class="sg-field"><label>–¶–µ–Ω—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)</label>' +
    '<input type="text" id="sg-prices" placeholder="–ü—ã—à–∫–∏ –æ—Ç 50‚ÇΩ, –∫–æ—Ñ–µ –æ—Ç 150‚ÇΩ" value="' + av('–¶–µ–Ω—ã') + '"></div>' +

    '<div class="sg-row">' +
    '<div class="sg-field"><label>–¶–≤–µ—Ç–æ–≤–∞—è —Ç–µ–º–∞</label><select id="sg-theme">' +
    '<option value="auto">ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</option>' +
    '<option value="warm">üî• –¢—ë–ø–ª–∞—è (—Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã, –∫–∞—Ñ–µ)</option>' +
    '<option value="cool">‚ùÑÔ∏è –•–æ–ª–æ–¥–Ω–∞—è (–º–µ–¥–∏—Ü–∏–Ω–∞, IT)</option>' +
    '<option value="dark">üåô –¢—ë–º–Ω–∞—è (–±–∞—Ä—ã, –∫–ª—É–±—ã)</option>' +
    '<option value="nature">üåø –ü—Ä–∏—Ä–æ–¥–Ω–∞—è (—ç–∫–æ, —Å–∞–ª–æ–Ω—ã)</option>' +
    '<option value="luxury">‚ú® –ü—Ä–µ–º–∏—É–º (–±—É—Ç–∏–∫–∏, –æ—Ç–µ–ª–∏)</option>' +
    '</select></div>' +
    '<div class="sg-field"><label>–°—Ç–∏–ª—å</label><select id="sg-style">' +
    '<option value="modern">–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π</option>' +
    '<option value="minimal">–ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π</option>' +
    '<option value="retro">–†–µ—Ç—Ä–æ / –°–æ–≤–µ—Ç—Å–∫–∏–π</option>' +
    '<option value="classic">–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π</option>' +
    '<option value="playful">–Ø—Ä–∫–∏–π / –ò–≥—Ä–∏–≤—ã–π</option>' +
    '</select></div>' +
    '</div>' +

    '<div class="sg-field"><label>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è</label>' +
    '<textarea id="sg-extra" rows="2" placeholder="–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç—É, —Ñ–æ—Ä–º—É –∑–∞–∫–∞–∑–∞, –≥–∞–ª–µ—Ä–µ—é —Ñ–æ—Ç–æ..."></textarea></div>' +

    '<div style="display:flex;gap:10px;margin-top:20px">' +
    '<button class="btn btn-primary" onclick="generateSite()" style="flex:1">ü§ñ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å (–ò–ò)</button>' +
    '<button class="btn btn-secondary" onclick="generateSiteLocal()" style="flex:0 0 auto">‚ö° –ë—ã—Å—Ç—Ä—ã–π —à–∞–±–ª–æ–Ω</button>' +
    '<button class="btn btn-secondary" onclick="fillSiteDemo()" style="flex:0 0 auto">üìã –ü—Ä–∏–º–µ—Ä</button>' +
    '</div>' +
    '</div></div></div>';
}

function renderSitePreview() {
  const sgd = getSiteGenData();
  const siteHtml = sgd.html || '';
  const dir = (DATA.directions||[]).find(d => d['–ù–∞–∑–≤–∞–Ω–∏–µ'] === currentSubproject && d['–ü—Ä–æ–µ–∫—Ç'] === '–°–∞–π—Ç—ã');
  const publishedUrl = dir && dir['site_url'] ? dir['site_url'] : '';

  let h = '';
  // Top toolbar
  h += '<div class="card" style="margin-bottom:12px"><div class="card-header" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">';
  h += '<h3>üåê ' + esc(sgd.name || currentSubproject) + '</h3>';
  h += '<div style="display:flex;gap:6px;flex-wrap:wrap">';
  h += '<button class="btn btn-sm" onclick="downloadSiteHtml()">üíæ –°–∫–∞—á–∞—Ç—å</button>';
  h += '<button class="btn btn-sm" onclick="copySiteHtml()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>';
  h += '<button class="btn btn-sm" onclick="toggleSiteCodeEditor()">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>';
  h += '<button class="btn btn-sm btn-secondary" onclick="siteGenStep=\'form\';renderSubprojectView()">üìù –ê–Ω–∫–µ—Ç–∞</button>';
  h += '<button class="btn btn-sm btn-secondary" onclick="regenerateSite()">üîÑ –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>';
  h += '</div></div></div>';

  // Iframe preview
  h += '<div class="site-preview-frame"><iframe id="site-preview-iframe" sandbox="allow-scripts allow-same-origin" style="width:100%;min-height:700px;border:none;border-radius:var(--radius);background:#fff"></iframe></div>';

  // Publish section
  h += '<div class="card" style="margin-top:12px;border-color:var(--accent);border-width:2px">';
  h += '<div class="card-body" style="text-align:center;padding:24px">';
  if (publishedUrl) {
    h += '<div style="font-size:16px;font-weight:700;color:var(--green);margin-bottom:12px">‚úÖ –°–∞–π—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!</div>';
    h += '<a href="'+esc(publishedUrl)+'" target="_blank" style="color:var(--accent);font-size:14px;word-break:break-all">'+esc(publishedUrl)+'</a>';
    h += '<div style="margin-top:12px;display:flex;gap:8px;justify-content:center">';
    h += '<button class="btn btn-primary" onclick="publishSite()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –ø—É–±–ª–∏–∫–∞—Ü–∏—é</button>';
    h += '<button class="btn btn-sm" onclick="navigator.clipboard.writeText(\''+escA(publishedUrl)+'\');toast(\'–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞\',\'success\')">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>';
    h += '</div>';
  } else {
    h += '<div style="font-size:20px;margin-bottom:8px">üöÄ</div>';
    h += '<div style="font-size:16px;font-weight:700;margin-bottom:8px">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Å–∞–π—Ç</div>';
    h += '<div style="font-size:13px;color:var(--text2);margin-bottom:16px">–†–∞–∑–º–µ—Å—Ç–∏—Ç–µ —Å–∞–π—Ç –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ –æ–¥–Ω–∏–º –Ω–∞–∂–∞—Ç–∏–µ–º. –í—ã –ø–æ–ª—É—á–∏—Ç–µ –ø—É–±–ª–∏—á–Ω—É—é —Å—Å—ã–ª–∫—É –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞.</div>';
    h += '<button class="btn btn-primary" style="font-size:15px;padding:12px 32px" onclick="publishSite()">üöÄ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –Ω–∞ —Ö–æ—Å—Ç–∏–Ω–≥</button>';
  }
  h += '</div></div>';

  // Step-by-step instructions
  h += '<div class="card" style="margin-top:12px"><div class="card-body">';
  h += '<div style="font-size:14px;font-weight:700;margin-bottom:12px">üìå –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏</div>';
  h += '<div style="display:grid;gap:8px;font-size:13px">';
  h += '<div style="display:flex;gap:8px;align-items:start"><span style="background:var(--accent);color:#fff;width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;flex-shrink:0">1</span><span>–ü—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ —Å–∞–π—Ç –≤ –ø—Ä–µ–≤—å—é –≤—ã—à–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–µ–∫—Å—Ç—ã, –∫–æ–Ω—Ç–∞–∫—Ç—ã, –∞–¥—Ä–µ—Å.</span></div>';
  h += '<div style="display:flex;gap:8px;align-items:start"><span style="background:var(--accent);color:#fff;width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;flex-shrink:0">2</span><span>–ï—Å–ª–∏ –Ω—É–∂–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è ‚Äî –Ω–∞–∂–º–∏—Ç–µ <b>"–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥"</b> –∏–ª–∏ <b>"–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å"</b>.</span></div>';
  h += '<div style="display:flex;gap:8px;align-items:start"><span style="background:var(--accent);color:#fff;width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;flex-shrink:0">3</span><span>–ö–æ–≥–¥–∞ —Å–∞–π—Ç –≥–æ—Ç–æ–≤ ‚Äî –Ω–∞–∂–º–∏—Ç–µ <b>"–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –Ω–∞ —Ö–æ—Å—Ç–∏–Ω–≥"</b> —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø—É–±–ª–∏—á–Ω—É—é —Å—Å—ã–ª–∫—É.</span></div>';
  h += '<div style="display:flex;gap:8px;align-items:start"><span style="background:var(--accent);color:#fff;width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;flex-shrink:0">4</span><span>–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –∫–ª–∏–µ–Ω—Ç—É –∏–ª–∏ —Å–∫–∞—á–∞–π—Ç–µ HTML —Ñ–∞–π–ª.</span></div>';
  h += '</div></div></div>';

  // Code editor (hidden by default)
  h += '<div class="card" style="margin-top:12px;display:none" id="site-code-editor-block">';
  h += '<div class="card-header"><h3>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–æ—Ä HTML</h3>';
  h += '<div style="display:flex;gap:8px">';
  h += '<button class="btn btn-sm btn-primary" onclick="applySiteCodeChanges()">‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>';
  h += '<button class="btn btn-sm btn-secondary" onclick="toggleSiteCodeEditor()">–ó–∞–∫—Ä—ã—Ç—å</button>';
  h += '</div></div>';
  h += '<textarea id="site-code-textarea" style="width:100%;min-height:400px;padding:12px;font-family:monospace;font-size:12px;border:none;background:var(--bg2);color:var(--text);resize:vertical">' + esc(siteHtml) + '</textarea>';
  h += '</div>';

  // Source code (read-only, hidden)
  h += '<div class="card" style="margin-top:12px"><div class="card-header"><h3>üìù –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥</h3>';
  h += '<button class="btn btn-sm" onclick="toggleSiteCode()">–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å</button></div>';
  h += '<div id="site-code-block" style="display:none;padding:16px;max-height:400px;overflow:auto">';
  h += '<pre style="white-space:pre-wrap;font-size:12px;color:var(--text2)">' + esc(siteHtml) + '</pre></div></div>';

  return h;
}

function toggleSiteCodeEditor() {
  const block = document.getElementById('site-code-editor-block');
  if (block) block.style.display = block.style.display === 'none' ? 'block' : 'none';
}

function applySiteCodeChanges() {
  const textarea = document.getElementById('site-code-textarea');
  if (!textarea) return;
  const newHtml = textarea.value;
  const sgd = getSiteGenData();
  sgd.html = newHtml;
  // Update iframe
  const iframe = document.getElementById('site-preview-iframe');
  if (iframe) {
    const doc = iframe.contentDocument || iframe.contentWindow.document;
    doc.open(); doc.write(newHtml); doc.close();
  }
  // Update source code block
  const pre = document.querySelector('#site-code-block pre');
  if (pre) pre.textContent = newHtml;
  toast('–ò–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∫ –ø—Ä–µ–≤—å—é', 'success');
}

async function publishSite() {
  const sgd = getSiteGenData();
  const html = sgd.html;
  if (!html) { toast('–ù–µ—Ç HTML –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏','error'); return; }
  const dir = (DATA.directions||[]).find(d => d['–ù–∞–∑–≤–∞–Ω–∏–µ'] === currentSubproject && d['–ü—Ä–æ–µ–∫—Ç'] === '–°–∞–π—Ç—ã');
  if (!dir) { toast('–ö–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ','error'); return; }
  const dirId = dir['ID'] || dir.id;
  const fileName = (currentSubproject||'site').replace(/[^a-zA-Z–∞-—è–ê-–Ø—ë–Å0-9_-]/g, '_') + '.html';
  const filePath = 'sites/' + dirId + '/' + fileName;

  toast('–ü—É–±–ª–∏–∫–∞—Ü–∏—è...','info');
  try {
    // Upload to Supabase Storage
    const blob = new Blob([html], { type: 'text/html; charset=utf-8' });
    const { data, error } = await SB.storage.from('sites').upload(filePath, blob, {
      contentType: 'text/html',
      upsert: true
    });
    if (error) throw error;

    // Get public URL
    const { data: urlData } = SB.storage.from('sites').getPublicUrl(filePath);
    const publicUrl = urlData?.publicUrl || '';

    // Save URL and HTML to directions table
    await SB.from('directions').update({
      site_url: publicUrl,
      site_html: html.substring(0, 50000) // limit to 50KB for DB
    }).eq('id', dirId);

    toast('–°–∞–π—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!', 'success');
    await loadData();
    renderSubprojectView();
  } catch(e) {
    console.error('Publish error:', e);
    toast('–û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏: ' + (e.message || e), 'error');
    // If storage bucket doesn't exist, suggest creating it
    if (e.message && e.message.includes('not found')) {
      toast('–°–æ–∑–¥–∞–π—Ç–µ bucket "sites" –≤ Supabase Storage (Dashboard > Storage > New bucket, –ø—É–±–ª–∏—á–Ω—ã–π)', 'warning');
    }
  }
}

function fillSiteDemo() {
  const demos = {
    '–ü—ã—à–∫–∏ –º–∏—Ä–∞': {name:'–ü—ã—à–∫–∏ –º–∏—Ä–∞',type:'–ö–∞—Ñ–µ-–ø–µ–∫–∞—Ä–Ω—è',city:'–ù–∞–±–µ—Ä–µ–∂–Ω—ã–µ –ß–µ–ª–Ω—ã',address:'–ø—Ä. –ú–∏—Ä–∞, 32',phone:'+7 917 234-56-78',social:'@pyshki_mira',hours:'–ü–Ω-–í—Å 08:00-22:00',desc:'–£—é—Ç–Ω–∞—è –ø–µ–∫–∞—Ä–Ω—è —Å –¥–æ–º–∞—à–Ω–∏–º–∏ –ø—ã—à–∫–∞–º–∏ –ø–æ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–º —Ä–µ—Ü–µ–ø—Ç–∞–º. –°–≤–µ–∂–∞—è –≤—ã–ø–µ—á–∫–∞ –∫–∞–∂–¥—ã–π —á–∞—Å, –∞—Ä–æ–º–∞—Ç–Ω—ã–π –∫–æ—Ñ–µ –∏ —Ç—ë–ø–ª–∞—è –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞. –†–∞–±–æ—Ç–∞–µ–º —Å 2023 –≥–æ–¥–∞.',services:'–ü—ã—à–∫–∏ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ, –ü—ã—à–∫–∏ —Å –≤–∞—Ä–µ–Ω—å–µ–º, –ü—ã—à–∫–∏ —Å —à–æ–∫–æ–ª–∞–¥–æ–º, –ü—ã—à–∫–∏ —Å—ã—Ä–Ω—ã–µ, –ö–æ—Ñ–µ —ç—Å–ø—Ä–µ—Å—Å–æ, –ö–∞–ø—É—á–∏–Ω–æ, –õ–∞—Ç—Ç–µ, –ß–∞–π, –ö–∞–∫–∞–æ, –î–æ—Å—Ç–∞–≤–∫–∞',prices:'–ü—ã—à–∫–∏ –æ—Ç 45‚ÇΩ, –∫–æ—Ñ–µ –æ—Ç 120‚ÇΩ, –∫–æ–º–±–æ –æ—Ç 199‚ÇΩ',theme:'warm',style:'playful'},
    '–ë—Ä–µ–∂–Ω–µ–≤': {name:'–ë—Ä–µ–∂–Ω–µ–≤',type:'–†–µ—Å—Ç–æ–∫–ª—É–±',city:'–ù–∞–±–µ—Ä–µ–∂–Ω—ã–µ –ß–µ–ª–Ω—ã',address:'—É–ª. –°–æ–≤–µ—Ç—Å–∫–∞—è, 15',phone:'+7 917 345-67-89',social:'@brezhnev_club',hours:'–ü–Ω-–ß—Ç 12:00-00:00, –ü—Ç-–°–± 12:00-03:00, –í—Å 12:00-22:00',desc:'–†–µ—Å—Ç–æ–∫–ª—É–± –≤ —Å–æ–≤–µ—Ç—Å–∫–æ–º —Å—Ç–∏–ª–µ. –ê—Ç–º–æ—Å—Ñ–µ—Ä–∞ –°–°–°–†: —Ä–µ—Ç—Ä–æ-–∏–Ω—Ç–µ—Ä—å–µ—Ä, –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—Å–∫–∏–µ –±–ª—é–¥–∞ –∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –∫—É—Ö–Ω—è. –ñ–∏–≤–∞—è –º—É–∑—ã–∫–∞ –ø–æ –ø—è—Ç–Ω–∏—Ü–∞–º.',services:'–û–±–µ–¥—ã, –£–∂–∏–Ω—ã, –ë–∞–Ω–∫–µ—Ç—ã, –ö–∞—Ä–∞–æ–∫–µ, –ñ–∏–≤–∞—è –º—É–∑—ã–∫–∞, –ë–∞—Ä, –ö–∞–ª—å—è–Ω, –ü—Ä–æ–≤–µ–¥–µ–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π',prices:'–°—Ä–µ–¥–Ω–∏–π —á–µ–∫ 1200‚ÇΩ, –±–∏–∑–Ω–µ—Å-–ª–∞–Ω—á 350‚ÇΩ',theme:'dark',style:'retro'},
  };
  const demo = demos[currentSubproject] || demos['–ü—ã—à–∫–∏ –º–∏—Ä–∞'];
  Object.keys(demo).forEach(k => {
    const el = document.getElementById('sg-' + k);
    if (el) el.value = demo[k];
  });
  toast('–ü—Ä–∏–º–µ—Ä –∑–∞–ø–æ–ª–Ω–µ–Ω!','success');
}

async function generateSite() {
  const name = document.getElementById('sg-name')?.value?.trim();
  const type = document.getElementById('sg-type')?.value?.trim();
  const desc = document.getElementById('sg-desc')?.value?.trim();
  if (!name || !type || !desc) { toast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (*)','error'); return; }

  const sgd = getSiteGenData();
  Object.assign(sgd, {
    name, type, desc,
    city: document.getElementById('sg-city')?.value?.trim() || '',
    address: document.getElementById('sg-address')?.value?.trim() || '',
    phone: document.getElementById('sg-phone')?.value?.trim() || '',
    social: document.getElementById('sg-social')?.value?.trim() || '',
    hours: document.getElementById('sg-hours')?.value?.trim() || '',
    services: document.getElementById('sg-services')?.value?.trim() || '',
    prices: document.getElementById('sg-prices')?.value?.trim() || '',
    theme: document.getElementById('sg-theme')?.value || 'auto',
    style: document.getElementById('sg-style')?.value || 'modern',
    extra: document.getElementById('sg-extra')?.value?.trim() || ''
  });
  // Add logo/photos + anketa data from direction record
  const genDir = (DATA.directions||[]).find(d => d['–ù–∞–∑–≤–∞–Ω–∏–µ'] === currentSubproject && d['–ü—Ä–æ–µ–∫—Ç'] === '–°–∞–π—Ç—ã');
  if (genDir) {
    sgd.logo = genDir['logo_url'] || '';
    sgd.photos = genDir['photos'] || '';
    // Merge anketa data (only if form fields are empty)
    if (!sgd.city && genDir['–ì–æ—Ä–æ–¥']) sgd.city = genDir['–ì–æ—Ä–æ–¥'];
    if (!sgd.phone && genDir['–¢–µ–ª–µ—Ñ–æ–Ω']) sgd.phone = genDir['–¢–µ–ª–µ—Ñ–æ–Ω'];
    if (!sgd.address && genDir['–ê–¥—Ä–µ—Å']) sgd.address = genDir['–ê–¥—Ä–µ—Å'];
    if (!sgd.social && genDir['–°–æ—Ü—Å–µ—Ç–∏']) sgd.social = genDir['–°–æ—Ü—Å–µ—Ç–∏'];
    if (!sgd.hours && genDir['–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã']) sgd.hours = genDir['–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã'];
    if (!sgd.services && genDir['–£—Å–ª—É–≥–∏']) sgd.services = genDir['–£—Å–ª—É–≥–∏'];
    if (!sgd.prices && genDir['–¶–µ–Ω—ã']) sgd.prices = genDir['–¶–µ–Ω—ã'];
    if (!sgd.desc || sgd.desc === name) {
      // Enhance description with business type from anketa
      const bizType = genDir['–¢–∏–ø –±–∏–∑–Ω–µ—Å–∞'] || '';
      if (bizType) sgd.desc = bizType + '. ' + sgd.desc;
    }
    // Parse questionnaire JSON for any additional info
    try {
      const q = JSON.parse(genDir['–ê–Ω–∫–µ—Ç–∞'] || '{}');
      if (q.wishes && !sgd.extra) sgd.extra = q.wishes;
    } catch(e) {}
  }
  siteGenStep = 'loading';
  renderSubprojectView();

  try {
    const prompt = buildSitePrompt(sgd);
    const ctrl = new AbortController();
    const tmr = setTimeout(() => ctrl.abort(), 180000);
    
    let response;
    try {
      response = await fetch(CONFIG.AI_URL, {
        method: 'POST', signal: ctrl.signal,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: prompt, direction: currentSubproject, user: USER?.name || '', source: 'web' })
      });
      if (!response.ok) throw new Error('HTTP ' + response.status);
    } catch(e) {
      // For site generation, GET won't work (URL too long) ‚Äî only POST
      throw new Error('–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ Web AI workflow –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –≤ n8n. (' + e.message + ')');
    }
    clearTimeout(tmr);

    const raw2 = await response.json();
    let data2 = raw2; if (Array.isArray(raw2)) data2 = raw2[0]||{}; if (data2.json) data2 = data2.json;
    let html = data2.reply || data2.response || data2.text || '';
    
    // Extract HTML from response (Claude may wrap it in ```html blocks)
    const htmlMatch = html.match(/```html\s*([\s\S]*?)```/);
    if (htmlMatch) html = htmlMatch[1].trim();
    else if (!html.trim().startsWith('<!') && !html.trim().startsWith('<html')) {
      // If no HTML detected, try extracting between tags
      const startIdx = html.indexOf('<!DOCTYPE') !== -1 ? html.indexOf('<!DOCTYPE') : html.indexOf('<html');
      if (startIdx !== -1) html = html.substring(startIdx);
    }

    sgd.html = html;
    siteGenStep = 'preview';
    renderSubprojectView();
    
    // Load into iframe
    setTimeout(() => {
      const iframe = document.getElementById('site-preview-iframe');
      if (iframe) {
        const iDoc = iframe.contentDocument || iframe.contentWindow.document;
        iDoc.open(); iDoc.write(html); iDoc.close();
        // Auto-resize iframe
        setTimeout(() => {
          try { iframe.style.height = Math.max(700, iDoc.body.scrollHeight + 50) + 'px'; } catch(e){}
        }, 500);
      }
    }, 100);
    toast('–°–∞–π—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω!','success');
  } catch(e) {
    // Fallback: generate site locally with template
    const fallbackHtml = generateLocalSite(sgd);
    if (fallbackHtml) {
      sgd.html = fallbackHtml;
      siteGenStep = 'preview';
      renderSubprojectView();
      setTimeout(() => {
        const iframe = document.getElementById('site-preview-iframe');
        if (iframe) {
          const iDoc = iframe.contentDocument || iframe.contentWindow.document;
          iDoc.open(); iDoc.write(fallbackHtml); iDoc.close();
        }
      }, 100);
      toast('‚ö†Ô∏è –ò–ò –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –°–æ–∑–¥–∞–Ω —à–∞–±–ª–æ–Ω–Ω—ã–π —Å–∞–π—Ç. –ú–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é.','warning');
    } else {
      siteGenStep = 'form';
      renderSubprojectView();
      toast('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: ' + e.message,'error');
    }
  }
}

function generateLocalSite(d) {
  const themes = {
    warm: {bg:'#FFF8F0',primary:'#E85D04',secondary:'#F48C06',text:'#370617',hero:'linear-gradient(135deg,#E85D04,#F48C06)'},
    cool: {bg:'#F0F4F8',primary:'#1E88E5',secondary:'#42A5F5',text:'#1A237E',hero:'linear-gradient(135deg,#1565C0,#42A5F5)'},
    dark: {bg:'#1a1a2e',primary:'#e94560',secondary:'#0f3460',text:'#eee',hero:'linear-gradient(135deg,#16213e,#0f3460)'},
    nature:{bg:'#F1F8E9',primary:'#2E7D32',secondary:'#66BB6A',text:'#1B5E20',hero:'linear-gradient(135deg,#2E7D32,#66BB6A)'},
    luxury:{bg:'#FFF8E1',primary:'#BF953F',secondary:'#FCF6BA',text:'#3E2723',hero:'linear-gradient(135deg,#BF953F,#AA771C)'},
    auto:  {bg:'#F8F9FA',primary:'#00d4aa',secondary:'#4dabf7',text:'#212529',hero:'linear-gradient(135deg,#00d4aa,#4dabf7)'}
  };
  const t = themes[d.theme] || themes.auto;
  const svc = (d.services||'').split(',').map(s=>s.trim()).filter(Boolean);
  const svcHtml = svc.length ? svc.map(s=>'<div style="background:white;padding:20px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08);text-align:center"><div style="font-size:28px;margin-bottom:8px">‚ú®</div><h3 style="margin:0;font-size:16px">'+s+'</h3></div>').join('') : '';
  
  return `<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>${d.name||'–°–∞–π—Ç'}</title>
<meta name="description" content="${(d.desc||'').substring(0,160)}">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Inter',sans-serif;color:${t.text};background:${t.bg}}
.hero{background:${t.hero};color:white;padding:100px 20px;text-align:center}
.hero h1{font-size:clamp(28px,5vw,48px);margin-bottom:16px}
.hero p{font-size:18px;opacity:.9;max-width:600px;margin:0 auto 30px}
.btn{display:inline-block;padding:14px 32px;background:white;color:${t.primary};border-radius:50px;text-decoration:none;font-weight:700;transition:.3s;margin:6px}
.btn:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,0,0,.15)}
.btn-outline{background:transparent;border:2px solid white;color:white}
section{padding:60px 20px;max-width:1000px;margin:0 auto}
h2{font-size:28px;text-align:center;margin-bottom:30px;color:${t.primary}}
.services{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;padding:20px 0}
.contact{background:${t.primary};color:white;padding:50px 20px;text-align:center;border-radius:0}
.contact a{color:white;text-decoration:none;font-size:20px;display:block;margin:8px 0}
footer{text-align:center;padding:20px;font-size:13px;color:#888;background:#111;color:#666}
</style></head><body>
<div class="hero">
<h1>${d.name||'–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å'}</h1>
<p>${d.desc||d.type||''}</p>
${d.phone?'<a href="tel:'+d.phone+'" class="btn">üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</a>':''}
<a href="#contact" class="btn btn-outline">–°–≤—è–∑–∞—Ç—å—Å—è</a>
</div>
${d.desc?'<section><h2>–û –Ω–∞—Å</h2><p style="text-align:center;max-width:700px;margin:0 auto;line-height:1.8">'+d.desc+'</p></section>':''}
${svcHtml?'<section><h2>–£—Å–ª—É–≥–∏</h2><div class="services">'+svcHtml+'</div></section>':''}
${d.prices?'<section><h2>–¶–µ–Ω—ã</h2><p style="text-align:center;font-size:18px">'+d.prices+'</p></section>':''}
<div class="contact" id="contact">
<h2 style="color:white">–ö–æ–Ω—Ç–∞–∫—Ç—ã</h2>
${d.phone?'<a href="tel:'+d.phone+'">üìû '+d.phone+'</a>':''}
${d.address?'<p style="margin:12px 0">üìç '+(d.city?d.city+', ':'')+d.address+'</p>':''}
${d.hours?'<p style="margin:12px 0">üïê '+d.hours+'</p>':''}
${d.social?'<p style="margin:12px 0">üì± '+d.social+'</p>':''}
</div>
<footer>¬© ${new Date().getFullYear()} ${d.name||''} ¬∑ –°–¥–µ–ª–∞–Ω–æ –≤ RKT Hub</footer>
</body></html>`;
}

function regenerateSite() { siteGenStep = 'form'; renderSubprojectView(); setTimeout(generateSite, 100); }

function buildSitePrompt(d) {
  return `–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –≤–µ–±-—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫. –°–æ–∑–¥–∞–π –ü–û–õ–ù–´–ô, –ë–û–õ–¨–®–û–ô, –ö–ê–ß–ï–°–¢–í–ï–ù–ù–´–ô –æ–¥–Ω–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã–π —Å–∞–π—Ç (landing page) –≤ –û–î–ù–û–ú HTML —Ñ–∞–π–ª–µ.
–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û HTML –∫–æ–¥. –ë–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π. –ë–µ–∑ \`\`\`html –æ–±—ë—Ä—Ç–∫–∏. –ù–∞—á–∏–Ω–∞–π —Å—Ä–∞–∑—É —Å <!DOCTYPE html>.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
–î–ê–ù–ù–´–ï –ë–ò–ó–ù–ï–°–ê:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
- –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏: ${d.name}
- –¢–∏–ø –±–∏–∑–Ω–µ—Å–∞: ${d.type}
- –ì–æ—Ä–æ–¥: ${d.city || '–Ω–µ —É–∫–∞–∑–∞–Ω'}
- –ê–¥—Ä–µ—Å: ${d.address || '–Ω–µ —É–∫–∞–∑–∞–Ω'}
- –¢–µ–ª–µ—Ñ–æ–Ω: ${d.phone || '–Ω–µ —É–∫–∞–∑–∞–Ω'}
- –°–æ—Ü—Å–µ—Ç–∏: ${d.social || '–Ω–µ—Ç'}
- –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã: ${d.hours || '–Ω–µ —É–∫–∞–∑–∞–Ω'}
- –û–ø–∏—Å–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å–∞: ${d.desc}
- –£—Å–ª—É–≥–∏/–¢–æ–≤–∞—Ä—ã: ${d.services || '–Ω–µ —É–∫–∞–∑–∞–Ω—ã'}
- –¶–µ–Ω—ã: ${d.prices || '–Ω–µ —É–∫–∞–∑–∞–Ω—ã'}
- –¶–≤–µ—Ç–æ–≤–∞—è —Ç–µ–º–∞: ${d.theme}
- –°—Ç–∏–ª—å –¥–∏–∑–∞–π–Ω–∞: ${d.style}
- –ü–æ–∂–µ–ª–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞: ${d.extra || '–Ω–µ—Ç'}
- –õ–æ–≥–æ—Ç–∏–ø (URL): ${d.logo || '–Ω–µ—Ç'}
- –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ (URLs): ${d.photos || '–Ω–µ—Ç'}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï –°–ï–ö–¶–ò–ò (–º–∏–Ω–∏–º—É–º 10):
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
1. **HEADER** ‚Äî —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è —Å –ª–æ–≥–æ—Ç–∏–ø–æ–º (—Ç–µ–∫—Å—Ç), –º–µ–Ω—é-—Å—Å—ã–ª–∫–∞–º–∏ –Ω–∞ —Å–µ–∫—Ü–∏–∏, –∫–Ω–æ–ø–∫–æ–π CTA –∏ –º–æ–±–∏–ª—å–Ω—ã–º –±—É—Ä–≥–µ—Ä-–º–µ–Ω—é
2. **HERO** ‚Äî –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π –±–∞–Ω–Ω–µ—Ä —Å –∫—Ä—É–ø–Ω—ã–º –∑–∞–≥–æ–ª–æ–≤–∫–æ–º (H1), –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–æ–º, –æ–ø–∏—Å–∞–Ω–∏–µ–º –Ω–∞ 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, 2 –∫–Ω–æ–ø–∫–∏ (–æ—Å–Ω–æ–≤–Ω–∞—è + –≤—Ç–æ—Ä–∏—á–Ω–∞—è). –§–æ–Ω–æ–≤—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç –∏–ª–∏ –ø–∞—Ç—Ç–µ—Ä–Ω
3. **–û –ù–ê–°** ‚Äî –±–ª–æ–∫ –Ω–∞ 150+ —Å–ª–æ–≤ —Å –∏—Å—Ç–æ—Ä–∏–µ–π –∫–æ–º–ø–∞–Ω–∏–∏, –º–∏—Å—Å–∏–µ–π, 3-4 –∫–∞—Ä—Ç–æ—á–∫–∏ —Å –∏–∫–æ–Ω–∫–∞–º–∏ (–æ–ø—ã—Ç, –∫–ª–∏–µ–Ω—Ç—ã, –ø—Ä–æ–µ–∫—Ç—ã, –Ω–∞–≥—Ä–∞–¥—ã). –ü—Ä–∏–¥—É–º–∞–π —É–±–µ–¥–∏—Ç–µ–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç
4. **–£–°–õ–£–ì–ò** ‚Äî –º–∏–Ω–∏–º—É–º 6 –∫–∞—Ä—Ç–æ—á–µ–∫ —É—Å–ª—É–≥ —Å –∏–∫–æ–Ω–∫–∞–º–∏ (–∏—Å–ø–æ–ª—å–∑—É–π HTML entities/emoji), –∑–∞–≥–æ–ª–æ–≤–∫–æ–º, –æ–ø–∏—Å–∞–Ω–∏–µ–º –Ω–∞ 2-3 —Å—Ç—Ä–æ–∫–∏ –∏ –∫–Ω–æ–ø–∫–æ–π "–ü–æ–¥—Ä–æ–±–Ω–µ–µ"
5. **–ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê** ‚Äî 4-6 –ø—É–Ω–∫—Ç–æ–≤ –ø–æ—á–µ–º—É –≤—ã–±–∏—Ä–∞—é—Ç –Ω–∞—Å: –∏–∫–æ–Ω–∫–∞ + –∑–∞–≥–æ–ª–æ–≤–æ–∫ + —Ç–µ–∫—Å—Ç. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–µ—Ç–∫—É 2x3 –∏–ª–∏ 3x2
6. **–ì–ê–õ–ï–†–ï–Ø/–ü–û–†–¢–§–û–õ–ò–û** ‚Äî –º–∏–Ω–∏–º—É–º 6 –∫–∞—Ä—Ç–æ—á–µ–∫ —Å CSS-–≥—Ä–∞–¥–∏–µ–Ω—Ç–∞–º–∏ –∫–∞–∫ –∑–∞–≥–ª—É—à–∫–∞–º–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (—Ü–≤–µ—Ç–Ω—ã–µ –±–ª–æ–∫–∏ 300x200), —Å hover-—ç—Ñ—Ñ–µ–∫—Ç–∞–º–∏
7. **–û–¢–ó–´–í–´** ‚Äî 3-4 –æ—Ç–∑—ã–≤–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ (–ø—Ä–∏–¥—É–º–∞–π —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ), –∫–∞—Ä—É—Å–µ–ª—å –∏–ª–∏ —Å–µ—Ç–∫–∞, —Å –∏–º–µ–Ω–µ–º, –¥–æ–ª–∂–Ω–æ—Å—Ç—å—é, —Ç–µ–∫—Å—Ç–æ–º –æ—Ç–∑—ã–≤–∞ –∏ —Ä–µ–π—Ç–∏–Ω–≥–æ–º –∑–≤—ë–∑–¥–∞–º–∏
8. **–¶–ï–ù–´** ‚Äî –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω—ã: —Ç–∞–±–ª–∏—Ü–∞ —Ç–∞—Ä–∏—Ñ–æ–≤ (3 –∫–æ–ª–æ–Ω–∫–∏ ‚Äî –±–∞–∑–æ–≤—ã–π, —Å—Ç–∞–Ω–¥–∞—Ä—Ç, –ø—Ä–µ–º–∏—É–º), –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî –±–ª–æ–∫ "–ü–æ–ª—É—á–∏—Ç–µ –±–µ—Å–ø–ª–∞—Ç–Ω—É—é –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é"
9. **FAQ** ‚Äî 5-6 –∞–∫–∫–æ—Ä–¥–µ–æ–Ω-–≤–æ–ø—Ä–æ—Å–æ–≤ —Å —Ä–∞—Å–∫—Ä—ã–≤–∞—é—â–∏–º–∏—Å—è –æ—Ç–≤–µ—Ç–∞–º–∏ (–Ω–∞ JS)
10. **–ö–û–ù–¢–ê–ö–¢–´** ‚Äî —Ç–µ–ª–µ—Ñ–æ–Ω (–∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–π tel:), –∞–¥—Ä–µ—Å, email, —Å–æ—Ü—Å–µ—Ç–∏, —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã. –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç–∞ iframe –µ—Å–ª–∏ –µ—Å—Ç—å –∞–¥—Ä–µ—Å. –§–æ—Ä–º–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ (–∏–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω, —Å–æ–æ–±—â–µ–Ω–∏–µ)
11. **FOOTER** ‚Äî –ª–æ–≥–æ—Ç–∏–ø, –Ω–∞–≤–∏–≥–∞—Ü–∏—è, –∫–æ–Ω—Ç–∞–∫—Ç—ã, –∫–æ–ø–∏—Ä–∞–π—Ç —Å —Ç–µ–∫—É—â–∏–º –≥–æ–¥–æ–º, —Å—Å—ã–ª–∫–∏ –Ω–∞ —Å–æ—Ü—Å–µ—Ç–∏

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
–¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –î–ò–ó–ê–ô–ù–£ –ò –ö–û–î–£:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
- CSS: –º–∏–Ω–∏–º—É–º 500 —Å—Ç—Ä–æ–∫. –ò—Å–ø–æ–ª—å–∑—É–π CSS-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (:root), –≥—Ä–∞–¥–∏–µ–Ω—Ç—ã, box-shadow, border-radius
- –ê–Ω–∏–º–∞—Ü–∏–∏: CSS transitions –Ω–∞ hover –¥–ª—è –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ –∏ –∫–∞—Ä—Ç–æ—á–µ–∫, IntersectionObserver –¥–ª—è –ø–æ—è–≤–ª–µ–Ω–∏—è —Å–µ–∫—Ü–∏–π –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ (fade-in + slide-up)
- –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å: media queries –¥–ª—è 1200px, 768px, 480px. –ù–∞ –º–æ–±–∏–ª—å–Ω–æ–º ‚Äî –±—É—Ä–≥–µ—Ä-–º–µ–Ω—é, –æ–¥–Ω–æ–∫–æ–ª–æ–Ω–æ—á–Ω–∞—è —Ä–∞—Å–∫–ª–∞–¥–∫–∞
- –®—Ä–∏—Ñ—Ç—ã: Google Fonts ‚Äî Montserrat –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤, Inter –¥–ª—è —Ç–µ–∫—Å—Ç–∞
- –¶–≤–µ—Ç–∞: —Å–æ–∑–¥–∞–π –ø–∞–ª–∏—Ç—Ä—É –∏–∑ 5 —Ü–≤–µ—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–º—ã "${d.theme}" (–æ—Å–Ω–æ–≤–Ω–æ–π, –∞–∫—Ü–µ–Ω—Ç, —Ñ–æ–Ω, —Ç–µ–∫—Å—Ç, —Ç–µ–∫—Å—Ç-–≤—Ç–æ—Ä–∏—á–Ω—ã–π)
- –ö–Ω–æ–ø–∫–∏: –º–∏–Ω–∏–º—É–º 2 —Å—Ç–∏–ª—è (primary —Å –∑–∞–ª–∏–≤–∫–æ–π, secondary —Å –æ–±–≤–æ–¥–∫–æ–π), hover-–∞–Ω–∏–º–∞—Ü–∏—è, border-radius
- –ü–ª–∞–≤–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞: scroll-behavior: smooth + JS –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
- –ö–Ω–æ–ø–∫–∞ "–ù–∞–≤–µ—Ä—Ö": –ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ –≤–Ω–∏–∑
- Favicon: SVG emoji –≤ base64
- SEO: –ø–æ–ª–Ω—ã–µ meta tags (title, description, og:title, og:description, viewport)
- –í—Å–µ —Ç–µ–∫—Å—Ç—ã –Ω–∞ –†–£–°–°–ö–û–ú —è–∑—ã–∫–µ
- –ú–∏–Ω–∏–º—É–º 1000 —Å—Ç—Ä–æ–∫ HTML+CSS+JS –∫–æ–¥–∞
- –ë–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∫—Ä–æ–º–µ Google Fonts

–ö–†–ò–¢–ò–ß–ù–û: –°–∞–π—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ë–û–õ–¨–®–ò–ú –∏ –î–ï–¢–ê–õ–ò–ó–ò–†–û–í–ê–ù–ù–´–ú. –ö–∞–∂–¥–∞—è —Å–µ–∫—Ü–∏—è –¥–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç (–Ω–µ placeholder). –ü—Ä–∏–¥—É–º–∞–π —É–±–µ–¥–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã –¥–ª—è –±–∏–∑–Ω–µ—Å–∞ "${d.name}" –≤ —Å—Ñ–µ—Ä–µ "${d.type}".

${d.logo ? '–õ–û–ì–û–¢–ò–ü: –ò—Å–ø–æ–ª—å–∑—É–π <img src="' + d.logo + '"> –≤ —à–∞–ø–∫–µ –≤–º–µ—Å—Ç–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ª–æ–≥–æ—Ç–∏–ø–∞.' : ''}
${d.photos ? '–§–û–¢–û–ì–†–ê–§–ò–ò: –ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–∏ —Ä–µ–∞–ª—å–Ω—ã–µ —Ñ–æ—Ç–æ –≤–º–µ—Å—Ç–æ –∑–∞–≥–ª—É—à–µ–∫ –≤ –≥–∞–ª–µ—Ä–µ–µ/–ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ: ' + d.photos : ''}

–í–µ—Ä–Ω–∏ –ü–û–õ–ù–´–ô —Ä–∞–±–æ—á–∏–π HTML —Ñ–∞–π–ª.`;
}

function generateSiteLocal() {
  const name = document.getElementById('sg-name')?.value?.trim();
  const type = document.getElementById('sg-type')?.value?.trim();
  const desc = document.getElementById('sg-desc')?.value?.trim();
  if (!name || !type || !desc) { toast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (*)','error'); return; }
  const sgd = getSiteGenData();
  Object.assign(sgd, {
    name, type, desc,
    city: document.getElementById('sg-city')?.value?.trim() || '',
    address: document.getElementById('sg-address')?.value?.trim() || '',
    phone: document.getElementById('sg-phone')?.value?.trim() || '',
    social: document.getElementById('sg-social')?.value?.trim() || '',
    hours: document.getElementById('sg-hours')?.value?.trim() || '',
    services: document.getElementById('sg-services')?.value?.trim() || '',
    prices: document.getElementById('sg-prices')?.value?.trim() || '',
    theme: document.getElementById('sg-theme')?.value || 'auto',
    style: document.getElementById('sg-style')?.value || 'modern',
    extra: document.getElementById('sg-extra')?.value?.trim() || ''
  });
  sgd.html = generateLocalSite(sgd);
  siteGenStep = 'preview';
  renderSubprojectView();
  setTimeout(() => {
    const iframe = document.getElementById('site-preview-iframe');
    if (iframe) {
      const iDoc = iframe.contentDocument || iframe.contentWindow.document;
      iDoc.open(); iDoc.write(sgd.html); iDoc.close();
    }
  }, 100);
  toast('‚ö° –®–∞–±–ª–æ–Ω–Ω—ã–π —Å–∞–π—Ç —Å–æ–∑–¥–∞–Ω! –ú–æ–∂–Ω–æ —Å–∫–∞—á–∞—Ç—å –∏–ª–∏ –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ –ò–ò.','success');
}

function downloadSiteHtml() {
  const sgDl = getSiteGenData();
  if (!sgDl.html) return;
  const blob = new Blob([sgDl.html], {type:'text/html'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = (sgDl.name || 'site').replace(/\s/g,'_') + '.html';
  a.click(); URL.revokeObjectURL(a.href);
  toast('HTML —Å–∫–∞—á–∞–Ω!','success');
}

function copySiteHtml() {
  const sgCp = getSiteGenData();
  if (!sgCp.html) return;
  navigator.clipboard.writeText(sgCp.html).then(() => toast('–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!','success')).catch(() => toast('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è','error'));
}

function toggleSiteCode() {
  const el = document.getElementById('site-code-block');
  if (el) el.style.display = el.style.display === 'none' ? 'block' : 'none';
}

function initSiteGenerator() {
  // Reset to form if no cached data for this subproject
  const sgInit = getSiteGenData();
  if (!sgInit.html) siteGenStep = 'form';
  else {
    siteGenStep = 'preview';
    // Reload cached HTML into iframe
    setTimeout(() => {
      const iframe = document.getElementById('site-preview-iframe');
      if (iframe && sgInit.html) {
        const iDoc = iframe.contentDocument || iframe.contentWindow.document;
        iDoc.open(); iDoc.write(sgInit.html); iDoc.close();
        setTimeout(() => {
          try { iframe.style.height = Math.max(700, iDoc.body.scrollHeight + 50) + 'px'; } catch(e){}
        }, 500);
      }
    }, 200);
  }
  // Auto-fill from direction/client record
  const dir = (DATA.directions||[]).find(d => (d['–ù–∞–∑–≤–∞–Ω–∏–µ']||d['name']) === currentSubproject && d['–ü—Ä–æ–µ–∫—Ç']==='–°–∞–π—Ç—ã');
  if (dir) {
    setTimeout(() => {
      const fill = (id, val) => { const el = document.getElementById(id); if (el && !el.value && val) el.value = val; };
      fill('sg-name', dir['–ù–∞–∑–≤–∞–Ω–∏–µ'] || currentSubproject);
      fill('sg-type', dir['–û–ø–∏—Å–∞–Ω–∏–µ'] || dir['–í–∏–¥ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏'] || '');
      fill('sg-city', dir['–ì–æ—Ä–æ–¥'] || '');
      fill('sg-phone', dir['–¢–µ–ª–µ—Ñ–æ–Ω'] || '');
      fill('sg-desc', dir['–£—Å–ª—É–≥–∏'] || '');
      fill('sg-services', dir['–£—Å–ª—É–≥–∏'] || '');
      fill('sg-extra', dir['–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π'] || dir['–ü–æ–∂–µ–ª–∞–Ω–∏—è'] || '');
      fill('sg-address', dir['–ê–¥—Ä–µ—Å'] || '');
      fill('sg-social', dir['–°–æ—Ü—Å–µ—Ç–∏'] || dir['Instagram'] || '');
      fill('sg-hours', dir['–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã'] || dir['–ì—Ä–∞—Ñ–∏–∫'] || '');
    }, 100);
  } else {
    const nameEl = document.getElementById('sg-name');
    if (nameEl && !nameEl.value) nameEl.value = currentSubproject || '';
  }
}

// ============================================================
// FILES / DOCUMENTS SECTION
// ============================================================
function renderFilesSection() {
  const docs = (DATA.documents || []).filter(d => {
    const folder = (d['–ü–∞–ø–∫–∞']||'').toLowerCase();
    const sp = (currentSubproject||'').toLowerCase();
    return folder.includes(sp) || (d['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'').toLowerCase() === sp;
  });
  
  let html = '<div class="card"><div class="card-header" style="display:flex;justify-content:space-between;align-items:center">' +
    '<h3>üìÑ –î–æ–∫—É–º–µ–Ω—Ç—ã –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è ¬´' + esc(currentSubproject) + '¬ª</h3>' +
    '<div style="display:flex;gap:8px">' +
    '<button class="btn btn-sm btn-primary" onclick="uploadFileWeb()">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</button>' +
    '<button class="btn btn-sm btn-secondary" onclick="openAiFileModal()">ü§ñ –°–æ–∑–¥–∞—Ç—å —á–µ—Ä–µ–∑ –ò–ò</button>' +
    '</div></div>';

  if (!docs.length) {
    html += '<div class="card-body" style="padding:40px;text-align:center">' +
      '<div style="font-size:48px;margin-bottom:12px">üìÅ</div>' +
      '<p style="color:var(--text2)">–î–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p>' +
      '<p style="color:var(--text3);font-size:13px;margin-top:8px">–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª –±–æ—Ç—É –≤ Telegram ‚Äî –æ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç –µ–≥–æ –≤ Google Drive –∏ –ø—Ä–∏–≤—è–∂–µ—Ç –∫ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é</p>' +
      '</div>';
  } else {
    html += '<div class="table-wrap"><table><thead><tr><th>üìÑ –§–∞–π–ª</th><th>üìÅ –ü–∞–ø–∫–∞</th><th>üë§ –ó–∞–≥—Ä—É–∑–∏–ª</th><th>üìÖ –î–∞—Ç–∞</th><th>üîó</th></tr></thead><tbody>';
    docs.forEach(d => {
      const icon = getFileIcon(d['–§–∞–π–ª'] || '');
      const link = d['–°—Å—ã–ª–∫–∞'] ? '<a href="'+esc(d['–°—Å—ã–ª–∫–∞'])+'" target="_blank" style="color:var(--accent)">–û—Ç–∫—Ä—ã—Ç—å</a>' : '‚Äî';
      html += '<tr><td>' + icon + ' ' + esc(d['–§–∞–π–ª']||'‚Äî') + '</td><td>' + esc(d['–ü–∞–ø–∫–∞']||'‚Äî') + '</td><td>' + esc(d['–ó–∞–≥—Ä—É–∑–∏–ª']||'‚Äî') + '</td><td>' + esc(d['–î–∞—Ç–∞']||'‚Äî') + '</td><td>' + link + '</td></tr>';
    });
    html += '</tbody></table></div>';
  }
  html += '</div>';

  // Upload via web form (hidden)
  html += '<input type="file" id="file-upload-input" style="display:none" onchange="handleFileUpload(this)" multiple>';
  
  return html;
}

function getFileIcon(name) {
  const ext = (name.split('.').pop() || '').toLowerCase();
  const icons = {pdf:'üìï',doc:'üìò',docx:'üìò',xls:'üìó',xlsx:'üìó',ppt:'üìô',pptx:'üìô',jpg:'üñº',jpeg:'üñº',png:'üñº',gif:'üñº',mp4:'üé¨',mov:'üé¨',zip:'üì¶',rar:'üì¶',txt:'üìù',csv:'üìä'};
  return icons[ext] || 'üìÑ';
}

function uploadFileWeb() {
  document.getElementById('file-upload-input')?.click();
}

async function handleFileUpload(input) {
  if (!input.files || !input.files.length) return;
  // Validate each file
  for (var fi = 0; fi < input.files.length; fi++) {
    var vf = input.files[fi];
    if (vf.size > MAX_FILE_SIZE) {
      toast('–§–∞–π–ª ¬´' + vf.name + '¬ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. 10 –ú–ë)', 'error');
      input.value = ''; return;
    }
    if (ALLOWED_FILE_TYPES.length && ALLOWED_FILE_TYPES.indexOf(vf.type) < 0 && !/\.(pdf|doc|docx|xls|xlsx|jpg|jpeg|png|gif|webp|txt|csv|zip)$/i.test(vf.name)) {
      toast('–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ç–∏–ø —Ñ–∞–π–ª–∞: ' + vf.name, 'error');
      input.value = ''; return;
    }
  }
  
  for (const file of input.files) {
    toast('üì§ –ó–∞–≥—Ä—É–∑–∫–∞: ' + file.name + '...','info');
    
    try {
      const folder = (currentSubproject || '–û–±—â–µ–µ').replace(/[^a-zA-Z–∞-—è–ê-–Ø0-9_ -]/g, '');
      const timestamp = Date.now();
      const safeName = file.name.replace(/[^a-zA-Z–∞-—è–ê-–Ø0-9._-]/g, '_');
      const path = folder + '/' + timestamp + '_' + safeName;
      
      // 1. Upload to Supabase Storage
      const { data: uploadData, error: uploadErr } = await SB.storage
        .from('documents')
        .upload(path, file, { contentType: file.type, upsert: false });
      
      if (uploadErr) throw uploadErr;
      
      // 2. Get public URL
      const { data: urlData } = SB.storage.from('documents').getPublicUrl(path);
      const publicUrl = urlData?.publicUrl || '';
      
      // 3. Save metadata to documents table
      const docRow = {
        id: 'D' + timestamp.toString(36).toUpperCase(),
        filename: file.name,
        folder: currentSubproject || '–û–±—â–µ–µ',
        uploaded_by: USER?.name || '–í–µ–±',
        upload_date: new Date().toISOString().split('T')[0],
        link: publicUrl,
        size: formatFileSize(file.size),
        direction: currentSubproject || '',
        project: PROJECTS[currentProject]?.name || ''
      };
      
      const { error: metaErr } = await SB.from('documents').insert(docRow);
      if (metaErr) console.warn('Meta save error:', metaErr);
      
      toast('‚úÖ ' + file.name + ' –∑–∞–≥—Ä—É–∂–µ–Ω!','success');
    } catch(e) {
      console.error('Upload error:', e);
      // Fallback: save just metadata via API
      try {
        await apiWrite('–î–æ–∫—É–º–µ–Ω—Ç—ã', {
          '–§–∞–π–ª': file.name,
          '–ü–∞–ø–∫–∞': currentSubproject || '–û–±—â–µ–µ',
          '–ó–∞–≥—Ä—É–∑–∏–ª': USER?.name || '–í–µ–±',
          '–î–∞—Ç–∞': new Date().toISOString().split('T')[0],
          '–†–∞–∑–º–µ—Ä': formatFileSize(file.size)
        });
        toast('‚ö†Ô∏è ' + file.name + ' ‚Äî –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã (—Ñ–∞–π–ª –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω: ' + e.message + ')','warning');
      } catch(e2) {
        toast('‚ùå –û—à–∏–±–∫–∞: ' + e.message,'error');
      }
    }
  }
  
  input.value = '';
  setTimeout(() => { loadData(); renderSubprojectView(); }, 800);
}

function formatFileSize(bytes) {
  if (bytes < 1024) return bytes + ' –ë';
  if (bytes < 1048576) return (bytes/1024).toFixed(1) + ' –ö–ë';
  return (bytes/1048576).toFixed(1) + ' –ú–ë';
}

function initFileUpload() {
  // Nothing extra needed
}

// ============================================================
// AI FILE CREATION
// ============================================================
const AI_FILE_TYPES = [
  { id: 'contract', name: '–î–æ–≥–æ–≤–æ—Ä', icon: 'üìú', desc: '–î–æ–≥–æ–≤–æ—Ä –Ω–∞ –æ–∫–∞–∑–∞–Ω–∏–µ —É—Å–ª—É–≥', ext: 'txt' },
  { id: 'proposal', name: '–ö–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ', icon: 'üìã', desc: '–ö–ü –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ —Å —Ü–µ–Ω–∞–º–∏ –∏ —É—Å–ª–æ–≤–∏—è–º–∏', ext: 'txt' },
  { id: 'pricelist', name: '–ü—Ä–∞–π—Å-–ª–∏—Å—Ç', icon: 'üí∞', desc: '–¢–∞–±–ª–∏—Ü–∞ —Ü–µ–Ω –Ω–∞ —É—Å–ª—É–≥–∏', ext: 'txt' },
  { id: 'brief', name: '–ë—Ä–∏—Ñ', icon: 'üìù', desc: '–ë—Ä–∏—Ñ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ (–æ–ø—Ä–æ—Å–Ω–∏–∫)', ext: 'txt' },
  { id: 'report', name: '–û—Ç—á—ë—Ç', icon: 'üìä', desc: '–û—Ç—á—ë—Ç –æ —Ä–∞–±–æ—Ç–µ / —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö', ext: 'txt' },
  { id: 'letter', name: '–î–µ–ª–æ–≤–æ–µ –ø–∏—Å—å–º–æ', icon: 'üìß', desc: '–û—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–µ –ø–∏—Å—å–º–æ –∫–ª–∏–µ–Ω—Ç—É –∏–ª–∏ –ø–∞—Ä—Ç–Ω—ë—Ä—É', ext: 'txt' },
  { id: 'custom', name: '–ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç', icon: '‚úçÔ∏è', desc: '–õ—é–±–æ–π –¥–æ–∫—É–º–µ–Ω—Ç –ø–æ –≤–∞—à–µ–º—É –æ–ø–∏—Å–∞–Ω–∏—é', ext: 'txt' },
  { id: 'site', name: 'HTML-—Å–∞–π—Ç', icon: 'üåê', desc: '–ì–æ—Ç–æ–≤—ã–π –æ–¥–Ω–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã–π —Å–∞–π—Ç', ext: 'html' }
];

function openAiFileModal() {
  const dir = (DATA.directions||[]).find(d => (d['–ù–∞–∑–≤–∞–Ω–∏–µ']||d['name']) === currentSubproject && d['–ü—Ä–æ–µ–∫—Ç'] === '–°–∞–π—Ç—ã');
  const clientName = dir ? (dir['–ù–∞–∑–≤–∞–Ω–∏–µ']||dir['name']||'') : (currentSubproject||'');
  const clientBiz = dir ? (dir['–¢–∏–ø –±–∏–∑–Ω–µ—Å–∞']||dir['–û–ø–∏—Å–∞–Ω–∏–µ']||'') : '';
  const clientPhone = dir ? (dir['–¢–µ–ª–µ—Ñ–æ–Ω']||'') : '';
  const clientCity = dir ? (dir['–ì–æ—Ä–æ–¥']||'') : '';

  let html = '<div class="modal-overlay" id="ai-file-modal" onclick="if(event.target===this)closeAiFileModal()">';
  html += '<div class="modal" style="max-width:560px;width:95%">';
  html += '<div class="modal-header"><h2>ü§ñ –°–æ–∑–¥–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç —á–µ—Ä–µ–∑ –ò–ò</h2><button class="modal-close" onclick="closeAiFileModal()">√ó</button></div>';
  html += '<div class="modal-body" style="padding:20px">';

  // Client context
  if (clientName) {
    html += '<div style="background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:16px;font-size:13px">';
    html += '<div style="font-weight:600;margin-bottom:4px">üìá –ö–ª–∏–µ–Ω—Ç: ' + esc(clientName) + '</div>';
    if (clientBiz) html += '<div style="color:var(--text2)">üíº ' + esc(clientBiz) + '</div>';
    if (clientCity) html += '<div style="color:var(--text2)">üìç ' + esc(clientCity) + '</div>';
    html += '</div>';
  }

  // File type selector
  html += '<label style="font-weight:600;display:block;margin-bottom:8px">–¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞</label>';
  html += '<div id="ai-file-types" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px">';
  AI_FILE_TYPES.forEach((ft, i) => {
    html += '<div class="ai-file-type-card' + (i===0?' active':'') + '" data-type="' + ft.id + '" onclick="selectAiFileType(\'' + ft.id + '\')" ';
    html += 'style="padding:12px;border:2px solid ' + (i===0?'var(--accent)':'var(--border)') + ';border-radius:8px;cursor:pointer;transition:all .2s">';
    html += '<div style="font-size:20px;margin-bottom:4px">' + ft.icon + '</div>';
    html += '<div style="font-weight:600;font-size:13px">' + ft.name + '</div>';
    html += '<div style="font-size:11px;color:var(--text2);margin-top:2px">' + ft.desc + '</div>';
    html += '</div>';
  });
  html += '</div>';

  // Description
  html += '<label style="font-weight:600;display:block;margin-bottom:8px">–û–ø–∏—Å–∞–Ω–∏–µ / –ø–æ–∂–µ–ª–∞–Ω–∏—è</label>';
  html += '<textarea id="ai-file-desc" rows="4" placeholder="–û–ø–∏—à–∏—Ç–µ —á—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ...\n–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–ü –¥–ª—è –∫–∞—Ñ–µ –ü—ã—à–∫–∏ –º–∏—Ä–∞, 3 —Ç–∏–ø–∞ —Å–∞–π—Ç–∞, —Å–∫–∏–¥–∫–∞ 10% –ø—Ä–∏ –∑–∞–∫–∞–∑–µ –¥–æ –∫–æ–Ω—Ü–∞ –º–µ—Å—è—Ü–∞" ';
  html += 'style="width:100%;padding:10px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:\'JetBrains Mono\',monospace;font-size:13px;resize:vertical"></textarea>';

  // Generate button
  html += '<div style="margin-top:16px;display:flex;gap:8px">';
  html += '<button id="ai-file-gen-btn" class="btn btn-primary" onclick="createAiFile()" style="flex:1;padding:14px;font-size:15px">ü§ñ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>';
  html += '<button class="btn btn-secondary" onclick="closeAiFileModal()">–û—Ç–º–µ–Ω–∞</button>';
  html += '</div>';

  // Result area (hidden initially)
  html += '<div id="ai-file-result" style="display:none;margin-top:16px">';
  html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">';
  html += '<label style="font-weight:600">–†–µ–∑—É–ª—å—Ç–∞—Ç</label>';
  html += '<div style="display:flex;gap:8px">';
  html += '<button class="btn btn-sm btn-primary" onclick="downloadAiFile()">üíæ –°–∫–∞—á–∞—Ç—å</button>';
  html += '<button class="btn btn-sm btn-secondary" onclick="copyAiFileText()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>';
  html += '<button class="btn btn-sm btn-secondary" onclick="saveAiFileToDocuments()">üì§ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –¥–æ–∫—É–º–µ–Ω—Ç—ã</button>';
  html += '</div></div>';
  html += '<pre id="ai-file-content" style="background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:12px;max-height:300px;overflow:auto;white-space:pre-wrap;font-size:12px"></pre>';
  html += '</div>';

  html += '</div></div></div>';

  document.body.insertAdjacentHTML('beforeend', html);
}

let _aiFileSelectedType = 'contract';
let _aiFileResult = '';
let _aiFileExt = 'txt';

function selectAiFileType(typeId) {
  _aiFileSelectedType = typeId;
  const ft = AI_FILE_TYPES.find(t => t.id === typeId);
  _aiFileExt = ft ? ft.ext : 'txt';
  document.querySelectorAll('.ai-file-type-card').forEach(card => {
    const isActive = card.getAttribute('data-type') === typeId;
    card.classList.toggle('active', isActive);
    card.style.borderColor = isActive ? 'var(--accent)' : 'var(--border)';
  });
}

function closeAiFileModal() {
  const modal = document.getElementById('ai-file-modal');
  if (modal) modal.remove();
  _aiFileResult = '';
}

async function createAiFile() {
  const desc = (document.getElementById('ai-file-desc')?.value || '').trim();
  const ft = AI_FILE_TYPES.find(t => t.id === _aiFileSelectedType);
  if (!ft) return;

  const dir = (DATA.directions||[]).find(d => (d['–ù–∞–∑–≤–∞–Ω–∏–µ']||d['name']) === currentSubproject && d['–ü—Ä–æ–µ–∫—Ç'] === '–°–∞–π—Ç—ã');
  const clientName = dir ? (dir['–ù–∞–∑–≤–∞–Ω–∏–µ']||dir['name']||'') : (currentSubproject||'');
  const clientBiz = dir ? (dir['–¢–∏–ø –±–∏–∑–Ω–µ—Å–∞']||dir['–û–ø–∏—Å–∞–Ω–∏–µ']||'') : '';
  const clientCity = dir ? (dir['–ì–æ—Ä–æ–¥']||'') : '';
  const clientPhone = dir ? (dir['–¢–µ–ª–µ—Ñ–æ–Ω']||'') : '';
  const siteType = dir ? (dir['–¢–∏–ø —Å–∞–π—Ç–∞']||'') : '';
  const price = dir ? (dir['–¶–µ–Ω–∞']||'') : '';

  const btn = document.getElementById('ai-file-gen-btn');
  if (btn) { btn.disabled = true; btn.textContent = '‚è≥ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è...'; }

  // Build prompt based on file type
  let prompt = '';
  const clientCtx = '–ö–ª–∏–µ–Ω—Ç: ' + clientName + (clientBiz ? ', –±–∏–∑–Ω–µ—Å: ' + clientBiz : '') + (clientCity ? ', –≥–æ—Ä–æ–¥: ' + clientCity : '') + (clientPhone ? ', —Ç–µ–ª: ' + clientPhone : '') + (siteType ? ', —Ç–∏–ø —Å–∞–π—Ç–∞: ' + siteType : '') + (price ? ', —Ü–µ–Ω–∞: ' + price + '‚ÇΩ' : '');

  if (_aiFileSelectedType === 'site') {
    prompt = '–¢—ã –≤–µ–±-—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫. –°–æ–∑–¥–∞–π –ø–æ–ª–Ω—ã–π HTML-—Å–∞–π—Ç (–æ–¥–Ω–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã–π, —Å CSS –≤–Ω—É—Ç—Ä–∏) –¥–ª—è: ' + clientCtx + '.\n' + (desc ? '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è: ' + desc : '') + '\n\n–í–ê–ñ–ù–û: –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û HTML-–∫–æ–¥, –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π. –ú–∏–Ω–∏–º—É–º 500 —Å—Ç—Ä–æ–∫. –ü–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤—ã–π –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é —Å–∞–π—Ç —Å –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–º –¥–∏–∑–∞–π–Ω–æ–º.';
  } else {
    const typeNames = { contract: '–¥–æ–≥–æ–≤–æ—Ä –Ω–∞ –æ–∫–∞–∑–∞–Ω–∏–µ —É—Å–ª—É–≥ –ø–æ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ —Å–∞–π—Ç–∞', proposal: '–∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ (–ö–ü) –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–∞–π—Ç–∞', pricelist: '–ø—Ä–∞–π—Å-–ª–∏—Å—Ç –Ω–∞ —É—Å–ª—É–≥–∏ –≤–µ–±-—Å—Ç—É–¥–∏–∏', brief: '–±—Ä–∏—Ñ (–æ–ø—Ä–æ—Å–Ω–∏–∫) –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º —Å–∞–π—Ç–∞', report: '–æ—Ç—á—ë—Ç –æ –ø—Ä–æ–¥–µ–ª–∞–Ω–Ω–æ–π —Ä–∞–±–æ—Ç–µ', letter: '–¥–µ–ª–æ–≤–æ–µ –ø–∏—Å—å–º–æ', custom: '–¥–æ–∫—É–º–µ–Ω—Ç' };
    const typeName = typeNames[_aiFileSelectedType] || '–¥–æ–∫—É–º–µ–Ω—Ç';
    prompt = '–°–æ–∑–¥–∞–π ' + typeName + ' –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.\n\n' + clientCtx + '\n\n–ö–æ–º–ø–∞–Ω–∏—è-–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å: –û–û–û "–í–µ–±-—Å—Ç—É–¥–∏—è" (–ø—Ä–æ–µ–∫—Ç –°–∞–π—Ç—ã –∫–æ–º–ø–∞–Ω–∏–∏ –†–ö–¢ ‚Äî –†–æ—Å—Å–∏–π—Å–∫–∏–µ –ö–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã–µ –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏).\n' +
      '–ù–∞—à–∏ —Ü–µ–Ω—ã: –í–∏–∑–∏—Ç–∫–∞ 5000‚ÇΩ, –õ–µ–Ω–¥–∏–Ω–≥ 10000‚ÇΩ, –ö–∞—Ç–∞–ª–æ–≥ 15000‚ÇΩ, –ü—Ä–µ–º–∏—É–º 25000‚ÇΩ, –î–æ–º–µ–Ω+—Ö–æ—Å—Ç–∏–Ω–≥ 3000‚ÇΩ.\n\n' +
      (desc ? '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è: ' + desc + '\n\n' : '') +
      '–í–ê–ñ–ù–û:\n- –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û —Ç–µ–∫—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞, –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤\n- –î–æ–∫—É–º–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–Ω—ã–º, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º, –≥–æ—Ç–æ–≤—ã–º –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é\n- –ò—Å–ø–æ–ª—å–∑—É–π —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞\n- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –∏—Å–ø–æ–ª—å–∑—É–π –∑–∞–≥–æ–ª–æ–≤–∫–∏, —Å–ø–∏—Å–∫–∏, –∞–±–∑–∞—Ü—ã\n- –ï—Å–ª–∏ —ç—Ç–æ –¥–æ–≥–æ–≤–æ—Ä ‚Äî –≤–∫–ª—é—á–∏ –≤—Å–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã (–ø—Ä–µ–¥–º–µ—Ç, —Å—Ä–æ–∫–∏, –æ–ø–ª–∞—Ç–∞, –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å, —Ä–µ–∫–≤–∏–∑–∏—Ç—ã)\n- –ï—Å–ª–∏ —ç—Ç–æ –ö–ü ‚Äî —Å–¥–µ–ª–∞–π –µ–≥–æ –ø—Ä–æ–¥–∞—é—â–∏–º —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –≤—ã–≥–æ–¥';
  }

  try {
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 120000);
    const response = await fetch(CONFIG.AI_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        message: prompt,
        context: 'file_create',
        source: 'web',
        fileType: _aiFileSelectedType,
        user: USER ? USER['–ò–º—è'] : '',
        history: []
      }),
      signal: controller.signal
    });
    clearTimeout(timeout);

    if (!response.ok) throw new Error('HTTP ' + response.status);

    const raw = await response.json();
    let data = raw; if (Array.isArray(raw)) data = raw[0] || {}; if (data.json) data = data.json;
    let text = data.reply || data.response || data.text || data.message || '';
    if (!text && data.content) { try { text = data.content[0].text; } catch(e) {} }

    if (!text) throw new Error('–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò');

    _aiFileResult = text;
    _aiFileExt = ft.ext;

    // Show result
    const resultDiv = document.getElementById('ai-file-result');
    const contentPre = document.getElementById('ai-file-content');
    if (resultDiv) resultDiv.style.display = 'block';
    if (contentPre) contentPre.textContent = text;

    toast('–î–æ–∫—É–º–µ–Ω—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω!', 'success');
  } catch(e) {
    console.error('AI file create error:', e);
    toast('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: ' + e.message, 'error');
  } finally {
    if (btn) { btn.disabled = false; btn.textContent = 'ü§ñ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å'; }
  }
}

function downloadAiFile() {
  if (!_aiFileResult) return;
  const ft = AI_FILE_TYPES.find(t => t.id === _aiFileSelectedType);
  const ext = ft ? ft.ext : 'txt';
  const mime = ext === 'html' ? 'text/html' : 'text/plain';
  const blob = new Blob([_aiFileResult], { type: mime + ';charset=utf-8' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  const name = (ft ? ft.name : 'document').replace(/\s/g, '_') + '_' + (currentSubproject||'file').replace(/\s/g, '_');
  a.download = name + '.' + ext;
  a.click();
  URL.revokeObjectURL(a.href);
  toast('–§–∞–π–ª —Å–∫–∞—á–∞–Ω!', 'success');
}

function copyAiFileText() {
  if (!_aiFileResult) return;
  navigator.clipboard.writeText(_aiFileResult)
    .then(() => toast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä!', 'success'))
    .catch(() => toast('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è', 'error'));
}

async function saveAiFileToDocuments() {
  if (!_aiFileResult) return;
  const ft = AI_FILE_TYPES.find(t => t.id === _aiFileSelectedType);
  const ext = ft ? ft.ext : 'txt';
  const mime = ext === 'html' ? 'text/html' : 'text/plain';
  const fileName = (ft ? ft.name : '–î–æ–∫—É–º–µ–Ω—Ç').replace(/\s/g, '_') + '_' + (currentSubproject||'').replace(/\s/g, '_') + '_' + new Date().toISOString().split('T')[0] + '.' + ext;

  toast('üì§ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –¥–æ–∫—É–º–µ–Ω—Ç—ã...', 'info');
  try {
    const blob = new Blob([_aiFileResult], { type: mime + ';charset=utf-8' });
    const folder = (currentSubproject || '–û–±—â–µ–µ').replace(/[^a-zA-Z–∞-—è–ê-–Ø0-9_ -]/g, '');
    const timestamp = Date.now();
    const path = folder + '/' + timestamp + '_' + fileName;

    const { data: uploadData, error: uploadErr } = await SB.storage
      .from('documents')
      .upload(path, blob, { contentType: mime, upsert: false });
    if (uploadErr) throw uploadErr;

    const { data: urlData } = SB.storage.from('documents').getPublicUrl(path);
    const publicUrl = urlData?.publicUrl || '';

    const docRow = {
      id: 'D' + timestamp.toString(36).toUpperCase(),
      filename: fileName,
      folder: currentSubproject || '–û–±—â–µ–µ',
      uploaded_by: (USER?.name || '–ò–ò') + ' (–ò–ò)',
      upload_date: new Date().toISOString().split('T')[0],
      link: publicUrl,
      size: formatFileSize(blob.size),
      direction: currentSubproject || '',
      project: PROJECTS[currentProject]?.name || ''
    };
    await SB.from('documents').insert(docRow);
    toast('–î–æ–∫—É–º–µ–Ω—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ —Ä–∞–∑–¥–µ–ª "–î–æ–∫—É–º–µ–Ω—Ç—ã"!', 'success');
    closeAiFileModal();
    debouncedLoadData();
    setTimeout(() => renderSubprojectView(), 500);
  } catch(e) {
    console.error('Save AI file error:', e);
    toast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + e.message, 'error');
  }
}

// ============================================================
// TASK DETAIL WITH AI ASSISTANT
// ============================================================
function openTaskDetail(taskId) {
  const task = DATA.tasks.find(t => t.ID === taskId);
  if (!task) { toast('–ó–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞','error'); return; }
  currentTaskId = taskId;
  aiMessages = [];

  // Breadcrumb
  let bc = '<a onclick="showPage(\'home\')">üè† –ü—Ä–æ–µ–∫—Ç—ã</a><span class="sep">‚Ä∫</span>';
  const dir = task['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'';
  const projKey = dirToProject(dir);
  if (projKey) {
    bc += '<a onclick="openProject(\''+projKey+'\')">'+esc(PROJECTS[projKey].name)+'</a><span class="sep">‚Ä∫</span>';
    bc += '<a onclick="openSubproject(\''+escA(dir)+'\')">'+esc(dir)+'</a><span class="sep">‚Ä∫</span>';
  }
  bc += '<span class="current">'+esc(task['–û–ø–∏—Å–∞–Ω–∏–µ']||task['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</span>';
  document.getElementById('td-breadcrumb').innerHTML = bc;

  // Task detail card
  let html = '<div class="task-detail">';
  html += '<div class="task-detail-header">';
  html += '<h3>'+esc(task['–û–ø–∏—Å–∞–Ω–∏–µ']||task['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</h3>';
  html += '<div class="task-meta">';
  html += '<div class="meta-item">'+prBadge(task['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç'])+' '+esc(task['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']||'')+'</div>';
  html += '<div class="meta-item">'+statusBadge(task['–°—Ç–∞—Ç—É—Å'])+'</div>';
  if(task['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']) html += '<div class="meta-item">üìÇ '+esc(task['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'])+'</div>';
  if(task['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']) html += '<div class="meta-item">üë§ '+esc(task['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π'])+'</div>';
  if(task['–î–µ–¥–ª–∞–π–Ω']) {
    const od = task['–î–µ–¥–ª–∞–π–Ω']<today()&&(task['–°—Ç–∞—Ç—É—Å']||'')!=='–ì–æ—Ç–æ–≤–æ';
    html += '<div class="meta-item" style="'+(od?'color:var(--red);font-weight:700':'')+'">üìÖ '+esc(task['–î–µ–¥–ª–∞–π–Ω'])+(od?' üî¥':'')+'</div>';
  }
  html += '</div></div>';

  // Detail fields
  html += '<div class="task-detail-body">';
  html += '<div class="detail-grid">';
  const fields = [
    ['–ü—Ä–æ–µ–∫—Ç', task['–ü—Ä–æ–µ–∫—Ç']],
    ['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', task['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']],
    ['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç', task['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']],
    ['–°—Ç–∞—Ç—É—Å', task['–°—Ç–∞—Ç—É—Å']],
    ['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π', task['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']],
    ['–î–µ–¥–ª–∞–π–Ω', task['–î–µ–¥–ª–∞–π–Ω']]
  ];
  fields.forEach(([l,v]) => {
    if(v) html += '<div class="detail-item"><div class="detail-label">'+esc(l)+'</div><div class="detail-value">'+esc(v)+'</div></div>';
  });
  if(task['–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π']) {
    html += '<div class="detail-item detail-full"><div class="detail-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</div><div class="detail-value">'+esc(task['–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π'])+'</div></div>';
  }
  html += '</div>';

  // Action buttons
  html += '<div style="display:flex;gap:10px;margin-top:20px;flex-wrap:wrap">';
  html += '<button class="btn btn-primary" onclick="editItem(\'task\',\''+escA(taskId)+'\')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>';
  html += '<button class="btn btn-secondary" onclick="changeTaskStatus(\''+escA(taskId)+'\')">üîÑ –°–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>';
  const p = getUserPerms();
  if(p.canDelete) html += '<button class="btn btn-danger" onclick="confirmDelete(\'task\',\''+escA(taskId)+'\',\''+escA(task['–û–ø–∏—Å–∞–Ω–∏–µ']||task['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'\')">üóë –£–¥–∞–ª–∏—Ç—å</button>';
  html += '</div>';
  html += '</div></div>';

  // AI ASSISTANT PANEL
  html += '<div class="ai-panel">';
  html += '<div class="ai-panel-header">';
  html += '<h4>ü§ñ –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ –∑–∞–¥–∞—á–µ</h4>';
  html += '<button class="btn btn-xs btn-secondary" onclick="aiGenerateSteps()">üìã –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞–Ω</button>';
  html += '</div>';

  // AI messages
  html += '<div class="ai-chat-messages" id="ai-messages">';
  html += '<div class="ai-msg system">–ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –≥–æ—Ç–æ–≤ –ø–æ–º–æ—á—å —Å –∑–∞–¥–∞—á–µ–π ¬´'+esc(task['–û–ø–∏—Å–∞–Ω–∏–µ']||task['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'¬ª. –ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ.</div>';
  html += '</div>';

  // Quick actions
  html += '<div class="ai-suggestions">';
  html += '<button class="ai-suggestion-btn" onclick="aiQuickAction(\'plan\')">üìã –ü–ª–∞–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</button>';
  html += '<button class="ai-suggestion-btn" onclick="aiQuickAction(\'risks\')">‚ö†Ô∏è –†–∏—Å–∫–∏</button>';
  html += '<button class="ai-suggestion-btn" onclick="aiQuickAction(\'email\')">üìß –ù–∞–ø–∏—Å–∞—Ç—å –ø–∏—Å—å–º–æ</button>';
  html += '<button class="ai-suggestion-btn" onclick="aiQuickAction(\'checklist\')">‚úÖ –ß–µ–∫–ª–∏—Å—Ç</button>';
  html += '<button class="ai-suggestion-btn" onclick="aiQuickAction(\'next\')">‚û°Ô∏è –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏</button>';
  html += '</div>';

  // Input
  html += '<div class="ai-input-area">';
  html += '<input class="ai-input" id="ai-input" placeholder="–°–ø—Ä–æ—Å–∏—Ç–µ –ò–ò –æ –∑–∞–¥–∞—á–µ..." onkeydown="if(event.key===\'Enter\')sendAiMessage()">';
  html += '<button class="ai-send-btn" id="ai-send-btn" onclick="sendAiMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>';
  html += '</div>';
  html += '</div>';

  document.getElementById('td-content').innerHTML = html;
  showPage('taskdetail');
}

function changeTaskStatus(taskId) {
  const task = DATA.tasks.find(t => t.ID===taskId);
  if(!task) return;
  const statuses = ['‚è≥ –í –æ—á–µ—Ä–µ–¥–∏', '–í —Ä–∞–±–æ—Ç–µ', '–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ', '–ì–æ—Ç–æ–≤–æ'];
  const cur = task['–°—Ç–∞—Ç—É—Å']||'';
  const idx = statuses.indexOf(cur);
  const next = statuses[(idx+1)%statuses.length];
  task['–°—Ç–∞—Ç—É—Å'] = next;
  openTaskDetail(taskId);
  toast('–°—Ç–∞—Ç—É—Å: '+next, 'success');
  apiWrite('–ó–∞–¥–∞—á–∏', task);
}

// ============================================================
// AI CHAT FUNCTIONS
// ============================================================
async function sendAiMessage() {
  const input = document.getElementById('ai-input');
  const msg = input.value.trim();
  if(!msg) return;

  input.value = '';
  addAiMessage('user', msg);

  // Get task context
  const task = DATA.tasks.find(t => t.ID===currentTaskId);
  const context = task ? '–ó–∞–¥–∞—á–∞: '+( task['–û–ø–∏—Å–∞–Ω–∏–µ']||task['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'. –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: '+(task['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'')+'. –°—Ç–∞—Ç—É—Å: '+(task['–°—Ç–∞—Ç—É—Å']||'')+'. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: '+(task['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']||'')+'. –î–µ–¥–ª–∞–π–Ω: '+(task['–î–µ–¥–ª–∞–π–Ω']||'–Ω–µ —É–∫–∞–∑–∞–Ω')+'. –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: '+(task['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'–Ω–µ —É–∫–∞–∑–∞–Ω')+'. –ü—Ä–æ–µ–∫—Ç: '+(task['–ü—Ä–æ–µ–∫—Ç']||'')+'. –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: '+(task['–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π']||'') : '';

  await callAI(msg, context);
}

function aiQuickAction(type) {
  const task = DATA.tasks.find(t => t.ID===currentTaskId);
  if(!task) return;
  const name = task['–û–ø–∏—Å–∞–Ω–∏–µ']||task['–ù–∞–∑–≤–∞–Ω–∏–µ'];

  const prompts = {
    plan: '–°–æ—Å—Ç–∞–≤—å –ø–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ ¬´'+name+'¬ª. –î–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —à–∞–≥–∏ —Å –æ—Ü–µ–Ω–∫–æ–π –≤—Ä–µ–º–µ–Ω–∏.',
    risks: '–ö–∞–∫–∏–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ä–∏—Å–∫–∏ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏ ¬´'+name+'¬ª? –ö–∞–∫ –∏—Ö –º–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å?',
    email: '–ù–∞–ø–∏—à–∏ –¥–µ–ª–æ–≤–æ–µ –ø–∏—Å—å–º–æ –ø–∞—Ä—Ç–Ω—ë—Ä—É –ø–æ –∑–∞–¥–∞—á–µ ¬´'+name+'¬ª. –¢–æ–Ω ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π.',
    checklist: '–°–æ–∑–¥–∞–π –ø–æ–¥—Ä–æ–±–Ω—ã–π —á–µ–∫–ª–∏—Å—Ç –¥–ª—è –∑–∞–¥–∞—á–∏ ¬´'+name+'¬ª ‚Äî —á—Ç–æ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º.',
    next: '–ö–∞–∫–∏–µ —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ ¬´'+name+'¬ª? –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –¥–∞–ª–µ–µ?'
  };

  const msg = prompts[type] || '–ü–æ–º–æ–≥–∏ —Å –∑–∞–¥–∞—á–µ–π ¬´'+name+'¬ª';
  addAiMessage('user', msg);

  const context = '–ó–∞–¥–∞—á–∞: '+name+'. –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: '+(task['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'')+'. –°—Ç–∞—Ç—É—Å: '+(task['–°—Ç–∞—Ç—É—Å']||'')+'. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: '+(task['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']||'')+'. –î–µ–¥–ª–∞–π–Ω: '+(task['–î–µ–¥–ª–∞–π–Ω']||'–Ω–µ —É–∫–∞–∑–∞–Ω')+'. –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: '+(task['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'–Ω–µ —É–∫–∞–∑–∞–Ω')+'.';
  callAI(msg, context);
}

function aiGenerateSteps() {
  aiQuickAction('plan');
}

async function callAI(userMsg, context) {
  // Show loading
  const container = document.getElementById('ai-messages');
  const loadingId = 'ai-loading-'+Date.now();
  container.innerHTML += '<div class="ai-msg assistant" id="'+loadingId+'"><div class="ai-loading"><span></span><span></span><span></span></div></div>';
  container.scrollTop = container.scrollHeight;

  const sendBtn = document.getElementById('ai-send-btn');
  if(sendBtn) sendBtn.disabled = true;

  let aiResponse = '';
  try {
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 30000);
    const response = await fetch(CONFIG.AI_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        message: userMsg,
        context: context,
        source: 'web',
        history: aiMessages.filter(m=>m.role==='user'||m.role==='assistant').slice(-20),
        user: USER ? USER['–ò–º—è'] : ''
      }),
      signal: controller.signal
    });
    clearTimeout(timeout);

    if (response.ok) {
      const raw3 = await response.json();
      let data3 = raw3; if (Array.isArray(raw3)) data3 = raw3[0]||{}; if (data3.json) data3 = data3.json;
      aiResponse = data3.reply || data3.response || data3.text || data3.message || '';
      if (!aiResponse && data3.content) { try { aiResponse = data3.content[0].text; } catch(e) {} }
    }
    if (!aiResponse) throw new Error('Empty response');
  } catch(e) {
    console.warn('Task AI fallback:', e.message);
    aiResponse = generateLocalAIResponse(userMsg, context);
  }

  const loadEl = document.getElementById(loadingId);
  if(loadEl) loadEl.remove();
  addAiMessage('assistant', aiResponse);
  if(sendBtn) sendBtn.disabled = false;
}

function generateLocalAIResponse(msg, context) {
  // Smart local fallback when AI endpoint is not available
  const lower = msg.toLowerCase();

  if (lower.includes('–ø–ª–∞–Ω') || lower.includes('—à–∞–≥')) {
    return 'üìã **–ü–ª–∞–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**\n\n1. –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π\n2. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤\n3. –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ —Å –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –ª–∏—Ü–∞–º–∏\n4. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–π —Ä–∞–±–æ—Ç—ã\n5. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ\n6. –§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –∏ –∑–∞–∫—Ä—ã—Ç–∏–µ –∑–∞–¥–∞—á–∏\n\n‚è± –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Å—Ä–æ–∫: —Ä–∞–∑–±–µ–π—Ç–µ –Ω–∞ —ç—Ç–∞–ø—ã –ø–æ 1-2 –¥–Ω—è –∫–∞–∂–¥—ã–π.\n\nüí° –°–æ–≤–µ—Ç: –Ω–∞—á–Ω–∏—Ç–µ —Å –ø—É–Ω–∫—Ç–∞ 1 —Å–µ–≥–æ–¥–Ω—è, —á—Ç–æ–±—ã –Ω–µ –æ—Ç–∫–ª–∞–¥—ã–≤–∞—Ç—å.';
  }
  if (lower.includes('—Ä–∏—Å–∫')) {
    return '‚ö†Ô∏è **–í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–∏—Å–∫–∏:**\n\n1. –ó–∞–¥–µ—Ä–∂–∫–∞ –æ—Ç –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤/–ø–æ–¥—Ä—è–¥—á–∏–∫–æ–≤\n2. –ù–µ—Ö–≤–∞—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ –∏–ª–∏ –±—é–¥–∂–µ—Ç–∞\n3. –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ\n4. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏\n\nüõ° **–ú–∏—Ç–∏–≥–∞—Ü–∏—è:**\n- –ó–∞–ª–æ–∂–∏—Ç–µ –±—É—Ñ–µ—Ä –ø–æ —Å—Ä–æ–∫–∞–º (15-20%)\n- –ü–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ –ø–ª–∞–Ω –ë –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —ç—Ç–∞–ø–æ–≤\n- –†–µ–≥—É–ª—è—Ä–Ω–æ —Å–≤–µ—Ä—è–π—Ç–µ—Å—å —Å –∑–∞–∫–∞–∑—á–∏–∫–æ–º';
  }
  if (lower.includes('–ø–∏—Å—å–º') || lower.includes('email')) {
    return 'üìß **–®–∞–±–ª–æ–Ω –ø–∏—Å—å–º–∞:**\n\n–£–≤–∞–∂–∞–µ–º—ã–π [–ò–º—è],\n\n–í —Ä–∞–º–∫–∞—Ö –Ω–∞—à–µ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞ —Ö–æ—Ç–µ–ª –±—ã –æ–±—Å—É–¥–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –ø–æ –∑–∞–¥–∞—á–µ.\n\n–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –º—ã –Ω–∞—Ö–æ–¥–∏–º—Å—è –Ω–∞ —ç—Ç–∞–ø–µ [—ç—Ç–∞–ø]. –î–ª—è –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è –Ω–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ [–¥–µ–π—Å—Ç–≤–∏–µ].\n\n–ü—Ä–µ–¥–ª–∞–≥–∞—é –Ω–∞–∑–Ω–∞—á–∏—Ç—å –≤—Å—Ç—Ä–µ—á—É/–∑–≤–æ–Ω–æ–∫ –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π.\n\n–° —É–≤–∞–∂–µ–Ω–∏–µ–º,\n'+((USER?USER.name:''))||'[–í–∞—à–µ –∏–º—è]';
  }
  if (lower.includes('—á–µ–∫–ª–∏—Å—Ç') || lower.includes('–ø—Ä–æ–≤–µ—Ä–∫')) {
    return '‚úÖ **–ß–µ–∫–ª–∏—Å—Ç:**\n\n‚òê –í—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã\n‚òê –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ —Å —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ–º –ø–æ–ª—É—á–µ–Ω–æ\n‚òê –ë—é–¥–∂–µ—Ç —É—Ç–≤–µ—Ä–∂–¥—ë–Ω\n‚òê –°—Ä–æ–∫–∏ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã\n‚òê –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã\n‚òê –†–∏—Å–∫–∏ —É—á—Ç–µ–Ω—ã\n‚òê –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –¢–ó\n‚òê –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –ø–æ–ª—É—á–µ–Ω–∞';
  }
  if (lower.includes('—Å–ª–µ–¥—É—é—â') || lower.includes('–¥–∞–ª–µ–µ') || lower.includes('next')) {
    return '‚û°Ô∏è **–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**\n\n1. –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ–∫—É—â–µ–π –∑–∞–¥–∞—á–∏\n2. –£–≤–µ–¥–æ–º–∏—Ç—å –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω–Ω—ã—Ö –ª–∏—Ü –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏\n3. –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤ —Å–∏—Å—Ç–µ–º–µ\n4. –ü—Ä–æ–≤–µ—Å—Ç–∏ —Ä–µ—Ç—Ä–æ—Å–ø–µ–∫—Ç–∏–≤—É (—á—Ç–æ –ø–æ—à–ª–æ —Ö–æ—Ä–æ—à–æ / —á—Ç–æ —É–ª—É—á—à–∏—Ç—å)\n5. –ü–µ—Ä–µ–π—Ç–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–π –∑–∞–¥–∞—á–µ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É';
  }

  return 'ü§ñ –Ø –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª –∑–∞–¥–∞—á—É. –í–æ—Ç —á—Ç–æ –º–æ–≥—É —Å–∫–∞–∑–∞—Ç—å:\n\n' + context + '\n\n–ß—Ç–æ–±—ã —è –¥–∞–ª –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–π –æ—Ç–≤–µ—Ç, —É—Ç–æ—á–Ω–∏—Ç–µ —á—Ç–æ –∏–º–µ–Ω–Ω–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç ‚Äî –ø–ª–∞–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è, —Ä–∏—Å–∫–∏, –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏ –∏–ª–∏ –¥—Ä—É–≥–æ–π –∞—Å–ø–µ–∫—Ç.';
}

function addAiMessage(role, text) {
  aiMessages.push({ role, content: text });
  const container = document.getElementById('ai-messages');
  const div = document.createElement('div');
  div.className = 'ai-msg ' + role;
  div.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

// ============================================================
// GLOBAL AI ASSISTANT PANEL
// ============================================================
let globalAiMessages = JSON.parse(localStorage.getItem('rkt_ai_history') || '[]');
let aiPanelOpen = false;

function saveAiHistory() {
  try { localStorage.setItem('rkt_ai_history', JSON.stringify(globalAiMessages.slice(-30))); } catch(e){}
}

function restoreAiHistory() {
  const container = document.getElementById('ai-global-messages');
  if (!container || !globalAiMessages.length) return;
  globalAiMessages.forEach(m => {
    const div = document.createElement('div');
    div.className = 'ai-msg ' + (m.role === 'user' ? 'user' : 'assistant');
    div.innerHTML = (m.content||'').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
    container.appendChild(div);
  });
  container.scrollTop = container.scrollHeight;
}

function toggleAiPanel() {
  const panel = document.getElementById('aiGlobalPanel');
  const fab = document.getElementById('aiFab');
  aiPanelOpen = !aiPanelOpen;
  if (aiPanelOpen) {
    panel.style.display = 'flex';
    fab.style.display = 'none';
    // Restore history on first open
    const container = document.getElementById('ai-global-messages');
    if (container && container.children.length <= 1) restoreAiHistory();
    setTimeout(() => document.getElementById('ai-global-input').focus(), 100);
  } else {
    panel.style.display = 'none';
    fab.style.display = 'flex';
  }
}

function getDataContext() {
  const ctx = { projects: {}, staff_count: DATA.staff.length, total_tasks: 0, overdue: [], upcoming: [], clients: [] };
  const now = new Date();
  for (const [key, proj] of Object.entries(PROJECTS)) {
    const tasks = DATA.tasks.filter(t => {
      for (const sub of Object.keys(proj.subprojects)) {
        if (t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] === sub || t['–ü—Ä–æ–µ–∫—Ç'] === proj.name) return true;
      }
      return false;
    });
    // Add client/direction info for each subproject
    const subs = {};
    for (const sub of Object.keys(proj.subprojects)) {
      const dir = (DATA.directions||[]).find(d => d['–ù–∞–∑–≤–∞–Ω–∏–µ'] === sub);
      const subTasks = tasks.filter(t => t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] === sub);
      subs[sub] = { 
        tasks: subTasks.length, 
        stage: dir ? (dir.stage||'prospect') : null,
        manager: dir ? dir['–ú–µ–Ω–µ–¥–∂–µ—Ä'] : null,
        price: dir ? dir['–¶–µ–Ω–∞'] : null,
        paid: dir ? !!dir['–û–ø–ª–∞—á–µ–Ω–æ'] : false
      };
    }
    ctx.projects[proj.name] = { subprojects: subs, total_tasks: tasks.length };
    ctx.total_tasks += tasks.length;
    tasks.forEach(t => {
      if (t['–î–µ–¥–ª–∞–π–Ω'] && t['–°—Ç–∞—Ç—É—Å'] !== '–ì–æ—Ç–æ–≤–æ' && t['–°—Ç–∞—Ç—É—Å'] !== '–ó–∞–≤–µ—Ä—à–µ–Ω–æ') {
        const dl = new Date(t['–î–µ–¥–ª–∞–π–Ω']);
        if (dl < now) ctx.overdue.push({ task: t['–û–ø–∏—Å–∞–Ω–∏–µ']||t['–ù–∞–∑–≤–∞–Ω–∏–µ'], deadline: t['–î–µ–¥–ª–∞–π–Ω'], direction: t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'], assignee: t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π'] });
        else if (dl - now < 7*86400000) ctx.upcoming.push({ task: t['–û–ø–∏—Å–∞–Ω–∏–µ']||t['–ù–∞–∑–≤–∞–Ω–∏–µ'], deadline: t['–î–µ–¥–ª–∞–π–Ω'], direction: t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'], assignee: t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π'] });
      }
    });
  }
  // Add all clients/directions
  (DATA.directions||[]).forEach(d => {
    ctx.clients.push({ name: d['–ù–∞–∑–≤–∞–Ω–∏–µ'], stage: d.stage||'prospect', price: d['–¶–µ–Ω–∞'], paid: !!d['–û–ø–ª–∞—á–µ–Ω–æ'], manager: d['–ú–µ–Ω–µ–¥–∂–µ—Ä'], project: d['–ü—Ä–æ–µ–∫—Ç'] });
  });
  ctx.partners_count = DATA.partners.length;
  ctx.comms_count = DATA.comms.length;
  return ctx;
}

async function sendGlobalAi() {
  const input = document.getElementById('ai-global-input');
  let msg = input.value.trim();
  if (!msg) return;
  input.value = '';
  input.disabled = true;

  // Handle attached file
  let fileInfo = '';
  if (window._aiAttachedFile) {
    const f = window._aiAttachedFile;
    fileInfo = '\n\n[–ü—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω —Ñ–∞–π–ª: ' + f.name + ' (' + formatFileSize(f.size) + ')]';
    // Read text files
    if (f.name.match(/\.(txt|csv|md|json)$/i) && f.size < 100000) {
      try {
        const text = await f.text();
        fileInfo += '\n–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞:\n' + text.substring(0, 5000);
      } catch(e) {}
    }
    window._aiAttachedFile = null;
    const badge = document.getElementById('ai-file-badge');
    if (badge) badge.style.display = 'none';
  }
  msg += fileInfo;

  const container = document.getElementById('ai-global-messages');
  const userDiv = document.createElement('div');
  userDiv.className = 'ai-msg user';
  userDiv.textContent = msg.split('\n')[0]; // Show first line only in chat
  container.appendChild(userDiv);
  globalAiMessages.push({ role: 'user', content: msg });
  saveAiHistory();

  // Typing indicator
  const typing = document.createElement('div');
  typing.className = 'ai-msg system';
  typing.innerHTML = '‚è≥ –î—É–º–∞—é...';
  typing.id = 'ai-typing';
  container.appendChild(typing);
  container.scrollTop = container.scrollHeight;

  const dataCtx = getDataContext();
  let aiText = '';

  try {
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 30000);
    const response = await fetch(CONFIG.AI_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        message: msg,
        userId: USER?.tgId || '',
        context: 'chat',
        source: 'web',
        direction: currentSubproject || currentProject || '',
        user: USER?.name || '',
        dataContext: JSON.stringify(dataCtx),
        history: globalAiMessages.filter(m=>m.role==='user'||m.role==='assistant').slice(-20)
      }),
      signal: controller.signal
    });
    clearTimeout(timeout);
    if (!response.ok) throw new Error('HTTP ' + response.status);
    const raw = await response.json();
    // Handle ANY format: {reply:""}, [{reply:""}], [{json:{reply:""}}], {content:[{text:""}]}
    let data = raw;
    if (Array.isArray(raw)) data = raw[0] || {};
    if (data.json) data = data.json;
    aiText = data.reply || data.response || data.text || data.message || data.output || '';
    if (!aiText && data.content) { try { aiText = data.content[0].text; } catch(e) {} }
    if (!aiText && typeof raw === 'string') aiText = raw;
    if (!aiText) throw new Error('Empty response. Raw: ' + JSON.stringify(raw).slice(0,200));
  } catch(e) {
    console.error('AI API error:', e.message, e);
    aiText = '‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ AI: ' + e.message + '\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:\n1. Workflow –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –≤ n8n\n2. URL: ' + CONFIG.AI_URL;
  }

  typing.remove();
  const aiDiv = document.createElement('div');
  aiDiv.className = 'ai-msg assistant';
  aiDiv.innerHTML = aiText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
  container.appendChild(aiDiv);
  globalAiMessages.push({ role: 'assistant', content: aiText });
  saveAiHistory();
  container.scrollTop = container.scrollHeight;
  input.disabled = false;
  input.focus();
}

function globalAiQuick(question) {
  document.getElementById('ai-global-input').value = question;
  sendGlobalAi();
}

function generateGlobalFallback(msg, ctx) {
  const ml = msg.toLowerCase();
  const td = today();

  // Direction-specific queries: "—á—Ç–æ –ø–æ –ö–¢?", "—Å—Ç–∞—Ç—É—Å —Ä–æ–±–æ—Ç–æ–≤", etc.
  const dirKeywords = {
    '–∫—Ç':['–ö–¢','–∫—Ç','—Ç–æ–º–æ–≥—Ä–∞—Ñ','ct'], '—Ä–µ–Ω—Ç–≥–µ–Ω':['–†–µ–Ω—Ç–≥–µ–Ω','—Ä–µ–Ω—Ç–≥–µ–Ω','xray'],
    '—Ä–æ–±–æ—Ç':['–†–æ–±–æ—Ç—ã','—Ä–æ–±–æ—Ç','—Ö–∏—Ä—É—Ä–≥'], '—É—Ä–æ–ª–æ–≥':['–£—Ä–æ–ª–æ–≥–∏—è','—É—Ä–æ–ª–æ–≥'],
    'pacs':['PACS','pacs','–∞—Ä—Ö–∏–≤'], '—É–∑–∏':['–£–ó–ò','—É–∑–∏','—É–ª—å—Ç—Ä–∞–∑–≤—É–∫'],
    '—Å–∞–π—Ç':['–°–∞–π—Ç—ã','—Å–∞–π—Ç','web','–≤–µ–±'], '–ø—ã—à–∫–∏':['–ü—ã—à–∫–∏','–ø—ã—à–∫–∏','–ø–æ–Ω—á–∏–∫'],
    '–±—Ä–µ–∂–Ω–µ–≤':['–ë—Ä–µ–∂–Ω–µ–≤','–±—Ä–µ–∂–Ω–µ–≤'], '–∫–µ—Ä–∞—Ç–∏–Ω':['–ö–µ—Ä–∞—Ç–∏–Ω','–∫–µ—Ä–∞—Ç–∏–Ω','–∞–≥—Ä—ã–∑']
  };
  for (const [key, words] of Object.entries(dirKeywords)) {
    if (words.some(w => ml.includes(w.toLowerCase()))) {
      const allDirs = getDirectionOptions();
      const matchDir = allDirs.find(d => words.some(w => d.toLowerCase().includes(w.toLowerCase()))) || words[0];
      const dirPartners = DATA.partners.filter(p => (p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'').toLowerCase().includes(key));
      const dirTasks = DATA.tasks.filter(t => (t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'').toLowerCase().includes(key));
      const openTasks = dirTasks.filter(t => t['–°—Ç–∞—Ç—É—Å'] !== '–ó–∞–≤–µ—Ä—à–µ–Ω–æ' && t['–°—Ç–∞—Ç—É—Å'] !== '–ì–æ—Ç–æ–≤–æ' && t['–°—Ç–∞—Ç—É—Å'] !== '‚úÖ –ì–æ—Ç–æ–≤–æ');
      const overdueT = openTasks.filter(t => t['–î–µ–¥–ª–∞–π–Ω'] && t['–î–µ–¥–ª–∞–π–Ω'] < td);
      let r = 'üìÇ **'+matchDir+':**\n\n';
      r += 'ü§ù –ü–∞—Ä—Ç–Ω—ë—Ä–æ–≤: '+dirPartners.length+'\n';
      if (dirPartners.length) dirPartners.forEach(p => r += '  ‚Ä¢ '+(p['–ù–∞–∑–≤–∞–Ω–∏–µ']||'?')+' ('+(p['–°—Ç—Ä–∞–Ω–∞']||'?')+') ‚Äî '+(p['–°—Ç–∞—Ç—É—Å']||'?')+'\n');
      r += '\n‚úÖ –ó–∞–¥–∞—á: '+dirTasks.length+' (–æ—Ç–∫—Ä—ã—Ç—ã—Ö: '+openTasks.length;
      if (overdueT.length) r += ', üî¥ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ: '+overdueT.length;
      r += ')\n';
      if (openTasks.length) openTasks.slice(0,5).forEach(t => r += '  ‚Ä¢ '+(t['–ù–∞–∑–≤–∞–Ω–∏–µ']||t['–û–ø–∏—Å–∞–Ω–∏–µ']||'‚Äî')+' ‚Äî '+(t['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']||'?')+', –¥–µ–¥–ª–∞–π–Ω: '+(t['–î–µ–¥–ª–∞–π–Ω']||'‚Äî')+'\n');
      return r;
    }
  }

  if (ml.includes('–ø—Ä–æ—Å—Ä–æ—á') || ml.includes('overdue')) {
    if (ctx.overdue.length === 0) return '‚úÖ –û—Ç–ª–∏—á–Ω–æ! –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á –Ω–µ—Ç.';
    let r = 'üî¥ **–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ ('+ctx.overdue.length+'):**\n';
    ctx.overdue.forEach(t => r += '‚Ä¢ '+t.task+' ‚Äî –¥–µ–¥–ª–∞–π–Ω: '+t.deadline+', '+t.direction+'\n');
    r += '\nüí° –†–∞–∑–æ–±—Ä–∞—Ç—å –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ, –æ–±–Ω–æ–≤–∏—Ç—å –¥–µ–¥–ª–∞–π–Ω—ã.';
    return r;
  }
  if (ml.includes('–æ—Ç—á—ë—Ç') || ml.includes('–æ—Ç—á–µ—Ç') || ml.includes('report')) {
    let r = 'üìä **–°–≤–æ–¥–∫–∞ RKT HUB:**\n\n';
    for (const [name, info] of Object.entries(ctx.projects)) r += '‚Ä¢ **'+name+'**: '+info.subprojects+' –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π, '+info.tasks+' –∑–∞–¥–∞—á\n';
    r += '\nüë• –°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤: '+ctx.staff_count+'\nü§ù –ü–∞—Ä—Ç–Ω—ë—Ä–æ–≤: '+ctx.partners_count;
    r += '\nüî¥ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ: '+ctx.overdue.length+'\n‚ö†Ô∏è –ë–ª–∏–∂–∞–π—à–∏–µ: '+ctx.upcoming.length;
    if (ctx.overdue.length) { r += '\n\n**–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ:**\n'; ctx.overdue.slice(0,5).forEach(t => r += '‚Ä¢ '+t.task+' ('+t.deadline+')\n'); }
    return r;
  }
  if (ml.includes('–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç') || ml.includes('priority')) {
    let r = '‚≠ê **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã:**\n';
    if (ctx.overdue.length) { r += '1. üî¥ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ ('+ctx.overdue.length+'):\n'; ctx.overdue.forEach(t => r += '   ‚Ä¢ '+t.task+'\n'); }
    if (ctx.upcoming.length) r += '2. ‚è∞ –ë–ª–∏–∂–∞–π—à–∏–µ: '+ctx.upcoming.map(t=>t.task).join(', ')+'\n';
    r += '3. üìÇ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å—ã –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º';
    return r;
  }
  if (ml.includes('–ø–ª–∞–Ω')) {
    return 'üìã **–ü–ª–∞–Ω –Ω–∞ –Ω–µ–¥–µ–ª—é:**\n‚Ä¢ –ü–Ω: –†–µ–≤—å—é —Å—Ç–∞—Ç—É—Å–æ–≤\n‚Ä¢ –í—Ç-–°—Ä: –ö–ª—é—á–µ–≤—ã–µ –∑–∞–¥–∞—á–∏\n‚Ä¢ –ß—Ç: –í—Å—Ç—Ä–µ—á–∏ —Å –ø–∞—Ä—Ç–Ω—ë—Ä–∞–º–∏\n‚Ä¢ –ü—Ç: –ò—Ç–æ–≥–∏\n\nüìå –ó–∞–¥–∞—á: '+ctx.total_tasks+' | –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ: '+ctx.overdue.length+' | –ö–æ–º–∞–Ω–¥–∞: '+ctx.staff_count;
  }
  if (ml.includes('–ø–∏—Å—å–º') || ml.includes('email')) {
    return 'üìß –ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º—É –∏ –æ —á—ë–º. –ü—Ä–∏–º–µ—Ä—ã:\n‚Ä¢ ¬´–ü–∏—Å—å–º–æ –ø–∞—Ä—Ç–Ω—ë—Ä—É Syno Medical –æ —Å—Ç–∞—Ç—É—Å–µ –ø–æ—Å—Ç–∞–≤–∫–∏¬ª\n‚Ä¢ ¬´–ü–∏—Å—å–º–æ –∫–ª–∏–µ–Ω—Ç—É –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å–∞–π—Ç–∞¬ª';
  }
  if (ml.includes('—Ä–∏—Å–∫')) {
    let r = '‚ö†Ô∏è **–†–∏—Å–∫–∏:**\n';
    if (ctx.overdue.length) r += '1. üî¥ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ ('+ctx.overdue.length+')\n';
    r += '2. –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤\n3. –°—Ä–æ–∫–∏ –ø–æ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–º –ø—Ä–æ–µ–∫—Ç–∞–º';
    return r;
  }
  if (ml.includes('–∫–æ–º–∞–Ω–¥') || ml.includes('—Å–æ—Ç—Ä—É–¥–Ω–∏–∫') || ml.includes('–∫—Ç–æ –≤')) {
    let r = 'üë• **–ö–æ–º–∞–Ω–¥–∞ ('+DATA.staff.length+'):**\n';
    DATA.staff.forEach(s => r += '‚Ä¢ '+(ROLES[s['–†–æ–ª—å']]?.emoji||'üë§')+' '+(s['–ò–º—è']||'?')+' ‚Äî '+(s['–†–æ–ª—å']||'?')+', '+(s['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'–í—Å–µ')+'\n');
    return r;
  }
  if (ml.includes('–ø–∞—Ä—Ç–Ω—ë—Ä') || ml.includes('–ø–∞—Ä—Ç–Ω–µ—Ä')) {
    let r = 'ü§ù **–ü–∞—Ä—Ç–Ω—ë—Ä—ã ('+DATA.partners.length+'):**\n';
    DATA.partners.forEach(p => r += '‚Ä¢ '+(p['–ù–∞–∑–≤–∞–Ω–∏–µ']||'?')+' ('+(p['–°—Ç—Ä–∞–Ω–∞']||'?')+') ‚Äî '+(p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'?')+', '+(p['–°—Ç–∞—Ç—É—Å']||'?')+'\n');
    return r;
  }
  return 'ü§ñ –í —Å–∏—Å—Ç–µ–º–µ '+ctx.total_tasks+' –∑–∞–¥–∞—á, '+ctx.staff_count+' —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤, '+ctx.partners_count+' –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤.\n\nüí° –°–ø—Ä–æ—Å–∏—Ç–µ:\n‚Ä¢ **–ü–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é:** ¬´—á—Ç–æ –ø–æ –ö–¢?¬ª, ¬´—Å—Ç–∞—Ç—É—Å —Ä–æ–±–æ—Ç–æ–≤¬ª\n‚Ä¢ **–ó–∞–¥–∞—á–∏:** ¬´–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ¬ª, ¬´–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã¬ª\n‚Ä¢ **–û—Ç—á—ë—Ç:** ¬´–æ—Ç—á—ë—Ç¬ª, ¬´–ø–ª–∞–Ω –Ω–∞ –Ω–µ–¥–µ–ª—é¬ª\n‚Ä¢ **–ö–æ–º–∞–Ω–¥–∞:** ¬´–∫—Ç–æ –≤ –∫–æ–º–∞–Ω–¥–µ?¬ª\n‚Ä¢ **–ü–∏—Å—å–º–æ:** ¬´–Ω–∞–ø–∏—à–∏ –ø–∏—Å—å–º–æ –ø–∞—Ä—Ç–Ω—ë—Ä—É X¬ª';
}

function openModal(type, existingData) {
  if (type === 'newproject') {
    openAddProjectModal();
    return;
  }

  currentModal = type;
  editingItem = existingData || null;
  const def = FORM_DEFS[type];
  if(!def) return;

  // Auto-set direction
  const autoDir = currentSubproject || null;

  document.getElementById('modalTitle').textContent = (editingItem?'‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å: ':'‚ûï –î–æ–±–∞–≤–∏—Ç—å: ') + def.title;

  let html = '';
  for (const field of def.fields) {
    const val = editingItem ? (editingItem[field.name]||'') : (field.name==='–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'&&autoDir ? autoDir : '');
    const req = field.required ? 'required' : '';

    html += '<div class="form-group"><label class="'+req+'">'+esc(field.name)+'</label>';
    const opts = typeof field.options === 'function' ? field.options() : field.options;

    if (field.type==='select') {
      const changeAttr = field.onchange ? ' onchange="'+field.onchange+'"' : '';
      html += '<select id="field-'+field.name+'"'+changeAttr+'>';
      for (const o of (opts||[])) html += '<option value="'+escA(o)+'"'+(val===o?' selected':'')+'>'+esc(o)+'</option>';
      html += '</select>';
    } else if (field.type==='textarea') {
      html += '<textarea id="field-'+field.name+'" placeholder="'+escA(field.placeholder||'')+'">'+esc(val)+'</textarea>';
    } else {
      html += '<input type="'+field.type+'" id="field-'+field.name+'" value="'+escA(val)+'" placeholder="'+escA(field.placeholder||'')+'">';
    }
    html += '</div>';
  }

  // Add extra_projects multi-select for CEO editing staff
  if (type === 'staff' && getUserPerms().seeAll) {
    const projNames = Object.values(PROJECTS).map(p => p.name);
    let extraProjects = [];
    try { extraProjects = JSON.parse((editingItem && editingItem['–î–æ–ø_–ø—Ä–æ–µ–∫—Ç—ã']) || '[]'); } catch(e) {}
    html += '<div class="form-group"><label>–î–æ–ø. –ø—Ä–æ–µ–∫—Ç—ã (CEO)</label>';
    html += '<div id="extra-projects-checkboxes" style="display:flex;flex-wrap:wrap;gap:8px;padding:8px 0">';
    projNames.forEach(pn => {
      const checked = extraProjects.includes(pn) ? ' checked' : '';
      html += '<label style="display:flex;align-items:center;gap:4px;cursor:pointer;font-size:13px">';
      html += '<input type="checkbox" class="extra-proj-cb" value="'+escA(pn)+'"'+checked+'> '+esc(pn);
      html += '</label>';
    });
    html += '</div></div>';
  }

  document.getElementById('modalBody').innerHTML = html;
  document.getElementById('modalOverlay').classList.add('show');

  // Auto-filter directions by selected project (for staff form)
  if (type === 'staff') {
    const projSel = document.getElementById('field-–ü—Ä–æ–µ–∫—Ç');
    if (projSel) updateDirectionOptions(projSel.value);
    if (editingItem) {
      const dirSel = document.getElementById('field-–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ');
      if (dirSel) dirSel.value = editingItem['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] || '–í—Å–µ';
    }
  }
  
  setTimeout(() => { const f=document.getElementById('field-'+def.fields[0].name); if(f)f.focus(); }, 200);
}

function openAddProjectModal() {
  currentModal = 'newproject';
  document.getElementById('modalTitle').textContent = '‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç';
  document.getElementById('modalBody').innerHTML =
    '<div class="form-group"><label class="required">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</label><input type="text" id="field-projname" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç"></div>'+
    '<div class="form-group"><label>Emoji</label><input type="text" id="field-projemoji" placeholder="üè¢" value="üè¢"></div>'+
    '<div class="form-group"><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea id="field-projdesc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞..."></textarea></div>'+
    '<div class="form-group"><label>–¶–≤–µ—Ç</label><select id="field-projcolor"><option value="var(--accent)">–ó–µ–ª—ë–Ω—ã–π</option><option value="var(--blue)">–°–∏–Ω–∏–π</option><option value="var(--purple)">–§–∏–æ–ª–µ—Ç–æ–≤—ã–π</option><option value="var(--orange)">–û—Ä–∞–Ω–∂–µ–≤—ã–π</option><option value="var(--pink)">–†–æ–∑–æ–≤—ã–π</option></select></div>';
  document.getElementById('modalOverlay').classList.add('show');
}

function openAddSubproject() {
  const projName = PROJECTS[currentProject]?.name || '';
  
  if (projName === '–°–∞–π—Ç—ã') {
    // Special modal for adding site client
    const types = Object.entries(SITE_PRICING).map(([k,v]) => 
      '<option value="'+k+'">'+v.emoji+' '+k+' ‚Äî '+v.price.toLocaleString("ru")+'‚ÇΩ</option>'
    ).join('');
    
    showCustomModal('üåê –ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç', `
      <div class="form-group"><label>üìã –ù–∞–∑–≤–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å–∞ *</label><input type="text" id="nc-name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü–∏—Ü—Ü–µ—Ä–∏—è –ú–∞—Ä–∏–æ"></div>
      <div class="form-group"><label>üë§ –ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ</label><input type="text" id="nc-contact" placeholder="–ò–º—è –≤–ª–∞–¥–µ–ª—å—Ü–∞/–º–µ–Ω–µ–¥–∂–µ—Ä–∞"></div>
      <div class="form-group"><label>üì± –¢–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–µ–Ω—Ç–∞</label><input type="text" id="nc-phone" placeholder="+7..."></div>
      <div class="form-group"><label>üåê –¢–∏–ø —Å–∞–π—Ç–∞</label><select id="nc-type">`+types+`</select></div>
      <div class="form-group"><label>üìç –ì–æ—Ä–æ–¥</label><input type="text" id="nc-city" placeholder="–ì–æ—Ä–æ–¥"></div>
      <div class="form-group"><label>üì° –ò—Å—Ç–æ—á–Ω–∏–∫ –ª–∏–¥–∞</label><select id="nc-source">
        <option value="–Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç—ã">üó∫Ô∏è –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç—ã</option>
        <option value="2–ì–ò–°">üìç 2–ì–ò–°</option>
        <option value="Google Maps">üåê Google Maps</option>
        <option value="Instagram">üì∑ Instagram</option>
        <option value="VK">üí¨ VK</option>
        <option value="–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è">ü§ù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è</option>
        <option value="–•–æ–ª–æ–¥–Ω—ã–π –∑–≤–æ–Ω–æ–∫">üìû –•–æ–ª–æ–¥–Ω—ã–π –∑–≤–æ–Ω–æ–∫</option>
        <option value="–î—Ä—É–≥–æ–µ">üìå –î—Ä—É–≥–æ–µ</option>
      </select></div>
      <div class="form-group"><label>üîó –°—Å—ã–ª–∫–∞ (–∫–∞—Ä—Ç—ã, —Å–æ—Ü—Å–µ—Ç–∏)</label><input type="text" id="nc-link" placeholder="https://..."></div>
      <div class="form-group"><label>üìÖ –ö–æ–≥–¥–∞ –ø–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å</label><input type="date" id="nc-followup"></div>
      <div class="form-group"><label>üìù –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label><textarea id="nc-desc" rows="2" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ –∫–ª–∏–µ–Ω—Ç—É? –ö–∞–∫–∏–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏?"></textarea></div>
    `, async () => {
      const name = document.getElementById('nc-name').value.trim();
      if (!name) { toast('‚ùå –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ','error'); return; }
      
      const type = document.getElementById('nc-type').value;
      const pricing = SITE_PRICING[type] || SITE_PRICING['–õ–µ–Ω–¥–∏–Ω–≥'];
      const city = document.getElementById('nc-city').value.trim();
      const phone = document.getElementById('nc-phone').value.trim();
      const link = document.getElementById('nc-link').value.trim();
      const desc = document.getElementById('nc-desc').value.trim();
      const source = document.getElementById('nc-source').value;
      const contact = document.getElementById('nc-contact').value.trim();
      const followup = document.getElementById('nc-followup').value;
      
      // 1. Create direction (client)
      const dirRow = {
        '–ù–∞–∑–≤–∞–Ω–∏–µ': name,
        '–ü—Ä–æ–µ–∫—Ç': '–°–∞–π—Ç—ã',
        '–°—Ç–∞—Ç—É—Å': '–í —Ä–∞–±–æ—Ç–µ',
        'stage': 'prospect',
        '–¢–∏–ø —Å–∞–π—Ç–∞': type,
        '–¶–µ–Ω–∞': pricing.price,
        '–û–ø–ª–∞—á–µ–Ω–æ': false,
        '–ö–ª–∏–µ–Ω—Ç': contact || name,
        '–¢–µ–ª–µ—Ñ–æ–Ω': phone,
        '–ì–æ—Ä–æ–¥': city,
        '–°—Å—ã–ª–∫–∞': link,
        '–û–ø–∏—Å–∞–Ω–∏–µ': desc,
        '–ò—Å—Ç–æ—á–Ω–∏–∫': source,
        '–°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç': followup || addDays(today(), 1),
        '–ú–µ–Ω–µ–¥–∂–µ—Ä': USER?.name || '',
        '–ö–∞—Å–∞–Ω–∏—è': 0,
        '–°–æ–∑–¥–∞–Ω': today()
      };
      
      const ok1 = await apiWrite('–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è', dirRow);
      if (!ok1) { toast('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞','error'); return; }
      
      // 2. Auto-create pipeline tasks
      const td = today();
      const tasks = SITE_PIPELINE.map(step => ({
        '–û–ø–∏—Å–∞–Ω–∏–µ': step.name + ': ' + name,
        '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ': name,
        '–ü—Ä–æ–µ–∫—Ç': '–°–∞–π—Ç—ã',
        '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç': 'P2',
        '–°—Ç–∞—Ç—É—Å': step.step === 1 ? '–í —Ä–∞–±–æ—Ç–µ' : '‚è≥ –í –æ—á–µ—Ä–µ–¥–∏',
        '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π': getSiteStaffByRole(step.role),
        '–î–µ–¥–ª–∞–π–Ω': addDays(td, step.days)
      }));
      
      for (const t of tasks) {
        await apiWrite('–ó–∞–¥–∞—á–∏', t);
      }
      
      toast('‚úÖ –ö–ª–∏–µ–Ω—Ç ¬´'+name+'¬ª —Å–æ–∑–¥–∞–Ω + '+tasks.length+' –∑–∞–¥–∞—á –≤ –≤–æ—Ä–æ–Ω–∫–µ','success');
      closeCustomModal();
      await loadData();
      syncSubprojectsFromDb(currentProject);
      renderProjectView();
    });
  } else {
    // Generic ‚Äî open directions modal
    openModal('–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è');
  }
}

function addDays(dateStr, days) {
  const d = new Date(dateStr);
  d.setDate(d.getDate() + days);
  return d.toISOString().split('T')[0];
}

function showCustomModal(title, bodyHtml, onSave) {
  window._customModalSave = onSave;
  document.getElementById('modalTitle').textContent = title;
  document.getElementById('modalBody').innerHTML = bodyHtml;
  document.getElementById('modalSaveBtn').onclick = () => { if(window._customModalSave) window._customModalSave(); };
  document.getElementById('modalOverlay').classList.add('show');
}

function closeCustomModal() {
  document.getElementById('modalOverlay').classList.remove('show');
  window._customModalSave = null;
}


function closeModal() {
  document.getElementById('modalOverlay').classList.remove('show');
  document.getElementById('modalBox').classList.remove('wide');
  currentModal = '';
  editingItem = null;
}

// Send Telegram notification when task is assigned to staff
async function notifyTaskAssigned(taskDesc, assigneeName, direction) {
  addNotification('–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞: ' + taskDesc + ' ‚Üí ' + assigneeName, 'task');
  if (!assigneeName) return;
  // Find staff member's telegram_id
  const staff = DATA.staff.find(s => (s['–ò–º—è']||'').includes(assigneeName) || (assigneeName||'').includes(s['–ò–º—è']||'___'));
  if (!staff) return;
  const tgId = staff['Telegram_ID'] || staff.telegram_id;
  if (!tgId) return;
  
  try {
    await fetch(CONFIG.AI_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'notify',
        source: 'web',
        chatId: tgId,
        message: 'üìã *–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞!*\n\n' + taskDesc + '\nüìÅ ' + (direction||'') + '\nüë§ –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: ' + assigneeName + '\n\nüåê –û—Ç–∫—Ä–æ–π—Ç–µ RKT HUB –¥–ª—è –¥–µ—Ç–∞–ª–µ–π'
      })
    });
  } catch(e) { console.warn('Notification failed:', e); }
}

async function saveModal() {
  // Handle new project
  if (currentModal === 'newproject') {
    const name = document.getElementById('field-projname').value.trim();
    if (!name) { toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ','warning'); return; }
    const key = name.toLowerCase().replace(/[^a-z–∞-—è—ë0-9]/gi,'_');
    const emoji = document.getElementById('field-projemoji').value.trim() || 'üìÅ';
    const desc = document.getElementById('field-projdesc').value.trim();
    const color = document.getElementById('field-projcolor').value;

    PROJECTS[key] = {
      name: name, emoji: emoji, color: color,
      gradient: 'linear-gradient(90deg, '+color+', '+color+')',
      desc: desc, subprojects: {}, canAddSub: true
    };
    closeModal();
    renderAll();
    toast('‚úÖ –ü—Ä–æ–µ–∫—Ç ¬´'+name+'¬ª —Å–æ–∑–¥–∞–Ω!','success');
    return;
  }

  // Handle new subproject
  if (currentModal === 'newsubproject') {
    const name = document.getElementById('field-subname').value.trim();
    if (!name) { toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ','warning'); return; }
    const emoji = document.getElementById('field-subemoji').value.trim() || 'üìå';
    const desc = document.getElementById('field-subdesc').value.trim();
    const proj = PROJECTS[currentProject];
    if (!proj) return;

    proj.subprojects[name] = { emoji: emoji, color: proj.color, desc: desc };

    // If site project, save extra questionnaire fields
    if (proj.canAddSub) {
      const url = document.getElementById('field-suburl')?.value || '';
      const client = document.getElementById('field-subclient')?.value || '';
      const phone = document.getElementById('field-subphone')?.value || '';
      const bizname = document.getElementById('field-subbizname')?.value || '';
      const biztype = document.getElementById('field-subbiztype')?.value || '';
      const email = document.getElementById('field-subemail')?.value || '';
      const city = document.getElementById('field-subcity')?.value || '';
      const style = document.getElementById('field-substyle')?.value || '';
      const colors = document.getElementById('field-subcolors')?.value || '';
      const pages = document.getElementById('field-subpages')?.value || '';
      const wishes = document.getElementById('field-subwishes')?.value || '';
      const domain = document.getElementById('field-subdomain')?.value || '';
      const budget = document.getElementById('field-subbudget')?.value || '';
      const deadline = document.getElementById('field-subdeadline')?.value || '';
      const content = document.getElementById('field-subcontent')?.value || '';
      const siteType = document.getElementById('field-subsitetype')?.value || '–õ–µ–Ω–¥–∏–Ω–≥';
      const pricing = SITE_PRICING[siteType] || SITE_PRICING['–õ–µ–Ω–¥–∏–Ω–≥'];

      // Build questionnaire JSON for AI
      const questionnaire = JSON.stringify({
        bizname, biztype, client, phone, email, city,
        style, colors, pages, wishes, domain, budget, deadline, content, url, siteType
      }).substring(0, 900);

      await apiWrite('–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è', {
        ID: 'DIR'+String(Date.now()).slice(-6),
        '–ù–∞–∑–≤–∞–Ω–∏–µ': name,
        '–ü—Ä–æ–µ–∫—Ç': proj.name,
        '–û–ø–∏—Å–∞–Ω–∏–µ': desc,
        '–°—Å—ã–ª–∫–∞': url,
        '–ö–ª–∏–µ–Ω—Ç': client,
        '–¢–µ–ª–µ—Ñ–æ–Ω': phone,
        '–ì–æ—Ä–æ–¥': city,
        '–¢–∏–ø –±–∏–∑–Ω–µ—Å–∞': biztype,
        '–¢–∏–ø —Å–∞–π—Ç–∞': siteType,
        '–¶–µ–Ω–∞': String(pricing.price),
        '–°—Ç–∏–ª—å': style,
        '–ê–Ω–∫–µ—Ç–∞': questionnaire,
        'stage': 'prospect',
        '–ú–µ–Ω–µ–¥–∂–µ—Ä': USER?.name || '',
        '–°—Ç–∞—Ç—É—Å': '–í —Ä–∞–±–æ—Ç–µ'
      });
    }

    document.getElementById('modalBox').classList.remove('wide');
    closeModal();
    renderAll();
    if(currentProject) renderProjectView();
    toast('‚úÖ –ü–æ–¥–ø—Ä–æ–µ–∫—Ç ¬´'+name+'¬ª –¥–æ–±–∞–≤–ª–µ–Ω!','success');

    // Notify managers about new client in pipeline
    if (PROJECTS[currentProject] && PROJECTS[currentProject].name === '–°–∞–π—Ç—ã') {
      notifyStaffByRole('–°–∞–π—Ç—ã', '–ú–µ–Ω–µ–¥–∂–µ—Ä',
        'üÜï *–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç –≤ –≤–æ—Ä–æ–Ω–∫–µ!*\n\n' +
        'üè™ ' + name + '\n' +
        'üë§ –î–æ–±–∞–≤–∏–ª: ' + (USER?.name||'') + '\n' +
        '\nüåê –û—Ç–∫—Ä–æ–π—Ç–µ RKT HUB –¥–ª—è –¥–µ—Ç–∞–ª–µ–π'
      );
    }

    // Auto-create pipeline tasks for site projects with role-based assignment
    if (PROJECTS[currentProject] && PROJECTS[currentProject].canAddSub) {
      const td = today();
      for (const step of SITE_PIPELINE) {
        const assigned = getSiteStaffByRole(step.role);
        const dl = new Date(); dl.setDate(dl.getDate() + step.days);
        apiWrite('–ó–∞–¥–∞—á–∏', {
          ID: 'T'+String(Date.now()).slice(-6)+String(Math.random()).slice(2,4),
          '–û–ø–∏—Å–∞–Ω–∏–µ': step.name + ' –¥–ª—è ¬´'+name+'¬ª',
          '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ': name,
          '–ü—Ä–æ–µ–∫—Ç': PROJECTS[currentProject].name,
          '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç': step.step <= 3 ? 'P1' : (step.step <= 6 ? 'P2' : 'P3'),
          '–°—Ç–∞—Ç—É—Å': step.step === 1 ? '–í —Ä–∞–±–æ—Ç–µ' : '‚è≥ –í –æ—á–µ—Ä–µ–¥–∏',
          '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π': assigned,
          '–î–µ–¥–ª–∞–π–Ω': dl.toISOString().split('T')[0],
          '–°–æ–∑–¥–∞–Ω–æ': td
        });
      }
      toast('üìã –°–æ–∑–¥–∞–Ω–æ '+SITE_PIPELINE.length+' –∑–∞–¥–∞—á –¥–ª—è ¬´'+name+'¬ª —Å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è–º–∏', 'info');
      // Notify all assigned staff
      for (const step of SITE_PIPELINE) {
        const assigned = getSiteStaffByRole(step.role);
        if (assigned) notifyTaskAssigned(step.name + ' –¥–ª—è ¬´'+name+'¬ª', assigned, name);
      }
    }
    return;
  }

  // Standard form save
  const def = FORM_DEFS[currentModal];
  if(!def) return;

  for (const field of def.fields) {
    if (field.required) {
      const el = document.getElementById('field-'+field.name);
      if(!el||!el.value.trim()) { toast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ ¬´'+field.name+'¬ª','warning'); if(el)el.focus(); return; }
    }
  }

  const row = {};
  row.ID = editingItem ? editingItem.ID : currentModal.charAt(0).toUpperCase()+String(Date.now()).slice(-6);

  for (const field of def.fields) {
    const el = document.getElementById('field-'+field.name);
    let val = el ? el.value : '';
    // Sanitize number fields: empty ‚Üí null, otherwise parseInt
    if (field.type === 'number') {
      val = (val === '' || val === null || val === undefined) ? null : parseInt(val, 10);
      if (val !== null && isNaN(val)) val = null;
    }
    row[field.name] = val;
  }

  // Collect extra_projects checkboxes for staff
  if (currentModal === 'staff') {
    const cbs = document.querySelectorAll('.extra-proj-cb');
    if (cbs.length) {
      const selected = [];
      cbs.forEach(cb => { if (cb.checked) selected.push(cb.value); });
      row['–î–æ–ø_–ø—Ä–æ–µ–∫—Ç—ã'] = JSON.stringify(selected);
    }
  }

  const td = today();
  if(def.sheet==='–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏'&&!editingItem) {
    row['–°—Ç–∞—Ç—É—Å']='–ê–∫—Ç–∏–≤–Ω—ã–π'; row['–î–∞—Ç–∞_–¥–æ–±–∞–≤–ª–µ–Ω–∏—è']=td;
    // Set default salary_pct based on role if not explicitly set
    if (row['–ü—Ä–æ—Ü–µ–Ω—Ç_–ó–ü'] === null || row['–ü—Ä–æ—Ü–µ–Ω—Ç_–ó–ü'] === undefined || row['–ü—Ä–æ—Ü–µ–Ω—Ç_–ó–ü'] === '' || row['–ü—Ä–æ—Ü–µ–Ω—Ç_–ó–ü'] === 0) {
      row['–ü—Ä–æ—Ü–µ–Ω—Ç_–ó–ü'] = DEFAULT_SALARY_PCT[row['–†–æ–ª—å']] || 0;
    }
  }
  if(def.sheet==='–ü—Ä–æ–µ–∫—Ç—ã') { if(!editingItem) row['–°–æ–∑–¥–∞–Ω–æ']=td; row['–û–±–Ω–æ–≤–ª–µ–Ω–æ']=td; }
  if(def.sheet==='–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏'&&!editingItem) { row['–î–∞—Ç–∞']=td; row['–ê–≤—Ç–æ—Ä']=USER?USER.name:''; }

  const perms = getUserPerms();
  const writeAccess = canDirectWrite(def.sheet);

  // Allow CEO to write directly; for staff sheet, allow self-registration for guests
  if (writeAccess === 'denied' && def.sheet !== '–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏') {
    toast('‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ ¬´'+def.sheet+'¬ª','error');
    return;
  }
  // If denied for staff but user is not logged in, allow as approval request
  if (writeAccess === 'denied' && def.sheet === '–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏') {
    // Self-register: write directly (will be inactive until CEO approves)
    row['–°—Ç–∞—Ç—É—Å'] = '–û–∂–∏–¥–∞–µ—Ç';
    document.getElementById('modalSaveBtn').disabled = true;
    const ok = await apiWrite('–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏', row);
    document.getElementById('modalSaveBtn').disabled = false;
    if(ok) toast('‚è≥ –ó–∞—è–≤–∫–∞ –Ω–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞. CEO –¥–æ–ª–∂–µ–Ω –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å.','info');
    closeModal();
    debouncedLoadData();
    return;
  }

  if (writeAccess === 'approval') {
    const approvalRow = {
      ID: 'APR'+String(Date.now()).slice(-6),
      '–¢–∏–ø': (editingItem ? '–ò–∑–º–µ–Ω–µ–Ω–∏–µ' : '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ') + ': '+def.title,
      '–û–ø–∏—Å–∞–Ω–∏–µ': row['–ù–∞–∑–≤–∞–Ω–∏–µ']||row['–û–ø–∏—Å–∞–Ω–∏–µ']||row['–ò–º—è']||row['–ü–∞—Ä—Ç–Ω—ë—Ä']||'',
      '–û—Ç_–∫–æ–≥–æ': USER?USER.name:'',
      '–†–æ–ª—å': USER?USER.role:'',
      'Telegram_ID': USER?USER.tgId:'',
      '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ': row['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'',
      '–ü—Ä–æ–µ–∫—Ç': row['–ü—Ä–æ–µ–∫—Ç']||'',
      '–õ–∏—Å—Ç': def.sheet,
      '–°—Ç–∞—Ç—É—Å': '‚è≥ –û–∂–∏–¥–∞–µ—Ç',
      '–î–∞—Ç–∞_–∑–∞–ø—Ä–æ—Å–∞': td,
      '–î–∞–Ω–Ω—ã–µ': JSON.stringify(row).substring(0,900)
    };
    document.getElementById('modalSaveBtn').disabled = true;
    const ok = await apiWrite('–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è', approvalRow);
    document.getElementById('modalSaveBtn').disabled = false;
    if(ok) {
      toast('‚è≥ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ CEO','info');
      notifyCEO('üì¨ *–ó–∞–ø—Ä–æ—Å –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ*\n\n' +
        'üìã ' + (approvalRow['–¢–∏–ø']||'') + ': ' + (approvalRow['–û–ø–∏—Å–∞–Ω–∏–µ']||'') + '\n' +
        'üë§ –û—Ç: ' + (approvalRow['–û—Ç_–∫–æ–≥–æ']||'') + '\n' +
        'üìÅ ' + (approvalRow['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||''));
    }
    closeModal();
    debouncedLoadData();
    return;
  }

  // Direct write
  document.getElementById('modalSaveBtn').disabled = true;
  const ok = await apiWrite(def.sheet, row);
  document.getElementById('modalSaveBtn').disabled = false;
  if(ok) {
    toast('‚úÖ '+def.title+' —Å–æ—Ö—Ä–∞–Ω—ë–Ω!','success');
    // Notify assignee if task created/assigned
    if (def.sheet === '–ó–∞–¥–∞—á–∏' && row['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π'] && !editingItem) {
      notifyTaskAssigned(row['–û–ø–∏—Å–∞–Ω–∏–µ']||row['–ù–∞–∑–≤–∞–Ω–∏–µ']||'', row['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π'], row['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']);
    }
    // Notify assignee if task status changed (editing existing task)
    if (def.sheet === '–ó–∞–¥–∞—á–∏' && editingItem && editingItem['–°—Ç–∞—Ç—É—Å'] !== row['–°—Ç–∞—Ç—É—Å']) {
      notifyTaskStatusChange(row, editingItem['–°—Ç–∞—Ç—É—Å'], row['–°—Ç–∞—Ç—É—Å']);
    }
    // Notify CEO about new approval requests
    if (def.sheet === '–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è') {
      notifyCEO('üì¨ *–ù–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ*\n\n' +
        'üìã ' + (row['–û–ø–∏—Å–∞–Ω–∏–µ']||row['–¢–∏–ø']||'') + '\n' +
        'üë§ –û—Ç: ' + (row['–û—Ç_–∫–æ–≥–æ']||'') + '\n' +
        'üìÅ ' + (row['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||''));
    }
  }

  // Auto-delegation: if task in site pipeline is marked done, create next step
  if (def.sheet === '–ó–∞–¥–∞—á–∏' && (row['–°—Ç–∞—Ç—É—Å'] === '–ì–æ—Ç–æ–≤–æ' || row['–°—Ç–∞—Ç—É—Å'] === '‚úÖ –ì–æ—Ç–æ–≤–æ') && row['–ü—Ä–æ–µ–∫—Ç'] === '–°–∞–π—Ç—ã') {
    await autoDelegate(row);
  }
  
  closeModal();
  debouncedLoadData();
}

// ============================================================
// AUTO-DELEGATION: When a pipeline task is done, create next step
// ============================================================
async function autoDelegate(completedTask) {
  const desc = completedTask['–û–ø–∏—Å–∞–Ω–∏–µ'] || completedTask['–ù–∞–∑–≤–∞–Ω–∏–µ'] || '';
  const direction = completedTask['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] || '';
  
  // Find which pipeline step was completed
  let currentStep = -1;
  SITE_PIPELINE.forEach((p, i) => {
    const keywords = p.name.replace(/[^\w–∞-—è—ë]/gi, ' ').toLowerCase().split(/\s+/).filter(w => w.length > 3);
    if (keywords.some(k => desc.toLowerCase().includes(k))) currentStep = i;
  });
  
  if (currentStep < 0 || currentStep >= SITE_PIPELINE.length - 1) return;
  
  const nextStep = SITE_PIPELINE[currentStep + 1];
  const assigned = getSiteStaffByRole(nextStep.role);
  
  const dl = new Date();
  dl.setDate(dl.getDate() + (nextStep.days - SITE_PIPELINE[currentStep].days));
  
  const nextTask = {
    ID: 'T' + String(Date.now()).slice(-6) + String(Math.random()).slice(2,4),
    '–û–ø–∏—Å–∞–Ω–∏–µ': nextStep.name + ' –¥–ª—è ¬´' + direction + '¬ª',
    '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ': direction,
    '–ü—Ä–æ–µ–∫—Ç': '–°–∞–π—Ç—ã',
    '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç': currentStep < 3 ? 'P1' : 'P2',
    '–°—Ç–∞—Ç—É—Å': '‚è≥ –í –æ—á–µ—Ä–µ–¥–∏',
    '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π': assigned,
    '–î–µ–¥–ª–∞–π–Ω': dl.toISOString().split('T')[0],
    '–°–æ–∑–¥–∞–Ω–æ': today()
  };
  
  await apiWrite('–ó–∞–¥–∞—á–∏', nextTask);
  toast('üîÑ –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–æ: ' + nextStep.name + ' ‚Üí ' + assigned, 'info');
  
  // If next step needs CEO approval (step 9), create approval
  if (nextStep.role === 'CEO') {
    await apiWrite('–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è', {
      ID: 'APR' + String(Date.now()).slice(-6),
      '–¢–∏–ø': '–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ —Å–¥–∞—á–∏',
      '–û–ø–∏—Å–∞–Ω–∏–µ': '–°–¥–∞—á–∞ –ø—Ä–æ–µ–∫—Ç–∞ ¬´' + direction + '¬ª',
      '–û—Ç_–∫–æ–≥–æ': completedTask['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π'] || '',
      '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ': direction,
      '–ü—Ä–æ–µ–∫—Ç': '–°–∞–π—Ç—ã',
      '–õ–∏—Å—Ç': '–ó–∞–¥–∞—á–∏',
      '–°—Ç–∞—Ç—É—Å': '‚è≥ –û–∂–∏–¥–∞–µ—Ç',
      '–î–∞—Ç–∞_–∑–∞–ø—Ä–æ—Å–∞': today()
    });
    toast('üëë –ó–∞–ø—Ä–æ—Å –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ CEO –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', 'info');
  }
}

// ============================================================
// VIEW / EDIT / DELETE
// ============================================================
function viewItem(type, id) {
  const map = {partner:'partners',project:'projects',task:'tasks',staff:'staff',comm:'comms'};
  const item = DATA[map[type]]?.find(i => i.ID===id);
  if(!item) return;

  document.getElementById('detailTitle').textContent = 'üìã '+(item['–ù–∞–∑–≤–∞–Ω–∏–µ']||item['–û–ø–∏—Å–∞–Ω–∏–µ']||item['–ò–º—è']||item['–ü–∞—Ä—Ç–Ω—ë—Ä']||'–î–µ—Ç–∞–ª–∏');

  const fields = Object.entries(item).filter(([k])=>k!=='row_number');
  let html = '<div class="detail-grid">';
  for (const [k,v] of fields) {
    if(!v&&v!==0) continue;
    const long = String(v).length > 60;
    html += '<div class="detail-item '+(long?'detail-full':'')+'"><div class="detail-label">'+esc(k)+'</div><div class="detail-value">'+esc(v)+'</div></div>';
  }
  html += '</div>';
  document.getElementById('detailBody').innerHTML = html;
  document.getElementById('detailEditBtn').onclick = function() { closeDetail(); editItem(type,id); };
  document.getElementById('detailOverlay').classList.add('show');
}

function closeDetail() { document.getElementById('detailOverlay').classList.remove('show'); }

function editItem(type, id) {
  const map = {partner:'partners',project:'projects',task:'tasks',staff:'staff',comm:'comms'};
  const item = DATA[map[type]]?.find(i => i.ID===id);
  if(item) openModal(type, item);
}

function confirmDelete(type, id, name) {
  if(!getUserPerms().canDelete) { toast('‚õî –¢–æ–ª—å–∫–æ CEO','error'); return; }
  const isDirection = (type === 'direction');
  document.getElementById('confirmTitle').textContent = isDirection ? 'üóë –£–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞?' : '–£–¥–∞–ª–∏—Ç—å?';
  document.getElementById('confirmText').textContent = isDirection
    ? '–ö–ª–∏–µ–Ω—Ç ¬´'+(name||id)+'¬ª –∏ –≤—Å–µ –µ–≥–æ –∑–∞–¥–∞—á–∏ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ.'
    : '¬´'+(name||id)+'¬ª –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞.';
  document.getElementById('confirmOverlay').classList.add('show');
  confirmCallback = async function(ok) {
    if(ok) {
      const sheetMap = {partner:'–ü–∞—Ä—Ç–Ω—ë—Ä—ã',task:'–ó–∞–¥–∞—á–∏',staff:'–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏',comm:'–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏',direction:'–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è'};
      const tableMap = {partner:'partners',task:'tasks',staff:'staff',comm:'communications',direction:'directions'};
      const dataMap = {partner:'partners',task:'tasks',staff:'staff',comm:'comms',direction:'directions'};
      try {
        const table = tableMap[type];
        if (table) {
          // Cascade delete for directions: delete related tasks first
          if (isDirection && name) {
            const relatedTasks = (DATA.tasks||[]).filter(t => (t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'') === name);
            for (const t of relatedTasks) {
              const taskId = t['ID'] || t.id;
              if (taskId) {
                try { await SB.from('tasks').delete().eq('id', taskId); } catch(te) { console.warn('Task delete err:', te); }
              }
            }
            if (typeof siteGenCache !== 'undefined') delete siteGenCache[name];
          }
          await SB.from(table).delete().eq('id', id);
        }
      } catch(e) {
        console.error('Delete error:', e);
        if (sheetMap[type]) {
          await apiWrite(sheetMap[type], { ID: id, '–°—Ç–∞—Ç—É—Å': '‚ùå –£–¥–∞–ª—ë–Ω' }, 'update');
        }
      }
      // Remove from local data
      if(DATA[dataMap[type]]) DATA[dataMap[type]] = DATA[dataMap[type]].filter(i=>(i.ID||i.id)!==id);
      if (isDirection && name) {
        DATA.tasks = (DATA.tasks||[]).filter(t => (t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'') !== name);
      }
      if (isDirection && currentDealId === id) closeSlideOver();
      renderAll();
      toast('üóë –£–¥–∞–ª–µ–Ω–æ','warning');
      debouncedLoadData();
    }
  };
}

function closeConfirm(r) {
  document.getElementById('confirmOverlay').classList.remove('show');
  if(confirmCallback) { confirmCallback(r); confirmCallback=null; }
}

// ============================================================
// APPROVALS
// ============================================================
async function handleApproval(id, approved) {
  const item = DATA.approvals.find(a=>a.ID===id);
  if(!item) return;
  item['–°—Ç–∞—Ç—É—Å'] = approved?'‚úÖ –û–¥–æ–±—Ä–µ–Ω–æ':'‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ';
  item['–î–∞—Ç–∞_—Ä–µ—à–µ–Ω–∏—è'] = today();
  item['–†–µ—à–µ–Ω–∏–µ_CEO'] = USER?USER.name:'';
  await apiWrite('–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è', item);

  // If approved and has data ‚Äî write to target sheet
  if (approved && item['–î–∞–Ω–Ω—ã–µ'] && item['–õ–∏—Å—Ç']) {
    try {
      const rowData = JSON.parse(item['–î–∞–Ω–Ω—ã–µ']);
      await apiWrite(item['–õ–∏—Å—Ç'], rowData);
      toast('‚úÖ –û–¥–æ–±—Ä–µ–Ω–æ –∏ –∑–∞–ø–∏—Å–∞–Ω–æ –≤ ¬´'+item['–õ–∏—Å—Ç']+'¬ª','success');
      
      // Send Telegram notification to the applicant
      if (rowData['Telegram_ID'] || rowData.Telegram_ID) {
        const tgId = rowData['Telegram_ID'] || rowData.Telegram_ID;
        const msg = approved 
          ? '‚úÖ –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∞!\n\nüë§ ' + (rowData['–ò–º—è']||'') + '\nüìã –†–æ–ª—å: ' + (rowData['–†–æ–ª—å']||'–°–æ—Ç—Ä—É–¥–Ω–∏–∫') + '\n\n–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É RKT Hub –ø–æ —Å–≤–æ–µ–º—É Telegram ID.'
          : '‚ùå –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞.\n\n–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—é –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è.';
        sendTelegramNotification(tgId, msg);
      }
    } catch(e) {
      toast('‚úÖ –û–¥–æ–±—Ä–µ–Ω–æ (–¥–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∞–Ω—ã)','success');
    }
  } else {
    toast(approved?'‚úÖ –û–¥–æ–±—Ä–µ–Ω–æ':'‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ', approved?'success':'error');
  }
  renderAll();
  debouncedLoadData();
}

// Send Telegram notification via n8n webhook
async function sendTelegramNotification(chatId, message) {
  if (!chatId) return;
  try {
    await fetch(CONFIG.AI_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'telegram_notify',
        chat_id: String(chatId),
        message: message,
        source: 'web'
      })
    });
  } catch(e) {
    console.log('TG notification failed:', e);
  }
}

// Notify a specific staff member by name
async function notifyStaffByName(staffName, message) {
  if (!staffName) return;
  const s = (DATA.staff||[]).find(st => (st['–ò–º—è']||'') === staffName || (staffName||'').includes(st['–ò–º—è']||'___'));
  if (!s) return;
  const tgId = s['Telegram_ID'] || s.telegram_id;
  if (tgId) sendTelegramNotification(tgId, message);
}

// Notify all staff with a given role in a project
async function notifyStaffByRole(projectName, role, message) {
  const matches = (DATA.staff||[]).filter(s =>
    s['–°—Ç–∞—Ç—É—Å'] === '–ê–∫—Ç–∏–≤–Ω—ã–π' &&
    (s['–ü—Ä–æ–µ–∫—Ç'] === projectName || s['–ü—Ä–æ–µ–∫—Ç'] === '–í—Å–µ') &&
    s['–†–æ–ª—å'] === role
  );
  for (const s of matches) {
    const tgId = s['Telegram_ID'] || s.telegram_id;
    if (tgId) sendTelegramNotification(tgId, message);
  }
}

// Notify CEO about important events
async function notifyCEO(message) {
  const ceo = (DATA.staff||[]).find(s => s['–†–æ–ª—å'] === 'CEO' && s['–°—Ç–∞—Ç—É—Å'] === '–ê–∫—Ç–∏–≤–Ω—ã–π');
  if (ceo) {
    const tgId = ceo['Telegram_ID'] || ceo.telegram_id;
    if (tgId) sendTelegramNotification(tgId, message);
  }
}

// Notify on task status change
async function notifyTaskStatusChange(task, oldStatus, newStatus) {
  const assignee = task['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π'];
  if (!assignee) return;
  // Don't notify if the user changed their own task
  if (USER && assignee === USER.name) return;
  const msg = 'üîÑ *–°—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏ –∏–∑–º–µ–Ω—ë–Ω*\n\n' +
    'üìã ' + (task['–û–ø–∏—Å–∞–Ω–∏–µ']||'') + '\n' +
    'üìÅ ' + (task['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'') + '\n' +
    '‚ùå –ë—ã–ª–æ: ' + (oldStatus||'‚Äî') + '\n' +
    '‚úÖ –°—Ç–∞–ª–æ: ' + newStatus + '\n' +
    (USER ? '\nüë§ –ò–∑–º–µ–Ω–∏–ª: ' + USER.name : '');
  notifyStaffByName(assignee, msg);
}

// Check deadlines and send reminders (runs every hour)
function checkDeadlines() {
  const td = today();
  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  const tomorrowStr = tomorrow.toISOString().split('T')[0];

  (DATA.tasks||[]).forEach(t => {
    const dl = t['–î–µ–¥–ª–∞–π–Ω'];
    const status = t['–°—Ç–∞—Ç—É—Å'] || '';
    const assignee = t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π'];
    if (!dl || !assignee || status === '–ì–æ—Ç–æ–≤–æ' || status.includes('–ì–æ—Ç–æ–≤–æ')) return;

    if (dl === tomorrowStr) {
      notifyStaffByName(assignee,
        '‚è∞ *–î–µ–¥–ª–∞–π–Ω –∑–∞–≤—Ç—Ä–∞!*\n\nüìã ' + (t['–û–ø–∏—Å–∞–Ω–∏–µ']||'') +
        '\nüìÅ ' + (t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'') +
        '\nüìÖ –°—Ä–æ–∫: ' + dl
      );
    } else if (dl < td) {
      notifyStaffByName(assignee,
        'üö® *–ó–∞–¥–∞—á–∞ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–∞!*\n\nüìã ' + (t['–û–ø–∏—Å–∞–Ω–∏–µ']||'') +
        '\nüìÅ ' + (t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'') +
        '\nüìÖ –ë—ã–ª —Å—Ä–æ–∫: ' + dl
      );
    }
  });
}

// Run deadline check every hour
let _deadlineCheckTimer = null;
function startDeadlineChecks() {
  if (_deadlineCheckTimer) clearInterval(_deadlineCheckTimer);
  // First check after 30 seconds (allow data to load)
  setTimeout(checkDeadlines, 30000);
  // Then every hour
  _deadlineCheckTimer = setInterval(checkDeadlines, 3600000);
}

// ============================================================
// CSV EXPORT
// ============================================================
function exportCSV(type) {
  const map = {partners:DATA.partners, tasks:DATA.tasks, projects:DATA.projects};
  const data = filterByRole(map[type]||[]);
  if(!data.length) { toast('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö','warning'); return; }
  const headers = Object.keys(data[0]).filter(k=>k!=='row_number');
  let csv = '\uFEFF' + headers.join(';')+'\n';
  data.forEach(r => { csv += headers.map(h=>'"'+String(r[h]||'').replace(/"/g,'""')+'"').join(';')+'\n'; });
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'RKT_'+type+'_'+today()+'.csv';
  a.click();
  toast('üì• –≠–∫—Å–ø–æ—Ä—Ç –≥–æ—Ç–æ–≤','success');
}

// ============================================================
// KEYBOARD
// ============================================================
document.addEventListener('keydown', function(e) {
  if(e.key==='Enter'&&document.getElementById('loginScreen').style.display!=='none') { doPasswordLogin(); return; }
  if(e.key==='Escape') {
    if(document.getElementById('confirmOverlay').classList.contains('show')) closeConfirm(false);
    else if(document.getElementById('detailOverlay').classList.contains('show')) closeDetail();
    else if(document.getElementById('modalOverlay').classList.contains('show')) closeModal();
  }
});

// ============================================================
// INIT ‚Äî Load saved subprojects from directions
// ============================================================
function loadSavedSubprojects() {
  // Load directions from sheet and add as subprojects to matching projects
  if (DATA.directions && DATA.directions.length) {
    DATA.directions.forEach(d => {
      const name = d['–ù–∞–∑–≤–∞–Ω–∏–µ'];
      const projName = d['–ü—Ä–æ–µ–∫—Ç'] || '';
      if (!name) return;
      // Find which project this belongs to
      for (const [key, proj] of Object.entries(PROJECTS)) {
        if (proj.name === projName && !proj.subprojects[name]) {
          proj.subprojects[name] = {
            emoji: d['Emoji'] || 'üìå',
            color: proj.color,
            desc: d['–û–ø–∏—Å–∞–Ω–∏–µ'] || ''
          };
        }
      }
    });
  }
}

// Override renderAll to include saved subprojects
const _origRenderAll = renderAll;
renderAll = function() {
  loadSavedSubprojects();
  _origRenderAll();
};

checkSavedLogin();

// ============================================================
// GUIDED WORKFLOW ‚Äî –∫–æ–Ω—Ç—Ä–æ–ª—å –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤  
// ============================================================
function getWorkflowStep(dir) {
  const stage = dir['stage'] || 'prospect';
  const dirName = dir['–ù–∞–∑–≤–∞–Ω–∏–µ'] || dir['name'] || '';
  const tasks = (DATA.tasks||[]).filter(t => t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] === dirName);
  const steps = {
    'prospect': { step: 1, icon: 'üîç', title: '–ü–æ–∑–≤–æ–Ω–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç—É', desc: '–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç ‚Äî –ø–æ–∑–≤–æ–Ω–∏—Ç–µ –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ –≤ Telegram', action: '–ü–æ–∑–≤–æ–Ω–∏–ª ‚Üí –ü–µ—Ä–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç', nextStage: 'contact', required: ['–¢–µ–ª–µ—Ñ–æ–Ω'] },
    'contact': { step: 2, icon: 'üìû', title: '–ñ–¥—ë–º –æ—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞', desc: '–ü–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç–µ —á–µ—Ä–µ–∑ 1-2 –¥–Ω—è –µ—Å–ª–∏ –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª. 80% —Å–¥–µ–ª–æ–∫ –ø–æ—Å–ª–µ 5+ –∑–≤–æ–Ω–∫–æ–≤!', action: '–ö–ª–∏–µ–Ω—Ç –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω', nextStage: 'interest', required: [] },
    'interest': { step: 3, icon: '‚úÖ', title: '–°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ—Ç–æ—Ç–∏–ø', desc: '–ö–ª–∏–µ–Ω—Ç –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω ‚Äî –ø–æ–∫–∞–∂–∏—Ç–µ –µ–º—É –¥–µ–º–æ-—Å–∞–π—Ç', action: '–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ç–æ—Ç–∏–ø', nextStage: 'proto', required: [] },
    'proto': { step: 4, icon: 'üé®', title: '–û—Ç–ø—Ä–∞–≤—å—Ç–µ –ö–ü', desc: '–ü–æ–∫–∞–∂–∏—Ç–µ –ø—Ä–æ—Ç–æ—Ç–∏–ø + –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å —Ü–µ–Ω–æ–π', action: '–ö–ü –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', nextStage: 'proposal', required: [] },
    'proposal': { step: 5, icon: 'üìã', title: '–ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã', desc: '–°–æ–∑–≤–æ–Ω–∏—Ç–µ—Å—å, –æ–±—Å—É–¥–∏—Ç–µ –ø—Ä–∞–≤–∫–∏ –∏ —É—Å–ª–æ–≤–∏—è', action: '–ù–∞—á–∞—Ç—å –ø–µ—Ä–µ–≥–æ–≤–æ—Ä—ã', nextStage: 'negotiation', required: [] },
    'negotiation': { step: 6, icon: 'ü§ù', title: '–ó–∞–∫—Ä–æ–π—Ç–µ —Å–¥–µ–ª–∫—É', desc: '–ö–ª–∏–µ–Ω—Ç –≥–æ—Ç–æ–≤ ‚Äî –≤—ã—Å—Ç–∞–≤—å—Ç–µ —Å—á—ë—Ç –∏ –ø–æ–ª—É—á–∏—Ç–µ –æ–ø–ª–∞—Ç—É', action: '–ö–ª–∏–µ–Ω—Ç –æ–ø–ª–∞—Ç–∏–ª', nextStage: 'payment', required: [] },
    'payment': { step: 7, icon: 'üí∞', title: '–°–¥–∞–π—Ç–µ —Å–∞–π—Ç', desc: '–ó–∞–ª–µ–π—Ç–µ –Ω–∞ —Ö–æ—Å—Ç–∏–Ω–≥, –ø—Ä–∏–≤—è–∂–∏—Ç–µ –¥–æ–º–µ–Ω –∏ –ø–µ—Ä–µ–¥–∞–π—Ç–µ –∫–ª–∏–µ–Ω—Ç—É', action: '–°–∞–π—Ç —Å–¥–∞–Ω!', nextStage: 'done', required: [] },
    'done': { step: 8, icon: '‚úÖ', title: '–ü—Ä–æ–µ–∫—Ç –∑–∞–≤–µ—Ä—à—ë–Ω', desc: '–ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∏–ª –≥–æ—Ç–æ–≤—ã–π —Å–∞–π—Ç', action: null, nextStage: null, required: [] },
    'lost': { step: 0, icon: '‚ùå', title: '–ö–ª–∏–µ–Ω—Ç –æ—Ç–∫–∞–∑–∞–ª—Å—è', desc: '–ü—Ä–∏—á–∏–Ω–∞: '+(dir['–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞']||'–Ω–µ —É–∫–∞–∑–∞–Ω–∞'), action: '–í–µ—Ä–Ω—É—Ç—å –≤ –≤–æ—Ä–æ–Ω–∫—É', nextStage: 'prospect', required: [] }
  };
  return steps[stage] || steps['prospect'];
}

function renderWorkflowBanner(dir) {
  const wf = getWorkflowStep(dir);
  const id = dir['ID'] || dir.id || '';
  const p = getUserPerms();
  const name = dir['–ù–∞–∑–≤–∞–Ω–∏–µ']||'';
  
  if (wf.step === 8) {
    return '<div class="workflow-banner" style="border-color:var(--green);background:rgba(0,212,170,.06)"><div class="wf-step">üéâ</div><div class="wf-info"><h4 style="color:var(--green)">–ü—Ä–æ–µ–∫—Ç –∑–∞–≤–µ—Ä—à—ë–Ω!</h4><p>–ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∏–ª –≥–æ—Ç–æ–≤—ã–π —Å–∞–π—Ç</p></div></div>';
  }
  
  // Find current active task for this client
  const clientTasks = (DATA.tasks||[]).filter(t => (t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'') === name);
  const activeTask = clientTasks.find(t => (t['–°—Ç–∞—Ç—É—Å']||'').includes('–í —Ä–∞–±–æ—Ç–µ') || (t['–°—Ç–∞—Ç—É—Å']||'').includes('–ù–æ–≤–∞—è'));
  const responsible = activeTask ? (activeTask['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω') : (dir['–ú–µ–Ω–µ–¥–∂–µ—Ä']||'–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω');
  const deadline = activeTask ? (activeTask['–î–µ–¥–ª–∞–π–Ω']||'‚Äî') : '‚Äî';
  
  let missingHtml = '';
  if (wf.required.length) {
    const missing = wf.required.filter(r => {
      if (r === '–¢–µ–ª–µ—Ñ–æ–Ω') return !dir['–¢–µ–ª–µ—Ñ–æ–Ω'];
      if (r === '–û–ø–ª–∞—á–µ–Ω–æ') return !dir['–û–ø–ª–∞—á–µ–Ω–æ'];
      return false;
    });
    if (missing.length) {
      missingHtml = '<p style="color:var(--red);font-size:11px;margin-top:4px">‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏—Ç–µ: ' + missing.join(', ') + '</p>';
    }
  }
  
  const actionBtn = wf.action && p.canWrite ? '<div class="wf-action"><button onclick="setDealStage(\''+id+'\',\''+wf.nextStage+'\')">'+wf.action+'</button></div>' : '';
  
  return '<div class="workflow-banner"><div class="wf-step">'+wf.icon+'</div><div class="wf-info"><h4>–®–∞–≥ '+wf.step+'/7: '+wf.title+'</h4><p>'+wf.desc+'</p>' +
    '<div style="display:flex;gap:12px;margin-top:6px;font-size:12px"><span style="color:var(--accent)">üë§ '+esc(responsible)+'</span><span style="color:var(--text2)">üìÖ '+esc(deadline)+'</span></div>' +
    missingHtml+'</div>'+actionBtn+'</div>';
}

// ============================================================
// ENHANCED SITE BUILDER ‚Äî –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Å–∞–π—Ç–æ–≤
// ============================================================
function renderFullSiteBuilder(dirName) {
  const dir = (DATA.directions||[]).find(d => (d['–ù–∞–∑–≤–∞–Ω–∏–µ']||d['name']) === dirName && d['–ü—Ä–æ–µ–∫—Ç'] === '–°–∞–π—Ç—ã');
  if (!dir) return '<p class="empty">–ö–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω</p>';
  
  const cached = siteCache[dirName];
  
  let html = '<div style="margin-bottom:16px">';
  html += renderWorkflowBanner(dir);
  html += '</div>';
  
  // Site builder form
  html += '<div class="card" style="padding:20px;margin-bottom:16px"><h4 style="font-size:15px;font-weight:600;margin-bottom:16px">üé® –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Å–∞–π—Ç–∞</h4>';
  html += '<div class="form-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:12px">';
  html += '<div class="form-group"><label>üè¢ –ù–∞–∑–≤–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å–∞</label><input id="sb-name" value="'+esc(dir['–ù–∞–∑–≤–∞–Ω–∏–µ']||'')+'" style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 12px;color:var(--text);width:100%;font-family:inherit"></div>';
  html += '<div class="form-group"><label>üìÇ –¢–∏–ø –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</label><input id="sb-type" value="'+esc(dir['–¢–∏–ø —Å–∞–π—Ç–∞']||'')+'" placeholder="–†–µ—Å—Ç–æ—Ä–∞–Ω, –°–∞–ª–æ–Ω –∫—Ä–∞—Å–æ—Ç—ã..." style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 12px;color:var(--text);width:100%;font-family:inherit"></div>';
  html += '<div class="form-group"><label>üì± –¢–µ–ª–µ—Ñ–æ–Ω</label><input id="sb-phone" value="'+esc(dir['–¢–µ–ª–µ—Ñ–æ–Ω']||'')+'" style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 12px;color:var(--text);width:100%;font-family:inherit"></div>';
  html += '<div class="form-group"><label>üìç –ì–æ—Ä–æ–¥</label><input id="sb-city" value="'+esc(dir['–ì–æ—Ä–æ–¥']||'')+'" style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 12px;color:var(--text);width:100%;font-family:inherit"></div>';
  html += '<div class="form-group" style="grid-column:span 2"><label>üìù –£—Å–ª—É–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label><input id="sb-services" placeholder="–°—Ç—Ä–∏–∂–∫–∏, –ú–∞–Ω–∏–∫—é—Ä, –ö–µ—Ä–∞—Ç–∏–Ω..." style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 12px;color:var(--text);width:100%;font-family:inherit"></div>';
  html += '<div class="form-group" style="grid-column:span 2"><label>üé® –°—Ç–∏–ª—å –¥–∏–∑–∞–π–Ω–∞</label><select id="sb-style" style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 12px;color:var(--text);width:100%;font-family:inherit"><option>–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–∏–Ω–∏–º–∞–ª–∏–∑–º</option><option>–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π</option><option>–Ø—Ä–∫–∏–π –∏ –º–æ–ª–æ–¥—ë–∂–Ω—ã–π</option><option>–ü—Ä–µ–º–∏—É–º / –õ—é–∫—Å</option><option>–£—é—Ç–Ω—ã–π –∏ —Ç—ë–ø–ª—ã–π</option></select></div>';
  html += '<div class="form-group" style="grid-column:span 2"><label>üí¨ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è</label><textarea id="sb-notes" rows="3" placeholder="–¶–≤–µ—Ç–∞, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏, –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ..." style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 12px;color:var(--text);width:100%;font-family:inherit;resize:vertical"></textarea></div>';
  html += '</div>';
  html += '<div style="display:flex;gap:8px;margin-top:12px">';
  html += '<button class="btn btn-primary" onclick="generateFullSite(\''+escA(dirName)+'\')"><span id="sb-gen-spinner" style="display:none">‚è≥</span> ü§ñ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–∞–π—Ç</button>';
  html += (cached ? '<button class="btn btn-secondary" onclick="downloadSite(\''+escA(dirName)+'\')">üì• –°–∫–∞—á–∞—Ç—å HTML</button>' : '');
  html += (cached ? '<button class="btn btn-secondary" onclick="editSiteCode(\''+escA(dirName)+'\')">üîß –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>' : '');
  html += '</div></div>';
  
  // Preview
  if (cached) {
    html += '<div class="card" style="padding:0;overflow:hidden"><div style="padding:12px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center"><h4 style="font-size:13px;font-weight:600">üëÅÔ∏è –ü—Ä–µ–≤—å—é —Å–∞–π—Ç–∞</h4><div style="display:flex;gap:6px"><button onclick="previewMobile()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--border);background:var(--bg);color:var(--text2);cursor:pointer;font-size:11px">üì± –ú–æ–±–∏–ª—å–Ω–∞—è</button><button onclick="previewDesktop()" style="padding:4px 10px;border-radius:4px;border:1px solid var(--border);background:var(--bg);color:var(--text2);cursor:pointer;font-size:11px">üñ• –î–µ—Å–∫—Ç–æ–ø</button></div></div>';
    html += '<iframe id="site-preview-frame" srcdoc="'+esc(cached)+'" style="width:100%;height:600px;border:none;background:#fff"></iframe></div>';
  }
  
  // Code editor
  html += '<div id="code-editor-wrap" style="display:none;margin-top:16px"><div class="card" style="padding:16px"><h4 style="font-size:13px;font-weight:600;margin-bottom:8px">üîß –†–µ–¥–∞–∫—Ç–æ—Ä –∫–æ–¥–∞</h4><textarea id="site-code-editor" style="width:100%;height:400px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px;color:var(--text);font-family:\'JetBrains Mono\',monospace;font-size:12px;resize:vertical"></textarea><div style="display:flex;gap:8px;margin-top:8px"><button class="btn btn-primary" onclick="applySiteCode(\''+escA(dirName)+'\')">üíæ –ü—Ä–∏–º–µ–Ω–∏—Ç—å</button><button class="btn btn-secondary" onclick="document.getElementById(\'code-editor-wrap\').style.display=\'none\'">–ó–∞–∫—Ä—ã—Ç—å</button></div></div></div>';
  
  return html;
}

function previewMobile() {
  const f = document.getElementById('site-preview-frame');
  if (f) { f.style.width = '375px'; f.style.margin = '0 auto'; f.style.display = 'block'; }
}
function previewDesktop() {
  const f = document.getElementById('site-preview-frame');
  if (f) { f.style.width = '100%'; f.style.margin = '0'; }
}
function editSiteCode(dirName) {
  const code = siteCache[dirName];
  if (!code) return;
  document.getElementById('code-editor-wrap').style.display = 'block';
  document.getElementById('site-code-editor').value = code;
}
function applySiteCode(dirName) {
  const code = document.getElementById('site-code-editor').value;
  siteCache[dirName] = code;
  const frame = document.getElementById('site-preview-frame');
  if (frame) frame.srcdoc = code;
  document.getElementById('code-editor-wrap').style.display = 'none';
  toast('‚úÖ –ö–æ–¥ –ø—Ä–∏–º–µ–Ω—ë–Ω');
}
function downloadSite(dirName) {
  const code = siteCache[dirName];
  if (!code) { toast('–°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —Å–∞–π—Ç','error'); return; }
  const blob = new Blob([code], {type:'text/html'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = (dirName||'site').replace(/[^a-zA-Z–∞-—è–ê-–Ø—ë–Å0-9]/g,'_') + '.html';
  a.click();
  toast('üì• –§–∞–π–ª —Å–∫–∞—á–∞–Ω');
}

async function generateFullSite(dirName) {
  const spinner = document.getElementById('sb-gen-spinner');
  if (spinner) spinner.style.display = 'inline';
  
  const data = {
    name: document.getElementById('sb-name')?.value || dirName,
    type: document.getElementById('sb-type')?.value || '',
    phone: document.getElementById('sb-phone')?.value || '',
    city: document.getElementById('sb-city')?.value || '',
    services: document.getElementById('sb-services')?.value || '',
    style: document.getElementById('sb-style')?.value || '–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–∏–Ω–∏–º–∞–ª–∏–∑–º',
    notes: document.getElementById('sb-notes')?.value || ''
  };
  
  const prompt = `–°–æ–∑–¥–∞–π –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –æ–¥–Ω–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã–π —Å–∞–π—Ç (HTML+CSS+JS –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ) –¥–ª—è –±–∏–∑–Ω–µ—Å–∞:
–ù–∞–∑–≤–∞–Ω–∏–µ: ${data.name}
–¢–∏–ø –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏: ${data.type}  
–ì–æ—Ä–æ–¥: ${data.city}
–¢–µ–ª–µ—Ñ–æ–Ω: ${data.phone}
–£—Å–ª—É–≥–∏: ${data.services}
–°—Ç–∏–ª—å –¥–∏–∑–∞–π–Ω–∞: ${data.style}
–ü–æ–∂–µ–ª–∞–Ω–∏—è: ${data.notes}

–¢–†–ï–ë–û–í–ê–ù–ò–Ø:
- –ü–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤—ã–π –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é HTML —Ñ–∞–π–ª
- –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π –¥–∏–∑–∞–π–Ω
- –°–µ–∫—Ü–∏–∏: —à–∞–ø–∫–∞ —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π, –≥–µ—Ä–æ–π-–±–∞–Ω–Ω–µ—Ä, —É—Å–ª—É–≥–∏/–ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞, –æ –∫–æ–º–ø–∞–Ω–∏–∏, –∫–æ–Ω—Ç–∞–∫—Ç—ã —Å –∫–∞—Ä—Ç–æ–π, –ø–æ–¥–≤–∞–ª
- –ö–Ω–æ–ø–∫–∏ CTA (–ø–æ–∑–≤–æ–Ω–∏—Ç—å, –∑–∞–ø–∏—Å–∞—Ç—å—Å—è)
- –ê–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ
- –ú–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è
- –Ø—Ä–∫–∏–π, –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–π –¥–∏–∑–∞–π–Ω –≤ —Å—Ç–∏–ª–µ "${data.style}"
- –í—Å—ë –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
- –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û HTML –∫–æ–¥ –±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏ –º–∞—Ä–∫–¥–∞—É–Ω–∞`;

  try {
    const resp = await fetch(CONFIG.AI_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ message: prompt, userId: USER?.tgId||'', context: 'site_generator' })
    });
    const result = await resp.json();
    let r4 = result; if (Array.isArray(result)) r4 = result[0]||{}; if (r4.json) r4 = r4.json;
    let siteCode = r4.reply || r4.response || r4.output || r4.text || '';
    
    // Clean up markdown wrapper if present
    siteCode = siteCode.replace(/^```html?\n?/i, '').replace(/\n?```$/,'').trim();
    
    if (siteCode.includes('<html') || siteCode.includes('<body') || siteCode.includes('<div')) {
      siteCache[dirName] = siteCode;
      toast('‚úÖ –°–∞–π—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω!');
      // Re-render to show preview
      const container = document.getElementById('sp-content');
      if (container) {
        const currentTab = document.querySelector('.sp-tab.active')?.dataset?.tab;
        if (currentTab === 'generator') {
          container.innerHTML = renderFullSiteBuilder(dirName);
        }
      }
    } else {
      toast('‚ö†Ô∏è AI –Ω–µ –≤–µ—Ä–Ω—É–ª HTML –∫–æ–¥','error');
    }
  } catch(err) {
    toast('‚ùå –û—à–∏–±–∫–∞: ' + err.message, 'error');
  }
  if (spinner) spinner.style.display = 'none';
}

// ============================================================
// CLIENT CARD ‚Äî –ø–æ–ª–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ —Å –∑–∞–¥–∞—á–∞–º–∏
// ============================================================
function openClientCard(id) {
  const dir = (DATA.directions||[]).find(d => (d['ID']||d.id) === id);
  if (!dir) { toast('–ö–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω','error'); return; }
  
  const name = dir['–ù–∞–∑–≤–∞–Ω–∏–µ']||dir['name']||'?';
  const stage = dir['stage']||'prospect';
  const stageObj = STAGES.find(s=>s.id===stage)||STAGES[0];
  const stageIdx = STAGES.findIndex(s=>s.id===stage);
  const clientTasks = (DATA.tasks||[]).filter(t => (t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'') === name);
  const activeTasks = clientTasks.filter(t => (t['–°—Ç–∞—Ç—É—Å']||'') !== '–ì–æ—Ç–æ–≤–æ');
  const doneTasks = clientTasks.filter(t => (t['–°—Ç–∞—Ç—É—Å']||'') === '–ì–æ—Ç–æ–≤–æ');
  const td = today();
  const p = getUserPerms();
  const eid = escA(id);
  const ename = escA(name);
  
  let html = '<div style="padding:20px 24px">';
  
  // Stepper
  html += '<div style="display:flex;align-items:center;margin-bottom:24px;gap:0">';
  STAGES.forEach((s,i) => {
    const done = i < stageIdx;
    const cur = i === stageIdx;
    const bgC = done ? 'var(--green)' : cur ? stageObj.color : 'var(--bg3)';
    const txtC = done || cur ? '#fff' : 'var(--text2)';
    html += '<div style="display:flex;align-items:center">';
    html += '<div style="width:28px;height:28px;border-radius:50%;background:'+bgC+';color:'+txtC+';display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;'+(cur?'box-shadow:0 0 12px '+stageObj.color+';transform:scale(1.15)':'')+'">'+(done?'‚úì':(i+1))+'</div>';
    if (i < STAGES.length-1) html += '<div style="width:20px;height:2px;background:'+(i<stageIdx?'var(--green)':'var(--bg3)')+'"></div>';
    html += '</div>';
  });
  html += '</div>';
  html += '<div style="text-align:center;margin-bottom:20px"><span style="background:'+stageObj.color+';color:#fff;padding:4px 14px;border-radius:12px;font-size:12px;font-weight:600">'+stageObj.name+'</span></div>';
  
  // MAIN ACTION AREA
  html += '<div class="card" style="padding:20px;margin-bottom:16px;border:2px solid '+stageObj.color+';border-radius:12px">';
  
  if (stage === 'prospect') {
    // ============ –ü–û–ò–°–ö ‚Äî –∑–∞–ø–æ–ª–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ, –ø–æ–∑–≤–æ–Ω–∏—Ç—å ============
    const hasPhone = !!dir['–¢–µ–ª–µ—Ñ–æ–Ω'];
    const hasType = !!dir['–¢–∏–ø —Å–∞–π—Ç–∞'];
    html += '<div style="font-size:16px;font-weight:700;margin-bottom:4px">üîç –®–∞–≥ 1: –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –ª–∏–¥–∞</div>';
    html += '<div style="font-size:13px;color:var(--text2);margin-bottom:16px">–ù–∞—à–ª–∏ –±–∏–∑–Ω–µ—Å –±–µ–∑ —Å–∞–π—Ç–∞ ‚Äî –≤–Ω–µ—Å–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç –∏ –ø–æ–∑–≤–æ–Ω–∏—Ç–µ</div>';
    
    html += '<div style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px">';
    html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">';
    html += '<div><label style="font-size:11px;color:var(--text2);display:block;margin-bottom:3px">–¢–µ–ª–µ—Ñ–æ–Ω *</label><input id="cc-lead-phone" type="tel" value="'+escA(dir['–¢–µ–ª–µ—Ñ–æ–Ω']||'')+'" placeholder="+7 900 123-45-67" style="width:100%;padding:8px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px"></div>';
    html += '<div><label style="font-size:11px;color:var(--text2);display:block;margin-bottom:3px">–ì–æ—Ä–æ–¥</label><input id="cc-lead-city" type="text" value="'+escA(dir['–ì–æ—Ä–æ–¥']||'')+'" placeholder="–ù–∞–±–µ—Ä–µ–∂–Ω—ã–µ –ß–µ–ª–Ω—ã" style="width:100%;padding:8px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px"></div>';
    html += '</div>';
    
    html += '<div><label style="font-size:11px;color:var(--text2);display:block;margin-bottom:3px">–¢–∏–ø —Å–∞–π—Ç–∞ *</label>';
    html += '<select id="cc-lead-type" onchange="updateLeadPrice()" style="width:100%;padding:8px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px">';
    html += '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø ‚Äî</option>';
    for (const [t, pr] of Object.entries(SITE_PRICING)) {
      html += '<option value="'+escA(t)+'"'+(dir['–¢–∏–ø —Å–∞–π—Ç–∞']===t?' selected':'')+'>'+pr.emoji+' '+t+' ‚Äî '+pr.price.toLocaleString('ru')+'‚ÇΩ</option>';
    }
    html += '</select></div>';
    
    html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">';
    html += '<div><label style="font-size:11px;color:var(--text2);display:block;margin-bottom:3px">–¶–µ–Ω–∞ ‚ÇΩ *</label><input id="cc-lead-price" type="number" value="'+(Number(dir['–¶–µ–Ω–∞'])||'')+'" placeholder="10000" style="width:100%;padding:8px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px"></div>';
    html += '<div><label style="font-size:11px;color:var(--text2);display:block;margin-bottom:3px">–ú–µ–Ω–µ–¥–∂–µ—Ä</label><select id="cc-lead-manager" style="width:100%;padding:8px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px">';
    html += '<option value="">‚Äî –ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω ‚Äî</option>';
    (DATA.staff||[]).filter(s=>s['–°—Ç–∞—Ç—É—Å']!=='–û–∂–∏–¥–∞–µ—Ç'&&s['–°—Ç–∞—Ç—É—Å']!=='‚ùå –£–¥–∞–ª—ë–Ω').forEach(s => {
      html += '<option value="'+escA(s['–ò–º—è'])+'"'+(dir['–ú–µ–Ω–µ–¥–∂–µ—Ä']===s['–ò–º—è']?' selected':'')+'>'+esc(s['–ò–º—è'])+' ('+esc(s['–†–æ–ª—å']||'')+')</option>';
    });
    html += '</select></div></div>';
    html += '</div>';
    
    html += '<button class="btn btn-secondary" onclick="saveLeadData(\''+eid+'\')" style="width:100%;margin-bottom:8px">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>';
    html += '<button class="btn btn-primary" onclick="advanceToStage(\''+eid+'\',\'contact\')" style="width:100%;font-size:14px;padding:12px">üìû –ü–æ–∑–≤–æ–Ω–∏–ª ‚Üí –ü–µ—Ä–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç</button>';
    if (!hasPhone) html += '<div style="text-align:center;padding:4px;color:var(--orange);font-size:11px">‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –ø–µ—Ä–µ–¥ –∑–≤–æ–Ω–∫–æ–º</div>';
    
  } else if (stage === 'contact') {
    // ============ –ü–ï–†–í–´–ô –ö–û–ù–¢–ê–ö–¢ ‚Äî –∂–¥—ë–º –æ—Ç–≤–µ—Ç, follow-up ============
    html += '<div style="font-size:16px;font-weight:700;margin-bottom:4px">üìû –®–∞–≥ 2: –ü–µ—Ä–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç</div>';
    html += '<div style="font-size:13px;color:var(--text2);margin-bottom:16px">–ü–æ–∑–≤–æ–Ω–∏–ª–∏ –∫–ª–∏–µ–Ω—Ç—É. –ñ–¥—ë–º –æ—Ç–≤–µ—Ç. –ï—Å–ª–∏ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç ‚Äî –ø–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç–µ —á–µ—Ä–µ–∑ 1-2 –¥–Ω—è.</div>';
    html += '<div style="background:var(--bg3);border-radius:8px;padding:14px;margin-bottom:16px;font-size:12px">';
    html += '<div style="font-weight:600;margin-bottom:6px">üí° –°–æ–≤–µ—Ç—ã –ø–æ –ø–µ—Ä–≤–æ–º—É –∑–≤–æ–Ω–∫—É:</div>';
    html += '<div>1. ¬´–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø —É–≤–∏–¥–µ–ª –≤–∞—à –±–∏–∑–Ω–µ—Å –Ω–∞ –∫–∞—Ä—Ç–∞—Ö ‚Äî —É –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–∞–π—Ç–∞?¬ª</div>';
    html += '<div>2. ¬´–ú—ã –º–æ–∂–µ–º —Å–¥–µ–ª–∞—Ç—å —Å–∞–π—Ç –∑–∞ X –¥–Ω–µ–π. –í–æ—Ç –ø—Ä–∏–º–µ—Ä ‚Äî –ø–æ—Å–º–æ—Ç—Ä–∏—Ç–µ.¬ª</div>';
    html += '<div>3. <b>80% —Å–¥–µ–ª–æ–∫ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –ø–æ—Å–ª–µ 5+ –∑–≤–æ–Ω–∫–æ–≤!</b></div>';
    html += '</div>';
    const cleanPhone = (dir['–¢–µ–ª–µ—Ñ–æ–Ω']||'').replace(/[^\\d+]/g,'');
    if (cleanPhone) {
      html += '<div style="display:flex;gap:8px;margin-bottom:12px">';
      html += '<button class="btn btn-secondary" onclick="window.open(\'tel:'+cleanPhone+'\')" style="flex:1">üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</button>';
      html += '<button class="btn btn-secondary" onclick="window.open(\'https://t.me/'+cleanPhone.replace('+','')+'\',\'_blank\')" style="flex:1">üí¨ Telegram</button>';
      html += '</div>';
    }
    html += '<button class="btn btn-secondary" onclick="logTouch(\''+eid+'\')" style="width:100%;margin-bottom:8px">üìû –ó–∞–ø–∏—Å–∞—Ç—å –∫–∞—Å–∞–Ω–∏–µ (–∑–≤–æ–Ω–æ–∫)</button>';
    html += '<button class="btn btn-primary" onclick="advanceToStage(\''+eid+'\',\'interest\')" style="width:100%;font-size:14px;padding:12px">‚úÖ –ö–ª–∏–µ–Ω—Ç –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω!</button>';
    html += '<button class="btn" onclick="rejectDeal(\''+eid+'\')" style="width:100%;margin-top:8px;background:rgba(255,75,75,.1);color:var(--red)">‚ùå –û—Ç–∫–∞–∑–∞–ª—Å—è</button>';
    
  } else if (stage === 'interest') {
    // ============ –ò–ù–¢–ï–†–ï–° ‚Äî –∑–∞–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∫–µ—Ç—É, —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ç–æ—Ç–∏–ø ============
    html += '<div style="font-size:16px;font-weight:700;margin-bottom:4px">‚úÖ –®–∞–≥ 3: –°–æ–±–µ—Ä–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–∞–π—Ç–∞</div>';
    html += '<div style="font-size:13px;color:var(--text2);margin-bottom:16px">–ö–ª–∏–µ–Ω—Ç –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω! –°–æ–±–µ—Ä–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ç–æ—Ç–∏–ø–∞.</div>';
    html += '<div style="display:flex;flex-direction:column;gap:10px;margin-bottom:16px">';
    html += '<div><label style="font-size:11px;color:var(--text2);display:block;margin-bottom:4px">–í–∏–¥ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</label><input id="cc-biz-type" type="text" placeholder="–†–µ—Å—Ç–æ—Ä–∞–Ω, —Å–∞–ª–æ–Ω –∫—Ä–∞—Å–æ—Ç—ã..." value="'+escA(dir['–û–ø–∏—Å–∞–Ω–∏–µ']||'')+'" style="width:100%;padding:8px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px"></div>';
    html += '<div><label style="font-size:11px;color:var(--text2);display:block;margin-bottom:4px">–ê–¥—Ä–µ—Å</label><input id="cc-address" type="text" value="'+escA(dir['–ê–¥—Ä–µ—Å']||'')+'" placeholder="—É–ª. –õ–µ–Ω–∏–Ω–∞, –¥. 1" style="width:100%;padding:8px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px"></div>';
    html += '<div><label style="font-size:11px;color:var(--text2);display:block;margin-bottom:4px">–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã</label><input id="cc-hours" type="text" value="'+escA(dir['–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã']||dir['–ì—Ä–∞—Ñ–∏–∫']||'')+'" placeholder="–ü–Ω-–ü—Ç 10:00-22:00" style="width:100%;padding:8px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px"></div>';
    html += '<div><label style="font-size:11px;color:var(--text2);display:block;margin-bottom:4px">–£—Å–ª—É–≥–∏ / –ú–µ–Ω—é</label><textarea id="cc-services" placeholder="–°—Ç—Ä–∏–∂–∫–∏, –æ–∫—Ä–∞—à–∏–≤–∞–Ω–∏–µ..." style="width:100%;padding:8px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;min-height:60px">'+esc(dir['–£—Å–ª—É–≥–∏']||'')+'</textarea></div>';
    html += '<div><label style="font-size:11px;color:var(--text2);display:block;margin-bottom:4px">–ü–æ–∂–µ–ª–∞–Ω–∏—è –∫ —Å–∞–π—Ç—É</label><textarea id="cc-wishes" placeholder="–¶–≤–µ—Ç–∞, —Å—Ç–∏–ª—å..." style="width:100%;padding:8px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;min-height:50px">'+esc(dir['–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π']||'')+'</textarea></div>';
    html += '</div>';
    html += '<button class="btn btn-secondary" onclick="saveAnketa(\''+eid+'\')" style="width:100%;margin-bottom:8px">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>';
    html += '<button class="btn btn-primary" onclick="advanceToStage(\''+eid+'\',\'proto\')" style="width:100%;font-size:14px;padding:12px">üé® –î–∞–Ω–Ω—ã–µ —Å–æ–±—Ä–∞–Ω—ã ‚Üí –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ç–æ—Ç–∏–ø</button>';
    
  } else if (stage === 'proto') {
    // ============ –ü–†–û–¢–û–¢–ò–ü ‚Äî —Å–æ–∑–¥–∞—Ç—å –¥–µ–º–æ-—Å–∞–π—Ç ============
    html += '<div style="font-size:16px;font-weight:700;margin-bottom:4px">üé® –®–∞–≥ 4: –°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ—Ç–æ—Ç–∏–ø —Å–∞–π—Ç–∞</div>';
    html += '<div style="font-size:13px;color:var(--text2);margin-bottom:16px">–û—Ç–∫—Ä–æ–π—Ç–µ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏ —Å–æ–∑–¥–∞–π—Ç–µ –¥–µ–º–æ-—Å–∞–π—Ç –¥–ª—è –ø–æ–∫–∞–∑–∞ –∫–ª–∏–µ–Ω—Ç—É</div>';
    html += '<button class="btn btn-primary" onclick="closeClientCard();openSubproject(\''+ename+'\');setTimeout(()=>showSpTab(\'sitegen\'),300)" style="width:100%;font-size:15px;padding:14px;margin-bottom:8px">üé® –û—Ç–∫—Ä—ã—Ç—å –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä</button>';
    html += '<button class="btn btn-secondary" onclick="advanceToStage(\''+eid+'\',\'proposal\')" style="width:100%">üìã –ü—Ä–æ—Ç–æ—Ç–∏–ø –≥–æ—Ç–æ–≤ ‚Üí –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ö–ü</button>';
    
  } else if (stage === 'proposal') {
    // ============ –ö–ü –û–¢–ü–†–ê–í–õ–ï–ù–û ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ—Ç–æ—Ç–∏–ø + —Ü–µ–Ω—É ============
    html += '<div style="font-size:16px;font-weight:700;margin-bottom:4px">üìã –®–∞–≥ 5: –ö–ü –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</div>';
    html += '<div style="font-size:13px;color:var(--text2);margin-bottom:16px">–ü–æ–∫–∞–∂–∏—Ç–µ –ø—Ä–æ—Ç–æ—Ç–∏–ø + —Ü–µ–Ω—É. –í–∞–∂–Ω–æ: –ø–æ–∫–∞–∑—ã–≤–∞–π—Ç–µ –ø—Ä–∏ –∑–≤–æ–Ω–∫–µ, –Ω–µ –ø—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ —Å—Å—ã–ª–∫—É!</div>';
    if (dir['–°—Å—ã–ª–∫–∞']) {
      html += '<div style="background:var(--bg3);border-radius:8px;padding:14px;margin-bottom:16px">';
      html += '<div style="font-size:11px;color:var(--text2);margin-bottom:4px">–°—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–æ—Ç–æ—Ç–∏–ø:</div>';
      html += '<a href="'+esc(dir['–°—Å—ã–ª–∫–∞'])+'" target="_blank" style="color:var(--blue);word-break:break-all">'+esc(dir['–°—Å—ã–ª–∫–∞'])+'</a></div>';
    }
    const phone2 = dir['–¢–µ–ª–µ—Ñ–æ–Ω']||'';
    if (phone2) {
      const tgLink = 'https://t.me/'+phone2.replace(/[^0-9]/g,'')+'?text='+encodeURIComponent('–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ú—ã –ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª–∏ –ø—Ä–æ—Ç–æ—Ç–∏–ø —Å–∞–π—Ç–∞ –¥–ª—è –≤–∞—Å: '+(dir['–°—Å—ã–ª–∫–∞']||''));
      html += '<a href="'+tgLink+'" target="_blank" class="btn btn-secondary" style="width:100%;margin-bottom:8px;text-align:center;display:block;background:rgba(0,136,204,0.1);color:#0088cc;border-color:#0088cc">üí¨ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram</a>';
    }
    html += '<button class="btn btn-primary" onclick="advanceToStage(\''+eid+'\',\'negotiation\')" style="width:100%;font-size:14px;padding:12px">ü§ù –ö–ª–∏–µ–Ω—Ç –≤–∏–¥–µ–ª –ö–ü ‚Üí –ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã</button>';
    
  } else if (stage === 'negotiation') {
    // ============ –ü–ï–†–ï–ì–û–í–û–†–´ ‚Äî –æ–±—Å—É–∂–¥–∞–µ–º, —Ç–æ—Ä–≥—É–µ–º—Å—è ============
    html += '<div style="font-size:16px;font-weight:700;margin-bottom:4px">ü§ù –®–∞–≥ 6: –ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã</div>';
    html += '<div style="font-size:13px;color:var(--text2);margin-bottom:16px">–û–±—Å—É–¥–∏—Ç–µ –ø—Ä–∞–≤–∫–∏, —É—Å–ª–æ–≤–∏—è, —Ü–µ–Ω—É. –ó–∞–∫—Ä–æ–π—Ç–µ —Å–¥–µ–ª–∫—É!</div>';
    html += '<div style="text-align:center;padding:20px;background:var(--bg3);border-radius:12px;margin-bottom:16px">';
    html += '<div style="font-size:13px;color:var(--text2)">–°—É–º–º–∞ —Å–¥–µ–ª–∫–∏:</div>';
    html += '<div style="font-size:32px;font-weight:700;color:var(--accent)">'+(Number(dir['–¶–µ–Ω–∞'])||0).toLocaleString('ru')+'‚ÇΩ</div></div>';
    html += '<button class="btn btn-secondary" onclick="addDealFeedback(\''+eid+'\')" style="width:100%;margin-bottom:8px">üí¨ –ó–∞–ø–∏—Å–∞—Ç—å —Ñ–∏–¥–±–µ–∫</button>';
    html += '<button class="btn btn-primary" onclick="advanceToStage(\''+eid+'\',\'payment\')" style="width:100%;font-size:14px;padding:12px">üí∞ –ö–ª–∏–µ–Ω—Ç —Å–æ–≥–ª–∞—Å–∏–ª—Å—è ‚Üí –û–ø–ª–∞—Ç–∞</button>';
    html += '<button class="btn" onclick="rejectDeal(\''+eid+'\')" style="width:100%;margin-top:8px;background:rgba(255,75,75,.1);color:var(--red)">‚ùå –û—Ç–∫–∞–∑–∞–ª—Å—è</button>';
    
  } else if (stage === 'payment') {
    // ============ –û–ü–õ–ê–¢–ê ‚Äî –ø–æ–ª—É—á–∏—Ç—å –¥–µ–Ω—å–≥–∏, –∑–∞–ª–∏—Ç—å —Å–∞–π—Ç ============
    html += '<div style="font-size:16px;font-weight:700;margin-bottom:4px">üí∞ –®–∞–≥ 7: –ü–æ–ª—É—á–∏—Ç–µ –æ–ø–ª–∞—Ç—É –∏ —Å–¥–∞–π—Ç–µ —Å–∞–π—Ç</div>';
    html += '<div style="text-align:center;padding:20px;background:var(--bg3);border-radius:12px;margin-bottom:16px">';
    html += '<div style="font-size:13px;color:var(--text2)">–ö –æ–ø–ª–∞—Ç–µ:</div>';
    html += '<div style="font-size:32px;font-weight:700;color:var(--accent)">'+(Number(dir['–¶–µ–Ω–∞'])||0).toLocaleString('ru')+'‚ÇΩ</div></div>';
    if (dir['–û–ø–ª–∞—á–µ–Ω–æ']) {
      html += '<div style="text-align:center;padding:12px;background:rgba(0,212,170,0.1);border-radius:8px;color:var(--green);font-weight:600;margin-bottom:8px">‚úÖ –û–ø–ª–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞!</div>';
    } else {
      html += '<button class="btn btn-secondary" onclick="markPaid(\''+eid+'\');closeClientCard();setTimeout(()=>openClientCard(\''+eid+'\'),800)" style="width:100%;font-size:14px;padding:12px;margin-bottom:8px">üí∞ –û—Ç–º–µ—Ç–∏—Ç—å –æ–ø–ª–∞—Ç—É</button>';
    }
    html += '<button class="btn btn-primary" onclick="advanceToStage(\''+eid+'\',\'done\')" style="width:100%;font-size:14px;padding:12px">‚úÖ –°–∞–π—Ç —Å–¥–∞–Ω ‚Üí –ó–∞–≤–µ—Ä—à–∏—Ç—å!</button>';
    
  } else if (stage === 'done') {
    // ============ –ó–ê–í–ï–†–®–Å–ù ============
    html += '<div style="text-align:center;padding:20px"><div style="font-size:48px;margin-bottom:8px">üéâ</div>';
    html += '<div style="font-size:18px;font-weight:700;color:var(--green)">–ü—Ä–æ–µ–∫—Ç –∑–∞–≤–µ—Ä—à—ë–Ω!</div>';
    html += '<div style="font-size:13px;color:var(--text2);margin-top:4px">–ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∏–ª —Å–∞–π—Ç</div></div>';
    if (dir['–°—Å—ã–ª–∫–∞']) html += '<a href="'+esc(dir['–°—Å—ã–ª–∫–∞'])+'" target="_blank" class="btn btn-secondary" style="width:100%;text-align:center;display:block">üîó –û—Ç–∫—Ä—ã—Ç—å —Å–∞–π—Ç</a>';
    
  } else if (stage === 'lost') {
    // ============ –û–¢–ö–ê–ó ============
    html += '<div style="text-align:center;padding:20px"><div style="font-size:48px;margin-bottom:8px">‚ùå</div>';
    html += '<div style="font-size:18px;font-weight:700;color:var(--red)">–ö–ª–∏–µ–Ω—Ç –æ—Ç–∫–∞–∑–∞–ª—Å—è</div>';
    html += '<div style="font-size:13px;color:var(--text2);margin-top:4px">–ü—Ä–∏—á–∏–Ω–∞: '+esc(dir['–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞']||'–Ω–µ —É–∫–∞–∑–∞–Ω–∞')+'</div></div>';
    html += '<button class="btn btn-secondary" onclick="advanceToStage(\''+eid+'\',\'prospect\')" style="width:100%">üîÑ –í–µ—Ä–Ω—É—Ç—å –≤ –≤–æ—Ä–æ–Ω–∫—É</button>';
  }
  // === SALES SCRIPT BUTTON (for active sales stages) ===
  if (['prospect','contact','interest','proto','proposal','negotiation','payment'].indexOf(stage) >= 0) {
    html += '<button class="btn btn-secondary" onclick="showSalesScript(\''+escA(stage)+'\',\''+ename+'\',\''+escA(dir['–¢–∏–ø —Å–∞–π—Ç–∞']||'')+'\' )" style="width:100%;margin-top:10px;background:rgba(75,171,247,0.08);color:var(--blue);border-color:rgba(75,171,247,0.3)">üìù –°–∫—Ä–∏–ø—Ç –ø—Ä–æ–¥–∞–∂–∏</button>';
  }
  html += '</div>';
  
  // CLIENT INFO (collapsed)
  html += '<details style="margin-bottom:12px"><summary style="padding:12px 16px;background:var(--bg3);border-radius:8px;cursor:pointer;font-size:13px;font-weight:600">üë§ –î–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞</summary>';
  html += '<div style="padding:12px;border:1px solid var(--border);border-top:0;border-radius:0 0 8px 8px;display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:12px">';
  html += '<div>üì± '+(dir['–¢–µ–ª–µ—Ñ–æ–Ω']||'‚Äî')+'</div><div>üìç '+esc(dir['–ì–æ—Ä–æ–¥']||'‚Äî')+'</div>';
  html += '<div>üí∞ '+(Number(dir['–¶–µ–Ω–∞'])||0).toLocaleString('ru')+'‚ÇΩ</div><div>üí≥ '+(dir['–û–ø–ª–∞—á–µ–Ω–æ']?'‚úÖ':'‚è≥')+'</div>';
  html += '<div>üåê '+esc(dir['–¢–∏–ø —Å–∞–π—Ç–∞']||'‚Äî')+'</div><div>üë§ '+esc(dir['–ú–µ–Ω–µ–¥–∂–µ—Ä']||'‚Äî')+'</div>';
  html += '</div>';
  if (p.canWrite) html += '<div style="padding:8px 12px;border:1px solid var(--border);border-top:0;border-radius:0 0 8px 8px"><button class="btn btn-sm btn-secondary" onclick="closeClientCard();openModal(\'direction\',\''+eid+'\')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button></div>';
  html += '</details>';
  
  // FINANCE PANEL (all steps except lead ‚Äî lead has its own inline)
  if (stage !== 'prospect') html += renderClientFinance(dir);
  
  // TASKS
  html += '<div class="card" style="padding:16px;margin-bottom:16px">';
  html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">';
  html += '<div style="font-size:13px;font-weight:700">üìã –ó–∞–¥–∞—á–∏ ('+activeTasks.length+')</div>';
  if (p.canWrite) html += '<button class="btn btn-sm btn-primary" onclick="closeClientCard();openModal(\'task\');setTimeout(()=>{const f=document.getElementById(\'field-–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ\');if(f)f.value=\''+ename+'\';},300)">‚ûï</button>';
  html += '</div>';
  if (activeTasks.length) {
    activeTasks.forEach(t => {
      const od = t['–î–µ–¥–ª–∞–π–Ω'] && t['–î–µ–¥–ª–∞–π–Ω'] < td;
      const prC = t['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']==='P1'?'var(--red)':t['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']==='P2'?'var(--orange)':'var(--text2)';
      html += '<div style="padding:8px 10px;margin-bottom:4px;background:var(--bg3);border-radius:6px;border-left:3px solid '+prC+';cursor:pointer;font-size:12px" onclick="closeClientCard();openTaskDetail(\''+escA(t.ID||t.id)+'\')">';
      html += '<div style="font-weight:500">'+(od?'üî¥ ':'')+esc(t['–û–ø–∏—Å–∞–Ω–∏–µ']||t['–ù–∞–∑–≤–∞–Ω–∏–µ']||'?')+'</div>';
      html += '<div style="display:flex;gap:8px;margin-top:2px;font-size:11px;color:var(--text2)">';
      if (t['–î–µ–¥–ª–∞–π–Ω']) html += '<span>üìÖ '+t['–î–µ–¥–ª–∞–π–Ω']+'</span>';
      if (t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']) html += '<span>üë§ '+esc(t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π'])+'</span>';
      html += '</div></div>';
    });
  } else html += '<div style="text-align:center;padding:12px;color:var(--text2);font-size:12px">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á</div>';
  if (doneTasks.length) html += '<div style="margin-top:6px;font-size:11px;color:var(--text2)">‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ: '+doneTasks.length+'</div>';
  html += '</div></div>';
  
  const overlay = document.getElementById('client-card-overlay') || createClientCardOverlay();
  overlay.innerHTML = '<div class="client-card-panel" onclick="event.stopPropagation()">' +
    '<div style="display:flex;justify-content:space-between;align-items:center;padding:16px 24px;border-bottom:1px solid var(--border);background:var(--bg3)">' +
    '<div><h3 style="font-size:16px;font-weight:700;margin:0">'+esc(name)+'</h3><div style="font-size:11px;color:var(--text2);margin-top:2px">'+esc(dir['–¢–∏–ø —Å–∞–π—Ç–∞']||'')+' ¬∑ '+esc(dir['–ì–æ—Ä–æ–¥']||'')+'</div></div>' +
    '<button onclick="closeClientCard()" style="background:none;border:none;color:var(--text2);font-size:20px;cursor:pointer">‚úï</button>' +
    '</div>' + html + '</div>';
  overlay.style.display = 'flex';
}

async function saveAnketa(id) {
  if (!id) { toast('–û—à–∏–±–∫–∞: ID –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω','error'); return; }
  // Unescape ID (from escA in onclick)
  const cleanId = id.replace(/\\'/g, "'").replace(/&quot;/g, '"');
  console.log('[RKT] saveAnketa called with id:', cleanId);

  const v = (sel) => { const el = document.getElementById(sel); return el ? el.value.trim() : ''; };
  const updates = {
    business_type: v('cc-biz-type') || null,
    services: v('cc-services') || null,
    phone: v('cc-phone') || null,
    city: v('cc-city') || null,
    comment: v('cc-wishes') || null,
    address: v('cc-address') || null,
    social: v('cc-social') || null,
    work_hours: v('cc-hours') || null,
    prices: v('cc-prices') || null
  };
  // Also rebuild questionnaire JSON for AI site generation
  const questionnaire = JSON.stringify({
    biztype: v('cc-biz-type'), services: v('cc-services'), phone: v('cc-phone'),
    city: v('cc-city'), address: v('cc-address'), social: v('cc-social'),
    hours: v('cc-hours'), prices: v('cc-prices'), wishes: v('cc-wishes')
  });
  updates.questionnaire = questionnaire;

  // Remove null/undefined fields that don't exist in DB (avoid column-not-found errors)
  const safeUpdates = {};
  for (const [k, val] of Object.entries(updates)) {
    safeUpdates[k] = val;
  }
  console.log('[RKT] saveAnketa updates:', safeUpdates);

  try {
    // Try with cleaned ID first
    let { data, error } = await SB.from('directions').update(safeUpdates).eq('id', cleanId).select();

    // If no rows matched, try to find the real DB id from DATA
    if ((!data || data.length === 0) && !error) {
      const dir = (DATA.directions || []).find(d => (d['ID'] || d.id) === cleanId || (d['ID'] || d.id) === id);
      if (dir) {
        const realId = dir['ID'] || dir.id || dir._dbId;
        if (realId && realId !== cleanId) {
          console.log('[RKT] saveAnketa: retrying with realId from DATA:', realId);
          ({ data, error } = await SB.from('directions').update(safeUpdates).eq('id', realId).select());
        }
      }
    }

    if (error) {
      // Check if error is about missing columns
      if (error.message && error.message.includes('column')) {
        console.error('[RKT] saveAnketa column error ‚Äî need SQL migration:', error.message);
        toast('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ë–î: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–ª–æ–Ω–∫–∞. –í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL –º–∏–≥—Ä–∞—Ü–∏—é (–¥–æ–±–∞–≤—å—Ç–µ –∫–æ–ª–æ–Ω–∫–∏ address, social, work_hours, prices, questionnaire –≤ —Ç–∞–±–ª–∏—Ü—É directions).', 'error');
      } else {
        throw error;
      }
      return;
    }
    if (!data || data.length === 0) {
      console.warn('[RKT] saveAnketa: no rows updated for id:', cleanId);
      toast('‚ö†Ô∏è –ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ (ID=' + cleanId + '). –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.', 'warning');
      return;
    }
    toast('‚úÖ –ê–Ω–∫–µ—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞', 'success');
    await loadData();
  } catch(e) {
    console.error('saveAnketa error:', e);
    toast('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + e.message, 'error');
  }
}

async function uploadAnketaFile(dirId, type, input) {
  const files = input.files;
  if (!files || !files.length) return;

  toast('–ó–∞–≥—Ä—É–∑–∫–∞...', 'info');
  try {
    if (type === 'logo') {
      const file = files[0];
      const ext = file.name.split('.').pop();
      const path = 'anketa/' + dirId + '/logo.' + ext;
      const { error } = await SB.storage.from('sites').upload(path, file, { contentType: file.type, upsert: true });
      if (error) throw error;
      const { data: urlData } = SB.storage.from('sites').getPublicUrl(path);
      await SB.from('directions').update({ logo_url: urlData.publicUrl }).eq('id', dirId);
      toast('–õ–æ–≥–æ—Ç–∏–ø –∑–∞–≥—Ä—É–∂–µ–Ω', 'success');
    } else if (type === 'photos') {
      const dir = (DATA.directions||[]).find(d => (d['ID']||d.id) === dirId);
      let photos = [];
      try { photos = JSON.parse(dir['photos'] || '[]'); } catch(e) {}
      const remaining = 5 - photos.length;
      const toUpload = Array.from(files).slice(0, remaining);
      for (const file of toUpload) {
        const ext = file.name.split('.').pop();
        const path = 'anketa/' + dirId + '/photo_' + Date.now() + '_' + Math.random().toString(36).slice(2,6) + '.' + ext;
        const { error } = await SB.storage.from('sites').upload(path, file, { contentType: file.type, upsert: true });
        if (error) throw error;
        const { data: urlData } = SB.storage.from('sites').getPublicUrl(path);
        photos.push(urlData.publicUrl);
      }
      await SB.from('directions').update({ photos: JSON.stringify(photos) }).eq('id', dirId);
      toast(toUpload.length + ' —Ñ–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ', 'success');
    }
    await loadData();
    renderSubprojectView();
  } catch(e) {
    console.error('Upload error:', e);
    toast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + (e.message||e), 'error');
  }
}

async function removeAnketaFile(dirId, type) {
  try {
    if (type === 'logo') {
      await SB.from('directions').update({ logo_url: null }).eq('id', dirId);
      toast('–õ–æ–≥–æ—Ç–∏–ø —É–¥–∞–ª—ë–Ω', 'success');
    }
    await loadData();
    renderSubprojectView();
  } catch(e) {
    toast('–û—à–∏–±–∫–∞: ' + e.message, 'error');
  }
}

async function removeAnketaPhoto(dirId, index) {
  try {
    const dir = (DATA.directions||[]).find(d => (d['ID']||d.id) === dirId);
    let photos = [];
    try { photos = JSON.parse(dir['photos'] || '[]'); } catch(e) {}
    photos.splice(index, 1);
    await SB.from('directions').update({ photos: JSON.stringify(photos) }).eq('id', dirId);
    toast('–§–æ—Ç–æ —É–¥–∞–ª–µ–Ω–æ', 'success');
    await loadData();
    renderSubprojectView();
  } catch(e) {
    toast('–û—à–∏–±–∫–∞: ' + e.message, 'error');
  }
}

function updateLeadPrice() {
  const sel = document.getElementById('cc-lead-type');
  const priceEl = document.getElementById('cc-lead-price');
  if (sel && priceEl && sel.value) {
    const p = SITE_PRICING[sel.value];
    if (p && (!priceEl.value || priceEl.value === '0')) priceEl.value = p.price;
  }
}

async function saveLeadData(id) {
  const v = (sel) => { const el = document.getElementById(sel); return el ? el.value.trim() : ''; };
  const updates = {
    phone: v('cc-lead-phone') || null,
    city: v('cc-lead-city') || null,
    site_type: v('cc-lead-type') || null,
    price: Number(v('cc-lead-price')) || 0,
    manager: v('cc-lead-manager') || null
  };
  try {
    const { error } = await SB.from('directions').update(updates).eq('id', id);
    if (error) throw error;
    toast('‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
    await loadData();
  } catch(e) {
    console.error('saveLeadData error:', e);
    toast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: '+e.message,'error');
  }
}

async function advanceLeadToAnketa(id) {
  const phone = document.getElementById('cc-lead-phone')?.value?.trim();
  const type = document.getElementById('cc-lead-type')?.value?.trim();
  if (!phone && !type) {
    toast('‚ö†Ô∏è –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∑–∞–ø–æ–ª–Ω–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω –∏ —Ç–∏–ø —Å–∞–π—Ç–∞','warning');
  }
  await saveLeadData(id);
  await setDealStage(id, 'contact');
  closeClientCard();
  setTimeout(() => renderProjectView(), 300);
}

async function advanceAnketaToProto(id) {
  await saveAnketa(id);
  await setDealStage(id, 'proto');
  closeClientCard();
  setTimeout(() => renderProjectView(), 300);
}

// Universal stage advance with auto-save and auto-follow-up
async function advanceToStage(id, newStage) {
  const dir = (DATA.directions||[]).find(d => (d['ID']||d.id) === id);
  if (!dir) return;
  // Auto-log touch when advancing from contact stages
  const stage = dir['stage']||'prospect';
  if (['prospect','contact','proposal','negotiation'].includes(stage)) {
    dir['–ö–∞—Å–∞–Ω–∏—è'] = (Number(dir['–ö–∞—Å–∞–Ω–∏—è']||0)) + 1;
    try {
      const dbId = dir['ID'] || dir._dbId || dir.id;
      await SB.from('directions').update({touches: dir['–ö–∞—Å–∞–Ω–∏—è']}).eq('id', dbId);
    } catch(e) {}
  }
  await setDealStage(id, newStage);
  closeClientCard();
  setTimeout(() => renderProjectView(), 300);
}

// Budget/finance block for client card
function renderClientFinance(dir) {
  const price = Number(dir['–¶–µ–Ω–∞']) || 0;
  if (!price) return '';
  const paid = !!dir['–û–ø–ª–∞—á–µ–Ω–æ'];

  // Calculate staff costs based on individual salary_pct
  const clientTasks = (DATA.tasks||[]).filter(t => t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] === dir['–ù–∞–∑–≤–∞–Ω–∏–µ']);
  const assignedNames = new Set();
  clientTasks.forEach(t => { if (t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']) assignedNames.add(t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']); });
  let staffCost = 0;

  let h = '<div class="card" style="padding:16px;margin-bottom:12px">';
  h += '<div style="font-size:13px;font-weight:700;margin-bottom:10px">üí∞ –§–∏–Ω–∞–Ω—Å—ã</div>';
  h += '<div style="display:grid;grid-template-columns:1fr auto;gap:4px 12px;font-size:12px">';
  h += '<div>üíµ –¶–µ–Ω–∞ –∫–ª–∏–µ–Ω—Ç—É</div><div style="font-weight:700">'+price.toLocaleString('ru')+'‚ÇΩ</div>';

  assignedNames.forEach(name => {
    const emp = (DATA.staff||[]).find(s => s['–ò–º—è'] === name);
    if (emp) {
      const pct = parseInt(emp['–ü—Ä–æ—Ü–µ–Ω—Ç_–ó–ü']) || DEFAULT_SALARY_PCT[emp['–†–æ–ª—å']] || 0;
      if (pct > 0) {
        const pay = Math.round(price * pct / 100);
        staffCost += pay;
        h += '<div>üë§ '+esc(name)+' ('+pct+'%)</div><div>‚àí'+pay.toLocaleString('ru')+'‚ÇΩ</div>';
      }
    }
  });

  const profit = price - staffCost;
  h += '<div style="border-top:1px solid var(--border);padding-top:4px;font-weight:700;color:var(--green)">üìà –ü—Ä–∏–±—ã–ª—å –∫–æ–º–ø–∞–Ω–∏–∏</div>';
  h += '<div style="border-top:1px solid var(--border);padding-top:4px;font-weight:700;color:var(--green)">'+profit.toLocaleString('ru')+'‚ÇΩ</div>';
  h += '</div>';
  h += '<div style="margin-top:8px;font-size:11px;text-align:center;padding:6px;border-radius:6px;background:'+(paid?'rgba(0,212,170,0.1)':'rgba(255,170,0,0.1)')+';color:'+(paid?'var(--green)':'var(--orange)')+'">'+(paid?'‚úÖ –û–ø–ª–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞':'‚è≥ –û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã')+'</div>';
  h += '</div>';
  return h;
}


function createClientCardOverlay() {
  const el = document.createElement('div');
  el.id = 'client-card-overlay';
  el.style.cssText = 'display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:1000;justify-content:flex-end;backdrop-filter:blur(4px)';
  el.onclick = () => closeClientCard();
  document.body.appendChild(el);
  const style = document.createElement('style');
  style.textContent = '.client-card-panel{width:520px;max-width:90vw;background:var(--bg2);height:100vh;overflow-y:auto;box-shadow:-8px 0 30px rgba(0,0,0,0.3);animation:slideInRight .25s ease}@keyframes slideInRight{from{transform:translateX(100%)}to{transform:translateX(0)}}';
  document.head.appendChild(style);
  return el;
}

function closeClientCard() {
  const el = document.getElementById('client-card-overlay');
  if (el) el.style.display = 'none';
}

// ============================================================
// KANBAN PIPELINE
// ============================================================
const STAGES = [
  {id:'prospect',name:'üîç –ü–æ–∏—Å–∫',color:'var(--text2)',tip:'–ù–∞–π–¥–µ–Ω –Ω–∞ –∫–∞—Ä—Ç–∞—Ö, –∫–æ–Ω—Ç–∞–∫—Ç –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω',pct:5},
  {id:'contact',name:'üìû –ü–µ—Ä–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç',color:'var(--blue)',tip:'–ü–æ–∑–≤–æ–Ω–∏–ª–∏/–Ω–∞–ø–∏—Å–∞–ª–∏, –∂–¥—ë–º –æ—Ç–≤–µ—Ç',pct:10},
  {id:'interest',name:'‚úÖ –ò–Ω—Ç–µ—Ä–µ—Å',color:'var(--purple)',tip:'–ö–ª–∏–µ–Ω—Ç –æ—Ç–≤–µ—Ç–∏–ª, –≥–æ—Ç–æ–≤ —Å–º–æ—Ç—Ä–µ—Ç—å',pct:20},
  {id:'proto',name:'üé® –ü—Ä–æ—Ç–æ—Ç–∏–ø',color:'#9b59b6',tip:'–î–µ–º–æ-—Å–∞–π—Ç —Å–æ–∑–¥–∞–Ω –∏ –ø–æ–∫–∞–∑–∞–Ω',pct:40},
  {id:'proposal',name:'üìã –ö–ü –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ',color:'var(--orange)',tip:'–¶–µ–Ω–∞ –∏ —É—Å–ª–æ–≤–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã',pct:60},
  {id:'negotiation',name:'ü§ù –ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã',color:'#e67e22',tip:'–û–±—Å—É–∂–¥–∞–µ–º, —Ç–æ—Ä–≥—É–µ–º—Å—è',pct:75},
  {id:'payment',name:'üí∞ –û–ø–ª–∞—Ç–∞',color:'var(--pink)',tip:'–ö–ª–∏–µ–Ω—Ç –æ–ø–ª–∞—Ç–∏–ª',pct:90},
  {id:'done',name:'‚úÖ –°–¥–∞–Ω',color:'var(--green)',tip:'–°–∞–π—Ç –≥–æ—Ç–æ–≤ –∏ –ø–µ—Ä–µ–¥–∞–Ω',pct:100},
  {id:'lost',name:'‚ùå –û—Ç–∫–∞–∑',color:'var(--red)',tip:'–ö–ª–∏–µ–Ω—Ç –æ—Ç–∫–∞–∑–∞–ª—Å—è',pct:0}
];

let draggedCard = null;

function renderKanban() {
  const container = document.getElementById('kanban-container');
  if (!container) return;
  const dirs = (DATA.directions||[]).filter(d => d['–ü—Ä–æ–µ–∫—Ç'] === '–°–∞–π—Ç—ã');
  const filterMgr = document.getElementById('kanban-filter-manager')?.value || '';
  const filtered = filterMgr ? dirs.filter(d => d['–ú–µ–Ω–µ–¥–∂–µ—Ä'] === filterMgr) : dirs;
  const td = today();

  // Update manager filter
  const mgrSelect = document.getElementById('kanban-filter-manager');
  if (mgrSelect) {
    const mgrs = [...new Set(dirs.map(d=>d['–ú–µ–Ω–µ–¥–∂–µ—Ä']).filter(Boolean))];
    const curVal = mgrSelect.value;
    mgrSelect.innerHTML = '<option value="">–í—Å–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã</option>' + mgrs.map(m => `<option value="${esc(m)}"${m===curVal?' selected':''}>${esc(m)}</option>`).join('');
  }

  let html = '';
  STAGES.forEach(stage => {
    const deals = filtered.filter(d => (d['stage']||'prospect') === stage.id);
    const sum = deals.reduce((s,d) => s + (Number(d['–¶–µ–Ω–∞'])||0), 0);
    html += `<div class="kanban-col" data-stage="${stage.id}" ondragover="kanbanDragOver(event)" ondrop="kanbanDrop(event,this)" ondragleave="this.classList.remove('drag-over')">
      <div class="kanban-col-header">
        <div>${stage.name} <span class="k-count">${deals.length}</span></div>
        <div class="k-sum">${sum ? sum.toLocaleString('ru')+'‚ÇΩ' : ''}</div>
      </div>
      <div class="kanban-col-body">`;
    deals.forEach(d => {
      const id = d['ID']||d.id||'';
      const overdue = d['–î–µ–¥–ª–∞–π–Ω'] && d['–î–µ–¥–ª–∞–π–Ω'] < td && stage.id !== 'done';
      html += `<div class="kanban-card${overdue?' overdue':''}" draggable="true" data-id="${id}" onclick="openSlideOver('${escA(id)}')" ondragstart="kanbanDragStart(event,this)" ondragend="kanbanDragEnd(this)">
        <div class="k-name">${esc(d['–ù–∞–∑–≤–∞–Ω–∏–µ']||d['name']||'?')}</div>
        <div class="k-meta">
          ${d['–¶–µ–Ω–∞']?'<span class="k-price">'+Number(d['–¶–µ–Ω–∞']).toLocaleString('ru')+'‚ÇΩ</span>':''}
          ${d['–¢–∏–ø —Å–∞–π—Ç–∞']?'<span class="k-type">'+esc(d['–¢–∏–ø —Å–∞–π—Ç–∞'])+'</span>':''}
          ${d['–ì–æ—Ä–æ–¥']?'<span class="k-city">üìç'+esc(d['–ì–æ—Ä–æ–¥'])+'</span>':''}
          ${d['–û–ø–ª–∞—á–µ–Ω–æ']?'<span class="k-paid">üí∞</span>':'<span class="k-unpaid">‚è≥</span>'}
          ${d['–ú–µ–Ω–µ–¥–∂–µ—Ä']?'<span class="k-manager">üë§'+esc(d['–ú–µ–Ω–µ–¥–∂–µ—Ä'])+'</span>':''}
        </div>
        ${getUserPerms().canDelete ? '<button class="k-delete-btn" onclick="event.stopPropagation();confirmDelete(\'direction\',\''+escA(id)+'\',\''+escA(d['–ù–∞–∑–≤–∞–Ω–∏–µ']||'')+'\')" title="–£–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞">üóë</button>' : ''}
      </div>`;
    });
    html += '</div></div>';
  });
  container.innerHTML = html;
}

function kanbanDragStart(e, el) {
  draggedCard = el;
  el.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/plain', el.dataset.id);
}
function kanbanDragEnd(el) { el.classList.remove('dragging'); draggedCard = null; }
function kanbanDragOver(e) { e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
async function kanbanDrop(e, col) {
  e.preventDefault();
  col.classList.remove('drag-over');
  const id = e.dataTransfer.getData('text/plain');
  const newStage = col.dataset.stage;
  if (!id || !newStage) return;
  const dir = (DATA.directions||[]).find(d => (d['ID']||d.id) === id);
  if (!dir) return;
  const oldStage = dir['stage']||'prospect';
  if (oldStage === newStage) return;
  dir['stage'] = newStage;
  try {
    const dbId = dir['ID'] || dir._dbId || dir.id;
    await SB.from('directions').update({stage: newStage}).eq('id', dbId);
    toast('‚úÖ ' + (dir['–ù–∞–∑–≤–∞–Ω–∏–µ']||'–°–¥–µ–ª–∫–∞') + ' ‚Üí ' + STAGES.find(s=>s.id===newStage)?.name);
    renderKanban();
  } catch(err) { toast('‚ùå –û—à–∏–±–∫–∞: '+err.message, 'error'); }
}

// ============================================================
// SLIDE-OVER DEAL CARD
// ============================================================
let currentDealId = null;

// Quick AI action
function aiQuick(text) {
  const input = document.getElementById('ai-global-input');
  if (input) { input.value = text; sendGlobalAi(); }
}

function togglePipeStage(hdr) {
  const body = hdr.parentElement.querySelector('.pipe-stage-body');
  if (!body) return;
  const arrow = hdr.querySelector('.pipe-stats span:last-child');
  if (body.style.display === 'none') {
    body.style.display = '';
    if (arrow) arrow.textContent = '‚ñæ';
  } else {
    body.style.display = 'none';
    if (arrow) arrow.textContent = '‚ñ∏';
  }
}

async function deleteClient(id, name) {
  const p = getUserPerms();
  if (p.level < 3) { toast('‚õî –¢–æ–ª—å–∫–æ CEO –∏ –ó–∞–º –º–æ–≥—É—Ç —É–¥–∞–ª—è—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤','error'); return; }
  
  document.getElementById('confirmTitle').textContent = 'üóë –£–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞?';
  document.getElementById('confirmText').textContent = '¬´' + name + '¬ª –∏ –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.';
  document.getElementById('confirmOverlay').classList.add('show');
  confirmCallback = async function(ok) {
    if (!ok) return;
    try {
      const { error: e1 } = await SB.from('directions').delete().eq('id', id);
      if (e1) throw e1;
      const { error: e2 } = await SB.from('tasks').delete().eq('direction', name);
      if (e2) console.warn('Task delete warn:', e2);
      toast('‚úÖ –ö–ª–∏–µ–Ω—Ç ¬´' + name + '¬ª —É–¥–∞–ª—ë–Ω', 'success');
      await loadData();
      syncSubprojectsFromDb(currentProject);
      renderProjectView();
    } catch(e) {
      toast('‚ùå –û—à–∏–±–∫–∞: ' + e.message, 'error');
    }
  };
}

// File upload for AI chat
function attachFileToAI() {
  const inp = document.createElement('input');
  inp.type = 'file';
  inp.accept = '.pdf,.doc,.docx,.txt,.png,.jpg,.jpeg,.csv,.xlsx';
  inp.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    window._aiAttachedFile = file;
    const badge = document.getElementById('ai-file-badge');
    if (badge) {
      badge.textContent = 'üìé ' + file.name;
      badge.style.display = 'inline-block';
    }
    toast('üìé –§–∞–π–ª –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω: ' + file.name, 'info');
  };
  inp.click();
}

function openSlideOver(id) {
  const dir = (DATA.directions||[]).find(d => (d['ID']||d.id) === id);
  if (!dir) return;
  currentDealId = id;
  const stage = dir['stage']||'prospect';
  const stageIdx = STAGES.findIndex(s=>s.id===stage);
  const td = today();

  document.getElementById('so-name').textContent = dir['–ù–∞–∑–≤–∞–Ω–∏–µ']||'?';
  document.getElementById('so-type').textContent = (dir['–¢–∏–ø —Å–∞–π—Ç–∞']||'‚Äî') + ' ¬∑ ' + (dir['–ì–æ—Ä–æ–¥']||'‚Äî');

  // Progress bar
  document.getElementById('so-progress').innerHTML = STAGES.map((s,i) =>
    `<div class="so-step ${i<stageIdx?'done':''} ${i===stageIdx?'active':''}" title="${s.name}" onclick="setDealStage('${id}','${s.id}')"></div>`
  ).join('');
  document.getElementById('so-stage-labels').innerHTML = STAGES.map(s =>
    `<span>${s.name.replace(/[^\s\w–ê-–Ø–∞-—è—ë–Å]/g,'').trim()}</span>`
  ).join('');

  // Guided workflow banner
  const wfBanner = document.getElementById('so-workflow-banner');
  const nextActions = {
    'prospect': {step:'1Ô∏è‚É£',title:'–ü–æ–∑–≤–æ–Ω–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç—É',desc:'–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç ‚Äî –ø–æ–∑–≤–æ–Ω–∏—Ç–µ –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ',action:'üìû –ü–æ–∑–≤–æ–Ω–∏–ª ‚Üí –ü–µ—Ä–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç',fn:"setDealStage('"+id+"','contact')"},
    'contact': {step:'2Ô∏è‚É£',title:'–ñ–¥—ë–º –æ—Ç–≤–µ—Ç –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞',desc:'–ö–ª–∏–µ–Ω—Ç –∑–Ω–∞–µ—Ç –æ –Ω–∞—Å. –ü–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç–µ —á–µ—Ä–µ–∑ 1-2 –¥–Ω—è –µ—Å–ª–∏ –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª',action:'‚úÖ –ö–ª–∏–µ–Ω—Ç –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω',fn:"setDealStage('"+id+"','interest')"},
    'interest': {step:'3Ô∏è‚É£',title:'–°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ—Ç–æ—Ç–∏–ø —Å–∞–π—Ç–∞',desc:'–ö–ª–∏–µ–Ω—Ç –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω ‚Äî –ø–æ–∫–∞–∂–∏—Ç–µ –µ–º—É –¥–µ–º–æ-—Å–∞–π—Ç',action:'üé® –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ç–æ—Ç–∏–ø',fn:"openSubproject('"+escA(dir['–ù–∞–∑–≤–∞–Ω–∏–µ']||'')+"')"},
    'proto': {step:'4Ô∏è‚É£',title:'–û—Ç–ø—Ä–∞–≤—å—Ç–µ –ö–ü (–∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ)',desc:'–ü–æ–∫–∞–∂–∏—Ç–µ –ø—Ä–æ—Ç–æ—Ç–∏–ø + –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ü–µ–Ω—É –∏ —É—Å–ª–æ–≤–∏—è',action:'üìã –ö–ü –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ',fn:"setDealStage('"+id+"','proposal')"},
    'proposal': {step:'5Ô∏è‚É£',title:'–û–±—Å—É–¥–∏—Ç–µ —É—Å–ª–æ–≤–∏—è',desc:'–°–æ–∑–≤–æ–Ω–∏—Ç–µ—Å—å, –æ–±—Å—É–¥–∏—Ç–µ –ø—Ä–∞–≤–∫–∏, —Ç–æ—Ä–≥—É–π—Ç–µ—Å—å',action:'ü§ù –ù–∞—á–∞–ª–∏ –ø–µ—Ä–µ–≥–æ–≤–æ—Ä—ã',fn:"setDealStage('"+id+"','negotiation')"},
    'negotiation': {step:'6Ô∏è‚É£',title:'–ó–∞–∫—Ä–æ–π—Ç–µ —Å–¥–µ–ª–∫—É!',desc:'–ö–ª–∏–µ–Ω—Ç –≥–æ—Ç–æ–≤ ‚Äî –≤—ã—Å—Ç–∞–≤—å—Ç–µ —Å—á—ë—Ç',action:'üí∞ –ö–ª–∏–µ–Ω—Ç –æ–ø–ª–∞—Ç–∏–ª',fn:"setDealStage('"+id+"','payment')"},
    'payment': {step:'7Ô∏è‚É£',title:'–°–¥–∞–π—Ç–µ —Å–∞–π—Ç',desc:'–ó–∞–ª–µ–π—Ç–µ –Ω–∞ —Ö–æ—Å—Ç–∏–Ω–≥ –∏ –ø–µ—Ä–µ–¥–∞–π—Ç–µ –∫–ª–∏–µ–Ω—Ç—É',action:'‚úÖ –°–∞–π—Ç —Å–¥–∞–Ω!',fn:"setDealStage('"+id+"','done')"}
  };
  if (nextActions[stage]) {
    const na = nextActions[stage];
    wfBanner.innerHTML = `<div class="workflow-banner"><div class="wf-step">${na.step}</div><div class="wf-info"><h4>${na.title}</h4><p>${na.desc}</p></div><div class="wf-action"><button onclick="${na.fn}">${na.action}</button></div></div>`;
  } else if (stage === 'done') {
    wfBanner.innerHTML = '<div class="workflow-banner" style="border-color:var(--green);background:rgba(0,212,170,.06)"><div class="wf-step">üéâ</div><div class="wf-info"><h4 style="color:var(--green)">–ü—Ä–æ–µ–∫—Ç –∑–∞–≤–µ—Ä—à—ë–Ω!</h4><p>–ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∏–ª –≥–æ—Ç–æ–≤—ã–π —Å–∞–π—Ç</p></div></div>';
  } else if (stage === 'lost') {
    wfBanner.innerHTML = '<div class="workflow-banner" style="border-color:var(--red);background:rgba(255,75,75,.06)"><div class="wf-step">‚ùå</div><div class="wf-info"><h4 style="color:var(--red)">–ö–ª–∏–µ–Ω—Ç –æ—Ç–∫–∞–∑–∞–ª—Å—è</h4><p>–ü—Ä–∏—á–∏–Ω–∞: '+(esc(dir['–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞']||'–Ω–µ —É–∫–∞–∑–∞–Ω–∞'))+'</p></div><div class="wf-action"><button onclick="setDealStage(\''+id+'\',\'prospect\')">üîÑ –í–µ—Ä–Ω—É—Ç—å –≤ –≤–æ—Ä–æ–Ω–∫—É</button></div></div>';
  } else {
    wfBanner.innerHTML = '';
  }

  // Details - expanded with sales data
  const touches = Number(dir['–ö–∞—Å–∞–Ω–∏—è']||0);
  const nextContact = dir['–°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç']||'';
  const isOverdue = nextContact && nextContact <= td && !['done','lost'].includes(stage);
  document.getElementById('so-details').innerHTML = `
    <div class="so-detail-item"><div class="so-label">üí∞ –¶–µ–Ω–∞</div><div class="so-value">${(Number(dir['–¶–µ–Ω–∞'])||0).toLocaleString('ru')}‚ÇΩ</div></div>
    <div class="so-detail-item"><div class="so-label">üí≥ –û–ø–ª–∞—Ç–∞</div><div class="so-value" style="color:${dir['–û–ø–ª–∞—á–µ–Ω–æ']?'var(--green)':'var(--orange)'}">${dir['–û–ø–ª–∞—á–µ–Ω–æ']?'‚úÖ –û–ø–ª–∞—á–µ–Ω':'‚è≥ –ù–µ –æ–ø–ª–∞—á–µ–Ω'}</div></div>
    <div class="so-detail-item"><div class="so-label">üë§ –ö–æ–Ω—Ç–∞–∫—Ç</div><div class="so-value">${esc(dir['–ö–ª–∏–µ–Ω—Ç']||dir['–ù–∞–∑–≤–∞–Ω–∏–µ']||'‚Äî')}</div></div>
    <div class="so-detail-item"><div class="so-label">üì± –¢–µ–ª–µ—Ñ–æ–Ω</div><div class="so-value">${esc(dir['–¢–µ–ª–µ—Ñ–æ–Ω']||'‚Äî')}</div></div>
    <div class="so-detail-item"><div class="so-label">üë§ –ú–µ–Ω–µ–¥–∂–µ—Ä</div><div class="so-value">${esc(dir['–ú–µ–Ω–µ–¥–∂–µ—Ä']||'‚Äî')}</div></div>
    <div class="so-detail-item"><div class="so-label">üì° –ò—Å—Ç–æ—á–Ω–∏–∫</div><div class="so-value">${esc(dir['–ò—Å—Ç–æ—á–Ω–∏–∫']||'‚Äî')}</div></div>
    <div class="so-detail-item"><div class="so-label">üåê –¢–∏–ø</div><div class="so-value">${esc(dir['–¢–∏–ø —Å–∞–π—Ç–∞']||'‚Äî')}</div></div>
    <div class="so-detail-item"><div class="so-label">üìç –ì–æ—Ä–æ–¥</div><div class="so-value">${esc(dir['–ì–æ—Ä–æ–¥']||'‚Äî')}</div></div>
    <div class="so-detail-item"><div class="so-label">üìû –ö–∞—Å–∞–Ω–∏–π</div><div class="so-value">${touches} –∏–∑ 8</div></div>
    <div class="so-detail-item"><div class="so-label">üìÖ –ü–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å</div><div class="so-value" style="color:${isOverdue?'var(--orange)':'inherit'}">${isOverdue?'üîî ':''}${nextContact ? formatDateRu(nextContact) : '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}</div></div>
    ${dir['–°—Å—ã–ª–∫–∞']?'<div class="so-detail-item" style="grid-column:span 2"><div class="so-label">üîó –°—Å—ã–ª–∫–∞</div><div class="so-value"><a href="'+esc(dir['–°—Å—ã–ª–∫–∞'])+'" target="_blank" style="color:var(--accent)">'+esc(dir['–°—Å—ã–ª–∫–∞'])+'</a></div></div>':''}
    ${dir['–û–ø–∏—Å–∞–Ω–∏–µ']?'<div class="so-detail-item" style="grid-column:span 2"><div class="so-label">üìù –ó–∞–º–µ—Ç–∫–∞</div><div class="so-value">'+esc(dir['–û–ø–∏—Å–∞–Ω–∏–µ'])+'</div></div>':''}
    ${dir['–§–∏–¥–±–µ–∫']?'<div class="so-detail-item" style="grid-column:span 2"><div class="so-label">üí¨ –§–∏–¥–±–µ–∫</div><div class="so-value">'+esc(dir['–§–∏–¥–±–µ–∫'])+'</div></div>':''}
  `;

  // Actions
  const p = getUserPerms();
  const cleanPh = (dir['–¢–µ–ª–µ—Ñ–æ–Ω']||'').replace(/[^\d+]/g,'');
  document.getElementById('so-actions').innerHTML = `
    ${cleanPh?'<button onclick="window.open(\'tel:'+cleanPh+'\')">üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</button>':''}
    ${cleanPh?'<button onclick="window.open(\'https://t.me/'+cleanPh.replace('+','')+'\',\'_blank\')">üí¨ Telegram</button>':''}
    <button onclick="logTouch('${id}')">üìû –ó–∞–ø–∏—Å–∞—Ç—å –∫–∞—Å–∞–Ω–∏–µ</button>
    <button onclick="scheduleFollowUp('${id}')">üìÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ</button>
    <button onclick="addDealFeedback('${id}')">üí¨ –§–∏–¥–±–µ–∫</button>
    <button onclick="addDealNote('${id}')">üìù –ó–∞–º–µ—Ç–∫–∞</button>
    <button onclick="closeSlideOver();openSubproject('${escA(dir['–ù–∞–∑–≤–∞–Ω–∏–µ']||'')}')">üìÇ –û—Ç–∫—Ä—ã—Ç—å</button>
    ${p.canWrite?'<button onclick="closeSlideOver();openClientCard(\''+escA(id)+'\')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>':''}
    ${!dir['–û–ø–ª–∞—á–µ–Ω–æ']&&p.canWrite?'<button onclick="markPaid(\''+id+'\')">üí∞ –û–ø–ª–∞—Ç–∞</button>':''}
    ${stage!=='lost'&&stage!=='done'?'<button onclick="rejectDeal(\''+id+'\')" style="background:rgba(255,75,75,.15);color:var(--red)">‚ùå –û—Ç–∫–∞–∑</button>':''}
    ${p.canDelete?'<button onclick="confirmDelete(\'direction\',\''+escA(id)+'\',\''+escA(dir['–ù–∞–∑–≤–∞–Ω–∏–µ']||'')+'\')" style="background:rgba(231,76,60,.15);color:var(--red)">üóë –£–¥–∞–ª–∏—Ç—å</button>':''}
  `;

  // Tasks checklist
  const tasks = (DATA.tasks||[]).filter(t => t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] === dir['–ù–∞–∑–≤–∞–Ω–∏–µ'] || t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] === dir['name']);
  document.getElementById('so-tasks').innerHTML = tasks.length ? tasks.map(t => {
    const done = t['–°—Ç–∞—Ç—É—Å'] === '–ì–æ—Ç–æ–≤–æ';
    return `<li class="${done?'done':''}"><span class="check" onclick="toggleTaskDone('${t['ID']||t.id}')">${done?'‚úì':''}</span>${esc(t['–û–ø–∏—Å–∞–Ω–∏–µ']||t['–ù–∞–∑–≤–∞–Ω–∏–µ']||'?')}</li>`;
  }).join('') : '<li style="color:var(--text3)">–ù–µ—Ç –∑–∞–¥–∞—á</li>';

  // Next stage button
  const nextBtn = document.getElementById('so-next-btn');
  if (stageIdx < STAGES.length - 1 && stage !== 'done') {
    nextBtn.style.display = 'block';
    nextBtn.textContent = '‚û°Ô∏è –ü–µ—Ä–µ–≤–µ—Å—Ç–∏: ' + STAGES[stageIdx+1].name;
  } else {
    nextBtn.style.display = 'none';
  }

  document.getElementById('slideoverOverlay').classList.add('open');
  document.getElementById('slideoverPanel').classList.add('open');
}

function closeSlideOver() {
  document.getElementById('slideoverOverlay').classList.remove('open');
  document.getElementById('slideoverPanel').classList.remove('open');
  currentDealId = null;
}

// Mapping: deal stage ‚Üí which SITE_PIPELINE steps should be completed by this stage
const STAGE_TO_STEPS = {
  'prospect':     { complete: [],         active: [1] },
  'contact':      { complete: [1],        active: [2] },
  'interest':     { complete: [1,2],      active: [3,4] },
  'proto':        { complete: [1,2,3,4],  active: [5,6] },
  'proposal':     { complete: [1,2,3,4,5,6], active: [7] },
  'negotiation':  { complete: [1,2,3,4,5,6,7], active: [8] },
  'payment':      { complete: [1,2,3,4,5,6,7,8], active: [9] },
  'done':         { complete: [1,2,3,4,5,6,7,8,9,10,11], active: [12] },
  'lost':         { complete: [],         active: [] }
};

async function setDealStage(id, newStage) {
  const dir = (DATA.directions||[]).find(d => (d['ID']||d.id) === id);
  if (!dir) { console.error('setDealStage: direction not found for id', id); toast('‚ùå –ö–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω','error'); return; }
  const oldStage = dir['stage']||'prospect';
  dir['stage'] = newStage;
  try {
    const dbId = dir['ID'] || dir._dbId || dir.id;
    if (!dbId) { console.error('setDealStage: no dbId!', dir); toast('‚ùå –ù–µ—Ç ID –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è','error'); return; }
    const { error } = await SB.from('directions').update({stage: newStage}).eq('id', dbId);
    if (error) throw error;
    const stageName = STAGES.find(s=>s.id===newStage)?.name || newStage;
    toast('‚úÖ ‚Üí ' + stageName);

    // Auto-update tasks based on new stage
    await syncTasksForStage(dir, newStage);

    await loadData();
    renderAll();
    if (currentDealId === id) openSlideOver(id);
  } catch(err) {
    dir['stage'] = oldStage;
    console.error('setDealStage error:', err);
    toast('‚ùå –û—à–∏–±–∫–∞: '+err.message,'error');
  }
}

// Sync tasks: complete old steps, activate new ones, create missing ones
async function syncTasksForStage(dir, stage) {
  const dirName = dir['–ù–∞–∑–≤–∞–Ω–∏–µ'] || dir['name'] || '';
  if (!dirName) return;
  const mapping = STAGE_TO_STEPS[stage];
  if (!mapping) return;

  // Get all tasks for this direction
  const clientTasks = (DATA.tasks||[]).filter(t => (t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'') === dirName);

  // For each pipeline step, find matching task by keywords
  const matchTask = (stepNum) => {
    const pipeStep = SITE_PIPELINE.find(p => p.step === stepNum);
    if (!pipeStep) return null;
    const stepName = pipeStep.name.replace(/[^\w–∞-—è—ë]/gi, ' ').toLowerCase();
    const keywords = stepName.split(/\s+/).filter(w => w.length > 2);
    return clientTasks.find(t => {
      const desc = (t['–û–ø–∏—Å–∞–Ω–∏–µ']||'').toLowerCase();
      return keywords.filter(k => desc.includes(k)).length >= 2;
    });
  };

  const updates = [];

  // Mark completed steps as "–ì–æ—Ç–æ–≤–æ"
  for (const stepNum of mapping.complete) {
    const task = matchTask(stepNum);
    if (task && (task['–°—Ç–∞—Ç—É—Å']||'') !== '–ì–æ—Ç–æ–≤–æ' && (task['–°—Ç–∞—Ç—É—Å']||'') !== '‚úÖ –ì–æ—Ç–æ–≤–æ') {
      const taskId = task['ID'] || task.id;
      if (taskId) {
        updates.push(SB.from('tasks').update({status: '–ì–æ—Ç–æ–≤–æ'}).eq('id', taskId));
      }
    }
  }

  // Mark active steps as "–í —Ä–∞–±–æ—Ç–µ" (if they're not already done)
  for (const stepNum of mapping.active) {
    const task = matchTask(stepNum);
    if (task) {
      const st = task['–°—Ç–∞—Ç—É—Å']||'';
      if (st !== '–ì–æ—Ç–æ–≤–æ' && st !== '‚úÖ –ì–æ—Ç–æ–≤–æ' && st !== '–í —Ä–∞–±–æ—Ç–µ' && st !== 'üîÑ –í —Ä–∞–±–æ—Ç–µ') {
        const taskId = task['ID'] || task.id;
        if (taskId) {
          updates.push(SB.from('tasks').update({status: '–í —Ä–∞–±–æ—Ç–µ'}).eq('id', taskId));
        }
      }
    } else {
      // Task doesn't exist for this step ‚Äî create it
      const pipeStep = SITE_PIPELINE.find(p => p.step === stepNum);
      if (pipeStep) {
        const assigned = getSiteStaffByRole(pipeStep.role);
        const dl = new Date();
        dl.setDate(dl.getDate() + (pipeStep.days || 3));
        const newTask = {
          id: genId('T'),
          description: pipeStep.name + ': ' + dirName,
          direction: dirName,
          project: '–°–∞–π—Ç—ã',
          status: '–í —Ä–∞–±–æ—Ç–µ',
          priority: 'P2',
          assignee: assigned || '',
          deadline: dl.toISOString().slice(0,10)
        };
        updates.push(SB.from('tasks').insert(newTask));
      }
    }
  }

  if (updates.length > 0) {
    try {
      await Promise.all(updates);
      console.log('[RKT] syncTasksForStage: updated', updates.length, 'tasks for', dirName, '‚Üí', stage);
    } catch(e) {
      console.error('[RKT] syncTasksForStage error:', e);
    }
  }
}

async function advanceDealStage() {
  if (!currentDealId) return;
  const dir = (DATA.directions||[]).find(d => (d['ID']||d.id) === currentDealId);
  if (!dir) return;
  const cur = dir['stage']||'prospect';
  const idx = STAGES.findIndex(s=>s.id===cur);
  if (idx < STAGES.length - 1) {
    await setDealStage(currentDealId, STAGES[idx+1].id);
  }
}

async function markPaid(id) {
  const dir = (DATA.directions||[]).find(d => (d['ID']||d.id) === id);
  if (!dir) return;
  dir['–û–ø–ª–∞—á–µ–Ω–æ'] = true;
  try {
    const dbId = dir['ID'] || dir._dbId || dir.id;
    await SB.from('directions').update({paid: true}).eq('id', dbId);
    toast('üí∞ –û–ø–ª–∞—Ç–∞ –æ—Ç–º–µ—á–µ–Ω–∞!');
    if (currentDealId === id) openSlideOver(id);
    renderKanban();
  } catch(err) { toast('‚ùå '+err.message,'error'); }
}

// ============================================================
// SALES CRM FUNCTIONS
// ============================================================

// –ó–∞–ø–∏—Å–∞—Ç—å –∫–∞—Å–∞–Ω–∏–µ (–∑–≤–æ–Ω–æ–∫/–∫–æ–Ω—Ç–∞–∫—Ç) ‚Äî —É–≤–µ–ª–∏—á–∏—Ç—å —Å—á—ë—Ç—á–∏–∫ + –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ follow-up
async function logTouch(id) {
  const dir = (DATA.directions||[]).find(d => (d['ID']||d.id) === id);
  if (!dir) return;
  const touches = (Number(dir['–ö–∞—Å–∞–Ω–∏—è']||0)) + 1;
  dir['–ö–∞—Å–∞–Ω–∏—è'] = touches;
  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π follow-up –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é: 1‚Üí2 –¥–Ω—è, 2‚Üí3, 3‚Üí5, 4‚Üí7, 5‚Üí14, 6‚Üí21, 7‚Üí30
  const intervals = [2, 3, 5, 7, 14, 21, 30, 90];
  const nextDays = intervals[Math.min(touches-1, intervals.length-1)];
  const nextDate = addDays(today(), nextDays);
  dir['–°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç'] = nextDate;
  try {
    const dbId = dir['ID'] || dir._dbId || dir.id;
    await SB.from('directions').update({touches: touches, next_contact: nextDate}).eq('id', dbId);
    toast('üìû –ö–∞—Å–∞–Ω–∏–µ #'+touches+' –∑–∞–ø–∏—Å–∞–Ω–æ. –°–ª–µ–¥—É—é—â–∏–π –∑–≤–æ–Ω–æ–∫: '+nextDate);
    // –£–≤–µ–¥–æ–º–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –≤ Telegram
    const mgr = dir['–ú–µ–Ω–µ–¥–∂–µ—Ä'];
    if (mgr) {
      notifyTaskAssigned('üìû –ü–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å –∫–ª–∏–µ–Ω—Ç—É ¬´'+dir['–ù–∞–∑–≤–∞–Ω–∏–µ']+'¬ª '+nextDate, mgr, dir['–ù–∞–∑–≤–∞–Ω–∏–µ']);
    }
    if (currentDealId === id) openSlideOver(id);
    renderProjectView();
  } catch(err) { toast('‚ùå '+err.message,'error'); }
}

// –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ (–¥–∞—Ç–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞)
async function scheduleFollowUp(id) {
  const dir = (DATA.directions||[]).find(d => (d['ID']||d.id) === id);
  if (!dir) return;
  showCustomModal('üìÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ', `
    <div class="form-group"><label>–ö–æ–≥–¥–∞ –ø–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å?</label><input type="date" id="fu-date" value="${dir['–°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç']||addDays(today(),1)}"></div>
    <div class="form-group"><label>–ó–∞–º–µ—Ç–∫–∞</label><input type="text" id="fu-note" placeholder="–û —á—ë–º –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å"></div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button type="button" onclick="document.getElementById('fu-date').value='${addDays(today(),1)}'" style="flex:1;padding:8px;border-radius:6px;border:1px solid var(--border);background:var(--bg2);cursor:pointer">–ó–∞–≤—Ç—Ä–∞</button>
      <button type="button" onclick="document.getElementById('fu-date').value='${addDays(today(),3)}'" style="flex:1;padding:8px;border-radius:6px;border:1px solid var(--border);background:var(--bg2);cursor:pointer">–ß–µ—Ä–µ–∑ 3 –¥–Ω—è</button>
      <button type="button" onclick="document.getElementById('fu-date').value='${addDays(today(),7)}'" style="flex:1;padding:8px;border-radius:6px;border:1px solid var(--border);background:var(--bg2);cursor:pointer">–ß–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é</button>
    </div>
  `, async () => {
    const dt = document.getElementById('fu-date').value;
    const note = document.getElementById('fu-note').value.trim();
    if (!dt) { toast('‚ùå –£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É','error'); return; }
    dir['–°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç'] = dt;
    if (note) dir['–û–ø–∏—Å–∞–Ω–∏–µ'] = (dir['–û–ø–∏—Å–∞–Ω–∏–µ']||'') + '\\n['+today()+'] '+note;
    try {
      const dbId = dir['ID'] || dir._dbId || dir.id;
      const upd = {next_contact: dt};
      if (note) upd.description = dir['–û–ø–∏—Å–∞–Ω–∏–µ'];
      await SB.from('directions').update(upd).eq('id', dbId);
      toast('üìÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: '+dt);
      closeCustomModal();
      // –£–≤–µ–¥–æ–º–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞
      const mgr = dir['–ú–µ–Ω–µ–¥–∂–µ—Ä'];
      if (mgr) notifyTaskAssigned('üìÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: –ø–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å ¬´'+dir['–ù–∞–∑–≤–∞–Ω–∏–µ']+'¬ª '+dt+(note?' ‚Äî '+note:''), mgr, dir['–ù–∞–∑–≤–∞–Ω–∏–µ']);
      if (currentDealId === id) openSlideOver(id);
      renderProjectView();
    } catch(err) { toast('‚ùå '+err.message,'error'); }
  });
}

// –ó–∞–ø–∏—Å–∞—Ç—å —Ñ–∏–¥–±–µ–∫ –∫–ª–∏–µ–Ω—Ç–∞
async function addDealFeedback(id) {
  const dir = (DATA.directions||[]).find(d => (d['ID']||d.id) === id);
  if (!dir) return;
  showCustomModal('üí¨ –§–∏–¥–±–µ–∫ –∫–ª–∏–µ–Ω—Ç–∞', `
    <div class="form-group"><label>–†–µ–∞–∫—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞</label><select id="fb-type">
      <option value="üëç –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π">üëç –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π ‚Äî –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω</option>
      <option value="üòê –ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π">üòê –ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π ‚Äî –¥—É–º–∞–µ—Ç</option>
      <option value="üëé –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π">üëé –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π ‚Äî –Ω–µ —Ö–æ—á–µ—Ç</option>
      <option value="üìû –ù–µ –¥–æ–∑–≤–æ–Ω–∏–ª—Å—è">üìû –ù–µ –¥–æ–∑–≤–æ–Ω–∏–ª—Å—è</option>
      <option value="‚è≥ –ü–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å –ø–æ–∑–∂–µ">‚è≥ –ü–æ–ø—Ä–æ—Å–∏–ª –ø–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å –ø–æ–∑–∂–µ</option>
    </select></div>
    <div class="form-group"><label>–ß—Ç–æ —Å–∫–∞–∑–∞–ª –∫–ª–∏–µ–Ω—Ç?</label><textarea id="fb-text" rows="3" placeholder="–ß—Ç–æ –∫–ª–∏–µ–Ω—Ç —Å–∫–∞–∑–∞–ª? –ö–∞–∫–∏–µ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è? –ß—Ç–æ –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å?"></textarea></div>
  `, async () => {
    const fbType = document.getElementById('fb-type').value;
    const fbText = document.getElementById('fb-text').value.trim();
    const fb = '['+today()+'] '+fbType+(fbText?' ‚Äî '+fbText:'');
    dir['–§–∏–¥–±–µ–∫'] = (dir['–§–∏–¥–±–µ–∫']||'') + (dir['–§–∏–¥–±–µ–∫']?'\\n':'') + fb;
    try {
      const dbId = dir['ID'] || dir._dbId || dir.id;
      await SB.from('directions').update({feedback: dir['–§–∏–¥–±–µ–∫']}).eq('id', dbId);
      toast('üí¨ –§–∏–¥–±–µ–∫ –∑–∞–ø–∏—Å–∞–Ω');
      closeCustomModal();
      if (currentDealId === id) openSlideOver(id);
    } catch(err) { toast('‚ùå '+err.message,'error'); }
  });
}

// –î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É
async function addDealNote(id) {
  const dir = (DATA.directions||[]).find(d => (d['ID']||d.id) === id);
  if (!dir) return;
  showCustomModal('üìù –ó–∞–º–µ—Ç–∫–∞', `
    <div class="form-group"><label>–ó–∞–º–µ—Ç–∫–∞ –ø–æ –∫–ª–∏–µ–Ω—Ç—É</label><textarea id="dn-text" rows="3" placeholder="–õ—é–±–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è..."></textarea></div>
  `, async () => {
    const note = document.getElementById('dn-text').value.trim();
    if (!note) return;
    dir['–û–ø–∏—Å–∞–Ω–∏–µ'] = (dir['–û–ø–∏—Å–∞–Ω–∏–µ']||'') + (dir['–û–ø–∏—Å–∞–Ω–∏–µ']?'\\n':'') + '['+today()+'] '+note;
    try {
      const dbId = dir['ID'] || dir._dbId || dir.id;
      await SB.from('directions').update({description: dir['–û–ø–∏—Å–∞–Ω–∏–µ']}).eq('id', dbId);
      toast('üìù –ó–∞–º–µ—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
      closeCustomModal();
      if (currentDealId === id) openSlideOver(id);
    } catch(err) { toast('‚ùå '+err.message,'error'); }
  });
}

// –û—Ç–∫–∞–∑ –∫–ª–∏–µ–Ω—Ç–∞ ‚Äî –ø–µ—Ä–µ–≤–æ–¥ –≤ "–û—Ç–∫–∞–∑" —Å –ø—Ä–∏—á–∏–Ω–æ–π
async function rejectDeal(id) {
  const dir = (DATA.directions||[]).find(d => (d['ID']||d.id) === id);
  if (!dir) return;
  showCustomModal('‚ùå –û—Ç–∫–∞–∑ –∫–ª–∏–µ–Ω—Ç–∞', `
    <div class="form-group"><label>–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞</label><select id="rj-reason">
      <option value="–î–æ—Ä–æ–≥–æ">üí∞ –î–æ—Ä–æ–≥–æ</option>
      <option value="–ù–µ –Ω—É–∂–µ–Ω —Å–∞–π—Ç">ü§∑ –ù–µ –Ω—É–∂–µ–Ω —Å–∞–π—Ç</option>
      <option value="–í—ã–±—Ä–∞–ª –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞">üèÉ –í—ã–±—Ä–∞–ª –¥—Ä—É–≥—É—é —Å—Ç—É–¥–∏—é</option>
      <option value="–°–¥–µ–ª–∞–µ—Ç —Å–∞–º">üõ†Ô∏è –°–¥–µ–ª–∞–µ—Ç —Å–∞–º (Tilda, Wix)</option>
      <option value="–ù–µ –æ—Ç–≤–µ—á–∞–µ—Ç">üìµ –ù–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∑–≤–æ–Ω–∫–∏</option>
      <option value="–ù–µ—Ç –±—é–¥–∂–µ—Ç–∞">üí∏ –ù–µ—Ç –±—é–¥–∂–µ—Ç–∞ —Å–µ–π—á–∞—Å</option>
      <option value="–î—Ä—É–≥–æ–µ">üìå –î—Ä—É–≥–æ–µ</option>
    </select></div>
    <div class="form-group"><label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label><input type="text" id="rj-comment" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏..."></div>
  `, async () => {
    const reason = document.getElementById('rj-reason').value;
    const comment = document.getElementById('rj-comment').value.trim();
    dir['–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞'] = reason + (comment ? ' ‚Äî ' + comment : '');
    dir['stage'] = 'lost';
    try {
      const dbId = dir['ID'] || dir._dbId || dir.id;
      await SB.from('directions').update({stage: 'lost', reject_reason: dir['–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞']}).eq('id', dbId);
      toast('‚ùå –ö–ª–∏–µ–Ω—Ç ¬´'+dir['–ù–∞–∑–≤–∞–Ω–∏–µ']+'¬ª ‚Üí –û—Ç–∫–∞–∑: '+reason);
      closeCustomModal();
      closeSlideOver();
      await loadData();
      renderAll();
    } catch(err) { toast('‚ùå '+err.message,'error'); }
  });
}

async function toggleTaskDone(taskId) {
  const task = (DATA.tasks||[]).find(t => (t['ID']||t.id) === taskId);
  if (!task) return;
  const oldStatus = task['–°—Ç–∞—Ç—É—Å'];
  const newStatus = oldStatus === '–ì–æ—Ç–æ–≤–æ' ? 'üîÑ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è' : '–ì–æ—Ç–æ–≤–æ';
  task['–°—Ç–∞—Ç—É—Å'] = newStatus;
  try {
    const dbId = task['ID'] || task._dbId || task.id;
    await SB.from('tasks').update({status: newStatus}).eq('id', dbId);
    toast(newStatus === '–ì–æ—Ç–æ–≤–æ' ? '‚úÖ –ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞!' : 'üîÑ –ó–∞–¥–∞—á–∞ –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∞');
    notifyTaskStatusChange(task, oldStatus, newStatus);
    if (currentDealId) openSlideOver(currentDealId);
  } catch(err) { toast('‚ùå '+err.message,'error'); }
}

// ============================================================
// REVENUE CHART (for Dashboard)
// ============================================================

// ============================================================
// IN-APP NOTIFICATIONS
// ============================================================
var NOTIFICATIONS = [];
var notifUnread = 0;

function addNotification(text, type, link) {
  type = type || 'info';
  NOTIFICATIONS.unshift({ id: Date.now(), text: text, type: type, time: new Date(), read: false, link: link || null });
  if (NOTIFICATIONS.length > 50) NOTIFICATIONS.pop();
  notifUnread++;
  renderNotifBadge();
  try { localStorage.setItem('rkt_notifs', JSON.stringify(NOTIFICATIONS.slice(0, 50))); } catch(e) {}
}
function renderNotifBadge() {
  var b = document.getElementById('notifBadge');
  if (b) { b.textContent = notifUnread; b.style.display = notifUnread > 0 ? 'flex' : 'none'; }
}
function toggleNotifPanel() {
  var p = document.getElementById('notifPanel');
  p.classList.toggle('open');
  if (p.classList.contains('open')) renderNotifList();
}
function closeNotifPanel() { document.getElementById('notifPanel').classList.remove('open'); }
function renderNotifList() {
  var el = document.getElementById('notifList');
  if (!NOTIFICATIONS.length) {
    el.innerHTML = '<div style="padding:40px;text-align:center;color:var(--text3)"><div style="font-size:40px;margin-bottom:12px">üîï</div>–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>';
    return;
  }
  var icons = { info: '‚ÑπÔ∏è', task: 'üìã', deal: 'üí∞', system: '‚öôÔ∏è', approval: '‚úÖ' };
  el.innerHTML = NOTIFICATIONS.slice(0, 30).map(function(n) {
    return '<div class="notif-item ' + (n.read ? '' : 'unread') + '" onclick="readNotif(' + n.id + ')">' +
      '<div class="notif-text">' + (icons[n.type] || '‚ÑπÔ∏è') + ' ' + esc(n.text) + '</div>' +
      '<div class="notif-time">' + timeAgo(n.time) + '</div></div>';
  }).join('');
}
function readNotif(id) {
  var n = NOTIFICATIONS.find(function(x) { return x.id === id; });
  if (n && !n.read) { n.read = true; notifUnread = Math.max(0, notifUnread - 1); renderNotifBadge(); }
  renderNotifList();
}
function markAllNotifRead() {
  NOTIFICATIONS.forEach(function(n) { n.read = true; });
  notifUnread = 0; renderNotifBadge(); renderNotifList();
}
function loadNotifications() {
  try {
    var saved = JSON.parse(localStorage.getItem('rkt_notifs') || '[]');
    saved.forEach(function(n) { n.time = new Date(n.time); NOTIFICATIONS.push(n); });
    notifUnread = NOTIFICATIONS.filter(function(n) { return !n.read; }).length;
    renderNotifBadge();
  } catch(e) {}
}
function timeAgo(date) {
  var d = new Date(date);
  var diff = (Date.now() - d.getTime()) / 1000;
  if (diff < 60) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
  if (diff < 3600) return Math.floor(diff / 60) + ' –º–∏–Ω –Ω–∞–∑–∞–¥';
  if (diff < 86400) return Math.floor(diff / 3600) + ' —á –Ω–∞–∑–∞–¥';
  return d.toLocaleDateString('ru-RU');
}

// ============================================================
// MOBILE MENU
// ============================================================
function toggleMobileMenu() {
  document.querySelector('.sidebar').classList.toggle('mobile-open');
  document.getElementById('mobileOverlay').classList.toggle('show');
}
function closeMobileMenu() {
  document.querySelector('.sidebar').classList.remove('mobile-open');
  document.getElementById('mobileOverlay').classList.remove('show');
}
function initMobileMenu() {
  var btn = document.getElementById('mobileMenuBtn');
  if (!btn) return;
  function check() { btn.style.display = window.innerWidth <= 768 ? 'block' : 'none'; }
  check();
  window.addEventListener('resize', check);
  // Close sidebar on nav click (mobile)
  document.querySelectorAll('.sidebar .nav-item').forEach(function(item) {
    item.addEventListener('click', function() { if (window.innerWidth <= 768) closeMobileMenu(); });
  });
}

// ============================================================
// ONBOARDING
// ============================================================
function checkOnboarding() {
  if (localStorage.getItem('rkt_onboarded') || !USER || !USER.name) return;
  var roleTips = {
    'CEO': '–î–∞—à–±–æ—Ä–¥ KPI, –≤—Å–µ –ø—Ä–æ–µ–∫—Ç—ã, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥–æ–π, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è –∏ –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø.',
    '–ó–∞–º': '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞–º–∏, –∑–∞–¥–∞—á–∏ –∫–æ–º–∞–Ω–¥—ã, –ø–∞—Ä—Ç–Ω—ë—Ä—ã, –æ—Ç—á—ë—Ç—ã.',
    '–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å': '–ó–∞–¥–∞—á–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏, CRM.',
    '–ú–µ–Ω–µ–¥–∂–µ—Ä': 'CRM-–≤–æ—Ä–æ–Ω–∫–∞ —Å 9 —ç—Ç–∞–ø–∞–º–∏, —Ä–∞–±–æ—Ç–∞ —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏, —Å–∫—Ä–∏–ø—Ç—ã –ø—Ä–æ–¥–∞–∂.',
    '–°–æ—Ç—Ä—É–¥–Ω–∏–∫': '–í–∞—à–∏ –∑–∞–¥–∞—á–∏ –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–æ–µ–∫—Ç–∞.'
  };
  var role = USER.role || '–°–æ—Ç—Ä—É–¥–Ω–∏–∫';
  var tip = roleTips[role] || roleTips['–°–æ—Ç—Ä—É–¥–Ω–∏–∫'];
  var h = '<div style="text-align:center;padding:20px">';
  h += '<div style="font-size:64px;margin-bottom:16px">üëã</div>';
  h += '<h2 style="margin-bottom:8px">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ' + esc(USER.name) + '!</h2>';
  h += '<p style="color:var(--text2);margin-bottom:24px">–í–∞—à–∞ —Ä–æ–ª—å: <strong style="color:var(--accent)">' + esc(role) + '</strong></p>';
  h += '<div style="background:var(--bg3);border-radius:12px;padding:16px;margin-bottom:20px;text-align:left">';
  h += '<p style="margin-bottom:8px"><strong>–í–∞–º –¥–æ—Å—Ç—É–ø–Ω—ã:</strong></p><p>' + esc(tip) + '</p></div>';
  h += '<div style="text-align:left;margin-bottom:20px;font-size:13px;color:var(--text2);line-height:1.8">';
  h += '<strong>–ü–æ–¥—Å–∫–∞–∑–∫–∏:</strong><br>';
  h += '‚Ä¢ –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é ‚Äî –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Ä–∞–∑–¥–µ–ª–∞–º<br>';
  h += '‚Ä¢ –ö–∞—Ä—Ç–æ—á–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ ‚Äî –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ —Å–¥–µ–ª–∫–∏, —Å–∫—Ä–∏–ø—Ç—ã<br>';
  h += '‚Ä¢ ü§ñ AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç ‚Äî –ø–æ–º–æ—â—å –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞<br>';
  h += '‚Ä¢ üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ‚Äî –Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ –∏ —Å–æ–±—ã—Ç–∏—è</div>';
  h += '<button class="btn btn-primary" style="width:100%" onclick="localStorage.setItem(\'rkt_onboarded\',\'1\');closeModal()">–ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É ‚Üí</button>';
  h += '</div>';
  showCustomModal('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ RKT HUB', h);
}

// ============================================================
// SALES SCRIPTS (–∫–ª–∏–µ–Ω—Ç–æ–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ)
// ============================================================
function getSalesScript(stage, clientName, siteType) {
  var name = clientName || '[–ö–û–ú–ü–ê–ù–ò–Ø]';
  var type = siteType || '–õ–µ–Ω–¥–∏–Ω–≥';
  var scripts = {
    'prospect': {
      title: 'üìû –°–∫—Ä–∏–ø—Ç –ø–µ—Ä–≤–æ–≥–æ –∑–≤–æ–Ω–∫–∞',
      text: '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ú–µ–Ω—è –∑–æ–≤—É—Ç [–ò–ú–Ø], –∫–æ–º–ø–∞–Ω–∏—è RKT Digital.\n' +
        '–ù–∞—à—ë–ª –≤–∞—à—É –∫–æ–º–ø–∞–Ω–∏—é ¬´' + name + '¬ª –∏ —Ö–æ—Ç–µ–ª –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Å–∞–π—Ç–∞.\n' +
        '–£ –≤–∞—Å –µ—Å—Ç—å –ø–∞—Ä–∞ –º–∏–Ω—É—Ç?\n\n' +
        '‚úÖ –ï—Å–ª–∏ –¥–∞: ¬´–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ, —á–µ–º –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è –≤–∞—à –±–∏–∑–Ω–µ—Å? –ö–∞–∫–∏–µ –∑–∞–¥–∞—á–∏ —Ö–æ—Ç–∏—Ç–µ —Ä–µ—à–∏—Ç—å —Å –ø–æ–º–æ—â—å—é —Å–∞–π—Ç–∞?¬ª\n' +
        '‚ùå –ï—Å–ª–∏ –Ω–µ—Ç: ¬´–ö–æ–≥–¥–∞ —É–¥–æ–±–Ω–æ –ø–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å? –ú–æ–≥—É –ø—Ä–∏—Å–ª–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ Telegram.¬ª\n' +
        'üö™ –û–±—Ö–æ–¥ —Å–µ–∫—Ä–µ—Ç–∞—Ä—è: ¬´–°–æ–µ–¥–∏–Ω–∏—Ç–µ —Å —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª–µ–º ‚Äî –≤–æ–ø—Ä–æ—Å –ø–æ digital-–ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—é –∫–æ–º–ø–∞–Ω–∏–∏.¬ª'
    },
    'contact': {
      title: 'üìã –í—ã—è–≤–ª–µ–Ω–∏–µ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–µ–π',
      text: '–î–æ–±—Ä—ã–π –¥–µ–Ω—å, ' + name + '! –í–æ–∑–≤—Ä–∞—â–∞—é—Å—å –∫ –Ω–∞—à–µ–º—É —Ä–∞–∑–≥–æ–≤–æ—Ä—É.\n\n' +
        '1. –ö–∞–∫–∏–µ —É—Å–ª—É–≥–∏/—Ç–æ–≤–∞—Ä—ã –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∞–∑–∞—Ç—å –Ω–∞ —Å–∞–π—Ç–µ?\n' +
        '2. –ö—Ç–æ –≤–∞—à–∞ —Ü–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è?\n' +
        '3. –ß—Ç–æ –¥–æ–ª–∂–µ–Ω –¥–µ–ª–∞—Ç—å –∏–¥–µ–∞–ª—å–Ω—ã–π —Å–∞–π—Ç –¥–ª—è –≤–∞—Å?\n' +
        '4. –ï—Å—Ç—å –ª–∏ –ø—Ä–∏–º–µ—Ä—ã —Å–∞–π—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω—Ä–∞–≤—è—Ç—Å—è?\n' +
        '5. –ö–∞–∫–æ–π –ø—Ä–∏–º–µ—Ä–Ω—ã–π –±—é–¥–∂–µ—Ç –Ω–∞ —Å–∞–π—Ç?\n\n' +
        '‚Üí –ó–∞–ø–∏—Å–∞—Ç—å –æ—Ç–≤–µ—Ç—ã –≤ –∫–∞—Ä—Ç–æ—á–∫—É –∫–ª–∏–µ–Ω—Ç–∞'
    },
    'interest': {
      title: 'üé® –ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ—Ç–æ—Ç–∏–ø–∞',
      text: '–û—Ç–ª–∏—á–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏! –ü—Ä–æ—Ç–æ—Ç–∏–ø –¥–ª—è ¬´' + name + '¬ª –≥–æ—Ç–æ–≤.\n\n' +
        '‚Üí –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –¥–µ–º–æ —á–µ—Ä–µ–∑ Telegram\n' +
        '‚Üí ¬´–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ, –∫–∞–∫ —ç—Ç–æ –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å. –ß—Ç–æ –Ω—Ä–∞–≤–∏—Ç—Å—è?¬ª\n' +
        '‚Üí ¬´–ß—Ç–æ —Ö–æ—Ç–µ–ª–∏ –±—ã –∏–∑–º–µ–Ω–∏—Ç—å –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å?¬ª\n' +
        '‚Üí –ó–∞–ø–∏—à–∏—Ç–µ –≤—Å–µ –ø—Ä–∞–≤–∫–∏ –≤ –∫–∞—Ä—Ç–æ—á–∫—É'
    },
    'proto': {
      title: 'üîß –î–æ—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ—Ç–æ—Ç–∏–ø–∞',
      text: '–ü–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –æ—Ç ¬´' + name + '¬ª:\n\n' +
        '‚Üí –í–Ω–µ—Å–∏—Ç–µ –ø—Ä–∞–≤–∫–∏ –ø–æ –∑–∞–º–µ—á–∞–Ω–∏—è–º –∫–ª–∏–µ–Ω—Ç–∞\n' +
        '‚Üí –ü–æ–∫–∞–∂–∏—Ç–µ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é\n' +
        '‚Üí ¬´–í—Å—ë –ª–∏ —É—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç? –ì–æ—Ç–æ–≤—ã –ø–µ—Ä–µ–π—Ç–∏ –∫ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏?¬ª'
    },
    'proposal': {
      title: 'üí∞ –û—Ç–ø—Ä–∞–≤–∫–∞ –ö–ü',
      text: '–î–æ–±—Ä—ã–π –¥–µ–Ω—å! –ü–æ –≤–∞—à–µ–º—É –ø—Ä–æ–µ–∫—Ç—É ¬´' + type + '¬ª –¥–ª—è ¬´' + name + '¬ª:\n\n' +
        '–°—Ç–æ–∏–º–æ—Å—Ç—å: [–¶–ï–ù–ê] ‚ÇΩ\n' +
        '–°—Ä–æ–∫–∏: 5-10 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π\n' +
        '–í–∫–ª—é—á–µ–Ω–æ: –¥–∏–∑–∞–π–Ω, –∞–¥–∞–ø—Ç–∏–≤, SEO-–æ—Å–Ω–æ–≤—ã, 2 —Ä–∞—É–Ω–¥–∞ –ø—Ä–∞–≤–æ–∫\n\n' +
        '‚Üí ¬´–ö–∞–∫ –≤–∞–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ? –ï—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã –ø–æ —Å–æ—Å—Ç–∞–≤—É —Ä–∞–±–æ—Ç?¬ª'
    },
    'negotiation': {
      title: 'ü§ù –†–∞–±–æ—Ç–∞ —Å –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è–º–∏',
      text: '¬´–î–æ—Ä–æ–≥–æ¬ª ‚Üí ¬´–î–∞–≤–∞–π—Ç–µ —Å—Ä–∞–≤–Ω–∏–º: —Ñ—Ä–∏–ª–∞–Ω—Å–µ—Ä –±–µ–∑ –≥–∞—Ä–∞–Ω—Ç–∏–π –∑–∞ X‚ÇΩ, –º—ã ‚Äî –∑–∞ Y‚ÇΩ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π, –ø—Ä–∞–≤–∫–∞–º–∏ –∏ SEO. –û–∫—É–ø–∞–µ–º–æ—Å—Ç—å —á–µ—Ä–µ–∑ 2-3 –º–µ—Å—è—Ü–∞.¬ª\n\n' +
        '¬´–ü–æ–¥—É–º–∞—é¬ª ‚Üí ¬´–ö–æ–Ω–µ—á–Ω–æ! –ß—Ç–æ –∏–º–µ–Ω–Ω–æ —Ö–æ—Ç–∏—Ç–µ –æ–±–¥—É–º–∞—Ç—å? –ú–æ–≥—É –ø–æ–º–æ—á—å —Å —Ä–∞—Å—á—ë—Ç–∞–º–∏.¬ª\n\n' +
        '¬´–°–¥–µ–ª–∞—é —Å–∞–º¬ª ‚Üí ¬´–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä—ã –æ—Ç–ª–∏—á–Ω–æ –¥–ª—è —Å—Ç–∞—Ä—Ç–∞, –Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã –≤ SEO, —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏. –î–∞–≤–∞–π—Ç–µ —Å—Ä–∞–≤–Ω–∏–º?¬ª\n\n' +
        '¬´–£ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –¥–µ—à–µ–≤–ª–µ¬ª ‚Üí ¬´–£—Ç–æ—á–Ω–∏—Ç–µ, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –≤—Ö–æ–¥–∏—Ç –≤ –∏—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ? –ß–∞—Å—Ç–æ —Ä–∞–∑–Ω–∏—Ü–∞ –≤ –æ–±—ä—ë–º–µ —Ä–∞–±–æ—Ç.¬ª'
    },
    'payment': {
      title: 'üí≥ –û–ø–ª–∞—Ç–∞ –∏ –∑–∞–ø—É—Å–∫',
      text: '–û—Ç–ª–∏—á–Ω–æ! –î–ª—è –∑–∞–ø—É—Å–∫–∞ —Ä–∞–±–æ—Ç –ø–æ ¬´' + name + '¬ª:\n\n' +
        '1. –í—ã—Å—Ç–∞–≤–ª—è—é —Å—á—ë—Ç –Ω–∞ [–°–£–ú–ú–ê] ‚ÇΩ\n' +
        '2. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã ‚Äî —Å—Ç–∞—Ä—Ç —Ä–∞–±–æ—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ 1 –¥–Ω—è\n' +
        '3. –°—Ä–æ–∫: [–°–†–û–ö] —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π\n' +
        '4. –°–≤—è–∑—å ‚Äî —á–µ—Ä–µ–∑ Telegram, –æ—Ç–≤–µ—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ 2 —á–∞—Å–æ–≤\n\n' +
        '‚Üí ¬´–†–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –æ–ø–ª–∞—Ç—ã –æ—Ç–ø—Ä–∞–≤–ª—é —Å–µ–π—á–∞—Å¬ª'
    }
  };
  return scripts[stage] || null;
}

function showSalesScript(stage, clientName, siteType) {
  var s = getSalesScript(stage, clientName, siteType);
  if (!s) { toast('–°–∫—Ä–∏–ø—Ç –¥–ª—è —ç—Ç–æ–≥–æ —ç—Ç–∞–ø–∞ –Ω–µ –∑–∞–¥–∞–Ω', 'info'); return; }
  var body = '<div style="padding:8px">';
  body += '<div style="background:var(--bg);border-radius:10px;padding:16px;white-space:pre-line;line-height:1.7;font-size:13px" id="scriptContent">' + esc(s.text).replace(/\\n/g, '\n') + '</div>';
  body += '<button class="btn btn-secondary" style="width:100%;margin-top:12px" onclick="var el=document.getElementById(\'scriptContent\');navigator.clipboard.writeText(el.innerText);toast(\'–°–∫—Ä–∏–ø—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!\',\'success\')">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–∫—Ä–∏–ø—Ç</button>';
  body += '</div>';
  showCustomModal(s.title, body);
}

// ============================================================
// FILE VALIDATION
// ============================================================
var ALLOWED_FILE_TYPES = [
  'application/pdf', 'image/jpeg', 'image/png', 'image/gif', 'image/webp',
  'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
  'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
  'text/plain', 'text/csv', 'application/zip'
];
var MAX_FILE_SIZE = 10 * 1024 * 1024; // 10 MB

// ============================================================
// DATA CACHING
// ============================================================
var DATA_CACHE = {};
var CACHE_TTL = 60000; // 60 seconds

function getCached(table) {
  var c = DATA_CACHE[table];
  if (c && Date.now() - c.time < CACHE_TTL) return c.data;
  return null;
}
function setCache(table, data) {
  DATA_CACHE[table] = { data: data, time: Date.now() };
}
function invalidateCache(table) {
  if (table) delete DATA_CACHE[table]; else DATA_CACHE = {};
}

function renderRevenueChart() {
  const dirs = (DATA.directions||[]).filter(d => d['–ü—Ä–æ–µ–∫—Ç'] === '–°–∞–π—Ç—ã' && d['–û–ø–ª–∞—á–µ–Ω–æ']);
  const weeks = {};
  dirs.forEach(d => {
    const date = d['–î–∞—Ç–∞']||d['–î–µ–¥–ª–∞–π–Ω']||today();
    const weekStart = new Date(date);
    weekStart.setDate(weekStart.getDate() - weekStart.getDay() + 1);
    const key = weekStart.toISOString().split('T')[0];
    weeks[key] = (weeks[key]||0) + (Number(d['–¶–µ–Ω–∞'])||0);
  });
  const sorted = Object.entries(weeks).sort((a,b)=>a[0].localeCompare(b[0])).slice(-8);
  if (!sorted.length) return '<div class="chart-container"><p style="text-align:center;color:var(--text3);font-size:13px">üìä –î–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ –ø–æ–∫–∞ –Ω–µ—Ç</p></div>';
  const max = Math.max(...sorted.map(([,v])=>v), 1);
  return `<div class="chart-container"><h4 style="font-size:13px;font-weight:600;margin-bottom:12px">üìà –í—ã—Ä—É—á–∫–∞ –ø–æ –Ω–µ–¥–µ–ª—è–º</h4><div class="chart-bars">${sorted.map(([w,v]) => {
    const h = Math.max(4, (v/max)*120);
    const label = w.slice(5);
    return `<div class="chart-bar-wrap"><div class="chart-bar-value">${v>=1000?(v/1000).toFixed(0)+'–∫':v}</div><div class="chart-bar" style="height:${h}px"></div><div class="chart-bar-label">${label}</div></div>`;
  }).join('')}</div></div>`;
}

</script>

<!-- MOBILE OVERLAY -->
<div class="mobile-overlay" id="mobileOverlay" onclick="closeMobileMenu()"></div>

<!-- NOTIFICATION PANEL -->
<div class="notif-panel" id="notifPanel">
  <div style="display:flex;align-items:center;justify-content:space-between;padding:20px;border-bottom:1px solid var(--border)">
    <h3 style="font-size:16px;font-weight:600">üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3>
    <div style="display:flex;gap:8px">
      <button onclick="markAllNotifRead()" style="background:none;border:none;color:var(--accent);cursor:pointer;font-size:13px">–ü—Ä–æ—á–∏—Ç–∞—Ç—å –≤—Å–µ</button>
      <button onclick="closeNotifPanel()" style="background:none;border:none;color:var(--text2);cursor:pointer;font-size:20px">‚úï</button>
    </div>
  </div>
  <div id="notifList"></div>
</div>

<!-- Loading overlay for async operations -->
<div id="loading-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:9999;
  display:none;align-items:center;justify-content:center;flex-direction:column;gap:16px">
  <div class="spinner"></div>
  <div id="loading-text" style="color:#fff;font-size:14px;font-family:var(--font)">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>

<script>
// Global loading helpers
function showLoading(text) {
  const el = document.getElementById('loading-overlay');
  if (el) { el.style.display = 'flex'; document.getElementById('loading-text').textContent = text || '–ó–∞–≥—Ä—É–∑–∫–∞...'; }
}
function hideLoading() {
  const el = document.getElementById('loading-overlay');
  if (el) el.style.display = 'none';
}
</script>
</body>
</html>
