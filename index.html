<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RKT HUB ‚Äî –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè•</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Unbounded:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
/* ===== CSS VARIABLES ===== */
:root {
  --bg: #0a0e17;
  --bg2: #111827;
  --bg3: #1a2234;
  --bg4: #1f2b3d;
  --accent: #00d4aa;
  --accent2: #00b894;
  --accent-glow: rgba(0, 212, 170, 0.15);
  --red: #ff6b6b;
  --red-glow: rgba(255, 107, 107, 0.15);
  --orange: #ffa94d;
  --orange-glow: rgba(255, 169, 77, 0.15);
  --yellow: #ffd43b;
  --blue: #4dabf7;
  --blue-glow: rgba(75, 171, 247, 0.15);
  --purple: #b197fc;
  --purple-glow: rgba(177, 151, 252, 0.15);
  --green: #51cf66;
  --pink: #f06595;
  --text: #e8ecf1;
  --text2: #8899aa;
  --text3: #5a6a7a;
  --border: #243044;
  --border2: #2d3f56;
  --glass: rgba(17, 24, 39, 0.85);
  --radius: 12px;
  --radius-sm: 8px;
  --radius-lg: 16px;
  --shadow: 0 4px 30px rgba(0, 0, 0, 0.4);
  --shadow-lg: 0 20px 60px rgba(0, 0, 0, 0.5);
  --transition: all 0.2s ease;
  --sidebar-w: 260px;
}

/* ===== RESET ===== */
*, *::before, *::after {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  font-family: 'JetBrains Mono', monospace;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
  line-height: 1.5;
}

/* Background gradient */
body::before {
  content: '';
  position: fixed;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background:
    radial-gradient(ellipse at 20% 50%, rgba(0, 212, 170, 0.06) 0%, transparent 50%),
    radial-gradient(ellipse at 80% 20%, rgba(75, 171, 247, 0.04) 0%, transparent 50%),
    radial-gradient(ellipse at 50% 80%, rgba(177, 151, 252, 0.03) 0%, transparent 50%);
  z-index: 0;
  pointer-events: none;
}

a {
  color: var(--accent);
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

/* ===== SCROLLBAR ===== */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--text2); }

/* ============================================================
   LOGIN SCREEN
   ============================================================ */
.login-screen {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  background: var(--bg);
}

.login-card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 24px;
  padding: 52px 44px;
  width: 440px;
  max-width: 92vw;
  text-align: center;
  box-shadow: var(--shadow-lg);
  position: relative;
  overflow: hidden;
  animation: loginFadeIn 0.5s ease;
}

@keyframes loginFadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.login-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--accent), var(--blue), var(--purple), var(--accent));
  background-size: 300% 100%;
  animation: gradientShift 4s ease infinite;
}

@keyframes gradientShift {
  0%, 100% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
}

.login-icon {
  font-size: 72px;
  margin-bottom: 20px;
  display: block;
  filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
}

.login-logo {
  font-family: 'Unbounded', sans-serif;
  font-size: 36px;
  font-weight: 900;
  background: linear-gradient(135deg, var(--accent), var(--blue));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  margin-bottom: 6px;
}

.login-sub {
  color: var(--text2);
  font-size: 13px;
  margin-bottom: 36px;
}

.login-label {
  display: block;
  text-align: left;
  font-size: 11px;
  color: var(--text2);
  text-transform: uppercase;
  letter-spacing: 2px;
  margin-bottom: 10px;
  font-weight: 600;
}

.login-input {
  width: 100%;
  padding: 16px 20px;
  background: var(--bg);
  border: 2px solid var(--border);
  border-radius: var(--radius);
  color: var(--text);
  font-family: 'JetBrains Mono', monospace;
  font-size: 18px;
  text-align: center;
  letter-spacing: 3px;
  transition: var(--transition);
  margin-bottom: 10px;
}

.login-input:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 4px var(--accent-glow);
}

.login-input::placeholder {
  color: var(--text3);
  font-size: 13px;
  letter-spacing: 0;
}

.login-hint {
  font-size: 11px;
  color: var(--text2);
  margin-bottom: 28px;
  line-height: 1.8;
}

.login-hint a {
  color: var(--accent);
  font-weight: 600;
}

.login-btn {
  width: 100%;
  padding: 16px;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  color: var(--bg);
  border: none;
  border-radius: var(--radius);
  font-family: 'JetBrains Mono', monospace;
  font-size: 15px;
  font-weight: 700;
  cursor: pointer;
  transition: var(--transition);
  letter-spacing: 1.5px;
  text-transform: uppercase;
}

.login-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(0, 212, 170, 0.3);
}

.login-btn:active {
  transform: translateY(0);
}

.login-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

.login-error {
  color: var(--red);
  font-size: 13px;
  margin-top: 16px;
  display: none;
  padding: 10px;
  background: var(--red-glow);
  border-radius: var(--radius-sm);
}

.login-loading {
  margin-top: 16px;
  color: var(--text2);
  font-size: 13px;
  display: none;
}

/* ============================================================
   APP LAYOUT
   ============================================================ */
.app {
  position: relative;
  z-index: 1;
  display: flex;
  min-height: 100vh;
}

/* ===== SIDEBAR ===== */
.sidebar {
  width: var(--sidebar-w);
  background: var(--bg2);
  border-right: 1px solid var(--border);
  padding: 0;
  display: flex;
  flex-direction: column;
  position: fixed;
  top: 0; left: 0; bottom: 0;
  z-index: 100;
  transition: transform 0.3s ease;
  overflow-y: auto;
}

.logo-section {
  padding: 28px 24px 20px;
  border-bottom: 1px solid var(--border);
}

.logo-section h1 {
  font-family: 'Unbounded', sans-serif;
  font-size: 22px;
  font-weight: 900;
  background: linear-gradient(135deg, var(--accent), var(--blue));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.logo-section .subtitle {
  font-size: 11px;
  color: var(--text2);
  margin-top: 4px;
}

.nav {
  flex: 1;
  padding: 12px;
}

.nav-section {
  font-size: 10px;
  color: var(--text3);
  text-transform: uppercase;
  letter-spacing: 2.5px;
  padding: 20px 12px 8px;
  font-weight: 600;
}

.nav-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 11px 14px;
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: var(--transition);
  font-size: 13px;
  color: var(--text2);
  text-decoration: none;
  margin-bottom: 2px;
  position: relative;
}

.nav-item:hover {
  background: var(--bg3);
  color: var(--text);
  text-decoration: none;
}

.nav-item.active {
  background: var(--accent-glow);
  color: var(--accent);
}

.nav-item.active::before {
  content: '';
  position: absolute;
  left: 0;
  top: 25%;
  bottom: 25%;
  width: 3px;
  background: var(--accent);
  border-radius: 0 3px 3px 0;
}

.nav-item .icon {
  font-size: 18px;
  width: 26px;
  text-align: center;
  flex-shrink: 0;
}

.nav-item .label {
  flex: 1;
}

.nav-item .badge {
  background: var(--accent);
  color: var(--bg);
  font-size: 10px;
  font-weight: 700;
  padding: 2px 8px;
  border-radius: 12px;
  min-width: 22px;
  text-align: center;
}

.nav-item .badge-orange {
  background: var(--orange);
}

.nav-item.hidden {
  display: none;
}

/* User bar */
.user-bar {
  padding: 16px 20px;
  border-top: 1px solid var(--border);
  background: var(--bg3);
}

.user-info {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 10px;
}

.user-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--accent), var(--blue));
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  font-weight: 700;
  color: var(--bg);
  flex-shrink: 0;
}

.user-name {
  font-size: 13px;
  font-weight: 600;
  line-height: 1.3;
}

.user-role-text {
  font-size: 11px;
  color: var(--text2);
}

.logout-btn {
  width: 100%;
  padding: 9px;
  background: transparent;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text2);
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}

.logout-btn:hover {
  border-color: var(--red);
  color: var(--red);
  background: var(--red-glow);
}

/* ===== MAIN ===== */
.main {
  flex: 1;
  margin-left: var(--sidebar-w);
  padding: 32px 36px 60px;
  max-width: 1300px;
  min-height: 100vh;
}

/* ===== PAGE HEADER ===== */
.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 28px;
  flex-wrap: wrap;
  gap: 12px;
}

.page-header h2 {
  font-family: 'Unbounded', sans-serif;
  font-size: 26px;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 12px;
}

.page-header .actions {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

/* ===== BREADCRUMB ===== */
.breadcrumb {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 18px;
  font-size: 12px;
  color: var(--text2);
}

.breadcrumb a {
  cursor: pointer;
  color: var(--text2);
  transition: var(--transition);
}

.breadcrumb a:hover {
  color: var(--accent);
  text-decoration: none;
}

.breadcrumb .sep {
  color: var(--text3);
}

.breadcrumb .current {
  color: var(--text);
  font-weight: 600;
}

/* ===== BUTTONS ===== */
.btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 20px;
  border-radius: var(--radius-sm);
  border: none;
  cursor: pointer;
  font-family: 'JetBrains Mono', monospace;
  font-size: 13px;
  font-weight: 600;
  transition: var(--transition);
  white-space: nowrap;
}

.btn-primary {
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  color: var(--bg);
}

.btn-primary:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 15px rgba(0, 212, 170, 0.3);
}

.btn-secondary {
  background: var(--bg3);
  color: var(--text);
  border: 1px solid var(--border);
}

.btn-secondary:hover {
  border-color: var(--accent);
  color: var(--accent);
}

.btn-danger {
  background: var(--red-glow);
  color: var(--red);
  border: 1px solid rgba(255, 107, 107, 0.3);
}

.btn-danger:hover {
  background: rgba(255, 107, 107, 0.25);
}

.btn-sm { padding: 6px 14px; font-size: 11px; }
.btn-xs { padding: 4px 10px; font-size: 10px; }

.btn-approve {
  background: var(--accent-glow);
  color: var(--accent);
  border: 1px solid rgba(0, 212, 170, 0.3);
}

.btn-reject {
  background: var(--red-glow);
  color: var(--red);
  border: 1px solid rgba(255, 107, 107, 0.3);
}

/* ============================================================
   PROJECT GRID (HOME SCREEN)
   ============================================================ */
.project-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
  gap: 20px;
  margin-bottom: 28px;
}

.project-card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 0;
  overflow: hidden;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
}

.project-card:hover {
  border-color: var(--accent);
  transform: translateY(-4px);
  box-shadow: 0 12px 40px rgba(0, 212, 170, 0.15);
}

.project-card-top {
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 4px;
}

.project-card.ct .project-card-top { background: linear-gradient(90deg, #00d4aa, #00b894); }
.project-card.xray .project-card-top { background: linear-gradient(90deg, #4dabf7, #228be6); }
.project-card.robots .project-card-top { background: linear-gradient(90deg, #b197fc, #7950f2); }
.project-card.urology .project-card-top { background: linear-gradient(90deg, #ffa94d, #fd7e14); }
.project-card.pacs .project-card-top { background: linear-gradient(90deg, #f06595, #d6336c); }
.project-card.uzi .project-card-top { background: linear-gradient(90deg, #51cf66, #37b24d); }
.project-card.general .project-card-top { background: linear-gradient(90deg, #8899aa, #5a6a7a); }

.project-card-header {
  padding: 26px 26px 16px;
  position: relative;
}

.project-card-header .emoji {
  font-size: 48px;
  margin-bottom: 12px;
  display: block;
  filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
}

.project-card-header h3 {
  font-family: 'Unbounded', sans-serif;
  font-size: 20px;
  font-weight: 700;
  margin-bottom: 4px;
}

.project-card-header .desc {
  font-size: 12px;
  color: var(--text2);
  line-height: 1.6;
}

.project-card-stats {
  padding: 0 26px 10px;
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 10px;
}

.pcs {
  text-align: center;
  padding: 10px 0;
}

.pcs .v {
  font-family: 'Unbounded', sans-serif;
  font-size: 22px;
  font-weight: 800;
}

.pcs .l {
  font-size: 10px;
  color: var(--text2);
  margin-top: 2px;
}

.project-card-progress {
  padding: 0 26px 22px;
}

.project-card-progress .bar {
  height: 6px;
  background: var(--bg);
  border-radius: 3px;
  overflow: hidden;
}

.project-card-progress .fill {
  height: 100%;
  border-radius: 3px;
  transition: width 0.6s ease;
}

.project-card-progress .info {
  display: flex;
  justify-content: space-between;
  margin-top: 6px;
  font-size: 11px;
  color: var(--text2);
}

.status-tag {
  position: absolute;
  top: 16px;
  right: 16px;
  font-size: 10px;
  padding: 4px 10px;
  border-radius: 12px;
  font-weight: 600;
}

/* ===== METRICS CARDS ===== */
.metrics {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 16px;
  margin-bottom: 28px;
}

.metric-card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 22px;
  position: relative;
  overflow: hidden;
  transition: var(--transition);
}

.metric-card:hover {
  border-color: var(--border2);
  transform: translateY(-2px);
  box-shadow: var(--shadow);
}

.metric-card::after {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 3px;
}

.metric-card:nth-child(1)::after { background: linear-gradient(90deg, var(--accent), var(--accent2)); }
.metric-card:nth-child(2)::after { background: linear-gradient(90deg, var(--blue), #228be6); }
.metric-card:nth-child(3)::after { background: linear-gradient(90deg, var(--orange), #fd7e14); }
.metric-card:nth-child(4)::after { background: linear-gradient(90deg, var(--purple), #7950f2); }
.metric-card:nth-child(5)::after { background: linear-gradient(90deg, var(--yellow), #fab005); }

.metric-card .m-icon { font-size: 30px; margin-bottom: 10px; }

.metric-card .m-value {
  font-family: 'Unbounded', sans-serif;
  font-size: 32px;
  font-weight: 900;
  line-height: 1;
}

.metric-card .m-label {
  font-size: 12px;
  color: var(--text2);
  margin-top: 6px;
}

.metric-card .m-sub {
  font-size: 10px;
  color: var(--text3);
  margin-top: 4px;
}

/* ===== CARDS ===== */
.card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  margin-bottom: 24px;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 22px;
  border-bottom: 1px solid var(--border);
  background: rgba(26, 34, 52, 0.5);
}

.card-header h3 {
  font-size: 15px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}

/* ===== TABLE ===== */
.table-wrap { overflow-x: auto; }

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

thead th {
  text-align: left;
  padding: 12px 18px;
  color: var(--text2);
  font-weight: 600;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 1.2px;
  border-bottom: 1px solid var(--border);
  background: var(--bg3);
  white-space: nowrap;
  position: sticky;
  top: 0;
  z-index: 2;
}

tbody td {
  padding: 13px 18px;
  border-bottom: 1px solid rgba(36, 48, 68, 0.4);
  vertical-align: middle;
}

tbody tr {
  transition: background 0.15s;
}

tbody tr:hover td {
  background: rgba(0, 212, 170, 0.03);
}

tbody tr:last-child td {
  border-bottom: none;
}

/* ===== STATUS BADGES ===== */
.status {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 600;
  white-space: nowrap;
}

.s-active { background: var(--accent-glow); color: var(--accent); }
.s-talks { background: var(--orange-glow); color: var(--orange); }
.s-research { background: var(--blue-glow); color: var(--blue); }
.s-pause { background: rgba(136, 153, 170, 0.15); color: var(--text2); }
.s-urgent { background: var(--red-glow); color: var(--red); }
.s-work { background: var(--purple-glow); color: var(--purple); }
.s-done { background: rgba(81, 207, 102, 0.15); color: var(--green); }

/* ===== PRIORITY ===== */
.p1 { color: var(--red); font-weight: 700; }
.p2 { color: var(--orange); font-weight: 600; }
.p3 { color: var(--text2); }

/* ===== PROGRESS BAR ===== */
.progress-wrap { display: flex; align-items: center; gap: 10px; }

.progress-bar {
  width: 90px;
  height: 7px;
  background: var(--bg);
  border-radius: 4px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  border-radius: 4px;
  background: linear-gradient(90deg, var(--accent), var(--accent2));
  transition: width 0.5s ease;
}

.progress-text {
  font-size: 11px;
  color: var(--text2);
  font-weight: 600;
  min-width: 30px;
}

/* ===== ACTION BUTTONS ===== */
.actions-cell { display: flex; gap: 5px; }

.act-btn {
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 6px;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text2);
  cursor: pointer;
  font-size: 14px;
  transition: var(--transition);
}

.act-btn:hover {
  border-color: var(--accent);
  color: var(--accent);
  background: var(--accent-glow);
}

.act-btn.del:hover {
  border-color: var(--red);
  color: var(--red);
  background: var(--red-glow);
}

.act-btn.view:hover {
  border-color: var(--blue);
  color: var(--blue);
  background: var(--blue-glow);
}

/* ===== FILTERS ===== */
.filters-bar {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-bottom: 18px;
  align-items: center;
}

.filter-chip {
  padding: 7px 16px;
  border-radius: 20px;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text2);
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px;
  cursor: pointer;
  transition: var(--transition);
}

.filter-chip:hover {
  border-color: var(--accent);
  color: var(--text);
}

.filter-chip.active {
  background: var(--accent-glow);
  border-color: var(--accent);
  color: var(--accent);
  font-weight: 600;
}

.search-input {
  padding: 8px 16px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 20px;
  color: var(--text);
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px;
  width: 220px;
  transition: var(--transition);
}

.search-input:focus {
  outline: none;
  border-color: var(--accent);
  width: 280px;
}

.search-input::placeholder { color: var(--text3); }

/* ===== TABS ===== */
.tabs {
  display: flex;
  gap: 4px;
  border-bottom: 1px solid var(--border);
  margin-bottom: 20px;
  overflow-x: auto;
}

.tab {
  padding: 10px 18px;
  font-size: 12px;
  color: var(--text2);
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: var(--transition);
  white-space: nowrap;
  font-family: 'JetBrains Mono', monospace;
}

.tab:hover { color: var(--text); }

.tab.active {
  color: var(--accent);
  border-bottom-color: var(--accent);
  font-weight: 600;
}

/* ===== MODAL ===== */
.modal-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.75);
  backdrop-filter: blur(6px);
  z-index: 1000;
  justify-content: center;
  align-items: center;
  animation: fadeIn 0.2s ease;
}

.modal-overlay.show { display: flex; }

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

.modal {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  width: 560px;
  max-width: 92vw;
  max-height: 88vh;
  overflow-y: auto;
  box-shadow: var(--shadow-lg);
  animation: slideUp 0.25s ease;
}

@keyframes slideUp {
  from { opacity: 0; transform: translateY(30px); }
  to { opacity: 1; transform: translateY(0); }
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 22px 28px;
  border-bottom: 1px solid var(--border);
  background: rgba(26, 34, 52, 0.5);
}

.modal-header h3 {
  font-family: 'Unbounded', sans-serif;
  font-size: 17px;
  font-weight: 700;
}

.modal-close {
  width: 34px;
  height: 34px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text2);
  cursor: pointer;
  font-size: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: var(--transition);
}

.modal-close:hover {
  color: var(--red);
  border-color: var(--red);
  background: var(--red-glow);
}

.modal-body { padding: 28px; }

.form-group { margin-bottom: 18px; }

.form-group label {
  display: block;
  font-size: 11px;
  color: var(--text2);
  margin-bottom: 7px;
  text-transform: uppercase;
  letter-spacing: 1.2px;
  font-weight: 600;
}

.form-group .required::after {
  content: ' *';
  color: var(--red);
}

.form-group input,
.form-group select,
.form-group textarea {
  width: 100%;
  padding: 11px 16px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text);
  font-family: 'JetBrains Mono', monospace;
  font-size: 13px;
  transition: var(--transition);
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-glow);
}

.form-group textarea { min-height: 90px; resize: vertical; }
.form-group select { cursor: pointer; }
.form-group select option { background: var(--bg2); color: var(--text); }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }

.modal-footer {
  padding: 18px 28px;
  border-top: 1px solid var(--border);
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  background: rgba(26, 34, 52, 0.3);
}

/* ===== DETAIL VIEW ===== */
.detail-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}

.detail-item {
  padding: 12px;
  background: var(--bg);
  border-radius: var(--radius-sm);
}

.detail-label {
  font-size: 10px;
  color: var(--text3);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 4px;
}

.detail-value {
  font-size: 13px;
  color: var(--text);
  word-break: break-word;
}

.detail-full {
  grid-column: 1 / -1;
}

/* ===== CONFIRM DIALOG ===== */
.confirm-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  z-index: 1100;
  justify-content: center;
  align-items: center;
}

.confirm-overlay.show { display: flex; }

.confirm-box {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 32px;
  width: 400px;
  max-width: 90vw;
  text-align: center;
  box-shadow: var(--shadow-lg);
}

.confirm-box .icon { font-size: 40px; margin-bottom: 16px; }
.confirm-box h4 { font-size: 16px; margin-bottom: 8px; }
.confirm-box p { color: var(--text2); font-size: 13px; margin-bottom: 24px; }
.confirm-actions { display: flex; gap: 10px; justify-content: center; }

/* ===== TOAST ===== */
.toast {
  position: fixed;
  bottom: 28px;
  right: 28px;
  padding: 14px 24px;
  border-radius: var(--radius-sm);
  font-size: 13px;
  font-weight: 600;
  transform: translateY(100px);
  opacity: 0;
  transition: all 0.35s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  z-index: 2000;
  max-width: 400px;
  box-shadow: var(--shadow);
}

.toast.show { transform: translateY(0); opacity: 1; }
.toast-success { background: var(--accent); color: var(--bg); }
.toast-error { background: var(--red); color: #fff; }
.toast-warning { background: var(--orange); color: var(--bg); }
.toast-info { background: var(--blue); color: var(--bg); }

/* ===== PAGES ===== */
.page { display: none; }
.page.active { display: block; animation: pageIn 0.3s ease; }

@keyframes pageIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ===== EMPTY STATE ===== */
.empty {
  text-align: center;
  padding: 50px;
  color: var(--text2);
}

.empty .icon { font-size: 44px; margin-bottom: 14px; opacity: 0.6; }
.empty p { font-size: 14px; }

/* ===== STATUS BAR ===== */
.status-bar {
  position: fixed;
  bottom: 0; left: 0; right: 0;
  background: var(--bg2);
  border-top: 1px solid var(--border);
  padding: 6px 24px;
  display: flex;
  justify-content: space-between;
  font-size: 11px;
  color: var(--text3);
  z-index: 50;
}

.status-bar .dot {
  display: inline-block;
  width: 7px;
  height: 7px;
  border-radius: 50%;
  margin-right: 6px;
}

.dot-green { background: var(--accent); }
.dot-red { background: var(--red); }

/* ===== MOBILE ===== */
.mobile-toggle { display: none; }

@media (max-width: 900px) {
  .sidebar {
    transform: translateX(-100%);
    width: 280px;
  }

  .sidebar.open {
    transform: translateX(0);
    box-shadow: var(--shadow-lg);
  }

  .main {
    margin-left: 0;
    padding: 20px 16px 60px;
  }

  .metrics {
    grid-template-columns: repeat(2, 1fr);
  }

  .project-grid {
    grid-template-columns: 1fr;
  }

  .form-row,
  .detail-grid {
    grid-template-columns: 1fr;
  }

  .page-header h2 {
    font-size: 20px;
  }

  .mobile-toggle {
    display: flex !important;
    position: fixed;
    top: 14px;
    left: 14px;
    z-index: 200;
    width: 44px;
    height: 44px;
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: var(--text);
    font-size: 22px;
    box-shadow: var(--shadow);
  }
}
</style>
</head>
<body>

<!-- ============================================================
     LOGIN SCREEN
     ============================================================ -->
<div class="login-screen" id="loginScreen">
  <div class="login-card">
    <span class="login-icon">üè•</span>
    <div class="login-logo">RKT HUB</div>
    <div class="login-sub">–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–º–∏ –ø—Ä–æ–µ–∫—Ç–∞–º–∏</div>

    <label class="login-label">–í–∞—à Telegram ID</label>
    <input class="login-input" id="loginTgId" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 1144907578" autofocus>
    <div class="login-hint">
      –£–∑–Ω–∞–π—Ç–µ —Å–≤–æ–π ID: –Ω–∞–ø–∏—à–∏—Ç–µ <a href="https://t.me/userinfobot" target="_blank">@userinfobot</a> –≤ Telegram
    </div>

    <button class="login-btn" id="loginBtn" onclick="doLogin()">
      <span id="loginBtnText">–í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</span>
    </button>

    <div class="login-error" id="loginError"></div>
    <div class="login-loading" id="loginLoading">‚è≥ –ü–æ–¥–∫–ª—é—á–∞—é—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É...</div>
  </div>
</div>

<!-- Mobile hamburger -->
<button class="mobile-toggle" id="mobileToggle" onclick="toggleSidebar()">‚ò∞</button>

<!-- ============================================================
     MAIN APP
     ============================================================ -->
<div class="app" id="mainApp" style="display:none">

  <!-- ===== SIDEBAR ===== -->
  <aside class="sidebar" id="sidebar">
    <div class="logo-section">
      <h1>RKT HUB</h1>
      <div class="subtitle">v2.1 ‚Ä¢ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞–º–∏</div>
    </div>

    <nav class="nav">
      <div class="nav-section">–ì–ª–∞–≤–Ω–æ–µ</div>
      <a class="nav-item active" onclick="showPage('home')" data-page="home">
        <span class="icon">üè†</span>
        <span class="label">–ü—Ä–æ–µ–∫—Ç—ã</span>
      </a>
      <a class="nav-item" onclick="showPage('dashboard')" data-page="dashboard">
        <span class="icon">üìä</span>
        <span class="label">–î–∞—à–±–æ—Ä–¥</span>
      </a>

      <div class="nav-section">–î–∞–Ω–Ω—ã–µ</div>
      <a class="nav-item" onclick="showPage('partners')" data-page="partners">
        <span class="icon">ü§ù</span>
        <span class="label">–ü–∞—Ä—Ç–Ω—ë—Ä—ã</span>
        <span class="badge" id="badge-partners">0</span>
      </a>
      <a class="nav-item" onclick="showPage('tasks')" data-page="tasks">
        <span class="icon">‚úÖ</span>
        <span class="label">–ó–∞–¥–∞—á–∏</span>
        <span class="badge" id="badge-tasks">0</span>
      </a>

      <div class="nav-section">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>
      <a class="nav-item" onclick="showPage('staff')" data-page="staff" id="nav-staff">
        <span class="icon">üë•</span>
        <span class="label">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</span>
      </a>
      <a class="nav-item" onclick="showPage('approvals')" data-page="approvals" id="nav-approvals">
        <span class="icon">üìã</span>
        <span class="label">–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è</span>
        <span class="badge badge-orange" id="badge-approvals">0</span>
      </a>
      <a class="nav-item" onclick="showPage('comms')" data-page="comms">
        <span class="icon">üí¨</span>
        <span class="label">–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏</span>
      </a>

      <div class="nav-section">–°–∏—Å—Ç–µ–º–∞</div>
      <a class="nav-item" onclick="showPage('settings')" data-page="settings">
        <span class="icon">‚öôÔ∏è</span>
        <span class="label">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
      </a>
    </nav>

    <!-- USER BAR -->
    <div class="user-bar" id="userBar">
      <div class="user-info">
        <div class="user-avatar" id="userAvatar">?</div>
        <div>
          <div class="user-name" id="userName">‚Äî</div>
          <div class="user-role-text" id="userRoleText">‚Äî</div>
        </div>
      </div>
      <button class="logout-btn" onclick="doLogout()">üö™ –í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã</button>
    </div>
  </aside>

  <!-- ===== MAIN CONTENT ===== -->
  <main class="main">

    <!-- ================ HOME: PROJECT SELECTION ================ -->
    <div class="page active" id="page-home">
      <div class="page-header">
        <h2>üè† –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç</h2>
        <div class="actions">
          <button class="btn btn-secondary" onclick="loadData()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
        </div>
      </div>

      <!-- Total metrics -->
      <div class="metrics" id="home-metrics"></div>

      <!-- Project cards grid -->
      <div class="project-grid" id="project-grid"></div>
    </div>

    <!-- ================ PROJECT WORKSPACE ================ -->
    <div class="page" id="page-project">
      <div class="breadcrumb">
        <a onclick="showPage('home')">üè† –ü—Ä–æ–µ–∫—Ç—ã</a>
        <span class="sep">‚Ä∫</span>
        <span class="current" id="pw-name">‚Äî</span>
      </div>

      <div class="page-header">
        <h2 id="pw-title">üìÅ –ü—Ä–æ–µ–∫—Ç</h2>
        <div class="actions">
          <button class="btn btn-primary" onclick="openModal('task')">+ –ó–∞–¥–∞—á–∞</button>
          <button class="btn btn-primary" onclick="openModal('partner')">+ –ü–∞—Ä—Ç–Ω—ë—Ä</button>
          <button class="btn btn-primary" onclick="openModal('comm')">+ –ö–æ–Ω—Ç–∞–∫—Ç</button>
          <button class="btn btn-secondary" onclick="openModal('project')">+ –ü—Ä–æ–µ–∫—Ç</button>
        </div>
      </div>

      <!-- Project metrics -->
      <div class="metrics" id="pw-metrics"></div>

      <!-- Tabs -->
      <div class="tabs" id="pw-tabs">
        <div class="tab active" data-tab="overview" onclick="showPwTab('overview')">üìä –û–±–∑–æ—Ä</div>
        <div class="tab" data-tab="partners" onclick="showPwTab('partners')">ü§ù –ü–∞—Ä—Ç–Ω—ë—Ä—ã</div>
        <div class="tab" data-tab="projects" onclick="showPwTab('projects')">üìÅ –ü—Ä–æ–µ–∫—Ç—ã</div>
        <div class="tab" data-tab="tasks" onclick="showPwTab('tasks')">‚úÖ –ó–∞–¥–∞—á–∏</div>
        <div class="tab" data-tab="comms" onclick="showPwTab('comms')">üí¨ –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏</div>
      </div>

      <!-- Tab content -->
      <div id="pw-content"></div>
    </div>

    <!-- ================ DASHBOARD ================ -->
    <div class="page" id="page-dashboard">
      <div class="page-header">
        <h2>üìä –û–±—â–∏–π –¥–∞—à–±–æ—Ä–¥</h2>
        <div class="actions">
          <button class="btn btn-secondary" onclick="loadData()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
      </div>

      <div class="metrics" id="dash-metrics"></div>

      <!-- Urgent Tasks -->
      <div class="card">
        <div class="card-header">
          <h3>üî¥ –°—Ä–æ—á–Ω—ã–µ –∑–∞–¥–∞—á–∏ (P1)</h3>
          <button class="btn btn-sm btn-secondary" onclick="showPage('tasks')">–í—Å–µ –∑–∞–¥–∞—á–∏ ‚Üí</button>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>–ó–∞–¥–∞—á–∞</th><th>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</th><th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–µ–¥–ª–∞–π–Ω</th></tr></thead>
            <tbody id="urgent-tasks"></tbody>
          </table>
        </div>
      </div>

      <!-- Active Projects -->
      <div class="card">
        <div class="card-header">
          <h3>üìÅ –ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã</h3>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>–ü—Ä–æ–µ–∫—Ç</th><th>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ü—Ä–æ–≥—Ä–µ—Å—Å</th><th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th><th>–î–µ–¥–ª–∞–π–Ω</th></tr></thead>
            <tbody id="active-projects"></tbody>
          </table>
        </div>
      </div>

      <!-- Recent Communications -->
      <div class="card">
        <div class="card-header">
          <h3>üí¨ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏</h3>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>–ü–∞—Ä—Ç–Ω—ë—Ä</th><th>–¢–∏–ø</th><th>–¢–µ–º–∞</th><th>–î–∞—Ç–∞</th><th>–ê–≤—Ç–æ—Ä</th></tr></thead>
            <tbody id="recent-comms"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ================ PARTNERS ================ -->
    <div class="page" id="page-partners">
      <div class="page-header">
        <h2>ü§ù –í—Å–µ –ø–∞—Ä—Ç–Ω—ë—Ä—ã</h2>
        <div class="actions">
          <button class="btn btn-primary" id="btn-add-partner" onclick="openModal('partner')">+ –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä—Ç–Ω—ë—Ä–∞</button>
          <button class="btn btn-secondary" onclick="exportCSV('partners')">üì• –≠–∫—Å–ø–æ—Ä—Ç CSV</button>
        </div>
      </div>

      <div class="filters-bar">
        <div id="partner-filters"></div>
        <input class="search-input" id="partner-search" placeholder="üîç –ü–æ–∏—Å–∫..." oninput="renderPartners()">
      </div>

      <div class="card">
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th>–°—Ç—Ä–∞–Ω–∞</th>
                <th>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</th>
                <th>–ü—Ä–æ–¥—É–∫—Ç</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–ö–æ–Ω—Ç–∞–∫—Ç</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="partners-table"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ================ TASKS ================ -->
    <div class="page" id="page-tasks">
      <div class="page-header">
        <h2>‚úÖ –í—Å–µ –∑–∞–¥–∞—á–∏</h2>
        <div class="actions">
          <button class="btn btn-primary" onclick="openModal('task')">+ –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</button>
          <button class="btn btn-secondary" onclick="exportCSV('tasks')">üì• –≠–∫—Å–ø–æ—Ä—Ç CSV</button>
        </div>
      </div>

      <div class="filters-bar">
        <div id="task-filters"></div>
        <input class="search-input" id="task-search" placeholder="üîç –ü–æ–∏—Å–∫..." oninput="renderTasks()">
      </div>

      <div class="card">
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                <th>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</th>
                <th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th>
                <th>–î–µ–¥–ª–∞–π–Ω</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="tasks-table"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ================ STAFF ================ -->
    <div class="page" id="page-staff">
      <div class="page-header">
        <h2>üë• –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</h2>
        <div class="actions">
          <button class="btn btn-primary" id="btn-add-staff" onclick="openModal('staff')">+ –î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</button>
        </div>
      </div>

      <div class="card">
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>–ò–º—è</th>
                <th>–†–æ–ª—å</th>
                <th>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</th>
                <th>Telegram</th>
                <th>Email</th>
                <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="staff-table"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ================ APPROVALS ================ -->
    <div class="page" id="page-approvals">
      <div class="page-header">
        <h2>üìã –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è</h2>
      </div>
      <div id="approvals-content"></div>
    </div>

    <!-- ================ COMMUNICATIONS ================ -->
    <div class="page" id="page-comms">
      <div class="page-header">
        <h2>üí¨ –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏</h2>
        <div class="actions">
          <button class="btn btn-primary" onclick="openModal('comm')">+ –ó–∞–ø–∏—Å–∞—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç</button>
        </div>
      </div>

      <div class="filters-bar">
        <input class="search-input" id="comm-search" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –ø–∞—Ä—Ç–Ω—ë—Ä—É..." oninput="renderComms()">
      </div>

      <div class="card">
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>–ü–∞—Ä—Ç–Ω—ë—Ä</th>
                <th>–¢–∏–ø</th>
                <th>–¢–µ–º–∞</th>
                <th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
                <th>–î–∞—Ç–∞</th>
                <th>–ê–≤—Ç–æ—Ä</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="comms-table"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ================ SETTINGS ================ -->
    <div class="page" id="page-settings">
      <div class="page-header">
        <h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã</h2>
      </div>

      <div class="card" style="padding: 28px;">
        <h3 style="margin-bottom: 20px; font-size: 15px;">üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h3>
        <div class="form-group">
          <label>API Endpoint (n8n Webhook)</label>
          <input type="text" id="settingsApiUrl" readonly style="opacity: 0.7">
        </div>
        <div class="form-group">
          <label>Google Sheet ID</label>
          <input type="text" value="12BniI4H5inrEDJKWNrSxL480acGSGJlSIFvCqYfd9KY" readonly style="opacity: 0.7">
        </div>
        <div class="form-group">
          <label>Telegram Bot</label>
          <input type="text" value="RKT HUB Bot (@RKT_HUB_bot)" readonly style="opacity: 0.7">
        </div>
      </div>

      <div class="card" style="padding: 28px; margin-top: 16px;">
        <h3 style="margin-bottom: 20px; font-size: 15px;">üë§ –í–∞—à –ø—Ä–æ—Ñ–∏–ª—å</h3>
        <div class="detail-grid">
          <div class="detail-item"><div class="detail-label">–ò–º—è</div><div class="detail-value" id="s-name">‚Äî</div></div>
          <div class="detail-item"><div class="detail-label">–†–æ–ª—å</div><div class="detail-value" id="s-role">‚Äî</div></div>
          <div class="detail-item"><div class="detail-label">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div><div class="detail-value" id="s-dir">‚Äî</div></div>
          <div class="detail-item"><div class="detail-label">Telegram ID</div><div class="detail-value" id="s-tgid">‚Äî</div></div>
        </div>
      </div>

      <div class="card" style="padding: 28px; margin-top: 16px;">
        <h3 style="margin-bottom: 20px; font-size: 15px;">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–∞–∑—ã</h3>
        <div class="detail-grid" id="s-stats"></div>
      </div>
    </div>

  </main>
</div>

<!-- ============================================================
     MODAL
     ============================================================ -->
<div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this)closeModal()">
  <div class="modal">
    <div class="modal-header">
      <h3 id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å</h3>
      <button class="modal-close" onclick="closeModal()">‚úï</button>
    </div>
    <div class="modal-body" id="modalBody"></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary" id="modalSaveBtn" onclick="saveModal()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- ============================================================
     DETAIL MODAL
     ============================================================ -->
<div class="modal-overlay" id="detailOverlay" onclick="if(event.target===this)closeDetail()">
  <div class="modal" style="width: 620px;">
    <div class="modal-header">
      <h3 id="detailTitle">–î–µ—Ç–∞–ª–∏</h3>
      <button class="modal-close" onclick="closeDetail()">‚úï</button>
    </div>
    <div class="modal-body" id="detailBody"></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeDetail()">–ó–∞–∫—Ä—ã—Ç—å</button>
      <button class="btn btn-primary" id="detailEditBtn" onclick="">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>
  </div>
</div>

<!-- ============================================================
     CONFIRM DIALOG
     ============================================================ -->
<div class="confirm-overlay" id="confirmOverlay">
  <div class="confirm-box">
    <div class="icon">‚ö†Ô∏è</div>
    <h4 id="confirmTitle">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h4>
    <p id="confirmText">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</p>
    <div class="confirm-actions">
      <button class="btn btn-secondary" onclick="closeConfirm(false)">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-danger" onclick="closeConfirm(true)">üóë –£–¥–∞–ª–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Status Bar -->
<div class="status-bar">
  <div><span class="dot dot-green" id="statusDot"></span> <span id="statusText">–ü–æ–¥–∫–ª—é—á–µ–Ω–æ</span></div>
  <div id="statusTime"></div>
</div>

<!-- ============================================================
     JAVASCRIPT ‚Äî FULL APPLICATION LOGIC
     ============================================================ -->
<script>
// ============================================================
// CONFIG & STATE
// ============================================================
const CONFIG = {
  API_URL: 'https://daniyal2212.app.n8n.cloud/webhook/rkt-api',
  WRITE_URL: 'https://daniyal2212.app.n8n.cloud/webhook/rkt-write',
  SHEET_ID: '12BniI4H5inrEDJKWNrSxL480acGSGJlSIFvCqYfd9KY',
  REFRESH_INTERVAL: 300000, // 5 min auto-refresh
  VERSION: '2.1.0'
};

let DATA = {
  partners: [],
  tasks: [],
  directions: [],
  staff: [],
  projects: [],
  approvals: [],
  comms: []
};

let USER = null;
let currentModal = '';
let editingItem = null;
let confirmCallback = null;
let currentFilters = { partners: '–í—Å–µ', tasks: '–í—Å–µ' };
let refreshTimer = null;
let currentProject = null;   // Selected direction name
let currentPwTab = 'overview'; // Active tab in project workspace

// ============================================================
// DIRECTION METADATA ‚Äî descriptions, icons, colors
// ============================================================
const DIR_META = {
  '–ö–¢': {
    emoji: 'üî¨',
    cls: 'ct',
    color: 'var(--accent)',
    desc: '–ö–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã–µ —Ç–æ–º–æ–≥—Ä–∞—Ñ—ã ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–µ–∫—Ç. –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è —Å Syno-Tech, –≤—ã—Ö–æ–¥ –Ω–∞ —Ä—ã–Ω–æ–∫ Q4 2027.'
  },
  '–†–µ–Ω—Ç–≥–µ–Ω': {
    emoji: 'üì°',
    cls: 'xray',
    color: 'var(--blue)',
    desc: '–†–µ–Ω—Ç–≥–µ–Ω–æ–≤—Å–∫–∏–µ –∞–ø–ø–∞—Ä–∞—Ç—ã ‚Äî —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –ª–∏–Ω–µ–π–∫–∏ –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –ö–¢.'
  },
  '–†–æ–±–æ—Ç—ã': {
    emoji: 'ü§ñ',
    cls: 'robots',
    color: 'var(--purple)',
    desc: '–•–∏—Ä—É—Ä–≥–∏—á–µ—Å–∫–∏–µ —Ä–æ–±–æ—Ç–æ—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–∏—Å—Ç–µ–º—ã ‚Äî –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ.'
  },
  '–£—Ä–æ–ª–æ–≥–∏—è': {
    emoji: 'üíä',
    cls: 'urology',
    color: 'var(--orange)',
    desc: '–£—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ ‚Äî –Ω–∏—à–µ–≤—ã–π —Å–µ–≥–º–µ–Ω—Ç —Ä—ã–Ω–∫–∞.'
  },
  'PACS': {
    emoji: 'üíª',
    cls: 'pacs',
    color: 'var(--pink)',
    desc: '–°–∏—Å—Ç–µ–º—ã –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏ –∏ –ø–µ—Ä–µ–¥–∞—á–∏ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (PACS/RIS).'
  },
  '–£–ó–ò': {
    emoji: 'ü©∫',
    cls: 'uzi',
    color: 'var(--green)',
    desc: '–£–ª—å—Ç—Ä–∞–∑–≤—É–∫–æ–≤–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ ‚Äî –ø–ª–∞–Ω –≤–Ω–µ–¥—Ä–µ–Ω–∏—è —Å–æ 2 –ø–æ–ª—É–≥–æ–¥–∏—è 2028.'
  },
  '–û–±—â–µ–µ': {
    emoji: 'üìå',
    cls: 'general',
    color: 'var(--text2)',
    desc: '–û–±—â–∏–µ –∑–∞–¥–∞—á–∏ –∏ –ø—Ä–æ–µ–∫—Ç—ã –∫–æ–º–ø–∞–Ω–∏–∏ –†–ö–¢.'
  }
};

// ============================================================
// ROLE DEFINITIONS
// ============================================================
const ROLES = {
  'CEO': {
    emoji: 'üëë',
    level: 3,
    canWrite: true,
    canDelete: true,
    canApprove: true,
    canManageStaff: true,
    seeAll: true
  },
  '–ó–∞–º': {
    emoji: '‚≠ê',
    level: 2,
    canWrite: false,
    canDelete: false,
    canApprove: false,
    canManageStaff: false,
    seeAll: true
  },
  '–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å': {
    emoji: 'üìã',
    level: 1,
    canWrite: false,
    canDelete: false,
    canApprove: false,
    canManageStaff: false,
    seeAll: false
  }
};

function getUserPerms() {
  if (!USER) return ROLES['–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å'];
  return ROLES[USER.role] || ROLES['–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å'];
}

// ============================================================
// FORM DEFINITIONS
// ============================================================
const FORM_DEFS = {
  partner: {
    title: '–ü–∞—Ä—Ç–Ω—ë—Ä',
    sheet: '–ü–∞—Ä—Ç–Ω—ë—Ä—ã',
    fields: [
      { name: '–ù–∞–∑–≤–∞–Ω–∏–µ', type: 'text', required: true, placeholder: '–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏' },
      { name: '–°—Ç—Ä–∞–Ω–∞', type: 'text', placeholder: '–ö–∏—Ç–∞–π, –†–æ—Å—Å–∏—è, ...' },
      { name: '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', type: 'select', options: ['–ö–¢', '–†–µ–Ω—Ç–≥–µ–Ω', '–†–æ–±–æ—Ç—ã', '–£—Ä–æ–ª–æ–≥–∏—è', 'PACS', '–£–ó–ò'] },
      { name: '–ü—Ä–æ–¥—É–∫—Ç', type: 'text', placeholder: '–û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–¥—É–∫—Ç' },
      { name: '–°—Ç–∞—Ç—É—Å', type: 'select', options: ['Research', '–ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã', '–ê–∫—Ç–∏–≤–Ω—ã–π', '–ü–∞—É–∑–∞'] },
      { name: '–ö–æ–Ω—Ç–∞–∫—Ç', type: 'text', placeholder: '–ò–º—è –∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ–≥–æ –ª–∏—Ü–∞' },
      { name: 'Email', type: 'text', placeholder: 'email@company.com' },
      { name: '–¢–µ–ª–µ—Ñ–æ–Ω', type: 'text', placeholder: '+7 ...' },
      { name: '–°–∞–π—Ç', type: 'text', placeholder: 'https://' },
      { name: '–û–ø–∏—Å–∞–Ω–∏–µ', type: 'textarea', placeholder: '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, –∑–∞–º–µ—Ç–∫–∏...' }
    ]
  },
  project: {
    title: '–ü—Ä–æ–µ–∫—Ç',
    sheet: '–ü—Ä–æ–µ–∫—Ç—ã',
    fields: [
      { name: '–ù–∞–∑–≤–∞–Ω–∏–µ', type: 'text', required: true, placeholder: '–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞' },
      { name: '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', type: 'select', options: ['–ö–¢', '–†–µ–Ω—Ç–≥–µ–Ω', '–†–æ–±–æ—Ç—ã', '–£—Ä–æ–ª–æ–≥–∏—è', 'PACS', '–£–ó–ò'] },
      { name: '–û–ø–∏—Å–∞–Ω–∏–µ', type: 'textarea', placeholder: '–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞...' },
      { name: '–°—Ç–∞—Ç—É—Å', type: 'select', options: ['–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ', '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞', '–í —Ä–∞–±–æ—Ç–µ', '–ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã', '–ó–∞–≤–µ—Ä—à—ë–Ω'] },
      { name: '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç', type: 'select', options: ['P1', 'P2', 'P3'] },
      { name: '–ü—Ä–æ–≥—Ä–µ—Å—Å', type: 'text', placeholder: '0-100' },
      { name: '–ü–∞—Ä—Ç–Ω—ë—Ä', type: 'text', placeholder: '–°–≤—è–∑–∞–Ω–Ω—ã–π –ø–∞—Ä—Ç–Ω—ë—Ä' },
      { name: '–ë—é–¥–∂–µ—Ç', type: 'text', placeholder: '–ë—é–¥–∂–µ—Ç –ø—Ä–æ–µ–∫—Ç–∞' },
      { name: '–î–µ–¥–ª–∞–π–Ω', type: 'date' },
      { name: '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π', type: 'text', placeholder: '–ö—Ç–æ –≤–µ–¥—ë—Ç –ø—Ä–æ–µ–∫—Ç' }
    ]
  },
  task: {
    title: '–ó–∞–¥–∞—á–∞',
    sheet: '–ó–∞–¥–∞—á–∏',
    fields: [
      { name: '–û–ø–∏—Å–∞–Ω–∏–µ', type: 'text', required: true, placeholder: '–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å' },
      { name: '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', type: 'select', options: ['–ö–¢', '–†–µ–Ω—Ç–≥–µ–Ω', '–†–æ–±–æ—Ç—ã', '–£—Ä–æ–ª–æ–≥–∏—è', 'PACS', '–£–ó–ò', '–û–±—â–µ–µ'] },
      { name: '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç', type: 'select', options: ['P1', 'P2', 'P3'] },
      { name: '–°—Ç–∞—Ç—É—Å', type: 'select', options: ['‚è≥ –í –æ—á–µ—Ä–µ–¥–∏', '–í —Ä–∞–±–æ—Ç–µ', '–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ', '–ì–æ—Ç–æ–≤–æ'] },
      { name: '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π', type: 'text', placeholder: '–ö—Ç–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç' },
      { name: '–ü—Ä–æ–µ–∫—Ç', type: 'text', placeholder: '–°–≤—è–∑–∞–Ω–Ω—ã–π –ø—Ä–æ–µ–∫—Ç' },
      { name: '–î–µ–¥–ª–∞–π–Ω', type: 'date' },
      { name: '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π', type: 'textarea', placeholder: '–î–æ–ø. –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è...' }
    ]
  },
  staff: {
    title: '–°–æ—Ç—Ä—É–¥–Ω–∏–∫',
    sheet: '–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏',
    fields: [
      { name: '–ò–º—è', type: 'text', required: true, placeholder: '–§–ò–û' },
      { name: 'Telegram_ID', type: 'text', placeholder: '–ß–∏—Å–ª–æ–≤–æ–π ID –∏–∑ Telegram' },
      { name: 'Username', type: 'text', placeholder: '@username' },
      { name: '–†–æ–ª—å', type: 'select', options: ['CEO', '–ó–∞–º', '–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å'] },
      { name: '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', type: 'select', options: ['–í—Å–µ', '–ö–¢', '–†–µ–Ω—Ç–≥–µ–Ω', '–†–æ–±–æ—Ç—ã', '–£—Ä–æ–ª–æ–≥–∏—è', 'PACS'] },
      { name: 'Email', type: 'text', placeholder: 'email@company.com' },
      { name: '–¢–µ–ª–µ—Ñ–æ–Ω', type: 'text', placeholder: '+7 ...' }
    ]
  },
  comm: {
    title: '–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è',
    sheet: '–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏',
    fields: [
      { name: '–ü–∞—Ä—Ç–Ω—ë—Ä', type: 'text', required: true, placeholder: '–° –∫–µ–º –æ–±—â–∞–ª–∏—Å—å' },
      { name: '–¢–∏–ø', type: 'select', options: ['–ó–≤–æ–Ω–æ–∫', 'Email', '–í—Å—Ç—Ä–µ—á–∞', '–ü–∏—Å—å–º–æ', '–ß–∞—Ç', 'Zoom', 'WhatsApp'] },
      { name: '–¢–µ–º–∞', type: 'text', placeholder: '–¢–µ–º–∞ –æ–±—Å—É–∂–¥–µ–Ω–∏—è' },
      { name: '–†–µ–∑—É–ª—å—Ç–∞—Ç', type: 'textarea', placeholder: '–ò—Ç–æ–≥, –¥–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç–∏, —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏...' },
      { name: '–°–ª–µ–¥—É—é—â–∏–π_—à–∞–≥', type: 'text', placeholder: '–ß—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ' },
      { name: '–î–∞—Ç–∞_—Å–ª–µ–¥—É—é—â–µ–≥–æ', type: 'date' }
    ]
  }
};

// ============================================================
// AUTHENTICATION
// ============================================================
function checkSavedLogin() {
  const saved = localStorage.getItem('rkt_user');
  if (saved) {
    try {
      USER = JSON.parse(saved);
      if (USER && USER.tgId) {
        showApp();
        return;
      }
    } catch (e) {}
    localStorage.removeItem('rkt_user');
  }
}

async function doLogin() {
  const tgId = document.getElementById('loginTgId').value.trim();

  if (!tgId) {
    showLoginError('–í–≤–µ–¥–∏—Ç–µ Telegram ID');
    return;
  }

  if (!/^\d+$/.test(tgId)) {
    showLoginError('Telegram ID –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã');
    return;
  }

  document.getElementById('loginBtn').disabled = true;
  document.getElementById('loginBtnText').textContent = '–ü–æ–¥–∫–ª—é—á–∞—é—Å—å...';
  document.getElementById('loginLoading').style.display = 'block';
  document.getElementById('loginError').style.display = 'none';

  try {
    const response = await fetch(CONFIG.API_URL);
    if (!response.ok) throw new Error('HTTP ' + response.status);
    const data = await response.json();
    DATA = normalizeData(data);

    const staffList = DATA.staff || [];
    const staffMember = staffList.find(s => String(s.Telegram_ID).trim() === String(tgId).trim());

    if (!staffMember) {
      showLoginError('‚õî Telegram ID ¬´' + tgId + '¬ª –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.');
      resetLoginBtn();
      return;
    }

    USER = {
      id: staffMember.ID || '',
      tgId: String(staffMember.Telegram_ID).trim(),
      name: staffMember['–ò–º—è'] || '–°–æ—Ç—Ä—É–¥–Ω–∏–∫',
      role: staffMember['–†–æ–ª—å'] || '–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å',
      direction: staffMember['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] || '–í—Å–µ',
      email: staffMember['Email'] || '',
      phone: staffMember['–¢–µ–ª–µ—Ñ–æ–Ω'] || '',
      username: staffMember['Username'] || ''
    };

    localStorage.setItem('rkt_user', JSON.stringify(USER));
    showApp();

  } catch (e) {
    console.error('Login error:', e);
    showLoginError('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
    resetLoginBtn();
  }
}

function showLoginError(msg) {
  const el = document.getElementById('loginError');
  el.textContent = msg;
  el.style.display = 'block';
}

function resetLoginBtn() {
  document.getElementById('loginBtn').disabled = false;
  document.getElementById('loginBtnText').textContent = '–í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É';
  document.getElementById('loginLoading').style.display = 'none';
}

function doLogout() {
  USER = null;
  localStorage.removeItem('rkt_user');
  if (refreshTimer) clearInterval(refreshTimer);
  document.getElementById('mainApp').style.display = 'none';
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('loginTgId').value = '';
  resetLoginBtn();
  document.getElementById('loginError').style.display = 'none';
}

function showApp() {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('mainApp').style.display = 'flex';

  const perms = getUserPerms();

  // User bar
  document.getElementById('userName').textContent = USER.name;
  document.getElementById('userRoleText').textContent = perms.emoji + ' ' + USER.role + (USER.direction !== '–í—Å–µ' ? ' ‚Äî ' + USER.direction : '');
  document.getElementById('userAvatar').textContent = USER.name.charAt(0).toUpperCase();

  // Settings page
  document.getElementById('settingsApiUrl').value = CONFIG.API_URL;
  document.getElementById('s-name').textContent = USER.name;
  document.getElementById('s-role').textContent = perms.emoji + ' ' + USER.role;
  document.getElementById('s-dir').textContent = USER.direction;
  document.getElementById('s-tgid').textContent = USER.tgId;

  // Role-based visibility
  document.getElementById('btn-add-staff').style.display = perms.canManageStaff ? '' : 'none';
  document.getElementById('nav-approvals').classList.toggle('hidden', !perms.canApprove);

  // Load data
  loadData();

  // Auto-refresh
  if (refreshTimer) clearInterval(refreshTimer);
  refreshTimer = setInterval(loadData, CONFIG.REFRESH_INTERVAL);

  // Status bar time
  updateStatusTime();
  setInterval(updateStatusTime, 60000);
}

// ============================================================
// DATA LOADING & WRITING
// ============================================================
function normalizeData(d) {
  return {
    partners: Array.isArray(d.partners) ? d.partners : [],
    tasks: Array.isArray(d.tasks) ? d.tasks : [],
    directions: Array.isArray(d.directions) ? d.directions : [],
    staff: Array.isArray(d.staff) ? d.staff : [],
    projects: Array.isArray(d.projects) ? d.projects : [],
    approvals: Array.isArray(d.approvals) ? d.approvals : [],
    comms: Array.isArray(d.comms) ? d.comms : []
  };
}

async function loadData() {
  setStatus('loading');
  try {
    const response = await fetch(CONFIG.API_URL);
    if (!response.ok) throw new Error('HTTP ' + response.status);
    const data = await response.json();
    DATA = normalizeData(data);
    renderAll();
    setStatus('connected');
    toast('‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã', 'success');
  } catch (e) {
    console.error('Load error:', e);
    setStatus('error');
    toast('‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');
  }
}

async function apiWrite(sheet, row) {
  try {
    const payload = JSON.stringify({ sheet: sheet, row: row });
    const b64 = btoa(unescape(encodeURIComponent(payload)));
    const response = await fetch(CONFIG.WRITE_URL + '?b64=' + b64);
    if (!response.ok) throw new Error('HTTP ' + response.status);
    return true;
  } catch (e) {
    console.error('Write error:', e);
    toast('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏: ' + e.message, 'error');
    return false;
  }
}

// ============================================================
// FILTERING
// ============================================================
function filterByRole(arr) {
  const perms = getUserPerms();
  if (perms.seeAll || !USER || USER.direction === '–í—Å–µ') return arr;
  return arr.filter(item => {
    const dir = item['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] || '';
    return dir === USER.direction || dir === '–í—Å–µ' || dir === '–û–±—â–µ–µ' || dir === '';
  });
}

function filterBySearch(arr, searchId, fields) {
  const el = document.getElementById(searchId);
  if (!el) return arr;
  const q = el.value.toLowerCase().trim();
  if (!q) return arr;
  return arr.filter(item => fields.some(f => (item[f] || '').toLowerCase().includes(q)));
}

function filterByDirection(arr, dir) {
  if (!dir || dir === '–í—Å–µ') return arr;
  return arr.filter(item => (item['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] || '').includes(dir));
}

// ============================================================
// NAVIGATION
// ============================================================
function showPage(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

  const pageEl = document.getElementById('page-' + page);
  const navEl = document.querySelector('[data-page="' + page + '"]');

  if (pageEl) pageEl.classList.add('active');
  if (navEl) navEl.classList.add('active');

  // Close sidebar on mobile
  document.getElementById('sidebar').classList.remove('open');

  // Reset project selection when going home
  if (page === 'home') currentProject = null;
}

function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
}

function openProject(dirName) {
  currentProject = dirName;
  currentPwTab = 'overview';
  showPage('project');
  renderProjectWorkspace();
}

function showPwTab(tab) {
  currentPwTab = tab;

  // Update tab UI
  document.querySelectorAll('#pw-tabs .tab').forEach(t => {
    t.classList.toggle('active', t.getAttribute('data-tab') === tab);
  });

  renderProjectWorkspace();
}

// ============================================================
// HELPER FUNCTIONS
// ============================================================
function escHtml(s) {
  return String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

function escAttr(s) {
  return String(s || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
}

function emptyRow(cols, msg) {
  return '<tr><td colspan="' + cols + '" class="empty"><div class="icon">üì≠</div><p>' + msg + '</p></td></tr>';
}

function statusBadge(s) {
  if (!s) return '';
  let cls = 's-active';
  if (s === '–ê–∫—Ç–∏–≤–Ω—ã–π' || s.includes('–ì–æ—Ç–æ–≤–æ')) cls = 's-done';
  else if (s === '–ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã') cls = 's-talks';
  else if (s === 'Research' || s.includes('–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ')) cls = 's-research';
  else if (s === '–ü–∞—É–∑–∞') cls = 's-pause';
  else if (s.includes('—Ä–∞–±–æ—Ç–µ') || s.includes('–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞') || s.includes('–ø—Ä–æ–≤–µ—Ä–∫–µ')) cls = 's-work';
  else if (s.includes('–û–∂–∏–¥–∞–µ—Ç') || s.includes('–æ—á–µ—Ä–µ–¥–∏')) cls = 's-urgent';
  else if (s.includes('–û–¥–æ–±—Ä–µ–Ω–æ')) cls = 's-done';
  else if (s.includes('–û—Ç–∫–ª–æ–Ω–µ–Ω–æ')) cls = 's-urgent';
  return '<span class="status ' + cls + '">' + escHtml(s) + '</span>';
}

function priorityBadge(p) {
  if (!p) return '';
  const cls = p === 'P1' ? 'p1' : p === 'P2' ? 'p2' : 'p3';
  return '<span class="' + cls + '">' + escHtml(p) + '</span>';
}

function progressBar(val) {
  const v = parseInt(val) || 0;
  const color = v >= 80 ? 'var(--green)' : v >= 50 ? 'var(--accent)' : v >= 25 ? 'var(--orange)' : 'var(--red)';
  return '<div class="progress-wrap">' +
    '<div class="progress-bar"><div class="progress-fill" style="width:' + v + '%;background:' + color + '"></div></div>' +
    '<span class="progress-text">' + v + '%</span>' +
    '</div>';
}

function actionButtons(type, id, name) {
  const perms = getUserPerms();
  let html = '<div class="actions-cell">';
  html += '<button class="act-btn view" onclick="viewItem(\'' + type + '\',\'' + escAttr(id) + '\')" title="–ü—Ä–æ—Å–º–æ—Ç—Ä">üëÅ</button>';
  html += '<button class="act-btn" onclick="editItem(\'' + type + '\',\'' + escAttr(id) + '\')" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>';
  if (perms.canDelete) {
    html += '<button class="act-btn del" onclick="confirmDelete(\'' + type + '\',\'' + escAttr(id) + '\',\'' + escAttr(name) + '\')" title="–£–¥–∞–ª–∏—Ç—å">üóë</button>';
  }
  html += '</div>';
  return html;
}

function toast(msg, type) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'toast toast-' + (type || 'success') + ' show';
  setTimeout(() => el.classList.remove('show'), 3000);
}

function setStatus(state) {
  const dot = document.getElementById('statusDot');
  const text = document.getElementById('statusText');
  if (state === 'connected') {
    dot.className = 'dot dot-green';
    text.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ ‚Ä¢ ' + new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
  } else if (state === 'loading') {
    dot.className = 'dot dot-green';
    text.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...';
  } else {
    dot.className = 'dot dot-red';
    text.textContent = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è';
  }
}

function updateStatusTime() {
  const el = document.getElementById('statusTime');
  if (el) {
    el.textContent = new Date().toLocaleString('ru-RU', {
      day: '2-digit', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit'
    });
  }
}

// ============================================================
// RENDER: MASTER
// ============================================================
function renderAll() {
  renderHome();
  renderDashboard();
  renderPartnerFilters();
  renderPartners();
  renderTaskFilters();
  renderTasks();
  renderStaff();
  renderApprovals();
  renderComms();
  renderSettings();
  updateBadges();
  if (currentProject) renderProjectWorkspace();
}

function updateBadges() {
  const fp = filterByRole(DATA.partners);
  const ft = filterByRole(DATA.tasks).filter(t => (t['–°—Ç–∞—Ç—É—Å'] || '') !== '–ì–æ—Ç–æ–≤–æ');
  const pendingApprovals = DATA.approvals.filter(a => (a['–°—Ç–∞—Ç—É—Å'] || '').includes('–û–∂–∏–¥–∞–µ—Ç'));

  document.getElementById('badge-partners').textContent = fp.length;
  document.getElementById('badge-tasks').textContent = ft.length;
  document.getElementById('badge-approvals').textContent = pendingApprovals.length;
}

// ============================================================
// RENDER: HOME ‚Äî PROJECT GRID
// ============================================================
function renderHome() {
  const partners = filterByRole(DATA.partners);
  const tasks = filterByRole(DATA.tasks);
  const projects = filterByRole(DATA.projects);
  const today = new Date().toISOString().split('T')[0];
  const activeTasks = tasks.filter(t => (t['–°—Ç–∞—Ç—É—Å'] || '') !== '–ì–æ—Ç–æ–≤–æ');
  const overdue = activeTasks.filter(t => t['–î–µ–¥–ª–∞–π–Ω'] && t['–î–µ–¥–ª–∞–π–Ω'] < today);

  // Home metrics (totals)
  document.getElementById('home-metrics').innerHTML =
    '<div class="metric-card"><div class="m-icon">ü§ù</div><div class="m-value">' + partners.length + '</div><div class="m-label">–ü–∞—Ä—Ç–Ω—ë—Ä–æ–≤</div><div class="m-sub">' + partners.filter(p => p['–°—Ç–∞—Ç—É—Å'] === '–ê–∫—Ç–∏–≤–Ω—ã–π').length + ' –∞–∫—Ç–∏–≤–Ω—ã—Ö</div></div>' +
    '<div class="metric-card"><div class="m-icon">üìÅ</div><div class="m-value">' + projects.length + '</div><div class="m-label">–ü—Ä–æ–µ–∫—Ç–æ–≤</div><div class="m-sub">' + projects.filter(p => (p['–°—Ç–∞—Ç—É—Å'] || '') !== '–ó–∞–≤–µ—Ä—à—ë–Ω').length + ' –∞–∫—Ç–∏–≤–Ω—ã—Ö</div></div>' +
    '<div class="metric-card"><div class="m-icon">‚úÖ</div><div class="m-value">' + activeTasks.length + '</div><div class="m-label">–ó–∞–¥–∞—á –≤ —Ä–∞–±–æ—Ç–µ</div><div class="m-sub">' + tasks.filter(t => (t['–°—Ç–∞—Ç—É—Å'] || '') === '–ì–æ—Ç–æ–≤–æ').length + ' –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</div></div>' +
    '<div class="metric-card"><div class="m-icon">üî¥</div><div class="m-value" style="color:' + (overdue.length ? 'var(--red)' : 'var(--green)') + '">' + overdue.length + '</div><div class="m-label">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</div></div>' +
    '<div class="metric-card"><div class="m-icon">üë•</div><div class="m-value">' + DATA.staff.length + '</div><div class="m-label">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</div><div class="m-sub">' + DATA.staff.filter(s => (s['–°—Ç–∞—Ç—É—Å'] || '–ê–∫—Ç–∏–≤–Ω—ã–π') === '–ê–∫—Ç–∏–≤–Ω—ã–π').length + ' –∞–∫—Ç–∏–≤–Ω—ã—Ö</div></div>';

  // Collect all unique directions
  const dirSet = new Set();
  DATA.directions.forEach(d => { if (d['–ù–∞–∑–≤–∞–Ω–∏–µ']) dirSet.add(d['–ù–∞–∑–≤–∞–Ω–∏–µ']); });
  partners.forEach(p => { if (p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']) dirSet.add(p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']); });
  projects.forEach(p => { if (p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']) dirSet.add(p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']); });
  tasks.forEach(t => { if (t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] && t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] !== '–û–±—â–µ–µ') dirSet.add(t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']); });

  const allDirs = [...dirSet];

  // Add "–û–±—â–µ–µ" at end if general tasks exist
  const generalTasks = tasks.filter(t => (t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] || '') === '–û–±—â–µ–µ');
  if (generalTasks.length > 0) allDirs.push('–û–±—â–µ–µ');

  // Build project cards
  const grid = document.getElementById('project-grid');
  grid.innerHTML = allDirs.map(dir => {
    const meta = DIR_META[dir] || { emoji: 'üìå', cls: 'general', color: 'var(--text2)', desc: '' };

    const dp = partners.filter(p => (p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] || '').includes(dir));
    const dpr = projects.filter(p => (p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] || '').includes(dir));
    const dt = tasks.filter(t => (t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] || '').includes(dir));
    const dtActive = dt.filter(t => (t['–°—Ç–∞—Ç—É—Å'] || '') !== '–ì–æ—Ç–æ–≤–æ');
    const dtOverdue = dtActive.filter(t => t['–î–µ–¥–ª–∞–π–Ω'] && t['–î–µ–¥–ª–∞–π–Ω'] < today);

    // Average progress across projects in this direction
    const avgProg = dpr.length
      ? Math.round(dpr.reduce((sum, p) => sum + (parseInt(p['–ü—Ä–æ–≥—Ä–µ—Å—Å']) || 0), 0) / dpr.length)
      : 0;

    // Status tag
    let statusTag = '';
    if (dtOverdue.length > 0) {
      statusTag = '<span class="status-tag" style="background:var(--red-glow);color:var(--red)">üî¥ ' + dtOverdue.length + ' –ø—Ä–æ—Å—Ä–æ—á.</span>';
    } else if (dtActive.length > 0) {
      statusTag = '<span class="status-tag" style="background:var(--accent-glow);color:var(--accent)">–í —Ä–∞–±–æ—Ç–µ</span>';
    } else {
      statusTag = '<span class="status-tag" style="background:rgba(136,153,170,0.15);color:var(--text2)">–°—Ç–∞—Ä—Ç</span>';
    }

    return '<div class="project-card ' + meta.cls + '" onclick="openProject(\'' + escAttr(dir) + '\')">' +
      '<div class="project-card-top"></div>' +
      statusTag +
      '<div class="project-card-header">' +
        '<span class="emoji">' + meta.emoji + '</span>' +
        '<h3>' + escHtml(dir) + '</h3>' +
        '<div class="desc">' + escHtml(meta.desc) + '</div>' +
      '</div>' +
      '<div class="project-card-stats">' +
        '<div class="pcs"><div class="v" style="color:' + meta.color + '">' + dp.length + '</div><div class="l">–ü–∞—Ä—Ç–Ω—ë—Ä–æ–≤</div></div>' +
        '<div class="pcs"><div class="v" style="color:' + meta.color + '">' + dpr.length + '</div><div class="l">–ü—Ä–æ–µ–∫—Ç–æ–≤</div></div>' +
        '<div class="pcs"><div class="v" style="color:' + meta.color + '">' + dtActive.length + '</div><div class="l">–ó–∞–¥–∞—á</div></div>' +
      '</div>' +
      '<div class="project-card-progress">' +
        '<div class="bar"><div class="fill" style="width:' + avgProg + '%;background:' + meta.color + '"></div></div>' +
        '<div class="info"><span>–ü—Ä–æ–≥—Ä–µ—Å—Å</span><span>' + avgProg + '%</span></div>' +
      '</div>' +
    '</div>';
  }).join('');
}

// ============================================================
// RENDER: PROJECT WORKSPACE
// ============================================================
function renderProjectWorkspace() {
  if (!currentProject) return;
  const dir = currentProject;
  const meta = DIR_META[dir] || { emoji: 'üìå', cls: 'general', color: 'var(--accent)', desc: '' };
  const today = new Date().toISOString().split('T')[0];

  // Header
  document.getElementById('pw-name').textContent = dir;
  document.getElementById('pw-title').innerHTML = meta.emoji + ' ' + escHtml(dir);

  // Filter data for this direction
  const dp = filterByRole(DATA.partners).filter(p => (p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] || '').includes(dir));
  const dpr = filterByRole(DATA.projects).filter(p => (p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] || '').includes(dir));
  const dt = filterByRole(DATA.tasks).filter(t => (t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] || '').includes(dir));
  const dtActive = dt.filter(t => (t['–°—Ç–∞—Ç—É—Å'] || '') !== '–ì–æ—Ç–æ–≤–æ');
  const dtDone = dt.filter(t => (t['–°—Ç–∞—Ç—É—Å'] || '') === '–ì–æ—Ç–æ–≤–æ');
  const dtOverdue = dtActive.filter(t => t['–î–µ–¥–ª–∞–π–Ω'] && t['–î–µ–¥–ª–∞–π–Ω'] < today);
  const avgProg = dpr.length ? Math.round(dpr.reduce((s, p) => s + (parseInt(p['–ü—Ä–æ–≥—Ä–µ—Å—Å']) || 0), 0) / dpr.length) : 0;

  // Comms linked to partners in this direction
  const dirPartnerNames = dp.map(p => p['–ù–∞–∑–≤–∞–Ω–∏–µ']).filter(Boolean);
  const dc = (DATA.comms || []).filter(c => dirPartnerNames.some(pn => (c['–ü–∞—Ä—Ç–Ω—ë—Ä'] || '').includes(pn)));

  // Metrics
  document.getElementById('pw-metrics').innerHTML =
    '<div class="metric-card"><div class="m-icon">ü§ù</div><div class="m-value">' + dp.length + '</div><div class="m-label">–ü–∞—Ä—Ç–Ω—ë—Ä–æ–≤</div><div class="m-sub">' + dp.filter(p => p['–°—Ç–∞—Ç—É—Å'] === '–ê–∫—Ç–∏–≤–Ω—ã–π').length + ' –∞–∫—Ç–∏–≤–Ω—ã—Ö</div></div>' +
    '<div class="metric-card"><div class="m-icon">üìÅ</div><div class="m-value">' + dpr.length + '</div><div class="m-label">–ü—Ä–æ–µ–∫—Ç–æ–≤</div><div class="m-sub">—Å—Ä. –ø—Ä–æ–≥—Ä–µ—Å—Å ' + avgProg + '%</div></div>' +
    '<div class="metric-card"><div class="m-icon">‚úÖ</div><div class="m-value">' + dtActive.length + '</div><div class="m-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á</div><div class="m-sub">' + dtDone.length + ' –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</div></div>' +
    '<div class="metric-card"><div class="m-icon">üî¥</div><div class="m-value" style="color:' + (dtOverdue.length ? 'var(--red)' : 'var(--green)') + '">' + dtOverdue.length + '</div><div class="m-label">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</div></div>' +
    '<div class="metric-card"><div class="m-icon">üí¨</div><div class="m-value">' + dc.length + '</div><div class="m-label">–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π</div></div>';

  const content = document.getElementById('pw-content');
  let html = '';

  // ‚Äî‚Äî‚Äî OVERVIEW TAB ‚Äî‚Äî‚Äî
  if (currentPwTab === 'overview') {

    // Overdue tasks block
    if (dtOverdue.length) {
      html += '<div class="card" style="border-color:rgba(255,107,107,0.4)">';
      html += '<div class="card-header" style="background:rgba(255,107,107,0.05)"><h3>üî¥ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ (' + dtOverdue.length + ')</h3></div>';
      html += '<div class="table-wrap"><table><thead><tr><th>–ó–∞–¥–∞—á–∞</th><th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th><th>–î–µ–¥–ª–∞–π–Ω</th><th>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th></tr></thead><tbody>';
      html += dtOverdue.map(t =>
        '<tr style="background:rgba(255,107,107,0.03)">' +
        '<td>' + escHtml(t['–û–ø–∏—Å–∞–Ω–∏–µ'] || t['–ù–∞–∑–≤–∞–Ω–∏–µ']) + '</td>' +
        '<td>' + priorityBadge(t['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']) + '</td>' +
        '<td style="color:var(--red);font-weight:700">' + escHtml(t['–î–µ–¥–ª–∞–π–Ω']) + '</td>' +
        '<td>' + escHtml(t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π'] || '‚Äî') + '</td></tr>'
      ).join('');
      html += '</tbody></table></div></div>';
    }

    // Active projects block
    if (dpr.length) {
      html += '<div class="card"><div class="card-header"><h3>üìÅ –ü—Ä–æ–µ–∫—Ç—ã (' + dpr.length + ')</h3></div>';
      html += '<div class="table-wrap"><table><thead><tr><th>–ü—Ä–æ–µ–∫—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ü—Ä–æ–≥—Ä–µ—Å—Å</th><th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th><th>–ü–∞—Ä—Ç–Ω—ë—Ä</th><th>–î–µ–¥–ª–∞–π–Ω</th></tr></thead><tbody>';
      html += dpr.map(p =>
        '<tr><td><strong>' + escHtml(p['–ù–∞–∑–≤–∞–Ω–∏–µ']) + '</strong></td>' +
        '<td>' + statusBadge(p['–°—Ç–∞—Ç—É—Å']) + '</td>' +
        '<td>' + progressBar(p['–ü—Ä–æ–≥—Ä–µ—Å—Å']) + '</td>' +
        '<td>' + priorityBadge(p['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']) + '</td>' +
        '<td style="font-size:12px">' + escHtml(p['–ü–∞—Ä—Ç–Ω—ë—Ä'] || '') + '</td>' +
        '<td>' + escHtml(p['–î–µ–¥–ª–∞–π–Ω'] || '‚Äî') + '</td></tr>'
      ).join('');
      html += '</tbody></table></div></div>';
    }

    // Top tasks by priority
    const pOrder = { P1: 1, P2: 2, P3: 3 };
    const topTasks = [...dtActive].sort((a, b) => (pOrder[a['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']] || 9) - (pOrder[b['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']] || 9)).slice(0, 10);

    html += '<div class="card"><div class="card-header"><h3>‚úÖ –ó–∞–¥–∞—á–∏ (' + dtActive.length + ' –∞–∫—Ç–∏–≤–Ω—ã—Ö)</h3></div>';
    html += '<div class="table-wrap"><table><thead><tr><th>–ó–∞–¥–∞—á–∞</th><th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th><th>–î–µ–¥–ª–∞–π–Ω</th></tr></thead><tbody>';
    html += topTasks.length ? topTasks.map(t => {
      const isOverdue = t['–î–µ–¥–ª–∞–π–Ω'] && t['–î–µ–¥–ª–∞–π–Ω'] < today && (t['–°—Ç–∞—Ç—É—Å'] || '') !== '–ì–æ—Ç–æ–≤–æ';
      return '<tr style="' + (isOverdue ? 'background:rgba(255,107,107,0.03)' : '') + '">' +
        '<td>' + (isOverdue ? 'üî¥ ' : '') + escHtml(t['–û–ø–∏—Å–∞–Ω–∏–µ'] || t['–ù–∞–∑–≤–∞–Ω–∏–µ']) + '</td>' +
        '<td>' + priorityBadge(t['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']) + '</td>' +
        '<td>' + statusBadge(t['–°—Ç–∞—Ç—É—Å']) + '</td>' +
        '<td style="font-size:12px">' + escHtml(t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π'] || '‚Äî') + '</td>' +
        '<td>' + escHtml(t['–î–µ–¥–ª–∞–π–Ω'] || '‚Äî') + '</td></tr>';
    }).join('') : emptyRow(5, '–ù–µ—Ç –∑–∞–¥–∞—á');
    html += '</tbody></table></div></div>';

    // Partners preview
    if (dp.length) {
      html += '<div class="card"><div class="card-header"><h3>ü§ù –ü–∞—Ä—Ç–Ω—ë—Ä—ã (' + dp.length + ')</h3></div>';
      html += '<div class="table-wrap"><table><thead><tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–°—Ç—Ä–∞–Ω–∞</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ü—Ä–æ–¥—É–∫—Ç</th><th>–ö–æ–Ω—Ç–∞–∫—Ç</th></tr></thead><tbody>';
      html += dp.map(p =>
        '<tr><td><strong>' + escHtml(p['–ù–∞–∑–≤–∞–Ω–∏–µ']) + '</strong></td>' +
        '<td>' + escHtml(p['–°—Ç—Ä–∞–Ω–∞']) + '</td>' +
        '<td>' + statusBadge(p['–°—Ç–∞—Ç—É—Å']) + '</td>' +
        '<td style="font-size:12px">' + escHtml(p['–ü—Ä–æ–¥—É–∫—Ç'] || '') + '</td>' +
        '<td style="font-size:12px">' + escHtml(p['–ö–æ–Ω—Ç–∞–∫—Ç'] || '') + '</td></tr>'
      ).join('');
      html += '</tbody></table></div></div>';
    }

    if (!html) {
      html = '<div class="empty"><div class="icon">üöÄ</div><p>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ¬´' + escHtml(dir) + '¬ª –ø–æ–∫–∞ –ø—É—Å—Ç–æ–µ. –î–æ–±–∞–≤—å—Ç–µ –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤, –ø—Ä–æ–µ–∫—Ç—ã –∏ –∑–∞–¥–∞—á–∏!</p></div>';
    }

  // ‚Äî‚Äî‚Äî PARTNERS TAB ‚Äî‚Äî‚Äî
  } else if (currentPwTab === 'partners') {
    html += '<div class="card"><div class="table-wrap"><table><thead><tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–°—Ç—Ä–∞–Ω–∞</th><th>–ü—Ä–æ–¥—É–∫—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ö–æ–Ω—Ç–∞–∫—Ç</th><th>Email</th><th></th></tr></thead><tbody>';
    html += dp.length ? dp.map(p =>
      '<tr><td><strong>' + escHtml(p['–ù–∞–∑–≤–∞–Ω–∏–µ']) + '</strong></td>' +
      '<td>' + escHtml(p['–°—Ç—Ä–∞–Ω–∞']) + '</td>' +
      '<td style="font-size:12px;max-width:200px;overflow:hidden;text-overflow:ellipsis">' + escHtml(p['–ü—Ä–æ–¥—É–∫—Ç'] || '') + '</td>' +
      '<td>' + statusBadge(p['–°—Ç–∞—Ç—É—Å']) + '</td>' +
      '<td style="font-size:12px">' + escHtml(p['–ö–æ–Ω—Ç–∞–∫—Ç'] || '') + '</td>' +
      '<td style="font-size:12px">' + escHtml(p['Email'] || '') + '</td>' +
      '<td>' + actionButtons('partner', p.ID, p['–ù–∞–∑–≤–∞–Ω–∏–µ']) + '</td></tr>'
    ).join('') : emptyRow(7, '–ù–µ—Ç –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤ –≤ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ ¬´' + escHtml(dir) + '¬ª');
    html += '</tbody></table></div></div>';

  // ‚Äî‚Äî‚Äî PROJECTS TAB ‚Äî‚Äî‚Äî
  } else if (currentPwTab === 'projects') {
    html += '<div class="card"><div class="table-wrap"><table><thead><tr><th>–ü—Ä–æ–µ–∫—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th><th>–ü—Ä–æ–≥—Ä–µ—Å—Å</th><th>–ü–∞—Ä—Ç–Ω—ë—Ä</th><th>–ë—é–¥–∂–µ—Ç</th><th>–î–µ–¥–ª–∞–π–Ω</th><th></th></tr></thead><tbody>';
    html += dpr.length ? dpr.map(p =>
      '<tr><td><strong>' + escHtml(p['–ù–∞–∑–≤–∞–Ω–∏–µ']) + '</strong></td>' +
      '<td>' + statusBadge(p['–°—Ç–∞—Ç—É—Å']) + '</td>' +
      '<td>' + priorityBadge(p['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']) + '</td>' +
      '<td>' + progressBar(p['–ü—Ä–æ–≥—Ä–µ—Å—Å']) + '</td>' +
      '<td style="font-size:12px">' + escHtml(p['–ü–∞—Ä—Ç–Ω—ë—Ä'] || '') + '</td>' +
      '<td style="font-size:12px">' + escHtml(p['–ë—é–¥–∂–µ—Ç'] || '‚Äî') + '</td>' +
      '<td>' + escHtml(p['–î–µ–¥–ª–∞–π–Ω'] || '‚Äî') + '</td>' +
      '<td>' + actionButtons('project', p.ID, p['–ù–∞–∑–≤–∞–Ω–∏–µ']) + '</td></tr>'
    ).join('') : emptyRow(8, '–ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤');
    html += '</tbody></table></div></div>';

  // ‚Äî‚Äî‚Äî TASKS TAB ‚Äî‚Äî‚Äî
  } else if (currentPwTab === 'tasks') {
    const pOrder = { P1: 1, P2: 2, P3: 3 };
    const sorted = [...dt].sort((a, b) => (pOrder[a['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']] || 9) - (pOrder[b['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']] || 9));

    html += '<div class="card"><div class="table-wrap"><table><thead><tr><th>–ó–∞–¥–∞—á–∞</th><th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th><th>–ü—Ä–æ–µ–∫—Ç</th><th>–î–µ–¥–ª–∞–π–Ω</th><th></th></tr></thead><tbody>';
    html += sorted.length ? sorted.map(t => {
      const isOD = t['–î–µ–¥–ª–∞–π–Ω'] && t['–î–µ–¥–ª–∞–π–Ω'] < today && (t['–°—Ç–∞—Ç—É—Å'] || '') !== '–ì–æ—Ç–æ–≤–æ';
      return '<tr style="' + (isOD ? 'background:rgba(255,107,107,0.05)' : '') + '">' +
        '<td>' + (isOD ? 'üî¥ ' : '') + escHtml(t['–û–ø–∏—Å–∞–Ω–∏–µ'] || t['–ù–∞–∑–≤–∞–Ω–∏–µ']) + '</td>' +
        '<td>' + priorityBadge(t['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']) + '</td>' +
        '<td>' + statusBadge(t['–°—Ç–∞—Ç—É—Å']) + '</td>' +
        '<td style="font-size:12px">' + escHtml(t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π'] || '‚Äî') + '</td>' +
        '<td style="font-size:12px">' + escHtml(t['–ü—Ä–æ–µ–∫—Ç'] || '‚Äî') + '</td>' +
        '<td>' + (isOD ? '<span style="color:var(--red);font-weight:700">' : '') + escHtml(t['–î–µ–¥–ª–∞–π–Ω'] || '‚Äî') + (isOD ? '</span>' : '') + '</td>' +
        '<td>' + actionButtons('task', t.ID, t['–û–ø–∏—Å–∞–Ω–∏–µ'] || t['–ù–∞–∑–≤–∞–Ω–∏–µ']) + '</td></tr>';
    }).join('') : emptyRow(7, '–ù–µ—Ç –∑–∞–¥–∞—á');
    html += '</tbody></table></div></div>';

  // ‚Äî‚Äî‚Äî COMMS TAB ‚Äî‚Äî‚Äî
  } else if (currentPwTab === 'comms') {
    html += '<div class="card"><div class="table-wrap"><table><thead><tr><th>–ü–∞—Ä—Ç–Ω—ë—Ä</th><th>–¢–∏–ø</th><th>–¢–µ–º–∞</th><th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th><th>–î–∞—Ç–∞</th><th>–ê–≤—Ç–æ—Ä</th><th></th></tr></thead><tbody>';
    html += dc.length ? dc.map(c =>
      '<tr><td><strong>' + escHtml(c['–ü–∞—Ä—Ç–Ω—ë—Ä']) + '</strong></td>' +
      '<td>' + escHtml(c['–¢–∏–ø']) + '</td>' +
      '<td>' + escHtml(c['–¢–µ–º–∞']) + '</td>' +
      '<td style="font-size:12px;max-width:200px;overflow:hidden;text-overflow:ellipsis">' + escHtml(c['–†–µ–∑—É–ª—å—Ç–∞—Ç'] || '') + '</td>' +
      '<td>' + escHtml(c['–î–∞—Ç–∞'] || '‚Äî') + '</td>' +
      '<td style="font-size:12px">' + escHtml(c['–ê–≤—Ç–æ—Ä'] || '‚Äî') + '</td>' +
      '<td>' + actionButtons('comm', c.ID || '', c['–ü–∞—Ä—Ç–Ω—ë—Ä']) + '</td></tr>'
    ).join('') : emptyRow(7, '–ù–µ—Ç –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é ¬´' + escHtml(dir) + '¬ª');
    html += '</tbody></table></div></div>';
  }

  content.innerHTML = html;
}

// ============================================================
// RENDER: DASHBOARD
// ============================================================
function renderDashboard() {
  const fp = filterByRole(DATA.partners);
  const ft = filterByRole(DATA.tasks);
  const fpr = filterByRole(DATA.projects);
  const today = new Date().toISOString().split('T')[0];
  const activeTasks = ft.filter(t => (t['–°—Ç–∞—Ç—É—Å'] || '') !== '–ì–æ—Ç–æ–≤–æ');
  const overdue = activeTasks.filter(t => t['–î–µ–¥–ª–∞–π–Ω'] && t['–î–µ–¥–ª–∞–π–Ω'] < today);

  document.getElementById('dash-metrics').innerHTML =
    '<div class="metric-card"><div class="m-icon">ü§ù</div><div class="m-value">' + fp.length + '</div><div class="m-label">–ü–∞—Ä—Ç–Ω—ë—Ä–æ–≤</div><div class="m-sub">' + fp.filter(p => p['–°—Ç–∞—Ç—É—Å'] === '–ê–∫—Ç–∏–≤–Ω—ã–π').length + ' –∞–∫—Ç–∏–≤–Ω—ã—Ö</div></div>' +
    '<div class="metric-card"><div class="m-icon">üìÅ</div><div class="m-value">' + fpr.length + '</div><div class="m-label">–ü—Ä–æ–µ–∫—Ç–æ–≤</div><div class="m-sub">' + fpr.filter(p => (p['–°—Ç–∞—Ç—É—Å'] || '') !== '–ó–∞–≤–µ—Ä—à—ë–Ω').length + ' –∞–∫—Ç–∏–≤–Ω—ã—Ö</div></div>' +
    '<div class="metric-card"><div class="m-icon">‚úÖ</div><div class="m-value">' + activeTasks.length + '</div><div class="m-label">–ó–∞–¥–∞—á</div><div class="m-sub">' + (overdue.length > 0 ? 'üî¥ ' + overdue.length + ' –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ' : '–≤ —Ä–∞–±–æ—Ç–µ') + '</div></div>' +
    '<div class="metric-card"><div class="m-icon">üë•</div><div class="m-value">' + DATA.staff.length + '</div><div class="m-label">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</div></div>' +
    '<div class="metric-card"><div class="m-icon">üìÇ</div><div class="m-value">' + DATA.directions.length + '</div><div class="m-label">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π</div></div>';

  // Urgent tasks
  const urgent = ft.filter(t => t['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç'] === 'P1' && (t['–°—Ç–∞—Ç—É—Å'] || '') !== '–ì–æ—Ç–æ–≤–æ').slice(0, 8);
  document.getElementById('urgent-tasks').innerHTML = urgent.length
    ? urgent.map(t =>
      '<tr><td>' + escHtml(t['–û–ø–∏—Å–∞–Ω–∏–µ'] || t['–ù–∞–∑–≤–∞–Ω–∏–µ']) + '</td><td>' + escHtml(t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']) + '</td><td>' + priorityBadge(t['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']) + '</td><td>' + statusBadge(t['–°—Ç–∞—Ç—É—Å']) + '</td><td>' + escHtml(t['–î–µ–¥–ª–∞–π–Ω'] || '‚Äî') + '</td></tr>'
    ).join('')
    : emptyRow(5, '–ù–µ—Ç —Å—Ä–æ—á–Ω—ã—Ö –∑–∞–¥–∞—á üéâ');

  // Active projects
  const activeProjects = fpr.filter(p => (p['–°—Ç–∞—Ç—É—Å'] || '') !== '–ó–∞–≤–µ—Ä—à—ë–Ω').slice(0, 8);
  document.getElementById('active-projects').innerHTML = activeProjects.length
    ? activeProjects.map(p =>
      '<tr><td><strong>' + escHtml(p['–ù–∞–∑–≤–∞–Ω–∏–µ']) + '</strong></td><td>' + escHtml(p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']) + '</td><td>' + statusBadge(p['–°—Ç–∞—Ç—É—Å']) + '</td><td>' + progressBar(p['–ü—Ä–æ–≥—Ä–µ—Å—Å']) + '</td><td>' + priorityBadge(p['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']) + '</td><td>' + escHtml(p['–î–µ–¥–ª–∞–π–Ω'] || '‚Äî') + '</td></tr>'
    ).join('')
    : emptyRow(6, '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤');

  // Recent comms
  const recentComms = (DATA.comms || []).slice(0, 5);
  document.getElementById('recent-comms').innerHTML = recentComms.length
    ? recentComms.map(c =>
      '<tr><td>' + escHtml(c['–ü–∞—Ä—Ç–Ω—ë—Ä']) + '</td><td>' + escHtml(c['–¢–∏–ø']) + '</td><td>' + escHtml(c['–¢–µ–º–∞']) + '</td><td>' + escHtml(c['–î–∞—Ç–∞'] || '‚Äî') + '</td><td>' + escHtml(c['–ê–≤—Ç–æ—Ä'] || '‚Äî') + '</td></tr>'
    ).join('')
    : emptyRow(5, '–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π');
}

// ============================================================
// RENDER: FILTERS
// ============================================================
function renderFilterChips(containerId, filterKey, dataKey) {
  const allDirs = ['–í—Å–µ', ...new Set(DATA[dataKey].map(item => item['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']).filter(Boolean))];
  const el = document.getElementById(containerId);
  if (!el) return;
  el.innerHTML = allDirs.map(d =>
    '<button class="filter-chip ' + (currentFilters[filterKey] === d ? 'active' : '') + '" onclick="setFilter(\'' + filterKey + '\',\'' + escAttr(d) + '\')">' + escHtml(d) + '</button>'
  ).join('');
}

function setFilter(key, value) {
  currentFilters[key] = value;
  renderAll();
}

function renderPartnerFilters() { renderFilterChips('partner-filters', 'partners', 'partners'); }
function renderTaskFilters() { renderFilterChips('task-filters', 'tasks', 'tasks'); }

// ============================================================
// RENDER: PARTNERS PAGE
// ============================================================
function renderPartners() {
  let data = filterByRole(DATA.partners);
  data = filterByDirection(data, currentFilters.partners === '–í—Å–µ' ? null : currentFilters.partners);
  data = filterBySearch(data, 'partner-search', ['–ù–∞–∑–≤–∞–Ω–∏–µ', '–°—Ç—Ä–∞–Ω–∞', '–ü—Ä–æ–¥—É–∫—Ç', '–ö–æ–Ω—Ç–∞–∫—Ç']);

  document.getElementById('partners-table').innerHTML = data.length ? data.map(p =>
    '<tr>' +
    '<td><strong>' + escHtml(p['–ù–∞–∑–≤–∞–Ω–∏–µ']) + '</strong></td>' +
    '<td>' + escHtml(p['–°—Ç—Ä–∞–Ω–∞']) + '</td>' +
    '<td>' + escHtml(p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']) + '</td>' +
    '<td style="font-size:12px;max-width:200px;overflow:hidden;text-overflow:ellipsis">' + escHtml(p['–ü—Ä–æ–¥—É–∫—Ç'] || '') + '</td>' +
    '<td>' + statusBadge(p['–°—Ç–∞—Ç—É—Å']) + '</td>' +
    '<td style="font-size:12px">' + escHtml(p['–ö–æ–Ω—Ç–∞–∫—Ç'] || '') + '</td>' +
    '<td>' + actionButtons('partner', p.ID, p['–ù–∞–∑–≤–∞–Ω–∏–µ']) + '</td>' +
    '</tr>'
  ).join('') : emptyRow(7, '–ü–∞—Ä—Ç–Ω—ë—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
}

// ============================================================
// RENDER: TASKS PAGE
// ============================================================
function renderTasks() {
  let data = filterByRole(DATA.tasks);
  data = filterByDirection(data, currentFilters.tasks === '–í—Å–µ' ? null : currentFilters.tasks);
  data = filterBySearch(data, 'task-search', ['–û–ø–∏—Å–∞–Ω–∏–µ', '–ù–∞–∑–≤–∞–Ω–∏–µ', '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π', '–ü—Ä–æ–µ–∫—Ç']);

  // Sort by priority
  const pOrder = { 'P1': 1, 'P2': 2, 'P3': 3 };
  data = [...data].sort((a, b) => (pOrder[a['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']] || 9) - (pOrder[b['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']] || 9));

  const today = new Date().toISOString().split('T')[0];
  document.getElementById('tasks-table').innerHTML = data.length ? data.map(t => {
    const isOverdue = t['–î–µ–¥–ª–∞–π–Ω'] && t['–î–µ–¥–ª–∞–π–Ω'] < today && (t['–°—Ç–∞—Ç—É—Å'] || '') !== '–ì–æ—Ç–æ–≤–æ';
    return '<tr style="' + (isOverdue ? 'background:rgba(255,107,107,0.05)' : '') + '">' +
      '<td>' + (isOverdue ? 'üî¥ ' : '') + escHtml(t['–û–ø–∏—Å–∞–Ω–∏–µ'] || t['–ù–∞–∑–≤–∞–Ω–∏–µ']) + '</td>' +
      '<td>' + escHtml(t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']) + '</td>' +
      '<td>' + priorityBadge(t['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']) + '</td>' +
      '<td>' + statusBadge(t['–°—Ç–∞—Ç—É—Å']) + '</td>' +
      '<td style="font-size:12px">' + escHtml(t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π'] || '‚Äî') + '</td>' +
      '<td>' + (isOverdue ? '<span style="color:var(--red);font-weight:700">' : '') + escHtml(t['–î–µ–¥–ª–∞–π–Ω'] || '‚Äî') + (isOverdue ? '</span>' : '') + '</td>' +
      '<td>' + actionButtons('task', t.ID, t['–û–ø–∏—Å–∞–Ω–∏–µ'] || t['–ù–∞–∑–≤–∞–Ω–∏–µ']) + '</td>' +
      '</tr>';
  }).join('') : emptyRow(7, '–ó–∞–¥–∞—á–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
}

// ============================================================
// RENDER: STAFF
// ============================================================
function renderStaff() {
  const perms = getUserPerms();
  document.getElementById('staff-table').innerHTML = DATA.staff.length ? DATA.staff.map(s => {
    const roleEmoji = (ROLES[s['–†–æ–ª—å']] || {}).emoji || 'üë§';
    return '<tr>' +
      '<td><strong>' + escHtml(s['–ò–º—è'] || '(–Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ)') + '</strong></td>' +
      '<td>' + roleEmoji + ' ' + escHtml(s['–†–æ–ª—å']) + '</td>' +
      '<td>' + escHtml(s['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']) + '</td>' +
      '<td style="font-size:11px">' + (s.Telegram_ID ? '‚úÖ ' + escHtml(s.Telegram_ID) : '‚ùå –Ω–µ—Ç') + '</td>' +
      '<td style="font-size:12px">' + escHtml(s['Email'] || '‚Äî') + '</td>' +
      '<td style="font-size:12px">' + escHtml(s['–¢–µ–ª–µ—Ñ–æ–Ω'] || '‚Äî') + '</td>' +
      '<td>' + statusBadge(s['–°—Ç–∞—Ç—É—Å'] || '–ê–∫—Ç–∏–≤–Ω—ã–π') + '</td>' +
      '<td>' + (perms.canManageStaff ? actionButtons('staff', s.ID, s['–ò–º—è']) : '') + '</td>' +
      '</tr>';
  }).join('') : emptyRow(8, '–ù–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤');
}

// ============================================================
// RENDER: APPROVALS
// ============================================================
function renderApprovals() {
  const el = document.getElementById('approvals-content');
  const perms = getUserPerms();

  if (!perms.canApprove) {
    el.innerHTML = '<div class="empty"><div class="icon">üîí</div><p>–†–∞–∑–¥–µ–ª —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–π –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ CEO.</p></div>';
    return;
  }

  const pending = DATA.approvals.filter(a => (a['–°—Ç–∞—Ç—É—Å'] || '').includes('–û–∂–∏–¥–∞–µ—Ç'));
  const decided = DATA.approvals.filter(a => !(a['–°—Ç–∞—Ç—É—Å'] || '').includes('–û–∂–∏–¥–∞–µ—Ç'));

  let html = '<div class="card"><div class="card-header"><h3>‚è≥ –û–∂–∏–¥–∞—é—Ç —Ä–µ—à–µ–Ω–∏—è (' + pending.length + ')</h3></div>';
  html += '<div class="table-wrap"><table><thead><tr><th>–¢–∏–ø</th><th>–û–ø–∏—Å–∞–Ω–∏–µ</th><th>–û—Ç –∫–æ–≥–æ</th><th>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</th><th>–î–∞—Ç–∞</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead><tbody>';
  html += pending.length ? pending.map(a =>
    '<tr><td>' + escHtml(a['–¢–∏–ø']) + '</td>' +
    '<td>' + escHtml(a['–û–ø–∏—Å–∞–Ω–∏–µ']) + '</td>' +
    '<td>' + escHtml(a['–û—Ç_–∫–æ–≥–æ']) + '</td>' +
    '<td>' + escHtml(a['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']) + '</td>' +
    '<td>' + escHtml(a['–î–∞—Ç–∞_–∑–∞–ø—Ä–æ—Å–∞'] || '') + '</td>' +
    '<td><div class="actions-cell">' +
    '<button class="btn btn-xs btn-approve" onclick="handleApproval(\'' + escAttr(a.ID) + '\',true)">‚úÖ –î–∞</button> ' +
    '<button class="btn btn-xs btn-reject" onclick="handleApproval(\'' + escAttr(a.ID) + '\',false)">‚ùå –ù–µ—Ç</button>' +
    '</div></td></tr>'
  ).join('') : emptyRow(6, '–ù–µ—Ç –æ–∂–∏–¥–∞—é—â–∏—Ö —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–π ‚ú®');
  html += '</tbody></table></div></div>';

  if (decided.length > 0) {
    html += '<div class="card" style="margin-top:16px"><div class="card-header"><h3>üìú –ò—Å—Ç–æ—Ä–∏—è —Ä–µ—à–µ–Ω–∏–π</h3></div>';
    html += '<div class="table-wrap"><table><thead><tr><th>–¢–∏–ø</th><th>–û–ø–∏—Å–∞–Ω–∏–µ</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–∞—Ç–∞ —Ä–µ—à–µ–Ω–∏—è</th></tr></thead><tbody>';
    html += decided.map(a =>
      '<tr><td>' + escHtml(a['–¢–∏–ø']) + '</td><td>' + escHtml(a['–û–ø–∏—Å–∞–Ω–∏–µ']) + '</td><td>' + statusBadge(a['–°—Ç–∞—Ç—É—Å']) + '</td><td>' + escHtml(a['–î–∞—Ç–∞_—Ä–µ—à–µ–Ω–∏—è'] || '') + '</td></tr>'
    ).join('');
    html += '</tbody></table></div></div>';
  }

  el.innerHTML = html;
}

// ============================================================
// RENDER: COMMUNICATIONS
// ============================================================
function renderComms() {
  let data = DATA.comms || [];
  data = filterBySearch(data, 'comm-search', ['–ü–∞—Ä—Ç–Ω—ë—Ä', '–¢–µ–º–∞', '–†–µ–∑—É–ª—å—Ç–∞—Ç']);

  document.getElementById('comms-table').innerHTML = data.length ? data.map(c =>
    '<tr>' +
    '<td><strong>' + escHtml(c['–ü–∞—Ä—Ç–Ω—ë—Ä']) + '</strong></td>' +
    '<td>' + escHtml(c['–¢–∏–ø']) + '</td>' +
    '<td>' + escHtml(c['–¢–µ–º–∞']) + '</td>' +
    '<td style="font-size:12px;max-width:250px;overflow:hidden;text-overflow:ellipsis">' + escHtml(c['–†–µ–∑—É–ª—å—Ç–∞—Ç'] || '') + '</td>' +
    '<td>' + escHtml(c['–î–∞—Ç–∞'] || '‚Äî') + '</td>' +
    '<td style="font-size:12px">' + escHtml(c['–ê–≤—Ç–æ—Ä'] || '‚Äî') + '</td>' +
    '<td>' + actionButtons('comm', c.ID || '', c['–ü–∞—Ä—Ç–Ω—ë—Ä']) + '</td>' +
    '</tr>'
  ).join('') : emptyRow(7, '–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –æ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è—Ö');
}

// ============================================================
// RENDER: SETTINGS
// ============================================================
function renderSettings() {
  const stats = [
    { label: '–ü–∞—Ä—Ç–Ω—ë—Ä—ã', value: DATA.partners.length },
    { label: '–ü—Ä–æ–µ–∫—Ç—ã', value: DATA.projects.length },
    { label: '–ó–∞–¥–∞—á–∏', value: DATA.tasks.length },
    { label: '–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏', value: DATA.staff.length },
    { label: '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è', value: DATA.directions.length },
    { label: '–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è', value: DATA.approvals.length },
    { label: '–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏', value: (DATA.comms || []).length },
    { label: '–í–µ—Ä—Å–∏—è', value: CONFIG.VERSION }
  ];
  document.getElementById('s-stats').innerHTML = stats.map(s =>
    '<div class="detail-item"><div class="detail-label">' + s.label + '</div><div class="detail-value">' + s.value + '</div></div>'
  ).join('');
}

// ============================================================
// MODAL: OPEN / CLOSE
// ============================================================
function openModal(type, existingData) {
  currentModal = type;
  editingItem = existingData || null;
  const def = FORM_DEFS[type];
  if (!def) return;

  // Auto-set direction when inside project workspace
  const autoDir = currentProject || null;

  document.getElementById('modalTitle').textContent =
    (editingItem ? '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å: ' : '‚ûï –î–æ–±–∞–≤–∏—Ç—å: ') + def.title;

  let html = '';
  for (const field of def.fields) {
    const val = editingItem
      ? (editingItem[field.name] || '')
      : (field.name === '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ' && autoDir ? autoDir : '');
    const reqClass = field.required ? 'required' : '';

    html += '<div class="form-group">';
    html += '<label class="' + reqClass + '">' + escHtml(field.name) + '</label>';

    if (field.type === 'select') {
      html += '<select id="field-' + field.name + '">';
      for (const opt of field.options) {
        html += '<option value="' + escAttr(opt) + '"' + (val === opt ? ' selected' : '') + '>' + escHtml(opt) + '</option>';
      }
      html += '</select>';
    } else if (field.type === 'textarea') {
      html += '<textarea id="field-' + field.name + '" placeholder="' + escAttr(field.placeholder || '') + '">' + escHtml(val) + '</textarea>';
    } else {
      html += '<input type="' + field.type + '" id="field-' + field.name + '" value="' + escAttr(val) + '" placeholder="' + escAttr(field.placeholder || '') + '">';
    }
    html += '</div>';
  }

  document.getElementById('modalBody').innerHTML = html;
  document.getElementById('modalOverlay').classList.add('show');

  // Focus first field
  setTimeout(() => {
    const first = document.getElementById('field-' + def.fields[0].name);
    if (first) first.focus();
  }, 200);
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('show');
  currentModal = '';
  editingItem = null;
}

// ============================================================
// MODAL: SAVE
// ============================================================
async function saveModal() {
  const def = FORM_DEFS[currentModal];
  if (!def) return;

  // Validate required fields
  for (const field of def.fields) {
    if (field.required) {
      const el = document.getElementById('field-' + field.name);
      if (!el || !el.value.trim()) {
        toast('‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª–µ ¬´' + field.name + '¬ª', 'warning');
        if (el) el.focus();
        return;
      }
    }
  }

  // Build row
  const row = {};
  if (editingItem) {
    row.ID = editingItem.ID;
  } else {
    row.ID = currentModal.charAt(0).toUpperCase() + String(Date.now()).slice(-6);
  }

  for (const field of def.fields) {
    const el = document.getElementById('field-' + field.name);
    row[field.name] = el ? el.value : '';
  }

  // Auto-fill system fields
  const today = new Date().toISOString().split('T')[0];

  if (def.sheet === '–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏' && !editingItem) {
    row['–°—Ç–∞—Ç—É—Å'] = '–ê–∫—Ç–∏–≤–Ω—ã–π';
    row['–î–∞—Ç–∞_–¥–æ–±–∞–≤–ª–µ–Ω–∏—è'] = today;
  }
  if (def.sheet === '–ü—Ä–æ–µ–∫—Ç—ã') {
    if (!editingItem) row['–°–æ–∑–¥–∞–Ω–æ'] = today;
    row['–û–±–Ω–æ–≤–ª–µ–Ω–æ'] = today;
  }
  if (def.sheet === '–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏') {
    if (!editingItem) {
      row['–î–∞—Ç–∞'] = today;
      row['–ê–≤—Ç–æ—Ä'] = USER ? USER.name : '';
    }
  }

  // Check permissions
  const perms = getUserPerms();
  if (!perms.canWrite && !editingItem) {
    // Send through approval workflow
    const approvalRow = {
      ID: 'APR' + String(Date.now()).slice(-6),
      '–¢–∏–ø': '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ: ' + def.title,
      '–û–ø–∏—Å–∞–Ω–∏–µ': row['–ù–∞–∑–≤–∞–Ω–∏–µ'] || row['–û–ø–∏—Å–∞–Ω–∏–µ'] || row['–ò–º—è'] || row['–ü–∞—Ä—Ç–Ω—ë—Ä'] || '',
      '–û—Ç_–∫–æ–≥–æ': USER ? USER.name : '',
      'Telegram_ID': USER ? USER.tgId : '',
      '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ': row['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] || '',
      '–°—Ç–∞—Ç—É—Å': '‚è≥ –û–∂–∏–¥–∞–µ—Ç',
      '–î–∞—Ç–∞_–∑–∞–ø—Ä–æ—Å–∞': today,
      '–î–∞–Ω–Ω—ã–µ': JSON.stringify(row).substring(0, 500)
    };

    document.getElementById('modalSaveBtn').disabled = true;
    const ok = await apiWrite('–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è', approvalRow);
    document.getElementById('modalSaveBtn').disabled = false;

    if (ok) {
      toast('‚è≥ –ó–∞–ø—Ä–æ—Å –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω CEO', 'info');
      setTimeout(() => loadData(), 1500);
    }
    closeModal();
    return;
  }

  // Direct write for CEO
  document.getElementById('modalSaveBtn').disabled = true;
  const ok = await apiWrite(def.sheet, row);
  document.getElementById('modalSaveBtn').disabled = false;

  if (ok) {
    toast('‚úÖ ' + def.title + ' —Å–æ—Ö—Ä–∞–Ω—ë–Ω!', 'success');
    setTimeout(() => loadData(), 1500);
  }
  closeModal();
}

// ============================================================
// VIEW DETAIL
// ============================================================
function viewItem(type, id) {
  const dataMap = { partner: 'partners', project: 'projects', task: 'tasks', staff: 'staff', comm: 'comms' };
  const key = dataMap[type];
  const item = DATA[key]?.find(i => i.ID === id);
  if (!item) return;

  const title = item['–ù–∞–∑–≤–∞–Ω–∏–µ'] || item['–û–ø–∏—Å–∞–Ω–∏–µ'] || item['–ò–º—è'] || item['–ü–∞—Ä—Ç–Ω—ë—Ä'] || '–î–µ—Ç–∞–ª–∏';
  document.getElementById('detailTitle').textContent = 'üìã ' + title;

  const allFields = Object.entries(item).filter(([k]) => k !== 'row_number');
  let html = '<div class="detail-grid">';
  for (const [key, val] of allFields) {
    if (!val && val !== 0) continue;
    const isLong = String(val).length > 60;
    html += '<div class="detail-item ' + (isLong ? 'detail-full' : '') + '">';
    html += '<div class="detail-label">' + escHtml(key) + '</div>';
    html += '<div class="detail-value">' + escHtml(val) + '</div>';
    html += '</div>';
  }
  html += '</div>';

  document.getElementById('detailBody').innerHTML = html;
  document.getElementById('detailEditBtn').onclick = function () {
    closeDetail();
    editItem(type, id);
  };
  document.getElementById('detailOverlay').classList.add('show');
}

function closeDetail() {
  document.getElementById('detailOverlay').classList.remove('show');
}

// ============================================================
// EDIT ITEM
// ============================================================
function editItem(type, id) {
  const dataMap = { partner: 'partners', project: 'projects', task: 'tasks', staff: 'staff', comm: 'comms' };
  const key = dataMap[type];
  const item = DATA[key]?.find(i => i.ID === id);
  if (item) openModal(type, item);
}

// ============================================================
// DELETE ITEM
// ============================================================
function confirmDelete(type, id, name) {
  const perms = getUserPerms();
  if (!perms.canDelete) {
    toast('‚õî –£–¥–∞–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ CEO', 'error');
    return;
  }

  document.getElementById('confirmTitle').textContent = '–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?';
  document.getElementById('confirmText').textContent = '¬´' + (name || id) + '¬ª –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞. –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.';
  document.getElementById('confirmOverlay').classList.add('show');

  confirmCallback = function (confirmed) {
    if (confirmed) {
      const dataMap = { partner: 'partners', project: 'projects', task: 'tasks', staff: 'staff', comm: 'comms' };
      const key = dataMap[type];
      if (key && DATA[key]) {
        DATA[key] = DATA[key].filter(i => i.ID !== id);
      }
      renderAll();
      toast('üóë –ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞ (–ª–æ–∫–∞–ª—å–Ω–æ)', 'warning');
    }
  };
}

function closeConfirm(result) {
  document.getElementById('confirmOverlay').classList.remove('show');
  if (confirmCallback) {
    confirmCallback(result);
    confirmCallback = null;
  }
}

// ============================================================
// APPROVALS HANDLING
// ============================================================
async function handleApproval(id, approved) {
  const item = DATA.approvals.find(a => a.ID === id);
  if (!item) return;

  const today = new Date().toISOString().split('T')[0];
  item['–°—Ç–∞—Ç—É—Å'] = approved ? '‚úÖ –û–¥–æ–±—Ä–µ–Ω–æ' : '‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ';
  item['–î–∞—Ç–∞_—Ä–µ—à–µ–Ω–∏—è'] = today;
  item['–†–µ—à–µ–Ω–∏–µ_CEO'] = USER ? USER.name : '';

  renderAll();
  toast(approved ? '‚úÖ –û–¥–æ–±—Ä–µ–Ω–æ' : '‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ', approved ? 'success' : 'error');

  // Persist to sheet
  await apiWrite('–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è', item);
}

// ============================================================
// CSV EXPORT
// ============================================================
function exportCSV(type) {
  const dataMap = { partners: DATA.partners, tasks: DATA.tasks, projects: DATA.projects };
  const data = filterByRole(dataMap[type] || []);
  if (!data.length) {
    toast('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'warning');
    return;
  }

  const headers = Object.keys(data[0]).filter(k => k !== 'row_number');
  let csv = '\uFEFF'; // BOM for Excel UTF-8
  csv += headers.join(';') + '\n';
  data.forEach(row => {
    csv += headers.map(h => '"' + String(row[h] || '').replace(/"/g, '""') + '"').join(';') + '\n';
  });

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'RKT_' + type + '_' + new Date().toISOString().split('T')[0] + '.csv';
  a.click();
  URL.revokeObjectURL(url);
  toast('üì• –≠–∫—Å–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω', 'success');
}

// ============================================================
// KEYBOARD SHORTCUTS
// ============================================================
document.addEventListener('keydown', function (e) {
  // Enter on login screen
  if (e.key === 'Enter' && document.getElementById('loginScreen').style.display !== 'none') {
    doLogin();
    return;
  }

  // Escape to close modals
  if (e.key === 'Escape') {
    if (document.getElementById('confirmOverlay').classList.contains('show')) {
      closeConfirm(false);
    } else if (document.getElementById('detailOverlay').classList.contains('show')) {
      closeDetail();
    } else if (document.getElementById('modalOverlay').classList.contains('show')) {
      closeModal();
    }
  }
});

// ============================================================
// INIT
// ============================================================
checkSavedLogin();
</script>
</body>
</html>
