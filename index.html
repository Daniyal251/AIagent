<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RKT HUB ‚Äî –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞–º–∏</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè•</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Unbounded:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
/* ===== CSS VARIABLES ===== */
:root {
  --bg: #0a0e17;
  --bg2: #111827;
  --bg3: #1a2234;
  --bg4: #1f2b3d;
  --accent: #00d4aa;
  --accent2: #00b894;
  --accent-glow: rgba(0, 212, 170, 0.15);
  --red: #ff6b6b;
  --red-glow: rgba(255, 107, 107, 0.15);
  --orange: #ffa94d;
  --orange-glow: rgba(255, 169, 77, 0.15);
  --yellow: #ffd43b;
  --blue: #4dabf7;
  --blue-glow: rgba(75, 171, 247, 0.15);
  --purple: #b197fc;
  --purple-glow: rgba(177, 151, 252, 0.15);
  --green: #51cf66;
  --pink: #f06595;
  --text: #e8ecf1;
  --text2: #8899aa;
  --text3: #5a6a7a;
  --border: #243044;
  --border2: #2d3f56;
  --radius: 12px;
  --radius-sm: 8px;
  --radius-lg: 16px;
  --shadow: 0 4px 30px rgba(0, 0, 0, 0.4);
  --shadow-lg: 0 20px 60px rgba(0, 0, 0, 0.5);
  --transition: all 0.2s ease;
  --sidebar-w: 260px;
}

/* ===== RESET ===== */
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
html { scroll-behavior: smooth; }

body {
  font-family: 'JetBrains Mono', monospace;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
  line-height: 1.5;
}

body::before {
  content: '';
  position: fixed;
  top: -50%; left: -50%;
  width: 200%; height: 200%;
  background:
    radial-gradient(ellipse at 20% 50%, rgba(0, 212, 170, 0.06) 0%, transparent 50%),
    radial-gradient(ellipse at 80% 20%, rgba(75, 171, 247, 0.04) 0%, transparent 50%),
    radial-gradient(ellipse at 50% 80%, rgba(177, 151, 252, 0.03) 0%, transparent 50%);
  z-index: 0;
  pointer-events: none;
}

a { color: var(--accent); text-decoration: none; }
a:hover { text-decoration: underline; }

::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--text2); }

/* ============================================================
   LOGIN SCREEN
   ============================================================ */
.login-screen {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  background: var(--bg);
}

.login-card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 24px;
  padding: 52px 44px;
  width: 440px;
  max-width: 92vw;
  text-align: center;
  box-shadow: var(--shadow-lg);
  position: relative;
  overflow: hidden;
  animation: loginFadeIn 0.5s ease;
}

@keyframes loginFadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.login-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--accent), var(--blue), var(--purple), var(--accent));
  background-size: 300% 100%;
  animation: gradientShift 4s ease infinite;
}

@keyframes gradientShift {
  0%, 100% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
}

.login-icon { font-size: 72px; margin-bottom: 20px; display: block; }

.login-logo {
  font-family: 'Unbounded', sans-serif;
  font-size: 36px;
  font-weight: 900;
  background: linear-gradient(135deg, var(--accent), var(--blue));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  margin-bottom: 6px;
}

.login-sub { color: var(--text2); font-size: 13px; margin-bottom: 36px; }

.login-label {
  display: block;
  text-align: left;
  font-size: 11px;
  color: var(--text2);
  text-transform: uppercase;
  letter-spacing: 2px;
  margin-bottom: 10px;
  font-weight: 600;
}

.login-input {
  width: 100%;
  padding: 16px 20px;
  background: var(--bg);
  border: 2px solid var(--border);
  border-radius: var(--radius);
  color: var(--text);
  font-family: 'JetBrains Mono', monospace;
  font-size: 18px;
  text-align: center;
  letter-spacing: 3px;
  transition: var(--transition);
  margin-bottom: 10px;
}

.login-input:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 4px var(--accent-glow);
}

.login-input::placeholder { color: var(--text3); font-size: 13px; letter-spacing: 0; }

.login-hint { font-size: 11px; color: var(--text2); margin-bottom: 28px; line-height: 1.8; }
.login-hint a { color: var(--accent); font-weight: 600; }

.login-btn {
  width: 100%;
  padding: 16px;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  color: var(--bg);
  border: none;
  border-radius: var(--radius);
  font-family: 'JetBrains Mono', monospace;
  font-size: 15px;
  font-weight: 700;
  cursor: pointer;
  transition: var(--transition);
  letter-spacing: 1.5px;
  text-transform: uppercase;
}

.login-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0, 212, 170, 0.3); }
.login-btn:active { transform: translateY(0); }
.login-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }

.login-error {
  color: var(--red);
  font-size: 13px;
  margin-top: 16px;
  display: none;
  padding: 10px;
  background: var(--red-glow);
  border-radius: var(--radius-sm);
}

/* ============================================================
   APP LAYOUT
   ============================================================ */
.app {
  position: relative;
  z-index: 1;
  display: flex;
  min-height: 100vh;
}

/* ===== SIDEBAR ===== */
.sidebar {
  width: var(--sidebar-w);
  background: var(--bg2);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  position: fixed;
  top: 0; left: 0; bottom: 0;
  z-index: 100;
  transition: transform 0.3s ease;
  overflow-y: auto;
}

.logo-section {
  padding: 28px 24px 20px;
  border-bottom: 1px solid var(--border);
}

.logo-section h1 {
  font-family: 'Unbounded', sans-serif;
  font-size: 22px;
  font-weight: 900;
  background: linear-gradient(135deg, var(--accent), var(--blue));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.logo-section .subtitle { font-size: 11px; color: var(--text2); margin-top: 4px; }

.nav { flex: 1; padding: 12px; }

.nav-section {
  font-size: 10px;
  color: var(--text3);
  text-transform: uppercase;
  letter-spacing: 2.5px;
  padding: 20px 12px 8px;
  font-weight: 600;
}

.nav-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 11px 14px;
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: var(--transition);
  font-size: 13px;
  color: var(--text2);
  text-decoration: none;
  margin-bottom: 2px;
  position: relative;
}

.nav-item:hover { background: var(--bg3); color: var(--text); text-decoration: none; }
.nav-item.active { background: var(--accent-glow); color: var(--accent); }

.nav-item.active::before {
  content: '';
  position: absolute;
  left: 0; top: 25%; bottom: 25%;
  width: 3px;
  background: var(--accent);
  border-radius: 0 3px 3px 0;
}

.nav-item .icon { font-size: 18px; width: 26px; text-align: center; flex-shrink: 0; }
.nav-item .label { flex: 1; }

.nav-item .badge {
  background: var(--accent);
  color: var(--bg);
  font-size: 10px;
  font-weight: 700;
  padding: 2px 8px;
  border-radius: 12px;
  min-width: 22px;
  text-align: center;
}

.nav-item .badge-orange { background: var(--orange); }
.nav-item .badge-red { background: var(--red); }
.nav-item.hidden { display: none; }

/* User bar */
.user-bar {
  padding: 16px 20px;
  border-top: 1px solid var(--border);
  background: var(--bg3);
}

.user-info { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }

.user-avatar {
  width: 40px; height: 40px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--accent), var(--blue));
  display: flex; align-items: center; justify-content: center;
  font-size: 18px; font-weight: 700; color: var(--bg); flex-shrink: 0;
}

.user-name { font-size: 13px; font-weight: 600; line-height: 1.3; }
.user-role-text { font-size: 11px; color: var(--text2); }

.logout-btn {
  width: 100%;
  padding: 9px;
  background: transparent;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text2);
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}

.logout-btn:hover { border-color: var(--red); color: var(--red); background: var(--red-glow); }

/* ===== MAIN ===== */
.main {
  flex: 1;
  margin-left: var(--sidebar-w);
  padding: 32px 36px 60px;
  max-width: 1400px;
  min-height: 100vh;
}

/* ===== PAGE HEADER ===== */
.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 28px;
  flex-wrap: wrap;
  gap: 12px;
}

.page-header h2 {
  font-family: 'Unbounded', sans-serif;
  font-size: 26px;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 12px;
}

.page-header .actions { display: flex; gap: 8px; flex-wrap: wrap; }

/* ===== BREADCRUMB ===== */
.breadcrumb {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 18px;
  font-size: 12px;
  color: var(--text2);
}

.breadcrumb a { cursor: pointer; color: var(--text2); transition: var(--transition); }
.breadcrumb a:hover { color: var(--accent); text-decoration: none; }
.breadcrumb .sep { color: var(--text3); }
.breadcrumb .current { color: var(--text); font-weight: 600; }

/* ===== BUTTONS ===== */
.btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 20px;
  border-radius: var(--radius-sm);
  border: none;
  cursor: pointer;
  font-family: 'JetBrains Mono', monospace;
  font-size: 13px;
  font-weight: 600;
  transition: var(--transition);
  white-space: nowrap;
}

.btn-primary {
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  color: var(--bg);
}

.btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(0, 212, 170, 0.3); }

.btn-secondary {
  background: var(--bg3);
  color: var(--text);
  border: 1px solid var(--border);
}

.btn-secondary:hover { border-color: var(--accent); color: var(--accent); }

.btn-danger {
  background: var(--red-glow);
  color: var(--red);
  border: 1px solid rgba(255, 107, 107, 0.3);
}

.btn-danger:hover { background: rgba(255, 107, 107, 0.25); }

.btn-sm { padding: 6px 14px; font-size: 11px; }
.btn-xs { padding: 4px 10px; font-size: 10px; }
.btn-approve { background: var(--accent-glow); color: var(--accent); border: 1px solid rgba(0, 212, 170, 0.3); }
.btn-reject { background: var(--red-glow); color: var(--red); border: 1px solid rgba(255, 107, 107, 0.3); }

.btn-ai {
  background: linear-gradient(135deg, var(--purple), #7950f2);
  color: #fff;
}

.btn-ai:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 15px var(--purple-glow);
}

/* ============================================================
   PROJECT GRID ‚Äî Main screen
   ============================================================ */
.project-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
  gap: 20px;
  margin-bottom: 28px;
}

.project-card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  overflow: hidden;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
}

.project-card:hover {
  border-color: var(--accent);
  transform: translateY(-4px);
  box-shadow: 0 12px 40px rgba(0, 212, 170, 0.15);
}

.project-card-top {
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 4px;
}

.project-card-header {
  padding: 28px 28px 16px;
  position: relative;
}

.project-card-header .emoji {
  font-size: 52px;
  margin-bottom: 14px;
  display: block;
  filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
}

.project-card-header h3 {
  font-family: 'Unbounded', sans-serif;
  font-size: 22px;
  font-weight: 700;
  margin-bottom: 6px;
}

.project-card-header .desc {
  font-size: 12px;
  color: var(--text2);
  line-height: 1.6;
}

.project-card-stats {
  padding: 0 28px 12px;
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 10px;
}

.pcs { text-align: center; padding: 10px 0; }

.pcs .v {
  font-family: 'Unbounded', sans-serif;
  font-size: 24px;
  font-weight: 800;
}

.pcs .l { font-size: 10px; color: var(--text2); margin-top: 2px; }

.project-card-progress {
  padding: 0 28px 24px;
}

.project-card-progress .bar {
  height: 6px;
  background: var(--bg);
  border-radius: 3px;
  overflow: hidden;
}

.project-card-progress .fill {
  height: 100%;
  border-radius: 3px;
  transition: width 0.6s ease;
}

.project-card-progress .info {
  display: flex;
  justify-content: space-between;
  margin-top: 6px;
  font-size: 11px;
  color: var(--text2);
}

.status-tag {
  position: absolute;
  top: 18px; right: 18px;
  font-size: 10px;
  padding: 4px 10px;
  border-radius: 12px;
  font-weight: 600;
}

/* Add new project card */
.project-card.add-card {
  border: 2px dashed var(--border);
  background: transparent;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 260px;
  flex-direction: column;
  gap: 12px;
}

.project-card.add-card:hover {
  border-color: var(--accent);
  background: var(--accent-glow);
}

.project-card.add-card .add-icon {
  font-size: 48px;
  opacity: 0.5;
}

.project-card.add-card .add-text {
  font-size: 14px;
  color: var(--text2);
  font-weight: 600;
}

/* ===== SUBPROJECT GRID ===== */
.subproject-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
}

.subproject-card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 22px;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.subproject-card:hover {
  border-color: var(--accent);
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(0, 212, 170, 0.1);
}

.subproject-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 3px;
}

.subproject-card .sp-emoji { font-size: 36px; margin-bottom: 10px; display: block; }

.subproject-card h4 {
  font-family: 'Unbounded', sans-serif;
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 4px;
}

.subproject-card .sp-desc {
  font-size: 11px;
  color: var(--text2);
  line-height: 1.5;
  margin-bottom: 12px;
}

.subproject-card .sp-stats {
  display: flex;
  gap: 16px;
  font-size: 11px;
  color: var(--text2);
}

.subproject-card .sp-stats span {
  display: flex;
  align-items: center;
  gap: 4px;
}

.subproject-card.add-sub {
  border: 2px dashed var(--border);
  background: transparent;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  gap: 8px;
  min-height: 160px;
}

.subproject-card.add-sub:hover {
  border-color: var(--accent);
  background: var(--accent-glow);
}

/* ===== METRICS ===== */
.metrics {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 16px;
  margin-bottom: 28px;
}

.metric-card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 22px;
  position: relative;
  overflow: hidden;
  transition: var(--transition);
}

.metric-card:hover {
  border-color: var(--border2);
  transform: translateY(-2px);
  box-shadow: var(--shadow);
}

.metric-card::after {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 3px;
}

.metric-card:nth-child(1)::after { background: linear-gradient(90deg, var(--accent), var(--accent2)); }
.metric-card:nth-child(2)::after { background: linear-gradient(90deg, var(--blue), #228be6); }
.metric-card:nth-child(3)::after { background: linear-gradient(90deg, var(--orange), #fd7e14); }
.metric-card:nth-child(4)::after { background: linear-gradient(90deg, var(--purple), #7950f2); }
.metric-card:nth-child(5)::after { background: linear-gradient(90deg, var(--green), #37b24d); }

.metric-card .m-icon { font-size: 30px; margin-bottom: 10px; }
.metric-card .m-value { font-family: 'Unbounded', sans-serif; font-size: 32px; font-weight: 900; line-height: 1; }
.metric-card .m-label { font-size: 12px; color: var(--text2); margin-top: 6px; }
.metric-card .m-sub { font-size: 10px; color: var(--text3); margin-top: 4px; }

/* ===== CARDS & TABLES ===== */
.card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  margin-bottom: 24px;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 22px;
  border-bottom: 1px solid var(--border);
  background: rgba(26, 34, 52, 0.5);
}

.card-header h3 {
  font-size: 15px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}

.table-wrap { overflow-x: auto; }

table { width: 100%; border-collapse: collapse; font-size: 13px; }

thead th {
  text-align: left;
  padding: 12px 18px;
  color: var(--text2);
  font-weight: 600;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 1.2px;
  border-bottom: 1px solid var(--border);
  background: var(--bg3);
  white-space: nowrap;
  position: sticky;
  top: 0;
  z-index: 2;
}

tbody td {
  padding: 13px 18px;
  border-bottom: 1px solid rgba(36, 48, 68, 0.4);
  vertical-align: middle;
}

tbody tr { transition: background 0.15s; }
tbody tr:hover td { background: rgba(0, 212, 170, 0.03); }
tbody tr:last-child td { border-bottom: none; }

/* ===== STATUS & BADGES ===== */
.status {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 600;
  white-space: nowrap;
}

.s-active { background: var(--accent-glow); color: var(--accent); }
.s-talks { background: var(--orange-glow); color: var(--orange); }
.s-research { background: var(--blue-glow); color: var(--blue); }
.s-pause { background: rgba(136, 153, 170, 0.15); color: var(--text2); }
.s-urgent { background: var(--red-glow); color: var(--red); }
.s-work { background: var(--purple-glow); color: var(--purple); }
.s-done { background: rgba(81, 207, 102, 0.15); color: var(--green); }

.p1 { color: var(--red); font-weight: 700; }
.p2 { color: var(--orange); font-weight: 600; }
.p3 { color: var(--text2); }

.progress-wrap { display: flex; align-items: center; gap: 10px; }

.progress-bar {
  width: 90px; height: 7px;
  background: var(--bg);
  border-radius: 4px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  border-radius: 4px;
  transition: width 0.5s ease;
}

.progress-text { font-size: 11px; color: var(--text2); font-weight: 600; min-width: 30px; }

/* ===== ACTION BUTTONS ===== */
.actions-cell { display: flex; gap: 5px; }

.act-btn {
  width: 30px; height: 30px;
  display: flex; align-items: center; justify-content: center;
  border-radius: 6px;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text2);
  cursor: pointer;
  font-size: 14px;
  transition: var(--transition);
}

.act-btn:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-glow); }
.act-btn.del:hover { border-color: var(--red); color: var(--red); background: var(--red-glow); }
.act-btn.view:hover { border-color: var(--blue); color: var(--blue); background: var(--blue-glow); }
.act-btn.ai:hover { border-color: var(--purple); color: var(--purple); background: var(--purple-glow); }

/* ===== FILTERS ===== */
.filters-bar {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-bottom: 18px;
  align-items: center;
}

.filter-chip {
  padding: 7px 16px;
  border-radius: 20px;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text2);
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px;
  cursor: pointer;
  transition: var(--transition);
}

.filter-chip:hover { border-color: var(--accent); color: var(--text); }
.filter-chip.active { background: var(--accent-glow); border-color: var(--accent); color: var(--accent); font-weight: 600; }

.search-input {
  padding: 8px 16px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 20px;
  color: var(--text);
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px;
  width: 220px;
  transition: var(--transition);
}

.search-input:focus { outline: none; border-color: var(--accent); width: 280px; }
.search-input::placeholder { color: var(--text3); }

/* ===== TABS ===== */
.tabs {
  display: flex;
  gap: 4px;
  border-bottom: 1px solid var(--border);
  margin-bottom: 20px;
  overflow-x: auto;
}

.tab {
  padding: 10px 18px;
  font-size: 12px;
  color: var(--text2);
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: var(--transition);
  white-space: nowrap;
  font-family: 'JetBrains Mono', monospace;
}

.tab:hover { color: var(--text); }
.tab.active { color: var(--accent); border-bottom-color: var(--accent); font-weight: 600; }

/* ============================================================
   AI CHAT PANEL ‚Äî Inside task view
   ============================================================ */
.ai-panel {
  background: var(--bg2);
  border: 1px solid var(--purple);
  border-radius: var(--radius);
  overflow: hidden;
  margin-top: 20px;
}

.ai-panel-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 20px;
  background: linear-gradient(135deg, rgba(177, 151, 252, 0.1), rgba(121, 80, 242, 0.05));
  border-bottom: 1px solid rgba(177, 151, 252, 0.2);
}

.ai-panel-header h4 {
  font-size: 14px;
  font-weight: 600;
  color: var(--purple);
  display: flex;
  align-items: center;
  gap: 8px;
}

.ai-chat-messages {
  padding: 16px 20px;
  max-height: 400px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.ai-msg {
  padding: 12px 16px;
  border-radius: var(--radius-sm);
  font-size: 13px;
  line-height: 1.6;
  max-width: 90%;
  animation: fadeInMsg 0.3s ease;
}

@keyframes fadeInMsg {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

.ai-msg.assistant {
  background: rgba(177, 151, 252, 0.08);
  border: 1px solid rgba(177, 151, 252, 0.15);
  color: var(--text);
  align-self: flex-start;
}

.ai-msg.user {
  background: var(--accent-glow);
  border: 1px solid rgba(0, 212, 170, 0.2);
  color: var(--text);
  align-self: flex-end;
}

.ai-msg.system {
  background: var(--bg3);
  border: 1px solid var(--border);
  color: var(--text2);
  font-size: 12px;
  text-align: center;
  align-self: center;
}

.ai-suggestions {
  padding: 12px 20px;
  border-top: 1px solid rgba(177, 151, 252, 0.15);
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.ai-suggestion-btn {
  padding: 6px 14px;
  border-radius: 20px;
  border: 1px solid rgba(177, 151, 252, 0.3);
  background: rgba(177, 151, 252, 0.05);
  color: var(--purple);
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  cursor: pointer;
  transition: var(--transition);
}

.ai-suggestion-btn:hover {
  background: rgba(177, 151, 252, 0.15);
  border-color: var(--purple);
}

.ai-input-area {
  display: flex;
  gap: 8px;
  padding: 14px 20px;
  border-top: 1px solid rgba(177, 151, 252, 0.15);
  background: rgba(26, 34, 52, 0.5);
}

.ai-input {
  flex: 1;
  padding: 10px 16px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text);
  font-family: 'JetBrains Mono', monospace;
  font-size: 13px;
  transition: var(--transition);
}

.ai-input:focus {
  outline: none;
  border-color: var(--purple);
  box-shadow: 0 0 0 3px var(--purple-glow);
}

.ai-input::placeholder { color: var(--text3); }

.ai-send-btn {
  padding: 10px 18px;
  background: linear-gradient(135deg, var(--purple), #7950f2);
  color: #fff;
  border: none;
  border-radius: var(--radius-sm);
  font-family: 'JetBrains Mono', monospace;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
}

.ai-send-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 15px var(--purple-glow); }
.ai-send-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

/* Loading dots animation */
.ai-loading { display: flex; gap: 4px; padding: 8px 0; }
.ai-loading span {
  width: 8px; height: 8px;
  border-radius: 50%;
  background: var(--purple);
  animation: aiDots 1.4s infinite both;
}
.ai-loading span:nth-child(2) { animation-delay: 0.2s; }
.ai-loading span:nth-child(3) { animation-delay: 0.4s; }

@keyframes aiDots {
  0%, 80%, 100% { opacity: 0.3; transform: scale(0.8); }
  40% { opacity: 1; transform: scale(1); }
}

/* ============================================================
   TASK DETAIL VIEW
   ============================================================ */
.task-detail {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  overflow: hidden;
}

.task-detail-header {
  padding: 28px;
  border-bottom: 1px solid var(--border);
  background: rgba(26, 34, 52, 0.5);
}

.task-detail-header h3 {
  font-family: 'Unbounded', sans-serif;
  font-size: 20px;
  font-weight: 700;
  margin-bottom: 12px;
}

.task-meta {
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
  font-size: 12px;
  color: var(--text2);
}

.task-meta .meta-item {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 4px 12px;
  background: var(--bg);
  border-radius: 20px;
}

.task-detail-body {
  padding: 28px;
}

.task-detail-body .detail-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin-bottom: 20px;
}

.task-steps {
  margin-top: 20px;
}

.task-steps h4 {
  font-size: 14px;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.task-step {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 12px 0;
  border-bottom: 1px solid rgba(36, 48, 68, 0.4);
}

.task-step:last-child { border-bottom: none; }

.task-step .step-check {
  width: 22px; height: 22px;
  border-radius: 50%;
  border: 2px solid var(--border);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  transition: var(--transition);
  flex-shrink: 0;
  margin-top: 2px;
}

.task-step .step-check:hover { border-color: var(--accent); }
.task-step .step-check.done { border-color: var(--green); background: var(--green); color: var(--bg); }
.task-step .step-text { font-size: 13px; line-height: 1.5; }
.task-step .step-text.done { text-decoration: line-through; color: var(--text3); }

.tab-sm { padding: 4px 12px; font-size: 11px; }
/* ===== SITE GENERATOR ===== */
.sg-form { display: flex; flex-direction: column; gap: 16px; }
.sg-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
@media (max-width: 600px) { .sg-row { grid-template-columns: 1fr; } }
.sg-field { display: flex; flex-direction: column; gap: 6px; }
.sg-field label { font-size: 12px; color: var(--text2); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
.sg-field input, .sg-field textarea, .sg-field select {
  background: var(--bg2); border: 1px solid var(--border); border-radius: var(--radius-sm);
  padding: 10px 14px; color: var(--text); font-family: inherit; font-size: 13px;
  transition: var(--transition);
}
.sg-field input:focus, .sg-field textarea:focus, .sg-field select:focus {
  outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow);
}
.sg-field textarea { resize: vertical; min-height: 60px; }
.sg-field select { cursor: pointer; }
.site-preview-frame {
  border: 2px solid var(--border); border-radius: var(--radius-lg); overflow: hidden;
  margin-top: 12px; box-shadow: var(--shadow-lg); background: #fff;
}
.spinner { width: 40px; height: 40px; border: 4px solid var(--border); border-top-color: var(--accent);
  border-radius: 50%; animation: spin 0.8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* ===== MODAL ===== */
.modal-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.75);
  backdrop-filter: blur(6px);
  z-index: 1000;
  justify-content: center;
  align-items: center;
}

.modal-overlay.show { display: flex; }

.modal {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  width: 560px;
  max-width: 92vw;
  max-height: 88vh;
  overflow-y: auto;
  box-shadow: var(--shadow-lg);
  animation: slideUp 0.25s ease;
}
.modal.wide { width: 720px; }
.form-section-title { font-size: 13px; font-weight: 700; color: var(--accent); margin: 18px 0 10px; padding-top: 14px; border-top: 1px solid var(--border); }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

@keyframes slideUp {
  from { opacity: 0; transform: translateY(30px); }
  to { opacity: 1; transform: translateY(0); }
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 22px 28px;
  border-bottom: 1px solid var(--border);
  background: rgba(26, 34, 52, 0.5);
}

.modal-header h3 {
  font-family: 'Unbounded', sans-serif;
  font-size: 17px;
  font-weight: 700;
}

.modal-close {
  width: 34px; height: 34px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text2);
  cursor: pointer;
  font-size: 20px;
  display: flex; align-items: center; justify-content: center;
  transition: var(--transition);
}

.modal-close:hover { color: var(--red); border-color: var(--red); background: var(--red-glow); }

.modal-body { padding: 28px; }

.form-group { margin-bottom: 18px; }

.form-group label {
  display: block;
  font-size: 11px;
  color: var(--text2);
  margin-bottom: 7px;
  text-transform: uppercase;
  letter-spacing: 1.2px;
  font-weight: 600;
}

.form-group .required::after { content: ' *'; color: var(--red); }

.form-group input,
.form-group select,
.form-group textarea {
  width: 100%;
  padding: 11px 16px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text);
  font-family: 'JetBrains Mono', monospace;
  font-size: 13px;
  transition: var(--transition);
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-glow);
}

.form-group textarea { min-height: 90px; resize: vertical; }
.form-group select { cursor: pointer; }
.form-group select option { background: var(--bg2); color: var(--text); }

.modal-footer {
  padding: 18px 28px;
  border-top: 1px solid var(--border);
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  background: rgba(26, 34, 52, 0.3);
}

/* Detail grid for modals */
.detail-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}

.detail-item {
  padding: 12px;
  background: var(--bg);
  border-radius: var(--radius-sm);
}

.detail-label {
  font-size: 10px;
  color: var(--text3);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 4px;
}

.detail-value { font-size: 13px; color: var(--text); word-break: break-word; }
.detail-full { grid-column: 1 / -1; }

/* ===== CONFIRM DIALOG ===== */
.confirm-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  z-index: 1100;
  justify-content: center;
  align-items: center;
}

.confirm-overlay.show { display: flex; }

.confirm-box {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 32px;
  width: 400px;
  max-width: 90vw;
  text-align: center;
  box-shadow: var(--shadow-lg);
}

.confirm-box .icon { font-size: 40px; margin-bottom: 16px; }
.confirm-box h4 { font-size: 16px; margin-bottom: 8px; }
.confirm-box p { color: var(--text2); font-size: 13px; margin-bottom: 24px; }
.confirm-actions { display: flex; gap: 10px; justify-content: center; }

/* ===== TOAST ===== */
.toast {
  position: fixed;
  bottom: 28px; right: 28px;
  padding: 14px 24px;
  border-radius: var(--radius-sm);
  font-size: 13px;
  font-weight: 600;
  transform: translateY(100px);
  opacity: 0;
  transition: all 0.35s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  z-index: 2000;
  max-width: 400px;
  box-shadow: var(--shadow);
}

.toast.show { transform: translateY(0); opacity: 1; }
.toast-success { background: var(--accent); color: var(--bg); }
.toast-error { background: var(--red); color: #fff; }
.toast-warning { background: var(--orange); color: var(--bg); }
.toast-info { background: var(--blue); color: var(--bg); }

/* ===== PAGES ===== */
.page { display: none; }
.page.active { display: block; animation: pageIn 0.3s ease; }

@keyframes pageIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.empty { text-align: center; padding: 50px; color: var(--text2); }
.empty .icon { font-size: 44px; margin-bottom: 14px; opacity: 0.6; }
.empty p { font-size: 14px; }

/* ===== STATUS BAR ===== */
.status-bar {
  position: fixed;
  bottom: 0; left: 0; right: 0;
  background: var(--bg2);
  border-top: 1px solid var(--border);
  padding: 6px 24px;
  display: flex;
  justify-content: space-between;
  font-size: 11px;
  color: var(--text3);
  z-index: 50;
}

.status-bar .dot {
  display: inline-block;
  width: 7px; height: 7px;
  border-radius: 50%;
  margin-right: 6px;
}

.dot-green { background: var(--accent); }
.dot-red { background: var(--red); }

/* ===== MOBILE ===== */
.mobile-toggle { display: none; }

@media (max-width: 900px) {
  .sidebar { transform: translateX(-100%); width: 280px; }
  .sidebar.open { transform: translateX(0); box-shadow: var(--shadow-lg); }
  .main { margin-left: 0; padding: 20px 16px 60px; }
  .metrics { grid-template-columns: repeat(2, 1fr); }
  .project-grid { grid-template-columns: 1fr; }
  .subproject-grid { grid-template-columns: 1fr; }
  .detail-grid { grid-template-columns: 1fr; }
  .page-header h2 { font-size: 20px; }
  .task-detail-body .detail-grid { grid-template-columns: 1fr; }
  .form-row { grid-template-columns: 1fr; }
  .modal.wide { width: 95vw; }
  #aiGlobalPanel { width: calc(100vw - 32px) !important; right: 16px !important; bottom: 16px !important; height: 70vh !important; }

  .mobile-toggle {
    display: flex !important;
    position: fixed;
    top: 14px; left: 14px;
    z-index: 200;
    width: 44px; height: 44px;
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    align-items: center; justify-content: center;
    cursor: pointer;
    color: var(--text);
    font-size: 22px;
    box-shadow: var(--shadow);
  }
}
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div class="login-screen" id="loginScreen">
  <div class="login-card">
    <span class="login-icon">üè•</span>
    <div class="login-logo">RKT HUB</div>
    <div class="login-sub">–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞–º–∏</div>

    <!-- LOGIN TAB -->
    <div id="loginTab">
      <label class="login-label">–í–∞—à Telegram ID</label>
      <input class="login-input" id="loginTgId" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 1144907578" autofocus>
      <div class="login-hint">
        –£–∑–Ω–∞–π—Ç–µ —Å–≤–æ–π ID: –Ω–∞–ø–∏—à–∏—Ç–µ <a href="https://t.me/userinfobot" target="_blank">@userinfobot</a> –≤ Telegram
      </div>
      <button class="login-btn" id="loginBtn" onclick="doLogin()">
        <span id="loginBtnText">–í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</span>
      </button>
      <div class="login-error" id="loginError"></div>
      <div style="margin-top:16px;text-align:center">
        <a href="#" onclick="toggleRegForm();return false" style="color:var(--accent);font-size:13px">üìù –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
      </div>
    </div>

    <!-- REGISTER TAB -->
    <div id="registerTab" style="display:none">
      <label class="login-label">üë§ –§–ò–û *</label>
      <input class="login-input" id="regName" type="text" placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á">
      <label class="login-label" style="margin-top:8px">üì± Telegram ID *</label>
      <input class="login-input" id="regTgId" type="text" placeholder="–£–∑–Ω–∞–π—Ç–µ —É @userinfobot">
      <label class="login-label" style="margin-top:8px">üìû –¢–µ–ª–µ—Ñ–æ–Ω</label>
      <input class="login-input" id="regPhone" type="text" placeholder="+7 900 123-45-67">
      <label class="login-label" style="margin-top:8px">üìß Email</label>
      <input class="login-input" id="regEmail" type="text" placeholder="email@example.com">
      <label class="login-label" style="margin-top:8px">üíº –†–æ–ª—å</label>
      <select class="login-input" id="regRole" style="padding:10px 16px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-size:14px">
        <option value="–ú–µ–Ω–µ–¥–∂–µ—Ä">–ú–µ–Ω–µ–¥–∂–µ—Ä</option>
        <option value="–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å">–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å</option>
        <option value="–ò–Ω–∂–µ–Ω–µ—Ä">–ò–Ω–∂–µ–Ω–µ—Ä</option>
        <option value="–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫">–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫</option>
      </select>
      <label class="login-label" style="margin-top:8px">üìÇ –ü—Ä–æ–µ–∫—Ç</label>
      <select class="login-input" id="regProject" style="padding:10px 16px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-size:14px">
        <option value="–†–ö–¢">–†–ö–¢</option>
        <option value="–°–∞–π—Ç—ã">–°–∞–π—Ç—ã</option>
      </select>
      <button class="login-btn" style="margin-top:12px" onclick="doRegister()">
        <span id="regBtnText">üìù –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</span>
      </button>
      <div class="login-error" id="regError"></div>
      <div style="margin-top:12px;text-align:center">
        <a href="#" onclick="toggleRegForm();return false" style="color:var(--accent);font-size:13px">‚Üê –£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏</a>
      </div>
    </div>
  </div>
</div>

<button class="mobile-toggle" id="mobileToggle" onclick="toggleSidebar()">‚ò∞</button>

<!-- MAIN APP -->
<div class="app" id="mainApp" style="display:none">

  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="logo-section">
      <h1>RKT HUB</h1>
      <div class="subtitle">v6.0 ‚Ä¢ –ü—Ä–æ–µ–∫—Ç—ã + –ò–ò</div>
    </div>

    <nav class="nav">
      <div class="nav-section">–ì–ª–∞–≤–Ω–æ–µ</div>
      <a class="nav-item active" onclick="showPage('home')" data-page="home">
        <span class="icon">üè†</span><span class="label">–ü—Ä–æ–µ–∫—Ç—ã</span>
      </a>
      <a class="nav-item" onclick="showPage('dashboard')" data-page="dashboard">
        <span class="icon">üìä</span><span class="label">–î–∞—à–±–æ—Ä–¥ –ì–î</span>
      </a>
      <a class="nav-item" onclick="toggleAiPanel()" data-page="ai" style="border:1px solid rgba(177,151,252,0.2)">
        <span class="icon">ü§ñ</span><span class="label">–ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç</span>
        <span class="badge" style="background:var(--purple)">AI</span>
      </a>

      <div class="nav-section">–î–∞–Ω–Ω—ã–µ</div>
      <a class="nav-item" onclick="showPage('partners')" data-page="partners">
        <span class="icon">ü§ù</span><span class="label">–ü–∞—Ä—Ç–Ω—ë—Ä—ã</span>
        <span class="badge" id="badge-partners">0</span>
      </a>
      <a class="nav-item" onclick="showPage('tasks')" data-page="tasks">
        <span class="icon">‚úÖ</span><span class="label">–ó–∞–¥–∞—á–∏</span>
        <span class="badge" id="badge-tasks">0</span>
      </a>
      <a class="nav-item" onclick="showPage('comms')" data-page="comms">
        <span class="icon">üí¨</span><span class="label">–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏</span>
      </a>

      <div class="nav-section">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>
      <a class="nav-item" onclick="showPage('staff')" data-page="staff" id="nav-staff">
        <span class="icon">üë•</span><span class="label">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</span>
      </a>
      <a class="nav-item" onclick="showPage('approvals')" data-page="approvals" id="nav-approvals">
        <span class="icon">üìã</span><span class="label">–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è</span>
        <span class="badge badge-orange" id="badge-approvals">0</span>
      </a>

      <div class="nav-section">–°–∏—Å—Ç–µ–º–∞</div>
      <a class="nav-item" onclick="showPage('settings')" data-page="settings">
        <span class="icon">‚öôÔ∏è</span><span class="label">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
      </a>
    </nav>

    <div class="user-bar" id="userBar">
      <div class="user-info">
        <div class="user-avatar" id="userAvatar">?</div>
        <div>
          <div class="user-name" id="userName">‚Äî</div>
          <div class="user-role-text" id="userRoleText">‚Äî</div>
        </div>
      </div>
      <button class="logout-btn" onclick="doLogout()">üö™ –í—ã–π—Ç–∏</button>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="main">

    <!-- ======== HOME: TOP-LEVEL PROJECTS ======== -->
    <div class="page active" id="page-home">
      <div class="page-header">
        <h2>üè† –ú–æ–∏ –ø—Ä–æ–µ–∫—Ç—ã</h2>
        <div class="actions">
          <button class="btn" onclick="toggleAiPanel()" style="background:linear-gradient(135deg,var(--purple),#7950f2);color:#fff">ü§ñ –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç</button>
          <button class="btn btn-secondary" onclick="loadData()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
      </div>
      <div class="metrics" id="home-metrics"></div>
      <div class="project-grid" id="project-grid"></div>
    </div>

    <!-- ======== PROJECT VIEW (subprojects) ======== -->
    <div class="page" id="page-project">
      <div class="breadcrumb">
        <a onclick="showPage('home')">üè† –ü—Ä–æ–µ–∫—Ç—ã</a>
        <span class="sep">‚Ä∫</span>
        <span class="current" id="pv-name">‚Äî</span>
      </div>
      <div class="page-header">
        <h2 id="pv-title">üìÅ –ü—Ä–æ–µ–∫—Ç</h2>
        <div class="actions">
          <button class="btn btn-primary" id="btn-add-sub" onclick="openAddSubproject()">+ –ü–æ–¥–ø—Ä–æ–µ–∫—Ç</button>
          <button class="btn btn-primary" id="btn-quick-site" onclick="openQuickSiteTask()" style="display:none;background:linear-gradient(135deg,#FF6B35,#F7931E)">üåê + –ö–ª–∏–µ–Ω—Ç (—Å—Å—ã–ª–∫–∞)</button>
          <button class="btn btn-primary" onclick="openModal('task')">+ –ó–∞–¥–∞—á–∞</button>
          <button class="btn btn-secondary" onclick="openModal('partner')">+ –ü–∞—Ä—Ç–Ω—ë—Ä</button>
        </div>
      </div>
      <div class="metrics" id="pv-metrics"></div>
      <div class="subproject-grid" id="subproject-grid"></div>

      <!-- Project-level tabs -->
      <div class="tabs" id="pv-tabs">
        <div class="tab active" data-tab="overview" onclick="showPvTab('overview')">üìä –û–±–∑–æ—Ä</div>
        <div class="tab" data-tab="tasks" onclick="showPvTab('tasks')">‚úÖ –ó–∞–¥–∞—á–∏</div>
        <div class="tab" data-tab="partners" onclick="showPvTab('partners')">ü§ù –ü–∞—Ä—Ç–Ω—ë—Ä—ã</div>
        <div class="tab" data-tab="staff" onclick="showPvTab('staff')">üë• –ö–æ–º–∞–Ω–¥–∞</div>
        <div class="tab" data-tab="timeline" onclick="showPvTab('timeline')">üìÖ –ü–ª–∞–Ω-–≥—Ä–∞—Ñ–∏–∫</div>
        <div class="tab" data-tab="comms" onclick="showPvTab('comms')">üí¨ –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏</div>
      </div>
      <div id="pv-content"></div>
    </div>

    <!-- ======== SUBPROJECT VIEW (workspace) ======== -->
    <div class="page" id="page-subproject">
      <div class="breadcrumb">
        <a onclick="showPage('home')">üè† –ü—Ä–æ–µ–∫—Ç—ã</a>
        <span class="sep">‚Ä∫</span>
        <a onclick="openProject(currentProject)" id="sp-parent">‚Äî</a>
        <span class="sep">‚Ä∫</span>
        <span class="current" id="sp-name">‚Äî</span>
      </div>
      <div class="page-header">
        <h2 id="sp-title">üìÅ –ü–æ–¥–ø—Ä–æ–µ–∫—Ç</h2>
        <div class="actions">
          <button class="btn btn-primary" onclick="openModal('task')">+ –ó–∞–¥–∞—á–∞</button>
          <button class="btn btn-primary" onclick="openModal('partner')">+ –ü–∞—Ä—Ç–Ω—ë—Ä</button>
          <button class="btn btn-secondary" onclick="openModal('comm')">+ –ö–æ–Ω—Ç–∞–∫—Ç</button>
        </div>
      </div>
      <div class="metrics" id="sp-metrics"></div>

      <div class="tabs" id="sp-tabs">
        <div class="tab active" data-tab="overview" onclick="showSpTab('overview')">üìä –û–±–∑–æ—Ä</div>
        <div class="tab" data-tab="tasks" onclick="showSpTab('tasks')">‚úÖ –ó–∞–¥–∞—á–∏</div>
        <div class="tab" data-tab="partners" onclick="showSpTab('partners')">ü§ù –ü–∞—Ä—Ç–Ω—ë—Ä—ã</div>
        <div class="tab" data-tab="projects" onclick="showSpTab('projects')">üìÅ –ü—Ä–æ–µ–∫—Ç—ã</div>
        <div class="tab" data-tab="comms" onclick="showSpTab('comms')">üí¨ –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏</div>
        <div class="tab" data-tab="files" onclick="showSpTab('files')">üìÑ –î–æ–∫—É–º–µ–Ω—Ç—ã</div>
        <div class="tab tab-sitegen" data-tab="sitegen" onclick="showSpTab('sitegen')" style="display:none">üåê –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å–∞–π—Ç–æ–≤</div>
      </div>
      <div id="sp-content"></div>
    </div>

    <!-- ======== TASK DETAIL with AI ======== -->
    <div class="page" id="page-taskdetail">
      <div class="breadcrumb" id="td-breadcrumb"></div>
      <div id="td-content"></div>
    </div>

    <!-- ======== DASHBOARD ======== -->
    <div class="page" id="page-dashboard">
      <div class="page-header">
        <h2>üìä –î–∞—à–±–æ—Ä–¥ –≥–µ–Ω–µ—Ä–∞–ª—å–Ω–æ–≥–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞</h2>
        <div class="actions">
          <button class="btn btn-secondary" onclick="loadData()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
      </div>
      <div class="metrics" id="dash-metrics"></div>
      <div class="card" style="border:1px solid rgba(177,151,252,0.2);background:linear-gradient(135deg,rgba(177,151,252,0.03),rgba(121,80,242,0.01))">
        <div class="card-header" style="display:flex;align-items:center;justify-content:space-between">
          <h3>ü§ñ –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç</h3>
          <button class="btn btn-sm" onclick="toggleAiPanel()" style="background:linear-gradient(135deg,var(--purple),#7950f2);color:#fff;border:none;font-size:11px">–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç ‚Üí</button>
        </div>
        <div style="padding:0 20px 16px;display:flex;gap:8px;flex-wrap:wrap">
          <button onclick="toggleAiPanel();setTimeout(()=>globalAiQuick('–°–æ—Å—Ç–∞–≤—å –æ—Ç—á—ë—Ç –ø–æ –≤—Å–µ–º –ø—Ä–æ–µ–∫—Ç–∞–º'),300)" style="padding:8px 16px;border-radius:20px;border:1px solid rgba(177,151,252,0.25);background:rgba(177,151,252,0.06);color:var(--purple);font-family:'JetBrains Mono',monospace;font-size:11px;cursor:pointer;transition:all .2s">üìä –û—Ç—á—ë—Ç –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º</button>
          <button onclick="toggleAiPanel();setTimeout(()=>globalAiQuick('–ö–∞–∫–∏–µ –∑–∞–¥–∞—á–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω—ã?'),300)" style="padding:8px 16px;border-radius:20px;border:1px solid rgba(177,151,252,0.25);background:rgba(177,151,252,0.06);color:var(--purple);font-family:'JetBrains Mono',monospace;font-size:11px;cursor:pointer;transition:all .2s">üî¥ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ</button>
          <button onclick="toggleAiPanel();setTimeout(()=>globalAiQuick('–ü–æ–¥–≥–æ—Ç–æ–≤—å –ø–ª–∞–Ω –Ω–∞ –Ω–µ–¥–µ–ª—é'),300)" style="padding:8px 16px;border-radius:20px;border:1px solid rgba(177,151,252,0.25);background:rgba(177,151,252,0.06);color:var(--purple);font-family:'JetBrains Mono',monospace;font-size:11px;cursor:pointer;transition:all .2s">üìã –ü–ª–∞–Ω –Ω–∞ –Ω–µ–¥–µ–ª—é</button>
          <button onclick="toggleAiPanel();setTimeout(()=>globalAiQuick('–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ä–∏—Å–∫–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤'),300)" style="padding:8px 16px;border-radius:20px;border:1px solid rgba(177,151,252,0.25);background:rgba(177,151,252,0.06);color:var(--purple);font-family:'JetBrains Mono',monospace;font-size:11px;cursor:pointer;transition:all .2s">‚ö†Ô∏è –†–∏—Å–∫–∏</button>
        </div>
      </div>
      <div class="card">
        <div class="card-header"><h3>üî¥ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏</h3></div>
        <div class="table-wrap"><table><thead><tr><th>–ó–∞–¥–∞—á–∞</th><th>–ü—Ä–æ–µ–∫—Ç</th><th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th><th>–î–µ–¥–ª–∞–π–Ω</th><th>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th><th></th></tr></thead><tbody id="dash-overdue"></tbody></table></div>
      </div>
      <div class="card">
        <div class="card-header"><h3>üìÅ –í—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã</h3></div>
        <div class="table-wrap"><table><thead><tr><th>–ü—Ä–æ–µ–∫—Ç</th><th>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ü—Ä–æ–≥—Ä–µ—Å—Å</th><th>–î–µ–¥–ª–∞–π–Ω</th></tr></thead><tbody id="dash-projects"></tbody></table></div>
      </div>
      <div class="card">
        <div class="card-header"><h3>üí¨ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏</h3></div>
        <div class="table-wrap"><table><thead><tr><th>–ü–∞—Ä—Ç–Ω—ë—Ä</th><th>–¢–∏–ø</th><th>–¢–µ–º–∞</th><th>–î–∞—Ç–∞</th><th>–ê–≤—Ç–æ—Ä</th></tr></thead><tbody id="dash-comms"></tbody></table></div>
      </div>
    </div>

    <!-- ======== PARTNERS ======== -->
    <div class="page" id="page-partners">
      <div class="page-header">
        <h2>ü§ù –í—Å–µ –ø–∞—Ä—Ç–Ω—ë—Ä—ã</h2>
        <div class="actions">
          <button class="btn btn-primary" id="btn-add-partner" onclick="openModal('partner')">+ –ü–∞—Ä—Ç–Ω—ë—Ä</button>
          <button class="btn btn-secondary" onclick="exportCSV('partners')">üì• CSV</button>
        </div>
      </div>
      <div class="filters-bar">
        <div id="partner-filters"></div>
        <input class="search-input" id="partner-search" placeholder="üîç –ü–æ–∏—Å–∫..." oninput="renderPartners()">
      </div>
      <div class="card"><div class="table-wrap"><table>
        <thead><tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–°—Ç—Ä–∞–Ω–∞</th><th>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</th><th>–ü—Ä–æ–¥—É–∫—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ö–æ–Ω—Ç–∞–∫—Ç</th><th></th></tr></thead>
        <tbody id="partners-table"></tbody>
      </table></div></div>
    </div>

    <!-- ======== TASKS ======== -->
    <div class="page" id="page-tasks">
      <div class="page-header">
        <h2>‚úÖ –í—Å–µ –∑–∞–¥–∞—á–∏</h2>
        <div class="actions">
          <button class="btn btn-primary" onclick="openModal('task')">+ –ó–∞–¥–∞—á–∞</button>
          <button class="btn btn-secondary" onclick="exportCSV('tasks')">üì• CSV</button>
        </div>
      </div>
      <div class="filters-bar" style="display:flex;flex-direction:column;gap:8px">
        <div id="task-filters"></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <select id="task-filter-status" onchange="renderTasks()" style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:6px 10px;color:var(--text);font-family:inherit;font-size:12px">
            <option value="active">üìã –ê–∫—Ç–∏–≤–Ω—ã–µ</option>
            <option value="–í—Å–µ">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
            <option value="‚è≥ –í –æ—á–µ—Ä–µ–¥–∏">‚è≥ –í –æ—á–µ—Ä–µ–¥–∏</option>
            <option value="üîÑ –í —Ä–∞–±–æ—Ç–µ">üîÑ –í —Ä–∞–±–æ—Ç–µ</option>
            <option value="‚úÖ –ì–æ—Ç–æ–≤–æ">‚úÖ –ì–æ—Ç–æ–≤–æ</option>
          </select>
          <select id="task-filter-person" onchange="renderTasks()" style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:6px 10px;color:var(--text);font-family:inherit;font-size:12px">
            <option value="–í—Å–µ">üë§ –í—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</option>
          </select>
          <label style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text2);cursor:pointer">
            <input type="checkbox" id="task-show-gantt" onchange="renderTasks()"> üìÖ –ü–æ–∫–∞–∑–∞—Ç—å –ø–ª–∞–Ω-–≥—Ä–∞—Ñ–∏–∫
          </label>
          <input class="search-input" id="task-search" placeholder="üîç –ü–æ–∏—Å–∫..." oninput="renderTasks()">
        </div>
      </div>
      <div id="task-gantt" style="margin-bottom:12px"></div>
      <div class="card"><div class="table-wrap"><table>
        <thead><tr><th>–ó–∞–¥–∞—á–∞</th><th>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</th><th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th><th>–î–µ–¥–ª–∞–π–Ω</th><th></th></tr></thead>
        <tbody id="tasks-table"></tbody>
      </table></div></div>
    </div>

    <!-- ======== STAFF ======== -->
    <div class="page" id="page-staff">
      <div class="page-header">
        <h2>üë• –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</h2>
        <div class="actions">
          <button class="btn btn-primary" id="btn-add-staff" onclick="openModal('staff')">+ –°–æ—Ç—Ä—É–¥–Ω–∏–∫</button>
        </div>
      </div>
      <!-- Step 1: Choose project -->
      <div class="staff-projects" id="staff-projects">
        <div class="tabs" id="staff-project-tabs"></div>
      </div>
      <!-- Step 2: Choose direction (after project selected) -->
      <div class="staff-directions" id="staff-direction-tabs" style="margin-top:8px"></div>
      <!-- Stats & Search -->
      <div style="display:flex;align-items:center;gap:12px;margin:12px 0;flex-wrap:wrap">
        <div id="staff-stats" style="flex:1"></div>
        <input type="text" id="staff-search" placeholder="üîç –ü–æ–∏—Å–∫..." oninput="renderStaff()" style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 14px;color:var(--text);font-family:inherit;font-size:13px;width:200px">
      </div>
      <!-- Pending registrations (CEO only) -->
      <div id="staff-pending" style="margin-bottom:16px"></div>
      <div id="staff-content"></div>
    </div>

    <!-- ======== APPROVALS ======== -->
    <div class="page" id="page-approvals">
      <div class="page-header"><h2>üìã –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è</h2></div>
      <div id="approvals-content"></div>
    </div>

    <!-- ======== COMMS ======== -->
    <div class="page" id="page-comms">
      <div class="page-header">
        <h2>üí¨ –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏</h2>
        <div class="actions">
          <button class="btn btn-primary" onclick="openModal('comm')">+ –ö–æ–Ω—Ç–∞–∫—Ç</button>
        </div>
      </div>
      <div class="filters-bar">
        <input class="search-input" id="comm-search" placeholder="üîç –ü–æ–∏—Å–∫..." oninput="renderComms()">
      </div>
      <div class="card"><div class="table-wrap"><table>
        <thead><tr><th>–ü–∞—Ä—Ç–Ω—ë—Ä</th><th>–¢–∏–ø</th><th>–¢–µ–º–∞</th><th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th><th>–î–∞—Ç–∞</th><th>–ê–≤—Ç–æ—Ä</th><th></th></tr></thead>
        <tbody id="comms-table"></tbody>
      </table></div></div>
    </div>

    <!-- ======== SETTINGS ======== -->
    <div class="page" id="page-settings">
      <div class="page-header"><h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2></div>
      <div class="card" style="padding:28px">
        <h3 style="margin-bottom:20px;font-size:15px">üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h3>
        <div class="form-group"><label>API URL</label><input type="text" id="settingsApiUrl" onchange="updateConfig('API_URL',this.value)" style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 12px;color:var(--text);width:100%;font-family:monospace;font-size:12px"></div>
        <div class="form-group"><label>AI URL</label><input type="text" id="settingsAiUrl" onchange="updateConfig('AI_URL',this.value)" style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 12px;color:var(--text);width:100%;font-family:monospace;font-size:12px"></div>
        <div class="form-group"><label>Write URL</label><input type="text" id="settingsWriteUrl" onchange="updateConfig('WRITE_URL',this.value)" style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 12px;color:var(--text);width:100%;font-family:monospace;font-size:12px"></div>
        <div class="form-group"><label>üìã Google Sheet ID</label><input type="text" id="settingsSheetId" onchange="updateConfig('SHEET_ID',this.value)" placeholder="1Te4CsdcN1rvpznHNyPa24MuH5ZSx45DUUDREWO5mtoE" style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 12px;color:var(--accent);width:100%;font-family:monospace;font-size:12px;font-weight:600"></div>
        <p style="font-size:11px;color:var(--text3);margin-top:-8px">–°–∫–æ–ø–∏—Ä—É–π—Ç–µ ID –∏–∑ URL —Ç–∞–±–ª–∏—Ü—ã: docs.google.com/spreadsheets/d/<b style="color:var(--accent)">–í–û–¢_–≠–¢–û–¢_ID</b>/edit</p>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="btn btn-primary" onclick="saveSettings()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button class="btn btn-secondary" onclick="testConnection()">üîå –¢–µ—Å—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</button>
        </div>
        <div id="settings-status" style="margin-top:8px;font-size:12px"></div>
      </div>
      <div class="card" style="padding:28px;margin-top:16px">
        <h3 style="margin-bottom:20px;font-size:15px">üë§ –ü—Ä–æ—Ñ–∏–ª—å</h3>
        <div class="detail-grid">
          <div class="detail-item"><div class="detail-label">–ò–º—è</div><div class="detail-value" id="s-name">‚Äî</div></div>
          <div class="detail-item"><div class="detail-label">–†–æ–ª—å</div><div class="detail-value" id="s-role">‚Äî</div></div>
          <div class="detail-item"><div class="detail-label">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div><div class="detail-value" id="s-dir">‚Äî</div></div>
          <div class="detail-item"><div class="detail-label">Telegram ID</div><div class="detail-value" id="s-tgid">‚Äî</div></div>
        </div>
      </div>
      <div class="card" style="padding:28px;margin-top:16px">
        <h3 style="margin-bottom:16px;font-size:15px">üîê –ó–æ–Ω—ã –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏</h3>
        <div id="s-perms" style="font-size:13px;line-height:2"></div>
        </div>
      </div>
      <div class="card" style="padding:28px;margin-top:16px">
        <h3 style="margin-bottom:20px;font-size:15px">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
        <div class="detail-grid" id="s-stats"></div>
      </div>
    </div>

  </main>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this)closeModal()">
  <div class="modal" id="modalBox">
    <div class="modal-header">
      <h3 id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å</h3>
      <button class="modal-close" onclick="closeModal()">‚úï</button>
    </div>
    <div class="modal-body" id="modalBody"></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary" id="modalSaveBtn" onclick="saveModal()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- DETAIL MODAL -->
<div class="modal-overlay" id="detailOverlay" onclick="if(event.target===this)closeDetail()">
  <div class="modal" style="width:620px">
    <div class="modal-header">
      <h3 id="detailTitle">–î–µ—Ç–∞–ª–∏</h3>
      <button class="modal-close" onclick="closeDetail()">‚úï</button>
    </div>
    <div class="modal-body" id="detailBody"></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeDetail()">–ó–∞–∫—Ä—ã—Ç—å</button>
      <button class="btn btn-primary" id="detailEditBtn">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>
  </div>
</div>

<!-- CONFIRM -->
<div class="confirm-overlay" id="confirmOverlay">
  <div class="confirm-box">
    <div class="icon">‚ö†Ô∏è</div>
    <h4 id="confirmTitle">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h4>
    <p id="confirmText">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</p>
    <div class="confirm-actions">
      <button class="btn btn-secondary" onclick="closeConfirm(false)">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-danger" onclick="closeConfirm(true)">üóë –£–¥–∞–ª–∏—Ç—å</button>
    </div>
  </div>
</div>

<button id="aiFab" onclick="toggleAiPanel()" style="position:fixed;bottom:40px;right:28px;width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,#b197fc,#7950f2);border:none;color:#fff;font-size:28px;cursor:pointer;z-index:500;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 24px rgba(177,151,252,0.4);transition:all .3s">ü§ñ</button>

<div id="aiGlobalPanel" style="position:fixed;bottom:40px;right:28px;width:440px;max-width:calc(100vw - 56px);height:600px;max-height:calc(100vh - 80px);background:var(--bg2);border:1px solid var(--purple);border-radius:16px;z-index:600;display:none;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,0.6),0 0 40px rgba(177,151,252,0.1)">
  <div style="display:flex;align-items:center;justify-content:space-between;padding:16px 20px;background:linear-gradient(135deg,rgba(177,151,252,0.12),rgba(121,80,242,0.06));border-bottom:1px solid rgba(177,151,252,0.2);border-radius:16px 16px 0 0">
    <h4 style="font-size:15px;font-weight:700;color:var(--purple);display:flex;align-items:center;gap:10px">ü§ñ –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç RKT HUB</h4>
    <button onclick="toggleAiPanel()" style="width:30px;height:30px;border-radius:50%;border:1px solid rgba(177,151,252,0.3);background:transparent;color:var(--text2);cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center">‚úï</button>
  </div>
  <div style="padding:10px 16px;border-bottom:1px solid rgba(177,151,252,0.1);display:flex;gap:6px;flex-wrap:wrap">
    <button onclick="globalAiQuick('–ö–∞–∫–∏–µ –∑–∞–¥–∞—á–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω—ã?')" style="padding:5px 12px;border-radius:16px;border:1px solid rgba(177,151,252,0.25);background:rgba(177,151,252,0.05);color:var(--purple);font-family:'JetBrains Mono',monospace;font-size:10px;cursor:pointer">üî¥ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</button>
    <button onclick="globalAiQuick('–°–æ—Å—Ç–∞–≤—å –æ—Ç—á—ë—Ç –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º')" style="padding:5px 12px;border-radius:16px;border:1px solid rgba(177,151,252,0.25);background:rgba(177,151,252,0.05);color:var(--purple);font-family:'JetBrains Mono',monospace;font-size:10px;cursor:pointer">üìä –û—Ç—á—ë—Ç</button>
    <button onclick="globalAiQuick('–ù–∞–ø–∏—à–∏ –¥–µ–ª–æ–≤–æ–µ –ø–∏—Å—å–º–æ')" style="padding:5px 12px;border-radius:16px;border:1px solid rgba(177,151,252,0.25);background:rgba(177,151,252,0.05);color:var(--purple);font-family:'JetBrains Mono',monospace;font-size:10px;cursor:pointer">üìß –ü–∏—Å—å–º–æ</button>
    <button onclick="globalAiQuick('–ö–∞–∫–∏–µ –∑–∞–¥–∞—á–∏ —Å–∞–º—ã–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ?')" style="padding:5px 12px;border-radius:16px;border:1px solid rgba(177,151,252,0.25);background:rgba(177,151,252,0.05);color:var(--purple);font-family:'JetBrains Mono',monospace;font-size:10px;cursor:pointer">‚≠ê –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã</button>
    <button onclick="globalAiQuick('–ü–æ–¥–≥–æ—Ç–æ–≤—å –ø–ª–∞–Ω –Ω–∞ –Ω–µ–¥–µ–ª—é')" style="padding:5px 12px;border-radius:16px;border:1px solid rgba(177,151,252,0.25);background:rgba(177,151,252,0.05);color:var(--purple);font-family:'JetBrains Mono',monospace;font-size:10px;cursor:pointer">üìã –ü–ª–∞–Ω</button>
  </div>
  <div id="ai-global-messages" style="flex:1;padding:16px;overflow-y:auto;display:flex;flex-direction:column;gap:10px">
    <div class="ai-msg system">–ü—Ä–∏–≤–µ—Ç! –Ø –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç RKT HUB. –ú–æ–≥—É –ø–æ–º–æ—á—å —Å –∑–∞–¥–∞—á–∞–º–∏, –ø–∏—Å—å–º–∞–º–∏, –∞–Ω–∞–ª–∏–∑–æ–º –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º –ø–æ –≤—Å–µ–º –≤–∞—à–∏–º –ø—Ä–æ–µ–∫—Ç–∞–º. –°–ø—Ä–∞—à–∏–≤–∞–π—Ç–µ!</div>
  </div>
  <div style="display:flex;gap:8px;padding:14px 16px;border-top:1px solid rgba(177,151,252,0.15);background:rgba(26,34,52,0.5);border-radius:0 0 16px 16px">
    <input id="ai-global-input" placeholder="–°–ø—Ä–æ—Å–∏—Ç–µ —á—Ç–æ —É–≥–æ–¥–Ω–æ..." onkeydown="if(event.key==='Enter')sendGlobalAi()" style="flex:1;padding:10px 16px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:13px">
    <button id="ai-global-send" onclick="sendGlobalAi()" style="padding:10px 18px;background:linear-gradient(135deg,var(--purple),#7950f2);color:#fff;border:none;border-radius:8px;font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:600;cursor:pointer">‚û§</button>
  </div>
</div>

<div class="toast" id="toast"></div>
<div class="status-bar">
  <div><span class="dot dot-green" id="statusDot"></span> <span id="statusText">–ü–æ–¥–∫–ª—é—á–µ–Ω–æ</span></div>
  <div id="statusTime"></div>
</div>

<script>
// ============================================================
// CONFIG & STATE
// ============================================================
const CONFIG = {
  API_URL: 'https://daniyal2212.app.n8n.cloud/webhook/rkt-api',
  WRITE_URL: 'https://daniyal2212.app.n8n.cloud/webhook/rkt-write',
  AI_URL: 'https://daniyal2212.app.n8n.cloud/webhook/rkt-ai',
  SHEET_ID: '1Te4CsdcN1rvpznHNyPa24MuH5ZSx45DUUDREWO5mtoE',
  REFRESH: 300000,
  VERSION: '6.0.0'
};

let DATA = { partners:[], tasks:[], directions:[], staff:[], projects:[], approvals:[], comms:[], documents:[] };
let USER = null;
let currentModal = '';
let editingItem = null;
let confirmCallback = null;
let currentFilters = { partners: '–í—Å–µ', tasks: '–í—Å–µ' };
let refreshTimer = null;

// Navigation state
let currentProject = null;       // Top-level project key (e.g. 'rkt', 'sites')
let currentSubproject = null;    // Subproject direction (e.g. '–ö–¢', '–ü—ã—à–∫–∏ –º–∏—Ä–∞')
let currentPvTab = 'overview';   // Project view tab
let currentSpTab = 'overview';   // Subproject view tab
let currentTaskId = null;        // Task open for detail+AI
let aiMessages = [];             // AI chat history for current task

// ============================================================
// TOP-LEVEL PROJECTS DEFINITION
// ============================================================
const PROJECTS = {
  rkt: {
    name: '–†–ö–¢',
    emoji: 'üè•',
    color: 'var(--accent)',
    gradient: 'linear-gradient(90deg, #00d4aa, #00b894)',
    desc: '–†–æ—Å—Å–∏–π—Å–∫–∏–µ –ö–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã–µ –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ ‚Äî –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è',
    subprojects: {
      '–ö–¢':       { emoji: 'üî¨', color: 'var(--accent)', desc: '–ö–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã–µ —Ç–æ–º–æ–≥—Ä–∞—Ñ—ã ‚Äî –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è —Å Syno-Tech' },
      '–†–µ–Ω—Ç–≥–µ–Ω':  { emoji: 'üì°', color: 'var(--blue)', desc: '–†–µ–Ω—Ç–≥–µ–Ω–æ–≤—Å–∫–∏–µ –∞–ø–ø–∞—Ä–∞—Ç—ã ‚Äî —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –ª–∏–Ω–µ–π–∫–∏' },
      '–†–æ–±–æ—Ç—ã':   { emoji: 'ü§ñ', color: 'var(--purple)', desc: '–•–∏—Ä—É—Ä–≥–∏—á–µ—Å–∫–∏–µ —Ä–æ–±–æ—Ç–æ—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–∏—Å—Ç–µ–º—ã' },
      '–£—Ä–æ–ª–æ–≥–∏—è': { emoji: 'üíä', color: 'var(--orange)', desc: '–£—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ' },
      'PACS':     { emoji: 'üíª', color: 'var(--pink)', desc: '–°–∏—Å—Ç–µ–º—ã –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π' },
      '–£–ó–ò':      { emoji: 'ü©∫', color: 'var(--green)', desc: '–£–ª—å—Ç—Ä–∞–∑–≤—É–∫–æ–≤–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ ‚Äî –ø–ª–∞–Ω —Å 2028' }
    }
  },
  sites: {
    name: '–°–∞–π—Ç—ã',
    emoji: 'üåê',
    color: 'var(--blue)',
    gradient: 'linear-gradient(90deg, #4dabf7, #228be6)',
    desc: '–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∏ –≤–µ–¥–µ–Ω–∏–µ –≤–µ–±-—Å–∞–π—Ç–æ–≤ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞',
    subprojects: {
      '–ü—ã—à–∫–∏ –º–∏—Ä–∞':  { emoji: 'üç©', color: 'var(--orange)', desc: '–°–∞–π—Ç –¥–ª—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ –ü—ã—à–∫–∏ –º–∏—Ä–∞' },
      '–ë—Ä–µ–∂–Ω–µ–≤':     { emoji: 'üèõ', color: 'var(--red)', desc: '–°–∞–π—Ç –¥–ª—è —Ä–µ—Å—Ç–æ–∫–ª—É–±–∞ –ë—Ä–µ–∂–Ω–µ–≤' },
      '–ö–µ—Ä–∞—Ç–∏–Ω –ê–≥—Ä—ã–∑': { emoji: 'üíá', color: 'var(--pink)', desc: '–°–∞–π—Ç –∫–µ—Ä–∞—Ç–∏–Ω–æ–≤–æ–≥–æ –≤—ã–ø—Ä—è–º–ª–µ–Ω–∏—è, –ê–≥—Ä—ã–∑' }
    },
    canAddSub: true // can add new subprojects (sites)
  }
};

// ============================================================
// ROLES & PERMISSIONS
// ============================================================
const ROLES = {
  'CEO': {
    emoji: 'üëë', level: 4,
    canWrite: true, canDelete: true, canApprove: true, canManageStaff: true, seeAll: true,
    canEditTasks: true, canEditPartners: true, canEditStaff: true, canEditProjects: true,
    canAssignTasks: true, canViewFinance: true, canExport: true,
    canCreateSiteTask: true, canGenerateSite: true,
    writeSheets: ['–ü–∞—Ä—Ç–Ω—ë—Ä—ã','–ó–∞–¥–∞—á–∏','–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è','–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏','–ü—Ä–æ–µ–∫—Ç—ã','–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è','–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏'],
    desc: '–ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–π —Å–∏—Å—Ç–µ–º–µ'
  },
  '–ó–∞–º': {
    emoji: '‚≠ê', level: 3,
    canWrite: true, canDelete: false, canApprove: false, canManageStaff: false, seeAll: true,
    canEditTasks: true, canEditPartners: true, canEditStaff: false, canEditProjects: false,
    canAssignTasks: true, canViewFinance: false, canExport: true,
    canCreateSiteTask: true, canGenerateSite: true,
    writeSheets: ['–ü–∞—Ä—Ç–Ω—ë—Ä—ã','–ó–∞–¥–∞—á–∏','–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏','–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è'],
    needsApproval: ['–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏','–ü—Ä–æ–µ–∫—Ç—ã'],
    desc: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∞–º–∏ –∏ –ø–∞—Ä—Ç–Ω—ë—Ä–∞–º–∏, —Å–æ–∑–¥–∞–Ω–∏–µ —Å–∞–π—Ç–æ–≤'
  },
  '–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å': {
    emoji: 'üìã', level: 2,
    canWrite: true, canDelete: false, canApprove: false, canManageStaff: false, seeAll: false,
    canEditTasks: true, canEditPartners: false, canEditStaff: false, canEditProjects: false,
    canAssignTasks: false, canViewFinance: false, canExport: false,
    canCreateSiteTask: true, canGenerateSite: true,
    writeSheets: ['–ó–∞–¥–∞—á–∏','–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏'],
    needsApproval: ['–ü–∞—Ä—Ç–Ω—ë—Ä—ã','–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è','–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏','–ü—Ä–æ–µ–∫—Ç—ã'],
    desc: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–≤–æ–∏–º–∏ –∑–∞–¥–∞—á–∞–º–∏ –∏ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è–º–∏'
  },
  '–ú–µ–Ω–µ–¥–∂–µ—Ä': {
    emoji: 'üíº', level: 1,
    canWrite: true, canDelete: false, canApprove: false, canManageStaff: false, seeAll: false,
    canEditTasks: true, canEditPartners: false, canEditStaff: false, canEditProjects: false,
    canAssignTasks: false, canViewFinance: false, canExport: false,
    canCreateSiteTask: true, canGenerateSite: false,
    writeSheets: ['–ó–∞–¥–∞—á–∏','–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏'],
    needsApproval: ['–ü–∞—Ä—Ç–Ω—ë—Ä—ã','–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è'],
    desc: '–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á –∏ –æ–±—â–µ–Ω–∏–µ —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏'
  },
  '–°–æ—Ç—Ä—É–¥–Ω–∏–∫': {
    emoji: 'üë§', level: 0,
    canWrite: false, canDelete: false, canApprove: false, canManageStaff: false, seeAll: false,
    canEditTasks: false, canEditPartners: false, canEditStaff: false, canEditProjects: false,
    canAssignTasks: false, canViewFinance: false, canExport: false,
    canCreateSiteTask: false, canGenerateSite: false,
    writeSheets: [],
    needsApproval: ['–ó–∞–¥–∞—á–∏','–ü–∞—Ä—Ç–Ω—ë—Ä—ã','–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏'],
    desc: '–ü—Ä–æ—Å–º–æ—Ç—Ä —Å–≤–æ–∏—Ö –∑–∞–¥–∞—á'
  }
};

function getUserPerms() {
  return USER ? (ROLES[USER.role] || ROLES['–°–æ—Ç—Ä—É–¥–Ω–∏–∫']) : ROLES['–°–æ—Ç—Ä—É–¥–Ω–∏–∫'];
}

// Check if user can directly write to a sheet or needs approval
function canDirectWrite(sheet) {
  const p = getUserPerms();
  if (p.writeSheets && p.writeSheets.includes(sheet)) return 'direct';
  if (p.needsApproval && p.needsApproval.includes(sheet)) return 'approval';
  return 'denied';
}

// ============================================================
// FORM DEFINITIONS
// ============================================================
function getDirectionOptions() {
  // Gather all subproject names across all projects
  let opts = [];
  Object.values(PROJECTS).forEach(p => {
    Object.keys(p.subprojects).forEach(sp => { if (!opts.includes(sp)) opts.push(sp); });
  });
  opts.push('–û–±—â–µ–µ');
  return opts;
}

const FORM_DEFS = {
  partner: {
    title: '–ü–∞—Ä—Ç–Ω—ë—Ä', sheet: '–ü–∞—Ä—Ç–Ω—ë—Ä—ã',
    fields: [
      { name: '–ù–∞–∑–≤–∞–Ω–∏–µ', type: 'text', required: true, placeholder: '–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏' },
      { name: '–°—Ç—Ä–∞–Ω–∞', type: 'text', placeholder: '–ö–∏—Ç–∞–π, –†–æ—Å—Å–∏—è...' },
      { name: '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', type: 'select', options: () => getDirectionOptions() },
      { name: '–ü—Ä–æ–¥—É–∫—Ç', type: 'text', placeholder: '–ü—Ä–æ–¥—É–∫—Ç' },
      { name: '–°—Ç–∞—Ç—É—Å', type: 'select', options: ['Research', '–ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã', '–ê–∫—Ç–∏–≤–Ω—ã–π', '–ü–∞—É–∑–∞'] },
      { name: '–ö–æ–Ω—Ç–∞–∫—Ç', type: 'text', placeholder: '–ò–º—è –∫–æ–Ω—Ç–∞–∫—Ç–∞' },
      { name: 'Email', type: 'text', placeholder: 'email@company.com' },
      { name: '–¢–µ–ª–µ—Ñ–æ–Ω', type: 'text', placeholder: '+7...' },
      { name: '–°–∞–π—Ç', type: 'text', placeholder: 'https://' },
      { name: '–û–ø–∏—Å–∞–Ω–∏–µ', type: 'textarea', placeholder: '–ó–∞–º–µ—Ç–∫–∏...' }
    ]
  },
  project: {
    title: '–ü—Ä–æ–µ–∫—Ç', sheet: '–ü—Ä–æ–µ–∫—Ç—ã',
    fields: [
      { name: '–ù–∞–∑–≤–∞–Ω–∏–µ', type: 'text', required: true, placeholder: '–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞' },
      { name: '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', type: 'select', options: () => getDirectionOptions() },
      { name: '–û–ø–∏—Å–∞–Ω–∏–µ', type: 'textarea', placeholder: '–û–ø–∏—Å–∞–Ω–∏–µ...' },
      { name: '–°—Ç–∞—Ç—É—Å', type: 'select', options: ['–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ', '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞', '–í —Ä–∞–±–æ—Ç–µ', '–ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã', '–ó–∞–≤–µ—Ä—à—ë–Ω'] },
      { name: '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç', type: 'select', options: ['P1', 'P2', 'P3'] },
      { name: '–ü—Ä–æ–≥—Ä–µ—Å—Å', type: 'text', placeholder: '0-100' },
      { name: '–ü–∞—Ä—Ç–Ω—ë—Ä', type: 'text', placeholder: '–ü–∞—Ä—Ç–Ω—ë—Ä' },
      { name: '–ë—é–¥–∂–µ—Ç', type: 'text', placeholder: '–ë—é–¥–∂–µ—Ç' },
      { name: '–î–µ–¥–ª–∞–π–Ω', type: 'date' },
      { name: '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π', type: 'text', placeholder: '–ö—Ç–æ –≤–µ–¥—ë—Ç' }
    ]
  },
  task: {
    title: '–ó–∞–¥–∞—á–∞', sheet: '–ó–∞–¥–∞—á–∏',
    fields: [
      { name: '–û–ø–∏—Å–∞–Ω–∏–µ', type: 'text', required: true, placeholder: '–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å' },
      { name: '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', type: 'select', options: () => getDirectionOptions() },
      { name: '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç', type: 'select', options: ['P1', 'P2', 'P3'] },
      { name: '–°—Ç–∞—Ç—É—Å', type: 'select', options: ['‚è≥ –í –æ—á–µ—Ä–µ–¥–∏', '–í —Ä–∞–±–æ—Ç–µ', '–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ', '–ì–æ—Ç–æ–≤–æ'] },
      { name: '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π', type: 'text', placeholder: '–ö—Ç–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç' },
      { name: '–ü—Ä–æ–µ–∫—Ç', type: 'text', placeholder: '–ü—Ä–æ–µ–∫—Ç' },
      { name: '–î–µ–¥–ª–∞–π–Ω', type: 'date' },
      { name: '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π', type: 'textarea', placeholder: '–î–æ–ø. –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è...' }
    ]
  },
  staff: {
    title: '–°–æ—Ç—Ä—É–¥–Ω–∏–∫', sheet: '–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏',
    fields: [
      { name: '–ò–º—è', type: 'text', required: true, placeholder: '–§–ò–û' },
      { name: '–†–æ–ª—å', type: 'select', options: ['CEO', '–ó–∞–º', '–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å', '–ú–µ–Ω–µ–¥–∂–µ—Ä', '–ò–Ω–∂–µ–Ω–µ—Ä', '–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫', '–°–æ—Ç—Ä—É–¥–Ω–∏–∫'] },
      { name: '–ü—Ä–æ–µ–∫—Ç', type: 'select', options: () => ['–í—Å–µ', ...Object.values(PROJECTS).map(p=>p.name)] },
      { name: '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', type: 'select', options: () => ['–í—Å–µ', ...getDirectionOptions()] },
      { name: 'Telegram_ID', type: 'text', placeholder: '–ß–∏—Å–ª–æ–≤–æ–π Telegram ID' },
      { name: 'Email', type: 'text', placeholder: 'email' },
      { name: '–¢–µ–ª–µ—Ñ–æ–Ω', type: 'text', placeholder: '+7...' },
      { name: '–°—Ç–∞—Ç—É—Å', type: 'select', options: ['–ê–∫—Ç–∏–≤–Ω—ã–π', '–û–∂–∏–¥–∞–µ—Ç', '–û—Ç–∫–ª—é—á—ë–Ω'] }
    ]
  },
  comm: {
    title: '–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è', sheet: '–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏',
    fields: [
      { name: '–ü–∞—Ä—Ç–Ω—ë—Ä', type: 'text', required: true, placeholder: '–° –∫–µ–º –æ–±—â–∞–ª–∏—Å—å' },
      { name: '–¢–∏–ø', type: 'select', options: ['–ó–≤–æ–Ω–æ–∫', 'Email', '–í—Å—Ç—Ä–µ—á–∞', '–ß–∞—Ç', 'Zoom', 'WhatsApp'] },
      { name: '–¢–µ–º–∞', type: 'text', placeholder: '–¢–µ–º–∞' },
      { name: '–†–µ–∑—É–ª—å—Ç–∞—Ç', type: 'textarea', placeholder: '–ò—Ç–æ–≥, –¥–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç–∏...' },
      { name: '–°–ª–µ–¥—É—é—â–∏–π_—à–∞–≥', type: 'text', placeholder: '–ß—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ' },
      { name: '–î–∞—Ç–∞_—Å–ª–µ–¥—É—é—â–µ–≥–æ', type: 'date' }
    ]
  },
  site: {
    title: '–°–∞–π—Ç (–ø–æ–¥–ø—Ä–æ–µ–∫—Ç)', sheet: null, // handled locally
    fields: [
      { name: '–ù–∞–∑–≤–∞–Ω–∏–µ', type: 'text', required: true, placeholder: '–ù–∞–∑–≤–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å–∞' },
      { name: '–°—Å—ã–ª–∫–∞', type: 'text', placeholder: 'https://...' },
      { name: '–ö–ª–∏–µ–Ω—Ç', type: 'text', placeholder: '–ò–º—è –∑–∞–∫–∞–∑—á–∏–∫–∞' },
      { name: '–¢–µ–ª–µ—Ñ–æ–Ω', type: 'text', placeholder: '+7...' },
      { name: '–û–ø–∏—Å–∞–Ω–∏–µ', type: 'textarea', placeholder: '–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞...' }
    ]
  }
};

// ============================================================
// HELPERS
// ============================================================
function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function escA(s) { return String(s||'').replace(/'/g,"\\'").replace(/"/g,'&quot;'); }
function emptyRow(c,m) { return '<tr><td colspan="'+c+'" class="empty"><div class="icon">üì≠</div><p>'+m+'</p></td></tr>'; }

function statusBadge(s) {
  if (!s) return '';
  let c = 's-active';
  if (s==='–ê–∫—Ç–∏–≤–Ω—ã–π'||s.includes('–ì–æ—Ç–æ–≤–æ')) c='s-done';
  else if (s==='–ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã') c='s-talks';
  else if (s==='Research'||s.includes('–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ')) c='s-research';
  else if (s==='–ü–∞—É–∑–∞') c='s-pause';
  else if (s.includes('—Ä–∞–±–æ—Ç–µ')||s.includes('–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞')||s.includes('–ø—Ä–æ–≤–µ—Ä–∫–µ')) c='s-work';
  else if (s.includes('–û–∂–∏–¥–∞–µ—Ç')||s.includes('–æ—á–µ—Ä–µ–¥–∏')) c='s-urgent';
  else if (s.includes('–û–¥–æ–±—Ä–µ–Ω–æ')) c='s-done';
  else if (s.includes('–û—Ç–∫–ª–æ–Ω–µ–Ω–æ')) c='s-urgent';
  return '<span class="status '+c+'">'+esc(s)+'</span>';
}

function prBadge(p) {
  if (!p) return '';
  return '<span class="'+(p==='P1'?'p1':p==='P2'?'p2':'p3')+'">'+esc(p)+'</span>';
}

function progBar(v) {
  v = parseInt(v)||0;
  const c = v>=80?'var(--green)':v>=50?'var(--accent)':v>=25?'var(--orange)':'var(--red)';
  return '<div class="progress-wrap"><div class="progress-bar"><div class="progress-fill" style="width:'+v+'%;background:'+c+'"></div></div><span class="progress-text">'+v+'%</span></div>';
}

function actBtns(type, id, name) {
  const p = getUserPerms();
  let h = '<div class="actions-cell">';
  h += '<button class="act-btn view" onclick="viewItem(\''+type+'\',\''+escA(id)+'\')" title="–ü—Ä–æ—Å–º–æ—Ç—Ä">üëÅ</button>';
  if (type === 'task') {
    h += '<button class="act-btn ai" onclick="openTaskDetail(\''+escA(id)+'\')" title="–û—Ç–∫—Ä—ã—Ç—å —Å –ò–ò">ü§ñ</button>';
  }
  h += '<button class="act-btn" onclick="editItem(\''+type+'\',\''+escA(id)+'\')" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>';
  if (p.canDelete) h += '<button class="act-btn del" onclick="confirmDelete(\''+type+'\',\''+escA(id)+'\',\''+escA(name)+'\')" title="–£–¥–∞–ª–∏—Ç—å">üóë</button>';
  h += '</div>';
  return h;
}

function toast(m,t) {
  const e = document.getElementById('toast');
  e.textContent = m;
  e.className = 'toast toast-'+(t||'success')+' show';
  setTimeout(()=>e.classList.remove('show'), 3000);
}

function setStatus(s) {
  const d=document.getElementById('statusDot'), t=document.getElementById('statusText');
  if (s==='connected') { d.className='dot dot-green'; t.textContent='–ü–æ–¥–∫–ª—é—á–µ–Ω–æ ‚Ä¢ '+new Date().toLocaleTimeString('ru',{hour:'2-digit',minute:'2-digit'}); }
  else if (s==='loading') { d.className='dot dot-green'; t.textContent='–ó–∞–≥—Ä—É–∑–∫–∞...'; }
  else { d.className='dot dot-red'; t.textContent='–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è'; }
}

function updateStatusTime() {
  const e=document.getElementById('statusTime');
  if(e) e.textContent=new Date().toLocaleString('ru',{day:'2-digit',month:'long',year:'numeric',hour:'2-digit',minute:'2-digit'});
}

function today() { return new Date().toISOString().split('T')[0]; }

// ============================================================
// AUTHENTICATION
// ============================================================
function checkSavedLogin() {
  loadSavedSettings();
  const s = localStorage.getItem('rkt_user');
  if (s) { try { USER=JSON.parse(s); if(USER&&USER.tgId){showApp();return;} } catch(e){} localStorage.removeItem('rkt_user'); }
}

async function doLogin() {
  const tgId = document.getElementById('loginTgId').value.trim();
  if (!tgId) { showLoginErr('–í–≤–µ–¥–∏—Ç–µ Telegram ID'); return; }
  if (!/^\d+$/.test(tgId)) { showLoginErr('–¢–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã'); return; }

  document.getElementById('loginBtn').disabled = true;
  document.getElementById('loginBtnText').textContent = '–ü–æ–¥–∫–ª—é—á–∞—é—Å—å...';
  document.getElementById('loginError').style.display = 'none';

  try {
    const url = CONFIG.SHEET_ID ? CONFIG.API_URL + '?sheetId=' + encodeURIComponent(CONFIG.SHEET_ID) : CONFIG.API_URL;
    const r = await fetch(url);
    if (!r.ok) throw new Error('HTTP '+r.status);
    DATA = normData(await r.json());

    const staff = DATA.staff.find(s => String(s.Telegram_ID).trim() === String(tgId).trim());
    if (!staff) { showLoginErr('‚õî ID ¬´'+tgId+'¬ª –Ω–µ –Ω–∞–π–¥–µ–Ω. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.'); resetLogin(); return; }

    USER = {
      id: staff.ID||'', tgId: String(staff.Telegram_ID).trim(),
      name: staff['–ò–º—è']||'–°–æ—Ç—Ä—É–¥–Ω–∏–∫', role: staff['–†–æ–ª—å']||'–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å',
      direction: staff['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'–í—Å–µ', email: staff['Email']||'',
      phone: staff['–¢–µ–ª–µ—Ñ–æ–Ω']||'', username: staff['Username']||''
    };
    localStorage.setItem('rkt_user', JSON.stringify(USER));
    showApp();
  } catch(e) {
    console.error(e);
    showLoginErr('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.');
    resetLogin();
  }
}

function showLoginErr(m) { const e=document.getElementById('loginError'); e.textContent=m; e.style.display='block'; }
function resetLogin() { document.getElementById('loginBtn').disabled=false; document.getElementById('loginBtnText').textContent='–í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É'; }

function toggleRegForm() {
  const lt = document.getElementById('loginTab');
  const rt = document.getElementById('registerTab');
  if (rt.style.display === 'none') { rt.style.display='block'; lt.style.display='none'; }
  else { rt.style.display='none'; lt.style.display='block'; }
}

async function doRegister() {
  const name = document.getElementById('regName').value.trim();
  const tgId = document.getElementById('regTgId').value.trim();
  const phone = document.getElementById('regPhone').value.trim();
  const email = document.getElementById('regEmail').value.trim();
  const role = document.getElementById('regRole').value;
  const project = document.getElementById('regProject').value;
  const errEl = document.getElementById('regError');

  if (!name || !tgId) {
    errEl.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –§–ò–û –∏ Telegram ID';
    errEl.style.display = 'block';
    return;
  }

  document.getElementById('regBtnText').textContent = '‚è≥ –û—Ç–ø—Ä–∞–≤–ª—è—é...';
  errEl.style.display = 'none';

  const ok = await selfRegister({
    name, telegram_id: tgId, phone, email, role, project
  });

  if (ok) {
    errEl.style.display = 'block';
    errEl.style.color = 'var(--green)';
    errEl.textContent = '‚úÖ –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞! –û–∂–∏–¥–∞–π—Ç–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è CEO. –ü–æ—Å–ª–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è –≤–æ–π–¥–∏—Ç–µ –ø–æ Telegram ID.';
    document.getElementById('regBtnText').textContent = '‚úÖ –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞';
  } else {
    errEl.textContent = '‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.';
    errEl.style.display = 'block';
    document.getElementById('regBtnText').textContent = 'üìù –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É';
  }
}

function doLogout() {
  USER=null; localStorage.removeItem('rkt_user');
  if(refreshTimer) clearInterval(refreshTimer);
  document.getElementById('mainApp').style.display='none';
  document.getElementById('loginScreen').style.display='flex';
  document.getElementById('loginTgId').value='';
  resetLogin(); document.getElementById('loginError').style.display='none';
}

function showApp() {
  document.getElementById('loginScreen').style.display='none';
  document.getElementById('mainApp').style.display='flex';
  const p = getUserPerms();
  document.getElementById('userName').textContent = USER.name;
  document.getElementById('userRoleText').textContent = p.emoji+' '+USER.role;
  document.getElementById('userAvatar').textContent = USER.name.charAt(0).toUpperCase();
  document.getElementById('settingsApiUrl').value = CONFIG.API_URL;
  document.getElementById('settingsAiUrl').value = CONFIG.AI_URL;
  document.getElementById('settingsWriteUrl').value = CONFIG.WRITE_URL;
  document.getElementById('settingsSheetId').value = CONFIG.SHEET_ID;
  document.getElementById('s-name').textContent = USER.name;
  document.getElementById('s-role').textContent = p.emoji+' '+USER.role;
  document.getElementById('s-dir').textContent = USER.direction;
  document.getElementById('s-tgid').textContent = USER.tgId;
  document.getElementById('btn-add-staff').style.display = p.canManageStaff?'':'none';
  document.getElementById('nav-approvals').classList.toggle('hidden', !p.canApprove);
  loadData();
  if(refreshTimer) clearInterval(refreshTimer);
  refreshTimer = setInterval(loadData, CONFIG.REFRESH);
  updateStatusTime(); setInterval(updateStatusTime, 60000);
}

// ============================================================
// DATA
// ============================================================
function normData(d) {
  return {
    partners: Array.isArray(d.partners)?d.partners:[],
    tasks: Array.isArray(d.tasks)?d.tasks:[],
    directions: Array.isArray(d.directions)?d.directions:[],
    staff: Array.isArray(d.staff)?d.staff:[],
    projects: Array.isArray(d.projects)?d.projects:[],
    approvals: Array.isArray(d.approvals)?d.approvals:[],
    comms: Array.isArray(d.comms)?d.comms:[],
    documents: Array.isArray(d.documents)?d.documents:[]
  };
}

async function loadData() {
  setStatus('loading');
  try {
    const r = await fetch(CONFIG.API_URL);
    if(!r.ok) throw new Error('HTTP '+r.status);
    DATA = normData(await r.json());
    renderAll();
    setStatus('connected');
    toast('‚úÖ –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã','success');
  } catch(e) {
    console.error(e);
    setStatus('error');
    toast('‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏','error');
  }
}

async function apiWrite(sheet, row) {
  try {
    // POST body (for updated API)
    const r = await fetch(CONFIG.WRITE_URL, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ sheet, data: row, sheetId: CONFIG.SHEET_ID })
    });
    if(!r.ok) throw new Error('POST HTTP '+r.status);
    return true;
  } catch(e) {
    // Fallback: GET with base64 (legacy)
    try {
      const b64 = btoa(unescape(encodeURIComponent(JSON.stringify({sheet,row}))));
      const r2 = await fetch(CONFIG.WRITE_URL+'?b64='+b64);
      if(!r2.ok) throw new Error('GET HTTP '+r2.status);
      return true;
    } catch(e2) { toast('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏: '+e2.message,'error'); return false; }
  }
}

// ============================================================
// FILTERING
// ============================================================
function filterByRole(arr) {
  const p = getUserPerms();
  if (p.seeAll || !USER || USER.direction==='–í—Å–µ') return arr;
  return arr.filter(i => { const d=i['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||''; return d===USER.direction||d==='–í—Å–µ'||d==='–û–±—â–µ–µ'||d===''; });
}

function filterBySearch(arr, sid, fields) {
  const e = document.getElementById(sid);
  if(!e) return arr;
  const q = e.value.toLowerCase().trim();
  if(!q) return arr;
  return arr.filter(i => fields.some(f => (i[f]||'').toLowerCase().includes(q)));
}

function filterByDir(arr, dir) {
  if(!dir||dir==='–í—Å–µ') return arr;
  return arr.filter(i => (i['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'').includes(dir));
}

// Which top-level project does a direction belong to?
function dirToProject(dir) {
  for (const [key, proj] of Object.entries(PROJECTS)) {
    if (proj.subprojects[dir]) return key;
  }
  return null;
}

// Get all direction names for a top-level project
function getProjectDirs(projKey) {
  const p = PROJECTS[projKey];
  return p ? Object.keys(p.subprojects) : [];
}

// Filter data by top-level project (all its subproject directions)
function filterByProject(arr, projKey) {
  const dirs = getProjectDirs(projKey);
  return arr.filter(i => dirs.includes(i['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||''));
}

// ============================================================
// NAVIGATION
// ============================================================
function showPage(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  const pe = document.getElementById('page-'+page);
  const ne = document.querySelector('[data-page="'+page+'"]');
  if(pe) pe.classList.add('active');
  if(ne) ne.classList.add('active');
  document.getElementById('sidebar').classList.remove('open');
  if(page==='home') { currentProject=null; currentSubproject=null; }
}

function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }

function openProject(projKey) {
  currentProject = projKey;
  currentSubproject = null;
  currentPvTab = 'overview';
  showPage('project');
  renderProjectView();
}

function openSubproject(spName) {
  currentSubproject = spName;
  currentSpTab = 'overview';
  showPage('subproject');
  // Show site generator tab only for "–°–∞–π—Ç—ã" project
  const siteGenTab = document.querySelector('.tab-sitegen');
  if (siteGenTab) siteGenTab.style.display = (currentProject === 'sites') ? '' : 'none';
  renderSubprojectView();
}

function showPvTab(tab) {
  currentPvTab = tab;
  document.querySelectorAll('#pv-tabs .tab').forEach(t => t.classList.toggle('active', t.getAttribute('data-tab')===tab));
  renderProjectView();
}

function showSpTab(tab) {
  currentSpTab = tab;
  document.querySelectorAll('#sp-tabs .tab').forEach(t => t.classList.toggle('active', t.getAttribute('data-tab')===tab));
  renderSubprojectView();
}

// ============================================================
// RENDER: MASTER
// ============================================================
function renderAll() {
  renderHome();
  renderDashboard();
  renderPartnerFilters();
  renderPartners();
  renderTaskFilters();
  renderTasks();
  renderStaff();
  renderApprovals();
  renderComms();
  renderSettings();
  updateBadges();
  if(currentProject && !currentSubproject) renderProjectView();
  if(currentSubproject) renderSubprojectView();
}

function updateBadges() {
  const fp = filterByRole(DATA.partners);
  const ft = filterByRole(DATA.tasks).filter(t => (t['–°—Ç–∞—Ç—É—Å']||'')!=='–ì–æ—Ç–æ–≤–æ');
  const pa = DATA.approvals.filter(a => (a['–°—Ç–∞—Ç—É—Å']||'').includes('–û–∂–∏–¥–∞–µ—Ç'));
  document.getElementById('badge-partners').textContent = fp.length;
  document.getElementById('badge-tasks').textContent = ft.length;
  document.getElementById('badge-approvals').textContent = pa.length;
}

// ============================================================
// RENDER: HOME ‚Äî TOP-LEVEL PROJECT CARDS
// ============================================================
function renderHome() {
  const allPartners = filterByRole(DATA.partners);
  const allTasks = filterByRole(DATA.tasks);
  const allProjects = filterByRole(DATA.projects);
  const td = today();
  const overdue = allTasks.filter(t => t['–î–µ–¥–ª–∞–π–Ω'] && t['–î–µ–¥–ª–∞–π–Ω']<td && (t['–°—Ç–∞—Ç—É—Å']||'')!=='–ì–æ—Ç–æ–≤–æ');
  const active = allTasks.filter(t => (t['–°—Ç–∞—Ç—É—Å']||'')!=='–ì–æ—Ç–æ–≤–æ');

  // Total metrics across all projects
  document.getElementById('home-metrics').innerHTML =
    '<div class="metric-card"><div class="m-icon">ü§ù</div><div class="m-value">'+allPartners.length+'</div><div class="m-label">–ü–∞—Ä—Ç–Ω—ë—Ä–æ–≤</div></div>'+
    '<div class="metric-card"><div class="m-icon">üìÅ</div><div class="m-value">'+allProjects.length+'</div><div class="m-label">–ü—Ä–æ–µ–∫—Ç–æ–≤</div></div>'+
    '<div class="metric-card"><div class="m-icon">‚úÖ</div><div class="m-value">'+active.length+'</div><div class="m-label">–ó–∞–¥–∞—á</div></div>'+
    '<div class="metric-card"><div class="m-icon">üî¥</div><div class="m-value" style="color:'+(overdue.length?'var(--red)':'var(--green)')+'">'+overdue.length+'</div><div class="m-label">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</div></div>'+
    '<div class="metric-card"><div class="m-icon">üë•</div><div class="m-value">'+DATA.staff.length+'</div><div class="m-label">–ö–æ–º–∞–Ω–¥–∞</div></div>';

  // Project cards
  let html = '';
  for (const [key, proj] of Object.entries(PROJECTS)) {
    const dirs = getProjectDirs(key);
    const pp = allPartners.filter(p => dirs.includes(p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||''));
    const pt = allTasks.filter(t => dirs.includes(t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||''));
    const ptActive = pt.filter(t => (t['–°—Ç–∞—Ç—É—Å']||'')!=='–ì–æ—Ç–æ–≤–æ');
    const ptOverdue = ptActive.filter(t => t['–î–µ–¥–ª–∞–π–Ω'] && t['–î–µ–¥–ª–∞–π–Ω']<td);
    const ppr = allProjects.filter(p => dirs.includes(p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||''));
    const avgPr = ppr.length ? Math.round(ppr.reduce((s,p) => s+(parseInt(p['–ü—Ä–æ–≥—Ä–µ—Å—Å'])||0),0)/ppr.length) : 0;

    let stTag = '';
    if (ptOverdue.length) stTag = '<span class="status-tag" style="background:var(--red-glow);color:var(--red)">üî¥ '+ptOverdue.length+' –ø—Ä–æ—Å—Ä–æ—á.</span>';
    else if (ptActive.length) stTag = '<span class="status-tag" style="background:var(--accent-glow);color:var(--accent)">–í —Ä–∞–±–æ—Ç–µ</span>';
    else stTag = '<span class="status-tag" style="background:rgba(136,153,170,0.15);color:var(--text2)">–°—Ç–∞—Ä—Ç</span>';

    html += '<div class="project-card" onclick="openProject(\''+key+'\')">';
    html += '<div class="project-card-top" style="background:'+proj.gradient+'"></div>';
    html += stTag;
    html += '<div class="project-card-header">';
    html += '<span class="emoji">'+proj.emoji+'</span>';
    html += '<h3>'+esc(proj.name)+'</h3>';
    html += '<div class="desc">'+esc(proj.desc)+'</div>';
    html += '</div>';
    html += '<div class="project-card-stats">';
    html += '<div class="pcs"><div class="v" style="color:'+proj.color+'">'+Object.keys(proj.subprojects).length+'</div><div class="l">–ü–æ–¥–ø—Ä–æ–µ–∫—Ç–æ–≤</div></div>';
    html += '<div class="pcs"><div class="v" style="color:'+proj.color+'">'+pp.length+'</div><div class="l">–ü–∞—Ä—Ç–Ω—ë—Ä–æ–≤</div></div>';
    html += '<div class="pcs"><div class="v" style="color:'+proj.color+'">'+ptActive.length+'</div><div class="l">–ó–∞–¥–∞—á</div></div>';
    html += '</div>';
    html += '<div class="project-card-progress">';
    html += '<div class="bar"><div class="fill" style="width:'+avgPr+'%;background:'+proj.color+'"></div></div>';
    html += '<div class="info"><span>–ü—Ä–æ–≥—Ä–µ—Å—Å</span><span>'+avgPr+'%</span></div>';
    html += '</div></div>';
  }

  // Add project card
  html += '<div class="project-card add-card" onclick="openModal(\'newproject\')">';
  html += '<span class="add-icon">‚ûï</span>';
  html += '<span class="add-text">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</span>';
  html += '</div>';

  document.getElementById('project-grid').innerHTML = html;
}

// ============================================================
// RENDER: PROJECT VIEW (subprojects)
// ============================================================
function renderProjectView() {
  if(!currentProject) return;
  const proj = PROJECTS[currentProject];
  if(!proj) return;
  const td = today();

  document.getElementById('pv-name').textContent = proj.name;
  document.getElementById('pv-title').innerHTML = proj.emoji + ' ' + esc(proj.name);
  // Show quick site button only for projects that support subprojects (site projects)
  const qsBtn = document.getElementById('btn-quick-site');
  if (qsBtn) qsBtn.style.display = proj.canAddSub ? '' : 'none';
  document.getElementById('btn-add-sub').style.display = proj.canAddSub ? '' : 'none';

  const dirs = getProjectDirs(currentProject);
  const pp = filterByRole(DATA.partners).filter(p => dirs.includes(p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||''));
  const pt = filterByRole(DATA.tasks).filter(t => dirs.includes(t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||''));
  const ppr = filterByRole(DATA.projects).filter(p => dirs.includes(p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||''));
  const ptActive = pt.filter(t => (t['–°—Ç–∞—Ç—É—Å']||'')!=='–ì–æ—Ç–æ–≤–æ');
  const ptOverdue = ptActive.filter(t => t['–î–µ–¥–ª–∞–π–Ω'] && t['–î–µ–¥–ª–∞–π–Ω']<td);
  const avgPr = ppr.length ? Math.round(ppr.reduce((s,p) => s+(parseInt(p['–ü—Ä–æ–≥—Ä–µ—Å—Å'])||0),0)/ppr.length) : 0;

  // Metrics
  document.getElementById('pv-metrics').innerHTML =
    '<div class="metric-card"><div class="m-icon">üìÇ</div><div class="m-value">'+Object.keys(proj.subprojects).length+'</div><div class="m-label">–ü–æ–¥–ø—Ä–æ–µ–∫—Ç–æ–≤</div></div>'+
    '<div class="metric-card"><div class="m-icon">ü§ù</div><div class="m-value">'+pp.length+'</div><div class="m-label">–ü–∞—Ä—Ç–Ω—ë—Ä–æ–≤</div></div>'+
    '<div class="metric-card"><div class="m-icon">‚úÖ</div><div class="m-value">'+ptActive.length+'</div><div class="m-label">–ó–∞–¥–∞—á</div><div class="m-sub">'+(ptOverdue.length?'üî¥ '+ptOverdue.length+' –ø—Ä–æ—Å—Ä–æ—á.':'–≤ —Ä–∞–±–æ—Ç–µ')+'</div></div>'+
    '<div class="metric-card"><div class="m-icon">üìà</div><div class="m-value">'+avgPr+'%</div><div class="m-label">–ü—Ä–æ–≥—Ä–µ—Å—Å</div></div>'+
    '<div class="metric-card"><div class="m-icon">üìÅ</div><div class="m-value">'+ppr.length+'</div><div class="m-label">–ü—Ä–æ–µ–∫—Ç–æ–≤</div></div>';

  // Subproject cards grid
  let sgHtml = '';
  for (const [spName, spMeta] of Object.entries(proj.subprojects)) {
    const spp = pp.filter(p => (p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'')===spName);
    const spt = ptActive.filter(t => (t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'')===spName);
    const spOverdue = spt.filter(t => t['–î–µ–¥–ª–∞–π–Ω'] && t['–î–µ–¥–ª–∞–π–Ω']<td);

    sgHtml += '<div class="subproject-card" onclick="openSubproject(\''+escA(spName)+'\')">';
    sgHtml += '<div style="position:absolute;top:0;left:0;right:0;height:3px;background:'+spMeta.color+'"></div>';
    sgHtml += '<span class="sp-emoji">'+spMeta.emoji+'</span>';
    sgHtml += '<h4>'+esc(spName)+'</h4>';
    sgHtml += '<div class="sp-desc">'+esc(spMeta.desc)+'</div>';
    sgHtml += '<div class="sp-stats">';
    sgHtml += '<span>ü§ù '+spp.length+'</span>';
    sgHtml += '<span>‚úÖ '+spt.length+'</span>';
    if (spOverdue.length) sgHtml += '<span style="color:var(--red)">üî¥ '+spOverdue.length+'</span>';
    sgHtml += '</div></div>';
  }

  // Add subproject card (only for sites etc.)
  if (proj.canAddSub) {
    sgHtml += '<div class="subproject-card add-sub" onclick="openAddSubproject()">';
    sgHtml += '<span class="add-icon" style="font-size:32px;opacity:0.4">‚ûï</span>';
    sgHtml += '<span style="font-size:12px;color:var(--text2)">–î–æ–±–∞–≤–∏—Ç—å</span>';
    sgHtml += '</div>';
  }

  document.getElementById('subproject-grid').innerHTML = sgHtml;

  // Tab content
  const content = document.getElementById('pv-content');
  let html = '';

  if (currentPvTab === 'overview') {
    // Overdue
    if (ptOverdue.length) {
      html += '<div class="card" style="border-color:rgba(255,107,107,0.4)"><div class="card-header" style="background:rgba(255,107,107,0.05)"><h3>üî¥ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ ('+ptOverdue.length+')</h3></div>';
      html += '<div class="table-wrap"><table><thead><tr><th>–ó–∞–¥–∞—á–∞</th><th>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</th><th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th><th>–î–µ–¥–ª–∞–π–Ω</th><th></th></tr></thead><tbody>';
      html += ptOverdue.map(t => '<tr style="background:rgba(255,107,107,0.03)"><td>'+esc(t['–û–ø–∏—Å–∞–Ω–∏–µ']||t['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</td><td>'+esc(t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'])+'</td><td>'+prBadge(t['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç'])+'</td><td style="color:var(--red);font-weight:700">'+esc(t['–î–µ–¥–ª–∞–π–Ω'])+'</td><td>'+actBtns('task',t.ID,t['–û–ø–∏—Å–∞–Ω–∏–µ'])+'</td></tr>').join('');
      html += '</tbody></table></div></div>';
    }
    // Active projects
    if (ppr.length) {
      html += '<div class="card"><div class="card-header"><h3>üìÅ –ü—Ä–æ–µ–∫—Ç—ã ('+ppr.length+')</h3></div>';
      html += '<div class="table-wrap"><table><thead><tr><th>–ü—Ä–æ–µ–∫—Ç</th><th>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ü—Ä–æ–≥—Ä–µ—Å—Å</th><th>–î–µ–¥–ª–∞–π–Ω</th></tr></thead><tbody>';
      html += ppr.map(p => '<tr><td><strong>'+esc(p['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</strong></td><td>'+esc(p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'])+'</td><td>'+statusBadge(p['–°—Ç–∞—Ç—É—Å'])+'</td><td>'+progBar(p['–ü—Ä–æ–≥—Ä–µ—Å—Å'])+'</td><td>'+esc(p['–î–µ–¥–ª–∞–π–Ω']||'‚Äî')+'</td></tr>').join('');
      html += '</tbody></table></div></div>';
    }
    // Recent tasks
    const pOrder = {P1:1,P2:2,P3:3};
    const topT = [...ptActive].sort((a,b) => (pOrder[a['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']]||9)-(pOrder[b['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']]||9)).slice(0,10);
    html += '<div class="card"><div class="card-header"><h3>‚úÖ –ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏</h3></div>';
    html += '<div class="table-wrap"><table><thead><tr><th>–ó–∞–¥–∞—á–∞</th><th>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</th><th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–µ–¥–ª–∞–π–Ω</th><th></th></tr></thead><tbody>';
    html += topT.length ? topT.map(t => {
      const od = t['–î–µ–¥–ª–∞–π–Ω']&&t['–î–µ–¥–ª–∞–π–Ω']<td;
      return '<tr style="'+(od?'background:rgba(255,107,107,0.03)':'')+'"><td>'+(od?'üî¥ ':'')+esc(t['–û–ø–∏—Å–∞–Ω–∏–µ']||t['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</td><td>'+esc(t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'])+'</td><td>'+prBadge(t['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç'])+'</td><td>'+statusBadge(t['–°—Ç–∞—Ç—É—Å'])+'</td><td>'+esc(t['–î–µ–¥–ª–∞–π–Ω']||'‚Äî')+'</td><td>'+actBtns('task',t.ID,t['–û–ø–∏—Å–∞–Ω–∏–µ'])+'</td></tr>';
    }).join('') : emptyRow(6,'–ù–µ—Ç –∑–∞–¥–∞—á');
    html += '</tbody></table></div></div>';

  } else if (currentPvTab === 'tasks') {
    html += renderTaskTable(pt);
  } else if (currentPvTab === 'partners') {
    html += renderPartnerTable(pp);
  } else if (currentPvTab === 'staff') {
    // Staff for this project
    const projName = PROJECTS[currentProject]?.name || '';
    const projectStaff = getStaffForProject(projName).filter(s => (s['–°—Ç–∞—Ç—É—Å']||'–ê–∫—Ç–∏–≤–Ω—ã–π')!=='–û–∂–∏–¥–∞–µ—Ç');
    const roleColors = {CEO:'linear-gradient(135deg,#00d4aa,#4dabf7)','–ó–∞–º':'linear-gradient(135deg,#b197fc,#7950f2)','–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å':'linear-gradient(135deg,#ffa94d,#fd7e14)'};
    html += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:12px">';
    const roleOrd = {'CEO':0,'–ó–∞–º':1,'–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å':2};
    [...projectStaff].sort((a,b)=>(roleOrd[a['–†–æ–ª—å']]??9)-(roleOrd[b['–†–æ–ª—å']]??9)).forEach(s => {
      const bg = roleColors[s['–†–æ–ª—å']]||'linear-gradient(135deg,var(--text3),var(--text2))';
      const tc = DATA.tasks.filter(t=>(t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'').includes(s['–ò–º—è']||'___')&&(t['–°—Ç–∞—Ç—É—Å']||'')!=='–ì–æ—Ç–æ–≤–æ').length;
      html += '<div style="background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:14px;display:flex;align-items:center;gap:12px">';
      html += '<div style="width:40px;height:40px;border-radius:50%;background:'+bg+';display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--bg);font-size:16px;flex-shrink:0">'+esc((s['–ò–º—è']||'?')[0])+'</div>';
      html += '<div><div style="font-weight:600;font-size:13px">'+esc(s['–ò–º—è']||'‚Äî')+'</div>';
      html += '<div style="font-size:11px;color:var(--text2)">'+({CEO:'üëë',–ó–∞–º:'‚≠ê',–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å:'üìã'}[s['–†–æ–ª—å']]||'üë§')+' '+esc(s['–†–æ–ª—å']||'')+' ¬∑ '+esc(s['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'–í—Å–µ')+'</div>';
      if(tc) html += '<div style="font-size:10px;color:var(--orange)">üìã '+tc+' –∑–∞–¥–∞—á</div>';
      html += '</div></div>';
    });
    if(!projectStaff.length) html += '<div class="empty" style="grid-column:1/-1"><div class="icon">üë•</div><p>–ù–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</p></div>';
    html += '</div>';
  } else if (currentPvTab === 'timeline') {
    // Gantt / Timeline
    html += renderTimeline(pt, dirs);
  } else if (currentPvTab === 'comms') {
    const pNames = pp.map(p => p['–ù–∞–∑–≤–∞–Ω–∏–µ']).filter(Boolean);
    const dc = (DATA.comms||[]).filter(c => pNames.some(n => (c['–ü–∞—Ä—Ç–Ω—ë—Ä']||'').includes(n)));
    html += renderCommTable(dc);
  }

  content.innerHTML = html;
}

// ============================================================
// RENDER: SUBPROJECT VIEW (workspace inside e.g. –ö–¢ or –ü—ã—à–∫–∏)
// ============================================================
function renderSubprojectView() {
  if (!currentSubproject||!currentProject) return;
  const proj = PROJECTS[currentProject];
  const spMeta = proj?.subprojects[currentSubproject] || { emoji:'üìå', color:'var(--text2)', desc:'' };
  const td = today();

  document.getElementById('sp-parent').textContent = proj.name;
  document.getElementById('sp-parent').setAttribute('onclick', "openProject('"+currentProject+"')");
  document.getElementById('sp-name').textContent = currentSubproject;
  document.getElementById('sp-title').innerHTML = spMeta.emoji + ' ' + esc(currentSubproject);

  const sp = filterByRole(DATA.partners).filter(p => (p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'')===currentSubproject);
  const st = filterByRole(DATA.tasks).filter(t => (t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'')===currentSubproject);
  const spr = filterByRole(DATA.projects).filter(p => (p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'')===currentSubproject);
  const stActive = st.filter(t => (t['–°—Ç–∞—Ç—É—Å']||'')!=='–ì–æ—Ç–æ–≤–æ');
  const stDone = st.filter(t => (t['–°—Ç–∞—Ç—É—Å']||'')==='–ì–æ—Ç–æ–≤–æ');
  const stOverdue = stActive.filter(t => t['–î–µ–¥–ª–∞–π–Ω']&&t['–î–µ–¥–ª–∞–π–Ω']<td);
  const avgPr = spr.length ? Math.round(spr.reduce((s,p) => s+(parseInt(p['–ü—Ä–æ–≥—Ä–µ—Å—Å'])||0),0)/spr.length) : 0;
  const pNames = sp.map(p => p['–ù–∞–∑–≤–∞–Ω–∏–µ']).filter(Boolean);
  const sc = (DATA.comms||[]).filter(c => pNames.some(n => (c['–ü–∞—Ä—Ç–Ω—ë—Ä']||'').includes(n)));

  document.getElementById('sp-metrics').innerHTML =
    '<div class="metric-card"><div class="m-icon">ü§ù</div><div class="m-value">'+sp.length+'</div><div class="m-label">–ü–∞—Ä—Ç–Ω—ë—Ä–æ–≤</div></div>'+
    '<div class="metric-card"><div class="m-icon">‚úÖ</div><div class="m-value">'+stActive.length+'</div><div class="m-label">–ó–∞–¥–∞—á</div><div class="m-sub">'+stDone.length+' –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</div></div>'+
    '<div class="metric-card"><div class="m-icon">üî¥</div><div class="m-value" style="color:'+(stOverdue.length?'var(--red)':'var(--green)')+'">'+stOverdue.length+'</div><div class="m-label">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</div></div>'+
    '<div class="metric-card"><div class="m-icon">üìÅ</div><div class="m-value">'+spr.length+'</div><div class="m-label">–ü—Ä–æ–µ–∫—Ç–æ–≤</div><div class="m-sub">'+avgPr+'% –ø—Ä–æ–≥—Ä–µ—Å—Å</div></div>'+
    '<div class="metric-card"><div class="m-icon">üí¨</div><div class="m-value">'+sc.length+'</div><div class="m-label">–ö–æ–Ω—Ç–∞–∫—Ç–æ–≤</div></div>';

  const content = document.getElementById('sp-content');
  let html = '';

  if (currentSpTab==='overview') {
    // Pipeline stages for site projects
    if (proj && proj.canAddSub) {
      const pipelineStages = [
        { icon: 'üìã', name: '–ê–Ω–∫–µ—Ç–∞', key: '–ó–∞–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∫–µ—Ç—É' },
        { icon: 'üé®', name: '–ü—Ä–∏–º–µ—Ä', key: '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–º–µ—Ä' },
        { icon: 'üì§', name: '–û—Ç–ø—Ä–∞–≤–∫–∞', key: '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä' },
        { icon: 'üí¨', name: '–§–∏–¥–±–µ–∫', key: '–ü–æ–ª—É—á–∏—Ç—å —Ñ–∏–¥–±–µ–∫' },
        { icon: 'üí≥', name: '–û–ø–ª–∞—Ç–∞', key: '–í—ã—Å—Ç–∞–≤–∏—Ç—å —Å—á—ë—Ç' },
        { icon: 'üîß', name: '–£—Å—Ç–∞–Ω–æ–≤–∫–∞', key: '–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∞–π—Ç' },
        { icon: '‚úÖ', name: '–°–¥–∞—á–∞', key: '–°–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç' }
      ];
      html += '<div class="card" style="margin-bottom:16px"><div class="card-header"><h3>üìä –í–æ—Ä–æ–Ω–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞</h3></div>';
      html += '<div style="display:flex;gap:4px;padding:16px;overflow-x:auto">';
      pipelineStages.forEach((stage, idx) => {
        const matchTask = st.find(t => (t['–û–ø–∏—Å–∞–Ω–∏–µ']||'').includes(stage.key));
        const isDone = matchTask && (matchTask['–°—Ç–∞—Ç—É—Å']||'').includes('–ì–æ—Ç–æ–≤–æ');
        const isActive = matchTask && !isDone && (matchTask['–°—Ç–∞—Ç—É—Å']||'').includes('–í —Ä–∞–±–æ—Ç–µ');
        const isOverdue = matchTask && !isDone && matchTask['–î–µ–¥–ª–∞–π–Ω'] && matchTask['–î–µ–¥–ª–∞–π–Ω'] < td;
        const bg = isDone ? 'var(--green)' : isOverdue ? 'var(--red)' : isActive ? 'var(--accent)' : 'var(--bg3)';
        const clr = isDone || isActive || isOverdue ? 'white' : 'var(--text2)';
        html += '<div style="flex:1;min-width:80px;text-align:center;padding:10px 6px;border-radius:10px;background:'+bg+';color:'+clr+';font-size:11px;cursor:pointer" ';
        if (matchTask) html += 'onclick="openTaskDetail(\''+escA(matchTask.ID)+'\')" ';
        html += 'title="'+(matchTask ? esc(matchTask['–°—Ç–∞—Ç—É—Å']||'')+' ‚Äî '+esc(matchTask['–î–µ–¥–ª–∞–π–Ω']||'') : '–ù–µ—Ç –∑–∞–¥–∞—á–∏')+'">';
        html += '<div style="font-size:20px;margin-bottom:4px">'+stage.icon+'</div>';
        html += '<div style="font-weight:600">'+stage.name+'</div>';
        if (matchTask && matchTask['–î–µ–¥–ª–∞–π–Ω']) html += '<div style="font-size:9px;opacity:0.8;margin-top:2px">'+matchTask['–î–µ–¥–ª–∞–π–Ω'].slice(5)+'</div>';
        html += '</div>';
        if (idx < pipelineStages.length - 1) html += '<div style="display:flex;align-items:center;color:var(--text3)">‚Üí</div>';
      });
      html += '</div></div>';
    }

    if (stOverdue.length) {
      html += '<div class="card" style="border-color:rgba(255,107,107,0.4)"><div class="card-header" style="background:rgba(255,107,107,0.05)"><h3>üî¥ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ ('+stOverdue.length+')</h3></div>';
      html += '<div class="table-wrap"><table><thead><tr><th>–ó–∞–¥–∞—á–∞</th><th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th><th>–î–µ–¥–ª–∞–π–Ω</th><th>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th><th></th></tr></thead><tbody>';
      html += stOverdue.map(t => '<tr style="background:rgba(255,107,107,0.03)"><td>'+esc(t['–û–ø–∏—Å–∞–Ω–∏–µ']||t['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</td><td>'+prBadge(t['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç'])+'</td><td style="color:var(--red);font-weight:700">'+esc(t['–î–µ–¥–ª–∞–π–Ω'])+'</td><td>'+esc(t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'‚Äî')+'</td><td>'+actBtns('task',t.ID,t['–û–ø–∏—Å–∞–Ω–∏–µ'])+'</td></tr>').join('');
      html += '</tbody></table></div></div>';
    }
    if (spr.length) {
      html += '<div class="card"><div class="card-header"><h3>üìÅ –ü—Ä–æ–µ–∫—Ç—ã</h3></div><div class="table-wrap"><table><thead><tr><th>–ü—Ä–æ–µ–∫—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ü—Ä–æ–≥—Ä–µ—Å—Å</th><th>–ü–∞—Ä—Ç–Ω—ë—Ä</th><th>–î–µ–¥–ª–∞–π–Ω</th></tr></thead><tbody>';
      html += spr.map(p => '<tr><td><strong>'+esc(p['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</strong></td><td>'+statusBadge(p['–°—Ç–∞—Ç—É—Å'])+'</td><td>'+progBar(p['–ü—Ä–æ–≥—Ä–µ—Å—Å'])+'</td><td>'+esc(p['–ü–∞—Ä—Ç–Ω—ë—Ä']||'')+'</td><td>'+esc(p['–î–µ–¥–ª–∞–π–Ω']||'‚Äî')+'</td></tr>').join('');
      html += '</tbody></table></div></div>';
    }
    const pO = {P1:1,P2:2,P3:3};
    const topT = [...stActive].sort((a,b)=>(pO[a['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']]||9)-(pO[b['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']]||9)).slice(0,10);
    html += '<div class="card"><div class="card-header"><h3>‚úÖ –ó–∞–¥–∞—á–∏ ('+stActive.length+')</h3></div><div class="table-wrap"><table><thead><tr><th>–ó–∞–¥–∞—á–∞</th><th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th><th>–î–µ–¥–ª–∞–π–Ω</th><th></th></tr></thead><tbody>';
    html += topT.length ? topT.map(t => {
      const od = t['–î–µ–¥–ª–∞–π–Ω']&&t['–î–µ–¥–ª–∞–π–Ω']<td&&(t['–°—Ç–∞—Ç—É—Å']||'')!=='–ì–æ—Ç–æ–≤–æ';
      return '<tr style="'+(od?'background:rgba(255,107,107,0.03)':'')+'"><td>'+(od?'üî¥ ':'')+esc(t['–û–ø–∏—Å–∞–Ω–∏–µ']||t['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</td><td>'+prBadge(t['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç'])+'</td><td>'+statusBadge(t['–°—Ç–∞—Ç—É—Å'])+'</td><td>'+esc(t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'‚Äî')+'</td><td>'+esc(t['–î–µ–¥–ª–∞–π–Ω']||'‚Äî')+'</td><td>'+actBtns('task',t.ID,t['–û–ø–∏—Å–∞–Ω–∏–µ'])+'</td></tr>';
    }).join('') : emptyRow(6,'–ù–µ—Ç –∑–∞–¥–∞—á'); 
    html += '</tbody></table></div></div>';
    if(sp.length) {
      html += '<div class="card"><div class="card-header"><h3>ü§ù –ü–∞—Ä—Ç–Ω—ë—Ä—ã ('+sp.length+')</h3></div><div class="table-wrap"><table><thead><tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–°—Ç—Ä–∞–Ω–∞</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ü—Ä–æ–¥—É–∫—Ç</th><th>–ö–æ–Ω—Ç–∞–∫—Ç</th></tr></thead><tbody>';
      html += sp.map(p => '<tr><td><strong>'+esc(p['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</strong></td><td>'+esc(p['–°—Ç—Ä–∞–Ω–∞'])+'</td><td>'+statusBadge(p['–°—Ç–∞—Ç—É—Å'])+'</td><td>'+esc(p['–ü—Ä–æ–¥—É–∫—Ç']||'')+'</td><td>'+esc(p['–ö–æ–Ω—Ç–∞–∫—Ç']||'')+'</td></tr>').join('');
      html += '</tbody></table></div></div>';
    }
    if(!html) html = '<div class="empty"><div class="icon">üöÄ</div><p>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ¬´'+esc(currentSubproject)+'¬ª –ø–æ–∫–∞ –ø—É—Å—Ç–æ–µ.</p></div>';

  } else if (currentSpTab==='tasks') { html += renderTaskTable(st);
  } else if (currentSpTab==='partners') { html += renderPartnerTable(sp);
  } else if (currentSpTab==='projects') {
    html += '<div class="card"><div class="table-wrap"><table><thead><tr><th>–ü—Ä–æ–µ–∫—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th><th>–ü—Ä–æ–≥—Ä–µ—Å—Å</th><th>–ü–∞—Ä—Ç–Ω—ë—Ä</th><th>–ë—é–¥–∂–µ—Ç</th><th>–î–µ–¥–ª–∞–π–Ω</th><th></th></tr></thead><tbody>';
    html += spr.length ? spr.map(p => '<tr><td><strong>'+esc(p['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</strong></td><td>'+statusBadge(p['–°—Ç–∞—Ç—É—Å'])+'</td><td>'+prBadge(p['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç'])+'</td><td>'+progBar(p['–ü—Ä–æ–≥—Ä–µ—Å—Å'])+'</td><td>'+esc(p['–ü–∞—Ä—Ç–Ω—ë—Ä']||'')+'</td><td>'+esc(p['–ë—é–¥–∂–µ—Ç']||'‚Äî')+'</td><td>'+esc(p['–î–µ–¥–ª–∞–π–Ω']||'‚Äî')+'</td><td>'+actBtns('project',p.ID,p['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</td></tr>').join('') : emptyRow(8,'–ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤');
    html += '</tbody></table></div></div>';
  } else if (currentSpTab==='comms') { html += renderCommTable(sc); 
  } else if (currentSpTab==='sitegen') { html += renderSiteGenerator(); 
  } else if (currentSpTab==='files') { html += renderFilesSection(); }

  content.innerHTML = html;
  
  // Init site generator if needed
  if (currentSpTab==='sitegen') initSiteGenerator();
  if (currentSpTab==='files') initFileUpload();
}

// Reusable table renderers
function renderTaskTable(data) {
  const pO = {P1:1,P2:2,P3:3};
  const sorted = [...data].sort((a,b)=>(pO[a['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']]||9)-(pO[b['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']]||9));
  const td = today();
  let h = '<div class="card"><div class="table-wrap"><table><thead><tr><th>–ó–∞–¥–∞—á–∞</th><th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th><th>–ü—Ä–æ–µ–∫—Ç</th><th>–î–µ–¥–ª–∞–π–Ω</th><th></th></tr></thead><tbody>';
  h += sorted.length ? sorted.map(t => {
    const od = t['–î–µ–¥–ª–∞–π–Ω']&&t['–î–µ–¥–ª–∞–π–Ω']<td&&(t['–°—Ç–∞—Ç—É—Å']||'')!=='–ì–æ—Ç–æ–≤–æ';
    return '<tr style="'+(od?'background:rgba(255,107,107,0.05)':'')+'"><td>'+(od?'üî¥ ':'')+esc(t['–û–ø–∏—Å–∞–Ω–∏–µ']||t['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</td><td>'+prBadge(t['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç'])+'</td><td>'+statusBadge(t['–°—Ç–∞—Ç—É—Å'])+'</td><td>'+esc(t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'‚Äî')+'</td><td>'+esc(t['–ü—Ä–æ–µ–∫—Ç']||'‚Äî')+'</td><td>'+(od?'<span style="color:var(--red);font-weight:700">':'')+esc(t['–î–µ–¥–ª–∞–π–Ω']||'‚Äî')+(od?'</span>':'')+'</td><td>'+actBtns('task',t.ID,t['–û–ø–∏—Å–∞–Ω–∏–µ']||t['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</td></tr>';
  }).join('') : emptyRow(7,'–ù–µ—Ç –∑–∞–¥–∞—á');
  h += '</tbody></table></div></div>';
  return h;
}

function renderPartnerTable(data) {
  let h = '<div class="card"><div class="table-wrap"><table><thead><tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–°—Ç—Ä–∞–Ω–∞</th><th>–ü—Ä–æ–¥—É–∫—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ö–æ–Ω—Ç–∞–∫—Ç</th><th>Email</th><th></th></tr></thead><tbody>';
  h += data.length ? data.map(p => '<tr><td><strong>'+esc(p['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</strong></td><td>'+esc(p['–°—Ç—Ä–∞–Ω–∞'])+'</td><td>'+esc(p['–ü—Ä–æ–¥—É–∫—Ç']||'')+'</td><td>'+statusBadge(p['–°—Ç–∞—Ç—É—Å'])+'</td><td>'+esc(p['–ö–æ–Ω—Ç–∞–∫—Ç']||'')+'</td><td>'+esc(p['Email']||'')+'</td><td>'+actBtns('partner',p.ID,p['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</td></tr>').join('') : emptyRow(7,'–ù–µ—Ç –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤');
  h += '</tbody></table></div></div>';
  return h;
}

function renderCommTable(data) {
  let h = '<div class="card"><div class="table-wrap"><table><thead><tr><th>–ü–∞—Ä—Ç–Ω—ë—Ä</th><th>–¢–∏–ø</th><th>–¢–µ–º–∞</th><th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th><th>–î–∞—Ç–∞</th><th>–ê–≤—Ç–æ—Ä</th><th></th></tr></thead><tbody>';
  h += data.length ? data.map(c => '<tr><td><strong>'+esc(c['–ü–∞—Ä—Ç–Ω—ë—Ä'])+'</strong></td><td>'+esc(c['–¢–∏–ø'])+'</td><td>'+esc(c['–¢–µ–º–∞'])+'</td><td style="font-size:12px;max-width:200px;overflow:hidden;text-overflow:ellipsis">'+esc(c['–†–µ–∑—É–ª—å—Ç–∞—Ç']||'')+'</td><td>'+esc(c['–î–∞—Ç–∞']||'‚Äî')+'</td><td>'+esc(c['–ê–≤—Ç–æ—Ä']||'‚Äî')+'</td><td>'+actBtns('comm',c.ID||'',c['–ü–∞—Ä—Ç–Ω—ë—Ä'])+'</td></tr>').join('') : emptyRow(7,'–ù–µ—Ç –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π');
  h += '</tbody></table></div></div>';
  return h;
}

// ============================================================
// RENDER: DASHBOARD (–ì–î)
// ============================================================
function renderDashboard() {
  const fp = filterByRole(DATA.partners);
  const ft = filterByRole(DATA.tasks);
  const fpr = filterByRole(DATA.projects);
  const td = today();
  const active = ft.filter(t => (t['–°—Ç–∞—Ç—É—Å']||'')!=='–ì–æ—Ç–æ–≤–æ');
  const overdue = active.filter(t => t['–î–µ–¥–ª–∞–π–Ω']&&t['–î–µ–¥–ª–∞–π–Ω']<td);

  document.getElementById('dash-metrics').innerHTML =
    '<div class="metric-card"><div class="m-icon">üè¢</div><div class="m-value">'+Object.keys(PROJECTS).length+'</div><div class="m-label">–ü—Ä–æ–µ–∫—Ç–æ–≤</div><div class="m-sub">–†–ö–¢, –°–∞–π—Ç—ã...</div></div>'+
    '<div class="metric-card"><div class="m-icon">ü§ù</div><div class="m-value">'+fp.length+'</div><div class="m-label">–ü–∞—Ä—Ç–Ω—ë—Ä–æ–≤</div><div class="m-sub">'+fp.filter(p=>p['–°—Ç–∞—Ç—É—Å']==='–ê–∫—Ç–∏–≤–Ω—ã–π').length+' –∞–∫—Ç–∏–≤–Ω—ã—Ö</div></div>'+
    '<div class="metric-card"><div class="m-icon">‚úÖ</div><div class="m-value">'+active.length+'</div><div class="m-label">–ó–∞–¥–∞—á –≤ —Ä–∞–±–æ—Ç–µ</div><div class="m-sub">'+(overdue.length?'üî¥ '+overdue.length+' –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ':'–≤—Å—ë –≤ —Å—Ä–æ–∫')+'</div></div>'+
    '<div class="metric-card"><div class="m-icon">üìÅ</div><div class="m-value">'+fpr.length+'</div><div class="m-label">–ü–æ–¥–ø—Ä–æ–µ–∫—Ç–æ–≤</div></div>'+
    '<div class="metric-card"><div class="m-icon">üë•</div><div class="m-value">'+DATA.staff.length+'</div><div class="m-label">–ö–æ–º–∞–Ω–¥–∞</div></div>';

  // Overdue table
  document.getElementById('dash-overdue').innerHTML = overdue.length ? overdue.map(t =>
    '<tr style="background:rgba(255,107,107,0.03)"><td>'+esc(t['–û–ø–∏—Å–∞–Ω–∏–µ']||t['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</td><td>'+esc(t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'])+'</td><td>'+prBadge(t['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç'])+'</td><td style="color:var(--red);font-weight:700">'+esc(t['–î–µ–¥–ª–∞–π–Ω'])+'</td><td>'+esc(t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'‚Äî')+'</td><td>'+actBtns('task',t.ID,t['–û–ø–∏—Å–∞–Ω–∏–µ'])+'</td></tr>'
  ).join('') : emptyRow(6,'–ù–µ—Ç –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á üéâ');

  // Active projects
  const ap = fpr.filter(p => (p['–°—Ç–∞—Ç—É—Å']||'')!=='–ó–∞–≤–µ—Ä—à—ë–Ω').slice(0,10);
  document.getElementById('dash-projects').innerHTML = ap.length ? ap.map(p =>
    '<tr><td><strong>'+esc(p['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</strong></td><td>'+esc(p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'])+'</td><td>'+statusBadge(p['–°—Ç–∞—Ç—É—Å'])+'</td><td>'+progBar(p['–ü—Ä–æ–≥—Ä–µ—Å—Å'])+'</td><td>'+esc(p['–î–µ–¥–ª–∞–π–Ω']||'‚Äî')+'</td></tr>'
  ).join('') : emptyRow(5,'–ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤');

  // Recent comms
  const rc = (DATA.comms||[]).slice(0,5);
  document.getElementById('dash-comms').innerHTML = rc.length ? rc.map(c =>
    '<tr><td>'+esc(c['–ü–∞—Ä—Ç–Ω—ë—Ä'])+'</td><td>'+esc(c['–¢–∏–ø'])+'</td><td>'+esc(c['–¢–µ–º–∞'])+'</td><td>'+esc(c['–î–∞—Ç–∞']||'‚Äî')+'</td><td>'+esc(c['–ê–≤—Ç–æ—Ä']||'‚Äî')+'</td></tr>'
  ).join('') : emptyRow(5,'–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π');
}

// ============================================================
// RENDER: GLOBAL PAGES (Partners, Tasks, Staff, Approvals, Comms, Settings)
// ============================================================
function renderPartnerFilters() {
  const allDirs = ['–í—Å–µ', ...new Set(DATA.partners.map(i=>i['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']).filter(Boolean))];
  const el = document.getElementById('partner-filters');
  if(el) el.innerHTML = allDirs.map(d => '<button class="filter-chip '+(currentFilters.partners===d?'active':'')+'" onclick="currentFilters.partners=\''+escA(d)+'\';renderAll()">'+esc(d)+'</button>').join('');
}

function renderTaskFilters() {
  const allDirs = ['–í—Å–µ', ...new Set(DATA.tasks.map(i=>i['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']).filter(Boolean))];
  const el = document.getElementById('task-filters');
  if(el) el.innerHTML = allDirs.map(d => '<button class="filter-chip '+(currentFilters.tasks===d?'active':'')+'" onclick="currentFilters.tasks=\''+escA(d)+'\';renderTasks()">'+esc(d)+'</button>').join('');
  
  // Populate person dropdown
  const personEl = document.getElementById('task-filter-person');
  if (personEl) {
    const people = ['–í—Å–µ', ...new Set(DATA.tasks.map(t=>t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']).filter(Boolean))];
    const current = personEl.value;
    personEl.innerHTML = people.map(p => '<option value="'+esc(p)+'"'+(p===current?' selected':'')+'>'+esc(p==='–í—Å–µ'?'üë§ –í—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏':p)+'</option>').join('');
  }
}

function renderPartners() {
  let d = filterByRole(DATA.partners);
  d = filterByDir(d, currentFilters.partners==='–í—Å–µ'?null:currentFilters.partners);
  d = filterBySearch(d,'partner-search',['–ù–∞–∑–≤–∞–Ω–∏–µ','–°—Ç—Ä–∞–Ω–∞','–ü—Ä–æ–¥—É–∫—Ç','–ö–æ–Ω—Ç–∞–∫—Ç']);
  document.getElementById('partners-table').innerHTML = d.length ? d.map(p =>
    '<tr><td><strong>'+esc(p['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</strong></td><td>'+esc(p['–°—Ç—Ä–∞–Ω–∞'])+'</td><td>'+esc(p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'])+'</td><td>'+esc(p['–ü—Ä–æ–¥—É–∫—Ç']||'')+'</td><td>'+statusBadge(p['–°—Ç–∞—Ç—É—Å'])+'</td><td>'+esc(p['–ö–æ–Ω—Ç–∞–∫—Ç']||'')+'</td><td>'+actBtns('partner',p.ID,p['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</td></tr>'
  ).join('') : emptyRow(7,'–ù–µ—Ç –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤');
}

function renderTasks() {
  renderTaskFilters();
  let d = filterByRole(DATA.tasks);
  d = filterByDir(d, currentFilters.tasks==='–í—Å–µ'?null:currentFilters.tasks);
  d = filterBySearch(d,'task-search',['–û–ø–∏—Å–∞–Ω–∏–µ','–ù–∞–∑–≤–∞–Ω–∏–µ','–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π','–ü—Ä–æ–µ–∫—Ç']);
  
  // Status filter
  const statusFilter = document.getElementById('task-filter-status')?.value || 'active';
  if (statusFilter === 'active') d = d.filter(t => (t['–°—Ç–∞—Ç—É—Å']||'') !== '‚úÖ –ì–æ—Ç–æ–≤–æ' && (t['–°—Ç–∞—Ç—É—Å']||'') !== '–ì–æ—Ç–æ–≤–æ');
  else if (statusFilter !== '–í—Å–µ') d = d.filter(t => (t['–°—Ç–∞—Ç—É—Å']||'').includes(statusFilter.replace(/[^–∞-—è–ê-–Ø\s]/g,'').trim()));
  
  // Person filter
  const personFilter = document.getElementById('task-filter-person')?.value || '–í—Å–µ';
  if (personFilter !== '–í—Å–µ') d = d.filter(t => (t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'') === personFilter);
  
  const pO = {P1:1,P2:2,P3:3};
  d = [...d].sort((a,b)=>(pO[a['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']]||9)-(pO[b['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']]||9));
  const td = today();
  
  document.getElementById('tasks-table').innerHTML = d.length ? d.map(t => {
    const od = t['–î–µ–¥–ª–∞–π–Ω']&&t['–î–µ–¥–ª–∞–π–Ω']<td&&(t['–°—Ç–∞—Ç—É—Å']||'')!=='–ì–æ—Ç–æ–≤–æ'&&(t['–°—Ç–∞—Ç—É—Å']||'')!=='‚úÖ –ì–æ—Ç–æ–≤–æ';
    return '<tr style="'+(od?'background:rgba(255,107,107,0.05)':'')+'"><td>'+(od?'üî¥ ':'')+esc(t['–û–ø–∏—Å–∞–Ω–∏–µ']||t['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</td><td>'+esc(t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'])+'</td><td>'+prBadge(t['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç'])+'</td><td>'+statusBadge(t['–°—Ç–∞—Ç—É—Å'])+'</td><td>'+esc(t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'‚Äî')+'</td><td>'+(od?'<span style="color:var(--red);font-weight:700">':'')+esc(t['–î–µ–¥–ª–∞–π–Ω']||'‚Äî')+(od?'</span>':'')+'</td><td>'+actBtns('task',t.ID,t['–û–ø–∏—Å–∞–Ω–∏–µ']||t['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</td></tr>';
  }).join('') : emptyRow(7,'–ù–µ—Ç –∑–∞–¥–∞—á');
  
  // Gantt chart
  const ganttEl = document.getElementById('task-gantt');
  if (ganttEl) {
    const showGantt = document.getElementById('task-show-gantt')?.checked;
    ganttEl.innerHTML = showGantt ? renderTimeline(d) : '';
  }
}

// ============================================================
// TIMELINE / GANTT CHART
// ============================================================
function renderTimeline(tasks, directions) {
  if (!tasks || !tasks.length) return '<div class="card" style="padding:20px;text-align:center;color:var(--text2)">–ù–µ—Ç –∑–∞–¥–∞—á —Å –¥–µ–¥–ª–∞–π–Ω–∞–º–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>';
  
  // Filter tasks with deadlines
  const withDates = tasks.filter(t => t['–î–µ–¥–ª–∞–π–Ω']);
  if (!withDates.length) return '<div class="card" style="padding:20px;text-align:center;color:var(--text2)">–ó–∞–¥–∞–π—Ç–µ –¥–µ–¥–ª–∞–π–Ω—ã –∑–∞–¥–∞—á–∞–º –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–ª–∞–Ω-–≥—Ä–∞—Ñ–∏–∫–∞</div>';
  
  // Calculate date range
  const dates = withDates.map(t => t['–î–µ–¥–ª–∞–π–Ω']).sort();
  const td = today();
  let minDate = dates[0] < td ? dates[0] : td;
  let maxDate = dates[dates.length - 1];
  
  // Extend range a bit
  const minD = new Date(minDate); minD.setDate(minD.getDate() - 7);
  const maxD = new Date(maxDate); maxD.setDate(maxD.getDate() + 14);
  const totalDays = Math.max(30, Math.ceil((maxD - minD) / 86400000));
  
  // Group by direction
  const groups = {};
  withDates.forEach(t => {
    const dir = t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] || '–û–±—â–µ–µ';
    (groups[dir] = groups[dir] || []).push(t);
  });
  
  // Month labels
  let months = [];
  let d = new Date(minD);
  while (d <= maxD) {
    const monthNames = ['–Ø–Ω–≤','–§–µ–≤','–ú–∞—Ä','–ê–ø—Ä','–ú–∞–π','–ò—é–Ω','–ò—é–ª','–ê–≤–≥','–°–µ–Ω','–û–∫—Ç','–ù–æ—è','–î–µ–∫'];
    const label = monthNames[d.getMonth()] + ' ' + d.getFullYear();
    const pos = Math.max(0, Math.ceil((d - minD) / 86400000) / totalDays * 100);
    if (!months.length || months[months.length-1].label !== label) months.push({label, pos});
    d.setMonth(d.getMonth() + 1); d.setDate(1);
  }
  
  // Today marker position
  const todayPos = Math.max(0, Math.min(100, Math.ceil((new Date(td) - minD) / 86400000) / totalDays * 100));
  
  const prColors = {P1:'var(--red)',P2:'var(--orange)',P3:'var(--accent)'};
  
  let h = '<div class="card"><div class="card-header"><h3>üìÖ –ü–ª–∞–Ω-–≥—Ä–∞—Ñ–∏–∫</h3></div><div style="padding:16px;overflow-x:auto">';
  
  // Month header
  h += '<div style="position:relative;height:24px;margin-bottom:8px;border-bottom:1px solid var(--border)">';
  months.forEach(m => { h += '<span style="position:absolute;left:'+m.pos+'%;font-size:10px;color:var(--text3);white-space:nowrap">'+m.label+'</span>'; });
  h += '</div>';
  
  // Rows per direction
  Object.entries(groups).forEach(([dir, dirTasks]) => {
    h += '<div style="margin-bottom:12px">';
    h += '<div style="font-size:11px;font-weight:600;color:var(--text2);margin-bottom:4px">üìÇ '+esc(dir)+' ('+dirTasks.length+')</div>';
    
    dirTasks.sort((a,b) => (a['–î–µ–¥–ª–∞–π–Ω']||'').localeCompare(b['–î–µ–¥–ª–∞–π–Ω']||'')).forEach(t => {
      const deadline = new Date(t['–î–µ–¥–ª–∞–π–Ω']);
      // Task bar: starts 30 days before deadline (or creation), ends at deadline
      const created = t['–°–æ–∑–¥–∞–Ω–æ'] ? new Date(t['–°–æ–∑–¥–∞–Ω–æ']) : new Date(deadline - 30*86400000);
      const startPos = Math.max(0, Math.min(100, (created - minD) / 86400000 / totalDays * 100));
      const endPos = Math.max(startPos+2, Math.min(100, (deadline - minD) / 86400000 / totalDays * 100));
      const width = endPos - startPos;
      const color = prColors[t['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']] || 'var(--accent)';
      const isDone = (t['–°—Ç–∞—Ç—É—Å']||'').includes('–ì–æ—Ç–æ–≤–æ');
      const isOverdue = t['–î–µ–¥–ª–∞–π–Ω'] < td && !isDone;
      
      h += '<div style="position:relative;height:22px;margin-bottom:2px">';
      h += '<div style="position:absolute;left:'+startPos+'%;width:'+width+'%;height:18px;background:'+(isDone?'var(--green)':color)+(isDone?'44':'33')+';border:1px solid '+(isDone?'var(--green)':color)+(isDone?'88':'66')+';border-radius:4px;display:flex;align-items:center;padding:0 6px;overflow:hidden;cursor:pointer;transition:all .2s" title="'+esc(t['–û–ø–∏—Å–∞–Ω–∏–µ']||'')+' ‚Äî '+esc(t['–î–µ–¥–ª–∞–π–Ω'])+'" onclick="openTaskDetail(\''+escA(t.ID)+'\')"">';
      h += '<span style="font-size:9px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+(isOverdue?'üî¥ ':isDone?'‚úÖ ':'')+esc(t['–û–ø–∏—Å–∞–Ω–∏–µ']||t['–ù–∞–∑–≤–∞–Ω–∏–µ']||'')+'</span>';
      h += '</div></div>';
    });
    h += '</div>';
  });
  
  // Today line
  h += '<div style="position:absolute;left:'+todayPos+'%;top:0;bottom:0;width:2px;background:var(--accent);opacity:0.5;pointer-events:none;z-index:5"></div>';
  
  h += '</div></div>';
  return h;
}


let staffProjectFilter = '–í—Å–µ';
let staffDirFilter = '–í—Å–µ';

function renderStaffTabs() {
  // Project tabs
  const projects = ['–í—Å–µ', '–†–ö–¢', '–°–∞–π—Ç—ã'];
  const projDirs = {};
  (DATA.directions || []).forEach(d => {
    const p = d['–ü—Ä–æ–µ–∫—Ç'] || '';
    if (p && !projects.includes(p)) projects.push(p);
    (projDirs[p] = projDirs[p] || []).push(d['–ù–∞–∑–≤–∞–Ω–∏–µ'] || '');
  });
  
  const tabsEl = document.getElementById('staff-project-tabs');
  if (tabsEl) {
    tabsEl.innerHTML = projects.map(p => {
      const emoji = p==='–í—Å–µ'?'üè†':p==='–†–ö–¢'?'üè•':p==='–°–∞–π—Ç—ã'?'üåê':'üìÇ';
      const count = getStaffForProject(p).length;
      return '<div class="tab'+(staffProjectFilter===p?' active':'')+'" onclick="filterStaffProject(\''+escA(p)+'\')">'+emoji+' '+esc(p)+' <span style="opacity:.5;font-size:11px">('+count+')</span></div>';
    }).join('');
  }
  
  // Direction tabs (only when specific project selected)
  const dirEl = document.getElementById('staff-direction-tabs');
  if (dirEl) {
    if (staffProjectFilter === '–í—Å–µ') {
      dirEl.innerHTML = '';
    } else {
      const dirs = ['–í—Å–µ', ...(projDirs[staffProjectFilter] || [])];
      dirEl.innerHTML = '<div class="tabs">' + dirs.map(d => {
        const count = d === '–í—Å–µ' ? getStaffForProject(staffProjectFilter).length : 
          DATA.staff.filter(s => (s['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'')=== d || (d==='–í—Å–µ' && (s['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'')==='–í—Å–µ')).length;
        return '<div class="tab tab-sm'+(staffDirFilter===d?' active':'')+'" onclick="filterStaffDir(\''+escA(d)+'\')">'+esc(d)+' <span style="opacity:.5">('+count+')</span></div>';
      }).join('') + '</div>';
    }
  }
}

function filterStaffProject(proj) {
  staffProjectFilter = proj;
  staffDirFilter = '–í—Å–µ';
  renderStaff();
}
function filterStaffDir(dir) {
  staffDirFilter = dir;
  renderStaff();
}

function getStaffForProject(proj) {
  if (proj === '–í—Å–µ') return DATA.staff;
  const projDirs = (DATA.directions || []).filter(d => (d['–ü—Ä–æ–µ–∫—Ç']||'') === proj).map(d => d['–ù–∞–∑–≤–∞–Ω–∏–µ']||'');
  return DATA.staff.filter(s => {
    const dir = s['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] || '';
    const role = s['–†–æ–ª—å'] || '';
    if (dir === '–í—Å–µ' || role === 'CEO') return true;
    if (role === '–ó–∞–º' && (s['–ü—Ä–æ–µ–∫—Ç']||'') === proj) return true;
    if (role === '–ó–∞–º' && dir === proj) return true;
    return dir === proj || projDirs.includes(dir);
  });
}

function renderStaff() {
  renderStaffTabs();
  
  const p = getUserPerms();
  let staff = getStaffForProject(staffProjectFilter);
  
  // Direction filter
  if (staffDirFilter !== '–í—Å–µ') {
    staff = staff.filter(s => {
      const d = s['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'';
      const role = s['–†–æ–ª—å']||'';
      return d === staffDirFilter || role === 'CEO' || role === '–ó–∞–º' || d === '–í—Å–µ';
    });
  }
  
  // Search
  const q = (document.getElementById('staff-search')?.value||'').toLowerCase().trim();
  if (q) staff = staff.filter(s => 
    (s['–ò–º—è']||'').toLowerCase().includes(q) || (s['–†–æ–ª—å']||'').toLowerCase().includes(q) ||
    (s['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'').toLowerCase().includes(q) || (s['Email']||'').toLowerCase().includes(q));
  
  // Stats
  const roles = {};
  staff.forEach(s => { const r=s['–†–æ–ª—å']||'–î—Ä—É–≥–æ–µ'; roles[r]=(roles[r]||0)+1; });
  const statsEl = document.getElementById('staff-stats');
  if (statsEl) {
    statsEl.innerHTML = '<div style="display:flex;flex-wrap:wrap;gap:6px">' +
      Object.entries(roles).map(([r,c]) => '<span style="padding:3px 10px;background:var(--bg3);border-radius:20px;font-size:11px;color:var(--text2)">' + 
        ({CEO:'üëë',–ó–∞–º:'‚≠ê',–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å:'üìã'}[r]||'üë§') + ' ' + esc(r) + ': <b style="color:var(--text)">' + c + '</b></span>').join('') +
      '<span style="padding:3px 10px;background:var(--accent-glow);border-radius:20px;font-size:11px;color:var(--accent);font-weight:600">–í—Å–µ–≥–æ: ' + staff.length + '</span></div>';
  }
  
  // Pending registrations (CEO only)
  const pendingEl = document.getElementById('staff-pending');
  if (pendingEl && p.canManageStaff) {
    const pending = DATA.staff.filter(s => (s['–°—Ç–∞—Ç—É—Å']||'')==='–û–∂–∏–¥–∞–µ—Ç');
    if (pending.length) {
      let ph = '<div class="card" style="border-color:rgba(255,169,77,.4)"><div class="card-header" style="background:rgba(255,169,77,.05)"><h3>‚è≥ –û–∂–∏–¥–∞—é—Ç –æ–¥–æ–±—Ä–µ–Ω–∏—è ('+pending.length+')</h3></div><div style="padding:12px;display:flex;flex-wrap:wrap;gap:10px">';
      pending.forEach(s => {
        ph += '<div style="background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:12px;min-width:200px">';
        ph += '<div style="font-weight:700">'+esc(s['–ò–º—è']||'‚Äî')+'</div>';
        ph += '<div style="font-size:11px;color:var(--text2)">'+esc(s['–†–æ–ª—å']||'')+ ' ¬∑ '+esc(s['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'')+'</div>';
        if(s['Telegram_ID']) ph += '<div style="font-size:11px;color:var(--text3)">TG: '+esc(String(s['Telegram_ID']))+'</div>';
        ph += '<div style="display:flex;gap:6px;margin-top:8px">';
        ph += '<button class="btn btn-sm btn-primary" onclick="approveStaff(\''+escA(s.ID)+'\')">‚úÖ –ü—Ä–∏–Ω—è—Ç—å</button>';
        ph += '<button class="btn btn-sm btn-danger" onclick="confirmDelete(\'staff\',\''+escA(s.ID)+'\',\''+escA(s['–ò–º—è'])+'\')">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>';
        ph += '</div></div>';
      });
      ph += '</div></div>';
      pendingEl.innerHTML = ph;
    } else { pendingEl.innerHTML = ''; }
  }
  
  // Sort: CEO ‚Üí –ó–∞–º ‚Üí –†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å ‚Üí rest
  const roleOrder = {'CEO':0,'–ó–∞–º':1,'–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å':2,'–ú–µ–Ω–µ–¥–∂–µ—Ä':3,'–ò–Ω–∂–µ–Ω–µ—Ä':4};
  staff = [...staff].filter(s=>(s['–°—Ç–∞—Ç—É—Å']||'–ê–∫—Ç–∏–≤–Ω—ã–π')!=='–û–∂–∏–¥–∞–µ—Ç').sort((a,b)=>(roleOrder[a['–†–æ–ª—å']]??9)-(roleOrder[b['–†–æ–ª—å']]??9));
  
  const roleColors = { CEO:'linear-gradient(135deg,#00d4aa,#4dabf7)','–ó–∞–º':'linear-gradient(135deg,#b197fc,#7950f2)',
    '–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å':'linear-gradient(135deg,#ffa94d,#fd7e14)','–ú–µ–Ω–µ–¥–∂–µ—Ä':'linear-gradient(135deg,#4dabf7,#228be6)' };
  
  let h = '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px">';
  if (staff.length) {
    staff.forEach(s => {
      const bg = roleColors[s['–†–æ–ª—å']] || 'linear-gradient(135deg,var(--text3),var(--text2))';
      const initial = (s['–ò–º—è']||'?').charAt(0).toUpperCase();
      const dir = s['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] || '–í—Å–µ';
      const role = s['–†–æ–ª—å'] || '';
      const taskCount = DATA.tasks.filter(t => (t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'').includes(s['–ò–º—è']||'___') && (t['–°—Ç–∞—Ç—É—Å']||'')!=='–ì–æ—Ç–æ–≤–æ').length;
      
      h += '<div style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:16px;transition:all .2s">';
      h += '<div style="display:flex;align-items:center;gap:12px;margin-bottom:10px">';
      h += '<div style="width:44px;height:44px;border-radius:50%;background:'+bg+';display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700;color:var(--bg);flex-shrink:0">'+esc(initial)+'</div>';
      h += '<div><div style="font-weight:700;font-size:14px">'+esc(s['–ò–º—è']||'‚Äî')+'</div>';
      h += '<div style="font-size:11px;color:var(--text2)">'+({CEO:'üëë',–ó–∞–º:'‚≠ê',–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å:'üìã'}[role]||'üë§')+' '+esc(role)+'</div></div>';
      h += '</div>';
      
      // Badges
      h += '<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px">';
      if (role==='–ó–∞–º') h += '<span style="padding:2px 8px;background:var(--purple-glow);color:var(--purple);border-radius:12px;font-size:10px;font-weight:600">–í–µ—Å—å –ø—Ä–æ–µ–∫—Ç</span>';
      else h += '<span style="padding:2px 8px;background:var(--blue-glow);color:var(--blue);border-radius:12px;font-size:10px;font-weight:600">üìÇ '+esc(dir)+'</span>';
      if (taskCount) h += '<span style="padding:2px 8px;background:var(--orange-glow);color:var(--orange);border-radius:12px;font-size:10px;font-weight:600">üìã '+taskCount+' –∑–∞–¥–∞—á</span>';
      h += '</div>';
      
      h += '<div style="display:flex;flex-direction:column;gap:3px;font-size:11px;color:var(--text3)">';
      if(s['Telegram_ID']) h += '<span>üì± '+esc(String(s['Telegram_ID']))+'</span>';
      if(s['Email']) h += '<span>‚úâÔ∏è '+esc(s['Email'])+'</span>';
      if(s['–¢–µ–ª–µ—Ñ–æ–Ω']) h += '<span>üìû '+esc(s['–¢–µ–ª–µ—Ñ–æ–Ω'])+'</span>';
      h += '</div>';
      
      if(p.canManageStaff) {
        h += '<div style="display:flex;gap:6px;margin-top:10px;padding-top:10px;border-top:1px solid var(--border)">';
        h += '<button class="btn btn-sm btn-secondary" onclick="editItem(\'staff\',\''+escA(s.ID)+'\')">‚úèÔ∏è</button>';
        h += '<button class="btn btn-sm btn-danger" onclick="confirmDelete(\'staff\',\''+escA(s.ID)+'\',\''+escA(s['–ò–º—è'])+'\')">üóë</button>';
        h += '</div>';
      }
      h += '</div>';
    });
  } else {
    h += '<div class="empty" style="grid-column:1/-1"><div class="icon">üë•</div><p>–ù–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤'+(staffProjectFilter!=='–í—Å–µ'?' –≤ ¬´'+esc(staffProjectFilter)+'¬ª':'')+'</p></div>';
  }
  h += '</div>';
  document.getElementById('staff-content').innerHTML = h;
}

async function approveStaff(id) {
  const staff = DATA.staff.find(s => s.ID === id);
  if (!staff) return;
  staff['–°—Ç–∞—Ç—É—Å'] = '–ê–∫—Ç–∏–≤–Ω—ã–π';
  const ok = await apiWrite('–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏', { ID: id, '–°—Ç–∞—Ç—É—Å': '–ê–∫—Ç–∏–≤–Ω—ã–π' });
  if (ok) { toast('‚úÖ '+esc(staff['–ò–º—è'])+' –æ–¥–æ–±—Ä–µ–Ω!','success'); renderStaff(); }
}

// Self-registration function (from Telegram bot or web)
async function selfRegister(data) {
  const row = {
    ID: 'S' + String(Date.now()).slice(-5),
    '–ò–º—è': data.name || '',
    '–†–æ–ª—å': data.role || '–°–æ—Ç—Ä—É–¥–Ω–∏–∫',
    '–ü—Ä–æ–µ–∫—Ç': data.project || '',
    '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ': data.direction || '',
    'Telegram_ID': data.telegram_id || '',
    'Email': data.email || '',
    '–¢–µ–ª–µ—Ñ–æ–Ω': data.phone || '',
    '–°—Ç–∞—Ç—É—Å': '–û–∂–∏–¥–∞–µ—Ç',
    '–î–∞—Ç–∞_–¥–æ–±–∞–≤–ª–µ–Ω–∏—è': today()
  };
  return await apiWrite('–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏', row);
}

// Quick site task ‚Äî CEO/–ó–∞–º –≤—Å—Ç–∞–≤–ª—è–µ—Ç —Å—Å—ã–ª–∫—É –Ω–∞ –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç—ã
function openQuickSiteTask() {
  const html = `
    <div style="padding:20px">
      <h3 style="margin-bottom:16px">üåê –ë—ã—Å—Ç—Ä–æ–µ –∑–∞–¥–∞–Ω–∏–µ –ø–æ —Å–∞–π—Ç—É</h3>
      <p style="font-size:13px;color:var(--text2);margin-bottom:16px">–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç—ã –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å–∞ ‚Äî —Å–∏—Å—Ç–µ–º–∞ —Å–æ–∑–¥–∞—Å—Ç –∫–ª–∏–µ–Ω—Ç–∞ –∏ –∑–∞–¥–∞—á–∏ –¥–ª—è –∑–∞–º–∞.</p>
      <div class="form-group">
        <label>üîó –°—Å—ã–ª–∫–∞ –Ω–∞ –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç—ã –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ</label>
        <input type="text" id="qs-link" placeholder="https://yandex.ru/maps/... –∏–ª–∏ –ù–∞–∑–≤–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å–∞" style="width:100%">
      </div>
      <div class="form-group">
        <label>üìç –ì–æ—Ä–æ–¥</label>
        <input type="text" id="qs-city" placeholder="–ù–∞–±–µ—Ä–µ–∂–Ω—ã–µ –ß–µ–ª–Ω—ã" value="–ù–∞–±–µ—Ä–µ–∂–Ω—ã–µ –ß–µ–ª–Ω—ã" style="width:100%">
      </div>
      <div class="form-group">
        <label>üìû –¢–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–µ–Ω—Ç–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)</label>
        <input type="text" id="qs-phone" placeholder="+7..." style="width:100%">
      </div>
      <div class="form-group">
        <label>üë§ –ù–∞–∑–Ω–∞—á–∏—Ç—å –Ω–∞</label>
        <select id="qs-assignee" style="width:100%">
          ${DATA.staff.filter(s => s['–°—Ç–∞—Ç—É—Å']!=='–û–∂–∏–¥–∞–µ—Ç' && s['–°—Ç–∞—Ç—É—Å']!=='‚ùå –£–¥–∞–ª—ë–Ω').map(s =>
            '<option value="'+esc(s['–ò–º—è'])+'">'+esc(s['–ò–º—è'])+' ('+esc(s['–†–æ–ª—å'])+')</option>'
          ).join('')}
        </select>
      </div>
      <div class="form-group">
        <label>üìù –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π CEO</label>
        <textarea id="qs-comment" rows="2" placeholder="–î–æ–ø. –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –∑–∞–º–∞..." style="width:100%"></textarea>
      </div>
      <button class="btn btn-primary" onclick="submitQuickSiteTask()" style="width:100%;margin-top:8px">üöÄ –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ</button>
    </div>`;
  document.getElementById('modalTitle').textContent = 'üåê –ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç –Ω–∞ —Å–∞–π—Ç';
  document.getElementById('modalBody').innerHTML = html;
  document.getElementById('modalSaveBtn').style.display = 'none';
  document.getElementById('modalOverlay').classList.add('show');
}

async function submitQuickSiteTask() {
  const link = document.getElementById('qs-link').value.trim();
  const city = document.getElementById('qs-city').value.trim();
  const phone = document.getElementById('qs-phone').value.trim();
  const assignee = document.getElementById('qs-assignee').value;
  const comment = document.getElementById('qs-comment').value.trim();

  if (!link) { toast('–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ','warning'); return; }

  // Extract name from link or use as-is
  let bizName = link;
  if (link.includes('yandex.ru/maps') || link.includes('2gis')) {
    bizName = '–ö–ª–∏–µ–Ω—Ç_' + String(Date.now()).slice(-4);
  }

  const td = today();
  const proj = PROJECTS['—Å–∞–π—Ç—ã'] || PROJECTS['sites'] || Object.values(PROJECTS).find(p => p.canAddSub);
  const projName = proj ? proj.name : '–°–∞–π—Ç—ã';

  // 1. Create direction (subproject)
  await apiWrite('–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è', {
    ID: 'DIR'+String(Date.now()).slice(-6),
    '–ù–∞–∑–≤–∞–Ω–∏–µ': bizName,
    '–ü—Ä–æ–µ–∫—Ç': projName,
    '–°—Ç–∞—Ç—É—Å': 'üîç –ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞',
    '–≠—Ç–∞–ø': '–õ–∏–¥',
    '–°—Å—ã–ª–∫–∞': link,
    '–¢–µ–ª–µ—Ñ–æ–Ω': phone,
    '–ì–æ—Ä–æ–¥': city,
    '–î–∞—Ç–∞_—Å–æ–∑–¥–∞–Ω–∏—è': td
  });

  // 2. Auto-create pipeline tasks
  const pipeline = [
    { desc: 'üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å –∫–ª–∏–µ–Ω—Ç—É ¬´'+bizName+'¬ª, –¥–æ–≥–æ–≤–æ—Ä–∏—Ç—å—Å—è –æ —Å–∞–π—Ç–µ', days: 1, pr: 'P1' },
    { desc: 'üìã –ó–∞–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∫–µ—Ç—É –¥–ª—è ¬´'+bizName+'¬ª', days: 2, pr: 'P1' },
    { desc: 'üé® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–º–µ—Ä —Å–∞–π—Ç–∞ ¬´'+bizName+'¬ª', days: 3, pr: 'P1' },
    { desc: 'üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä –∫–ª–∏–µ–Ω—Ç—É ¬´'+bizName+'¬ª', days: 4, pr: 'P1' },
    { desc: 'üí¨ –ü–æ–ª—É—á–∏—Ç—å —Ñ–∏–¥–±–µ–∫ –æ—Ç ¬´'+bizName+'¬ª', days: 6, pr: 'P2' },
    { desc: 'üí≥ –í—ã—Å—Ç–∞–≤–∏—Ç—å —Å—á—ë—Ç –∑–∞ –¥–æ–º–µ–Ω/—Ö–æ—Å—Ç–∏–Ω–≥ ¬´'+bizName+'¬ª', days: 8, pr: 'P2' },
    { desc: 'üîß –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∞–π—Ç ¬´'+bizName+'¬ª –Ω–∞ —Ö–æ—Å—Ç–∏–Ω–≥', days: 12, pr: 'P2' },
    { desc: '‚úÖ –°–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç ¬´'+bizName+'¬ª, –ø–æ–ª—É—á–∏—Ç—å –æ–ø–ª–∞—Ç—É', days: 14, pr: 'P3' }
  ];

  for (const task of pipeline) {
    const dl = new Date(); dl.setDate(dl.getDate() + task.days);
    await apiWrite('–ó–∞–¥–∞—á–∏', {
      ID: 'T'+String(Date.now()).slice(-6)+String(Math.random()).slice(2,4),
      '–û–ø–∏—Å–∞–Ω–∏–µ': task.desc + (comment ? '\nüí° CEO: '+comment : ''),
      '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ': bizName,
      '–ü—Ä–æ–µ–∫—Ç': projName,
      '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç': task.pr,
      '–°—Ç–∞—Ç—É—Å': '‚è≥ –í –æ—á–µ—Ä–µ–¥–∏',
      '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π': assignee,
      '–î–µ–¥–ª–∞–π–Ω': dl.toISOString().split('T')[0],
      '–°—Å—ã–ª–∫–∞': link,
      '–°–æ–∑–¥–∞–Ω–æ': td
    });
  }

  closeModal();
  toast('üöÄ –°–æ–∑–¥–∞–Ω –∫–ª–∏–µ–Ω—Ç ¬´'+bizName+'¬ª + 8 –∑–∞–¥–∞—á –¥–ª—è '+assignee, 'success');
  setTimeout(loadData, 2000);
}

function renderApprovals() {
  const el = document.getElementById('approvals-content');
  const p = getUserPerms();
  if (!p.canApprove) { el.innerHTML = '<div class="empty"><div class="icon">üîí</div><p>–¢–æ–ª—å–∫–æ –¥–ª—è CEO</p></div>'; return; }
  const pending = DATA.approvals.filter(a=>(a['–°—Ç–∞—Ç—É—Å']||'').includes('–û–∂–∏–¥–∞–µ—Ç'));
  const done = DATA.approvals.filter(a=>!(a['–°—Ç–∞—Ç—É—Å']||'').includes('–û–∂–∏–¥–∞–µ—Ç')).slice(0,20);

  let h = '<div class="card" style="margin-bottom:16px"><div class="card-header"><h3>‚è≥ –û–∂–∏–¥–∞—é—Ç –æ–¥–æ–±—Ä–µ–Ω–∏—è ('+pending.length+')</h3></div>';
  if (pending.length) {
    h += pending.map(a => {
      let preview = '';
      try {
        const d = JSON.parse(a['–î–∞–Ω–Ω—ã–µ']||'{}');
        preview = Object.entries(d).filter(([k,v])=>v&&k!=='ID'&&k!=='row_number').slice(0,5).map(([k,v])=>'<span style="font-size:11px;background:var(--bg3);padding:2px 6px;border-radius:4px;margin:2px">'+esc(k)+': '+esc(String(v).substring(0,40))+'</span>').join(' ');
      } catch(e) {}
      return '<div class="card" style="padding:16px;margin:8px 16px;border-left:3px solid var(--accent)">' +
        '<div style="display:flex;justify-content:space-between;align-items:start;gap:12px">' +
        '<div style="flex:1">' +
        '<div style="font-weight:600;font-size:14px">'+esc(a['–¢–∏–ø']||'–ó–∞–ø—Ä–æ—Å')+'</div>' +
        '<div style="font-size:13px;color:var(--text2);margin:4px 0">'+esc(a['–û–ø–∏—Å–∞–Ω–∏–µ']||'')+'</div>' +
        '<div style="font-size:12px;color:var(--text3)">üë§ '+esc(a['–û—Ç_–∫–æ–≥–æ']||'?')+' ('+esc(a['–†–æ–ª—å']||'')+') ¬∑ üìÖ '+esc(a['–î–∞—Ç–∞_–∑–∞–ø—Ä–æ—Å–∞']||'')+'</div>' +
        (a['–õ–∏—Å—Ç'] ? '<div style="font-size:11px;margin-top:4px">üìã –õ–∏—Å—Ç: <b>'+esc(a['–õ–∏—Å—Ç'])+'</b></div>' : '') +
        (preview ? '<div style="margin-top:6px;display:flex;flex-wrap:wrap;gap:2px">'+preview+'</div>' : '') +
        '</div>' +
        '<div style="display:flex;gap:6px;flex-shrink:0">' +
        '<button class="btn btn-primary" style="padding:6px 16px" onclick="handleApproval(\''+escA(a.ID)+'\',true)">‚úÖ –û–¥–æ–±—Ä–∏—Ç—å</button>' +
        '<button class="btn btn-danger" style="padding:6px 12px" onclick="handleApproval(\''+escA(a.ID)+'\',false)">‚ùå</button>' +
        '</div></div></div>';
    }).join('');
  } else {
    h += '<div class="empty" style="padding:30px"><div class="icon">‚ú®</div><p>–ù–µ—Ç –æ–∂–∏–¥–∞—é—â–∏—Ö</p></div>';
  }
  h += '</div>';

  if (done.length) {
    h += '<div class="card"><div class="card-header"><h3>üìã –ò—Å—Ç–æ—Ä–∏—è</h3></div><div class="table-wrap"><table><thead><tr><th>–¢–∏–ø</th><th>–û–ø–∏—Å–∞–Ω–∏–µ</th><th>–û—Ç –∫–æ–≥–æ</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–∞—Ç–∞ —Ä–µ—à–µ–Ω–∏—è</th></tr></thead><tbody>';
    h += done.map(a => '<tr><td>'+esc(a['–¢–∏–ø'])+'</td><td>'+esc(a['–û–ø–∏—Å–∞–Ω–∏–µ'])+'</td><td>'+esc(a['–û—Ç_–∫–æ–≥–æ'])+'</td><td>'+esc(a['–°—Ç–∞—Ç—É—Å'])+'</td><td>'+esc(a['–î–∞—Ç–∞_—Ä–µ—à–µ–Ω–∏—è']||'‚Äî')+'</td></tr>').join('');
    h += '</tbody></table></div></div>';
  }
  el.innerHTML = h;
}

function renderComms() {
  let d = DATA.comms||[];
  d = filterBySearch(d,'comm-search',['–ü–∞—Ä—Ç–Ω—ë—Ä','–¢–µ–º–∞','–†–µ–∑—É–ª—å—Ç–∞—Ç']);
  document.getElementById('comms-table').innerHTML = d.length ? d.map(c =>
    '<tr><td><strong>'+esc(c['–ü–∞—Ä—Ç–Ω—ë—Ä'])+'</strong></td><td>'+esc(c['–¢–∏–ø'])+'</td><td>'+esc(c['–¢–µ–º–∞'])+'</td><td style="font-size:12px;max-width:200px;overflow:hidden;text-overflow:ellipsis">'+esc(c['–†–µ–∑—É–ª—å—Ç–∞—Ç']||'')+'</td><td>'+esc(c['–î–∞—Ç–∞']||'‚Äî')+'</td><td>'+esc(c['–ê–≤—Ç–æ—Ä']||'‚Äî')+'</td><td>'+actBtns('comm',c.ID||'',c['–ü–∞—Ä—Ç–Ω—ë—Ä'])+'</td></tr>'
  ).join('') : emptyRow(7,'–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π');
}

function renderSettings() {
  const stats = [
    {l:'–ü–∞—Ä—Ç–Ω—ë—Ä—ã',v:DATA.partners.length},{l:'–ü—Ä–æ–µ–∫—Ç—ã',v:DATA.projects.length},
    {l:'–ó–∞–¥–∞—á–∏',v:DATA.tasks.length},{l:'–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏',v:DATA.staff.length},
    {l:'–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è',v:DATA.directions.length},{l:'–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏',v:(DATA.comms||[]).length},
    {l:'–í–µ—Ä—Å–∏—è',v:CONFIG.VERSION}
  ];
  document.getElementById('s-stats').innerHTML = stats.map(s => '<div class="detail-item"><div class="detail-label">'+s.l+'</div><div class="detail-value">'+s.v+'</div></div>').join('');

  // Permissions display
  const p = getUserPerms();
  const yn = (v) => v ? '<span style="color:var(--green)">‚úÖ</span>' : '<span style="color:var(--red)">‚ùå</span>';
  let ph = '<div style="margin-bottom:8px;color:var(--text2)">'+esc(p.desc||'')+'</div>';
  ph += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:4px">';
  ph += '<div>'+yn(p.canEditTasks)+' –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∞–º–∏</div>';
  ph += '<div>'+yn(p.canEditPartners)+' –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä—Ç–Ω—ë—Ä–∞–º–∏</div>';
  ph += '<div>'+yn(p.canEditStaff)+' –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏</div>';
  ph += '<div>'+yn(p.canEditProjects)+' –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞–º–∏</div>';
  ph += '<div>'+yn(p.canAssignTasks)+' –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∑–∞–¥–∞—á</div>';
  ph += '<div>'+yn(p.canApprove)+' –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ</div>';
  ph += '<div>'+yn(p.canDelete)+' –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π</div>';
  ph += '<div>'+yn(p.canCreateSiteTask)+' –°–æ–∑–¥–∞–Ω–∏–µ —Å–∞–π—Ç-–∑–∞–¥–∞—á</div>';
  ph += '<div>'+yn(p.canGenerateSite)+' –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∞–π—Ç–æ–≤</div>';
  ph += '<div>'+yn(p.canExport)+' –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
  ph += '</div>';
  if (p.writeSheets && p.writeSheets.length) {
    ph += '<div style="margin-top:8px;font-size:12px;color:var(--text3)">üìù –ü—Ä—è–º–∞—è –∑–∞–ø–∏—Å—å: '+p.writeSheets.join(', ')+'</div>';
  }
  if (p.needsApproval && p.needsApproval.length) {
    ph += '<div style="font-size:12px;color:var(--text3)">‚è≥ –ß–µ—Ä–µ–∑ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ: '+p.needsApproval.join(', ')+'</div>';
  }
  const permsEl = document.getElementById('s-perms');
  if (permsEl) permsEl.innerHTML = ph;
}

function updateConfig(key, value) { CONFIG[key] = value.trim(); }

function saveSettings() {
  localStorage.setItem('rkt_config', JSON.stringify({
    API_URL: CONFIG.API_URL, AI_URL: CONFIG.AI_URL, WRITE_URL: CONFIG.WRITE_URL, SHEET_ID: CONFIG.SHEET_ID
  }));
  toast('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
}

function loadSavedSettings() {
  try {
    const saved = JSON.parse(localStorage.getItem('rkt_config') || '{}');
    if (saved.API_URL) CONFIG.API_URL = saved.API_URL;
    if (saved.AI_URL) CONFIG.AI_URL = saved.AI_URL;
    if (saved.WRITE_URL) CONFIG.WRITE_URL = saved.WRITE_URL;
    if (saved.SHEET_ID) CONFIG.SHEET_ID = saved.SHEET_ID;
  } catch(e) {}
}

async function testConnection() {
  const el = document.getElementById('settings-status');
  el.innerHTML = '‚è≥ –ü—Ä–æ–≤–µ—Ä—è—é...';
  try {
    const url = CONFIG.API_URL;
    if (!url || !url.startsWith('http')) throw new Error('–ù–µ–≤–∞–ª–∏–¥–Ω—ã–π URL');
    const ctrl = new AbortController();
    const tmr = setTimeout(() => ctrl.abort(), 10000);
    const fullUrl = CONFIG.SHEET_ID ? url + '?sheetId=' + encodeURIComponent(CONFIG.SHEET_ID) : url;
    const r = await fetch(fullUrl, { signal: ctrl.signal });
    clearTimeout(tmr);
    if (r.ok) {
      const data = await r.json();
      const p = (data.partners||[]).length;
      const t = (data.tasks||[]).length;
      const s = (data.staff||[]).length;
      el.innerHTML = '<span style="color:var(--green)">‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ! –ü–∞—Ä—Ç–Ω—ë—Ä–æ–≤: '+p+', –ó–∞–¥–∞—á: '+t+', –°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤: '+s+'</span>';
    } else {
      el.innerHTML = '<span style="color:var(--red)">‚ùå HTTP ' + r.status + ' ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ workflow –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –≤ n8n</span>';
    }
  } catch(e) {
    const msg = e.name === 'AbortError' ? '–¢–∞–π–º–∞—É—Ç ‚Äî —Å–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç' :
      e.message.includes('pattern') ? 'Webhook –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –≤ n8n. –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ workflow –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ.' :
      e.message.includes('Failed to fetch') ? '–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ URL –∏ —á—Ç–æ workflow –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω.' : e.message;
    el.innerHTML = '<span style="color:var(--red)">‚ùå ' + msg + '</span>';
  }
}

// ============================================================
// SITE GENERATOR ‚Äî –∞–Ω–∫–µ—Ç–∞ + –ø—Ä–µ–≤—å—é —Å–∞–π—Ç–∞ —á–µ—Ä–µ–∑ Claude
// ============================================================
let siteGenData = {};
let siteGenStep = 'form'; // form | loading | preview

function renderSiteGenerator() {
  if (siteGenStep === 'preview' && siteGenData.html) return renderSitePreview();
  if (siteGenStep === 'loading') return '<div class="card"><div class="card-body" style="text-align:center;padding:60px">' +
    '<div class="spinner" style="margin:0 auto 20px"></div><h3 style="margin-bottom:10px">ü§ñ Claude –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–∞–π—Ç...</h3>' +
    '<p style="color:var(--text2)">–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 20-30 —Å–µ–∫—É–Ω–¥</p></div></div>';

  return '<div class="card"><div class="card-header"><h3>üåê –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å–∞–π—Ç–∞ –¥–ª—è ¬´' + esc(currentSubproject) + '¬ª</h3></div>' +
    '<div class="card-body" style="padding:20px">' +
    '<p style="color:var(--text2);margin-bottom:20px">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∞–Ω–∫–µ—Ç—É ‚Äî Claude —Å–æ–∑–¥–∞—Å—Ç –≥–æ—Ç–æ–≤—ã–π —Å–∞–π—Ç-–≤–∏–∑–∏—Ç–∫—É —Å –≤–∞—à–∏–º –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º.</p>' +
    '<div class="sg-form" id="sg-form">' +

    '<div class="sg-row">' +
    '<div class="sg-field"><label>–ù–∞–∑–≤–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å–∞ *</label><input type="text" id="sg-name" placeholder="–ü—ã—à–∫–∏ –º–∏—Ä–∞" value="' + esc(currentSubproject || '') + '"></div>' +
    '<div class="sg-field"><label>–¢–∏–ø –±–∏–∑–Ω–µ—Å–∞ *</label><input type="text" id="sg-type" placeholder="–†–µ—Å—Ç–æ—Ä–∞–Ω, –∫–∞—Ñ–µ, —Å–∞–ª–æ–Ω..."></div>' +
    '</div>' +

    '<div class="sg-row">' +
    '<div class="sg-field"><label>–ì–æ—Ä–æ–¥</label><input type="text" id="sg-city" placeholder="–ù–∞–±–µ—Ä–µ–∂–Ω—ã–µ –ß–µ–ª–Ω—ã"></div>' +
    '<div class="sg-field"><label>–ê–¥—Ä–µ—Å</label><input type="text" id="sg-address" placeholder="—É–ª. –õ–µ–Ω–∏–Ω–∞, –¥. 1"></div>' +
    '</div>' +

    '<div class="sg-row">' +
    '<div class="sg-field"><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input type="text" id="sg-phone" placeholder="+7 900 123-45-67"></div>' +
    '<div class="sg-field"><label>Instagram / –°–æ—Ü—Å–µ—Ç–∏</label><input type="text" id="sg-social" placeholder="@pyshki_mira"></div>' +
    '</div>' +

    '<div class="sg-field"><label>–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã</label><input type="text" id="sg-hours" placeholder="–ü–Ω-–ü—Ç 10:00-22:00, –°–±-–í—Å 11:00-23:00"></div>' +

    '<div class="sg-field"><label>–û–ø–∏—Å–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å–∞ (—á–µ–º –∑–∞–Ω–∏–º–∞–µ—Ç–µ—Å—å, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏, –£–¢–ü) *</label>' +
    '<textarea id="sg-desc" rows="4" placeholder="–£—é—Ç–Ω–æ–µ –∫–∞—Ñ–µ —Å –¥–æ–º–∞—à–Ω–∏–º–∏ –ø—ã—à–∫–∞–º–∏ –∏ –∫–æ—Ñ–µ. –†–∞–±–æ—Ç–∞–µ–º —Å 2020 –≥–æ–¥–∞. –°–≤–µ–∂–∞—è –≤—ã–ø–µ—á–∫–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å..."></textarea></div>' +

    '<div class="sg-field"><label>–£—Å–ª—É–≥–∏ / –ú–µ–Ω—é (–ø–µ—Ä–µ—á–∏—Å–ª–∏—Ç–µ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>' +
    '<textarea id="sg-services" rows="3" placeholder="–ü—ã—à–∫–∏ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ, –ü—ã—à–∫–∏ —Å –Ω–∞—á–∏–Ω–∫–æ–π, –ö–æ—Ñ–µ, –ß–∞–π, –î–µ—Å–µ—Ä—Ç—ã, –î–æ—Å—Ç–∞–≤–∫–∞..."></textarea></div>' +

    '<div class="sg-field"><label>–¶–µ–Ω—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)</label>' +
    '<input type="text" id="sg-prices" placeholder="–ü—ã—à–∫–∏ –æ—Ç 50‚ÇΩ, –∫–æ—Ñ–µ –æ—Ç 150‚ÇΩ"></div>' +

    '<div class="sg-row">' +
    '<div class="sg-field"><label>–¶–≤–µ—Ç–æ–≤–∞—è —Ç–µ–º–∞</label><select id="sg-theme">' +
    '<option value="auto">ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</option>' +
    '<option value="warm">üî• –¢—ë–ø–ª–∞—è (—Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã, –∫–∞—Ñ–µ)</option>' +
    '<option value="cool">‚ùÑÔ∏è –•–æ–ª–æ–¥–Ω–∞—è (–º–µ–¥–∏—Ü–∏–Ω–∞, IT)</option>' +
    '<option value="dark">üåô –¢—ë–º–Ω–∞—è (–±–∞—Ä—ã, –∫–ª—É–±—ã)</option>' +
    '<option value="nature">üåø –ü—Ä–∏—Ä–æ–¥–Ω–∞—è (—ç–∫–æ, —Å–∞–ª–æ–Ω—ã)</option>' +
    '<option value="luxury">‚ú® –ü—Ä–µ–º–∏—É–º (–±—É—Ç–∏–∫–∏, –æ—Ç–µ–ª–∏)</option>' +
    '</select></div>' +
    '<div class="sg-field"><label>–°—Ç–∏–ª—å</label><select id="sg-style">' +
    '<option value="modern">–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π</option>' +
    '<option value="minimal">–ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π</option>' +
    '<option value="retro">–†–µ—Ç—Ä–æ / –°–æ–≤–µ—Ç—Å–∫–∏–π</option>' +
    '<option value="classic">–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π</option>' +
    '<option value="playful">–Ø—Ä–∫–∏–π / –ò–≥—Ä–∏–≤—ã–π</option>' +
    '</select></div>' +
    '</div>' +

    '<div class="sg-field"><label>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è</label>' +
    '<textarea id="sg-extra" rows="2" placeholder="–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç—É, —Ñ–æ—Ä–º—É –∑–∞–∫–∞–∑–∞, –≥–∞–ª–µ—Ä–µ—é —Ñ–æ—Ç–æ..."></textarea></div>' +

    '<div style="display:flex;gap:10px;margin-top:20px">' +
    '<button class="btn btn-primary" onclick="generateSite()" style="flex:1">üöÄ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–∞–π—Ç</button>' +
    '<button class="btn btn-secondary" onclick="fillSiteDemo()" style="flex:0 0 auto">üìã –ó–∞–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–∏–º–µ—Ä</button>' +
    '</div>' +
    '</div></div></div>';
}

function renderSitePreview() {
  return '<div class="card"><div class="card-header" style="display:flex;justify-content:space-between;align-items:center">' +
    '<h3>üåê –ü—Ä–µ–≤—å—é —Å–∞–π—Ç–∞: ' + esc(siteGenData.name || currentSubproject) + '</h3>' +
    '<div style="display:flex;gap:8px">' +
    '<button class="btn btn-sm" onclick="downloadSiteHtml()">üíæ –°–∫–∞—á–∞—Ç—å HTML</button>' +
    '<button class="btn btn-sm" onclick="copySiteHtml()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>' +
    '<button class="btn btn-sm btn-secondary" onclick="siteGenStep=\'form\';renderSubprojectView()">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–Ω–∫–µ—Ç—É</button>' +
    '<button class="btn btn-sm btn-primary" onclick="regenerateSite()">üîÑ –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>' +
    '</div></div></div>' +
    '<div class="site-preview-frame"><iframe id="site-preview-iframe" sandbox="allow-scripts allow-same-origin" style="width:100%;min-height:700px;border:none;border-radius:var(--radius);background:#fff"></iframe></div>' +
    '<div class="card" style="margin-top:12px"><div class="card-header"><h3>üìù –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥</h3>' +
    '<button class="btn btn-sm" onclick="toggleSiteCode()">–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å</button></div>' +
    '<div id="site-code-block" style="display:none;padding:16px;max-height:400px;overflow:auto">' +
    '<pre style="white-space:pre-wrap;font-size:12px;color:var(--text2)">' + esc(siteGenData.html || '') + '</pre></div></div>';
}

function fillSiteDemo() {
  const demos = {
    '–ü—ã—à–∫–∏ –º–∏—Ä–∞': {name:'–ü—ã—à–∫–∏ –º–∏—Ä–∞',type:'–ö–∞—Ñ–µ-–ø–µ–∫–∞—Ä–Ω—è',city:'–ù–∞–±–µ—Ä–µ–∂–Ω—ã–µ –ß–µ–ª–Ω—ã',address:'–ø—Ä. –ú–∏—Ä–∞, 32',phone:'+7 917 234-56-78',social:'@pyshki_mira',hours:'–ü–Ω-–í—Å 08:00-22:00',desc:'–£—é—Ç–Ω–∞—è –ø–µ–∫–∞—Ä–Ω—è —Å –¥–æ–º–∞—à–Ω–∏–º–∏ –ø—ã—à–∫–∞–º–∏ –ø–æ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–º —Ä–µ—Ü–µ–ø—Ç–∞–º. –°–≤–µ–∂–∞—è –≤—ã–ø–µ—á–∫–∞ –∫–∞–∂–¥—ã–π —á–∞—Å, –∞—Ä–æ–º–∞—Ç–Ω—ã–π –∫–æ—Ñ–µ –∏ —Ç—ë–ø–ª–∞—è –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞. –†–∞–±–æ—Ç–∞–µ–º —Å 2023 –≥–æ–¥–∞.',services:'–ü—ã—à–∫–∏ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ, –ü—ã—à–∫–∏ —Å –≤–∞—Ä–µ–Ω—å–µ–º, –ü—ã—à–∫–∏ —Å —à–æ–∫–æ–ª–∞–¥–æ–º, –ü—ã—à–∫–∏ —Å—ã—Ä–Ω—ã–µ, –ö–æ—Ñ–µ —ç—Å–ø—Ä–µ—Å—Å–æ, –ö–∞–ø—É—á–∏–Ω–æ, –õ–∞—Ç—Ç–µ, –ß–∞–π, –ö–∞–∫–∞–æ, –î–æ—Å—Ç–∞–≤–∫–∞',prices:'–ü—ã—à–∫–∏ –æ—Ç 45‚ÇΩ, –∫–æ—Ñ–µ –æ—Ç 120‚ÇΩ, –∫–æ–º–±–æ –æ—Ç 199‚ÇΩ',theme:'warm',style:'playful'},
    '–ë—Ä–µ–∂–Ω–µ–≤': {name:'–ë—Ä–µ–∂–Ω–µ–≤',type:'–†–µ—Å—Ç–æ–∫–ª—É–±',city:'–ù–∞–±–µ—Ä–µ–∂–Ω—ã–µ –ß–µ–ª–Ω—ã',address:'—É–ª. –°–æ–≤–µ—Ç—Å–∫–∞—è, 15',phone:'+7 917 345-67-89',social:'@brezhnev_club',hours:'–ü–Ω-–ß—Ç 12:00-00:00, –ü—Ç-–°–± 12:00-03:00, –í—Å 12:00-22:00',desc:'–†–µ—Å—Ç–æ–∫–ª—É–± –≤ —Å–æ–≤–µ—Ç—Å–∫–æ–º —Å—Ç–∏–ª–µ. –ê—Ç–º–æ—Å—Ñ–µ—Ä–∞ –°–°–°–†: —Ä–µ—Ç—Ä–æ-–∏–Ω—Ç–µ—Ä—å–µ—Ä, –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—Å–∫–∏–µ –±–ª—é–¥–∞ –∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –∫—É—Ö–Ω—è. –ñ–∏–≤–∞—è –º—É–∑—ã–∫–∞ –ø–æ –ø—è—Ç–Ω–∏—Ü–∞–º.',services:'–û–±–µ–¥—ã, –£–∂–∏–Ω—ã, –ë–∞–Ω–∫–µ—Ç—ã, –ö–∞—Ä–∞–æ–∫–µ, –ñ–∏–≤–∞—è –º—É–∑—ã–∫–∞, –ë–∞—Ä, –ö–∞–ª—å—è–Ω, –ü—Ä–æ–≤–µ–¥–µ–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π',prices:'–°—Ä–µ–¥–Ω–∏–π —á–µ–∫ 1200‚ÇΩ, –±–∏–∑–Ω–µ—Å-–ª–∞–Ω—á 350‚ÇΩ',theme:'dark',style:'retro'},
  };
  const demo = demos[currentSubproject] || demos['–ü—ã—à–∫–∏ –º–∏—Ä–∞'];
  Object.keys(demo).forEach(k => {
    const el = document.getElementById('sg-' + k);
    if (el) el.value = demo[k];
  });
  toast('–ü—Ä–∏–º–µ—Ä –∑–∞–ø–æ–ª–Ω–µ–Ω!','success');
}

async function generateSite() {
  const name = document.getElementById('sg-name')?.value?.trim();
  const type = document.getElementById('sg-type')?.value?.trim();
  const desc = document.getElementById('sg-desc')?.value?.trim();
  if (!name || !type || !desc) { toast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (*)','error'); return; }

  siteGenData = {
    name, type, desc,
    city: document.getElementById('sg-city')?.value?.trim() || '',
    address: document.getElementById('sg-address')?.value?.trim() || '',
    phone: document.getElementById('sg-phone')?.value?.trim() || '',
    social: document.getElementById('sg-social')?.value?.trim() || '',
    hours: document.getElementById('sg-hours')?.value?.trim() || '',
    services: document.getElementById('sg-services')?.value?.trim() || '',
    prices: document.getElementById('sg-prices')?.value?.trim() || '',
    theme: document.getElementById('sg-theme')?.value || 'auto',
    style: document.getElementById('sg-style')?.value || 'modern',
    extra: document.getElementById('sg-extra')?.value?.trim() || ''
  };
  siteGenStep = 'loading';
  renderSubprojectView();

  try {
    const prompt = buildSitePrompt(siteGenData);
    const ctrl = new AbortController();
    const tmr = setTimeout(() => ctrl.abort(), 120000);
    
    let response;
    try {
      response = await fetch(CONFIG.AI_URL, {
        method: 'POST', signal: ctrl.signal,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: prompt, direction: currentSubproject, user: USER?.name || '', sheetId: CONFIG.SHEET_ID })
      });
      if (!response.ok) throw new Error('HTTP ' + response.status);
    } catch(e) {
      // For site generation, GET won't work (URL too long) ‚Äî only POST
      throw new Error('–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ Web AI workflow –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –≤ n8n. (' + e.message + ')');
    }
    clearTimeout(tmr);

    const data = await response.json();
    let html = data.response || data.text || '';
    
    // Extract HTML from response (Claude may wrap it in ```html blocks)
    const htmlMatch = html.match(/```html\s*([\s\S]*?)```/);
    if (htmlMatch) html = htmlMatch[1].trim();
    else if (!html.trim().startsWith('<!') && !html.trim().startsWith('<html')) {
      // If no HTML detected, try extracting between tags
      const startIdx = html.indexOf('<!DOCTYPE') !== -1 ? html.indexOf('<!DOCTYPE') : html.indexOf('<html');
      if (startIdx !== -1) html = html.substring(startIdx);
    }

    siteGenData.html = html;
    siteGenStep = 'preview';
    renderSubprojectView();
    
    // Load into iframe
    setTimeout(() => {
      const iframe = document.getElementById('site-preview-iframe');
      if (iframe) {
        const doc = iframe.contentDocument || iframe.contentWindow.document;
        doc.open(); doc.write(html); doc.close();
        // Auto-resize iframe
        setTimeout(() => {
          try { iframe.style.height = Math.max(700, doc.body.scrollHeight + 50) + 'px'; } catch(e){}
        }, 500);
      }
    }, 100);
    toast('–°–∞–π—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω!','success');
  } catch(e) {
    siteGenStep = 'form';
    renderSubprojectView();
    toast('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: ' + e.message,'error');
  }
}

function regenerateSite() { siteGenStep = 'form'; renderSubprojectView(); setTimeout(generateSite, 100); }

function buildSitePrompt(d) {
  return `–°–æ–∑–¥–∞–π –ü–û–õ–ù–´–ô –æ–¥–Ω–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã–π —Å–∞–π—Ç (landing page) –≤ –û–î–ù–û–ú HTML —Ñ–∞–π–ª–µ. 
–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û HTML –∫–æ–¥ –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π, –±–µ–∑ \`\`\`html –æ–±—ë—Ä—Ç–∫–∏.

–î–ê–ù–ù–´–ï –ë–ò–ó–ù–ï–°–ê:
- –ù–∞–∑–≤–∞–Ω–∏–µ: ${d.name}
- –¢–∏–ø: ${d.type}
- –ì–æ—Ä–æ–¥: ${d.city || '–Ω–µ —É–∫–∞–∑–∞–Ω'}
- –ê–¥—Ä–µ—Å: ${d.address || '–Ω–µ —É–∫–∞–∑–∞–Ω'}
- –¢–µ–ª–µ—Ñ–æ–Ω: ${d.phone || '–Ω–µ —É–∫–∞–∑–∞–Ω'}
- –°–æ—Ü—Å–µ—Ç–∏: ${d.social || '–Ω–µ—Ç'}
- –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã: ${d.hours || '–Ω–µ —É–∫–∞–∑–∞–Ω'}
- –û–ø–∏—Å–∞–Ω–∏–µ: ${d.desc}
- –£—Å–ª—É–≥–∏/–ú–µ–Ω—é: ${d.services || '–Ω–µ —É–∫–∞–∑–∞–Ω—ã'}
- –¶–µ–Ω—ã: ${d.prices || '–Ω–µ —É–∫–∞–∑–∞–Ω—ã'}
- –¶–≤–µ—Ç–æ–≤–∞—è —Ç–µ–º–∞: ${d.theme}
- –°—Ç–∏–ª—å: ${d.style}
- –î–æ–ø. –ø–æ–∂–µ–ª–∞–Ω–∏—è: ${d.extra || '–Ω–µ—Ç'}

–¢–†–ï–ë–û–í–ê–ù–ò–Ø:
1. –û–¥–∏–Ω HTML —Ñ–∞–π–ª —Å–æ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º–∏ CSS –∏ JS
2. –ü–æ–ª–Ω–æ—Å—Ç—å—é –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π (–º–æ–±–∏–ª—å–Ω—ã–π + –¥–µ—Å–∫—Ç–æ–ø)
3. –°–µ–∫—Ü–∏–∏: —à–∞–ø–∫–∞ —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π, –≥–µ—Ä–æ–π-–±–∞–Ω–Ω–µ—Ä, –û –Ω–∞—Å, –£—Å–ª—É–≥–∏/–ú–µ–Ω—é, –¶–µ–Ω—ã (–µ—Å–ª–∏ –µ—Å—Ç—å), –ö–æ–Ω—Ç–∞–∫—Ç—ã, –ø–æ–¥–≤–∞–ª
4. –ö—Ä–∞—Å–∏–≤—ã–π —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –¥–∏–∑–∞–π–Ω —Å –∞–Ω–∏–º–∞—Ü–∏—è–º–∏ (CSS transitions, scroll effects)
5. –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç–∞ —Å –∞–¥—Ä–µ—Å–æ–º (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω) —á–µ—Ä–µ–∑ iframe
6. –ö–Ω–æ–ø–∫–∞ "–ü–æ–∑–≤–æ–Ω–∏—Ç—å" —Å tel: —Å—Å—ã–ª–∫–æ–π
7. –ö–Ω–æ–ø–∫–∞ WhatsApp/Telegram –¥–ª—è —Å–≤—è–∑–∏
8. –í—Å–µ —Ç–µ–∫—Å—Ç—ã –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
9. –ò—Å–ø–æ–ª—å–∑—É–π Google Fonts (Montserrat –∏–ª–∏ Inter)
10. –ü–ª–∞–≤–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –º–µ–∂–¥—É —Å–µ–∫—Ü–∏—è–º–∏
11. Favicon —á–µ—Ä–µ–∑ emoji SVG
12. Meta tags –¥–ª—è SEO (title, description)
13. –°—Ç–∏–ª—å–Ω—ã–π CSS —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞–º–∏, —Ç–µ–Ω—è–º–∏, —Å–∫—Ä—É–≥–ª—ë–Ω–Ω—ã–º–∏ —É–≥–ª–∞–º–∏
14. –ë–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∫—Ä–æ–º–µ —à—Ä–∏—Ñ—Ç–æ–≤ –∏ –∫–∞—Ä—Ç—ã

–í–µ—Ä–Ω–∏ –ü–û–õ–ù–´–ô —Ä–∞–±–æ—á–∏–π HTML —Ñ–∞–π–ª.`;
}

function downloadSiteHtml() {
  if (!siteGenData.html) return;
  const blob = new Blob([siteGenData.html], {type:'text/html'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = (siteGenData.name || 'site').replace(/\s/g,'_') + '.html';
  a.click(); URL.revokeObjectURL(a.href);
  toast('HTML —Å–∫–∞—á–∞–Ω!','success');
}

function copySiteHtml() {
  if (!siteGenData.html) return;
  navigator.clipboard.writeText(siteGenData.html).then(() => toast('–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!','success')).catch(() => toast('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è','error'));
}

function toggleSiteCode() {
  const el = document.getElementById('site-code-block');
  if (el) el.style.display = el.style.display === 'none' ? 'block' : 'none';
}

function initSiteGenerator() {
  // Auto-fill name from subproject if empty
  const nameEl = document.getElementById('sg-name');
  if (nameEl && !nameEl.value) nameEl.value = currentSubproject || '';
}

// ============================================================
// FILES / DOCUMENTS SECTION
// ============================================================
function renderFilesSection() {
  const docs = (DATA.documents || []).filter(d => {
    const folder = (d['–ü–∞–ø–∫–∞']||'').toLowerCase();
    const sp = (currentSubproject||'').toLowerCase();
    return folder.includes(sp) || (d['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'').toLowerCase() === sp;
  });
  
  let html = '<div class="card"><div class="card-header" style="display:flex;justify-content:space-between;align-items:center">' +
    '<h3>üìÑ –î–æ–∫—É–º–µ–Ω—Ç—ã –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è ¬´' + esc(currentSubproject) + '¬ª</h3>' +
    '<div style="display:flex;gap:8px">' +
    '<button class="btn btn-sm btn-primary" onclick="uploadFileWeb()">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</button>' +
    '</div></div>';

  if (!docs.length) {
    html += '<div class="card-body" style="padding:40px;text-align:center">' +
      '<div style="font-size:48px;margin-bottom:12px">üìÅ</div>' +
      '<p style="color:var(--text2)">–î–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p>' +
      '<p style="color:var(--text3);font-size:13px;margin-top:8px">–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª –±–æ—Ç—É –≤ Telegram ‚Äî –æ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç –µ–≥–æ –≤ Google Drive –∏ –ø—Ä–∏–≤—è–∂–µ—Ç –∫ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é</p>' +
      '</div>';
  } else {
    html += '<div class="table-wrap"><table><thead><tr><th>üìÑ –§–∞–π–ª</th><th>üìÅ –ü–∞–ø–∫–∞</th><th>üë§ –ó–∞–≥—Ä—É–∑–∏–ª</th><th>üìÖ –î–∞—Ç–∞</th><th>üîó</th></tr></thead><tbody>';
    docs.forEach(d => {
      const icon = getFileIcon(d['–§–∞–π–ª'] || '');
      const link = d['–°—Å—ã–ª–∫–∞'] ? '<a href="'+esc(d['–°—Å—ã–ª–∫–∞'])+'" target="_blank" style="color:var(--accent)">–û—Ç–∫—Ä—ã—Ç—å</a>' : '‚Äî';
      html += '<tr><td>' + icon + ' ' + esc(d['–§–∞–π–ª']||'‚Äî') + '</td><td>' + esc(d['–ü–∞–ø–∫–∞']||'‚Äî') + '</td><td>' + esc(d['–ó–∞–≥—Ä—É–∑–∏–ª']||'‚Äî') + '</td><td>' + esc(d['–î–∞—Ç–∞']||'‚Äî') + '</td><td>' + link + '</td></tr>';
    });
    html += '</tbody></table></div>';
  }
  html += '</div>';

  // Upload via web form (hidden)
  html += '<input type="file" id="file-upload-input" style="display:none" onchange="handleFileUpload(this)" multiple>';
  
  return html;
}

function getFileIcon(name) {
  const ext = (name.split('.').pop() || '').toLowerCase();
  const icons = {pdf:'üìï',doc:'üìò',docx:'üìò',xls:'üìó',xlsx:'üìó',ppt:'üìô',pptx:'üìô',jpg:'üñº',jpeg:'üñº',png:'üñº',gif:'üñº',mp4:'üé¨',mov:'üé¨',zip:'üì¶',rar:'üì¶',txt:'üìù',csv:'üìä'};
  return icons[ext] || 'üìÑ';
}

function uploadFileWeb() {
  document.getElementById('file-upload-input')?.click();
}

async function handleFileUpload(input) {
  if (!input.files || !input.files.length) return;
  
  for (const file of input.files) {
    toast('–ó–∞–≥—Ä—É–∑–∫–∞: ' + file.name + '...','info');
    
    try {
      // Upload via API (if endpoint exists) or save reference
      const formData = new FormData();
      formData.append('file', file);
      formData.append('direction', currentSubproject || '');
      formData.append('user', USER.name || '');
      
      // Try to upload (this would need a dedicated upload endpoint in n8n)
      // For now, just log to sheet
      const writeData = {
        action: 'add_document',
        sheet: '–î–æ–∫—É–º–µ–Ω—Ç—ã',
        data: {
          '–§–∞–π–ª': file.name,
          '–ü–∞–ø–∫–∞': currentSubproject || '–û–±—â–µ–µ',
          '–ó–∞–≥—Ä—É–∑–∏–ª': USER.name || '–í–µ–±',
          '–î–∞—Ç–∞': new Date().toISOString().split('T')[0],
          '–†–∞–∑–º–µ—Ä': formatFileSize(file.size)
        }
      };
      
      await fetch(CONFIG.WRITE_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(writeData)
      });
      
      toast('‚úÖ ' + file.name + ' ‚Äî –∑–∞–ø–∏—Å–∞–Ω –≤ —Ä–µ–µ—Å—Ç—Ä','success');
    } catch(e) {
      toast('–û—à–∏–±–∫–∞: ' + e.message,'error');
    }
  }
  
  input.value = '';
  // Reload data to show new files
  setTimeout(() => { loadData(); }, 1000);
}

function formatFileSize(bytes) {
  if (bytes < 1024) return bytes + ' –ë';
  if (bytes < 1048576) return (bytes/1024).toFixed(1) + ' –ö–ë';
  return (bytes/1048576).toFixed(1) + ' –ú–ë';
}

function initFileUpload() {
  // Nothing extra needed
}

// ============================================================
// TASK DETAIL WITH AI ASSISTANT
// ============================================================
function openTaskDetail(taskId) {
  const task = DATA.tasks.find(t => t.ID === taskId);
  if (!task) { toast('–ó–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞','error'); return; }
  currentTaskId = taskId;
  aiMessages = [];

  // Breadcrumb
  let bc = '<a onclick="showPage(\'home\')">üè† –ü—Ä–æ–µ–∫—Ç—ã</a><span class="sep">‚Ä∫</span>';
  const dir = task['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'';
  const projKey = dirToProject(dir);
  if (projKey) {
    bc += '<a onclick="openProject(\''+projKey+'\')">'+esc(PROJECTS[projKey].name)+'</a><span class="sep">‚Ä∫</span>';
    bc += '<a onclick="openSubproject(\''+escA(dir)+'\')">'+esc(dir)+'</a><span class="sep">‚Ä∫</span>';
  }
  bc += '<span class="current">'+esc(task['–û–ø–∏—Å–∞–Ω–∏–µ']||task['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</span>';
  document.getElementById('td-breadcrumb').innerHTML = bc;

  // Task detail card
  let html = '<div class="task-detail">';
  html += '<div class="task-detail-header">';
  html += '<h3>'+esc(task['–û–ø–∏—Å–∞–Ω–∏–µ']||task['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</h3>';
  html += '<div class="task-meta">';
  html += '<div class="meta-item">'+prBadge(task['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç'])+' '+esc(task['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']||'')+'</div>';
  html += '<div class="meta-item">'+statusBadge(task['–°—Ç–∞—Ç—É—Å'])+'</div>';
  if(task['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']) html += '<div class="meta-item">üìÇ '+esc(task['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'])+'</div>';
  if(task['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']) html += '<div class="meta-item">üë§ '+esc(task['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π'])+'</div>';
  if(task['–î–µ–¥–ª–∞–π–Ω']) {
    const od = task['–î–µ–¥–ª–∞–π–Ω']<today()&&(task['–°—Ç–∞—Ç—É—Å']||'')!=='–ì–æ—Ç–æ–≤–æ';
    html += '<div class="meta-item" style="'+(od?'color:var(--red);font-weight:700':'')+'">üìÖ '+esc(task['–î–µ–¥–ª–∞–π–Ω'])+(od?' üî¥':'')+'</div>';
  }
  html += '</div></div>';

  // Detail fields
  html += '<div class="task-detail-body">';
  html += '<div class="detail-grid">';
  const fields = [
    ['–ü—Ä–æ–µ–∫—Ç', task['–ü—Ä–æ–µ–∫—Ç']],
    ['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', task['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']],
    ['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç', task['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']],
    ['–°—Ç–∞—Ç—É—Å', task['–°—Ç–∞—Ç—É—Å']],
    ['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π', task['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']],
    ['–î–µ–¥–ª–∞–π–Ω', task['–î–µ–¥–ª–∞–π–Ω']]
  ];
  fields.forEach(([l,v]) => {
    if(v) html += '<div class="detail-item"><div class="detail-label">'+esc(l)+'</div><div class="detail-value">'+esc(v)+'</div></div>';
  });
  if(task['–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π']) {
    html += '<div class="detail-item detail-full"><div class="detail-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</div><div class="detail-value">'+esc(task['–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π'])+'</div></div>';
  }
  html += '</div>';

  // Action buttons
  html += '<div style="display:flex;gap:10px;margin-top:20px;flex-wrap:wrap">';
  html += '<button class="btn btn-primary" onclick="editItem(\'task\',\''+escA(taskId)+'\')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>';
  html += '<button class="btn btn-secondary" onclick="changeTaskStatus(\''+escA(taskId)+'\')">üîÑ –°–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>';
  const p = getUserPerms();
  if(p.canDelete) html += '<button class="btn btn-danger" onclick="confirmDelete(\'task\',\''+escA(taskId)+'\',\''+escA(task['–û–ø–∏—Å–∞–Ω–∏–µ']||task['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'\')">üóë –£–¥–∞–ª–∏—Ç—å</button>';
  html += '</div>';
  html += '</div></div>';

  // AI ASSISTANT PANEL
  html += '<div class="ai-panel">';
  html += '<div class="ai-panel-header">';
  html += '<h4>ü§ñ –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ –∑–∞–¥–∞—á–µ</h4>';
  html += '<button class="btn btn-xs btn-secondary" onclick="aiGenerateSteps()">üìã –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞–Ω</button>';
  html += '</div>';

  // AI messages
  html += '<div class="ai-chat-messages" id="ai-messages">';
  html += '<div class="ai-msg system">–ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –≥–æ—Ç–æ–≤ –ø–æ–º–æ—á—å —Å –∑–∞–¥–∞—á–µ–π ¬´'+esc(task['–û–ø–∏—Å–∞–Ω–∏–µ']||task['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'¬ª. –ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ.</div>';
  html += '</div>';

  // Quick actions
  html += '<div class="ai-suggestions">';
  html += '<button class="ai-suggestion-btn" onclick="aiQuickAction(\'plan\')">üìã –ü–ª–∞–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</button>';
  html += '<button class="ai-suggestion-btn" onclick="aiQuickAction(\'risks\')">‚ö†Ô∏è –†–∏—Å–∫–∏</button>';
  html += '<button class="ai-suggestion-btn" onclick="aiQuickAction(\'email\')">üìß –ù–∞–ø–∏—Å–∞—Ç—å –ø–∏—Å—å–º–æ</button>';
  html += '<button class="ai-suggestion-btn" onclick="aiQuickAction(\'checklist\')">‚úÖ –ß–µ–∫–ª–∏—Å—Ç</button>';
  html += '<button class="ai-suggestion-btn" onclick="aiQuickAction(\'next\')">‚û°Ô∏è –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏</button>';
  html += '</div>';

  // Input
  html += '<div class="ai-input-area">';
  html += '<input class="ai-input" id="ai-input" placeholder="–°–ø—Ä–æ—Å–∏—Ç–µ –ò–ò –æ –∑–∞–¥–∞—á–µ..." onkeydown="if(event.key===\'Enter\')sendAiMessage()">';
  html += '<button class="ai-send-btn" id="ai-send-btn" onclick="sendAiMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>';
  html += '</div>';
  html += '</div>';

  document.getElementById('td-content').innerHTML = html;
  showPage('taskdetail');
}

function changeTaskStatus(taskId) {
  const task = DATA.tasks.find(t => t.ID===taskId);
  if(!task) return;
  const statuses = ['‚è≥ –í –æ—á–µ—Ä–µ–¥–∏', '–í —Ä–∞–±–æ—Ç–µ', '–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ', '–ì–æ—Ç–æ–≤–æ'];
  const cur = task['–°—Ç–∞—Ç—É—Å']||'';
  const idx = statuses.indexOf(cur);
  const next = statuses[(idx+1)%statuses.length];
  task['–°—Ç–∞—Ç—É—Å'] = next;
  openTaskDetail(taskId);
  toast('–°—Ç–∞—Ç—É—Å: '+next, 'success');
  apiWrite('–ó–∞–¥–∞—á–∏', task);
}

// ============================================================
// AI CHAT FUNCTIONS
// ============================================================
async function sendAiMessage() {
  const input = document.getElementById('ai-input');
  const msg = input.value.trim();
  if(!msg) return;

  input.value = '';
  addAiMessage('user', msg);

  // Get task context
  const task = DATA.tasks.find(t => t.ID===currentTaskId);
  const context = task ? '–ó–∞–¥–∞—á–∞: '+( task['–û–ø–∏—Å–∞–Ω–∏–µ']||task['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'. –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: '+(task['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'')+'. –°—Ç–∞—Ç—É—Å: '+(task['–°—Ç–∞—Ç—É—Å']||'')+'. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: '+(task['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']||'')+'. –î–µ–¥–ª–∞–π–Ω: '+(task['–î–µ–¥–ª–∞–π–Ω']||'–Ω–µ —É–∫–∞–∑–∞–Ω')+'. –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: '+(task['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'–Ω–µ —É–∫–∞–∑–∞–Ω')+'. –ü—Ä–æ–µ–∫—Ç: '+(task['–ü—Ä–æ–µ–∫—Ç']||'')+'. –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: '+(task['–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π']||'') : '';

  await callAI(msg, context);
}

function aiQuickAction(type) {
  const task = DATA.tasks.find(t => t.ID===currentTaskId);
  if(!task) return;
  const name = task['–û–ø–∏—Å–∞–Ω–∏–µ']||task['–ù–∞–∑–≤–∞–Ω–∏–µ'];

  const prompts = {
    plan: '–°–æ—Å—Ç–∞–≤—å –ø–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ ¬´'+name+'¬ª. –î–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —à–∞–≥–∏ —Å –æ—Ü–µ–Ω–∫–æ–π –≤—Ä–µ–º–µ–Ω–∏.',
    risks: '–ö–∞–∫–∏–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ä–∏—Å–∫–∏ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏ ¬´'+name+'¬ª? –ö–∞–∫ –∏—Ö –º–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å?',
    email: '–ù–∞–ø–∏—à–∏ –¥–µ–ª–æ–≤–æ–µ –ø–∏—Å—å–º–æ –ø–∞—Ä—Ç–Ω—ë—Ä—É –ø–æ –∑–∞–¥–∞—á–µ ¬´'+name+'¬ª. –¢–æ–Ω ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π.',
    checklist: '–°–æ–∑–¥–∞–π –ø–æ–¥—Ä–æ–±–Ω—ã–π —á–µ–∫–ª–∏—Å—Ç –¥–ª—è –∑–∞–¥–∞—á–∏ ¬´'+name+'¬ª ‚Äî —á—Ç–æ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º.',
    next: '–ö–∞–∫–∏–µ —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ ¬´'+name+'¬ª? –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –¥–∞–ª–µ–µ?'
  };

  const msg = prompts[type] || '–ü–æ–º–æ–≥–∏ —Å –∑–∞–¥–∞—á–µ–π ¬´'+name+'¬ª';
  addAiMessage('user', msg);

  const context = '–ó–∞–¥–∞—á–∞: '+name+'. –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: '+(task['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'')+'. –°—Ç–∞—Ç—É—Å: '+(task['–°—Ç–∞—Ç—É—Å']||'')+'. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: '+(task['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']||'')+'. –î–µ–¥–ª–∞–π–Ω: '+(task['–î–µ–¥–ª–∞–π–Ω']||'–Ω–µ —É–∫–∞–∑–∞–Ω')+'. –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: '+(task['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'–Ω–µ —É–∫–∞–∑–∞–Ω')+'.';
  callAI(msg, context);
}

function aiGenerateSteps() {
  aiQuickAction('plan');
}

async function callAI(userMsg, context) {
  // Show loading
  const container = document.getElementById('ai-messages');
  const loadingId = 'ai-loading-'+Date.now();
  container.innerHTML += '<div class="ai-msg assistant" id="'+loadingId+'"><div class="ai-loading"><span></span><span></span><span></span></div></div>';
  container.scrollTop = container.scrollHeight;

  const sendBtn = document.getElementById('ai-send-btn');
  if(sendBtn) sendBtn.disabled = true;

  let aiResponse = '';
  try {
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 30000);
    const response = await fetch(CONFIG.AI_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        message: userMsg,
        context: context,
        sheetId: CONFIG.SHEET_ID,
        history: aiMessages.filter(m=>m.role==='user'||m.role==='assistant').slice(-10),
        user: USER ? USER['–ò–º—è'] : ''
      }),
      signal: controller.signal
    });
    clearTimeout(timeout);

    if (response.ok) {
      const data = await response.json();
      aiResponse = data.response || data.text || data.message || '';
      if (!aiResponse && data.content) { try { aiResponse = data.content[0].text; } catch(e) {} }
    }
    if (!aiResponse) throw new Error('Empty response');
  } catch(e) {
    console.warn('Task AI fallback:', e.message);
    aiResponse = generateLocalAIResponse(userMsg, context);
  }

  const loadEl = document.getElementById(loadingId);
  if(loadEl) loadEl.remove();
  addAiMessage('assistant', aiResponse);
  if(sendBtn) sendBtn.disabled = false;
}

function generateLocalAIResponse(msg, context) {
  // Smart local fallback when AI endpoint is not available
  const lower = msg.toLowerCase();

  if (lower.includes('–ø–ª–∞–Ω') || lower.includes('—à–∞–≥')) {
    return 'üìã **–ü–ª–∞–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**\n\n1. –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π\n2. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤\n3. –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ —Å –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –ª–∏—Ü–∞–º–∏\n4. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–π —Ä–∞–±–æ—Ç—ã\n5. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ\n6. –§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –∏ –∑–∞–∫—Ä—ã—Ç–∏–µ –∑–∞–¥–∞—á–∏\n\n‚è± –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Å—Ä–æ–∫: —Ä–∞–∑–±–µ–π—Ç–µ –Ω–∞ —ç—Ç–∞–ø—ã –ø–æ 1-2 –¥–Ω—è –∫–∞–∂–¥—ã–π.\n\nüí° –°–æ–≤–µ—Ç: –Ω–∞—á–Ω–∏—Ç–µ —Å –ø—É–Ω–∫—Ç–∞ 1 —Å–µ–≥–æ–¥–Ω—è, —á—Ç–æ–±—ã –Ω–µ –æ—Ç–∫–ª–∞–¥—ã–≤–∞—Ç—å.';
  }
  if (lower.includes('—Ä–∏—Å–∫')) {
    return '‚ö†Ô∏è **–í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–∏—Å–∫–∏:**\n\n1. –ó–∞–¥–µ—Ä–∂–∫–∞ –æ—Ç –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤/–ø–æ–¥—Ä—è–¥—á–∏–∫–æ–≤\n2. –ù–µ—Ö–≤–∞—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ –∏–ª–∏ –±—é–¥–∂–µ—Ç–∞\n3. –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ\n4. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏\n\nüõ° **–ú–∏—Ç–∏–≥–∞—Ü–∏—è:**\n- –ó–∞–ª–æ–∂–∏—Ç–µ –±—É—Ñ–µ—Ä –ø–æ —Å—Ä–æ–∫–∞–º (15-20%)\n- –ü–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ –ø–ª–∞–Ω –ë –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —ç—Ç–∞–ø–æ–≤\n- –†–µ–≥—É–ª—è—Ä–Ω–æ —Å–≤–µ—Ä—è–π—Ç–µ—Å—å —Å –∑–∞–∫–∞–∑—á–∏–∫–æ–º';
  }
  if (lower.includes('–ø–∏—Å—å–º') || lower.includes('email')) {
    return 'üìß **–®–∞–±–ª–æ–Ω –ø–∏—Å—å–º–∞:**\n\n–£–≤–∞–∂–∞–µ–º—ã–π [–ò–º—è],\n\n–í —Ä–∞–º–∫–∞—Ö –Ω–∞—à–µ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞ —Ö–æ—Ç–µ–ª –±—ã –æ–±—Å—É–¥–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –ø–æ –∑–∞–¥–∞—á–µ.\n\n–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –º—ã –Ω–∞—Ö–æ–¥–∏–º—Å—è –Ω–∞ —ç—Ç–∞–ø–µ [—ç—Ç–∞–ø]. –î–ª—è –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è –Ω–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ [–¥–µ–π—Å—Ç–≤–∏–µ].\n\n–ü—Ä–µ–¥–ª–∞–≥–∞—é –Ω–∞–∑–Ω–∞—á–∏—Ç—å –≤—Å—Ç—Ä–µ—á—É/–∑–≤–æ–Ω–æ–∫ –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π.\n\n–° —É–≤–∞–∂–µ–Ω–∏–µ–º,\n'+((USER?USER.name:''))||'[–í–∞—à–µ –∏–º—è]';
  }
  if (lower.includes('—á–µ–∫–ª–∏—Å—Ç') || lower.includes('–ø—Ä–æ–≤–µ—Ä–∫')) {
    return '‚úÖ **–ß–µ–∫–ª–∏—Å—Ç:**\n\n‚òê –í—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã\n‚òê –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ —Å —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ–º –ø–æ–ª—É—á–µ–Ω–æ\n‚òê –ë—é–¥–∂–µ—Ç —É—Ç–≤–µ—Ä–∂–¥—ë–Ω\n‚òê –°—Ä–æ–∫–∏ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã\n‚òê –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã\n‚òê –†–∏—Å–∫–∏ —É—á—Ç–µ–Ω—ã\n‚òê –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –¢–ó\n‚òê –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –ø–æ–ª—É—á–µ–Ω–∞';
  }
  if (lower.includes('—Å–ª–µ–¥—É—é—â') || lower.includes('–¥–∞–ª–µ–µ') || lower.includes('next')) {
    return '‚û°Ô∏è **–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**\n\n1. –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ–∫—É—â–µ–π –∑–∞–¥–∞—á–∏\n2. –£–≤–µ–¥–æ–º–∏—Ç—å –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω–Ω—ã—Ö –ª–∏—Ü –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏\n3. –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤ —Å–∏—Å—Ç–µ–º–µ\n4. –ü—Ä–æ–≤–µ—Å—Ç–∏ —Ä–µ—Ç—Ä–æ—Å–ø–µ–∫—Ç–∏–≤—É (—á—Ç–æ –ø–æ—à–ª–æ —Ö–æ—Ä–æ—à–æ / —á—Ç–æ —É–ª—É—á—à–∏—Ç—å)\n5. –ü–µ—Ä–µ–π—Ç–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–π –∑–∞–¥–∞—á–µ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É';
  }

  return 'ü§ñ –Ø –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª –∑–∞–¥–∞—á—É. –í–æ—Ç —á—Ç–æ –º–æ–≥—É —Å–∫–∞–∑–∞—Ç—å:\n\n' + context + '\n\n–ß—Ç–æ–±—ã —è –¥–∞–ª –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–π –æ—Ç–≤–µ—Ç, —É—Ç–æ—á–Ω–∏—Ç–µ —á—Ç–æ –∏–º–µ–Ω–Ω–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç ‚Äî –ø–ª–∞–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è, —Ä–∏—Å–∫–∏, –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏ –∏–ª–∏ –¥—Ä—É–≥–æ–π –∞—Å–ø–µ–∫—Ç.';
}

function addAiMessage(role, text) {
  aiMessages.push({ role, content: text });
  const container = document.getElementById('ai-messages');
  const div = document.createElement('div');
  div.className = 'ai-msg ' + role;
  div.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

// ============================================================
// GLOBAL AI ASSISTANT PANEL
// ============================================================
let globalAiMessages = [];
let aiPanelOpen = false;

function toggleAiPanel() {
  const panel = document.getElementById('aiGlobalPanel');
  const fab = document.getElementById('aiFab');
  aiPanelOpen = !aiPanelOpen;
  if (aiPanelOpen) {
    panel.style.display = 'flex';
    fab.style.display = 'none';
    setTimeout(() => document.getElementById('ai-global-input').focus(), 100);
  } else {
    panel.style.display = 'none';
    fab.style.display = 'flex';
  }
}

function getDataContext() {
  const ctx = { projects: {}, staff_count: DATA.staff.length, total_tasks: 0, overdue: [], upcoming: [] };
  const now = new Date();
  for (const [key, proj] of Object.entries(PROJECTS)) {
    const tasks = DATA.tasks.filter(t => {
      for (const sub of Object.keys(proj.subprojects)) {
        if (t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] === sub || t['–ü—Ä–æ–µ–∫—Ç'] === proj.name) return true;
      }
      return false;
    });
    ctx.projects[proj.name] = { subprojects: Object.keys(proj.subprojects).length, tasks: tasks.length };
    ctx.total_tasks += tasks.length;
    tasks.forEach(t => {
      if (t['–î–µ–¥–ª–∞–π–Ω'] && t['–°—Ç–∞—Ç—É—Å'] !== '–ó–∞–≤–µ—Ä—à–µ–Ω–æ') {
        const dl = new Date(t['–î–µ–¥–ª–∞–π–Ω']);
        if (dl < now) ctx.overdue.push({ task: t['–ù–∞–∑–≤–∞–Ω–∏–µ'], deadline: t['–î–µ–¥–ª–∞–π–Ω'], direction: t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] });
        else if (dl - now < 7*86400000) ctx.upcoming.push({ task: t['–ù–∞–∑–≤–∞–Ω–∏–µ'], deadline: t['–î–µ–¥–ª–∞–π–Ω'], direction: t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] });
      }
    });
  }
  ctx.partners_count = DATA.partners.length;
  ctx.comms_count = DATA.comms.length;
  return ctx;
}

async function sendGlobalAi() {
  const input = document.getElementById('ai-global-input');
  const msg = input.value.trim();
  if (!msg) return;
  input.value = '';
  input.disabled = true;

  const container = document.getElementById('ai-global-messages');
  const userDiv = document.createElement('div');
  userDiv.className = 'ai-msg user';
  userDiv.textContent = msg;
  container.appendChild(userDiv);
  globalAiMessages.push({ role: 'user', content: msg });

  // Typing indicator
  const typing = document.createElement('div');
  typing.className = 'ai-msg system';
  typing.innerHTML = '‚è≥ –î—É–º–∞—é...';
  typing.id = 'ai-typing';
  container.appendChild(typing);
  container.scrollTop = container.scrollHeight;

  const dataCtx = getDataContext();
  let aiText = '';

  try {
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 30000);
    const response = await fetch(CONFIG.AI_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        message: msg,
        context: '',
        sheetId: CONFIG.SHEET_ID,
        history: globalAiMessages.filter(m=>m.role==='user'||m.role==='assistant').slice(-10)
      }),
      signal: controller.signal
    });
    clearTimeout(timeout);
    if (!response.ok) throw new Error('HTTP ' + response.status);
    const data = await response.json();
    aiText = data.response || data.text || data.message || '';
    if (!aiText && data.content) { try { aiText = data.content[0].text; } catch(e) {} }
    if (!aiText) throw new Error('Empty response');
  } catch(e) {
    console.warn('AI API error, using local fallback:', e.message);
    aiText = generateGlobalFallback(msg, dataCtx);
  }

  typing.remove();
  const aiDiv = document.createElement('div');
  aiDiv.className = 'ai-msg assistant';
  aiDiv.innerHTML = aiText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
  container.appendChild(aiDiv);
  globalAiMessages.push({ role: 'assistant', content: aiText });
  container.scrollTop = container.scrollHeight;
  input.disabled = false;
  input.focus();
}

function globalAiQuick(question) {
  document.getElementById('ai-global-input').value = question;
  sendGlobalAi();
}

function generateGlobalFallback(msg, ctx) {
  const ml = msg.toLowerCase();
  const td = today();

  // Direction-specific queries: "—á—Ç–æ –ø–æ –ö–¢?", "—Å—Ç–∞—Ç—É—Å —Ä–æ–±–æ—Ç–æ–≤", etc.
  const dirKeywords = {
    '–∫—Ç':['–ö–¢','–∫—Ç','—Ç–æ–º–æ–≥—Ä–∞—Ñ','ct'], '—Ä–µ–Ω—Ç–≥–µ–Ω':['–†–µ–Ω—Ç–≥–µ–Ω','—Ä–µ–Ω—Ç–≥–µ–Ω','xray'],
    '—Ä–æ–±–æ—Ç':['–†–æ–±–æ—Ç—ã','—Ä–æ–±–æ—Ç','—Ö–∏—Ä—É—Ä–≥'], '—É—Ä–æ–ª–æ–≥':['–£—Ä–æ–ª–æ–≥–∏—è','—É—Ä–æ–ª–æ–≥'],
    'pacs':['PACS','pacs','–∞—Ä—Ö–∏–≤'], '—É–∑–∏':['–£–ó–ò','—É–∑–∏','—É–ª—å—Ç—Ä–∞–∑–≤—É–∫'],
    '—Å–∞–π—Ç':['–°–∞–π—Ç—ã','—Å–∞–π—Ç','web','–≤–µ–±'], '–ø—ã—à–∫–∏':['–ü—ã—à–∫–∏','–ø—ã—à–∫–∏','–ø–æ–Ω—á–∏–∫'],
    '–±—Ä–µ–∂–Ω–µ–≤':['–ë—Ä–µ–∂–Ω–µ–≤','–±—Ä–µ–∂–Ω–µ–≤'], '–∫–µ—Ä–∞—Ç–∏–Ω':['–ö–µ—Ä–∞—Ç–∏–Ω','–∫–µ—Ä–∞—Ç–∏–Ω','–∞–≥—Ä—ã–∑']
  };
  for (const [key, words] of Object.entries(dirKeywords)) {
    if (words.some(w => ml.includes(w.toLowerCase()))) {
      const allDirs = getDirectionOptions();
      const matchDir = allDirs.find(d => words.some(w => d.toLowerCase().includes(w.toLowerCase()))) || words[0];
      const dirPartners = DATA.partners.filter(p => (p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'').toLowerCase().includes(key));
      const dirTasks = DATA.tasks.filter(t => (t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'').toLowerCase().includes(key));
      const openTasks = dirTasks.filter(t => t['–°—Ç–∞—Ç—É—Å'] !== '–ó–∞–≤–µ—Ä—à–µ–Ω–æ' && t['–°—Ç–∞—Ç—É—Å'] !== '–ì–æ—Ç–æ–≤–æ' && t['–°—Ç–∞—Ç—É—Å'] !== '‚úÖ –ì–æ—Ç–æ–≤–æ');
      const overdueT = openTasks.filter(t => t['–î–µ–¥–ª–∞–π–Ω'] && t['–î–µ–¥–ª–∞–π–Ω'] < td);
      let r = 'üìÇ **'+matchDir+':**\n\n';
      r += 'ü§ù –ü–∞—Ä—Ç–Ω—ë—Ä–æ–≤: '+dirPartners.length+'\n';
      if (dirPartners.length) dirPartners.forEach(p => r += '  ‚Ä¢ '+(p['–ù–∞–∑–≤–∞–Ω–∏–µ']||'?')+' ('+(p['–°—Ç—Ä–∞–Ω–∞']||'?')+') ‚Äî '+(p['–°—Ç–∞—Ç—É—Å']||'?')+'\n');
      r += '\n‚úÖ –ó–∞–¥–∞—á: '+dirTasks.length+' (–æ—Ç–∫—Ä—ã—Ç—ã—Ö: '+openTasks.length;
      if (overdueT.length) r += ', üî¥ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ: '+overdueT.length;
      r += ')\n';
      if (openTasks.length) openTasks.slice(0,5).forEach(t => r += '  ‚Ä¢ '+(t['–ù–∞–∑–≤–∞–Ω–∏–µ']||t['–û–ø–∏—Å–∞–Ω–∏–µ']||'‚Äî')+' ‚Äî '+(t['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']||'?')+', –¥–µ–¥–ª–∞–π–Ω: '+(t['–î–µ–¥–ª–∞–π–Ω']||'‚Äî')+'\n');
      return r;
    }
  }

  if (ml.includes('–ø—Ä–æ—Å—Ä–æ—á') || ml.includes('overdue')) {
    if (ctx.overdue.length === 0) return '‚úÖ –û—Ç–ª–∏—á–Ω–æ! –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á –Ω–µ—Ç.';
    let r = 'üî¥ **–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ ('+ctx.overdue.length+'):**\n';
    ctx.overdue.forEach(t => r += '‚Ä¢ '+t.task+' ‚Äî –¥–µ–¥–ª–∞–π–Ω: '+t.deadline+', '+t.direction+'\n');
    r += '\nüí° –†–∞–∑–æ–±—Ä–∞—Ç—å –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ, –æ–±–Ω–æ–≤–∏—Ç—å –¥–µ–¥–ª–∞–π–Ω—ã.';
    return r;
  }
  if (ml.includes('–æ—Ç—á—ë—Ç') || ml.includes('–æ—Ç—á–µ—Ç') || ml.includes('report')) {
    let r = 'üìä **–°–≤–æ–¥–∫–∞ RKT HUB:**\n\n';
    for (const [name, info] of Object.entries(ctx.projects)) r += '‚Ä¢ **'+name+'**: '+info.subprojects+' –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π, '+info.tasks+' –∑–∞–¥–∞—á\n';
    r += '\nüë• –°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤: '+ctx.staff_count+'\nü§ù –ü–∞—Ä—Ç–Ω—ë—Ä–æ–≤: '+ctx.partners_count;
    r += '\nüî¥ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ: '+ctx.overdue.length+'\n‚ö†Ô∏è –ë–ª–∏–∂–∞–π—à–∏–µ: '+ctx.upcoming.length;
    if (ctx.overdue.length) { r += '\n\n**–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ:**\n'; ctx.overdue.slice(0,5).forEach(t => r += '‚Ä¢ '+t.task+' ('+t.deadline+')\n'); }
    return r;
  }
  if (ml.includes('–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç') || ml.includes('priority')) {
    let r = '‚≠ê **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã:**\n';
    if (ctx.overdue.length) { r += '1. üî¥ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ ('+ctx.overdue.length+'):\n'; ctx.overdue.forEach(t => r += '   ‚Ä¢ '+t.task+'\n'); }
    if (ctx.upcoming.length) r += '2. ‚è∞ –ë–ª–∏–∂–∞–π—à–∏–µ: '+ctx.upcoming.map(t=>t.task).join(', ')+'\n';
    r += '3. üìÇ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å—ã –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º';
    return r;
  }
  if (ml.includes('–ø–ª–∞–Ω')) {
    return 'üìã **–ü–ª–∞–Ω –Ω–∞ –Ω–µ–¥–µ–ª—é:**\n‚Ä¢ –ü–Ω: –†–µ–≤—å—é —Å—Ç–∞—Ç—É—Å–æ–≤\n‚Ä¢ –í—Ç-–°—Ä: –ö–ª—é—á–µ–≤—ã–µ –∑–∞–¥–∞—á–∏\n‚Ä¢ –ß—Ç: –í—Å—Ç—Ä–µ—á–∏ —Å –ø–∞—Ä—Ç–Ω—ë—Ä–∞–º–∏\n‚Ä¢ –ü—Ç: –ò—Ç–æ–≥–∏\n\nüìå –ó–∞–¥–∞—á: '+ctx.total_tasks+' | –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ: '+ctx.overdue.length+' | –ö–æ–º–∞–Ω–¥–∞: '+ctx.staff_count;
  }
  if (ml.includes('–ø–∏—Å—å–º') || ml.includes('email')) {
    return 'üìß –ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º—É –∏ –æ —á—ë–º. –ü—Ä–∏–º–µ—Ä—ã:\n‚Ä¢ ¬´–ü–∏—Å—å–º–æ –ø–∞—Ä—Ç–Ω—ë—Ä—É Syno Medical –æ —Å—Ç–∞—Ç—É—Å–µ –ø–æ—Å—Ç–∞–≤–∫–∏¬ª\n‚Ä¢ ¬´–ü–∏—Å—å–º–æ –∫–ª–∏–µ–Ω—Ç—É –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å–∞–π—Ç–∞¬ª';
  }
  if (ml.includes('—Ä–∏—Å–∫')) {
    let r = '‚ö†Ô∏è **–†–∏—Å–∫–∏:**\n';
    if (ctx.overdue.length) r += '1. üî¥ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ ('+ctx.overdue.length+')\n';
    r += '2. –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤\n3. –°—Ä–æ–∫–∏ –ø–æ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–º –ø—Ä–æ–µ–∫—Ç–∞–º';
    return r;
  }
  if (ml.includes('–∫–æ–º–∞–Ω–¥') || ml.includes('—Å–æ—Ç—Ä—É–¥–Ω–∏–∫') || ml.includes('–∫—Ç–æ –≤')) {
    let r = 'üë• **–ö–æ–º–∞–Ω–¥–∞ ('+DATA.staff.length+'):**\n';
    DATA.staff.forEach(s => r += '‚Ä¢ '+(ROLES[s['–†–æ–ª—å']]?.emoji||'üë§')+' '+(s['–ò–º—è']||'?')+' ‚Äî '+(s['–†–æ–ª—å']||'?')+', '+(s['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'–í—Å–µ')+'\n');
    return r;
  }
  if (ml.includes('–ø–∞—Ä—Ç–Ω—ë—Ä') || ml.includes('–ø–∞—Ä—Ç–Ω–µ—Ä')) {
    let r = 'ü§ù **–ü–∞—Ä—Ç–Ω—ë—Ä—ã ('+DATA.partners.length+'):**\n';
    DATA.partners.forEach(p => r += '‚Ä¢ '+(p['–ù–∞–∑–≤–∞–Ω–∏–µ']||'?')+' ('+(p['–°—Ç—Ä–∞–Ω–∞']||'?')+') ‚Äî '+(p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'?')+', '+(p['–°—Ç–∞—Ç—É—Å']||'?')+'\n');
    return r;
  }
  return 'ü§ñ –í —Å–∏—Å—Ç–µ–º–µ '+ctx.total_tasks+' –∑–∞–¥–∞—á, '+ctx.staff_count+' —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤, '+ctx.partners_count+' –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤.\n\nüí° –°–ø—Ä–æ—Å–∏—Ç–µ:\n‚Ä¢ **–ü–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é:** ¬´—á—Ç–æ –ø–æ –ö–¢?¬ª, ¬´—Å—Ç–∞—Ç—É—Å —Ä–æ–±–æ—Ç–æ–≤¬ª\n‚Ä¢ **–ó–∞–¥–∞—á–∏:** ¬´–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ¬ª, ¬´–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã¬ª\n‚Ä¢ **–û—Ç—á—ë—Ç:** ¬´–æ—Ç—á—ë—Ç¬ª, ¬´–ø–ª–∞–Ω –Ω–∞ –Ω–µ–¥–µ–ª—é¬ª\n‚Ä¢ **–ö–æ–º–∞–Ω–¥–∞:** ¬´–∫—Ç–æ –≤ –∫–æ–º–∞–Ω–¥–µ?¬ª\n‚Ä¢ **–ü–∏—Å—å–º–æ:** ¬´–Ω–∞–ø–∏—à–∏ –ø–∏—Å—å–º–æ –ø–∞—Ä—Ç–Ω—ë—Ä—É X¬ª';
}

function openModal(type, existingData) {
  if (type === 'newproject') {
    openAddProjectModal();
    return;
  }

  currentModal = type;
  editingItem = existingData || null;
  const def = FORM_DEFS[type];
  if(!def) return;

  // Auto-set direction
  const autoDir = currentSubproject || null;

  document.getElementById('modalTitle').textContent = (editingItem?'‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å: ':'‚ûï –î–æ–±–∞–≤–∏—Ç—å: ') + def.title;

  let html = '';
  for (const field of def.fields) {
    const val = editingItem ? (editingItem[field.name]||'') : (field.name==='–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'&&autoDir ? autoDir : '');
    const req = field.required ? 'required' : '';

    html += '<div class="form-group"><label class="'+req+'">'+esc(field.name)+'</label>';
    const opts = typeof field.options === 'function' ? field.options() : field.options;

    if (field.type==='select') {
      html += '<select id="field-'+field.name+'">';
      for (const o of (opts||[])) html += '<option value="'+escA(o)+'"'+(val===o?' selected':'')+'>'+esc(o)+'</option>';
      html += '</select>';
    } else if (field.type==='textarea') {
      html += '<textarea id="field-'+field.name+'" placeholder="'+escA(field.placeholder||'')+'">'+esc(val)+'</textarea>';
    } else {
      html += '<input type="'+field.type+'" id="field-'+field.name+'" value="'+escA(val)+'" placeholder="'+escA(field.placeholder||'')+'">';
    }
    html += '</div>';
  }

  document.getElementById('modalBody').innerHTML = html;
  document.getElementById('modalOverlay').classList.add('show');
  setTimeout(() => { const f=document.getElementById('field-'+def.fields[0].name); if(f)f.focus(); }, 200);
}

function openAddProjectModal() {
  currentModal = 'newproject';
  document.getElementById('modalTitle').textContent = '‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç';
  document.getElementById('modalBody').innerHTML =
    '<div class="form-group"><label class="required">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</label><input type="text" id="field-projname" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ë—É—Ä–º–∏—Å—Ç—Ä"></div>'+
    '<div class="form-group"><label>Emoji</label><input type="text" id="field-projemoji" placeholder="üè¢" value="üè¢"></div>'+
    '<div class="form-group"><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea id="field-projdesc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞..."></textarea></div>'+
    '<div class="form-group"><label>–¶–≤–µ—Ç</label><select id="field-projcolor"><option value="var(--accent)">–ó–µ–ª—ë–Ω—ã–π</option><option value="var(--blue)">–°–∏–Ω–∏–π</option><option value="var(--purple)">–§–∏–æ–ª–µ—Ç–æ–≤—ã–π</option><option value="var(--orange)">–û—Ä–∞–Ω–∂–µ–≤—ã–π</option><option value="var(--pink)">–†–æ–∑–æ–≤—ã–π</option></select></div>';
  document.getElementById('modalOverlay').classList.add('show');
}

function openAddSubproject() {
  if (!currentProject) return;
  currentModal = 'newsubproject';
  const proj = PROJECTS[currentProject];
  document.getElementById('modalTitle').textContent = '‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–ø—Ä–æ–µ–∫—Ç –≤ ¬´'+proj.name+'¬ª';

  // Check if this is a site-type project (canAddSub=true means site project)
  const isSite = proj.canAddSub;
  if (isSite) {
    document.getElementById('modalBox').classList.add('wide');
  } else {
    document.getElementById('modalBox').classList.remove('wide');
  }

  let fieldsHtml = '<div class="form-group"><label class="required">–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="field-subname" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥–ø—Ä–æ–µ–∫—Ç–∞"></div>';
  fieldsHtml += '<div class="form-group"><label>Emoji</label><input type="text" id="field-subemoji" placeholder="üìå" value="üìå"></div>';
  fieldsHtml += '<div class="form-group"><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea id="field-subdesc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ..."></textarea></div>';

  if (isSite) {
    // Full site questionnaire
    fieldsHtml += '<div class="form-section-title">üìã –ê–Ω–∫–µ—Ç–∞ –¥–ª—è –ò–ò-–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∞–π—Ç–∞</div>';
    fieldsHtml += '<div class="form-row">';
    fieldsHtml += '<div class="form-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å–∞</label><input type="text" id="field-subbizname" placeholder="–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –±–∏–∑–Ω–µ—Å"></div>';
    fieldsHtml += '<div class="form-group"><label>–¢–∏–ø –±–∏–∑–Ω–µ—Å–∞</label><select id="field-subbiztype"><option>–†–µ—Å—Ç–æ—Ä–∞–Ω / –ö–∞—Ñ–µ</option><option>–°–∞–ª–æ–Ω –∫—Ä–∞—Å–æ—Ç—ã</option><option>–ú–µ–¥–∏—Ü–∏–Ω–∞</option><option>–£—Å–ª—É–≥–∏</option><option>–ú–∞–≥–∞–∑–∏–Ω</option><option>–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ</option><option>–î—Ä—É–≥–æ–µ</option></select></div>';
    fieldsHtml += '</div>';
    fieldsHtml += '<div class="form-row">';
    fieldsHtml += '<div class="form-group"><label>–ö–ª–∏–µ–Ω—Ç (–§–ò–û)</label><input type="text" id="field-subclient" placeholder="–ò–º—è –∑–∞–∫–∞–∑—á–∏–∫–∞"></div>';
    fieldsHtml += '<div class="form-group"><label>–¢–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–µ–Ω—Ç–∞</label><input type="text" id="field-subphone" placeholder="+7..."></div>';
    fieldsHtml += '</div>';
    fieldsHtml += '<div class="form-row">';
    fieldsHtml += '<div class="form-group"><label>Email –∫–ª–∏–µ–Ω—Ç–∞</label><input type="text" id="field-subemail" placeholder="email@..."></div>';
    fieldsHtml += '<div class="form-group"><label>–ì–æ—Ä–æ–¥</label><input type="text" id="field-subcity" placeholder="–ì–æ—Ä–æ–¥ –±–∏–∑–Ω–µ—Å–∞"></div>';
    fieldsHtml += '</div>';
    fieldsHtml += '<div class="form-section-title">üé® –î–∏–∑–∞–π–Ω –∏ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ</div>';
    fieldsHtml += '<div class="form-row">';
    fieldsHtml += '<div class="form-group"><label>–°—Ç–∏–ª—å —Å–∞–π—Ç–∞</label><select id="field-substyle"><option>–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–∏–Ω–∏–º–∞–ª–∏–∑–º</option><option>–¢—ë–º–Ω–∞—è —Ç–µ–º–∞</option><option>–°–≤–µ—Ç–ª–∞—è –∏ —è—Ä–∫–∞—è</option><option>–†–µ—Ç—Ä–æ / –í–∏–Ω—Ç–∞–∂</option><option>–ü—Ä–µ–º–∏—É–º / –õ—é–∫—Å</option><option>–î–µ—Ç—Å–∫–∏–π / –í–µ—Å—ë–ª—ã–π</option></select></div>';
    fieldsHtml += '<div class="form-group"><label>–û—Å–Ω–æ–≤–Ω—ã–µ —Ü–≤–µ—Ç–∞</label><input type="text" id="field-subcolors" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –∫—Ä–∞—Å–Ω—ã–π –∏ –∑–æ–ª–æ—Ç–æ–π"></div>';
    fieldsHtml += '</div>';
    fieldsHtml += '<div class="form-group"><label>–ß—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–∞ —Å–∞–π—Ç–µ</label><textarea id="field-subpages" placeholder="–ì–ª–∞–≤–Ω–∞—è, –ú–µ–Ω—é, –û –Ω–∞—Å, –ö–æ–Ω—Ç–∞–∫—Ç—ã, –î–æ—Å—Ç–∞–≤–∫–∞..."></textarea></div>';
    fieldsHtml += '<div class="form-group"><label>–û—Å–æ–±—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è</label><textarea id="field-subwishes" placeholder="–ß—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞? –û–Ω–ª–∞–π–Ω-–∑–∞–∫–∞–∑, –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, –≥–∞–ª–µ—Ä–µ—è, –æ—Ç–∑—ã–≤—ã..."></textarea></div>';
    fieldsHtml += '<div class="form-section-title">üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ</div>';
    fieldsHtml += '<div class="form-row">';
    fieldsHtml += '<div class="form-group"><label>–î–æ–º–µ–Ω (–µ—Å–ª–∏ –µ—Å—Ç—å)</label><input type="text" id="field-subdomain" placeholder="example.ru"></div>';
    fieldsHtml += '<div class="form-group"><label>–ë—é–¥–∂–µ—Ç</label><input type="text" id="field-subbudget" placeholder="–ë—é–¥–∂–µ—Ç –Ω–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É"></div>';
    fieldsHtml += '</div>';
    fieldsHtml += '<div class="form-row">';
    fieldsHtml += '<div class="form-group"><label>–î–µ–¥–ª–∞–π–Ω</label><input type="date" id="field-subdeadline"></div>';
    fieldsHtml += '<div class="form-group"><label>–°—Å—ã–ª–∫–∞ –Ω–∞ —Ç–µ–∫—É—â–∏–π —Å–∞–π—Ç</label><input type="text" id="field-suburl" placeholder="https://..."></div>';
    fieldsHtml += '</div>';
    fieldsHtml += '<div class="form-group"><label>–ö–æ–Ω—Ç–µ–Ω—Ç –≥–æ—Ç–æ–≤?</label><select id="field-subcontent"><option>–ù–µ—Ç, –Ω—É–∂–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å</option><option>–ß–∞—Å—Ç–∏—á–Ω–æ –≥–æ—Ç–æ–≤</option><option>–ü–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤</option></select></div>';
  }

  document.getElementById('modalBody').innerHTML = fieldsHtml;
  document.getElementById('modalOverlay').classList.add('show');
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('show');
  document.getElementById('modalBox').classList.remove('wide');
  currentModal = '';
  editingItem = null;
}

async function saveModal() {
  // Handle new project
  if (currentModal === 'newproject') {
    const name = document.getElementById('field-projname').value.trim();
    if (!name) { toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ','warning'); return; }
    const key = name.toLowerCase().replace(/[^a-z–∞-—è—ë0-9]/gi,'_');
    const emoji = document.getElementById('field-projemoji').value.trim() || 'üìÅ';
    const desc = document.getElementById('field-projdesc').value.trim();
    const color = document.getElementById('field-projcolor').value;

    PROJECTS[key] = {
      name: name, emoji: emoji, color: color,
      gradient: 'linear-gradient(90deg, '+color+', '+color+')',
      desc: desc, subprojects: {}, canAddSub: true
    };
    closeModal();
    renderAll();
    toast('‚úÖ –ü—Ä–æ–µ–∫—Ç ¬´'+name+'¬ª —Å–æ–∑–¥–∞–Ω!','success');
    return;
  }

  // Handle new subproject
  if (currentModal === 'newsubproject') {
    const name = document.getElementById('field-subname').value.trim();
    if (!name) { toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ','warning'); return; }
    const emoji = document.getElementById('field-subemoji').value.trim() || 'üìå';
    const desc = document.getElementById('field-subdesc').value.trim();
    const proj = PROJECTS[currentProject];
    if (!proj) return;

    proj.subprojects[name] = { emoji: emoji, color: proj.color, desc: desc };

    // If site project, save extra questionnaire fields
    if (proj.canAddSub) {
      const url = document.getElementById('field-suburl')?.value || '';
      const client = document.getElementById('field-subclient')?.value || '';
      const phone = document.getElementById('field-subphone')?.value || '';
      const bizname = document.getElementById('field-subbizname')?.value || '';
      const biztype = document.getElementById('field-subbiztype')?.value || '';
      const email = document.getElementById('field-subemail')?.value || '';
      const city = document.getElementById('field-subcity')?.value || '';
      const style = document.getElementById('field-substyle')?.value || '';
      const colors = document.getElementById('field-subcolors')?.value || '';
      const pages = document.getElementById('field-subpages')?.value || '';
      const wishes = document.getElementById('field-subwishes')?.value || '';
      const domain = document.getElementById('field-subdomain')?.value || '';
      const budget = document.getElementById('field-subbudget')?.value || '';
      const deadline = document.getElementById('field-subdeadline')?.value || '';
      const content = document.getElementById('field-subcontent')?.value || '';

      // Build questionnaire JSON for AI
      const questionnaire = JSON.stringify({
        bizname, biztype, client, phone, email, city,
        style, colors, pages, wishes, domain, budget, deadline, content, url
      }).substring(0, 900);

      await apiWrite('–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è', {
        ID: 'DIR'+String(Date.now()).slice(-6),
        '–ù–∞–∑–≤–∞–Ω–∏–µ': name,
        '–ü—Ä–æ–µ–∫—Ç': proj.name,
        'Emoji': emoji,
        '–û–ø–∏—Å–∞–Ω–∏–µ': desc,
        '–°—Å—ã–ª–∫–∞': url,
        '–ö–ª–∏–µ–Ω—Ç': client,
        '–¢–µ–ª–µ—Ñ–æ–Ω': phone,
        '–ì–æ—Ä–æ–¥': city,
        '–ë–∏–∑–Ω–µ—Å_—Ç–∏–ø': biztype,
        '–°—Ç–∏–ª—å': style,
        '–ê–Ω–∫–µ—Ç–∞': questionnaire,
        '–ë—é–¥–∂–µ—Ç': budget,
        '–î–µ–¥–ª–∞–π–Ω': deadline,
        '–î–∞—Ç–∞_—Å–æ–∑–¥–∞–Ω–∏—è': today()
      });
    }

    document.getElementById('modalBox').classList.remove('wide');
    closeModal();
    renderAll();
    if(currentProject) renderProjectView();
    toast('‚úÖ –ü–æ–¥–ø—Ä–æ–µ–∫—Ç ¬´'+name+'¬ª –¥–æ–±–∞–≤–ª–µ–Ω!','success');

    // Auto-create pipeline tasks for site projects
    if (PROJECTS[currentProject] && PROJECTS[currentProject].canAddSub) {
      const pipeline = [
        { desc: 'üìã –ó–∞–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∫–µ—Ç—É –¥–ª—è ¬´'+name+'¬ª', days: 1, priority: 'P1' },
        { desc: 'üé® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–º–µ—Ä —Å–∞–π—Ç–∞ ¬´'+name+'¬ª', days: 2, priority: 'P1' },
        { desc: 'üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä –∫–ª–∏–µ–Ω—Ç—É ¬´'+name+'¬ª', days: 3, priority: 'P1' },
        { desc: 'üí¨ –ü–æ–ª—É—á–∏—Ç—å —Ñ–∏–¥–±–µ–∫ –æ—Ç ¬´'+name+'¬ª', days: 5, priority: 'P2' },
        { desc: 'üí≥ –í—ã—Å—Ç–∞–≤–∏—Ç—å —Å—á—ë—Ç –∑–∞ –¥–æ–º–µ–Ω ¬´'+name+'¬ª', days: 7, priority: 'P2' },
        { desc: 'üîß –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∞–π—Ç ¬´'+name+'¬ª –Ω–∞ —Ö–æ—Å—Ç–∏–Ω–≥', days: 10, priority: 'P2' },
        { desc: '‚úÖ –°–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç ¬´'+name+'¬ª, –ø–æ–ª—É—á–∏—Ç—å –æ–ø–ª–∞—Ç—É', days: 14, priority: 'P3' }
      ];
      const td = today();
      for (const task of pipeline) {
        const dl = new Date(); dl.setDate(dl.getDate() + task.days);
        const deadlineStr = dl.toISOString().split('T')[0];
        apiWrite('–ó–∞–¥–∞—á–∏', {
          ID: 'T'+String(Date.now()).slice(-6)+String(Math.random()).slice(2,4),
          '–û–ø–∏—Å–∞–Ω–∏–µ': task.desc,
          '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ': name,
          '–ü—Ä–æ–µ–∫—Ç': PROJECTS[currentProject].name,
          '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç': task.priority,
          '–°—Ç–∞—Ç—É—Å': '‚è≥ –í –æ—á–µ—Ä–µ–¥–∏',
          '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π': USER ? USER.name : '',
          '–î–µ–¥–ª–∞–π–Ω': deadlineStr,
          '–°–æ–∑–¥–∞–Ω–æ': td
        });
      }
      toast('üìã –°–æ–∑–¥–∞–Ω–æ 7 –∑–∞–¥–∞—á –¥–ª—è ¬´'+name+'¬ª', 'info');
    }
    return;
  }

  // Standard form save
  const def = FORM_DEFS[currentModal];
  if(!def) return;

  for (const field of def.fields) {
    if (field.required) {
      const el = document.getElementById('field-'+field.name);
      if(!el||!el.value.trim()) { toast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ ¬´'+field.name+'¬ª','warning'); if(el)el.focus(); return; }
    }
  }

  const row = {};
  row.ID = editingItem ? editingItem.ID : currentModal.charAt(0).toUpperCase()+String(Date.now()).slice(-6);

  for (const field of def.fields) {
    const el = document.getElementById('field-'+field.name);
    row[field.name] = el ? el.value : '';
  }

  const td = today();
  if(def.sheet==='–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏'&&!editingItem) { row['–°—Ç–∞—Ç—É—Å']='–ê–∫—Ç–∏–≤–Ω—ã–π'; row['–î–∞—Ç–∞_–¥–æ–±–∞–≤–ª–µ–Ω–∏—è']=td; }
  if(def.sheet==='–ü—Ä–æ–µ–∫—Ç—ã') { if(!editingItem) row['–°–æ–∑–¥–∞–Ω–æ']=td; row['–û–±–Ω–æ–≤–ª–µ–Ω–æ']=td; }
  if(def.sheet==='–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏'&&!editingItem) { row['–î–∞—Ç–∞']=td; row['–ê–≤—Ç–æ—Ä']=USER?USER.name:''; }

  const perms = getUserPerms();
  const writeAccess = canDirectWrite(def.sheet);

  if (writeAccess === 'denied') {
    toast('‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ ¬´'+def.sheet+'¬ª','error');
    return;
  }

  if (writeAccess === 'approval') {
    const approvalRow = {
      ID: 'APR'+String(Date.now()).slice(-6),
      '–¢–∏–ø': (editingItem ? '–ò–∑–º–µ–Ω–µ–Ω–∏–µ' : '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ') + ': '+def.title,
      '–û–ø–∏—Å–∞–Ω–∏–µ': row['–ù–∞–∑–≤–∞–Ω–∏–µ']||row['–û–ø–∏—Å–∞–Ω–∏–µ']||row['–ò–º—è']||row['–ü–∞—Ä—Ç–Ω—ë—Ä']||'',
      '–û—Ç_–∫–æ–≥–æ': USER?USER.name:'',
      '–†–æ–ª—å': USER?USER.role:'',
      'Telegram_ID': USER?USER.tgId:'',
      '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ': row['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'',
      '–ü—Ä–æ–µ–∫—Ç': row['–ü—Ä–æ–µ–∫—Ç']||'',
      '–õ–∏—Å—Ç': def.sheet,
      '–°—Ç–∞—Ç—É—Å': '‚è≥ –û–∂–∏–¥–∞–µ—Ç',
      '–î–∞—Ç–∞_–∑–∞–ø—Ä–æ—Å–∞': td,
      '–î–∞–Ω–Ω—ã–µ': JSON.stringify(row).substring(0,900)
    };
    document.getElementById('modalSaveBtn').disabled = true;
    const ok = await apiWrite('–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è', approvalRow);
    document.getElementById('modalSaveBtn').disabled = false;
    if(ok) toast('‚è≥ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ CEO','info');
    closeModal();
    setTimeout(loadData, 1500);
    return;
  }

  // Direct write
  document.getElementById('modalSaveBtn').disabled = true;
  const ok = await apiWrite(def.sheet, row);
  document.getElementById('modalSaveBtn').disabled = false;
  if(ok) toast('‚úÖ '+def.title+' —Å–æ—Ö—Ä–∞–Ω—ë–Ω!','success');
  closeModal();
  setTimeout(loadData, 1500);
}

// ============================================================
// VIEW / EDIT / DELETE
// ============================================================
function viewItem(type, id) {
  const map = {partner:'partners',project:'projects',task:'tasks',staff:'staff',comm:'comms'};
  const item = DATA[map[type]]?.find(i => i.ID===id);
  if(!item) return;

  document.getElementById('detailTitle').textContent = 'üìã '+(item['–ù–∞–∑–≤–∞–Ω–∏–µ']||item['–û–ø–∏—Å–∞–Ω–∏–µ']||item['–ò–º—è']||item['–ü–∞—Ä—Ç–Ω—ë—Ä']||'–î–µ—Ç–∞–ª–∏');

  const fields = Object.entries(item).filter(([k])=>k!=='row_number');
  let html = '<div class="detail-grid">';
  for (const [k,v] of fields) {
    if(!v&&v!==0) continue;
    const long = String(v).length > 60;
    html += '<div class="detail-item '+(long?'detail-full':'')+'"><div class="detail-label">'+esc(k)+'</div><div class="detail-value">'+esc(v)+'</div></div>';
  }
  html += '</div>';
  document.getElementById('detailBody').innerHTML = html;
  document.getElementById('detailEditBtn').onclick = function() { closeDetail(); editItem(type,id); };
  document.getElementById('detailOverlay').classList.add('show');
}

function closeDetail() { document.getElementById('detailOverlay').classList.remove('show'); }

function editItem(type, id) {
  const map = {partner:'partners',project:'projects',task:'tasks',staff:'staff',comm:'comms'};
  const item = DATA[map[type]]?.find(i => i.ID===id);
  if(item) openModal(type, item);
}

function confirmDelete(type, id, name) {
  if(!getUserPerms().canDelete) { toast('‚õî –¢–æ–ª—å–∫–æ CEO','error'); return; }
  document.getElementById('confirmTitle').textContent = '–£–¥–∞–ª–∏—Ç—å?';
  document.getElementById('confirmText').textContent = '¬´'+(name||id)+'¬ª –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞.';
  document.getElementById('confirmOverlay').classList.add('show');
  confirmCallback = async function(ok) {
    if(ok) {
      const sheetMap = {partner:'–ü–∞—Ä—Ç–Ω—ë—Ä—ã',task:'–ó–∞–¥–∞—á–∏',staff:'–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏',comm:'–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏'};
      const dataMap = {partner:'partners',task:'tasks',staff:'staff',comm:'comms'};
      // Mark as deleted in Google Sheet
      if (sheetMap[type]) {
        await apiWrite(sheetMap[type], { ID: id, '–°—Ç–∞—Ç—É—Å': '‚ùå –£–¥–∞–ª—ë–Ω' });
      }
      // Remove from local data
      if(DATA[dataMap[type]]) DATA[dataMap[type]] = DATA[dataMap[type]].filter(i=>i.ID!==id);
      renderAll();
      toast('üóë –£–¥–∞–ª–µ–Ω–æ','warning');
      setTimeout(loadData, 2000);
    }
  };
}

function closeConfirm(r) {
  document.getElementById('confirmOverlay').classList.remove('show');
  if(confirmCallback) { confirmCallback(r); confirmCallback=null; }
}

// ============================================================
// APPROVALS
// ============================================================
async function handleApproval(id, approved) {
  const item = DATA.approvals.find(a=>a.ID===id);
  if(!item) return;
  item['–°—Ç–∞—Ç—É—Å'] = approved?'‚úÖ –û–¥–æ–±—Ä–µ–Ω–æ':'‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ';
  item['–î–∞—Ç–∞_—Ä–µ—à–µ–Ω–∏—è'] = today();
  item['–†–µ—à–µ–Ω–∏–µ_CEO'] = USER?USER.name:'';
  await apiWrite('–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è', item);

  // If approved and has data ‚Äî write to target sheet
  if (approved && item['–î–∞–Ω–Ω—ã–µ'] && item['–õ–∏—Å—Ç']) {
    try {
      const rowData = JSON.parse(item['–î–∞–Ω–Ω—ã–µ']);
      await apiWrite(item['–õ–∏—Å—Ç'], rowData);
      toast('‚úÖ –û–¥–æ–±—Ä–µ–Ω–æ –∏ –∑–∞–ø–∏—Å–∞–Ω–æ –≤ ¬´'+item['–õ–∏—Å—Ç']+'¬ª','success');
    } catch(e) {
      toast('‚úÖ –û–¥–æ–±—Ä–µ–Ω–æ (–¥–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∞–Ω—ã)','success');
    }
  } else {
    toast(approved?'‚úÖ –û–¥–æ–±—Ä–µ–Ω–æ':'‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ', approved?'success':'error');
  }
  renderAll();
  setTimeout(loadData, 1500);
}

// ============================================================
// CSV EXPORT
// ============================================================
function exportCSV(type) {
  const map = {partners:DATA.partners, tasks:DATA.tasks, projects:DATA.projects};
  const data = filterByRole(map[type]||[]);
  if(!data.length) { toast('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö','warning'); return; }
  const headers = Object.keys(data[0]).filter(k=>k!=='row_number');
  let csv = '\uFEFF' + headers.join(';')+'\n';
  data.forEach(r => { csv += headers.map(h=>'"'+String(r[h]||'').replace(/"/g,'""')+'"').join(';')+'\n'; });
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'RKT_'+type+'_'+today()+'.csv';
  a.click();
  toast('üì• –≠–∫—Å–ø–æ—Ä—Ç –≥–æ—Ç–æ–≤','success');
}

// ============================================================
// KEYBOARD
// ============================================================
document.addEventListener('keydown', function(e) {
  if(e.key==='Enter'&&document.getElementById('loginScreen').style.display!=='none') { doLogin(); return; }
  if(e.key==='Escape') {
    if(document.getElementById('confirmOverlay').classList.contains('show')) closeConfirm(false);
    else if(document.getElementById('detailOverlay').classList.contains('show')) closeDetail();
    else if(document.getElementById('modalOverlay').classList.contains('show')) closeModal();
  }
});

// ============================================================
// INIT ‚Äî Load saved subprojects from directions
// ============================================================
function loadSavedSubprojects() {
  // Load directions from sheet and add as subprojects to matching projects
  if (DATA.directions && DATA.directions.length) {
    DATA.directions.forEach(d => {
      const name = d['–ù–∞–∑–≤–∞–Ω–∏–µ'];
      const projName = d['–ü—Ä–æ–µ–∫—Ç'] || '';
      if (!name) return;
      // Find which project this belongs to
      for (const [key, proj] of Object.entries(PROJECTS)) {
        if (proj.name === projName && !proj.subprojects[name]) {
          proj.subprojects[name] = {
            emoji: d['Emoji'] || 'üìå',
            color: proj.color,
            desc: d['–û–ø–∏—Å–∞–Ω–∏–µ'] || ''
          };
        }
      }
    });
  }
}

// Override renderAll to include saved subprojects
const _origRenderAll = renderAll;
renderAll = function() {
  loadSavedSubprojects();
  _origRenderAll();
};

checkSavedLogin();
</script>
</body>
</html>
