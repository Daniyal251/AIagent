<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RKT HUB ‚Äî –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞–º–∏</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè•</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Unbounded:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
/* ===== CSS VARIABLES ===== */
:root {
  --bg: #0a0e17;
  --bg2: #111827;
  --bg3: #1a2234;
  --bg4: #1f2b3d;
  --accent: #00d4aa;
  --accent2: #00b894;
  --accent-glow: rgba(0, 212, 170, 0.15);
  --red: #ff6b6b;
  --red-glow: rgba(255, 107, 107, 0.15);
  --orange: #ffa94d;
  --orange-glow: rgba(255, 169, 77, 0.15);
  --yellow: #ffd43b;
  --blue: #4dabf7;
  --blue-glow: rgba(75, 171, 247, 0.15);
  --purple: #b197fc;
  --purple-glow: rgba(177, 151, 252, 0.15);
  --green: #51cf66;
  --pink: #f06595;
  --text: #e8ecf1;
  --text2: #8899aa;
  --text3: #5a6a7a;
  --border: #243044;
  --border2: #2d3f56;
  --radius: 12px;
  --radius-sm: 8px;
  --radius-lg: 16px;
  --shadow: 0 4px 30px rgba(0, 0, 0, 0.4);
  --shadow-lg: 0 20px 60px rgba(0, 0, 0, 0.5);
  --transition: all 0.2s ease;
  --sidebar-w: 260px;
}

/* ===== RESET ===== */
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
html { scroll-behavior: smooth; }

body {
  font-family: 'JetBrains Mono', monospace;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
  line-height: 1.5;
}

body::before {
  content: '';
  position: fixed;
  top: -50%; left: -50%;
  width: 200%; height: 200%;
  background:
    radial-gradient(ellipse at 20% 50%, rgba(0, 212, 170, 0.06) 0%, transparent 50%),
    radial-gradient(ellipse at 80% 20%, rgba(75, 171, 247, 0.04) 0%, transparent 50%),
    radial-gradient(ellipse at 50% 80%, rgba(177, 151, 252, 0.03) 0%, transparent 50%);
  z-index: 0;
  pointer-events: none;
}

a { color: var(--accent); text-decoration: none; }
a:hover { text-decoration: underline; }

::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--text2); }

/* ============================================================
   LOGIN SCREEN
   ============================================================ */
.login-screen {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  background: var(--bg);
}

.login-card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 24px;
  padding: 52px 44px;
  width: 440px;
  max-width: 92vw;
  text-align: center;
  box-shadow: var(--shadow-lg);
  position: relative;
  overflow: hidden;
  animation: loginFadeIn 0.5s ease;
}

@keyframes loginFadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.login-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--accent), var(--blue), var(--purple), var(--accent));
  background-size: 300% 100%;
  animation: gradientShift 4s ease infinite;
}

@keyframes gradientShift {
  0%, 100% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
}

.login-icon { font-size: 72px; margin-bottom: 20px; display: block; }

.login-logo {
  font-family: 'Unbounded', sans-serif;
  font-size: 36px;
  font-weight: 900;
  background: linear-gradient(135deg, var(--accent), var(--blue));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  margin-bottom: 6px;
}

.login-sub { color: var(--text2); font-size: 13px; margin-bottom: 36px; }

.login-label {
  display: block;
  text-align: left;
  font-size: 11px;
  color: var(--text2);
  text-transform: uppercase;
  letter-spacing: 2px;
  margin-bottom: 10px;
  font-weight: 600;
}

.login-input {
  width: 100%;
  padding: 16px 20px;
  background: var(--bg);
  border: 2px solid var(--border);
  border-radius: var(--radius);
  color: var(--text);
  font-family: 'JetBrains Mono', monospace;
  font-size: 18px;
  text-align: center;
  letter-spacing: 3px;
  transition: var(--transition);
  margin-bottom: 10px;
}

.login-input:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 4px var(--accent-glow);
}

.login-input::placeholder { color: var(--text3); font-size: 13px; letter-spacing: 0; }

.login-hint { font-size: 11px; color: var(--text2); margin-bottom: 28px; line-height: 1.8; }
.login-hint a { color: var(--accent); font-weight: 600; }

.login-btn {
  width: 100%;
  padding: 16px;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  color: var(--bg);
  border: none;
  border-radius: var(--radius);
  font-family: 'JetBrains Mono', monospace;
  font-size: 15px;
  font-weight: 700;
  cursor: pointer;
  transition: var(--transition);
  letter-spacing: 1.5px;
  text-transform: uppercase;
}

.login-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0, 212, 170, 0.3); }
.login-btn:active { transform: translateY(0); }
.login-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }

.login-error {
  color: var(--red);
  font-size: 13px;
  margin-top: 16px;
  display: none;
  padding: 10px;
  background: var(--red-glow);
  border-radius: var(--radius-sm);
}

/* ============================================================
   APP LAYOUT
   ============================================================ */
.app {
  position: relative;
  z-index: 1;
  display: flex;
  min-height: 100vh;
}

/* ===== SIDEBAR ===== */
.sidebar {
  width: var(--sidebar-w);
  background: var(--bg2);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  position: fixed;
  top: 0; left: 0; bottom: 0;
  z-index: 100;
  transition: transform 0.3s ease;
  overflow-y: auto;
}

.logo-section {
  padding: 28px 24px 20px;
  border-bottom: 1px solid var(--border);
}

.logo-section h1 {
  font-family: 'Unbounded', sans-serif;
  font-size: 22px;
  font-weight: 900;
  background: linear-gradient(135deg, var(--accent), var(--blue));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.logo-section .subtitle { font-size: 11px; color: var(--text2); margin-top: 4px; }

.nav { flex: 1; padding: 12px; }

.nav-section {
  font-size: 10px;
  color: var(--text3);
  text-transform: uppercase;
  letter-spacing: 2.5px;
  padding: 20px 12px 8px;
  font-weight: 600;
}

.nav-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 11px 14px;
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: var(--transition);
  font-size: 13px;
  color: var(--text2);
  text-decoration: none;
  margin-bottom: 2px;
  position: relative;
}

.nav-item:hover { background: var(--bg3); color: var(--text); text-decoration: none; }
.nav-item.active { background: var(--accent-glow); color: var(--accent); }

.nav-item.active::before {
  content: '';
  position: absolute;
  left: 0; top: 25%; bottom: 25%;
  width: 3px;
  background: var(--accent);
  border-radius: 0 3px 3px 0;
}

.nav-item .icon { font-size: 18px; width: 26px; text-align: center; flex-shrink: 0; }
.nav-item .label { flex: 1; }

.nav-item .badge {
  background: var(--accent);
  color: var(--bg);
  font-size: 10px;
  font-weight: 700;
  padding: 2px 8px;
  border-radius: 12px;
  min-width: 22px;
  text-align: center;
}

.nav-item .badge-orange { background: var(--orange); }
.nav-item .badge-red { background: var(--red); }
.nav-item.hidden { display: none; }

/* User bar */
.user-bar {
  padding: 16px 20px;
  border-top: 1px solid var(--border);
  background: var(--bg3);
}

.user-info { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }

.user-avatar {
  width: 40px; height: 40px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--accent), var(--blue));
  display: flex; align-items: center; justify-content: center;
  font-size: 18px; font-weight: 700; color: var(--bg); flex-shrink: 0;
}

.user-name { font-size: 13px; font-weight: 600; line-height: 1.3; }
.user-role-text { font-size: 11px; color: var(--text2); }

.logout-btn {
  width: 100%;
  padding: 9px;
  background: transparent;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text2);
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}

.logout-btn:hover { border-color: var(--red); color: var(--red); background: var(--red-glow); }

/* ===== MAIN ===== */
.main {
  flex: 1;
  margin-left: var(--sidebar-w);
  padding: 32px 36px 60px;
  max-width: 1400px;
  min-height: 100vh;
}

/* ===== PAGE HEADER ===== */
.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 28px;
  flex-wrap: wrap;
  gap: 12px;
}

.page-header h2 {
  font-family: 'Unbounded', sans-serif;
  font-size: 26px;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 12px;
}

.page-header .actions { display: flex; gap: 8px; flex-wrap: wrap; }

/* ===== BREADCRUMB ===== */
.breadcrumb {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 18px;
  font-size: 12px;
  color: var(--text2);
}

.breadcrumb a { cursor: pointer; color: var(--text2); transition: var(--transition); }
.breadcrumb a:hover { color: var(--accent); text-decoration: none; }
.breadcrumb .sep { color: var(--text3); }
.breadcrumb .current { color: var(--text); font-weight: 600; }

/* ===== BUTTONS ===== */
.btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 20px;
  border-radius: var(--radius-sm);
  border: none;
  cursor: pointer;
  font-family: 'JetBrains Mono', monospace;
  font-size: 13px;
  font-weight: 600;
  transition: var(--transition);
  white-space: nowrap;
}

.btn-primary {
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  color: var(--bg);
}

.btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(0, 212, 170, 0.3); }

.btn-secondary {
  background: var(--bg3);
  color: var(--text);
  border: 1px solid var(--border);
}

.btn-secondary:hover { border-color: var(--accent); color: var(--accent); }

.btn-danger {
  background: var(--red-glow);
  color: var(--red);
  border: 1px solid rgba(255, 107, 107, 0.3);
}

.btn-danger:hover { background: rgba(255, 107, 107, 0.25); }

.btn-sm { padding: 6px 14px; font-size: 11px; }
.btn-xs { padding: 4px 10px; font-size: 10px; }
.btn-approve { background: var(--accent-glow); color: var(--accent); border: 1px solid rgba(0, 212, 170, 0.3); }
.btn-reject { background: var(--red-glow); color: var(--red); border: 1px solid rgba(255, 107, 107, 0.3); }

.btn-ai {
  background: linear-gradient(135deg, var(--purple), #7950f2);
  color: #fff;
}

.btn-ai:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 15px var(--purple-glow);
}

/* ============================================================
   PROJECT GRID ‚Äî Main screen
   ============================================================ */
.project-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
  gap: 20px;
  margin-bottom: 28px;
}

.project-card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  overflow: hidden;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
}

.project-card:hover {
  border-color: var(--accent);
  transform: translateY(-4px);
  box-shadow: 0 12px 40px rgba(0, 212, 170, 0.15);
}

.project-card-top {
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 4px;
}

.project-card-header {
  padding: 28px 28px 16px;
  position: relative;
}

.project-card-header .emoji {
  font-size: 52px;
  margin-bottom: 14px;
  display: block;
  filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
}

.project-card-header h3 {
  font-family: 'Unbounded', sans-serif;
  font-size: 22px;
  font-weight: 700;
  margin-bottom: 6px;
}

.project-card-header .desc {
  font-size: 12px;
  color: var(--text2);
  line-height: 1.6;
}

.project-card-stats {
  padding: 0 28px 12px;
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 10px;
}

.pcs { text-align: center; padding: 10px 0; }

.pcs .v {
  font-family: 'Unbounded', sans-serif;
  font-size: 24px;
  font-weight: 800;
}

.pcs .l { font-size: 10px; color: var(--text2); margin-top: 2px; }

.project-card-progress {
  padding: 0 28px 24px;
}

.project-card-progress .bar {
  height: 6px;
  background: var(--bg);
  border-radius: 3px;
  overflow: hidden;
}

.project-card-progress .fill {
  height: 100%;
  border-radius: 3px;
  transition: width 0.6s ease;
}

.project-card-progress .info {
  display: flex;
  justify-content: space-between;
  margin-top: 6px;
  font-size: 11px;
  color: var(--text2);
}

.status-tag {
  position: absolute;
  top: 18px; right: 18px;
  font-size: 10px;
  padding: 4px 10px;
  border-radius: 12px;
  font-weight: 600;
}

/* Add new project card */
.project-card.add-card {
  border: 2px dashed var(--border);
  background: transparent;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 260px;
  flex-direction: column;
  gap: 12px;
}

.project-card.add-card:hover {
  border-color: var(--accent);
  background: var(--accent-glow);
}

.project-card.add-card .add-icon {
  font-size: 48px;
  opacity: 0.5;
}

.project-card.add-card .add-text {
  font-size: 14px;
  color: var(--text2);
  font-weight: 600;
}

/* ===== SUBPROJECT GRID ===== */
.subproject-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
}

.subproject-card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 22px;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.subproject-card:hover {
  border-color: var(--accent);
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(0, 212, 170, 0.1);
}

.subproject-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 3px;
}

.subproject-card .sp-emoji { font-size: 36px; margin-bottom: 10px; display: block; }

.subproject-card h4 {
  font-family: 'Unbounded', sans-serif;
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 4px;
}

.subproject-card .sp-desc {
  font-size: 11px;
  color: var(--text2);
  line-height: 1.5;
  margin-bottom: 12px;
}

.subproject-card .sp-stats {
  display: flex;
  gap: 16px;
  font-size: 11px;
  color: var(--text2);
}

.subproject-card .sp-stats span {
  display: flex;
  align-items: center;
  gap: 4px;
}

.subproject-card.add-sub {
  border: 2px dashed var(--border);
  background: transparent;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  gap: 8px;
  min-height: 160px;
}

.subproject-card.add-sub:hover {
  border-color: var(--accent);
  background: var(--accent-glow);
}

/* ===== METRICS ===== */
.metrics {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 16px;
  margin-bottom: 28px;
}

.metric-card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 22px;
  position: relative;
  overflow: hidden;
  transition: var(--transition);
}

.metric-card:hover {
  border-color: var(--border2);
  transform: translateY(-2px);
  box-shadow: var(--shadow);
}

.metric-card::after {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 3px;
}

.metric-card:nth-child(1)::after { background: linear-gradient(90deg, var(--accent), var(--accent2)); }
.metric-card:nth-child(2)::after { background: linear-gradient(90deg, var(--blue), #228be6); }
.metric-card:nth-child(3)::after { background: linear-gradient(90deg, var(--orange), #fd7e14); }
.metric-card:nth-child(4)::after { background: linear-gradient(90deg, var(--purple), #7950f2); }
.metric-card:nth-child(5)::after { background: linear-gradient(90deg, var(--green), #37b24d); }

.metric-card .m-icon { font-size: 30px; margin-bottom: 10px; }
.metric-card .m-value { font-family: 'Unbounded', sans-serif; font-size: 32px; font-weight: 900; line-height: 1; }
.metric-card .m-label { font-size: 12px; color: var(--text2); margin-top: 6px; }
.metric-card .m-sub { font-size: 10px; color: var(--text3); margin-top: 4px; }

/* ===== CARDS & TABLES ===== */
.card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  margin-bottom: 24px;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 22px;
  border-bottom: 1px solid var(--border);
  background: rgba(26, 34, 52, 0.5);
}

.card-header h3 {
  font-size: 15px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}

.table-wrap { overflow-x: auto; }

table { width: 100%; border-collapse: collapse; font-size: 13px; }

thead th {
  text-align: left;
  padding: 12px 18px;
  color: var(--text2);
  font-weight: 600;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 1.2px;
  border-bottom: 1px solid var(--border);
  background: var(--bg3);
  white-space: nowrap;
  position: sticky;
  top: 0;
  z-index: 2;
}

tbody td {
  padding: 13px 18px;
  border-bottom: 1px solid rgba(36, 48, 68, 0.4);
  vertical-align: middle;
}

tbody tr { transition: background 0.15s; }
tbody tr:hover td { background: rgba(0, 212, 170, 0.03); }
tbody tr:last-child td { border-bottom: none; }

/* ===== STATUS & BADGES ===== */
.status {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 600;
  white-space: nowrap;
}

.s-active { background: var(--accent-glow); color: var(--accent); }
.s-talks { background: var(--orange-glow); color: var(--orange); }
.s-research { background: var(--blue-glow); color: var(--blue); }
.s-pause { background: rgba(136, 153, 170, 0.15); color: var(--text2); }
.s-urgent { background: var(--red-glow); color: var(--red); }
.s-work { background: var(--purple-glow); color: var(--purple); }
.s-done { background: rgba(81, 207, 102, 0.15); color: var(--green); }

.p1 { color: var(--red); font-weight: 700; }
.p2 { color: var(--orange); font-weight: 600; }
.p3 { color: var(--text2); }

.progress-wrap { display: flex; align-items: center; gap: 10px; }

.progress-bar {
  width: 90px; height: 7px;
  background: var(--bg);
  border-radius: 4px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  border-radius: 4px;
  transition: width 0.5s ease;
}

.progress-text { font-size: 11px; color: var(--text2); font-weight: 600; min-width: 30px; }

/* ===== ACTION BUTTONS ===== */
.actions-cell { display: flex; gap: 5px; }

.act-btn {
  width: 30px; height: 30px;
  display: flex; align-items: center; justify-content: center;
  border-radius: 6px;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text2);
  cursor: pointer;
  font-size: 14px;
  transition: var(--transition);
}

.act-btn:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-glow); }
.act-btn.del:hover { border-color: var(--red); color: var(--red); background: var(--red-glow); }
.act-btn.view:hover { border-color: var(--blue); color: var(--blue); background: var(--blue-glow); }
.act-btn.ai:hover { border-color: var(--purple); color: var(--purple); background: var(--purple-glow); }

/* ===== FILTERS ===== */
.filters-bar {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-bottom: 18px;
  align-items: center;
}

.filter-chip {
  padding: 7px 16px;
  border-radius: 20px;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text2);
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px;
  cursor: pointer;
  transition: var(--transition);
}

.filter-chip:hover { border-color: var(--accent); color: var(--text); }
.filter-chip.active { background: var(--accent-glow); border-color: var(--accent); color: var(--accent); font-weight: 600; }

.search-input {
  padding: 8px 16px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 20px;
  color: var(--text);
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px;
  width: 220px;
  transition: var(--transition);
}

.search-input:focus { outline: none; border-color: var(--accent); width: 280px; }
.search-input::placeholder { color: var(--text3); }

/* ===== TABS ===== */
.tabs {
  display: flex;
  gap: 4px;
  border-bottom: 1px solid var(--border);
  margin-bottom: 20px;
  overflow-x: auto;
}

.tab {
  padding: 10px 18px;
  font-size: 12px;
  color: var(--text2);
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: var(--transition);
  white-space: nowrap;
  font-family: 'JetBrains Mono', monospace;
}

.tab:hover { color: var(--text); }
.tab.active { color: var(--accent); border-bottom-color: var(--accent); font-weight: 600; }

/* ============================================================
   AI CHAT PANEL ‚Äî Inside task view
   ============================================================ */
.ai-panel {
  background: var(--bg2);
  border: 1px solid var(--purple);
  border-radius: var(--radius);
  overflow: hidden;
  margin-top: 20px;
}

.ai-panel-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 20px;
  background: linear-gradient(135deg, rgba(177, 151, 252, 0.1), rgba(121, 80, 242, 0.05));
  border-bottom: 1px solid rgba(177, 151, 252, 0.2);
}

.ai-panel-header h4 {
  font-size: 14px;
  font-weight: 600;
  color: var(--purple);
  display: flex;
  align-items: center;
  gap: 8px;
}

.ai-chat-messages {
  padding: 16px 20px;
  max-height: 400px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.ai-msg {
  padding: 12px 16px;
  border-radius: var(--radius-sm);
  font-size: 13px;
  line-height: 1.6;
  max-width: 90%;
  animation: fadeInMsg 0.3s ease;
}

@keyframes fadeInMsg {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

.ai-msg.assistant {
  background: rgba(177, 151, 252, 0.08);
  border: 1px solid rgba(177, 151, 252, 0.15);
  color: var(--text);
  align-self: flex-start;
}

.ai-msg.user {
  background: var(--accent-glow);
  border: 1px solid rgba(0, 212, 170, 0.2);
  color: var(--text);
  align-self: flex-end;
}

.ai-msg.system {
  background: var(--bg3);
  border: 1px solid var(--border);
  color: var(--text2);
  font-size: 12px;
  text-align: center;
  align-self: center;
}

.ai-suggestions {
  padding: 12px 20px;
  border-top: 1px solid rgba(177, 151, 252, 0.15);
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.ai-suggestion-btn {
  padding: 6px 14px;
  border-radius: 20px;
  border: 1px solid rgba(177, 151, 252, 0.3);
  background: rgba(177, 151, 252, 0.05);
  color: var(--purple);
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  cursor: pointer;
  transition: var(--transition);
}

.ai-suggestion-btn:hover {
  background: rgba(177, 151, 252, 0.15);
  border-color: var(--purple);
}

.ai-input-area {
  display: flex;
  gap: 8px;
  padding: 14px 20px;
  border-top: 1px solid rgba(177, 151, 252, 0.15);
  background: rgba(26, 34, 52, 0.5);
}

.ai-input {
  flex: 1;
  padding: 10px 16px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text);
  font-family: 'JetBrains Mono', monospace;
  font-size: 13px;
  transition: var(--transition);
}

.ai-input:focus {
  outline: none;
  border-color: var(--purple);
  box-shadow: 0 0 0 3px var(--purple-glow);
}

.ai-input::placeholder { color: var(--text3); }

.ai-send-btn {
  padding: 10px 18px;
  background: linear-gradient(135deg, var(--purple), #7950f2);
  color: #fff;
  border: none;
  border-radius: var(--radius-sm);
  font-family: 'JetBrains Mono', monospace;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
}

.ai-send-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 15px var(--purple-glow); }
.ai-send-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

/* Loading dots animation */
.ai-loading { display: flex; gap: 4px; padding: 8px 0; }
.ai-loading span {
  width: 8px; height: 8px;
  border-radius: 50%;
  background: var(--purple);
  animation: aiDots 1.4s infinite both;
}
.ai-loading span:nth-child(2) { animation-delay: 0.2s; }
.ai-loading span:nth-child(3) { animation-delay: 0.4s; }

@keyframes aiDots {
  0%, 80%, 100% { opacity: 0.3; transform: scale(0.8); }
  40% { opacity: 1; transform: scale(1); }
}

/* ============================================================
   TASK DETAIL VIEW
   ============================================================ */
.task-detail {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  overflow: hidden;
}

.task-detail-header {
  padding: 28px;
  border-bottom: 1px solid var(--border);
  background: rgba(26, 34, 52, 0.5);
}

.task-detail-header h3 {
  font-family: 'Unbounded', sans-serif;
  font-size: 20px;
  font-weight: 700;
  margin-bottom: 12px;
}

.task-meta {
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
  font-size: 12px;
  color: var(--text2);
}

.task-meta .meta-item {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 4px 12px;
  background: var(--bg);
  border-radius: 20px;
}

.task-detail-body {
  padding: 28px;
}

.task-detail-body .detail-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin-bottom: 20px;
}

.task-steps {
  margin-top: 20px;
}

.task-steps h4 {
  font-size: 14px;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.task-step {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 12px 0;
  border-bottom: 1px solid rgba(36, 48, 68, 0.4);
}

.task-step:last-child { border-bottom: none; }

.task-step .step-check {
  width: 22px; height: 22px;
  border-radius: 50%;
  border: 2px solid var(--border);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  transition: var(--transition);
  flex-shrink: 0;
  margin-top: 2px;
}

.task-step .step-check:hover { border-color: var(--accent); }
.task-step .step-check.done { border-color: var(--green); background: var(--green); color: var(--bg); }
.task-step .step-text { font-size: 13px; line-height: 1.5; }
.task-step .step-text.done { text-decoration: line-through; color: var(--text3); }

/* ===== MODAL ===== */
.modal-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.75);
  backdrop-filter: blur(6px);
  z-index: 1000;
  justify-content: center;
  align-items: center;
}

.modal-overlay.show { display: flex; }

.modal {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  width: 560px;
  max-width: 92vw;
  max-height: 88vh;
  overflow-y: auto;
  box-shadow: var(--shadow-lg);
  animation: slideUp 0.25s ease;
}
.modal.wide { width: 720px; }
.form-section-title { font-size: 13px; font-weight: 700; color: var(--accent); margin: 18px 0 10px; padding-top: 14px; border-top: 1px solid var(--border); }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

@keyframes slideUp {
  from { opacity: 0; transform: translateY(30px); }
  to { opacity: 1; transform: translateY(0); }
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 22px 28px;
  border-bottom: 1px solid var(--border);
  background: rgba(26, 34, 52, 0.5);
}

.modal-header h3 {
  font-family: 'Unbounded', sans-serif;
  font-size: 17px;
  font-weight: 700;
}

.modal-close {
  width: 34px; height: 34px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text2);
  cursor: pointer;
  font-size: 20px;
  display: flex; align-items: center; justify-content: center;
  transition: var(--transition);
}

.modal-close:hover { color: var(--red); border-color: var(--red); background: var(--red-glow); }

.modal-body { padding: 28px; }

.form-group { margin-bottom: 18px; }

.form-group label {
  display: block;
  font-size: 11px;
  color: var(--text2);
  margin-bottom: 7px;
  text-transform: uppercase;
  letter-spacing: 1.2px;
  font-weight: 600;
}

.form-group .required::after { content: ' *'; color: var(--red); }

.form-group input,
.form-group select,
.form-group textarea {
  width: 100%;
  padding: 11px 16px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text);
  font-family: 'JetBrains Mono', monospace;
  font-size: 13px;
  transition: var(--transition);
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-glow);
}

.form-group textarea { min-height: 90px; resize: vertical; }
.form-group select { cursor: pointer; }
.form-group select option { background: var(--bg2); color: var(--text); }

.modal-footer {
  padding: 18px 28px;
  border-top: 1px solid var(--border);
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  background: rgba(26, 34, 52, 0.3);
}

/* Detail grid for modals */
.detail-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}

.detail-item {
  padding: 12px;
  background: var(--bg);
  border-radius: var(--radius-sm);
}

.detail-label {
  font-size: 10px;
  color: var(--text3);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 4px;
}

.detail-value { font-size: 13px; color: var(--text); word-break: break-word; }
.detail-full { grid-column: 1 / -1; }

/* ===== CONFIRM DIALOG ===== */
.confirm-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  z-index: 1100;
  justify-content: center;
  align-items: center;
}

.confirm-overlay.show { display: flex; }

.confirm-box {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 32px;
  width: 400px;
  max-width: 90vw;
  text-align: center;
  box-shadow: var(--shadow-lg);
}

.confirm-box .icon { font-size: 40px; margin-bottom: 16px; }
.confirm-box h4 { font-size: 16px; margin-bottom: 8px; }
.confirm-box p { color: var(--text2); font-size: 13px; margin-bottom: 24px; }
.confirm-actions { display: flex; gap: 10px; justify-content: center; }

/* ===== TOAST ===== */
.toast {
  position: fixed;
  bottom: 28px; right: 28px;
  padding: 14px 24px;
  border-radius: var(--radius-sm);
  font-size: 13px;
  font-weight: 600;
  transform: translateY(100px);
  opacity: 0;
  transition: all 0.35s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  z-index: 2000;
  max-width: 400px;
  box-shadow: var(--shadow);
}

.toast.show { transform: translateY(0); opacity: 1; }
.toast-success { background: var(--accent); color: var(--bg); }
.toast-error { background: var(--red); color: #fff; }
.toast-warning { background: var(--orange); color: var(--bg); }
.toast-info { background: var(--blue); color: var(--bg); }

/* ===== PAGES ===== */
.page { display: none; }
.page.active { display: block; animation: pageIn 0.3s ease; }

@keyframes pageIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.empty { text-align: center; padding: 50px; color: var(--text2); }
.empty .icon { font-size: 44px; margin-bottom: 14px; opacity: 0.6; }
.empty p { font-size: 14px; }

/* ===== STATUS BAR ===== */
.status-bar {
  position: fixed;
  bottom: 0; left: 0; right: 0;
  background: var(--bg2);
  border-top: 1px solid var(--border);
  padding: 6px 24px;
  display: flex;
  justify-content: space-between;
  font-size: 11px;
  color: var(--text3);
  z-index: 50;
}

.status-bar .dot {
  display: inline-block;
  width: 7px; height: 7px;
  border-radius: 50%;
  margin-right: 6px;
}

.dot-green { background: var(--accent); }
.dot-red { background: var(--red); }

/* ===== MOBILE ===== */
.mobile-toggle { display: none; }

@media (max-width: 900px) {
  .sidebar { transform: translateX(-100%); width: 280px; }
  .sidebar.open { transform: translateX(0); box-shadow: var(--shadow-lg); }
  .main { margin-left: 0; padding: 20px 16px 60px; }
  .metrics { grid-template-columns: repeat(2, 1fr); }
  .project-grid { grid-template-columns: 1fr; }
  .subproject-grid { grid-template-columns: 1fr; }
  .detail-grid { grid-template-columns: 1fr; }
  .page-header h2 { font-size: 20px; }
  .task-detail-body .detail-grid { grid-template-columns: 1fr; }
  .form-row { grid-template-columns: 1fr; }
  .modal.wide { width: 95vw; }
  #aiGlobalPanel { width: calc(100vw - 32px) !important; right: 16px !important; bottom: 16px !important; height: 70vh !important; }

  .mobile-toggle {
    display: flex !important;
    position: fixed;
    top: 14px; left: 14px;
    z-index: 200;
    width: 44px; height: 44px;
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    align-items: center; justify-content: center;
    cursor: pointer;
    color: var(--text);
    font-size: 22px;
    box-shadow: var(--shadow);
  }
}
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div class="login-screen" id="loginScreen">
  <div class="login-card">
    <span class="login-icon">üè•</span>
    <div class="login-logo">RKT HUB</div>
    <div class="login-sub">–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞–º–∏</div>
    <label class="login-label">–í–∞—à Telegram ID</label>
    <input class="login-input" id="loginTgId" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 1144907578" autofocus>
    <div class="login-hint">
      –£–∑–Ω–∞–π—Ç–µ —Å–≤–æ–π ID: –Ω–∞–ø–∏—à–∏—Ç–µ <a href="https://t.me/userinfobot" target="_blank">@userinfobot</a> –≤ Telegram
    </div>
    <button class="login-btn" id="loginBtn" onclick="doLogin()">
      <span id="loginBtnText">–í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</span>
    </button>
    <div class="login-error" id="loginError"></div>
  </div>
</div>

<button class="mobile-toggle" id="mobileToggle" onclick="toggleSidebar()">‚ò∞</button>

<!-- MAIN APP -->
<div class="app" id="mainApp" style="display:none">

  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="logo-section">
      <h1>RKT HUB</h1>
      <div class="subtitle">v4.0 ‚Ä¢ –ü—Ä–æ–µ–∫—Ç—ã + –ò–ò</div>
    </div>

    <nav class="nav">
      <div class="nav-section">–ì–ª–∞–≤–Ω–æ–µ</div>
      <a class="nav-item active" onclick="showPage('home')" data-page="home">
        <span class="icon">üè†</span><span class="label">–ü—Ä–æ–µ–∫—Ç—ã</span>
      </a>
      <a class="nav-item" onclick="showPage('dashboard')" data-page="dashboard">
        <span class="icon">üìä</span><span class="label">–î–∞—à–±–æ—Ä–¥ –ì–î</span>
      </a>
      <a class="nav-item" onclick="toggleAiPanel()" data-page="ai" style="border:1px solid rgba(177,151,252,0.2)">
        <span class="icon">ü§ñ</span><span class="label">–ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç</span>
        <span class="badge" style="background:var(--purple)">AI</span>
      </a>

      <div class="nav-section">–î–∞–Ω–Ω—ã–µ</div>
      <a class="nav-item" onclick="showPage('partners')" data-page="partners">
        <span class="icon">ü§ù</span><span class="label">–ü–∞—Ä—Ç–Ω—ë—Ä—ã</span>
        <span class="badge" id="badge-partners">0</span>
      </a>
      <a class="nav-item" onclick="showPage('tasks')" data-page="tasks">
        <span class="icon">‚úÖ</span><span class="label">–ó–∞–¥–∞—á–∏</span>
        <span class="badge" id="badge-tasks">0</span>
      </a>
      <a class="nav-item" onclick="showPage('comms')" data-page="comms">
        <span class="icon">üí¨</span><span class="label">–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏</span>
      </a>

      <div class="nav-section">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>
      <a class="nav-item" onclick="showPage('staff')" data-page="staff" id="nav-staff">
        <span class="icon">üë•</span><span class="label">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</span>
      </a>
      <a class="nav-item" onclick="showPage('approvals')" data-page="approvals" id="nav-approvals">
        <span class="icon">üìã</span><span class="label">–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è</span>
        <span class="badge badge-orange" id="badge-approvals">0</span>
      </a>

      <div class="nav-section">–°–∏—Å—Ç–µ–º–∞</div>
      <a class="nav-item" onclick="showPage('settings')" data-page="settings">
        <span class="icon">‚öôÔ∏è</span><span class="label">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
      </a>
    </nav>

    <div class="user-bar" id="userBar">
      <div class="user-info">
        <div class="user-avatar" id="userAvatar">?</div>
        <div>
          <div class="user-name" id="userName">‚Äî</div>
          <div class="user-role-text" id="userRoleText">‚Äî</div>
        </div>
      </div>
      <button class="logout-btn" onclick="doLogout()">üö™ –í—ã–π—Ç–∏</button>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="main">

    <!-- ======== HOME: TOP-LEVEL PROJECTS ======== -->
    <div class="page active" id="page-home">
      <div class="page-header">
        <h2>üè† –ú–æ–∏ –ø—Ä–æ–µ–∫—Ç—ã</h2>
        <div class="actions">
          <button class="btn" onclick="toggleAiPanel()" style="background:linear-gradient(135deg,var(--purple),#7950f2);color:#fff">ü§ñ –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç</button>
          <button class="btn btn-secondary" onclick="loadData()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
      </div>
      <div class="metrics" id="home-metrics"></div>
      <div class="project-grid" id="project-grid"></div>
    </div>

    <!-- ======== PROJECT VIEW (subprojects) ======== -->
    <div class="page" id="page-project">
      <div class="breadcrumb">
        <a onclick="showPage('home')">üè† –ü—Ä–æ–µ–∫—Ç—ã</a>
        <span class="sep">‚Ä∫</span>
        <span class="current" id="pv-name">‚Äî</span>
      </div>
      <div class="page-header">
        <h2 id="pv-title">üìÅ –ü—Ä–æ–µ–∫—Ç</h2>
        <div class="actions">
          <button class="btn btn-primary" id="btn-add-sub" onclick="openAddSubproject()">+ –ü–æ–¥–ø—Ä–æ–µ–∫—Ç</button>
          <button class="btn btn-primary" onclick="openModal('task')">+ –ó–∞–¥–∞—á–∞</button>
          <button class="btn btn-secondary" onclick="openModal('partner')">+ –ü–∞—Ä—Ç–Ω—ë—Ä</button>
        </div>
      </div>
      <div class="metrics" id="pv-metrics"></div>
      <div class="subproject-grid" id="subproject-grid"></div>

      <!-- Project-level tabs -->
      <div class="tabs" id="pv-tabs">
        <div class="tab active" data-tab="overview" onclick="showPvTab('overview')">üìä –û–±–∑–æ—Ä</div>
        <div class="tab" data-tab="tasks" onclick="showPvTab('tasks')">‚úÖ –ó–∞–¥–∞—á–∏</div>
        <div class="tab" data-tab="partners" onclick="showPvTab('partners')">ü§ù –ü–∞—Ä—Ç–Ω—ë—Ä—ã</div>
        <div class="tab" data-tab="comms" onclick="showPvTab('comms')">üí¨ –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏</div>
      </div>
      <div id="pv-content"></div>
    </div>

    <!-- ======== SUBPROJECT VIEW (workspace) ======== -->
    <div class="page" id="page-subproject">
      <div class="breadcrumb">
        <a onclick="showPage('home')">üè† –ü—Ä–æ–µ–∫—Ç—ã</a>
        <span class="sep">‚Ä∫</span>
        <a onclick="openProject(currentProject)" id="sp-parent">‚Äî</a>
        <span class="sep">‚Ä∫</span>
        <span class="current" id="sp-name">‚Äî</span>
      </div>
      <div class="page-header">
        <h2 id="sp-title">üìÅ –ü–æ–¥–ø—Ä–æ–µ–∫—Ç</h2>
        <div class="actions">
          <button class="btn btn-primary" onclick="openModal('task')">+ –ó–∞–¥–∞—á–∞</button>
          <button class="btn btn-primary" onclick="openModal('partner')">+ –ü–∞—Ä—Ç–Ω—ë—Ä</button>
          <button class="btn btn-secondary" onclick="openModal('comm')">+ –ö–æ–Ω—Ç–∞–∫—Ç</button>
        </div>
      </div>
      <div class="metrics" id="sp-metrics"></div>

      <div class="tabs" id="sp-tabs">
        <div class="tab active" data-tab="overview" onclick="showSpTab('overview')">üìä –û–±–∑–æ—Ä</div>
        <div class="tab" data-tab="tasks" onclick="showSpTab('tasks')">‚úÖ –ó–∞–¥–∞—á–∏</div>
        <div class="tab" data-tab="partners" onclick="showSpTab('partners')">ü§ù –ü–∞—Ä—Ç–Ω—ë—Ä—ã</div>
        <div class="tab" data-tab="projects" onclick="showSpTab('projects')">üìÅ –ü—Ä–æ–µ–∫—Ç—ã</div>
        <div class="tab" data-tab="comms" onclick="showSpTab('comms')">üí¨ –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏</div>
      </div>
      <div id="sp-content"></div>
    </div>

    <!-- ======== TASK DETAIL with AI ======== -->
    <div class="page" id="page-taskdetail">
      <div class="breadcrumb" id="td-breadcrumb"></div>
      <div id="td-content"></div>
    </div>

    <!-- ======== DASHBOARD ======== -->
    <div class="page" id="page-dashboard">
      <div class="page-header">
        <h2>üìä –î–∞—à–±–æ—Ä–¥ –≥–µ–Ω–µ—Ä–∞–ª—å–Ω–æ–≥–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞</h2>
        <div class="actions">
          <button class="btn btn-secondary" onclick="loadData()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
      </div>
      <div class="metrics" id="dash-metrics"></div>
      <div class="card" style="border:1px solid rgba(177,151,252,0.2);background:linear-gradient(135deg,rgba(177,151,252,0.03),rgba(121,80,242,0.01))">
        <div class="card-header" style="display:flex;align-items:center;justify-content:space-between">
          <h3>ü§ñ –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç</h3>
          <button class="btn btn-sm" onclick="toggleAiPanel()" style="background:linear-gradient(135deg,var(--purple),#7950f2);color:#fff;border:none;font-size:11px">–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç ‚Üí</button>
        </div>
        <div style="padding:0 20px 16px;display:flex;gap:8px;flex-wrap:wrap">
          <button onclick="toggleAiPanel();setTimeout(()=>globalAiQuick('–°–æ—Å—Ç–∞–≤—å –æ—Ç—á—ë—Ç –ø–æ –≤—Å–µ–º –ø—Ä–æ–µ–∫—Ç–∞–º'),300)" style="padding:8px 16px;border-radius:20px;border:1px solid rgba(177,151,252,0.25);background:rgba(177,151,252,0.06);color:var(--purple);font-family:'JetBrains Mono',monospace;font-size:11px;cursor:pointer;transition:all .2s">üìä –û—Ç—á—ë—Ç –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º</button>
          <button onclick="toggleAiPanel();setTimeout(()=>globalAiQuick('–ö–∞–∫–∏–µ –∑–∞–¥–∞—á–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω—ã?'),300)" style="padding:8px 16px;border-radius:20px;border:1px solid rgba(177,151,252,0.25);background:rgba(177,151,252,0.06);color:var(--purple);font-family:'JetBrains Mono',monospace;font-size:11px;cursor:pointer;transition:all .2s">üî¥ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ</button>
          <button onclick="toggleAiPanel();setTimeout(()=>globalAiQuick('–ü–æ–¥–≥–æ—Ç–æ–≤—å –ø–ª–∞–Ω –Ω–∞ –Ω–µ–¥–µ–ª—é'),300)" style="padding:8px 16px;border-radius:20px;border:1px solid rgba(177,151,252,0.25);background:rgba(177,151,252,0.06);color:var(--purple);font-family:'JetBrains Mono',monospace;font-size:11px;cursor:pointer;transition:all .2s">üìã –ü–ª–∞–Ω –Ω–∞ –Ω–µ–¥–µ–ª—é</button>
          <button onclick="toggleAiPanel();setTimeout(()=>globalAiQuick('–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ä–∏—Å–∫–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤'),300)" style="padding:8px 16px;border-radius:20px;border:1px solid rgba(177,151,252,0.25);background:rgba(177,151,252,0.06);color:var(--purple);font-family:'JetBrains Mono',monospace;font-size:11px;cursor:pointer;transition:all .2s">‚ö†Ô∏è –†–∏—Å–∫–∏</button>
        </div>
      </div>
      <div class="card">
        <div class="card-header"><h3>üî¥ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏</h3></div>
        <div class="table-wrap"><table><thead><tr><th>–ó–∞–¥–∞—á–∞</th><th>–ü—Ä–æ–µ–∫—Ç</th><th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th><th>–î–µ–¥–ª–∞–π–Ω</th><th>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th><th></th></tr></thead><tbody id="dash-overdue"></tbody></table></div>
      </div>
      <div class="card">
        <div class="card-header"><h3>üìÅ –í—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã</h3></div>
        <div class="table-wrap"><table><thead><tr><th>–ü—Ä–æ–µ–∫—Ç</th><th>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ü—Ä–æ–≥—Ä–µ—Å—Å</th><th>–î–µ–¥–ª–∞–π–Ω</th></tr></thead><tbody id="dash-projects"></tbody></table></div>
      </div>
      <div class="card">
        <div class="card-header"><h3>üí¨ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏</h3></div>
        <div class="table-wrap"><table><thead><tr><th>–ü–∞—Ä—Ç–Ω—ë—Ä</th><th>–¢–∏–ø</th><th>–¢–µ–º–∞</th><th>–î–∞—Ç–∞</th><th>–ê–≤—Ç–æ—Ä</th></tr></thead><tbody id="dash-comms"></tbody></table></div>
      </div>
    </div>

    <!-- ======== PARTNERS ======== -->
    <div class="page" id="page-partners">
      <div class="page-header">
        <h2>ü§ù –í—Å–µ –ø–∞—Ä—Ç–Ω—ë—Ä—ã</h2>
        <div class="actions">
          <button class="btn btn-primary" id="btn-add-partner" onclick="openModal('partner')">+ –ü–∞—Ä—Ç–Ω—ë—Ä</button>
          <button class="btn btn-secondary" onclick="exportCSV('partners')">üì• CSV</button>
        </div>
      </div>
      <div class="filters-bar">
        <div id="partner-filters"></div>
        <input class="search-input" id="partner-search" placeholder="üîç –ü–æ–∏—Å–∫..." oninput="renderPartners()">
      </div>
      <div class="card"><div class="table-wrap"><table>
        <thead><tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–°—Ç—Ä–∞–Ω–∞</th><th>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</th><th>–ü—Ä–æ–¥—É–∫—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ö–æ–Ω—Ç–∞–∫—Ç</th><th></th></tr></thead>
        <tbody id="partners-table"></tbody>
      </table></div></div>
    </div>

    <!-- ======== TASKS ======== -->
    <div class="page" id="page-tasks">
      <div class="page-header">
        <h2>‚úÖ –í—Å–µ –∑–∞–¥–∞—á–∏</h2>
        <div class="actions">
          <button class="btn btn-primary" onclick="openModal('task')">+ –ó–∞–¥–∞—á–∞</button>
          <button class="btn btn-secondary" onclick="exportCSV('tasks')">üì• CSV</button>
        </div>
      </div>
      <div class="filters-bar">
        <div id="task-filters"></div>
        <input class="search-input" id="task-search" placeholder="üîç –ü–æ–∏—Å–∫..." oninput="renderTasks()">
      </div>
      <div class="card"><div class="table-wrap"><table>
        <thead><tr><th>–ó–∞–¥–∞—á–∞</th><th>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</th><th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th><th>–î–µ–¥–ª–∞–π–Ω</th><th></th></tr></thead>
        <tbody id="tasks-table"></tbody>
      </table></div></div>
    </div>

    <!-- ======== STAFF ======== -->
    <div class="page" id="page-staff">
      <div class="page-header">
        <h2>üë• –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</h2>
        <div class="actions">
          <button class="btn btn-primary" id="btn-add-staff" onclick="openModal('staff')">+ –°–æ—Ç—Ä—É–¥–Ω–∏–∫</button>
        </div>
      </div>
      <div id="staff-content"></div>
    </div>

    <!-- ======== APPROVALS ======== -->
    <div class="page" id="page-approvals">
      <div class="page-header"><h2>üìã –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è</h2></div>
      <div id="approvals-content"></div>
    </div>

    <!-- ======== COMMS ======== -->
    <div class="page" id="page-comms">
      <div class="page-header">
        <h2>üí¨ –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏</h2>
        <div class="actions">
          <button class="btn btn-primary" onclick="openModal('comm')">+ –ö–æ–Ω—Ç–∞–∫—Ç</button>
        </div>
      </div>
      <div class="filters-bar">
        <input class="search-input" id="comm-search" placeholder="üîç –ü–æ–∏—Å–∫..." oninput="renderComms()">
      </div>
      <div class="card"><div class="table-wrap"><table>
        <thead><tr><th>–ü–∞—Ä—Ç–Ω—ë—Ä</th><th>–¢–∏–ø</th><th>–¢–µ–º–∞</th><th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th><th>–î–∞—Ç–∞</th><th>–ê–≤—Ç–æ—Ä</th><th></th></tr></thead>
        <tbody id="comms-table"></tbody>
      </table></div></div>
    </div>

    <!-- ======== SETTINGS ======== -->
    <div class="page" id="page-settings">
      <div class="page-header"><h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2></div>
      <div class="card" style="padding:28px">
        <h3 style="margin-bottom:20px;font-size:15px">üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h3>
        <div class="form-group"><label>API</label><input type="text" id="settingsApiUrl" readonly style="opacity:0.7"></div>
        <div class="form-group"><label>Sheet ID</label><input type="text" value="12BniI4H5inrEDJKWNrSxL480acGSGJlSIFvCqYfd9KY" readonly style="opacity:0.7"></div>
      </div>
      <div class="card" style="padding:28px;margin-top:16px">
        <h3 style="margin-bottom:20px;font-size:15px">üë§ –ü—Ä–æ—Ñ–∏–ª—å</h3>
        <div class="detail-grid">
          <div class="detail-item"><div class="detail-label">–ò–º—è</div><div class="detail-value" id="s-name">‚Äî</div></div>
          <div class="detail-item"><div class="detail-label">–†–æ–ª—å</div><div class="detail-value" id="s-role">‚Äî</div></div>
          <div class="detail-item"><div class="detail-label">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div><div class="detail-value" id="s-dir">‚Äî</div></div>
          <div class="detail-item"><div class="detail-label">Telegram ID</div><div class="detail-value" id="s-tgid">‚Äî</div></div>
        </div>
      </div>
      <div class="card" style="padding:28px;margin-top:16px">
        <h3 style="margin-bottom:20px;font-size:15px">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
        <div class="detail-grid" id="s-stats"></div>
      </div>
    </div>

  </main>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this)closeModal()">
  <div class="modal" id="modalBox">
    <div class="modal-header">
      <h3 id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å</h3>
      <button class="modal-close" onclick="closeModal()">‚úï</button>
    </div>
    <div class="modal-body" id="modalBody"></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary" id="modalSaveBtn" onclick="saveModal()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- DETAIL MODAL -->
<div class="modal-overlay" id="detailOverlay" onclick="if(event.target===this)closeDetail()">
  <div class="modal" style="width:620px">
    <div class="modal-header">
      <h3 id="detailTitle">–î–µ—Ç–∞–ª–∏</h3>
      <button class="modal-close" onclick="closeDetail()">‚úï</button>
    </div>
    <div class="modal-body" id="detailBody"></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeDetail()">–ó–∞–∫—Ä—ã—Ç—å</button>
      <button class="btn btn-primary" id="detailEditBtn">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>
  </div>
</div>

<!-- CONFIRM -->
<div class="confirm-overlay" id="confirmOverlay">
  <div class="confirm-box">
    <div class="icon">‚ö†Ô∏è</div>
    <h4 id="confirmTitle">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h4>
    <p id="confirmText">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</p>
    <div class="confirm-actions">
      <button class="btn btn-secondary" onclick="closeConfirm(false)">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-danger" onclick="closeConfirm(true)">üóë –£–¥–∞–ª–∏—Ç—å</button>
    </div>
  </div>
</div>

<button id="aiFab" onclick="toggleAiPanel()" style="position:fixed;bottom:40px;right:28px;width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,#b197fc,#7950f2);border:none;color:#fff;font-size:28px;cursor:pointer;z-index:500;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 24px rgba(177,151,252,0.4);transition:all .3s">ü§ñ</button>

<div id="aiGlobalPanel" style="position:fixed;bottom:40px;right:28px;width:440px;max-width:calc(100vw - 56px);height:600px;max-height:calc(100vh - 80px);background:var(--bg2);border:1px solid var(--purple);border-radius:16px;z-index:600;display:none;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,0.6),0 0 40px rgba(177,151,252,0.1)">
  <div style="display:flex;align-items:center;justify-content:space-between;padding:16px 20px;background:linear-gradient(135deg,rgba(177,151,252,0.12),rgba(121,80,242,0.06));border-bottom:1px solid rgba(177,151,252,0.2);border-radius:16px 16px 0 0">
    <h4 style="font-size:15px;font-weight:700;color:var(--purple);display:flex;align-items:center;gap:10px">ü§ñ –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç RKT HUB</h4>
    <button onclick="toggleAiPanel()" style="width:30px;height:30px;border-radius:50%;border:1px solid rgba(177,151,252,0.3);background:transparent;color:var(--text2);cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center">‚úï</button>
  </div>
  <div style="padding:10px 16px;border-bottom:1px solid rgba(177,151,252,0.1);display:flex;gap:6px;flex-wrap:wrap">
    <button onclick="globalAiQuick('–ö–∞–∫–∏–µ –∑–∞–¥–∞—á–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω—ã?')" style="padding:5px 12px;border-radius:16px;border:1px solid rgba(177,151,252,0.25);background:rgba(177,151,252,0.05);color:var(--purple);font-family:'JetBrains Mono',monospace;font-size:10px;cursor:pointer">üî¥ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</button>
    <button onclick="globalAiQuick('–°–æ—Å—Ç–∞–≤—å –æ—Ç—á—ë—Ç –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º')" style="padding:5px 12px;border-radius:16px;border:1px solid rgba(177,151,252,0.25);background:rgba(177,151,252,0.05);color:var(--purple);font-family:'JetBrains Mono',monospace;font-size:10px;cursor:pointer">üìä –û—Ç—á—ë—Ç</button>
    <button onclick="globalAiQuick('–ù–∞–ø–∏—à–∏ –¥–µ–ª–æ–≤–æ–µ –ø–∏—Å—å–º–æ')" style="padding:5px 12px;border-radius:16px;border:1px solid rgba(177,151,252,0.25);background:rgba(177,151,252,0.05);color:var(--purple);font-family:'JetBrains Mono',monospace;font-size:10px;cursor:pointer">üìß –ü–∏—Å—å–º–æ</button>
    <button onclick="globalAiQuick('–ö–∞–∫–∏–µ –∑–∞–¥–∞—á–∏ —Å–∞–º—ã–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ?')" style="padding:5px 12px;border-radius:16px;border:1px solid rgba(177,151,252,0.25);background:rgba(177,151,252,0.05);color:var(--purple);font-family:'JetBrains Mono',monospace;font-size:10px;cursor:pointer">‚≠ê –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã</button>
    <button onclick="globalAiQuick('–ü–æ–¥–≥–æ—Ç–æ–≤—å –ø–ª–∞–Ω –Ω–∞ –Ω–µ–¥–µ–ª—é')" style="padding:5px 12px;border-radius:16px;border:1px solid rgba(177,151,252,0.25);background:rgba(177,151,252,0.05);color:var(--purple);font-family:'JetBrains Mono',monospace;font-size:10px;cursor:pointer">üìã –ü–ª–∞–Ω</button>
  </div>
  <div id="ai-global-messages" style="flex:1;padding:16px;overflow-y:auto;display:flex;flex-direction:column;gap:10px">
    <div class="ai-msg system">–ü—Ä–∏–≤–µ—Ç! –Ø –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç RKT HUB. –ú–æ–≥—É –ø–æ–º–æ—á—å —Å –∑–∞–¥–∞—á–∞–º–∏, –ø–∏—Å—å–º–∞–º–∏, –∞–Ω–∞–ª–∏–∑–æ–º –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º –ø–æ –≤—Å–µ–º –≤–∞—à–∏–º –ø—Ä–æ–µ–∫—Ç–∞–º. –°–ø—Ä–∞—à–∏–≤–∞–π—Ç–µ!</div>
  </div>
  <div style="display:flex;gap:8px;padding:14px 16px;border-top:1px solid rgba(177,151,252,0.15);background:rgba(26,34,52,0.5);border-radius:0 0 16px 16px">
    <input id="ai-global-input" placeholder="–°–ø—Ä–æ—Å–∏—Ç–µ —á—Ç–æ —É–≥–æ–¥–Ω–æ..." onkeydown="if(event.key==='Enter')sendGlobalAi()" style="flex:1;padding:10px 16px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:13px">
    <button id="ai-global-send" onclick="sendGlobalAi()" style="padding:10px 18px;background:linear-gradient(135deg,var(--purple),#7950f2);color:#fff;border:none;border-radius:8px;font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:600;cursor:pointer">‚û§</button>
  </div>
</div>

<div class="toast" id="toast"></div>
<div class="status-bar">
  <div><span class="dot dot-green" id="statusDot"></span> <span id="statusText">–ü–æ–¥–∫–ª—é—á–µ–Ω–æ</span></div>
  <div id="statusTime"></div>
</div>

<script>
// ============================================================
// CONFIG & STATE
// ============================================================
const CONFIG = {
  API_URL: 'https://daniyal2212.app.n8n.cloud/webhook/rkt-api',
  WRITE_URL: 'https://daniyal2212.app.n8n.cloud/webhook/rkt-write',
  AI_URL: 'https://daniyal2212.app.n8n.cloud/webhook/rkt-ai',
  REFRESH: 300000,
  VERSION: '3.0.0'
};

let DATA = { partners:[], tasks:[], directions:[], staff:[], projects:[], approvals:[], comms:[] };
let USER = null;
let currentModal = '';
let editingItem = null;
let confirmCallback = null;
let currentFilters = { partners: '–í—Å–µ', tasks: '–í—Å–µ' };
let refreshTimer = null;

// Navigation state
let currentProject = null;       // Top-level project key (e.g. 'rkt', 'sites')
let currentSubproject = null;    // Subproject direction (e.g. '–ö–¢', '–ü—ã—à–∫–∏ –º–∏—Ä–∞')
let currentPvTab = 'overview';   // Project view tab
let currentSpTab = 'overview';   // Subproject view tab
let currentTaskId = null;        // Task open for detail+AI
let aiMessages = [];             // AI chat history for current task

// ============================================================
// TOP-LEVEL PROJECTS DEFINITION
// ============================================================
const PROJECTS = {
  rkt: {
    name: '–†–ö–¢',
    emoji: 'üè•',
    color: 'var(--accent)',
    gradient: 'linear-gradient(90deg, #00d4aa, #00b894)',
    desc: '–†–æ—Å—Å–∏–π—Å–∫–∏–µ –ö–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã–µ –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ ‚Äî –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è',
    subprojects: {
      '–ö–¢':       { emoji: 'üî¨', color: 'var(--accent)', desc: '–ö–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã–µ —Ç–æ–º–æ–≥—Ä–∞—Ñ—ã ‚Äî –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è —Å Syno-Tech' },
      '–†–µ–Ω—Ç–≥–µ–Ω':  { emoji: 'üì°', color: 'var(--blue)', desc: '–†–µ–Ω—Ç–≥–µ–Ω–æ–≤—Å–∫–∏–µ –∞–ø–ø–∞—Ä–∞—Ç—ã ‚Äî —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –ª–∏–Ω–µ–π–∫–∏' },
      '–†–æ–±–æ—Ç—ã':   { emoji: 'ü§ñ', color: 'var(--purple)', desc: '–•–∏—Ä—É—Ä–≥–∏—á–µ—Å–∫–∏–µ —Ä–æ–±–æ—Ç–æ—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–∏—Å—Ç–µ–º—ã' },
      '–£—Ä–æ–ª–æ–≥–∏—è': { emoji: 'üíä', color: 'var(--orange)', desc: '–£—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ' },
      'PACS':     { emoji: 'üíª', color: 'var(--pink)', desc: '–°–∏—Å—Ç–µ–º—ã –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π' },
      '–£–ó–ò':      { emoji: 'ü©∫', color: 'var(--green)', desc: '–£–ª—å—Ç—Ä–∞–∑–≤—É–∫–æ–≤–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ ‚Äî –ø–ª–∞–Ω —Å 2028' }
    }
  },
  sites: {
    name: '–°–∞–π—Ç—ã',
    emoji: 'üåê',
    color: 'var(--blue)',
    gradient: 'linear-gradient(90deg, #4dabf7, #228be6)',
    desc: '–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∏ –≤–µ–¥–µ–Ω–∏–µ –≤–µ–±-—Å–∞–π—Ç–æ–≤ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞',
    subprojects: {
      '–ü—ã—à–∫–∏ –º–∏—Ä–∞':  { emoji: 'üç©', color: 'var(--orange)', desc: '–°–∞–π—Ç –¥–ª—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ –ü—ã—à–∫–∏ –º–∏—Ä–∞' },
      '–ë—Ä–µ–∂–Ω–µ–≤':     { emoji: 'üèõ', color: 'var(--red)', desc: '–°–∞–π—Ç –¥–ª—è —Ä–µ—Å—Ç–æ–∫–ª—É–±–∞ –ë—Ä–µ–∂–Ω–µ–≤' },
      '–ö–µ—Ä–∞—Ç–∏–Ω –ê–≥—Ä—ã–∑': { emoji: 'üíá', color: 'var(--pink)', desc: '–°–∞–π—Ç –∫–µ—Ä–∞—Ç–∏–Ω–æ–≤–æ–≥–æ –≤—ã–ø—Ä—è–º–ª–µ–Ω–∏—è, –ê–≥—Ä—ã–∑' }
    },
    canAddSub: true // can add new subprojects (sites)
  }
};

// ============================================================
// ROLES
// ============================================================
const ROLES = {
  'CEO':          { emoji: 'üëë', level: 3, canWrite: true, canDelete: true, canApprove: true, canManageStaff: true, seeAll: true },
  '–ó–∞–º':          { emoji: '‚≠ê', level: 2, canWrite: true, canDelete: false, canApprove: false, canManageStaff: false, seeAll: true },
  '–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å': { emoji: 'üìã', level: 1, canWrite: false, canDelete: false, canApprove: false, canManageStaff: false, seeAll: false }
};

function getUserPerms() {
  return USER ? (ROLES[USER.role] || ROLES['–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å']) : ROLES['–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å'];
}

// ============================================================
// FORM DEFINITIONS
// ============================================================
function getDirectionOptions() {
  // Gather all subproject names across all projects
  let opts = [];
  Object.values(PROJECTS).forEach(p => {
    Object.keys(p.subprojects).forEach(sp => { if (!opts.includes(sp)) opts.push(sp); });
  });
  opts.push('–û–±—â–µ–µ');
  return opts;
}

const FORM_DEFS = {
  partner: {
    title: '–ü–∞—Ä—Ç–Ω—ë—Ä', sheet: '–ü–∞—Ä—Ç–Ω—ë—Ä—ã',
    fields: [
      { name: '–ù–∞–∑–≤–∞–Ω–∏–µ', type: 'text', required: true, placeholder: '–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏' },
      { name: '–°—Ç—Ä–∞–Ω–∞', type: 'text', placeholder: '–ö–∏—Ç–∞–π, –†–æ—Å—Å–∏—è...' },
      { name: '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', type: 'select', options: () => getDirectionOptions() },
      { name: '–ü—Ä–æ–¥—É–∫—Ç', type: 'text', placeholder: '–ü—Ä–æ–¥—É–∫—Ç' },
      { name: '–°—Ç–∞—Ç—É—Å', type: 'select', options: ['Research', '–ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã', '–ê–∫—Ç–∏–≤–Ω—ã–π', '–ü–∞—É–∑–∞'] },
      { name: '–ö–æ–Ω—Ç–∞–∫—Ç', type: 'text', placeholder: '–ò–º—è –∫–æ–Ω—Ç–∞–∫—Ç–∞' },
      { name: 'Email', type: 'text', placeholder: 'email@company.com' },
      { name: '–¢–µ–ª–µ—Ñ–æ–Ω', type: 'text', placeholder: '+7...' },
      { name: '–°–∞–π—Ç', type: 'text', placeholder: 'https://' },
      { name: '–û–ø–∏—Å–∞–Ω–∏–µ', type: 'textarea', placeholder: '–ó–∞–º–µ—Ç–∫–∏...' }
    ]
  },
  project: {
    title: '–ü—Ä–æ–µ–∫—Ç', sheet: '–ü—Ä–æ–µ–∫—Ç—ã',
    fields: [
      { name: '–ù–∞–∑–≤–∞–Ω–∏–µ', type: 'text', required: true, placeholder: '–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞' },
      { name: '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', type: 'select', options: () => getDirectionOptions() },
      { name: '–û–ø–∏—Å–∞–Ω–∏–µ', type: 'textarea', placeholder: '–û–ø–∏—Å–∞–Ω–∏–µ...' },
      { name: '–°—Ç–∞—Ç—É—Å', type: 'select', options: ['–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ', '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞', '–í —Ä–∞–±–æ—Ç–µ', '–ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã', '–ó–∞–≤–µ—Ä—à—ë–Ω'] },
      { name: '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç', type: 'select', options: ['P1', 'P2', 'P3'] },
      { name: '–ü—Ä–æ–≥—Ä–µ—Å—Å', type: 'text', placeholder: '0-100' },
      { name: '–ü–∞—Ä—Ç–Ω—ë—Ä', type: 'text', placeholder: '–ü–∞—Ä—Ç–Ω—ë—Ä' },
      { name: '–ë—é–¥–∂–µ—Ç', type: 'text', placeholder: '–ë—é–¥–∂–µ—Ç' },
      { name: '–î–µ–¥–ª–∞–π–Ω', type: 'date' },
      { name: '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π', type: 'text', placeholder: '–ö—Ç–æ –≤–µ–¥—ë—Ç' }
    ]
  },
  task: {
    title: '–ó–∞–¥–∞—á–∞', sheet: '–ó–∞–¥–∞—á–∏',
    fields: [
      { name: '–û–ø–∏—Å–∞–Ω–∏–µ', type: 'text', required: true, placeholder: '–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å' },
      { name: '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', type: 'select', options: () => getDirectionOptions() },
      { name: '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç', type: 'select', options: ['P1', 'P2', 'P3'] },
      { name: '–°—Ç–∞—Ç—É—Å', type: 'select', options: ['‚è≥ –í –æ—á–µ—Ä–µ–¥–∏', '–í —Ä–∞–±–æ—Ç–µ', '–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ', '–ì–æ—Ç–æ–≤–æ'] },
      { name: '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π', type: 'text', placeholder: '–ö—Ç–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç' },
      { name: '–ü—Ä–æ–µ–∫—Ç', type: 'text', placeholder: '–ü—Ä–æ–µ–∫—Ç' },
      { name: '–î–µ–¥–ª–∞–π–Ω', type: 'date' },
      { name: '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π', type: 'textarea', placeholder: '–î–æ–ø. –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è...' }
    ]
  },
  staff: {
    title: '–°–æ—Ç—Ä—É–¥–Ω–∏–∫', sheet: '–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏',
    fields: [
      { name: '–ò–º—è', type: 'text', required: true, placeholder: '–§–ò–û' },
      { name: 'Telegram_ID', type: 'text', placeholder: '–ß–∏—Å–ª–æ–≤–æ–π Telegram ID' },
      { name: 'Username', type: 'text', placeholder: '@username' },
      { name: '–†–æ–ª—å', type: 'select', options: ['CEO', '–ó–∞–º', '–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å'] },
      { name: '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', type: 'select', options: () => ['–í—Å–µ', ...getDirectionOptions()] },
      { name: 'Email', type: 'text', placeholder: 'email' },
      { name: '–¢–µ–ª–µ—Ñ–æ–Ω', type: 'text', placeholder: '+7...' }
    ]
  },
  comm: {
    title: '–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è', sheet: '–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏',
    fields: [
      { name: '–ü–∞—Ä—Ç–Ω—ë—Ä', type: 'text', required: true, placeholder: '–° –∫–µ–º –æ–±—â–∞–ª–∏—Å—å' },
      { name: '–¢–∏–ø', type: 'select', options: ['–ó–≤–æ–Ω–æ–∫', 'Email', '–í—Å—Ç—Ä–µ—á–∞', '–ß–∞—Ç', 'Zoom', 'WhatsApp'] },
      { name: '–¢–µ–º–∞', type: 'text', placeholder: '–¢–µ–º–∞' },
      { name: '–†–µ–∑—É–ª—å—Ç–∞—Ç', type: 'textarea', placeholder: '–ò—Ç–æ–≥, –¥–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç–∏...' },
      { name: '–°–ª–µ–¥—É—é—â–∏–π_—à–∞–≥', type: 'text', placeholder: '–ß—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ' },
      { name: '–î–∞—Ç–∞_—Å–ª–µ–¥—É—é—â–µ–≥–æ', type: 'date' }
    ]
  },
  site: {
    title: '–°–∞–π—Ç (–ø–æ–¥–ø—Ä–æ–µ–∫—Ç)', sheet: null, // handled locally
    fields: [
      { name: '–ù–∞–∑–≤–∞–Ω–∏–µ', type: 'text', required: true, placeholder: '–ù–∞–∑–≤–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å–∞' },
      { name: '–°—Å—ã–ª–∫–∞', type: 'text', placeholder: 'https://...' },
      { name: '–ö–ª–∏–µ–Ω—Ç', type: 'text', placeholder: '–ò–º—è –∑–∞–∫–∞–∑—á–∏–∫–∞' },
      { name: '–¢–µ–ª–µ—Ñ–æ–Ω', type: 'text', placeholder: '+7...' },
      { name: '–û–ø–∏—Å–∞–Ω–∏–µ', type: 'textarea', placeholder: '–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞...' }
    ]
  }
};

// ============================================================
// HELPERS
// ============================================================
function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function escA(s) { return String(s||'').replace(/'/g,"\\'").replace(/"/g,'&quot;'); }
function emptyRow(c,m) { return '<tr><td colspan="'+c+'" class="empty"><div class="icon">üì≠</div><p>'+m+'</p></td></tr>'; }

function statusBadge(s) {
  if (!s) return '';
  let c = 's-active';
  if (s==='–ê–∫—Ç–∏–≤–Ω—ã–π'||s.includes('–ì–æ—Ç–æ–≤–æ')) c='s-done';
  else if (s==='–ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã') c='s-talks';
  else if (s==='Research'||s.includes('–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ')) c='s-research';
  else if (s==='–ü–∞—É–∑–∞') c='s-pause';
  else if (s.includes('—Ä–∞–±–æ—Ç–µ')||s.includes('–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞')||s.includes('–ø—Ä–æ–≤–µ—Ä–∫–µ')) c='s-work';
  else if (s.includes('–û–∂–∏–¥–∞–µ—Ç')||s.includes('–æ—á–µ—Ä–µ–¥–∏')) c='s-urgent';
  else if (s.includes('–û–¥–æ–±—Ä–µ–Ω–æ')) c='s-done';
  else if (s.includes('–û—Ç–∫–ª–æ–Ω–µ–Ω–æ')) c='s-urgent';
  return '<span class="status '+c+'">'+esc(s)+'</span>';
}

function prBadge(p) {
  if (!p) return '';
  return '<span class="'+(p==='P1'?'p1':p==='P2'?'p2':'p3')+'">'+esc(p)+'</span>';
}

function progBar(v) {
  v = parseInt(v)||0;
  const c = v>=80?'var(--green)':v>=50?'var(--accent)':v>=25?'var(--orange)':'var(--red)';
  return '<div class="progress-wrap"><div class="progress-bar"><div class="progress-fill" style="width:'+v+'%;background:'+c+'"></div></div><span class="progress-text">'+v+'%</span></div>';
}

function actBtns(type, id, name) {
  const p = getUserPerms();
  let h = '<div class="actions-cell">';
  h += '<button class="act-btn view" onclick="viewItem(\''+type+'\',\''+escA(id)+'\')" title="–ü—Ä–æ—Å–º–æ—Ç—Ä">üëÅ</button>';
  if (type === 'task') {
    h += '<button class="act-btn ai" onclick="openTaskDetail(\''+escA(id)+'\')" title="–û—Ç–∫—Ä—ã—Ç—å —Å –ò–ò">ü§ñ</button>';
  }
  h += '<button class="act-btn" onclick="editItem(\''+type+'\',\''+escA(id)+'\')" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>';
  if (p.canDelete) h += '<button class="act-btn del" onclick="confirmDelete(\''+type+'\',\''+escA(id)+'\',\''+escA(name)+'\')" title="–£–¥–∞–ª–∏—Ç—å">üóë</button>';
  h += '</div>';
  return h;
}

function toast(m,t) {
  const e = document.getElementById('toast');
  e.textContent = m;
  e.className = 'toast toast-'+(t||'success')+' show';
  setTimeout(()=>e.classList.remove('show'), 3000);
}

function setStatus(s) {
  const d=document.getElementById('statusDot'), t=document.getElementById('statusText');
  if (s==='connected') { d.className='dot dot-green'; t.textContent='–ü–æ–¥–∫–ª—é—á–µ–Ω–æ ‚Ä¢ '+new Date().toLocaleTimeString('ru',{hour:'2-digit',minute:'2-digit'}); }
  else if (s==='loading') { d.className='dot dot-green'; t.textContent='–ó–∞–≥—Ä—É–∑–∫–∞...'; }
  else { d.className='dot dot-red'; t.textContent='–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è'; }
}

function updateStatusTime() {
  const e=document.getElementById('statusTime');
  if(e) e.textContent=new Date().toLocaleString('ru',{day:'2-digit',month:'long',year:'numeric',hour:'2-digit',minute:'2-digit'});
}

function today() { return new Date().toISOString().split('T')[0]; }

// ============================================================
// AUTHENTICATION
// ============================================================
function checkSavedLogin() {
  const s = localStorage.getItem('rkt_user');
  if (s) { try { USER=JSON.parse(s); if(USER&&USER.tgId){showApp();return;} } catch(e){} localStorage.removeItem('rkt_user'); }
}

async function doLogin() {
  const tgId = document.getElementById('loginTgId').value.trim();
  if (!tgId) { showLoginErr('–í–≤–µ–¥–∏—Ç–µ Telegram ID'); return; }
  if (!/^\d+$/.test(tgId)) { showLoginErr('–¢–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã'); return; }

  document.getElementById('loginBtn').disabled = true;
  document.getElementById('loginBtnText').textContent = '–ü–æ–¥–∫–ª—é—á–∞—é—Å—å...';
  document.getElementById('loginError').style.display = 'none';

  try {
    const r = await fetch(CONFIG.API_URL);
    if (!r.ok) throw new Error('HTTP '+r.status);
    DATA = normData(await r.json());

    const staff = DATA.staff.find(s => String(s.Telegram_ID).trim() === String(tgId).trim());
    if (!staff) { showLoginErr('‚õî ID ¬´'+tgId+'¬ª –Ω–µ –Ω–∞–π–¥–µ–Ω. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.'); resetLogin(); return; }

    USER = {
      id: staff.ID||'', tgId: String(staff.Telegram_ID).trim(),
      name: staff['–ò–º—è']||'–°–æ—Ç—Ä—É–¥–Ω–∏–∫', role: staff['–†–æ–ª—å']||'–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å',
      direction: staff['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'–í—Å–µ', email: staff['Email']||'',
      phone: staff['–¢–µ–ª–µ—Ñ–æ–Ω']||'', username: staff['Username']||''
    };
    localStorage.setItem('rkt_user', JSON.stringify(USER));
    showApp();
  } catch(e) {
    console.error(e);
    showLoginErr('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.');
    resetLogin();
  }
}

function showLoginErr(m) { const e=document.getElementById('loginError'); e.textContent=m; e.style.display='block'; }
function resetLogin() { document.getElementById('loginBtn').disabled=false; document.getElementById('loginBtnText').textContent='–í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É'; }

function doLogout() {
  USER=null; localStorage.removeItem('rkt_user');
  if(refreshTimer) clearInterval(refreshTimer);
  document.getElementById('mainApp').style.display='none';
  document.getElementById('loginScreen').style.display='flex';
  document.getElementById('loginTgId').value='';
  resetLogin(); document.getElementById('loginError').style.display='none';
}

function showApp() {
  document.getElementById('loginScreen').style.display='none';
  document.getElementById('mainApp').style.display='flex';
  const p = getUserPerms();
  document.getElementById('userName').textContent = USER.name;
  document.getElementById('userRoleText').textContent = p.emoji+' '+USER.role;
  document.getElementById('userAvatar').textContent = USER.name.charAt(0).toUpperCase();
  document.getElementById('settingsApiUrl').value = CONFIG.API_URL;
  document.getElementById('s-name').textContent = USER.name;
  document.getElementById('s-role').textContent = p.emoji+' '+USER.role;
  document.getElementById('s-dir').textContent = USER.direction;
  document.getElementById('s-tgid').textContent = USER.tgId;
  document.getElementById('btn-add-staff').style.display = p.canManageStaff?'':'none';
  document.getElementById('nav-approvals').classList.toggle('hidden', !p.canApprove);
  loadData();
  if(refreshTimer) clearInterval(refreshTimer);
  refreshTimer = setInterval(loadData, CONFIG.REFRESH);
  updateStatusTime(); setInterval(updateStatusTime, 60000);
}

// ============================================================
// DATA
// ============================================================
function normData(d) {
  return {
    partners: Array.isArray(d.partners)?d.partners:[],
    tasks: Array.isArray(d.tasks)?d.tasks:[],
    directions: Array.isArray(d.directions)?d.directions:[],
    staff: Array.isArray(d.staff)?d.staff:[],
    projects: Array.isArray(d.projects)?d.projects:[],
    approvals: Array.isArray(d.approvals)?d.approvals:[],
    comms: Array.isArray(d.comms)?d.comms:[]
  };
}

async function loadData() {
  setStatus('loading');
  try {
    const r = await fetch(CONFIG.API_URL);
    if(!r.ok) throw new Error('HTTP '+r.status);
    DATA = normData(await r.json());
    renderAll();
    setStatus('connected');
    toast('‚úÖ –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã','success');
  } catch(e) {
    console.error(e);
    setStatus('error');
    toast('‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏','error');
  }
}

async function apiWrite(sheet, row) {
  try {
    // POST body (for updated API)
    const r = await fetch(CONFIG.WRITE_URL, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ sheet, data: row })
    });
    if(!r.ok) throw new Error('POST HTTP '+r.status);
    return true;
  } catch(e) {
    // Fallback: GET with base64 (legacy)
    try {
      const b64 = btoa(unescape(encodeURIComponent(JSON.stringify({sheet,row}))));
      const r2 = await fetch(CONFIG.WRITE_URL+'?b64='+b64);
      if(!r2.ok) throw new Error('GET HTTP '+r2.status);
      return true;
    } catch(e2) { toast('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏: '+e2.message,'error'); return false; }
  }
}

// ============================================================
// FILTERING
// ============================================================
function filterByRole(arr) {
  const p = getUserPerms();
  if (p.seeAll || !USER || USER.direction==='–í—Å–µ') return arr;
  return arr.filter(i => { const d=i['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||''; return d===USER.direction||d==='–í—Å–µ'||d==='–û–±—â–µ–µ'||d===''; });
}

function filterBySearch(arr, sid, fields) {
  const e = document.getElementById(sid);
  if(!e) return arr;
  const q = e.value.toLowerCase().trim();
  if(!q) return arr;
  return arr.filter(i => fields.some(f => (i[f]||'').toLowerCase().includes(q)));
}

function filterByDir(arr, dir) {
  if(!dir||dir==='–í—Å–µ') return arr;
  return arr.filter(i => (i['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'').includes(dir));
}

// Which top-level project does a direction belong to?
function dirToProject(dir) {
  for (const [key, proj] of Object.entries(PROJECTS)) {
    if (proj.subprojects[dir]) return key;
  }
  return null;
}

// Get all direction names for a top-level project
function getProjectDirs(projKey) {
  const p = PROJECTS[projKey];
  return p ? Object.keys(p.subprojects) : [];
}

// Filter data by top-level project (all its subproject directions)
function filterByProject(arr, projKey) {
  const dirs = getProjectDirs(projKey);
  return arr.filter(i => dirs.includes(i['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||''));
}

// ============================================================
// NAVIGATION
// ============================================================
function showPage(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  const pe = document.getElementById('page-'+page);
  const ne = document.querySelector('[data-page="'+page+'"]');
  if(pe) pe.classList.add('active');
  if(ne) ne.classList.add('active');
  document.getElementById('sidebar').classList.remove('open');
  if(page==='home') { currentProject=null; currentSubproject=null; }
}

function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }

function openProject(projKey) {
  currentProject = projKey;
  currentSubproject = null;
  currentPvTab = 'overview';
  showPage('project');
  renderProjectView();
}

function openSubproject(spName) {
  currentSubproject = spName;
  currentSpTab = 'overview';
  showPage('subproject');
  renderSubprojectView();
}

function showPvTab(tab) {
  currentPvTab = tab;
  document.querySelectorAll('#pv-tabs .tab').forEach(t => t.classList.toggle('active', t.getAttribute('data-tab')===tab));
  renderProjectView();
}

function showSpTab(tab) {
  currentSpTab = tab;
  document.querySelectorAll('#sp-tabs .tab').forEach(t => t.classList.toggle('active', t.getAttribute('data-tab')===tab));
  renderSubprojectView();
}

// ============================================================
// RENDER: MASTER
// ============================================================
function renderAll() {
  renderHome();
  renderDashboard();
  renderPartnerFilters();
  renderPartners();
  renderTaskFilters();
  renderTasks();
  renderStaff();
  renderApprovals();
  renderComms();
  renderSettings();
  updateBadges();
  if(currentProject && !currentSubproject) renderProjectView();
  if(currentSubproject) renderSubprojectView();
}

function updateBadges() {
  const fp = filterByRole(DATA.partners);
  const ft = filterByRole(DATA.tasks).filter(t => (t['–°—Ç–∞—Ç—É—Å']||'')!=='–ì–æ—Ç–æ–≤–æ');
  const pa = DATA.approvals.filter(a => (a['–°—Ç–∞—Ç—É—Å']||'').includes('–û–∂–∏–¥–∞–µ—Ç'));
  document.getElementById('badge-partners').textContent = fp.length;
  document.getElementById('badge-tasks').textContent = ft.length;
  document.getElementById('badge-approvals').textContent = pa.length;
}

// ============================================================
// RENDER: HOME ‚Äî TOP-LEVEL PROJECT CARDS
// ============================================================
function renderHome() {
  const allPartners = filterByRole(DATA.partners);
  const allTasks = filterByRole(DATA.tasks);
  const allProjects = filterByRole(DATA.projects);
  const td = today();
  const overdue = allTasks.filter(t => t['–î–µ–¥–ª–∞–π–Ω'] && t['–î–µ–¥–ª–∞–π–Ω']<td && (t['–°—Ç–∞—Ç—É—Å']||'')!=='–ì–æ—Ç–æ–≤–æ');
  const active = allTasks.filter(t => (t['–°—Ç–∞—Ç—É—Å']||'')!=='–ì–æ—Ç–æ–≤–æ');

  // Total metrics across all projects
  document.getElementById('home-metrics').innerHTML =
    '<div class="metric-card"><div class="m-icon">ü§ù</div><div class="m-value">'+allPartners.length+'</div><div class="m-label">–ü–∞—Ä—Ç–Ω—ë—Ä–æ–≤</div></div>'+
    '<div class="metric-card"><div class="m-icon">üìÅ</div><div class="m-value">'+allProjects.length+'</div><div class="m-label">–ü—Ä–æ–µ–∫—Ç–æ–≤</div></div>'+
    '<div class="metric-card"><div class="m-icon">‚úÖ</div><div class="m-value">'+active.length+'</div><div class="m-label">–ó–∞–¥–∞—á</div></div>'+
    '<div class="metric-card"><div class="m-icon">üî¥</div><div class="m-value" style="color:'+(overdue.length?'var(--red)':'var(--green)')+'">'+overdue.length+'</div><div class="m-label">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</div></div>'+
    '<div class="metric-card"><div class="m-icon">üë•</div><div class="m-value">'+DATA.staff.length+'</div><div class="m-label">–ö–æ–º–∞–Ω–¥–∞</div></div>';

  // Project cards
  let html = '';
  for (const [key, proj] of Object.entries(PROJECTS)) {
    const dirs = getProjectDirs(key);
    const pp = allPartners.filter(p => dirs.includes(p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||''));
    const pt = allTasks.filter(t => dirs.includes(t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||''));
    const ptActive = pt.filter(t => (t['–°—Ç–∞—Ç—É—Å']||'')!=='–ì–æ—Ç–æ–≤–æ');
    const ptOverdue = ptActive.filter(t => t['–î–µ–¥–ª–∞–π–Ω'] && t['–î–µ–¥–ª–∞–π–Ω']<td);
    const ppr = allProjects.filter(p => dirs.includes(p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||''));
    const avgPr = ppr.length ? Math.round(ppr.reduce((s,p) => s+(parseInt(p['–ü—Ä–æ–≥—Ä–µ—Å—Å'])||0),0)/ppr.length) : 0;

    let stTag = '';
    if (ptOverdue.length) stTag = '<span class="status-tag" style="background:var(--red-glow);color:var(--red)">üî¥ '+ptOverdue.length+' –ø—Ä–æ—Å—Ä–æ—á.</span>';
    else if (ptActive.length) stTag = '<span class="status-tag" style="background:var(--accent-glow);color:var(--accent)">–í —Ä–∞–±–æ—Ç–µ</span>';
    else stTag = '<span class="status-tag" style="background:rgba(136,153,170,0.15);color:var(--text2)">–°—Ç–∞—Ä—Ç</span>';

    html += '<div class="project-card" onclick="openProject(\''+key+'\')">';
    html += '<div class="project-card-top" style="background:'+proj.gradient+'"></div>';
    html += stTag;
    html += '<div class="project-card-header">';
    html += '<span class="emoji">'+proj.emoji+'</span>';
    html += '<h3>'+esc(proj.name)+'</h3>';
    html += '<div class="desc">'+esc(proj.desc)+'</div>';
    html += '</div>';
    html += '<div class="project-card-stats">';
    html += '<div class="pcs"><div class="v" style="color:'+proj.color+'">'+Object.keys(proj.subprojects).length+'</div><div class="l">–ü–æ–¥–ø—Ä–æ–µ–∫—Ç–æ–≤</div></div>';
    html += '<div class="pcs"><div class="v" style="color:'+proj.color+'">'+pp.length+'</div><div class="l">–ü–∞—Ä—Ç–Ω—ë—Ä–æ–≤</div></div>';
    html += '<div class="pcs"><div class="v" style="color:'+proj.color+'">'+ptActive.length+'</div><div class="l">–ó–∞–¥–∞—á</div></div>';
    html += '</div>';
    html += '<div class="project-card-progress">';
    html += '<div class="bar"><div class="fill" style="width:'+avgPr+'%;background:'+proj.color+'"></div></div>';
    html += '<div class="info"><span>–ü—Ä–æ–≥—Ä–µ—Å—Å</span><span>'+avgPr+'%</span></div>';
    html += '</div></div>';
  }

  // Add project card
  html += '<div class="project-card add-card" onclick="openModal(\'newproject\')">';
  html += '<span class="add-icon">‚ûï</span>';
  html += '<span class="add-text">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</span>';
  html += '</div>';

  document.getElementById('project-grid').innerHTML = html;
}

// ============================================================
// RENDER: PROJECT VIEW (subprojects)
// ============================================================
function renderProjectView() {
  if(!currentProject) return;
  const proj = PROJECTS[currentProject];
  if(!proj) return;
  const td = today();

  document.getElementById('pv-name').textContent = proj.name;
  document.getElementById('pv-title').innerHTML = proj.emoji + ' ' + esc(proj.name);
  document.getElementById('btn-add-sub').style.display = proj.canAddSub ? '' : 'none';

  const dirs = getProjectDirs(currentProject);
  const pp = filterByRole(DATA.partners).filter(p => dirs.includes(p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||''));
  const pt = filterByRole(DATA.tasks).filter(t => dirs.includes(t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||''));
  const ppr = filterByRole(DATA.projects).filter(p => dirs.includes(p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||''));
  const ptActive = pt.filter(t => (t['–°—Ç–∞—Ç—É—Å']||'')!=='–ì–æ—Ç–æ–≤–æ');
  const ptOverdue = ptActive.filter(t => t['–î–µ–¥–ª–∞–π–Ω'] && t['–î–µ–¥–ª–∞–π–Ω']<td);
  const avgPr = ppr.length ? Math.round(ppr.reduce((s,p) => s+(parseInt(p['–ü—Ä–æ–≥—Ä–µ—Å—Å'])||0),0)/ppr.length) : 0;

  // Metrics
  document.getElementById('pv-metrics').innerHTML =
    '<div class="metric-card"><div class="m-icon">üìÇ</div><div class="m-value">'+Object.keys(proj.subprojects).length+'</div><div class="m-label">–ü–æ–¥–ø—Ä–æ–µ–∫—Ç–æ–≤</div></div>'+
    '<div class="metric-card"><div class="m-icon">ü§ù</div><div class="m-value">'+pp.length+'</div><div class="m-label">–ü–∞—Ä—Ç–Ω—ë—Ä–æ–≤</div></div>'+
    '<div class="metric-card"><div class="m-icon">‚úÖ</div><div class="m-value">'+ptActive.length+'</div><div class="m-label">–ó–∞–¥–∞—á</div><div class="m-sub">'+(ptOverdue.length?'üî¥ '+ptOverdue.length+' –ø—Ä–æ—Å—Ä–æ—á.':'–≤ —Ä–∞–±–æ—Ç–µ')+'</div></div>'+
    '<div class="metric-card"><div class="m-icon">üìà</div><div class="m-value">'+avgPr+'%</div><div class="m-label">–ü—Ä–æ–≥—Ä–µ—Å—Å</div></div>'+
    '<div class="metric-card"><div class="m-icon">üìÅ</div><div class="m-value">'+ppr.length+'</div><div class="m-label">–ü—Ä–æ–µ–∫—Ç–æ–≤</div></div>';

  // Subproject cards grid
  let sgHtml = '';
  for (const [spName, spMeta] of Object.entries(proj.subprojects)) {
    const spp = pp.filter(p => (p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'')===spName);
    const spt = ptActive.filter(t => (t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'')===spName);
    const spOverdue = spt.filter(t => t['–î–µ–¥–ª–∞–π–Ω'] && t['–î–µ–¥–ª–∞–π–Ω']<td);

    sgHtml += '<div class="subproject-card" onclick="openSubproject(\''+escA(spName)+'\')">';
    sgHtml += '<div style="position:absolute;top:0;left:0;right:0;height:3px;background:'+spMeta.color+'"></div>';
    sgHtml += '<span class="sp-emoji">'+spMeta.emoji+'</span>';
    sgHtml += '<h4>'+esc(spName)+'</h4>';
    sgHtml += '<div class="sp-desc">'+esc(spMeta.desc)+'</div>';
    sgHtml += '<div class="sp-stats">';
    sgHtml += '<span>ü§ù '+spp.length+'</span>';
    sgHtml += '<span>‚úÖ '+spt.length+'</span>';
    if (spOverdue.length) sgHtml += '<span style="color:var(--red)">üî¥ '+spOverdue.length+'</span>';
    sgHtml += '</div></div>';
  }

  // Add subproject card (only for sites etc.)
  if (proj.canAddSub) {
    sgHtml += '<div class="subproject-card add-sub" onclick="openAddSubproject()">';
    sgHtml += '<span class="add-icon" style="font-size:32px;opacity:0.4">‚ûï</span>';
    sgHtml += '<span style="font-size:12px;color:var(--text2)">–î–æ–±–∞–≤–∏—Ç—å</span>';
    sgHtml += '</div>';
  }

  document.getElementById('subproject-grid').innerHTML = sgHtml;

  // Tab content
  const content = document.getElementById('pv-content');
  let html = '';

  if (currentPvTab === 'overview') {
    // Overdue
    if (ptOverdue.length) {
      html += '<div class="card" style="border-color:rgba(255,107,107,0.4)"><div class="card-header" style="background:rgba(255,107,107,0.05)"><h3>üî¥ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ ('+ptOverdue.length+')</h3></div>';
      html += '<div class="table-wrap"><table><thead><tr><th>–ó–∞–¥–∞—á–∞</th><th>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</th><th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th><th>–î–µ–¥–ª–∞–π–Ω</th><th></th></tr></thead><tbody>';
      html += ptOverdue.map(t => '<tr style="background:rgba(255,107,107,0.03)"><td>'+esc(t['–û–ø–∏—Å–∞–Ω–∏–µ']||t['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</td><td>'+esc(t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'])+'</td><td>'+prBadge(t['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç'])+'</td><td style="color:var(--red);font-weight:700">'+esc(t['–î–µ–¥–ª–∞–π–Ω'])+'</td><td>'+actBtns('task',t.ID,t['–û–ø–∏—Å–∞–Ω–∏–µ'])+'</td></tr>').join('');
      html += '</tbody></table></div></div>';
    }
    // Active projects
    if (ppr.length) {
      html += '<div class="card"><div class="card-header"><h3>üìÅ –ü—Ä–æ–µ–∫—Ç—ã ('+ppr.length+')</h3></div>';
      html += '<div class="table-wrap"><table><thead><tr><th>–ü—Ä–æ–µ–∫—Ç</th><th>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ü—Ä–æ–≥—Ä–µ—Å—Å</th><th>–î–µ–¥–ª–∞–π–Ω</th></tr></thead><tbody>';
      html += ppr.map(p => '<tr><td><strong>'+esc(p['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</strong></td><td>'+esc(p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'])+'</td><td>'+statusBadge(p['–°—Ç–∞—Ç—É—Å'])+'</td><td>'+progBar(p['–ü—Ä–æ–≥—Ä–µ—Å—Å'])+'</td><td>'+esc(p['–î–µ–¥–ª–∞–π–Ω']||'‚Äî')+'</td></tr>').join('');
      html += '</tbody></table></div></div>';
    }
    // Recent tasks
    const pOrder = {P1:1,P2:2,P3:3};
    const topT = [...ptActive].sort((a,b) => (pOrder[a['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']]||9)-(pOrder[b['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']]||9)).slice(0,10);
    html += '<div class="card"><div class="card-header"><h3>‚úÖ –ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏</h3></div>';
    html += '<div class="table-wrap"><table><thead><tr><th>–ó–∞–¥–∞—á–∞</th><th>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</th><th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–µ–¥–ª–∞–π–Ω</th><th></th></tr></thead><tbody>';
    html += topT.length ? topT.map(t => {
      const od = t['–î–µ–¥–ª–∞–π–Ω']&&t['–î–µ–¥–ª–∞–π–Ω']<td;
      return '<tr style="'+(od?'background:rgba(255,107,107,0.03)':'')+'"><td>'+(od?'üî¥ ':'')+esc(t['–û–ø–∏—Å–∞–Ω–∏–µ']||t['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</td><td>'+esc(t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'])+'</td><td>'+prBadge(t['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç'])+'</td><td>'+statusBadge(t['–°—Ç–∞—Ç—É—Å'])+'</td><td>'+esc(t['–î–µ–¥–ª–∞–π–Ω']||'‚Äî')+'</td><td>'+actBtns('task',t.ID,t['–û–ø–∏—Å–∞–Ω–∏–µ'])+'</td></tr>';
    }).join('') : emptyRow(6,'–ù–µ—Ç –∑–∞–¥–∞—á');
    html += '</tbody></table></div></div>';

  } else if (currentPvTab === 'tasks') {
    html += renderTaskTable(pt);
  } else if (currentPvTab === 'partners') {
    html += renderPartnerTable(pp);
  } else if (currentPvTab === 'comms') {
    const pNames = pp.map(p => p['–ù–∞–∑–≤–∞–Ω–∏–µ']).filter(Boolean);
    const dc = (DATA.comms||[]).filter(c => pNames.some(n => (c['–ü–∞—Ä—Ç–Ω—ë—Ä']||'').includes(n)));
    html += renderCommTable(dc);
  }

  content.innerHTML = html;
}

// ============================================================
// RENDER: SUBPROJECT VIEW (workspace inside e.g. –ö–¢ or –ü—ã—à–∫–∏)
// ============================================================
function renderSubprojectView() {
  if (!currentSubproject||!currentProject) return;
  const proj = PROJECTS[currentProject];
  const spMeta = proj?.subprojects[currentSubproject] || { emoji:'üìå', color:'var(--text2)', desc:'' };
  const td = today();

  document.getElementById('sp-parent').textContent = proj.name;
  document.getElementById('sp-parent').setAttribute('onclick', "openProject('"+currentProject+"')");
  document.getElementById('sp-name').textContent = currentSubproject;
  document.getElementById('sp-title').innerHTML = spMeta.emoji + ' ' + esc(currentSubproject);

  const sp = filterByRole(DATA.partners).filter(p => (p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'')===currentSubproject);
  const st = filterByRole(DATA.tasks).filter(t => (t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'')===currentSubproject);
  const spr = filterByRole(DATA.projects).filter(p => (p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'')===currentSubproject);
  const stActive = st.filter(t => (t['–°—Ç–∞—Ç—É—Å']||'')!=='–ì–æ—Ç–æ–≤–æ');
  const stDone = st.filter(t => (t['–°—Ç–∞—Ç—É—Å']||'')==='–ì–æ—Ç–æ–≤–æ');
  const stOverdue = stActive.filter(t => t['–î–µ–¥–ª–∞–π–Ω']&&t['–î–µ–¥–ª–∞–π–Ω']<td);
  const avgPr = spr.length ? Math.round(spr.reduce((s,p) => s+(parseInt(p['–ü—Ä–æ–≥—Ä–µ—Å—Å'])||0),0)/spr.length) : 0;
  const pNames = sp.map(p => p['–ù–∞–∑–≤–∞–Ω–∏–µ']).filter(Boolean);
  const sc = (DATA.comms||[]).filter(c => pNames.some(n => (c['–ü–∞—Ä—Ç–Ω—ë—Ä']||'').includes(n)));

  document.getElementById('sp-metrics').innerHTML =
    '<div class="metric-card"><div class="m-icon">ü§ù</div><div class="m-value">'+sp.length+'</div><div class="m-label">–ü–∞—Ä—Ç–Ω—ë—Ä–æ–≤</div></div>'+
    '<div class="metric-card"><div class="m-icon">‚úÖ</div><div class="m-value">'+stActive.length+'</div><div class="m-label">–ó–∞–¥–∞—á</div><div class="m-sub">'+stDone.length+' –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</div></div>'+
    '<div class="metric-card"><div class="m-icon">üî¥</div><div class="m-value" style="color:'+(stOverdue.length?'var(--red)':'var(--green)')+'">'+stOverdue.length+'</div><div class="m-label">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</div></div>'+
    '<div class="metric-card"><div class="m-icon">üìÅ</div><div class="m-value">'+spr.length+'</div><div class="m-label">–ü—Ä–æ–µ–∫—Ç–æ–≤</div><div class="m-sub">'+avgPr+'% –ø—Ä–æ–≥—Ä–µ—Å—Å</div></div>'+
    '<div class="metric-card"><div class="m-icon">üí¨</div><div class="m-value">'+sc.length+'</div><div class="m-label">–ö–æ–Ω—Ç–∞–∫—Ç–æ–≤</div></div>';

  const content = document.getElementById('sp-content');
  let html = '';

  if (currentSpTab==='overview') {
    if (stOverdue.length) {
      html += '<div class="card" style="border-color:rgba(255,107,107,0.4)"><div class="card-header" style="background:rgba(255,107,107,0.05)"><h3>üî¥ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ ('+stOverdue.length+')</h3></div>';
      html += '<div class="table-wrap"><table><thead><tr><th>–ó–∞–¥–∞—á–∞</th><th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th><th>–î–µ–¥–ª–∞–π–Ω</th><th>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th><th></th></tr></thead><tbody>';
      html += stOverdue.map(t => '<tr style="background:rgba(255,107,107,0.03)"><td>'+esc(t['–û–ø–∏—Å–∞–Ω–∏–µ']||t['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</td><td>'+prBadge(t['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç'])+'</td><td style="color:var(--red);font-weight:700">'+esc(t['–î–µ–¥–ª–∞–π–Ω'])+'</td><td>'+esc(t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'‚Äî')+'</td><td>'+actBtns('task',t.ID,t['–û–ø–∏—Å–∞–Ω–∏–µ'])+'</td></tr>').join('');
      html += '</tbody></table></div></div>';
    }
    if (spr.length) {
      html += '<div class="card"><div class="card-header"><h3>üìÅ –ü—Ä–æ–µ–∫—Ç—ã</h3></div><div class="table-wrap"><table><thead><tr><th>–ü—Ä–æ–µ–∫—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ü—Ä–æ–≥—Ä–µ—Å—Å</th><th>–ü–∞—Ä—Ç–Ω—ë—Ä</th><th>–î–µ–¥–ª–∞–π–Ω</th></tr></thead><tbody>';
      html += spr.map(p => '<tr><td><strong>'+esc(p['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</strong></td><td>'+statusBadge(p['–°—Ç–∞—Ç—É—Å'])+'</td><td>'+progBar(p['–ü—Ä–æ–≥—Ä–µ—Å—Å'])+'</td><td>'+esc(p['–ü–∞—Ä—Ç–Ω—ë—Ä']||'')+'</td><td>'+esc(p['–î–µ–¥–ª–∞–π–Ω']||'‚Äî')+'</td></tr>').join('');
      html += '</tbody></table></div></div>';
    }
    const pO = {P1:1,P2:2,P3:3};
    const topT = [...stActive].sort((a,b)=>(pO[a['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']]||9)-(pO[b['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']]||9)).slice(0,10);
    html += '<div class="card"><div class="card-header"><h3>‚úÖ –ó–∞–¥–∞—á–∏ ('+stActive.length+')</h3></div><div class="table-wrap"><table><thead><tr><th>–ó–∞–¥–∞—á–∞</th><th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th><th>–î–µ–¥–ª–∞–π–Ω</th><th></th></tr></thead><tbody>';
    html += topT.length ? topT.map(t => {
      const od = t['–î–µ–¥–ª–∞–π–Ω']&&t['–î–µ–¥–ª–∞–π–Ω']<td&&(t['–°—Ç–∞—Ç—É—Å']||'')!=='–ì–æ—Ç–æ–≤–æ';
      return '<tr style="'+(od?'background:rgba(255,107,107,0.03)':'')+'"><td>'+(od?'üî¥ ':'')+esc(t['–û–ø–∏—Å–∞–Ω–∏–µ']||t['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</td><td>'+prBadge(t['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç'])+'</td><td>'+statusBadge(t['–°—Ç–∞—Ç—É—Å'])+'</td><td>'+esc(t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'‚Äî')+'</td><td>'+esc(t['–î–µ–¥–ª–∞–π–Ω']||'‚Äî')+'</td><td>'+actBtns('task',t.ID,t['–û–ø–∏—Å–∞–Ω–∏–µ'])+'</td></tr>';
    }).join('') : emptyRow(6,'–ù–µ—Ç –∑–∞–¥–∞—á'); 
    html += '</tbody></table></div></div>';
    if(sp.length) {
      html += '<div class="card"><div class="card-header"><h3>ü§ù –ü–∞—Ä—Ç–Ω—ë—Ä—ã ('+sp.length+')</h3></div><div class="table-wrap"><table><thead><tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–°—Ç—Ä–∞–Ω–∞</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ü—Ä–æ–¥—É–∫—Ç</th><th>–ö–æ–Ω—Ç–∞–∫—Ç</th></tr></thead><tbody>';
      html += sp.map(p => '<tr><td><strong>'+esc(p['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</strong></td><td>'+esc(p['–°—Ç—Ä–∞–Ω–∞'])+'</td><td>'+statusBadge(p['–°—Ç–∞—Ç—É—Å'])+'</td><td>'+esc(p['–ü—Ä–æ–¥—É–∫—Ç']||'')+'</td><td>'+esc(p['–ö–æ–Ω—Ç–∞–∫—Ç']||'')+'</td></tr>').join('');
      html += '</tbody></table></div></div>';
    }
    if(!html) html = '<div class="empty"><div class="icon">üöÄ</div><p>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ¬´'+esc(currentSubproject)+'¬ª –ø–æ–∫–∞ –ø—É—Å—Ç–æ–µ.</p></div>';

  } else if (currentSpTab==='tasks') { html += renderTaskTable(st);
  } else if (currentSpTab==='partners') { html += renderPartnerTable(sp);
  } else if (currentSpTab==='projects') {
    html += '<div class="card"><div class="table-wrap"><table><thead><tr><th>–ü—Ä–æ–µ–∫—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th><th>–ü—Ä–æ–≥—Ä–µ—Å—Å</th><th>–ü–∞—Ä—Ç–Ω—ë—Ä</th><th>–ë—é–¥–∂–µ—Ç</th><th>–î–µ–¥–ª–∞–π–Ω</th><th></th></tr></thead><tbody>';
    html += spr.length ? spr.map(p => '<tr><td><strong>'+esc(p['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</strong></td><td>'+statusBadge(p['–°—Ç–∞—Ç—É—Å'])+'</td><td>'+prBadge(p['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç'])+'</td><td>'+progBar(p['–ü—Ä–æ–≥—Ä–µ—Å—Å'])+'</td><td>'+esc(p['–ü–∞—Ä—Ç–Ω—ë—Ä']||'')+'</td><td>'+esc(p['–ë—é–¥–∂–µ—Ç']||'‚Äî')+'</td><td>'+esc(p['–î–µ–¥–ª–∞–π–Ω']||'‚Äî')+'</td><td>'+actBtns('project',p.ID,p['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</td></tr>').join('') : emptyRow(8,'–ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤');
    html += '</tbody></table></div></div>';
  } else if (currentSpTab==='comms') { html += renderCommTable(sc); }

  content.innerHTML = html;
}

// Reusable table renderers
function renderTaskTable(data) {
  const pO = {P1:1,P2:2,P3:3};
  const sorted = [...data].sort((a,b)=>(pO[a['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']]||9)-(pO[b['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']]||9));
  const td = today();
  let h = '<div class="card"><div class="table-wrap"><table><thead><tr><th>–ó–∞–¥–∞—á–∞</th><th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th><th>–ü—Ä–æ–µ–∫—Ç</th><th>–î–µ–¥–ª–∞–π–Ω</th><th></th></tr></thead><tbody>';
  h += sorted.length ? sorted.map(t => {
    const od = t['–î–µ–¥–ª–∞–π–Ω']&&t['–î–µ–¥–ª–∞–π–Ω']<td&&(t['–°—Ç–∞—Ç—É—Å']||'')!=='–ì–æ—Ç–æ–≤–æ';
    return '<tr style="'+(od?'background:rgba(255,107,107,0.05)':'')+'"><td>'+(od?'üî¥ ':'')+esc(t['–û–ø–∏—Å–∞–Ω–∏–µ']||t['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</td><td>'+prBadge(t['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç'])+'</td><td>'+statusBadge(t['–°—Ç–∞—Ç—É—Å'])+'</td><td>'+esc(t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'‚Äî')+'</td><td>'+esc(t['–ü—Ä–æ–µ–∫—Ç']||'‚Äî')+'</td><td>'+(od?'<span style="color:var(--red);font-weight:700">':'')+esc(t['–î–µ–¥–ª–∞–π–Ω']||'‚Äî')+(od?'</span>':'')+'</td><td>'+actBtns('task',t.ID,t['–û–ø–∏—Å–∞–Ω–∏–µ']||t['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</td></tr>';
  }).join('') : emptyRow(7,'–ù–µ—Ç –∑–∞–¥–∞—á');
  h += '</tbody></table></div></div>';
  return h;
}

function renderPartnerTable(data) {
  let h = '<div class="card"><div class="table-wrap"><table><thead><tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–°—Ç—Ä–∞–Ω–∞</th><th>–ü—Ä–æ–¥—É–∫—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ö–æ–Ω—Ç–∞–∫—Ç</th><th>Email</th><th></th></tr></thead><tbody>';
  h += data.length ? data.map(p => '<tr><td><strong>'+esc(p['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</strong></td><td>'+esc(p['–°—Ç—Ä–∞–Ω–∞'])+'</td><td>'+esc(p['–ü—Ä–æ–¥—É–∫—Ç']||'')+'</td><td>'+statusBadge(p['–°—Ç–∞—Ç—É—Å'])+'</td><td>'+esc(p['–ö–æ–Ω—Ç–∞–∫—Ç']||'')+'</td><td>'+esc(p['Email']||'')+'</td><td>'+actBtns('partner',p.ID,p['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</td></tr>').join('') : emptyRow(7,'–ù–µ—Ç –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤');
  h += '</tbody></table></div></div>';
  return h;
}

function renderCommTable(data) {
  let h = '<div class="card"><div class="table-wrap"><table><thead><tr><th>–ü–∞—Ä—Ç–Ω—ë—Ä</th><th>–¢–∏–ø</th><th>–¢–µ–º–∞</th><th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th><th>–î–∞—Ç–∞</th><th>–ê–≤—Ç–æ—Ä</th><th></th></tr></thead><tbody>';
  h += data.length ? data.map(c => '<tr><td><strong>'+esc(c['–ü–∞—Ä—Ç–Ω—ë—Ä'])+'</strong></td><td>'+esc(c['–¢–∏–ø'])+'</td><td>'+esc(c['–¢–µ–º–∞'])+'</td><td style="font-size:12px;max-width:200px;overflow:hidden;text-overflow:ellipsis">'+esc(c['–†–µ–∑—É–ª—å—Ç–∞—Ç']||'')+'</td><td>'+esc(c['–î–∞—Ç–∞']||'‚Äî')+'</td><td>'+esc(c['–ê–≤—Ç–æ—Ä']||'‚Äî')+'</td><td>'+actBtns('comm',c.ID||'',c['–ü–∞—Ä—Ç–Ω—ë—Ä'])+'</td></tr>').join('') : emptyRow(7,'–ù–µ—Ç –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π');
  h += '</tbody></table></div></div>';
  return h;
}

// ============================================================
// RENDER: DASHBOARD (–ì–î)
// ============================================================
function renderDashboard() {
  const fp = filterByRole(DATA.partners);
  const ft = filterByRole(DATA.tasks);
  const fpr = filterByRole(DATA.projects);
  const td = today();
  const active = ft.filter(t => (t['–°—Ç–∞—Ç—É—Å']||'')!=='–ì–æ—Ç–æ–≤–æ');
  const overdue = active.filter(t => t['–î–µ–¥–ª–∞–π–Ω']&&t['–î–µ–¥–ª–∞–π–Ω']<td);

  document.getElementById('dash-metrics').innerHTML =
    '<div class="metric-card"><div class="m-icon">üè¢</div><div class="m-value">'+Object.keys(PROJECTS).length+'</div><div class="m-label">–ü—Ä–æ–µ–∫—Ç–æ–≤</div><div class="m-sub">–†–ö–¢, –°–∞–π—Ç—ã...</div></div>'+
    '<div class="metric-card"><div class="m-icon">ü§ù</div><div class="m-value">'+fp.length+'</div><div class="m-label">–ü–∞—Ä—Ç–Ω—ë—Ä–æ–≤</div><div class="m-sub">'+fp.filter(p=>p['–°—Ç–∞—Ç—É—Å']==='–ê–∫—Ç–∏–≤–Ω—ã–π').length+' –∞–∫—Ç–∏–≤–Ω—ã—Ö</div></div>'+
    '<div class="metric-card"><div class="m-icon">‚úÖ</div><div class="m-value">'+active.length+'</div><div class="m-label">–ó–∞–¥–∞—á –≤ —Ä–∞–±–æ—Ç–µ</div><div class="m-sub">'+(overdue.length?'üî¥ '+overdue.length+' –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ':'–≤—Å—ë –≤ —Å—Ä–æ–∫')+'</div></div>'+
    '<div class="metric-card"><div class="m-icon">üìÅ</div><div class="m-value">'+fpr.length+'</div><div class="m-label">–ü–æ–¥–ø—Ä–æ–µ–∫—Ç–æ–≤</div></div>'+
    '<div class="metric-card"><div class="m-icon">üë•</div><div class="m-value">'+DATA.staff.length+'</div><div class="m-label">–ö–æ–º–∞–Ω–¥–∞</div></div>';

  // Overdue table
  document.getElementById('dash-overdue').innerHTML = overdue.length ? overdue.map(t =>
    '<tr style="background:rgba(255,107,107,0.03)"><td>'+esc(t['–û–ø–∏—Å–∞–Ω–∏–µ']||t['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</td><td>'+esc(t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'])+'</td><td>'+prBadge(t['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç'])+'</td><td style="color:var(--red);font-weight:700">'+esc(t['–î–µ–¥–ª–∞–π–Ω'])+'</td><td>'+esc(t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'‚Äî')+'</td><td>'+actBtns('task',t.ID,t['–û–ø–∏—Å–∞–Ω–∏–µ'])+'</td></tr>'
  ).join('') : emptyRow(6,'–ù–µ—Ç –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á üéâ');

  // Active projects
  const ap = fpr.filter(p => (p['–°—Ç–∞—Ç—É—Å']||'')!=='–ó–∞–≤–µ—Ä—à—ë–Ω').slice(0,10);
  document.getElementById('dash-projects').innerHTML = ap.length ? ap.map(p =>
    '<tr><td><strong>'+esc(p['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</strong></td><td>'+esc(p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'])+'</td><td>'+statusBadge(p['–°—Ç–∞—Ç—É—Å'])+'</td><td>'+progBar(p['–ü—Ä–æ–≥—Ä–µ—Å—Å'])+'</td><td>'+esc(p['–î–µ–¥–ª–∞–π–Ω']||'‚Äî')+'</td></tr>'
  ).join('') : emptyRow(5,'–ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤');

  // Recent comms
  const rc = (DATA.comms||[]).slice(0,5);
  document.getElementById('dash-comms').innerHTML = rc.length ? rc.map(c =>
    '<tr><td>'+esc(c['–ü–∞—Ä—Ç–Ω—ë—Ä'])+'</td><td>'+esc(c['–¢–∏–ø'])+'</td><td>'+esc(c['–¢–µ–º–∞'])+'</td><td>'+esc(c['–î–∞—Ç–∞']||'‚Äî')+'</td><td>'+esc(c['–ê–≤—Ç–æ—Ä']||'‚Äî')+'</td></tr>'
  ).join('') : emptyRow(5,'–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π');
}

// ============================================================
// RENDER: GLOBAL PAGES (Partners, Tasks, Staff, Approvals, Comms, Settings)
// ============================================================
function renderPartnerFilters() {
  const allDirs = ['–í—Å–µ', ...new Set(DATA.partners.map(i=>i['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']).filter(Boolean))];
  const el = document.getElementById('partner-filters');
  if(el) el.innerHTML = allDirs.map(d => '<button class="filter-chip '+(currentFilters.partners===d?'active':'')+'" onclick="currentFilters.partners=\''+escA(d)+'\';renderAll()">'+esc(d)+'</button>').join('');
}

function renderTaskFilters() {
  const allDirs = ['–í—Å–µ', ...new Set(DATA.tasks.map(i=>i['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']).filter(Boolean))];
  const el = document.getElementById('task-filters');
  if(el) el.innerHTML = allDirs.map(d => '<button class="filter-chip '+(currentFilters.tasks===d?'active':'')+'" onclick="currentFilters.tasks=\''+escA(d)+'\';renderAll()">'+esc(d)+'</button>').join('');
}

function renderPartners() {
  let d = filterByRole(DATA.partners);
  d = filterByDir(d, currentFilters.partners==='–í—Å–µ'?null:currentFilters.partners);
  d = filterBySearch(d,'partner-search',['–ù–∞–∑–≤–∞–Ω–∏–µ','–°—Ç—Ä–∞–Ω–∞','–ü—Ä–æ–¥—É–∫—Ç','–ö–æ–Ω—Ç–∞–∫—Ç']);
  document.getElementById('partners-table').innerHTML = d.length ? d.map(p =>
    '<tr><td><strong>'+esc(p['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</strong></td><td>'+esc(p['–°—Ç—Ä–∞–Ω–∞'])+'</td><td>'+esc(p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'])+'</td><td>'+esc(p['–ü—Ä–æ–¥—É–∫—Ç']||'')+'</td><td>'+statusBadge(p['–°—Ç–∞—Ç—É—Å'])+'</td><td>'+esc(p['–ö–æ–Ω—Ç–∞–∫—Ç']||'')+'</td><td>'+actBtns('partner',p.ID,p['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</td></tr>'
  ).join('') : emptyRow(7,'–ù–µ—Ç –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤');
}

function renderTasks() {
  let d = filterByRole(DATA.tasks);
  d = filterByDir(d, currentFilters.tasks==='–í—Å–µ'?null:currentFilters.tasks);
  d = filterBySearch(d,'task-search',['–û–ø–∏—Å–∞–Ω–∏–µ','–ù–∞–∑–≤–∞–Ω–∏–µ','–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π','–ü—Ä–æ–µ–∫—Ç']);
  const pO = {P1:1,P2:2,P3:3};
  d = [...d].sort((a,b)=>(pO[a['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']]||9)-(pO[b['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']]||9));
  const td = today();
  document.getElementById('tasks-table').innerHTML = d.length ? d.map(t => {
    const od = t['–î–µ–¥–ª–∞–π–Ω']&&t['–î–µ–¥–ª–∞–π–Ω']<td&&(t['–°—Ç–∞—Ç—É—Å']||'')!=='–ì–æ—Ç–æ–≤–æ';
    return '<tr style="'+(od?'background:rgba(255,107,107,0.05)':'')+'"><td>'+(od?'üî¥ ':'')+esc(t['–û–ø–∏—Å–∞–Ω–∏–µ']||t['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</td><td>'+esc(t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'])+'</td><td>'+prBadge(t['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç'])+'</td><td>'+statusBadge(t['–°—Ç–∞—Ç—É—Å'])+'</td><td>'+esc(t['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'‚Äî')+'</td><td>'+(od?'<span style="color:var(--red);font-weight:700">':'')+esc(t['–î–µ–¥–ª–∞–π–Ω']||'‚Äî')+(od?'</span>':'')+'</td><td>'+actBtns('task',t.ID,t['–û–ø–∏—Å–∞–Ω–∏–µ']||t['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</td></tr>';
  }).join('') : emptyRow(7,'–ù–µ—Ç –∑–∞–¥–∞—á');
}

function renderStaff() {
  const p = getUserPerms();
  const roleColors = { CEO: 'linear-gradient(135deg,#00d4aa,#4dabf7)', '–ó–∞–º': 'linear-gradient(135deg,#b197fc,#7950f2)', '–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å': 'linear-gradient(135deg,#ffa94d,#fd7e14)' };
  let h = '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px">';
  if (DATA.staff.length) {
    DATA.staff.forEach(s => {
      const re = (ROLES[s['–†–æ–ª—å']]||{}).emoji||'üë§';
      const bg = roleColors[s['–†–æ–ª—å']] || 'linear-gradient(135deg,var(--text3),var(--text2))';
      h += '<div style="background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:20px;transition:all .2s">';
      h += '<div style="display:flex;align-items:center;gap:14px;margin-bottom:14px">';
      h += '<div style="width:48px;height:48px;border-radius:50%;background:'+bg+';display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:700;color:var(--bg)">'+esc((s['–ò–º—è']||'?').charAt(0).toUpperCase())+'</div>';
      h += '<div><div style="font-weight:700;font-size:14px">'+esc(s['–ò–º—è']||'‚Äî')+'</div><div style="font-size:11px;color:var(--text2)">'+re+' '+esc(s['–†–æ–ª—å']||'‚Äî')+'</div></div>';
      h += '</div>';
      h += '<div style="display:flex;flex-direction:column;gap:6px;font-size:12px;color:var(--text2)">';
      h += '<span>üìÇ '+esc(s['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'–í—Å–µ')+'</span>';
      if(s['Telegram_ID']) h += '<span>üì± TG: '+esc(s['Telegram_ID'])+'</span>';
      if(s['Username']) h += '<span>üë§ '+esc(s['Username'])+'</span>';
      if(s['Email']) h += '<span>‚úâÔ∏è '+esc(s['Email'])+'</span>';
      if(s['–¢–µ–ª–µ—Ñ–æ–Ω']) h += '<span>üìû '+esc(s['–¢–µ–ª–µ—Ñ–æ–Ω'])+'</span>';
      h += '<span>'+statusBadge(s['–°—Ç–∞—Ç—É—Å']||'–ê–∫—Ç–∏–≤–Ω—ã–π')+'</span>';
      h += '</div>';
      if(p.canManageStaff) {
        h += '<div style="display:flex;gap:8px;margin-top:14px;padding-top:12px;border-top:1px solid var(--border)">';
        h += '<button class="btn btn-sm btn-secondary" onclick="editItem(\'staff\',\''+escA(s.ID)+'\')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç.</button>';
        h += '<button class="btn btn-sm btn-danger" onclick="confirmDelete(\'staff\',\''+escA(s.ID)+'\',\''+escA(s['–ò–º—è'])+'\')">üóë</button>';
        h += '</div>';
      }
      h += '</div>';
    });
  } else {
    h += '<div class="empty" style="grid-column:1/-1"><div class="icon">üë•</div><p>–ù–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</p></div>';
  }
  h += '</div>';
  document.getElementById('staff-content').innerHTML = h;
}

function renderApprovals() {
  const el = document.getElementById('approvals-content');
  const p = getUserPerms();
  if (!p.canApprove) { el.innerHTML = '<div class="empty"><div class="icon">üîí</div><p>–¢–æ–ª—å–∫–æ –¥–ª—è CEO</p></div>'; return; }
  const pending = DATA.approvals.filter(a=>(a['–°—Ç–∞—Ç—É—Å']||'').includes('–û–∂–∏–¥–∞–µ—Ç'));
  let h = '<div class="card"><div class="card-header"><h3>‚è≥ –û–∂–∏–¥–∞—é—Ç ('+pending.length+')</h3></div><div class="table-wrap"><table><thead><tr><th>–¢–∏–ø</th><th>–û–ø–∏—Å–∞–Ω–∏–µ</th><th>–û—Ç –∫–æ–≥–æ</th><th>–î–∞—Ç–∞</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead><tbody>';
  h += pending.length ? pending.map(a =>
    '<tr><td>'+esc(a['–¢–∏–ø'])+'</td><td>'+esc(a['–û–ø–∏—Å–∞–Ω–∏–µ'])+'</td><td>'+esc(a['–û—Ç_–∫–æ–≥–æ'])+'</td><td>'+esc(a['–î–∞—Ç–∞_–∑–∞–ø—Ä–æ—Å–∞']||'')+'</td><td><div class="actions-cell"><button class="btn btn-xs btn-approve" onclick="handleApproval(\''+escA(a.ID)+'\',true)">‚úÖ</button> <button class="btn btn-xs btn-reject" onclick="handleApproval(\''+escA(a.ID)+'\',false)">‚ùå</button></div></td></tr>'
  ).join('') : emptyRow(5,'–ù–µ—Ç –æ–∂–∏–¥–∞—é—â–∏—Ö ‚ú®');
  h += '</tbody></table></div></div>';
  el.innerHTML = h;
}

function renderComms() {
  let d = DATA.comms||[];
  d = filterBySearch(d,'comm-search',['–ü–∞—Ä—Ç–Ω—ë—Ä','–¢–µ–º–∞','–†–µ–∑—É–ª—å—Ç–∞—Ç']);
  document.getElementById('comms-table').innerHTML = d.length ? d.map(c =>
    '<tr><td><strong>'+esc(c['–ü–∞—Ä—Ç–Ω—ë—Ä'])+'</strong></td><td>'+esc(c['–¢–∏–ø'])+'</td><td>'+esc(c['–¢–µ–º–∞'])+'</td><td style="font-size:12px;max-width:200px;overflow:hidden;text-overflow:ellipsis">'+esc(c['–†–µ–∑—É–ª—å—Ç–∞—Ç']||'')+'</td><td>'+esc(c['–î–∞—Ç–∞']||'‚Äî')+'</td><td>'+esc(c['–ê–≤—Ç–æ—Ä']||'‚Äî')+'</td><td>'+actBtns('comm',c.ID||'',c['–ü–∞—Ä—Ç–Ω—ë—Ä'])+'</td></tr>'
  ).join('') : emptyRow(7,'–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π');
}

function renderSettings() {
  const stats = [
    {l:'–ü–∞—Ä—Ç–Ω—ë—Ä—ã',v:DATA.partners.length},{l:'–ü—Ä–æ–µ–∫—Ç—ã',v:DATA.projects.length},
    {l:'–ó–∞–¥–∞—á–∏',v:DATA.tasks.length},{l:'–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏',v:DATA.staff.length},
    {l:'–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è',v:DATA.directions.length},{l:'–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏',v:(DATA.comms||[]).length},
    {l:'–í–µ—Ä—Å–∏—è',v:CONFIG.VERSION}
  ];
  document.getElementById('s-stats').innerHTML = stats.map(s => '<div class="detail-item"><div class="detail-label">'+s.l+'</div><div class="detail-value">'+s.v+'</div></div>').join('');
}

// ============================================================
// TASK DETAIL WITH AI ASSISTANT
// ============================================================
function openTaskDetail(taskId) {
  const task = DATA.tasks.find(t => t.ID === taskId);
  if (!task) { toast('–ó–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞','error'); return; }
  currentTaskId = taskId;
  aiMessages = [];

  // Breadcrumb
  let bc = '<a onclick="showPage(\'home\')">üè† –ü—Ä–æ–µ–∫—Ç—ã</a><span class="sep">‚Ä∫</span>';
  const dir = task['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'';
  const projKey = dirToProject(dir);
  if (projKey) {
    bc += '<a onclick="openProject(\''+projKey+'\')">'+esc(PROJECTS[projKey].name)+'</a><span class="sep">‚Ä∫</span>';
    bc += '<a onclick="openSubproject(\''+escA(dir)+'\')">'+esc(dir)+'</a><span class="sep">‚Ä∫</span>';
  }
  bc += '<span class="current">'+esc(task['–û–ø–∏—Å–∞–Ω–∏–µ']||task['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</span>';
  document.getElementById('td-breadcrumb').innerHTML = bc;

  // Task detail card
  let html = '<div class="task-detail">';
  html += '<div class="task-detail-header">';
  html += '<h3>'+esc(task['–û–ø–∏—Å–∞–Ω–∏–µ']||task['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'</h3>';
  html += '<div class="task-meta">';
  html += '<div class="meta-item">'+prBadge(task['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç'])+' '+esc(task['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']||'')+'</div>';
  html += '<div class="meta-item">'+statusBadge(task['–°—Ç–∞—Ç—É—Å'])+'</div>';
  if(task['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']) html += '<div class="meta-item">üìÇ '+esc(task['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'])+'</div>';
  if(task['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']) html += '<div class="meta-item">üë§ '+esc(task['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π'])+'</div>';
  if(task['–î–µ–¥–ª–∞–π–Ω']) {
    const od = task['–î–µ–¥–ª–∞–π–Ω']<today()&&(task['–°—Ç–∞—Ç—É—Å']||'')!=='–ì–æ—Ç–æ–≤–æ';
    html += '<div class="meta-item" style="'+(od?'color:var(--red);font-weight:700':'')+'">üìÖ '+esc(task['–î–µ–¥–ª–∞–π–Ω'])+(od?' üî¥':'')+'</div>';
  }
  html += '</div></div>';

  // Detail fields
  html += '<div class="task-detail-body">';
  html += '<div class="detail-grid">';
  const fields = [
    ['–ü—Ä–æ–µ–∫—Ç', task['–ü—Ä–æ–µ–∫—Ç']],
    ['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', task['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']],
    ['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç', task['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']],
    ['–°—Ç–∞—Ç—É—Å', task['–°—Ç–∞—Ç—É—Å']],
    ['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π', task['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']],
    ['–î–µ–¥–ª–∞–π–Ω', task['–î–µ–¥–ª–∞–π–Ω']]
  ];
  fields.forEach(([l,v]) => {
    if(v) html += '<div class="detail-item"><div class="detail-label">'+esc(l)+'</div><div class="detail-value">'+esc(v)+'</div></div>';
  });
  if(task['–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π']) {
    html += '<div class="detail-item detail-full"><div class="detail-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</div><div class="detail-value">'+esc(task['–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π'])+'</div></div>';
  }
  html += '</div>';

  // Action buttons
  html += '<div style="display:flex;gap:10px;margin-top:20px;flex-wrap:wrap">';
  html += '<button class="btn btn-primary" onclick="editItem(\'task\',\''+escA(taskId)+'\')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>';
  html += '<button class="btn btn-secondary" onclick="changeTaskStatus(\''+escA(taskId)+'\')">üîÑ –°–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>';
  const p = getUserPerms();
  if(p.canDelete) html += '<button class="btn btn-danger" onclick="confirmDelete(\'task\',\''+escA(taskId)+'\',\''+escA(task['–û–ø–∏—Å–∞–Ω–∏–µ']||task['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'\')">üóë –£–¥–∞–ª–∏—Ç—å</button>';
  html += '</div>';
  html += '</div></div>';

  // AI ASSISTANT PANEL
  html += '<div class="ai-panel">';
  html += '<div class="ai-panel-header">';
  html += '<h4>ü§ñ –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ –∑–∞–¥–∞—á–µ</h4>';
  html += '<button class="btn btn-xs btn-secondary" onclick="aiGenerateSteps()">üìã –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞–Ω</button>';
  html += '</div>';

  // AI messages
  html += '<div class="ai-chat-messages" id="ai-messages">';
  html += '<div class="ai-msg system">–ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –≥–æ—Ç–æ–≤ –ø–æ–º–æ—á—å —Å –∑–∞–¥–∞—á–µ–π ¬´'+esc(task['–û–ø–∏—Å–∞–Ω–∏–µ']||task['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'¬ª. –ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ.</div>';
  html += '</div>';

  // Quick actions
  html += '<div class="ai-suggestions">';
  html += '<button class="ai-suggestion-btn" onclick="aiQuickAction(\'plan\')">üìã –ü–ª–∞–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</button>';
  html += '<button class="ai-suggestion-btn" onclick="aiQuickAction(\'risks\')">‚ö†Ô∏è –†–∏—Å–∫–∏</button>';
  html += '<button class="ai-suggestion-btn" onclick="aiQuickAction(\'email\')">üìß –ù–∞–ø–∏—Å–∞—Ç—å –ø–∏—Å—å–º–æ</button>';
  html += '<button class="ai-suggestion-btn" onclick="aiQuickAction(\'checklist\')">‚úÖ –ß–µ–∫–ª–∏—Å—Ç</button>';
  html += '<button class="ai-suggestion-btn" onclick="aiQuickAction(\'next\')">‚û°Ô∏è –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏</button>';
  html += '</div>';

  // Input
  html += '<div class="ai-input-area">';
  html += '<input class="ai-input" id="ai-input" placeholder="–°–ø—Ä–æ—Å–∏—Ç–µ –ò–ò –æ –∑–∞–¥–∞—á–µ..." onkeydown="if(event.key===\'Enter\')sendAiMessage()">';
  html += '<button class="ai-send-btn" id="ai-send-btn" onclick="sendAiMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>';
  html += '</div>';
  html += '</div>';

  document.getElementById('td-content').innerHTML = html;
  showPage('taskdetail');
}

function changeTaskStatus(taskId) {
  const task = DATA.tasks.find(t => t.ID===taskId);
  if(!task) return;
  const statuses = ['‚è≥ –í –æ—á–µ—Ä–µ–¥–∏', '–í —Ä–∞–±–æ—Ç–µ', '–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ', '–ì–æ—Ç–æ–≤–æ'];
  const cur = task['–°—Ç–∞—Ç—É—Å']||'';
  const idx = statuses.indexOf(cur);
  const next = statuses[(idx+1)%statuses.length];
  task['–°—Ç–∞—Ç—É—Å'] = next;
  openTaskDetail(taskId);
  toast('–°—Ç–∞—Ç—É—Å: '+next, 'success');
  apiWrite('–ó–∞–¥–∞—á–∏', task);
}

// ============================================================
// AI CHAT FUNCTIONS
// ============================================================
async function sendAiMessage() {
  const input = document.getElementById('ai-input');
  const msg = input.value.trim();
  if(!msg) return;

  input.value = '';
  addAiMessage('user', msg);

  // Get task context
  const task = DATA.tasks.find(t => t.ID===currentTaskId);
  const context = task ? '–ó–∞–¥–∞—á–∞: '+( task['–û–ø–∏—Å–∞–Ω–∏–µ']||task['–ù–∞–∑–≤–∞–Ω–∏–µ'])+'. –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: '+(task['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'')+'. –°—Ç–∞—Ç—É—Å: '+(task['–°—Ç–∞—Ç—É—Å']||'')+'. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: '+(task['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']||'')+'. –î–µ–¥–ª–∞–π–Ω: '+(task['–î–µ–¥–ª–∞–π–Ω']||'–Ω–µ —É–∫–∞–∑–∞–Ω')+'. –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: '+(task['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'–Ω–µ —É–∫–∞–∑–∞–Ω')+'. –ü—Ä–æ–µ–∫—Ç: '+(task['–ü—Ä–æ–µ–∫—Ç']||'')+'. –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: '+(task['–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π']||'') : '';

  await callAI(msg, context);
}

function aiQuickAction(type) {
  const task = DATA.tasks.find(t => t.ID===currentTaskId);
  if(!task) return;
  const name = task['–û–ø–∏—Å–∞–Ω–∏–µ']||task['–ù–∞–∑–≤–∞–Ω–∏–µ'];

  const prompts = {
    plan: '–°–æ—Å—Ç–∞–≤—å –ø–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ ¬´'+name+'¬ª. –î–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —à–∞–≥–∏ —Å –æ—Ü–µ–Ω–∫–æ–π –≤—Ä–µ–º–µ–Ω–∏.',
    risks: '–ö–∞–∫–∏–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ä–∏—Å–∫–∏ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏ ¬´'+name+'¬ª? –ö–∞–∫ –∏—Ö –º–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å?',
    email: '–ù–∞–ø–∏—à–∏ –¥–µ–ª–æ–≤–æ–µ –ø–∏—Å—å–º–æ –ø–∞—Ä—Ç–Ω—ë—Ä—É –ø–æ –∑–∞–¥–∞—á–µ ¬´'+name+'¬ª. –¢–æ–Ω ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π.',
    checklist: '–°–æ–∑–¥–∞–π –ø–æ–¥—Ä–æ–±–Ω—ã–π —á–µ–∫–ª–∏—Å—Ç –¥–ª—è –∑–∞–¥–∞—á–∏ ¬´'+name+'¬ª ‚Äî —á—Ç–æ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º.',
    next: '–ö–∞–∫–∏–µ —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ ¬´'+name+'¬ª? –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –¥–∞–ª–µ–µ?'
  };

  const msg = prompts[type] || '–ü–æ–º–æ–≥–∏ —Å –∑–∞–¥–∞—á–µ–π ¬´'+name+'¬ª';
  addAiMessage('user', msg);

  const context = '–ó–∞–¥–∞—á–∞: '+name+'. –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: '+(task['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'')+'. –°—Ç–∞—Ç—É—Å: '+(task['–°—Ç–∞—Ç—É—Å']||'')+'. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: '+(task['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']||'')+'. –î–µ–¥–ª–∞–π–Ω: '+(task['–î–µ–¥–ª–∞–π–Ω']||'–Ω–µ —É–∫–∞–∑–∞–Ω')+'. –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: '+(task['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π']||'–Ω–µ —É–∫–∞–∑–∞–Ω')+'.';
  callAI(msg, context);
}

function aiGenerateSteps() {
  aiQuickAction('plan');
}

async function callAI(userMsg, context) {
  // Show loading
  const container = document.getElementById('ai-messages');
  const loadingId = 'ai-loading-'+Date.now();
  container.innerHTML += '<div class="ai-msg assistant" id="'+loadingId+'"><div class="ai-loading"><span></span><span></span><span></span></div></div>';
  container.scrollTop = container.scrollHeight;

  const sendBtn = document.getElementById('ai-send-btn');
  if(sendBtn) sendBtn.disabled = true;

  let aiResponse = '';
  try {
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 30000);
    const response = await fetch(CONFIG.AI_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        message: userMsg,
        context: context,
        history: aiMessages.filter(m=>m.role==='user'||m.role==='assistant').slice(-10),
        user: USER ? USER['–ò–º—è'] : ''
      }),
      signal: controller.signal
    });
    clearTimeout(timeout);

    if (response.ok) {
      const data = await response.json();
      aiResponse = data.response || data.text || data.message || '';
      if (!aiResponse && data.content) { try { aiResponse = data.content[0].text; } catch(e) {} }
    }
    if (!aiResponse) throw new Error('Empty response');
  } catch(e) {
    console.warn('Task AI fallback:', e.message);
    aiResponse = generateLocalAIResponse(userMsg, context);
  }

  const loadEl = document.getElementById(loadingId);
  if(loadEl) loadEl.remove();
  addAiMessage('assistant', aiResponse);
  if(sendBtn) sendBtn.disabled = false;
}

function generateLocalAIResponse(msg, context) {
  // Smart local fallback when AI endpoint is not available
  const lower = msg.toLowerCase();

  if (lower.includes('–ø–ª–∞–Ω') || lower.includes('—à–∞–≥')) {
    return 'üìã **–ü–ª–∞–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**\n\n1. –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π\n2. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤\n3. –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ —Å –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –ª–∏—Ü–∞–º–∏\n4. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–π —Ä–∞–±–æ—Ç—ã\n5. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ\n6. –§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –∏ –∑–∞–∫—Ä—ã—Ç–∏–µ –∑–∞–¥–∞—á–∏\n\n‚è± –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Å—Ä–æ–∫: —Ä–∞–∑–±–µ–π—Ç–µ –Ω–∞ —ç—Ç–∞–ø—ã –ø–æ 1-2 –¥–Ω—è –∫–∞–∂–¥—ã–π.\n\nüí° –°–æ–≤–µ—Ç: –Ω–∞—á–Ω–∏—Ç–µ —Å –ø—É–Ω–∫—Ç–∞ 1 —Å–µ–≥–æ–¥–Ω—è, —á—Ç–æ–±—ã –Ω–µ –æ—Ç–∫–ª–∞–¥—ã–≤–∞—Ç—å.';
  }
  if (lower.includes('—Ä–∏—Å–∫')) {
    return '‚ö†Ô∏è **–í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–∏—Å–∫–∏:**\n\n1. –ó–∞–¥–µ—Ä–∂–∫–∞ –æ—Ç –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤/–ø–æ–¥—Ä—è–¥—á–∏–∫–æ–≤\n2. –ù–µ—Ö–≤–∞—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ –∏–ª–∏ –±—é–¥–∂–µ—Ç–∞\n3. –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ\n4. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏\n\nüõ° **–ú–∏—Ç–∏–≥–∞—Ü–∏—è:**\n- –ó–∞–ª–æ–∂–∏—Ç–µ –±—É—Ñ–µ—Ä –ø–æ —Å—Ä–æ–∫–∞–º (15-20%)\n- –ü–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ –ø–ª–∞–Ω –ë –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —ç—Ç–∞–ø–æ–≤\n- –†–µ–≥—É–ª—è—Ä–Ω–æ —Å–≤–µ—Ä—è–π—Ç–µ—Å—å —Å –∑–∞–∫–∞–∑—á–∏–∫–æ–º';
  }
  if (lower.includes('–ø–∏—Å—å–º') || lower.includes('email')) {
    return 'üìß **–®–∞–±–ª–æ–Ω –ø–∏—Å—å–º–∞:**\n\n–£–≤–∞–∂–∞–µ–º—ã–π [–ò–º—è],\n\n–í —Ä–∞–º–∫–∞—Ö –Ω–∞—à–µ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞ —Ö–æ—Ç–µ–ª –±—ã –æ–±—Å—É–¥–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –ø–æ –∑–∞–¥–∞—á–µ.\n\n–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –º—ã –Ω–∞—Ö–æ–¥–∏–º—Å—è –Ω–∞ —ç—Ç–∞–ø–µ [—ç—Ç–∞–ø]. –î–ª—è –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è –Ω–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ [–¥–µ–π—Å—Ç–≤–∏–µ].\n\n–ü—Ä–µ–¥–ª–∞–≥–∞—é –Ω–∞–∑–Ω–∞—á–∏—Ç—å –≤—Å—Ç—Ä–µ—á—É/–∑–≤–æ–Ω–æ–∫ –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π.\n\n–° —É–≤–∞–∂–µ–Ω–∏–µ–º,\n'+((USER?USER.name:''))||'[–í–∞—à–µ –∏–º—è]';
  }
  if (lower.includes('—á–µ–∫–ª–∏—Å—Ç') || lower.includes('–ø—Ä–æ–≤–µ—Ä–∫')) {
    return '‚úÖ **–ß–µ–∫–ª–∏—Å—Ç:**\n\n‚òê –í—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã\n‚òê –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ —Å —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ–º –ø–æ–ª—É—á–µ–Ω–æ\n‚òê –ë—é–¥–∂–µ—Ç —É—Ç–≤–µ—Ä–∂–¥—ë–Ω\n‚òê –°—Ä–æ–∫–∏ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã\n‚òê –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã\n‚òê –†–∏—Å–∫–∏ —É—á—Ç–µ–Ω—ã\n‚òê –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –¢–ó\n‚òê –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –ø–æ–ª—É—á–µ–Ω–∞';
  }
  if (lower.includes('—Å–ª–µ–¥—É—é—â') || lower.includes('–¥–∞–ª–µ–µ') || lower.includes('next')) {
    return '‚û°Ô∏è **–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**\n\n1. –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ–∫—É—â–µ–π –∑–∞–¥–∞—á–∏\n2. –£–≤–µ–¥–æ–º–∏—Ç—å –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω–Ω—ã—Ö –ª–∏—Ü –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏\n3. –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤ —Å–∏—Å—Ç–µ–º–µ\n4. –ü—Ä–æ–≤–µ—Å—Ç–∏ —Ä–µ—Ç—Ä–æ—Å–ø–µ–∫—Ç–∏–≤—É (—á—Ç–æ –ø–æ—à–ª–æ —Ö–æ—Ä–æ—à–æ / —á—Ç–æ —É–ª—É—á—à–∏—Ç—å)\n5. –ü–µ—Ä–µ–π—Ç–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–π –∑–∞–¥–∞—á–µ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É';
  }

  return 'ü§ñ –Ø –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª –∑–∞–¥–∞—á—É. –í–æ—Ç —á—Ç–æ –º–æ–≥—É —Å–∫–∞–∑–∞—Ç—å:\n\n' + context + '\n\n–ß—Ç–æ–±—ã —è –¥–∞–ª –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–π –æ—Ç–≤–µ—Ç, —É—Ç–æ—á–Ω–∏—Ç–µ —á—Ç–æ –∏–º–µ–Ω–Ω–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç ‚Äî –ø–ª–∞–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è, —Ä–∏—Å–∫–∏, –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏ –∏–ª–∏ –¥—Ä—É–≥–æ–π –∞—Å–ø–µ–∫—Ç.';
}

function addAiMessage(role, text) {
  aiMessages.push({ role, content: text });
  const container = document.getElementById('ai-messages');
  const div = document.createElement('div');
  div.className = 'ai-msg ' + role;
  div.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

// ============================================================
// GLOBAL AI ASSISTANT PANEL
// ============================================================
let globalAiMessages = [];
let aiPanelOpen = false;

function toggleAiPanel() {
  const panel = document.getElementById('aiGlobalPanel');
  const fab = document.getElementById('aiFab');
  aiPanelOpen = !aiPanelOpen;
  if (aiPanelOpen) {
    panel.style.display = 'flex';
    fab.style.display = 'none';
    setTimeout(() => document.getElementById('ai-global-input').focus(), 100);
  } else {
    panel.style.display = 'none';
    fab.style.display = 'flex';
  }
}

function getDataContext() {
  const ctx = { projects: {}, staff_count: DATA.staff.length, total_tasks: 0, overdue: [], upcoming: [] };
  const now = new Date();
  for (const [key, proj] of Object.entries(PROJECTS)) {
    const tasks = DATA.tasks.filter(t => {
      for (const sub of Object.keys(proj.subprojects)) {
        if (t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] === sub || t['–ü—Ä–æ–µ–∫—Ç'] === proj.name) return true;
      }
      return false;
    });
    ctx.projects[proj.name] = { subprojects: Object.keys(proj.subprojects).length, tasks: tasks.length };
    ctx.total_tasks += tasks.length;
    tasks.forEach(t => {
      if (t['–î–µ–¥–ª–∞–π–Ω'] && t['–°—Ç–∞—Ç—É—Å'] !== '–ó–∞–≤–µ—Ä—à–µ–Ω–æ') {
        const dl = new Date(t['–î–µ–¥–ª–∞–π–Ω']);
        if (dl < now) ctx.overdue.push({ task: t['–ù–∞–∑–≤–∞–Ω–∏–µ'], deadline: t['–î–µ–¥–ª–∞–π–Ω'], direction: t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] });
        else if (dl - now < 7*86400000) ctx.upcoming.push({ task: t['–ù–∞–∑–≤–∞–Ω–∏–µ'], deadline: t['–î–µ–¥–ª–∞–π–Ω'], direction: t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] });
      }
    });
  }
  ctx.partners_count = DATA.partners.length;
  ctx.comms_count = DATA.comms.length;
  return ctx;
}

async function sendGlobalAi() {
  const input = document.getElementById('ai-global-input');
  const msg = input.value.trim();
  if (!msg) return;
  input.value = '';
  input.disabled = true;

  const container = document.getElementById('ai-global-messages');
  const userDiv = document.createElement('div');
  userDiv.className = 'ai-msg user';
  userDiv.textContent = msg;
  container.appendChild(userDiv);
  globalAiMessages.push({ role: 'user', content: msg });

  // Typing indicator
  const typing = document.createElement('div');
  typing.className = 'ai-msg system';
  typing.innerHTML = '‚è≥ –î—É–º–∞—é...';
  typing.id = 'ai-typing';
  container.appendChild(typing);
  container.scrollTop = container.scrollHeight;

  const dataCtx = getDataContext();
  let aiText = '';

  try {
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 30000);
    const response = await fetch(CONFIG.AI_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        message: msg,
        context: '',
        history: globalAiMessages.filter(m=>m.role==='user'||m.role==='assistant').slice(-10)
      }),
      signal: controller.signal
    });
    clearTimeout(timeout);
    if (!response.ok) throw new Error('HTTP ' + response.status);
    const data = await response.json();
    aiText = data.response || data.text || data.message || '';
    if (!aiText && data.content) { try { aiText = data.content[0].text; } catch(e) {} }
    if (!aiText) throw new Error('Empty response');
  } catch(e) {
    console.warn('AI API error, using local fallback:', e.message);
    aiText = generateGlobalFallback(msg, dataCtx);
  }

  typing.remove();
  const aiDiv = document.createElement('div');
  aiDiv.className = 'ai-msg assistant';
  aiDiv.innerHTML = aiText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
  container.appendChild(aiDiv);
  globalAiMessages.push({ role: 'assistant', content: aiText });
  container.scrollTop = container.scrollHeight;
  input.disabled = false;
  input.focus();
}

function globalAiQuick(question) {
  document.getElementById('ai-global-input').value = question;
  sendGlobalAi();
}

function generateGlobalFallback(msg, ctx) {
  const ml = msg.toLowerCase();
  const td = today();

  // Direction-specific queries: "—á—Ç–æ –ø–æ –ö–¢?", "—Å—Ç–∞—Ç—É—Å —Ä–æ–±–æ—Ç–æ–≤", etc.
  const dirKeywords = {
    '–∫—Ç':['–ö–¢','–∫—Ç','—Ç–æ–º–æ–≥—Ä–∞—Ñ','ct'], '—Ä–µ–Ω—Ç–≥–µ–Ω':['–†–µ–Ω—Ç–≥–µ–Ω','—Ä–µ–Ω—Ç–≥–µ–Ω','xray'],
    '—Ä–æ–±–æ—Ç':['–†–æ–±–æ—Ç—ã','—Ä–æ–±–æ—Ç','—Ö–∏—Ä—É—Ä–≥'], '—É—Ä–æ–ª–æ–≥':['–£—Ä–æ–ª–æ–≥–∏—è','—É—Ä–æ–ª–æ–≥'],
    'pacs':['PACS','pacs','–∞—Ä—Ö–∏–≤'], '—É–∑–∏':['–£–ó–ò','—É–∑–∏','—É–ª—å—Ç—Ä–∞–∑–≤—É–∫'],
    '—Å–∞–π—Ç':['–°–∞–π—Ç—ã','—Å–∞–π—Ç','web','–≤–µ–±'], '–ø—ã—à–∫–∏':['–ü—ã—à–∫–∏','–ø—ã—à–∫–∏','–ø–æ–Ω—á–∏–∫'],
    '–±—Ä–µ–∂–Ω–µ–≤':['–ë—Ä–µ–∂–Ω–µ–≤','–±—Ä–µ–∂–Ω–µ–≤'], '–∫–µ—Ä–∞—Ç–∏–Ω':['–ö–µ—Ä–∞—Ç–∏–Ω','–∫–µ—Ä–∞—Ç–∏–Ω','–∞–≥—Ä—ã–∑']
  };
  for (const [key, words] of Object.entries(dirKeywords)) {
    if (words.some(w => ml.includes(w.toLowerCase()))) {
      const allDirs = getDirectionOptions();
      const matchDir = allDirs.find(d => words.some(w => d.toLowerCase().includes(w.toLowerCase()))) || words[0];
      const dirPartners = DATA.partners.filter(p => (p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'').toLowerCase().includes(key));
      const dirTasks = DATA.tasks.filter(t => (t['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'').toLowerCase().includes(key));
      const openTasks = dirTasks.filter(t => t['–°—Ç–∞—Ç—É—Å'] !== '–ó–∞–≤–µ—Ä—à–µ–Ω–æ' && t['–°—Ç–∞—Ç—É—Å'] !== '–ì–æ—Ç–æ–≤–æ' && t['–°—Ç–∞—Ç—É—Å'] !== '‚úÖ –ì–æ—Ç–æ–≤–æ');
      const overdueT = openTasks.filter(t => t['–î–µ–¥–ª–∞–π–Ω'] && t['–î–µ–¥–ª–∞–π–Ω'] < td);
      let r = 'üìÇ **'+matchDir+':**\n\n';
      r += 'ü§ù –ü–∞—Ä—Ç–Ω—ë—Ä–æ–≤: '+dirPartners.length+'\n';
      if (dirPartners.length) dirPartners.forEach(p => r += '  ‚Ä¢ '+(p['–ù–∞–∑–≤–∞–Ω–∏–µ']||'?')+' ('+(p['–°—Ç—Ä–∞–Ω–∞']||'?')+') ‚Äî '+(p['–°—Ç–∞—Ç—É—Å']||'?')+'\n');
      r += '\n‚úÖ –ó–∞–¥–∞—á: '+dirTasks.length+' (–æ—Ç–∫—Ä—ã—Ç—ã—Ö: '+openTasks.length;
      if (overdueT.length) r += ', üî¥ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ: '+overdueT.length;
      r += ')\n';
      if (openTasks.length) openTasks.slice(0,5).forEach(t => r += '  ‚Ä¢ '+(t['–ù–∞–∑–≤–∞–Ω–∏–µ']||t['–û–ø–∏—Å–∞–Ω–∏–µ']||'‚Äî')+' ‚Äî '+(t['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç']||'?')+', –¥–µ–¥–ª–∞–π–Ω: '+(t['–î–µ–¥–ª–∞–π–Ω']||'‚Äî')+'\n');
      return r;
    }
  }

  if (ml.includes('–ø—Ä–æ—Å—Ä–æ—á') || ml.includes('overdue')) {
    if (ctx.overdue.length === 0) return '‚úÖ –û—Ç–ª–∏—á–Ω–æ! –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á –Ω–µ—Ç.';
    let r = 'üî¥ **–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ ('+ctx.overdue.length+'):**\n';
    ctx.overdue.forEach(t => r += '‚Ä¢ '+t.task+' ‚Äî –¥–µ–¥–ª–∞–π–Ω: '+t.deadline+', '+t.direction+'\n');
    r += '\nüí° –†–∞–∑–æ–±—Ä–∞—Ç—å –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ, –æ–±–Ω–æ–≤–∏—Ç—å –¥–µ–¥–ª–∞–π–Ω—ã.';
    return r;
  }
  if (ml.includes('–æ—Ç—á—ë—Ç') || ml.includes('–æ—Ç—á–µ—Ç') || ml.includes('report')) {
    let r = 'üìä **–°–≤–æ–¥–∫–∞ RKT HUB:**\n\n';
    for (const [name, info] of Object.entries(ctx.projects)) r += '‚Ä¢ **'+name+'**: '+info.subprojects+' –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π, '+info.tasks+' –∑–∞–¥–∞—á\n';
    r += '\nüë• –°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤: '+ctx.staff_count+'\nü§ù –ü–∞—Ä—Ç–Ω—ë—Ä–æ–≤: '+ctx.partners_count;
    r += '\nüî¥ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ: '+ctx.overdue.length+'\n‚ö†Ô∏è –ë–ª–∏–∂–∞–π—à–∏–µ: '+ctx.upcoming.length;
    if (ctx.overdue.length) { r += '\n\n**–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ:**\n'; ctx.overdue.slice(0,5).forEach(t => r += '‚Ä¢ '+t.task+' ('+t.deadline+')\n'); }
    return r;
  }
  if (ml.includes('–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç') || ml.includes('priority')) {
    let r = '‚≠ê **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã:**\n';
    if (ctx.overdue.length) { r += '1. üî¥ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ ('+ctx.overdue.length+'):\n'; ctx.overdue.forEach(t => r += '   ‚Ä¢ '+t.task+'\n'); }
    if (ctx.upcoming.length) r += '2. ‚è∞ –ë–ª–∏–∂–∞–π—à–∏–µ: '+ctx.upcoming.map(t=>t.task).join(', ')+'\n';
    r += '3. üìÇ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å—ã –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º';
    return r;
  }
  if (ml.includes('–ø–ª–∞–Ω')) {
    return 'üìã **–ü–ª–∞–Ω –Ω–∞ –Ω–µ–¥–µ–ª—é:**\n‚Ä¢ –ü–Ω: –†–µ–≤—å—é —Å—Ç–∞—Ç—É—Å–æ–≤\n‚Ä¢ –í—Ç-–°—Ä: –ö–ª—é—á–µ–≤—ã–µ –∑–∞–¥–∞—á–∏\n‚Ä¢ –ß—Ç: –í—Å—Ç—Ä–µ—á–∏ —Å –ø–∞—Ä—Ç–Ω—ë—Ä–∞–º–∏\n‚Ä¢ –ü—Ç: –ò—Ç–æ–≥–∏\n\nüìå –ó–∞–¥–∞—á: '+ctx.total_tasks+' | –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ: '+ctx.overdue.length+' | –ö–æ–º–∞–Ω–¥–∞: '+ctx.staff_count;
  }
  if (ml.includes('–ø–∏—Å—å–º') || ml.includes('email')) {
    return 'üìß –ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º—É –∏ –æ —á—ë–º. –ü—Ä–∏–º–µ—Ä—ã:\n‚Ä¢ ¬´–ü–∏—Å—å–º–æ –ø–∞—Ä—Ç–Ω—ë—Ä—É Syno Medical –æ —Å—Ç–∞—Ç—É—Å–µ –ø–æ—Å—Ç–∞–≤–∫–∏¬ª\n‚Ä¢ ¬´–ü–∏—Å—å–º–æ –∫–ª–∏–µ–Ω—Ç—É –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å–∞–π—Ç–∞¬ª';
  }
  if (ml.includes('—Ä–∏—Å–∫')) {
    let r = '‚ö†Ô∏è **–†–∏—Å–∫–∏:**\n';
    if (ctx.overdue.length) r += '1. üî¥ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ ('+ctx.overdue.length+')\n';
    r += '2. –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤\n3. –°—Ä–æ–∫–∏ –ø–æ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–º –ø—Ä–æ–µ–∫—Ç–∞–º';
    return r;
  }
  if (ml.includes('–∫–æ–º–∞–Ω–¥') || ml.includes('—Å–æ—Ç—Ä—É–¥–Ω–∏–∫') || ml.includes('–∫—Ç–æ –≤')) {
    let r = 'üë• **–ö–æ–º–∞–Ω–¥–∞ ('+DATA.staff.length+'):**\n';
    DATA.staff.forEach(s => r += '‚Ä¢ '+(ROLES[s['–†–æ–ª—å']]?.emoji||'üë§')+' '+(s['–ò–º—è']||'?')+' ‚Äî '+(s['–†–æ–ª—å']||'?')+', '+(s['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'–í—Å–µ')+'\n');
    return r;
  }
  if (ml.includes('–ø–∞—Ä—Ç–Ω—ë—Ä') || ml.includes('–ø–∞—Ä—Ç–Ω–µ—Ä')) {
    let r = 'ü§ù **–ü–∞—Ä—Ç–Ω—ë—Ä—ã ('+DATA.partners.length+'):**\n';
    DATA.partners.forEach(p => r += '‚Ä¢ '+(p['–ù–∞–∑–≤–∞–Ω–∏–µ']||'?')+' ('+(p['–°—Ç—Ä–∞–Ω–∞']||'?')+') ‚Äî '+(p['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'?')+', '+(p['–°—Ç–∞—Ç—É—Å']||'?')+'\n');
    return r;
  }
  return 'ü§ñ –í —Å–∏—Å—Ç–µ–º–µ '+ctx.total_tasks+' –∑–∞–¥–∞—á, '+ctx.staff_count+' —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤, '+ctx.partners_count+' –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤.\n\nüí° –°–ø—Ä–æ—Å–∏—Ç–µ:\n‚Ä¢ **–ü–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é:** ¬´—á—Ç–æ –ø–æ –ö–¢?¬ª, ¬´—Å—Ç–∞—Ç—É—Å —Ä–æ–±–æ—Ç–æ–≤¬ª\n‚Ä¢ **–ó–∞–¥–∞—á–∏:** ¬´–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ¬ª, ¬´–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã¬ª\n‚Ä¢ **–û—Ç—á—ë—Ç:** ¬´–æ—Ç—á—ë—Ç¬ª, ¬´–ø–ª–∞–Ω –Ω–∞ –Ω–µ–¥–µ–ª—é¬ª\n‚Ä¢ **–ö–æ–º–∞–Ω–¥–∞:** ¬´–∫—Ç–æ –≤ –∫–æ–º–∞–Ω–¥–µ?¬ª\n‚Ä¢ **–ü–∏—Å—å–º–æ:** ¬´–Ω–∞–ø–∏—à–∏ –ø–∏—Å—å–º–æ –ø–∞—Ä—Ç–Ω—ë—Ä—É X¬ª';
}

function openModal(type, existingData) {
  if (type === 'newproject') {
    openAddProjectModal();
    return;
  }

  currentModal = type;
  editingItem = existingData || null;
  const def = FORM_DEFS[type];
  if(!def) return;

  // Auto-set direction
  const autoDir = currentSubproject || null;

  document.getElementById('modalTitle').textContent = (editingItem?'‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å: ':'‚ûï –î–æ–±–∞–≤–∏—Ç—å: ') + def.title;

  let html = '';
  for (const field of def.fields) {
    const val = editingItem ? (editingItem[field.name]||'') : (field.name==='–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'&&autoDir ? autoDir : '');
    const req = field.required ? 'required' : '';

    html += '<div class="form-group"><label class="'+req+'">'+esc(field.name)+'</label>';
    const opts = typeof field.options === 'function' ? field.options() : field.options;

    if (field.type==='select') {
      html += '<select id="field-'+field.name+'">';
      for (const o of (opts||[])) html += '<option value="'+escA(o)+'"'+(val===o?' selected':'')+'>'+esc(o)+'</option>';
      html += '</select>';
    } else if (field.type==='textarea') {
      html += '<textarea id="field-'+field.name+'" placeholder="'+escA(field.placeholder||'')+'">'+esc(val)+'</textarea>';
    } else {
      html += '<input type="'+field.type+'" id="field-'+field.name+'" value="'+escA(val)+'" placeholder="'+escA(field.placeholder||'')+'">';
    }
    html += '</div>';
  }

  document.getElementById('modalBody').innerHTML = html;
  document.getElementById('modalOverlay').classList.add('show');
  setTimeout(() => { const f=document.getElementById('field-'+def.fields[0].name); if(f)f.focus(); }, 200);
}

function openAddProjectModal() {
  currentModal = 'newproject';
  document.getElementById('modalTitle').textContent = '‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç';
  document.getElementById('modalBody').innerHTML =
    '<div class="form-group"><label class="required">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</label><input type="text" id="field-projname" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ë—É—Ä–º–∏—Å—Ç—Ä"></div>'+
    '<div class="form-group"><label>Emoji</label><input type="text" id="field-projemoji" placeholder="üè¢" value="üè¢"></div>'+
    '<div class="form-group"><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea id="field-projdesc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞..."></textarea></div>'+
    '<div class="form-group"><label>–¶–≤–µ—Ç</label><select id="field-projcolor"><option value="var(--accent)">–ó–µ–ª—ë–Ω—ã–π</option><option value="var(--blue)">–°–∏–Ω–∏–π</option><option value="var(--purple)">–§–∏–æ–ª–µ—Ç–æ–≤—ã–π</option><option value="var(--orange)">–û—Ä–∞–Ω–∂–µ–≤—ã–π</option><option value="var(--pink)">–†–æ–∑–æ–≤—ã–π</option></select></div>';
  document.getElementById('modalOverlay').classList.add('show');
}

function openAddSubproject() {
  if (!currentProject) return;
  currentModal = 'newsubproject';
  const proj = PROJECTS[currentProject];
  document.getElementById('modalTitle').textContent = '‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–ø—Ä–æ–µ–∫—Ç –≤ ¬´'+proj.name+'¬ª';

  // Check if this is a site-type project (canAddSub=true means site project)
  const isSite = proj.canAddSub;
  if (isSite) {
    document.getElementById('modalBox').classList.add('wide');
  } else {
    document.getElementById('modalBox').classList.remove('wide');
  }

  let fieldsHtml = '<div class="form-group"><label class="required">–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="field-subname" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥–ø—Ä–æ–µ–∫—Ç–∞"></div>';
  fieldsHtml += '<div class="form-group"><label>Emoji</label><input type="text" id="field-subemoji" placeholder="üìå" value="üìå"></div>';
  fieldsHtml += '<div class="form-group"><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea id="field-subdesc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ..."></textarea></div>';

  if (isSite) {
    // Full site questionnaire
    fieldsHtml += '<div class="form-section-title">üìã –ê–Ω–∫–µ—Ç–∞ –¥–ª—è –ò–ò-–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∞–π—Ç–∞</div>';
    fieldsHtml += '<div class="form-row">';
    fieldsHtml += '<div class="form-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å–∞</label><input type="text" id="field-subbizname" placeholder="–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –±–∏–∑–Ω–µ—Å"></div>';
    fieldsHtml += '<div class="form-group"><label>–¢–∏–ø –±–∏–∑–Ω–µ—Å–∞</label><select id="field-subbiztype"><option>–†–µ—Å—Ç–æ—Ä–∞–Ω / –ö–∞—Ñ–µ</option><option>–°–∞–ª–æ–Ω –∫—Ä–∞—Å–æ—Ç—ã</option><option>–ú–µ–¥–∏—Ü–∏–Ω–∞</option><option>–£—Å–ª—É–≥–∏</option><option>–ú–∞–≥–∞–∑–∏–Ω</option><option>–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ</option><option>–î—Ä—É–≥–æ–µ</option></select></div>';
    fieldsHtml += '</div>';
    fieldsHtml += '<div class="form-row">';
    fieldsHtml += '<div class="form-group"><label>–ö–ª–∏–µ–Ω—Ç (–§–ò–û)</label><input type="text" id="field-subclient" placeholder="–ò–º—è –∑–∞–∫–∞–∑—á–∏–∫–∞"></div>';
    fieldsHtml += '<div class="form-group"><label>–¢–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–µ–Ω—Ç–∞</label><input type="text" id="field-subphone" placeholder="+7..."></div>';
    fieldsHtml += '</div>';
    fieldsHtml += '<div class="form-row">';
    fieldsHtml += '<div class="form-group"><label>Email –∫–ª–∏–µ–Ω—Ç–∞</label><input type="text" id="field-subemail" placeholder="email@..."></div>';
    fieldsHtml += '<div class="form-group"><label>–ì–æ—Ä–æ–¥</label><input type="text" id="field-subcity" placeholder="–ì–æ—Ä–æ–¥ –±–∏–∑–Ω–µ—Å–∞"></div>';
    fieldsHtml += '</div>';
    fieldsHtml += '<div class="form-section-title">üé® –î–∏–∑–∞–π–Ω –∏ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ</div>';
    fieldsHtml += '<div class="form-row">';
    fieldsHtml += '<div class="form-group"><label>–°—Ç–∏–ª—å —Å–∞–π—Ç–∞</label><select id="field-substyle"><option>–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–∏–Ω–∏–º–∞–ª–∏–∑–º</option><option>–¢—ë–º–Ω–∞—è —Ç–µ–º–∞</option><option>–°–≤–µ—Ç–ª–∞—è –∏ —è—Ä–∫–∞—è</option><option>–†–µ—Ç—Ä–æ / –í–∏–Ω—Ç–∞–∂</option><option>–ü—Ä–µ–º–∏—É–º / –õ—é–∫—Å</option><option>–î–µ—Ç—Å–∫–∏–π / –í–µ—Å—ë–ª—ã–π</option></select></div>';
    fieldsHtml += '<div class="form-group"><label>–û—Å–Ω–æ–≤–Ω—ã–µ —Ü–≤–µ—Ç–∞</label><input type="text" id="field-subcolors" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –∫—Ä–∞—Å–Ω—ã–π –∏ –∑–æ–ª–æ—Ç–æ–π"></div>';
    fieldsHtml += '</div>';
    fieldsHtml += '<div class="form-group"><label>–ß—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–∞ —Å–∞–π—Ç–µ</label><textarea id="field-subpages" placeholder="–ì–ª–∞–≤–Ω–∞—è, –ú–µ–Ω—é, –û –Ω–∞—Å, –ö–æ–Ω—Ç–∞–∫—Ç—ã, –î–æ—Å—Ç–∞–≤–∫–∞..."></textarea></div>';
    fieldsHtml += '<div class="form-group"><label>–û—Å–æ–±—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è</label><textarea id="field-subwishes" placeholder="–ß—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞? –û–Ω–ª–∞–π–Ω-–∑–∞–∫–∞–∑, –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, –≥–∞–ª–µ—Ä–µ—è, –æ—Ç–∑—ã–≤—ã..."></textarea></div>';
    fieldsHtml += '<div class="form-section-title">üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ</div>';
    fieldsHtml += '<div class="form-row">';
    fieldsHtml += '<div class="form-group"><label>–î–æ–º–µ–Ω (–µ—Å–ª–∏ –µ—Å—Ç—å)</label><input type="text" id="field-subdomain" placeholder="example.ru"></div>';
    fieldsHtml += '<div class="form-group"><label>–ë—é–¥–∂–µ—Ç</label><input type="text" id="field-subbudget" placeholder="–ë—é–¥–∂–µ—Ç –Ω–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É"></div>';
    fieldsHtml += '</div>';
    fieldsHtml += '<div class="form-row">';
    fieldsHtml += '<div class="form-group"><label>–î–µ–¥–ª–∞–π–Ω</label><input type="date" id="field-subdeadline"></div>';
    fieldsHtml += '<div class="form-group"><label>–°—Å—ã–ª–∫–∞ –Ω–∞ —Ç–µ–∫—É—â–∏–π —Å–∞–π—Ç</label><input type="text" id="field-suburl" placeholder="https://..."></div>';
    fieldsHtml += '</div>';
    fieldsHtml += '<div class="form-group"><label>–ö–æ–Ω—Ç–µ–Ω—Ç –≥–æ—Ç–æ–≤?</label><select id="field-subcontent"><option>–ù–µ—Ç, –Ω—É–∂–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å</option><option>–ß–∞—Å—Ç–∏—á–Ω–æ –≥–æ—Ç–æ–≤</option><option>–ü–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤</option></select></div>';
  }

  document.getElementById('modalBody').innerHTML = fieldsHtml;
  document.getElementById('modalOverlay').classList.add('show');
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('show');
  document.getElementById('modalBox').classList.remove('wide');
  currentModal = '';
  editingItem = null;
}

async function saveModal() {
  // Handle new project
  if (currentModal === 'newproject') {
    const name = document.getElementById('field-projname').value.trim();
    if (!name) { toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ','warning'); return; }
    const key = name.toLowerCase().replace(/[^a-z–∞-—è—ë0-9]/gi,'_');
    const emoji = document.getElementById('field-projemoji').value.trim() || 'üìÅ';
    const desc = document.getElementById('field-projdesc').value.trim();
    const color = document.getElementById('field-projcolor').value;

    PROJECTS[key] = {
      name: name, emoji: emoji, color: color,
      gradient: 'linear-gradient(90deg, '+color+', '+color+')',
      desc: desc, subprojects: {}, canAddSub: true
    };
    closeModal();
    renderAll();
    toast('‚úÖ –ü—Ä–æ–µ–∫—Ç ¬´'+name+'¬ª —Å–æ–∑–¥–∞–Ω!','success');
    return;
  }

  // Handle new subproject
  if (currentModal === 'newsubproject') {
    const name = document.getElementById('field-subname').value.trim();
    if (!name) { toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ','warning'); return; }
    const emoji = document.getElementById('field-subemoji').value.trim() || 'üìå';
    const desc = document.getElementById('field-subdesc').value.trim();
    const proj = PROJECTS[currentProject];
    if (!proj) return;

    proj.subprojects[name] = { emoji: emoji, color: proj.color, desc: desc };

    // If site project, save extra questionnaire fields
    if (proj.canAddSub) {
      const url = document.getElementById('field-suburl')?.value || '';
      const client = document.getElementById('field-subclient')?.value || '';
      const phone = document.getElementById('field-subphone')?.value || '';
      const bizname = document.getElementById('field-subbizname')?.value || '';
      const biztype = document.getElementById('field-subbiztype')?.value || '';
      const email = document.getElementById('field-subemail')?.value || '';
      const city = document.getElementById('field-subcity')?.value || '';
      const style = document.getElementById('field-substyle')?.value || '';
      const colors = document.getElementById('field-subcolors')?.value || '';
      const pages = document.getElementById('field-subpages')?.value || '';
      const wishes = document.getElementById('field-subwishes')?.value || '';
      const domain = document.getElementById('field-subdomain')?.value || '';
      const budget = document.getElementById('field-subbudget')?.value || '';
      const deadline = document.getElementById('field-subdeadline')?.value || '';
      const content = document.getElementById('field-subcontent')?.value || '';

      // Build questionnaire JSON for AI
      const questionnaire = JSON.stringify({
        bizname, biztype, client, phone, email, city,
        style, colors, pages, wishes, domain, budget, deadline, content, url
      }).substring(0, 900);

      await apiWrite('–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è', {
        ID: 'DIR'+String(Date.now()).slice(-6),
        '–ù–∞–∑–≤–∞–Ω–∏–µ': name,
        '–ü—Ä–æ–µ–∫—Ç': proj.name,
        'Emoji': emoji,
        '–û–ø–∏—Å–∞–Ω–∏–µ': desc,
        '–°—Å—ã–ª–∫–∞': url,
        '–ö–ª–∏–µ–Ω—Ç': client,
        '–¢–µ–ª–µ—Ñ–æ–Ω': phone,
        '–ì–æ—Ä–æ–¥': city,
        '–ë–∏–∑–Ω–µ—Å_—Ç–∏–ø': biztype,
        '–°—Ç–∏–ª—å': style,
        '–ê–Ω–∫–µ—Ç–∞': questionnaire,
        '–ë—é–¥–∂–µ—Ç': budget,
        '–î–µ–¥–ª–∞–π–Ω': deadline,
        '–î–∞—Ç–∞_—Å–æ–∑–¥–∞–Ω–∏—è': today()
      });
    }

    document.getElementById('modalBox').classList.remove('wide');
    closeModal();
    renderAll();
    if(currentProject) renderProjectView();
    toast('‚úÖ –ü–æ–¥–ø—Ä–æ–µ–∫—Ç ¬´'+name+'¬ª –¥–æ–±–∞–≤–ª–µ–Ω!','success');
    return;
  }

  // Standard form save
  const def = FORM_DEFS[currentModal];
  if(!def) return;

  for (const field of def.fields) {
    if (field.required) {
      const el = document.getElementById('field-'+field.name);
      if(!el||!el.value.trim()) { toast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ ¬´'+field.name+'¬ª','warning'); if(el)el.focus(); return; }
    }
  }

  const row = {};
  row.ID = editingItem ? editingItem.ID : currentModal.charAt(0).toUpperCase()+String(Date.now()).slice(-6);

  for (const field of def.fields) {
    const el = document.getElementById('field-'+field.name);
    row[field.name] = el ? el.value : '';
  }

  const td = today();
  if(def.sheet==='–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏'&&!editingItem) { row['–°—Ç–∞—Ç—É—Å']='–ê–∫—Ç–∏–≤–Ω—ã–π'; row['–î–∞—Ç–∞_–¥–æ–±–∞–≤–ª–µ–Ω–∏—è']=td; }
  if(def.sheet==='–ü—Ä–æ–µ–∫—Ç—ã') { if(!editingItem) row['–°–æ–∑–¥–∞–Ω–æ']=td; row['–û–±–Ω–æ–≤–ª–µ–Ω–æ']=td; }
  if(def.sheet==='–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏'&&!editingItem) { row['–î–∞—Ç–∞']=td; row['–ê–≤—Ç–æ—Ä']=USER?USER.name:''; }

  const perms = getUserPerms();
  if(!perms.canWrite && !editingItem) {
    const approvalRow = {
      ID: 'APR'+String(Date.now()).slice(-6),
      '–¢–∏–ø': '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ: '+def.title,
      '–û–ø–∏—Å–∞–Ω–∏–µ': row['–ù–∞–∑–≤–∞–Ω–∏–µ']||row['–û–ø–∏—Å–∞–Ω–∏–µ']||row['–ò–º—è']||row['–ü–∞—Ä—Ç–Ω—ë—Ä']||'',
      '–û—Ç_–∫–æ–≥–æ': USER?USER.name:'',
      'Telegram_ID': USER?USER.tgId:'',
      '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ': row['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'',
      '–°—Ç–∞—Ç—É—Å': '‚è≥ –û–∂–∏–¥–∞–µ—Ç',
      '–î–∞—Ç–∞_–∑–∞–ø—Ä–æ—Å–∞': td,
      '–î–∞–Ω–Ω—ã–µ': JSON.stringify(row).substring(0,500)
    };
    document.getElementById('modalSaveBtn').disabled = true;
    const ok = await apiWrite('–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è', approvalRow);
    document.getElementById('modalSaveBtn').disabled = false;
    if(ok) toast('‚è≥ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ','info');
    closeModal();
    setTimeout(loadData, 1500);
    return;
  }

  document.getElementById('modalSaveBtn').disabled = true;
  const ok = await apiWrite(def.sheet, row);
  document.getElementById('modalSaveBtn').disabled = false;
  if(ok) toast('‚úÖ '+def.title+' —Å–æ—Ö—Ä–∞–Ω—ë–Ω!','success');
  closeModal();
  setTimeout(loadData, 1500);
}

// ============================================================
// VIEW / EDIT / DELETE
// ============================================================
function viewItem(type, id) {
  const map = {partner:'partners',project:'projects',task:'tasks',staff:'staff',comm:'comms'};
  const item = DATA[map[type]]?.find(i => i.ID===id);
  if(!item) return;

  document.getElementById('detailTitle').textContent = 'üìã '+(item['–ù–∞–∑–≤–∞–Ω–∏–µ']||item['–û–ø–∏—Å–∞–Ω–∏–µ']||item['–ò–º—è']||item['–ü–∞—Ä—Ç–Ω—ë—Ä']||'–î–µ—Ç–∞–ª–∏');

  const fields = Object.entries(item).filter(([k])=>k!=='row_number');
  let html = '<div class="detail-grid">';
  for (const [k,v] of fields) {
    if(!v&&v!==0) continue;
    const long = String(v).length > 60;
    html += '<div class="detail-item '+(long?'detail-full':'')+'"><div class="detail-label">'+esc(k)+'</div><div class="detail-value">'+esc(v)+'</div></div>';
  }
  html += '</div>';
  document.getElementById('detailBody').innerHTML = html;
  document.getElementById('detailEditBtn').onclick = function() { closeDetail(); editItem(type,id); };
  document.getElementById('detailOverlay').classList.add('show');
}

function closeDetail() { document.getElementById('detailOverlay').classList.remove('show'); }

function editItem(type, id) {
  const map = {partner:'partners',project:'projects',task:'tasks',staff:'staff',comm:'comms'};
  const item = DATA[map[type]]?.find(i => i.ID===id);
  if(item) openModal(type, item);
}

function confirmDelete(type, id, name) {
  if(!getUserPerms().canDelete) { toast('‚õî –¢–æ–ª—å–∫–æ CEO','error'); return; }
  document.getElementById('confirmTitle').textContent = '–£–¥–∞–ª–∏—Ç—å?';
  document.getElementById('confirmText').textContent = '¬´'+(name||id)+'¬ª –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞.';
  document.getElementById('confirmOverlay').classList.add('show');
  confirmCallback = function(ok) {
    if(ok) {
      const map = {partner:'partners',project:'projects',task:'tasks',staff:'staff',comm:'comms'};
      if(DATA[map[type]]) DATA[map[type]] = DATA[map[type]].filter(i=>i.ID!==id);
      renderAll();
      toast('üóë –£–¥–∞–ª–µ–Ω–æ','warning');
    }
  };
}

function closeConfirm(r) {
  document.getElementById('confirmOverlay').classList.remove('show');
  if(confirmCallback) { confirmCallback(r); confirmCallback=null; }
}

// ============================================================
// APPROVALS
// ============================================================
async function handleApproval(id, approved) {
  const item = DATA.approvals.find(a=>a.ID===id);
  if(!item) return;
  item['–°—Ç–∞—Ç—É—Å'] = approved?'‚úÖ –û–¥–æ–±—Ä–µ–Ω–æ':'‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ';
  item['–î–∞—Ç–∞_—Ä–µ—à–µ–Ω–∏—è'] = today();
  item['–†–µ—à–µ–Ω–∏–µ_CEO'] = USER?USER.name:'';
  renderAll();
  toast(approved?'‚úÖ –û–¥–æ–±—Ä–µ–Ω–æ':'‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ', approved?'success':'error');
  await apiWrite('–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è', item);
}

// ============================================================
// CSV EXPORT
// ============================================================
function exportCSV(type) {
  const map = {partners:DATA.partners, tasks:DATA.tasks, projects:DATA.projects};
  const data = filterByRole(map[type]||[]);
  if(!data.length) { toast('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö','warning'); return; }
  const headers = Object.keys(data[0]).filter(k=>k!=='row_number');
  let csv = '\uFEFF' + headers.join(';')+'\n';
  data.forEach(r => { csv += headers.map(h=>'"'+String(r[h]||'').replace(/"/g,'""')+'"').join(';')+'\n'; });
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'RKT_'+type+'_'+today()+'.csv';
  a.click();
  toast('üì• –≠–∫—Å–ø–æ—Ä—Ç –≥–æ—Ç–æ–≤','success');
}

// ============================================================
// KEYBOARD
// ============================================================
document.addEventListener('keydown', function(e) {
  if(e.key==='Enter'&&document.getElementById('loginScreen').style.display!=='none') { doLogin(); return; }
  if(e.key==='Escape') {
    if(document.getElementById('confirmOverlay').classList.contains('show')) closeConfirm(false);
    else if(document.getElementById('detailOverlay').classList.contains('show')) closeDetail();
    else if(document.getElementById('modalOverlay').classList.contains('show')) closeModal();
  }
});

// ============================================================
// INIT ‚Äî Load saved subprojects from directions
// ============================================================
function loadSavedSubprojects() {
  // Load directions from sheet and add as subprojects to matching projects
  if (DATA.directions && DATA.directions.length) {
    DATA.directions.forEach(d => {
      const name = d['–ù–∞–∑–≤–∞–Ω–∏–µ'];
      const projName = d['–ü—Ä–æ–µ–∫—Ç'] || '';
      if (!name) return;
      // Find which project this belongs to
      for (const [key, proj] of Object.entries(PROJECTS)) {
        if (proj.name === projName && !proj.subprojects[name]) {
          proj.subprojects[name] = {
            emoji: d['Emoji'] || 'üìå',
            color: proj.color,
            desc: d['–û–ø–∏—Å–∞–Ω–∏–µ'] || ''
          };
        }
      }
    });
  }
}

// Override renderAll to include saved subprojects
const _origRenderAll = renderAll;
renderAll = function() {
  loadSavedSubprojects();
  _origRenderAll();
};

checkSavedLogin();
</script>
</body>
</html>
