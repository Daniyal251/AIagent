<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>–ó–∞–∫–∞–∑–∞—Ç—å —Å–∞–π—Ç ‚Äî –í–µ–±-—Å—Ç—É–¥–∏—è</title>
<meta name="description" content="–ó–∞–∫–∞–∂–∏—Ç–µ —Å–∞–π—Ç –¥–ª—è –≤–∞—à–µ–≥–æ –±–∏–∑–Ω–µ—Å–∞ –æ—Ç 5000‚ÇΩ. AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ–º–æ–∂–µ—Ç –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑ –∑–∞ 5 –º–∏–Ω—É—Ç.">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --bg: #0a0b0f;
  --bg2: #12131a;
  --bg3: #1a1b26;
  --bg4: #22243a;
  --surface: #1e2035;
  --border: rgba(255,255,255,0.06);
  --text: #e8e6f0;
  --text2: #9d9bb0;
  --text3: #6b6980;
  --accent: #7c6ff7;
  --accent2: #9b8aff;
  --accent-glow: rgba(124,111,247,0.15);
  --green: #4ade80;
  --green-bg: rgba(74,222,128,0.08);
  --orange: #fb923c;
  --orange-bg: rgba(251,146,60,0.08);
  --pink: #f472b6;
  --blue: #60a5fa;
  --red: #f87171;
  --yellow: #fbbf24;
  --radius: 16px;
  --radius-sm: 10px;
  --shadow: 0 8px 32px rgba(0,0,0,0.4);
}

* { margin:0; padding:0; box-sizing:border-box; }
html { scroll-behavior: smooth; }

body {
  font-family: 'Manrope', -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100dvh;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
}

/* ‚ïê‚ïê‚ïê NOISE TEXTURE ‚ïê‚ïê‚ïê */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
  pointer-events: none;
  z-index: 0;
}

/* ‚ïê‚ïê‚ïê GLOW ORBS ‚ïê‚ïê‚ïê */
.orb {
  position: fixed;
  border-radius: 50%;
  filter: blur(100px);
  pointer-events: none;
  z-index: 0;
}
.orb-1 { width: 500px; height: 500px; background: rgba(124,111,247,0.08); top: -150px; right: -150px; }
.orb-2 { width: 400px; height: 400px; background: rgba(244,114,182,0.06); bottom: 10%; left: -100px; }
.orb-3 { width: 300px; height: 300px; background: rgba(96,165,250,0.05); top: 50%; right: 10%; }

/* ‚ïê‚ïê‚ïê CONTAINER ‚ïê‚ïê‚ïê */
.container {
  max-width: 1100px;
  margin: 0 auto;
  padding: 0 20px;
  position: relative;
  z-index: 1;
}

/* ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê */
.header {
  padding: 20px 0;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.logo {
  display: flex;
  align-items: center;
  gap: 10px;
  text-decoration: none;
}
.logo-icon {
  width: 40px;
  height: 40px;
  border-radius: 12px;
  background: linear-gradient(135deg, var(--accent), var(--pink));
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  font-weight: 800;
  color: #fff;
  letter-spacing: -1px;
}
.logo-text {
  font-size: 18px;
  font-weight: 700;
  color: var(--text);
  letter-spacing: -0.3px;
}
.header-badge {
  padding: 6px 14px;
  border-radius: 20px;
  background: var(--green-bg);
  color: var(--green);
  font-size: 12px;
  font-weight: 600;
  border: 1px solid rgba(74,222,128,0.15);
}

/* ‚ïê‚ïê‚ïê HERO ‚ïê‚ïê‚ïê */
.hero {
  padding: 60px 0 40px;
  text-align: center;
}
.hero-eyebrow {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 8px 18px;
  border-radius: 30px;
  background: var(--accent-glow);
  border: 1px solid rgba(124,111,247,0.2);
  color: var(--accent2);
  font-size: 13px;
  font-weight: 600;
  margin-bottom: 24px;
}
.hero h1 {
  font-size: clamp(32px, 6vw, 56px);
  font-weight: 800;
  line-height: 1.1;
  letter-spacing: -1.5px;
  margin-bottom: 16px;
  background: linear-gradient(135deg, var(--text) 0%, var(--accent2) 50%, var(--pink) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
.hero p {
  font-size: clamp(16px, 2.5vw, 20px);
  color: var(--text2);
  max-width: 600px;
  margin: 0 auto 32px;
  line-height: 1.5;
}
.hero-cta {
  display: inline-flex;
  align-items: center;
  gap: 10px;
  padding: 16px 36px;
  border-radius: 14px;
  background: linear-gradient(135deg, var(--accent), #6c5ce7);
  color: #fff;
  font-size: 17px;
  font-weight: 700;
  border: none;
  cursor: pointer;
  transition: all 0.3s;
  text-decoration: none;
  box-shadow: 0 4px 24px rgba(124,111,247,0.3);
}
.hero-cta:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 32px rgba(124,111,247,0.5);
}
.hero-cta:active { transform: translateY(0); }

/* ‚ïê‚ïê‚ïê TRUST ‚ïê‚ïê‚ïê */
.trust {
  display: flex;
  justify-content: center;
  gap: 32px;
  padding: 24px 0;
  flex-wrap: wrap;
}
.trust-item {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
  color: var(--text3);
}
.trust-item span { font-size: 18px; }

/* ‚ïê‚ïê‚ïê PRICING CARDS ‚ïê‚ïê‚ïê */
.pricing-section {
  padding: 60px 0 40px;
}
.section-title {
  text-align: center;
  font-size: clamp(24px, 4vw, 36px);
  font-weight: 800;
  letter-spacing: -0.5px;
  margin-bottom: 8px;
}
.section-sub {
  text-align: center;
  color: var(--text2);
  font-size: 15px;
  margin-bottom: 40px;
}
.pricing-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
  gap: 16px;
}
.price-card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 24px;
  transition: all 0.3s;
  cursor: pointer;
  position: relative;
  overflow: hidden;
}
.price-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--accent), var(--pink));
  opacity: 0;
  transition: opacity 0.3s;
}
.price-card:hover {
  border-color: rgba(124,111,247,0.3);
  transform: translateY(-4px);
  box-shadow: 0 12px 40px rgba(0,0,0,0.3);
}
.price-card:hover::before { opacity: 1; }
.price-card.selected {
  border-color: var(--accent);
  background: rgba(124,111,247,0.05);
}
.price-card.selected::before { opacity: 1; }
.pc-emoji { font-size: 32px; margin-bottom: 12px; display: block; }
.pc-name { font-size: 17px; font-weight: 700; margin-bottom: 6px; }
.pc-desc { font-size: 13px; color: var(--text2); margin-bottom: 16px; line-height: 1.4; }
.pc-price {
  font-size: 24px;
  font-weight: 800;
  color: var(--accent2);
  letter-spacing: -0.5px;
}
.pc-price small { font-size: 14px; font-weight: 500; color: var(--text3); }
.pc-badge {
  position: absolute;
  top: 12px;
  right: 12px;
  padding: 3px 10px;
  border-radius: 8px;
  font-size: 11px;
  font-weight: 700;
  background: var(--orange-bg);
  color: var(--orange);
  border: 1px solid rgba(251,146,60,0.2);
}

/* ‚ïê‚ïê‚ïê ORDER FORM ‚ïê‚ïê‚ïê */
.order-section {
  padding: 40px 0 60px;
}
.order-form {
  max-width: 560px;
  margin: 0 auto;
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 32px;
  box-shadow: var(--shadow);
}
.of-title {
  font-size: 22px;
  font-weight: 800;
  margin-bottom: 4px;
  letter-spacing: -0.3px;
}
.of-sub {
  font-size: 14px;
  color: var(--text2);
  margin-bottom: 24px;
}
.of-group {
  margin-bottom: 16px;
}
.of-label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  color: var(--text2);
  margin-bottom: 6px;
}
.of-input {
  width: 100%;
  padding: 12px 16px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
  background: var(--bg3);
  color: var(--text);
  font-size: 15px;
  font-family: inherit;
  outline: none;
  transition: border-color 0.2s;
}
.of-input:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-glow);
}
.of-input::placeholder { color: var(--text3); }
select.of-input {
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%239d9bb0' fill='none' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 14px center;
  padding-right: 38px;
}
.of-selected-type {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 16px;
  border-radius: var(--radius-sm);
  background: var(--accent-glow);
  border: 1px solid rgba(124,111,247,0.2);
  margin-bottom: 16px;
  font-size: 14px;
}
.of-selected-type .emoji { font-size: 24px; }
.of-selected-type .info { flex: 1; }
.of-selected-type .name { font-weight: 700; font-size: 15px; }
.of-selected-type .price { color: var(--accent2); font-weight: 600; }
.of-selected-type .change {
  padding: 4px 12px;
  border-radius: 8px;
  background: var(--bg3);
  border: 1px solid var(--border);
  color: var(--text2);
  font-size: 12px;
  cursor: pointer;
  font-family: inherit;
}

.of-submit {
  width: 100%;
  padding: 14px;
  border-radius: var(--radius-sm);
  background: linear-gradient(135deg, var(--accent), #6c5ce7);
  color: #fff;
  font-size: 16px;
  font-weight: 700;
  font-family: inherit;
  border: none;
  cursor: pointer;
  transition: all 0.3s;
  margin-top: 8px;
  box-shadow: 0 4px 20px rgba(124,111,247,0.3);
}
.of-submit:hover { box-shadow: 0 8px 32px rgba(124,111,247,0.5); transform: translateY(-1px); }
.of-submit:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

/* ‚ïê‚ïê‚ïê AI CHAT SCREEN ‚ïê‚ïê‚ïê */
.chat-screen {
  display: none;
  position: fixed;
  inset: 0;
  z-index: 100;
  background: var(--bg);
  flex-direction: column;
}
.chat-screen.active { display: flex; }

.chat-header {
  padding: 16px 20px;
  background: var(--bg2);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 12px;
  flex-shrink: 0;
}
.chat-back {
  width: 36px;
  height: 36px;
  border-radius: 10px;
  background: var(--bg3);
  border: 1px solid var(--border);
  color: var(--text);
  font-size: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: background 0.2s;
}
.chat-back:hover { background: var(--bg4); }
.chat-info { flex: 1; }
.chat-name { font-size: 15px; font-weight: 700; }
.chat-status { font-size: 12px; color: var(--green); font-weight: 500; }

.chat-progress {
  padding: 10px 20px;
  background: var(--bg2);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
.cp-row { display: flex; justify-content: space-between; font-size: 12px; color: var(--text2); margin-bottom: 6px; }
.cp-bar { height: 4px; border-radius: 2px; background: var(--bg4); overflow: hidden; }
.cp-fill { height: 100%; border-radius: 2px; background: linear-gradient(90deg, var(--accent), var(--green)); transition: width 0.5s ease; }

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  scroll-behavior: smooth;
}

.msg {
  max-width: 85%;
  padding: 12px 16px;
  border-radius: 16px;
  font-size: 14px;
  line-height: 1.55;
  word-break: break-word;
  animation: msgIn 0.3s ease;
}
@keyframes msgIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}
.msg.assistant {
  align-self: flex-start;
  background: var(--bg3);
  border: 1px solid var(--border);
  border-bottom-left-radius: 4px;
  color: var(--text);
}
.msg.user {
  align-self: flex-end;
  background: linear-gradient(135deg, var(--accent), #6c5ce7);
  color: #fff;
  border-bottom-right-radius: 4px;
}
.msg.system {
  align-self: center;
  background: var(--orange-bg);
  border: 1px solid rgba(251,146,60,0.15);
  color: var(--orange);
  font-size: 13px;
  text-align: center;
  max-width: 90%;
}
.msg img {
  max-width: 100%;
  max-height: 240px;
  border-radius: 10px;
  margin-top: 6px;
  cursor: pointer;
}
.msg b { font-weight: 700; }

.typing-dots {
  display: flex;
  gap: 5px;
  padding: 4px 0;
}
.typing-dots span {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--text3);
  animation: blink 1.4s infinite both;
}
.typing-dots span:nth-child(2) { animation-delay: 0.2s; }
.typing-dots span:nth-child(3) { animation-delay: 0.4s; }
@keyframes blink {
  0%, 80%, 100% { opacity: 0.3; transform: scale(0.8); }
  40% { opacity: 1; transform: scale(1); }
}

.chat-input-area {
  padding: 12px 16px;
  background: var(--bg2);
  border-top: 1px solid var(--border);
  display: flex;
  gap: 10px;
  align-items: flex-end;
  flex-shrink: 0;
}
.chat-attach {
  width: 42px;
  height: 42px;
  border-radius: 12px;
  background: var(--bg3);
  border: 1px solid var(--border);
  color: var(--text2);
  font-size: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  flex-shrink: 0;
  transition: all 0.2s;
}
.chat-attach:hover { background: var(--bg4); color: var(--text); }
.chat-textarea {
  flex: 1;
  padding: 10px 14px;
  border-radius: 12px;
  border: 1px solid var(--border);
  background: var(--bg3);
  color: var(--text);
  font-size: 15px;
  font-family: inherit;
  resize: none;
  outline: none;
  min-height: 42px;
  max-height: 120px;
  line-height: 1.4;
  transition: border-color 0.2s;
}
.chat-textarea:focus {
  border-color: var(--accent);
}
.chat-textarea::placeholder { color: var(--text3); }
.chat-send {
  width: 42px;
  height: 42px;
  border-radius: 12px;
  background: linear-gradient(135deg, var(--accent), #6c5ce7);
  border: none;
  color: #fff;
  font-size: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  flex-shrink: 0;
  transition: all 0.2s;
  box-shadow: 0 2px 12px rgba(124,111,247,0.3);
}
.chat-send:hover { transform: scale(1.05); }
.chat-send:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

.media-preview {
  display: none;
  padding: 8px 16px 0;
  background: var(--bg2);
  gap: 8px;
  flex-wrap: wrap;
}
.media-preview.show { display: flex; }
.media-thumb {
  width: 60px;
  height: 60px;
  border-radius: 8px;
  object-fit: cover;
  border: 2px solid var(--border);
}
.media-remove {
  position: absolute;
  top: -4px;
  right: -4px;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: var(--red);
  color: #fff;
  font-size: 12px;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}
.media-item {
  position: relative;
}

/* ‚ïê‚ïê‚ïê PORTFOLIO ‚ïê‚ïê‚ïê */
.portfolio-section {
  padding: 40px 0;
}
.portfolio-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 16px;
}
.port-card {
  border-radius: var(--radius);
  overflow: hidden;
  background: var(--bg2);
  border: 1px solid var(--border);
  transition: all 0.3s;
}
.port-card:hover { transform: translateY(-3px); box-shadow: var(--shadow); }
.port-img {
  width: 100%;
  height: 180px;
  background: linear-gradient(135deg, var(--bg3), var(--bg4));
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 48px;
}
.port-info { padding: 16px; }
.port-name { font-size: 15px; font-weight: 700; margin-bottom: 4px; }
.port-desc { font-size: 13px; color: var(--text2); }

/* ‚ïê‚ïê‚ïê FAQ ‚ïê‚ïê‚ïê */
.faq-section { padding: 40px 0 60px; }
.faq-item {
  border-bottom: 1px solid var(--border);
  padding: 18px 0;
}
.faq-q {
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.faq-q::after { content: '+'; font-size: 20px; color: var(--text3); transition: transform 0.2s; }
.faq-item.open .faq-q::after { content: '‚àí'; color: var(--accent); }
.faq-a {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s, padding 0.3s;
  font-size: 14px;
  color: var(--text2);
  line-height: 1.6;
}
.faq-item.open .faq-a { max-height: 200px; padding-top: 12px; }

/* ‚ïê‚ïê‚ïê FOOTER ‚ïê‚ïê‚ïê */
.footer {
  padding: 30px 0;
  text-align: center;
  border-top: 1px solid var(--border);
  font-size: 13px;
  color: var(--text3);
}

/* ‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê */
.toast-msg {
  position: fixed;
  bottom: 80px;
  left: 50%;
  transform: translateX(-50%) translateY(20px);
  padding: 10px 24px;
  border-radius: 12px;
  background: var(--bg3);
  border: 1px solid var(--border);
  color: var(--text);
  font-size: 14px;
  font-weight: 500;
  z-index: 999;
  opacity: 0;
  transition: all 0.3s;
  box-shadow: var(--shadow);
  pointer-events: none;
}
.toast-msg.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* ‚ïê‚ïê‚ïê LOADING ‚ïê‚ïê‚ïê */
.loading-screen {
  position: fixed;
  inset: 0;
  background: var(--bg);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 200;
  flex-direction: column;
  gap: 16px;
}
.loader {
  width: 40px;
  height: 40px;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* ‚ïê‚ïê‚ïê SAFE AREA ‚ïê‚ïê‚ïê */
@supports (padding-bottom: env(safe-area-inset-bottom)) {
  .chat-input-area { padding-bottom: calc(12px + env(safe-area-inset-bottom)); }
}

/* ‚ïê‚ïê‚ïê MOBILE ‚ïê‚ïê‚ïê */
@media (max-width: 640px) {
  .hero { padding: 40px 0 24px; }
  .hero h1 { font-size: 28px; letter-spacing: -0.5px; }
  .hero p { font-size: 15px; }
  .trust { gap: 16px; }
  .trust-item { font-size: 12px; }
  .pricing-grid { grid-template-columns: 1fr 1fr; gap: 10px; }
  .price-card { padding: 16px; }
  .pc-emoji { font-size: 24px; margin-bottom: 8px; }
  .pc-name { font-size: 14px; }
  .pc-desc { font-size: 12px; margin-bottom: 10px; }
  .pc-price { font-size: 20px; }
  .order-form { padding: 24px 20px; }
  .container { padding: 0 16px; }
  .section-title { font-size: 22px; }
  .chat-messages { padding: 14px; }
  .msg { max-width: 90%; font-size: 14px; }
}
</style>
</head>
<body>

<!-- Background orbs -->
<div class="orb orb-1"></div>
<div class="orb orb-2"></div>
<div class="orb orb-3"></div>

<!-- Loading screen -->
<div class="loading-screen" id="loadingScreen">
  <div class="loader"></div>
  <div style="color:var(--text2);font-size:14px">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>

<!-- ‚ïê‚ïê‚ïê LANDING PAGE ‚ïê‚ïê‚ïê -->
<div id="landingPage">

  <div class="container">
    <!-- Header -->
    <div class="header">
      <a href="#" class="logo">
        <div class="logo-icon">S</div>
        <div class="logo-text">–°–∞–π—Ç—ã</div>
      </a>
      <div class="header-badge">‚úì –î–µ–ª–∞–µ–º –∑–∞ 3 –¥–Ω—è</div>
    </div>

    <!-- Hero -->
    <div class="hero">
      <div class="hero-eyebrow">üöÄ –°–∞–π—Ç –¥–ª—è –≤–∞—à–µ–≥–æ –±–∏–∑–Ω–µ—Å–∞</div>
      <h1>–°–∞–π—Ç, –∫–æ—Ç–æ—Ä—ã–π<br>–ø—Ä–∏–≤–æ–¥–∏—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤</h1>
      <p>AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Å–æ–±–µ—Ä—ë—Ç –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∑–∞ 5 –º–∏–Ω—É—Ç. –í—ã –ø–æ–ª—É—á–∏—Ç–µ –≥–æ—Ç–æ–≤—ã–π —Å–∞–π—Ç —á–µ—Ä–µ–∑ 3 –¥–Ω—è. –û—Ç 5 000‚ÇΩ.</p>
      <a href="#order" class="hero-cta" onclick="scrollToOrder(event)">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑ ‚Üí</a>
    </div>

    <!-- Trust -->
    <div class="trust">
      <div class="trust-item"><span>‚ö°</span> –ì–æ—Ç–æ–≤–æ –∑–∞ 3 –¥–Ω—è</div>
      <div class="trust-item"><span>üí∞</span> –û—Ç 5 000‚ÇΩ</div>
      <div class="trust-item"><span>üîÑ</span> –ü—Ä–∞–≤–∫–∏ –±–µ—Å–ø–ª–∞—Ç–Ω–æ</div>
      <div class="trust-item"><span>üì±</span> –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –¥–∏–∑–∞–π–Ω</div>
    </div>

    <!-- Pricing -->
    <div class="pricing-section" id="pricing">
      <div class="section-title">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Å–∞–π—Ç–∞</div>
      <div class="section-sub">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞</div>
      <div class="pricing-grid" id="pricingGrid"></div>
    </div>

    <!-- Order Form -->
    <div class="order-section" id="order">
      <div class="order-form" id="orderForm">
        <div class="of-title">üìã –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</div>
        <div class="of-sub">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É ‚Äî AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Å–æ–±–µ—Ä—ë—Ç –¥–µ—Ç–∞–ª–∏</div>
        
        <div id="selectedTypeBlock" style="display:none"></div>

        <div class="of-group">
          <label class="of-label">–ù–∞–∑–≤–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å–∞ *</label>
          <input class="of-input" id="ofName" placeholder="–ü—Ä–∏–º–µ—Ä: –ö–∞—Ñ–µ ¬´–£—é—Ç¬ª" autocomplete="organization">
        </div>
        <div class="of-group">
          <label class="of-label">–í–∞—à–µ –∏–º—è</label>
          <input class="of-input" id="ofContact" placeholder="–ö–∞–∫ –∫ –≤–∞–º –æ–±—Ä–∞—â–∞—Ç—å—Å—è?" autocomplete="name">
        </div>
        <div class="of-group" style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div>
            <label class="of-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
            <input class="of-input" id="ofPhone" placeholder="+7..." type="tel" autocomplete="tel">
          </div>
          <div>
            <label class="of-label">–ì–æ—Ä–æ–¥</label>
            <input class="of-input" id="ofCity" placeholder="–ú–æ—Å–∫–≤–∞" autocomplete="address-level2">
          </div>
        </div>
        <div class="of-group" id="typeSelectGroup">
          <label class="of-label">–¢–∏–ø —Å–∞–π—Ç–∞</label>
          <select class="of-input" id="ofType"></select>
        </div>
        <div class="of-group">
          <label class="of-label">–°—Å—ã–ª–∫–∞ –Ω–∞ –±–∏–∑–Ω–µ—Å (–Ø–Ω–¥–µ–∫—Å –∫–∞—Ä—Ç—ã, Instagram, 2–ì–ò–°)</label>
          <input class="of-input" id="ofLink" placeholder="https://..." type="url">
        </div>

        <button class="of-submit" id="ofSubmit" onclick="submitOrder()">
          ü§ñ –ù–∞—á–∞—Ç—å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ —Å AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º
        </button>
        <div style="text-align:center;margin-top:10px;font-size:12px;color:var(--text3)">
          –ë–µ—Å–ø–ª–∞—Ç–Ω–æ –∏ –±–µ–∑ –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤. AI –∑–∞–¥–∞—Å—Ç —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã.
        </div>
      </div>
    </div>

    <!-- Portfolio -->
    <div class="portfolio-section" id="portfolio">
      <div class="section-title">–ù–∞—à–∏ —Ä–∞–±–æ—Ç—ã</div>
      <div class="section-sub">–ü—Ä–∏–º–µ—Ä—ã —Å–∞–π—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –º—ã —Å–æ–∑–¥–∞–ª–∏</div>
      <div class="portfolio-grid" id="portfolioGrid"></div>
    </div>

    <!-- FAQ -->
    <div class="faq-section">
      <div class="section-title">–ß–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã</div>
      <div class="section-sub">–û—Ç–≤–µ—Ç—ã –Ω–∞ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã</div>
      <div id="faqList"></div>
    </div>

    <!-- Footer -->
    <div class="footer">
      ¬© 2025 –í–µ–±-—Å—Ç—É–¥–∏—è ¬∑ <a href="#" style="color:var(--accent);text-decoration:none">Telegram</a>
    </div>
  </div>

</div>

<!-- ‚ïê‚ïê‚ïê AI CHAT SCREEN ‚ïê‚ïê‚ïê -->
<div class="chat-screen" id="chatScreen">
  <div class="chat-header">
    <button class="chat-back" onclick="backToLanding()">‚Üê</button>
    <div style="width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--pink));display:flex;align-items:center;justify-content:center;font-size:18px">ü§ñ</div>
    <div class="chat-info">
      <div class="chat-name">AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç</div>
      <div class="chat-status" id="chatStatus">‚óè –æ–Ω–ª–∞–π–Ω</div>
    </div>
  </div>
  <div class="chat-progress">
    <div class="cp-row">
      <span>–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∞–Ω–∫–µ—Ç—ã</span>
      <span id="cpPct">0%</span>
    </div>
    <div class="cp-bar"><div class="cp-fill" id="cpFill" style="width:0%"></div></div>
  </div>
  <div class="chat-messages" id="chatMessages"></div>
  <div class="media-preview" id="mediaPreview"></div>
  <div class="chat-input-area">
    <button class="chat-attach" onclick="attachFiles()">üìé</button>
    <textarea class="chat-textarea" id="chatInput" rows="1" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –æ—Ç–≤–µ—Ç..." 
      oninput="autoResize(this)" 
      onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMessage()}"></textarea>
    <button class="chat-send" id="chatSendBtn" onclick="sendMessage()">‚û§</button>
    <input type="file" id="fileInput" multiple accept="image/*,.pdf,.doc,.docx" style="display:none" onchange="filesSelected(this)">
  </div>
</div>

<!-- Toast -->
<div class="toast-msg" id="toastEl"></div>

<script>
// ‚ïê‚ïê‚ïê CONFIG ‚ïê‚ïê‚ïê
const SUPABASE_URL = 'https://prparzgqevfelwsndmkc.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBycGFyemdxZXZmZWx3c25kbWtjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM1MTM5NDIsImV4cCI6MjA1OTA4OTk0Mn0.D3xHFWu7WwVsLZMh-vs-Hv2Fo8k1GFoFQXOLuJ3i6Ew';
const AI_URL = 'https://daniyal2212.app.n8n.cloud/webhook/rkt-ai';

const SB = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const PRICING = {
  '–í–∏–∑–∏—Ç–∫–∞':     { price: 5000,  emoji: 'üìÑ', desc: '1‚Äì3 —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –±–∞–∑–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', badge: '' },
  '–õ–µ–Ω–¥–∏–Ω–≥':     { price: 10000, emoji: 'üéØ', desc: '–ü—Ä–æ–¥–∞—é—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –∞–Ω–∏–º–∞—Ü–∏—è–º–∏', badge: '–ü–æ–ø—É–ª—è—Ä–Ω—ã–π' },
  '–ö–∞—Ç–∞–ª–æ–≥':     { price: 15000, emoji: 'üõí', desc: '5+ —Å—Ç—Ä–∞–Ω–∏—Ü, –∫–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤/—É—Å–ª—É–≥', badge: '' },
  '–ü—Ä–µ–º–∏—É–º':     { price: 25000, emoji: '‚≠ê', desc: '–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –¥–∏–∑–∞–π–Ω, SEO, CRM', badge: '' },
  '–°–≤–∞–¥–µ–±–Ω—ã–π':   { price: 8000,  emoji: 'üíç', desc: '–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ, RSVP, —Ñ–æ—Ç–æ–≥–∞–ª–µ—Ä–µ—è', badge: '' },
  '–ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ':   { price: 7000,  emoji: 'üé®', desc: '–ì–∞–ª–µ—Ä–µ—è —Ä–∞–±–æ—Ç, —Ä–µ–∑—é–º–µ, –∫–æ–Ω—Ç–∞–∫—Ç—ã', badge: '' },
  '–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ':  { price: 8000,  emoji: 'üéâ', desc: '–°–æ–±—ã—Ç–∏–µ, –ø—Ä–æ–≥—Ä–∞–º–º–∞, —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è', badge: '' },
  '–ë–ª–æ–≥/–ú–µ–¥–∏–∞':  { price: 10000, emoji: 'üì∞', desc: '–ë–ª–æ–≥, —Å—Ç–∞—Ç—å–∏, –º–µ–¥–∏–∞–∫–æ–Ω—Ç–µ–Ω—Ç', badge: '' }
};

const FAQ_DATA = [
  { q: '–°–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–Ω–∏–º–∞–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ —Å–∞–π—Ç–∞?', a: '–°–∞–π—Ç-–≤–∏–∑–∏—Ç–∫–∞ ‚Äî 1‚Äì2 –¥–Ω—è, –ª–µ–Ω–¥–∏–Ω–≥ ‚Äî 2‚Äì3 –¥–Ω—è, –∫–∞—Ç–∞–ª–æ–≥ ‚Äî 3‚Äì5 –¥–Ω–µ–π. –ú—ã –Ω–∞—á–∏–Ω–∞–µ–º —Ä–∞–±–æ—Ç—É —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞.' },
  { q: '–ß—Ç–æ –≤—Ö–æ–¥–∏—Ç –≤ —Å—Ç–æ–∏–º–æ—Å—Ç—å?', a: '–î–∏–∑–∞–π–Ω, –≤—ë—Ä—Å—Ç–∫–∞, –∞–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ –º–æ–±–∏–ª—å–Ω—ã–µ, –±–∞–∑–æ–≤–∞—è SEO-–Ω–∞—Å—Ç—Ä–æ–π–∫–∞, —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ –Ω–∞ —Ö–æ—Å—Ç–∏–Ω–≥–µ. –î–æ–º–µ–Ω –∏ —Ö–æ—Å—Ç–∏–Ω–≥ –Ω–∞ –≥–æ–¥ ‚Äî –æ—Ç–¥–µ–ª—å–Ω–æ –∑–∞ 3 000‚ÇΩ.' },
  { q: '–ù—É–∂–Ω–æ –ª–∏ –º–Ω–µ —á—Ç–æ-—Ç–æ –¥–µ–ª–∞—Ç—å?', a: '–ú–∏–Ω–∏–º—É–º! AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∑–∞–¥–∞—Å—Ç –≤–æ–ø—Ä–æ—Å—ã –æ –≤–∞—à–µ–º –±–∏–∑–Ω–µ—Å–µ, –∞ –≤—ã –ø—Ä–æ—Å—Ç–æ –æ—Ç–≤–µ—Ç–∏—Ç–µ. –ú–æ–∂–Ω–æ –ø—Ä–∏—Å–ª–∞—Ç—å —Ñ–æ—Ç–æ ‚Äî –∏ –º—ã —Å–¥–µ–ª–∞–µ–º –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ.' },
  { q: '–ú–æ–∂–Ω–æ –ª–∏ –≤–Ω–æ—Å–∏—Ç—å –ø—Ä–∞–≤–∫–∏?', a: '–î–∞, –æ–¥–Ω–∞ –∏—Ç–µ—Ä–∞—Ü–∏—è –ø—Ä–∞–≤–æ–∫ –≤—Ö–æ–¥–∏—Ç –≤ —Å—Ç–æ–∏–º–æ—Å—Ç—å. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∫–∏ ‚Äî –ø–æ –¥–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç–∏.' },
  { q: '–ö–∞–∫–∏–µ —Å–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã?', a: '–ü–µ—Ä–µ–≤–æ–¥ –Ω–∞ –∫–∞—Ä—Ç—É, –ø–æ —Å—á—ë—Ç—É –¥–ª—è —é—Ä–ª–∏—Ü. –û–ø–ª–∞—Ç–∞ –ø–æ—Å–ª–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –º–∞–∫–µ—Ç–∞ ‚Äî –Ω–∏–∫–∞–∫–∏—Ö –ø—Ä–µ–¥–æ–ø–ª–∞—Ç.' },
  { q: '–ß—Ç–æ –µ—Å–ª–∏ –º–Ω–µ –Ω–µ –ø–æ–Ω—Ä–∞–≤–∏—Ç—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç?', a: '–ú—ã –ø–æ–∫–∞–∂–µ–º –¥–µ–º–æ-–≤–µ—Ä—Å–∏—é —Å–∞–π—Ç–∞ –¥–æ –æ–ø–ª–∞—Ç—ã. –ï—Å–ª–∏ –Ω–µ –ø–æ–¥–æ–π–¥—ë—Ç ‚Äî –≤—ã –Ω–∏—á–µ–≥–æ –Ω–µ –ø–ª–∞—Ç–∏—Ç–µ.' }
];

const PORTFOLIO_DATA = [
  { name: '–ü—ã—à–∫–∏ –º–∏—Ä–∞', desc: '–†–µ—Å—Ç–æ—Ä–∞–Ω ‚Äî –∫–∞—Ç–∞–ª–æ–≥ –º–µ–Ω—é + –¥–æ—Å—Ç–∞–≤–∫–∞', emoji: 'üç©' },
  { name: '–†–µ—Å—Ç–æ–∫–ª—É–± –ë—Ä–µ–∂–Ω–µ–≤', desc: '–†–µ—Å—Ç–æ—Ä–∞–Ω ‚Äî –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ + –º–µ–Ω—é', emoji: 'üçΩÔ∏è' },
  { name: '–ö–µ—Ä–∞—Ç–∏–Ω –ê–≥—Ä—ã–∑', desc: '–°–∞–ª–æ–Ω –∫—Ä–∞—Å–æ—Ç—ã ‚Äî —É—Å–ª—É–≥–∏ + –∑–∞–ø–∏—Å—å', emoji: 'üíá' }
];

// ‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê
let selectedType = '';
let currentDir = null;
let clientToken = '';
let chatHistory = [];
let pendingFiles = [];
let sending = false;

// ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded', () => {
  renderPricing();
  renderFAQ();
  renderPortfolio();
  populateTypeSelect();

  // Check for token in URL
  const params = new URLSearchParams(window.location.search);
  const token = params.get('token') || params.get('client');

  if (token) {
    loadExistingClient(token);
  } else {
    hideLoading();
  }
});

function hideLoading() {
  const el = document.getElementById('loadingScreen');
  el.style.opacity = '0';
  setTimeout(() => el.style.display = 'none', 300);
}

// ‚ïê‚ïê‚ïê RENDER PRICING ‚ïê‚ïê‚ïê
function renderPricing() {
  const grid = document.getElementById('pricingGrid');
  let html = '';
  for (const [name, p] of Object.entries(PRICING)) {
    html += `<div class="price-card" onclick="selectPricing('${esc(name)}')" data-type="${esc(name)}">
      ${p.badge ? '<div class="pc-badge">' + p.badge + '</div>' : ''}
      <span class="pc-emoji">${p.emoji}</span>
      <div class="pc-name">${esc(name)}</div>
      <div class="pc-desc">${esc(p.desc)}</div>
      <div class="pc-price">${p.price.toLocaleString('ru')}‚ÇΩ</div>
    </div>`;
  }
  grid.innerHTML = html;
}

function selectPricing(type) {
  selectedType = type;
  // Highlight card
  document.querySelectorAll('.price-card').forEach(c => c.classList.remove('selected'));
  const card = document.querySelector(`.price-card[data-type="${type}"]`);
  if (card) card.classList.add('selected');

  // Update form
  const p = PRICING[type];
  document.getElementById('selectedTypeBlock').style.display = 'block';
  document.getElementById('selectedTypeBlock').innerHTML = `
    <div class="of-selected-type">
      <div class="emoji">${p.emoji}</div>
      <div class="info">
        <div class="name">${esc(type)}</div>
        <div class="price">${p.price.toLocaleString('ru')}‚ÇΩ ¬∑ ${esc(p.desc)}</div>
      </div>
      <button class="change" onclick="clearSelection()">–ò–∑–º–µ–Ω–∏—Ç—å</button>
    </div>`;
  document.getElementById('typeSelectGroup').style.display = 'none';
  document.getElementById('ofType').value = type;

  // Scroll to form
  document.getElementById('order').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function clearSelection() {
  selectedType = '';
  document.querySelectorAll('.price-card').forEach(c => c.classList.remove('selected'));
  document.getElementById('selectedTypeBlock').style.display = 'none';
  document.getElementById('typeSelectGroup').style.display = 'block';
  document.getElementById('ofType').value = '';
}

function populateTypeSelect() {
  const sel = document.getElementById('ofType');
  sel.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø ‚Äî</option>';
  for (const [name, p] of Object.entries(PRICING)) {
    sel.innerHTML += `<option value="${esc(name)}">${p.emoji} ${esc(name)} ‚Äî ${p.price.toLocaleString('ru')}‚ÇΩ</option>`;
  }
  sel.innerHTML += '<option value="–î—Ä—É–≥–æ–µ">üìå –î—Ä—É–≥–æ–µ (–æ–±—Å—É–¥–∏–º)</option>';
}

// ‚ïê‚ïê‚ïê RENDER FAQ ‚ïê‚ïê‚ïê
function renderFAQ() {
  const list = document.getElementById('faqList');
  list.innerHTML = FAQ_DATA.map((f, i) => `
    <div class="faq-item" onclick="this.classList.toggle('open')">
      <div class="faq-q">${esc(f.q)}</div>
      <div class="faq-a">${esc(f.a)}</div>
    </div>
  `).join('');
}

// ‚ïê‚ïê‚ïê RENDER PORTFOLIO ‚ïê‚ïê‚ïê
function renderPortfolio() {
  const grid = document.getElementById('portfolioGrid');
  grid.innerHTML = PORTFOLIO_DATA.map(p => `
    <div class="port-card">
      <div class="port-img">${p.emoji}</div>
      <div class="port-info">
        <div class="port-name">${esc(p.name)}</div>
        <div class="port-desc">${esc(p.desc)}</div>
      </div>
    </div>
  `).join('');
}

// ‚ïê‚ïê‚ïê SCROLL ‚ïê‚ïê‚ïê
function scrollToOrder(e) {
  e.preventDefault();
  document.getElementById('order').scrollIntoView({ behavior: 'smooth' });
}

// ‚ïê‚ïê‚ïê SUBMIT ORDER ‚ïê‚ïê‚ïê
async function submitOrder() {
  const name = document.getElementById('ofName').value.trim();
  if (!name) { toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å–∞'); document.getElementById('ofName').focus(); return; }

  const contact = document.getElementById('ofContact').value.trim();
  const phone = document.getElementById('ofPhone').value.trim();
  const city = document.getElementById('ofCity').value.trim();
  const type = selectedType || document.getElementById('ofType').value || '–õ–µ–Ω–¥–∏–Ω–≥';
  const link = document.getElementById('ofLink').value.trim();
  const pricing = PRICING[type] || { price: 0 };

  const btn = document.getElementById('ofSubmit');
  btn.disabled = true;
  btn.textContent = '‚è≥ –°–æ–∑–¥–∞—ë–º –∑–∞–∫–∞–∑...';

  try {
    // Generate unique token for this client
    const token = generateToken();

    // Create direction in Supabase
    const row = {
      name: name,
      project: '–°–∞–π—Ç—ã',
      status: '–í —Ä–∞–±–æ—Ç–µ',
      stage: 'prospect',
      site_type: type,
      price: pricing.price || 0,
      paid: false,
      client_name: contact || name,
      phone: phone,
      city: city,
      link: link,
      source: '–û–Ω–ª–∞–π–Ω-–∑–∞—è–≤–∫–∞',
      next_contact: new Date(Date.now() + 86400000).toISOString().slice(0, 10),
      manager: '',
      touches: 0,
      created_at: new Date().toISOString().slice(0, 10),
      client_token: token,
      questionnaire: JSON.stringify({
        _version: 2,
        _source: 'client_order_form',
        _created: new Date().toISOString(),
        business_info: { name, type: type, city, link },
        contact: { name: contact, phone }
      })
    };

    const { data, error } = await SB.from('directions').insert(row).select();
    if (error) throw error;

    currentDir = data[0];
    clientToken = token;

    // Save token to localStorage for return visits
    localStorage.setItem('rkt_order_token', token);

    // Notify team via n8n (non-blocking)
    notifyTeam(name, type, phone, city).catch(e => console.warn('Notify failed:', e));

    // Open chat
    openChat();

  } catch(e) {
    console.error('Submit error:', e);
    toast('–û—à–∏–±–∫–∞: ' + (e.message || '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑'));
    btn.disabled = false;
    btn.textContent = 'ü§ñ –ù–∞—á–∞—Ç—å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ —Å AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º';
  }
}

// ‚ïê‚ïê‚ïê LOAD EXISTING CLIENT ‚ïê‚ïê‚ïê
async function loadExistingClient(token) {
  try {
    const { data, error } = await SB.from('directions').select('*').eq('client_token', token).single();
    if (error || !data) {
      hideLoading();
      toast('–°—Å—ã–ª–∫–∞ —É—Å—Ç–∞—Ä–µ–ª–∞. –û—Ñ–æ—Ä–º–∏—Ç–µ –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑.');
      return;
    }

    currentDir = data;
    clientToken = token;

    // Load chat history
    const dirId = data.id;
    const { data: msgs } = await SB.from('anketa_chat').select('*').eq('direction_id', dirId).order('created_at', { ascending: true });
    chatHistory = msgs || [];

    hideLoading();
    openChat(true);

  } catch(e) {
    console.error('Load error:', e);
    hideLoading();
    toast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
  }
}

// ‚ïê‚ïê‚ïê CHAT ‚ïê‚ïê‚ïê
function openChat(skipGreeting) {
  document.getElementById('landingPage').style.display = 'none';
  document.getElementById('chatScreen').classList.add('active');
  hideLoading();

  const msgs = document.getElementById('chatMessages');
  msgs.innerHTML = '';

  // Render existing messages
  chatHistory.forEach(m => {
    if (m.role === 'user' || m.role === 'assistant') {
      appendMsg(m.role, m.content, m.media_urls);
    }
  });

  // Update progress
  if (currentDir) {
    updateProgress(currentDir.anketa_completeness || 0);
  }

  // Auto-greeting if new
  if (!skipGreeting || !chatHistory.length) {
    sendAutoGreeting();
  }

  // Scroll to bottom
  msgs.scrollTop = msgs.scrollHeight;

  // Focus input
  setTimeout(() => document.getElementById('chatInput').focus(), 300);
}

function backToLanding() {
  document.getElementById('chatScreen').classList.remove('active');
  document.getElementById('landingPage').style.display = 'block';
}

function appendMsg(role, content, mediaUrls) {
  const container = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = 'msg ' + role;

  let html = '';
  if (mediaUrls && Array.isArray(mediaUrls) && mediaUrls.length) {
    html += '<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:6px">';
    mediaUrls.forEach(m => {
      if ((m.type === 'image' || /\.(jpg|jpeg|png|gif|webp)/i.test(m.url || ''))) {
        html += '<img src="' + escA(m.url) + '" onclick="window.open(this.src)" alt="—Ñ–æ—Ç–æ">';
      }
    });
    html += '</div>';
  }
  if (content) {
    html += formatText(content);
  }
  div.innerHTML = html;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
  return div;
}

function formatText(text) {
  return esc(text)
    .replace(/\n/g, '<br>')
    .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
    .replace(/\*(.*?)\*/g, '<em>$1</em>');
}

// ‚ïê‚ïê‚ïê AUTO GREETING ‚ïê‚ïê‚ïê
async function sendAutoGreeting() {
  const dir = currentDir;
  if (!dir) return;
  const dirId = dir.id;

  const typingDiv = appendMsg('assistant', '');
  typingDiv.innerHTML = '<div class="typing-dots"><span></span><span></span><span></span></div>';
  document.getElementById('chatStatus').textContent = '‚óè –ø–µ—á–∞—Ç–∞–µ—Ç...';

  try {
    const q = parseQ(dir);
    const prompt = buildSystemPrompt(dir, q);

    const res = await fetch(AI_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        message: '–ü–æ–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–π –∫–ª–∏–µ–Ω—Ç–∞ –∏ –Ω–∞—á–Ω–∏ —Å–æ–±–∏—Ä–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é. –ü—Ä–µ–¥—Å—Ç–∞–≤—å—Å—è –∫–∞–∫ AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –≤–µ–±-—Å—Ç—É–¥–∏–∏.',
        context: 'anketa',
        source: 'client_order',
        direction: dir.name || '',
        directionId: dirId,
        user: '–ö–ª–∏–µ–Ω—Ç',
        questionnaire: q,
        stage: dir.stage || 'prospect',
        history: [],
        media: [],
        systemPrompt: prompt,
        isClientMode: true
      }),
      signal: AbortSignal.timeout(60000)
    });

    let data = await res.json();
    if (Array.isArray(data)) data = data[0] || {};
    if (data.json) data = data.json;
    let aiText = data.reply || data.response || data.text || data.message || '';
    if (!aiText && data.content) { try { aiText = data.content[0].text; } catch(e) {} }
    if (!aiText) aiText = '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! üëã –Ø AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –≤–µ–±-—Å—Ç—É–¥–∏–∏. –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ –æ –≤–∞—à–µ–º –±–∏–∑–Ω–µ—Å–µ, –∏ –º—ã —Å–æ–∑–¥–∞–¥–∏–º –¥–ª—è –≤–∞—Å –∏–¥–µ–∞–ª—å–Ω—ã–π —Å–∞–π—Ç!';

    const parsed = parseAiResponse(aiText);
    typingDiv.innerHTML = formatText(parsed.visibleText);

    // Save to DB
    await SB.from('anketa_chat').insert({
      direction_id: dirId,
      role: 'assistant',
      content: parsed.visibleText,
      extracted_data: parsed.extracted || {}
    });
    chatHistory.push({ role: 'assistant', content: parsed.visibleText });

    if (parsed.completeness !== null) updateProgress(parsed.completeness);

  } catch(e) {
    console.warn('Greeting error:', e);
    typingDiv.innerHTML = formatText('–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! üëã –Ø AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –≤–µ–±-—Å—Ç—É–¥–∏–∏. –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ –≤–∞—à–µ–º –±–∏–∑–Ω–µ—Å–µ ‚Äî –∫–∞–∫–∏–µ —É—Å–ª—É–≥–∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç–µ, –∫—Ç–æ –≤–∞—à–∏ –∫–ª–∏–µ–Ω—Ç—ã? –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –º–Ω–µ —Å–¥–µ–ª–∞—Ç—å –¥–ª—è –≤–∞—Å –ª—É—á—à–∏–π —Å–∞–π—Ç!');
  }

  document.getElementById('chatStatus').textContent = '‚óè –æ–Ω–ª–∞–π–Ω';
}

// ‚ïê‚ïê‚ïê SEND MESSAGE ‚ïê‚ïê‚ïê
async function sendMessage() {
  if (sending) return;
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text && !pendingFiles.length) return;

  const dir = currentDir;
  if (!dir) return;
  const dirId = dir.id;

  sending = true;
  document.getElementById('chatSendBtn').disabled = true;
  input.value = '';
  input.style.height = 'auto';

  // Upload files
  let mediaUrls = [];
  if (pendingFiles.length) {
    toast('üì§ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤...');
    for (const file of pendingFiles) {
      try {
        const resized = await resizeImage(file);
        const path = 'client/' + dirId + '/' + Date.now() + '_' + slugify(file.name);
        const { error } = await SB.storage.from('anketa').upload(path, resized, { contentType: resized.type, upsert: false });
        if (!error) {
          const { data: urlData } = SB.storage.from('anketa').getPublicUrl(path);
          if (urlData?.publicUrl) mediaUrls.push({ type: 'image', url: urlData.publicUrl, name: file.name });
        }
      } catch(e) { console.warn('Upload error:', e); }
    }
    pendingFiles = [];
    document.getElementById('mediaPreview').innerHTML = '';
    document.getElementById('mediaPreview').classList.remove('show');
  }

  // Show user message
  let displayText = text;
  if (mediaUrls.length) displayText += (text ? '\n' : '') + 'üìé ' + mediaUrls.length + ' —Ñ–∞–π–ª(–æ–≤)';
  appendMsg('user', displayText, mediaUrls);

  // Save user message
  let fullContent = text;
  if (mediaUrls.length) fullContent += '\n[–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ: ' + mediaUrls.map(m => m.name).join(', ') + ']';
  await SB.from('anketa_chat').insert({ direction_id: dirId, role: 'user', content: fullContent, media_urls: mediaUrls });
  chatHistory.push({ role: 'user', content: fullContent, media_urls: mediaUrls });

  // Typing indicator
  const typingDiv = appendMsg('assistant', '');
  typingDiv.innerHTML = '<div class="typing-dots"><span></span><span></span><span></span></div>';
  document.getElementById('chatStatus').textContent = '‚óè –ø–µ—á–∞—Ç–∞–µ—Ç...';

  try {
    const history = chatHistory.slice(-16).map(m => ({ role: m.role === 'user' ? 'user' : 'assistant', content: (m.content || '').slice(0, 2000) }));
    const q = parseQ(dir);
    const prompt = buildSystemPrompt(dir, q);
    const hasMedia = mediaUrls.length > 0;
    const isLongRequest = /(?:–Ω–∞–ø–∏—à–∏|—Å–æ—Å—Ç–∞–≤—å|–ø–æ–¥–≥–æ—Ç–æ–≤—å|—Å–¥–µ–ª–∞–π|—Å–æ–∑–¥–∞–π|–æ—Ñ–æ—Ä–º–∏|–¥–∞–≤–∞–π)[^.]{0,30}(?:—Ç–µ–∫—Å—Ç|–∫–ø|–ø—Ä–µ–¥–ª–æ–∂–µ–Ω|–ø–∏—Å—å–º|–æ–ø–∏—Å–∞–Ω)/i.test((text || '').toLowerCase());
    const timeout = isLongRequest ? 150000 : hasMedia ? 120000 : 90000;

    // Retry logic
    let aiText = '';
    for (let attempt = 1; attempt <= 2; attempt++) {
      try {
        const controller = new AbortController();
        const tmr = setTimeout(() => controller.abort(), attempt === 1 ? timeout : timeout + 60000);
        const res = await fetch(AI_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: fullContent,
            context: 'anketa',
            source: 'client_order',
            direction: dir.name || '',
            directionId: dirId,
            user: '–ö–ª–∏–µ–Ω—Ç',
            questionnaire: q,
            stage: dir.stage || 'prospect',
            history: history,
            media: mediaUrls,
            systemPrompt: prompt,
            isClientMode: true
          }),
          signal: controller.signal
        });
        clearTimeout(tmr);

        let data = await res.json();
        if (Array.isArray(data)) data = data[0] || {};
        if (data.json) data = data.json;
        aiText = data.reply || data.response || data.text || data.message || '';
        if (!aiText && data.content) { try { aiText = data.content[0].text; } catch(e) {} }
        if (aiText) break;
      } catch(retryErr) {
        if (attempt < 2 && retryErr.name === 'AbortError') {
          typingDiv.innerHTML = '<div class="typing-dots"><span></span><span></span><span></span></div><div style="font-size:11px;color:var(--text3);margin-top:4px">–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞...</div>';
          continue;
        }
        throw retryErr;
      }
    }

    if (!aiText) aiText = '–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞–ø—Ä–æ—Å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ –ø–æ-–¥—Ä—É–≥–æ–º—É.';

    const parsed = parseAiResponse(aiText);

    // Typewriter effect
    typingDiv.innerHTML = '';
    const words = parsed.visibleText.split(/([\s]+)/);
    let idx = 0;
    await new Promise(resolve => {
      const iv = setInterval(() => {
        if (idx >= words.length) { clearInterval(iv); resolve(); return; }
        const chunk = words.slice(idx, idx + 4).join('');
        typingDiv.innerHTML += formatText(chunk);
        idx += 4;
        document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
      }, 25);
    });

    // Save assistant message
    await SB.from('anketa_chat').insert({
      direction_id: dirId,
      role: 'assistant',
      content: parsed.visibleText,
      extracted_data: parsed.extracted || {}
    });
    chatHistory.push({ role: 'assistant', content: parsed.visibleText });

    // Update questionnaire
    if (parsed.extracted && Object.keys(parsed.extracted).length) {
      const updatedQ = mergeQ(q, parsed.extracted);
      if (parsed.completeness !== null) updatedQ._completeness = parsed.completeness;
      await SB.from('directions').update({
        questionnaire: JSON.stringify(updatedQ),
        anketa_completeness: parsed.completeness || dir.anketa_completeness || 0
      }).eq('id', dirId);
      dir.questionnaire = JSON.stringify(updatedQ);
    }

    if (parsed.completeness !== null) updateProgress(parsed.completeness);

  } catch(e) {
    console.error('Send error:', e);
    const isAbort = e.name === 'AbortError';
    typingDiv.innerHTML = isAbort
      ? '<span style="color:var(--yellow)">‚è± –í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ ‚Äî AI –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç –≤–∞—à –∑–∞–ø—Ä–æ—Å.</span>'
      : '<span style="color:var(--red)">–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.</span>';
  }

  sending = false;
  document.getElementById('chatSendBtn').disabled = false;
  document.getElementById('chatStatus').textContent = '‚óè –æ–Ω–ª–∞–π–Ω';
  document.getElementById('chatInput').focus();
}

// ‚ïê‚ïê‚ïê FILE HANDLING ‚ïê‚ïê‚ïê
function attachFiles() {
  document.getElementById('fileInput').click();
}

function filesSelected(input) {
  const files = Array.from(input.files);
  if (!files.length) return;
  pendingFiles.push(...files);
  renderMediaPreview();
  input.value = '';
}

function renderMediaPreview() {
  const container = document.getElementById('mediaPreview');
  if (!pendingFiles.length) { container.classList.remove('show'); container.innerHTML = ''; return; }
  container.classList.add('show');
  container.innerHTML = pendingFiles.map((f, i) => {
    const isImg = f.type.startsWith('image/');
    return `<div class="media-item">
      ${isImg ? '<img class="media-thumb" src="' + URL.createObjectURL(f) + '">' : '<div class="media-thumb" style="display:flex;align-items:center;justify-content:center;background:var(--bg3);font-size:11px;color:var(--text2)">üìÑ</div>'}
      <button class="media-remove" onclick="removeFile(${i})">√ó</button>
    </div>`;
  }).join('');
}

function removeFile(idx) {
  pendingFiles.splice(idx, 1);
  renderMediaPreview();
}

// ‚ïê‚ïê‚ïê AI RESPONSE PARSING ‚ïê‚ïê‚ïê
function parseAiResponse(text) {
  let visibleText = text;
  let extracted = {};
  let completeness = null;

  // Extract JSON block
  const jsonMatch = text.match(/```json\s*([\s\S]*?)```/);
  if (jsonMatch) {
    try {
      extracted = JSON.parse(jsonMatch[1]);
      visibleText = text.replace(/```json[\s\S]*?```/, '').trim();
    } catch(e) {}
  }

  // Extract completeness
  const compMatch = text.match(/(?:completeness|–≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å|–∑–∞–ø–æ–ª–Ω–µ–Ω)[:\s]*(\d+)/i);
  if (compMatch) completeness = Math.min(100, parseInt(compMatch[1]));
  if (extracted.completeness) completeness = Math.min(100, parseInt(extracted.completeness));
  if (extracted._completeness) completeness = Math.min(100, parseInt(extracted._completeness));

  // Clean markdown artifacts
  visibleText = visibleText.replace(/---[\s]*$/gm, '').replace(/^\s*#{1,3}\s*/gm, '').trim();

  return { visibleText, extracted, completeness };
}

// ‚ïê‚ïê‚ïê SYSTEM PROMPT ‚ïê‚ïê‚ïê
function buildSystemPrompt(dir, q) {
  const name = dir.name || '–ö–ª–∏–µ–Ω—Ç';
  const type = dir.site_type || q?.business_info?.type || '';
  const city = dir.city || q?.business_info?.city || '';
  const stage = dir.stage || 'prospect';

  let collected = '';
  if (q && q._version === 2) {
    ['business_info','contact','content','design','media','services','custom'].forEach(s => {
      if (q[s] && Object.keys(q[s]).length) collected += '\n' + s + ': ' + JSON.stringify(q[s]);
    });
  }

  let p = '–¢—ã ‚Äî AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –≤–µ–±-—Å—Ç—É–¥–∏–∏. –û–±—â–∞–µ—à—å—Å—è –ù–ê–ü–†–Ø–ú–£–Æ —Å –∫–ª–∏–µ–Ω—Ç–æ–º.\n\n';

  p += '## –ü–†–ê–í–ò–õ–ê:\n';
  p += '- –ó–∞–¥–∞–≤–∞–π –ø–æ –û–î–ù–û–ú–£ –≤–æ–ø—Ä–æ—Å—É –∑–∞ —Ä–∞–∑, –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞–π\n';
  p += '- –ë—É–¥—å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º, –∫—Ä–∞—Ç–∫–∏–º\n';
  p += '- –û—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –∫–ª–∏–µ–Ω—Ç–∞, –µ—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç ‚Äî –ù–ï –∏–≥–Ω–æ—Ä–∏—Ä—É–π\n';
  p += '- –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø—Ä–æ—Å–∏—Ç –Ω–∞–ø–∏—Å–∞—Ç—å —Ç–µ–∫—Å—Ç/–ö–ü/–æ–ø–∏—Å–∞–Ω–∏–µ ‚Äî –ù–ê–ü–ò–®–ò –µ–≥–æ, –∞ –Ω–µ –∑–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã\n';
  p += '- –§–æ—Ä–º–∞—Ç: –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç, –∏—Å–ø–æ–ª—å–∑—É–π **–∂–∏—Ä–Ω—ã–π** –¥–ª—è –∞–∫—Ü–µ–Ω—Ç–æ–≤\n';
  p += '- –í –∫–æ–Ω—Ü–µ –∫–∞–∂–¥–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –¥–æ–±–∞–≤—å JSON-–±–ª–æ–∫ —Å –∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏\n\n';

  p += '## –û –ö–õ–ò–ï–ù–¢–ï:\n';
  p += '- –ë–∏–∑–Ω–µ—Å: ' + name + '\n';
  if (type) p += '- –¢–∏–ø —Å–∞–π—Ç–∞: ' + type + '\n';
  if (city) p += '- –ì–æ—Ä–æ–¥: ' + city + '\n';

  if (collected) {
    p += '\n## –°–û–ë–†–ê–ù–û:\n' + collected + '\n';
    p += '\n–ù–ï —Å–ø—Ä–∞—à–∏–≤–∞–π —Ç–æ, —á—Ç–æ —É–∂–µ –∏–∑–≤–µ—Å—Ç–Ω–æ!\n';
  }

  p += '\n## –ß–¢–û –£–ó–ù–ê–¢–¨ (–ø–æ –æ–¥–Ω–æ–º—É!):\n';
  p += '1. –ü–æ–¥—Ä–æ–±–Ω–µ–µ –æ –±–∏–∑–Ω–µ—Å–µ (—á–µ–º –∑–∞–Ω–∏–º–∞–µ—Ç–µ—Å—å, –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞, –∞—É–¥–∏—Ç–æ—Ä–∏—è)\n';
  p += '2. –£—Å–ª—É–≥–∏/—Ç–æ–≤–∞—Ä—ã —Å —Ü–µ–Ω–∞–º–∏\n';
  p += '3. –ö–æ–Ω—Ç–∞–∫—Ç—ã (—Ç–µ–ª–µ—Ñ–æ–Ω, —Å–æ—Ü—Å–µ—Ç–∏, –∞–¥—Ä–µ—Å, —á–∞—Å—ã —Ä–∞–±–æ—Ç—ã)\n';
  p += '4. –°—Ç–∏–ª—å (—Ü–≤–µ—Ç–∞, –ø—Ä–∏–º–µ—Ä—ã —Å–∞–π—Ç–æ–≤ –∫–æ—Ç–æ—Ä—ã–µ –Ω—Ä–∞–≤—è—Ç—Å—è)\n';
  p += '5. –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ (–ª–æ–≥–æ—Ç–∏–ø, —Ñ–æ—Ç–æ –ø—Ä–æ–¥—É–∫—Ü–∏–∏/–∏–Ω—Ç–µ—Ä—å–µ—Ä–∞)\n';
  p += '6. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è\n\n';

  p += '## JSON-–§–û–†–ú–ê–¢ (–≤ –∫–æ–Ω—Ü–µ –æ—Ç–≤–µ—Ç–∞):\n';
  p += '```json\n{"business_info":{"type":"...","description":"..."},"services":[...],"contact":{"phone":"...","hours":"..."},"design":{"colors":"...","style":"..."},"completeness":25}\n```\n';
  p += 'completeness ‚Äî –æ—Ü–µ–Ω–∫–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç–∏ –æ—Ç 0 –¥–æ 100.\n';

  return p;
}

// ‚ïê‚ïê‚ïê HELPERS ‚ïê‚ïê‚ïê
function parseQ(dir) {
  try { return JSON.parse(dir.questionnaire || '{}'); } catch(e) { return {}; }
}

function mergeQ(existing, newData) {
  const m = JSON.parse(JSON.stringify(existing));
  m._version = 2;
  m._last_updated = new Date().toISOString();
  for (const [k, v] of Object.entries(newData)) {
    if (k.startsWith('_')) { m[k] = v; continue; }
    if (typeof v === 'object' && v !== null && !Array.isArray(v)) {
      if (!m[k]) m[k] = {};
      for (const [kk, vv] of Object.entries(v)) {
        if (vv !== null && vv !== undefined && vv !== '') m[k][kk] = vv;
      }
    } else {
      m[k] = v;
    }
  }
  return m;
}

function updateProgress(pct) {
  const n = Math.min(100, Math.max(0, parseInt(pct) || 0));
  document.getElementById('cpPct').textContent = n + '%';
  document.getElementById('cpFill').style.width = n + '%';
}

function generateToken() {
  const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
  let t = '';
  for (let i = 0; i < 24; i++) t += chars[Math.floor(Math.random() * chars.length)];
  return t;
}

function slugify(s) {
  return s.replace(/[^a-zA-Z0-9._-]/g, '_').slice(0, 60);
}

function esc(s) {
  if (!s) return '';
  const d = document.createElement('div');
  d.textContent = String(s);
  return d.innerHTML;
}

function escA(s) {
  return esc(s).replace(/"/g, '&quot;');
}

function toast(msg) {
  const el = document.getElementById('toastEl');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 3000);
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 120) + 'px';
}

function resizeImage(file, maxDim = 1568, quality = 0.85) {
  return new Promise(resolve => {
    if (!file.type.startsWith('image/') || file.size < 1024 * 1024) return resolve(file);
    if (file.type === 'image/gif' || file.type === 'image/svg+xml') return resolve(file);
    const img = new Image();
    const url = URL.createObjectURL(file);
    img.onload = () => {
      URL.revokeObjectURL(url);
      let { width, height } = img;
      if (width <= maxDim && height <= maxDim && file.size < 3 * 1024 * 1024) return resolve(file);
      if (width > height) { if (width > maxDim) { height = Math.round(height * maxDim / width); width = maxDim; } }
      else { if (height > maxDim) { width = Math.round(width * maxDim / height); height = maxDim; } }
      const canvas = document.createElement('canvas');
      canvas.width = width; canvas.height = height;
      canvas.getContext('2d').drawImage(img, 0, 0, width, height);
      canvas.toBlob(blob => {
        if (blob && blob.size < file.size) resolve(new File([blob], file.name.replace(/\.[^.]+$/, '.jpg'), { type: 'image/jpeg' }));
        else resolve(file);
      }, 'image/jpeg', quality);
    };
    img.onerror = () => { URL.revokeObjectURL(url); resolve(file); };
    img.src = url;
  });
}

async function notifyTeam(name, type, phone, city) {
  try {
    await fetch(AI_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        message: 'üÜï –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ —Å —Å–∞–π—Ç–∞!\n\n–ö–ª–∏–µ–Ω—Ç: ' + name + '\n–¢–∏–ø: ' + type + '\n–¢–µ–ª–µ—Ñ–æ–Ω: ' + (phone || '–Ω–µ —É–∫–∞–∑–∞–Ω') + '\n–ì–æ—Ä–æ–¥: ' + (city || '–Ω–µ —É–∫–∞–∑–∞–Ω'),
        context: 'notification',
        source: 'client_order'
      }),
      signal: AbortSignal.timeout(10000)
    });
  } catch(e) {}
}
</script>
</body>
</html>
